<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Build, Bin, Boost: The R&D Portfolio Simulation | ShieldTech India</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* P&G-inspired professional blue color scheme */
            --primary: #003da5;
            --primary-light: #0056d6;
            --primary-lighter: #e8f1fc;
            --primary-pale: #d0e3f8;
            --primary-dark: #002d7a;
            --accent: #00a3e0;
            --accent-light: #b3e5f7;
            --gold: #F1BE48;
            --gold-dark: #D69A2D;
            --gold-light: #fdf6e3;
            --white: #ffffff;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --success: #059669;
            --success-light: #d1fae5;
            --warning: #d97706;
            --warning-light: #fef3c7;
            --danger: #dc2626;
            --danger-light: #fee2e2;
            --info: #0284c7;
            --info-light: #e0f2fe;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--gray-50) 0%, var(--primary-lighter) 100%);
            min-height: 100vh;
            color: var(--gray-800);
            line-height: 1.6;
        }
        
        .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
        
        /* Landing Page */
        .landing-page {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 40px 20px;
        }
        
        .landing-hero { text-align: center; margin-bottom: 50px; }
        
        .landing-badge {
            display: inline-block;
            background: var(--primary);
            color: var(--gold);
            padding: 8px 20px;
            border-radius: 30px;
            font-size: 0.85em;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 25px;
        }
        
        .landing-title {
            font-family: 'Playfair Display', Georgia, serif;
            font-size: 3.5em;
            color: var(--primary);
            margin-bottom: 15px;
            line-height: 1.1;
        }
        
        .landing-subtitle {
            font-size: 1.4em;
            color: var(--gray-600);
            max-width: 600px;
            margin: 0 auto 40px;
        }
        
        .landing-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            max-width: 900px;
            margin: 0 auto 50px;
        }
        
        .feature-card {
            background: var(--white);
            border-radius: 16px;
            padding: 30px;
            text-align: left;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            border-top: 4px solid var(--primary);
        }
        
        .feature-icon { font-size: 2em; margin-bottom: 15px; }
        .feature-card h3 { color: var(--primary); margin-bottom: 10px; font-size: 1.15em; }
        .feature-card p { color: var(--gray-600); font-size: 0.95em; }
        
        .landing-cta { text-align: center; }
        
        .landing-meta {
            text-align: center;
            margin-top: 40px;
            color: var(--gray-500);
            font-size: 0.9em;
        }
        
        .landing-meta span { margin: 0 15px; }
        
        .landing-credits {
            text-align: center;
            margin-top: 50px;
            padding-top: 30px;
            border-top: 1px solid var(--gray-200);
            color: var(--gray-500);
            font-size: 0.85em;
        }
        
        .landing-credits p {
            margin: 8px 0;
            line-height: 1.6;
        }
        
        .landing-credits a {
            color: var(--primary);
            text-decoration: none;
        }
        
        .landing-credits a:hover {
            text-decoration: underline;
        }
        
        .license-text {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .credits-btn {
            margin-top: 15px;
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            color: var(--gray-600);
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .credits-btn:hover {
            background: var(--gray-100);
            border-color: var(--gray-400);
        }
        
        /* Credits Modal */
        .credits-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            padding: 20px;
        }
        
        .credits-modal {
            background: white;
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 25px 80px rgba(0,0,0,0.4);
        }
        
        .credits-modal-header {
            padding: 25px 30px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border-radius: 16px 16px 0 0;
        }
        
        .credits-modal-header h2 {
            margin: 0 0 5px;
        }
        
        .credits-modal-header p {
            margin: 0;
            opacity: 0.9;
            font-size: 0.95em;
        }
        
        .credits-modal-body {
            padding: 25px 30px;
        }
        
        .credits-section {
            margin-bottom: 25px;
        }
        
        .credits-section:last-child {
            margin-bottom: 0;
        }
        
        .credits-section h3 {
            font-size: 0.8em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--gray-500);
            margin: 0 0 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--gray-200);
        }
        
        .credits-person {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
        }
        
        .credits-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--primary-lighter);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1em;
        }
        
        .credits-person-info {
            flex: 1;
        }
        
        .credits-person-name {
            font-weight: 600;
            color: var(--gray-800);
        }
        
        .credits-person-role {
            font-size: 0.85em;
            color: var(--gray-500);
        }
        
        .license-box {
            background: var(--gray-50);
            padding: 20px;
            border-radius: 10px;
            margin-top: 10px;
        }
        
        .license-box h4 {
            margin: 0 0 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .license-terms {
            font-size: 0.9em;
            color: var(--gray-600);
            line-height: 1.6;
        }
        
        .license-terms strong {
            color: var(--gray-700);
        }
        
        .license-terms ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .license-terms li {
            margin-bottom: 6px;
        }
        
        .warranty-notice {
            margin-top: 15px;
            padding: 12px;
            background: var(--warning-light);
            border-radius: 8px;
            font-size: 0.8em;
            color: var(--gray-600);
        }
        
        .credits-modal-footer {
            padding: 15px 30px;
            background: var(--gray-50);
            border-radius: 0 0 16px 16px;
            text-align: center;
        }
        
        .credits-close-btn {
            padding: 10px 25px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        /* ========== SELECTION APPROACH MODAL ========== */
        .approach-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 4000;
            padding: 20px;
        }
        
        .approach-modal-overlay.hidden {
            display: none;
        }
        
        .approach-modal {
            background: white;
            border-radius: 20px;
            max-width: 750px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 80px rgba(0,0,0,0.4);
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .approach-modal-header {
            padding: 30px 35px 25px;
            background: linear-gradient(135deg, var(--primary) 0%, #1e40af 100%);
            color: white;
            border-radius: 20px 20px 0 0;
            text-align: center;
        }
        
        .approach-modal-header h2 {
            margin: 0 0 8px;
            font-size: 1.5em;
            font-family: 'Playfair Display', Georgia, serif;
        }
        
        .approach-modal-header p {
            margin: 0;
            opacity: 0.9;
            font-size: 0.95em;
        }
        
        .approach-modal-body {
            padding: 30px 35px;
        }
        
        .approach-choice-section {
            margin-bottom: 30px;
        }
        
        .approach-choice-section:last-of-type {
            margin-bottom: 20px;
        }
        
        .approach-choice-header {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            margin-bottom: 18px;
        }
        
        .choice-number {
            width: 32px;
            height: 32px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1em;
            flex-shrink: 0;
        }
        
        .approach-choice-header h3 {
            margin: 0 0 4px;
            font-size: 1.1em;
            color: var(--gray-800);
        }
        
        .approach-choice-header p {
            margin: 0;
            font-size: 0.9em;
            color: var(--gray-500);
        }
        
        .approach-options-vertical {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .approach-options-horizontal {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        @media (max-width: 600px) {
            .approach-options-horizontal {
                grid-template-columns: 1fr;
            }
        }
        
        .approach-option {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            padding: 18px;
            background: white;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .approach-option:hover {
            border-color: var(--primary-light);
            background: var(--gray-50);
        }
        
        .approach-option.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, var(--primary-lighter) 0%, white 100%);
            box-shadow: 0 0 0 3px var(--primary-pale);
        }
        
        .approach-option.compact {
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 20px 15px;
        }
        
        .approach-option.compact .approach-option-content {
            align-items: center;
        }
        
        .approach-option-radio {
            width: 22px;
            height: 22px;
            border: 2px solid var(--gray-300);
            border-radius: 50%;
            flex-shrink: 0;
            position: relative;
            transition: all 0.2s;
        }
        
        .approach-option.selected .approach-option-radio {
            border-color: var(--primary);
            background: var(--primary);
        }
        
        .approach-option.selected .approach-option-radio::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
            font-weight: 700;
        }
        
        .approach-option.compact .approach-option-radio {
            position: absolute;
            top: 12px;
            right: 12px;
        }
        
        .approach-option.compact {
            position: relative;
        }
        
        .approach-option-icon {
            font-size: 1.8em;
            flex-shrink: 0;
        }
        
        .approach-option.compact .approach-option-icon {
            font-size: 2.2em;
            margin-bottom: 5px;
        }
        
        .approach-option-content {
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex: 1;
        }
        
        .approach-option-title {
            font-weight: 700;
            color: var(--primary);
            font-size: 1em;
        }
        
        .approach-option-desc {
            font-size: 0.85em;
            color: var(--gray-600);
            line-height: 1.5;
        }
        
        .approach-option-effects {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 4px;
        }
        
        .approach-option.compact .approach-option-effects {
            justify-content: center;
        }
        
        .approach-effect {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 0.75em;
            font-weight: 500;
        }
        
        .approach-effect.pro {
            background: var(--success-light);
            color: var(--success);
        }
        
        .approach-effect.con {
            background: var(--warning-light);
            color: var(--warning);
        }
        
        .approach-effect.neutral {
            background: var(--gray-100);
            color: var(--gray-600);
        }
        
        .approach-research-note {
            background: linear-gradient(135deg, #fef3c7 0%, #fffbeb 100%);
            border: 1px solid #fcd34d;
            border-radius: 12px;
            padding: 16px 18px;
            margin-top: 5px;
        }
        
        .approach-research-note h4 {
            margin: 0 0 6px;
            font-size: 0.85em;
            color: var(--gray-700);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .approach-research-note p {
            margin: 0;
            font-size: 0.8em;
            color: var(--gray-600);
            line-height: 1.5;
        }
        
        .approach-modal-footer {
            padding: 20px 35px 30px;
            text-align: center;
        }
        
        .approach-confirm-btn {
            padding: 14px 40px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .approach-confirm-btn:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,61,165,0.3);
        }
        
        .approach-confirm-btn:disabled {
            background: var(--gray-300);
            cursor: not-allowed;
        }
        
        /* ========== RAPID MODE & BLINDING STYLES ========== */
        .rapid-mode-badge {
            display: inline-block;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #92400e;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin-bottom: 15px;
            border: 1px solid #fcd34d;
        }
        
        .rapid-facts {
            grid-template-columns: repeat(4, 1fr) !important;
        }
        
        @media (max-width: 600px) {
            .rapid-facts {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }
        
        .rapid-team-hint {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: var(--gray-50);
            border-radius: 10px;
            margin: 15px 0;
            border: 1px solid var(--gray-200);
        }
        
        .rapid-team-hint .team-icon {
            font-size: 1.3em;
        }
        
        .rapid-team-hint .team-text {
            font-size: 0.9em;
            color: var(--gray-600);
        }
        
        .rapid-team-hint.blinded {
            background: linear-gradient(135deg, #e0e7ff 0%, #eef2ff 100%);
            border-color: #a5b4fc;
        }
        
        .rapid-team-hint.blinded .team-text {
            color: #4338ca;
        }
        
        .rapid-details-link {
            margin-top: 15px;
            text-align: center;
        }
        
        .rapid-details-link .btn {
            font-size: 0.85em;
        }
        
        .rapid-summary {
            background: var(--gray-50);
            padding: 15px 18px;
            border-radius: 10px;
            border-left: 4px solid var(--primary);
        }
        
        .project-rapid-desc {
            color: var(--gray-700);
            line-height: 1.7;
            font-size: 0.95em;
            margin: 0;
        }
        
        .track-record-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .track-record-badge.success {
            background: var(--success-light);
            color: var(--success);
        }
        
        .track-record-badge.warning {
            background: var(--warning-light);
            color: var(--warning);
        }
        
        .track-record-badge.danger {
            background: var(--danger-light);
            color: var(--danger);
        }
        
        .blinded-section {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px;
            background: linear-gradient(135deg, #e0e7ff 0%, #eef2ff 100%);
            border-radius: 12px;
            border: 2px dashed #a5b4fc;
            margin: 15px 0;
        }
        
        .blinded-icon {
            font-size: 2.5em;
            flex-shrink: 0;
        }
        
        .blinded-text {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .blinded-text strong {
            color: #4338ca;
            font-size: 1em;
        }
        
        .blinded-text span {
            color: #6366f1;
            font-size: 0.9em;
        }
        
        .btn-sm {
            padding: 8px 14px;
            font-size: 0.85em;
        }
        
        /* ========== MANAGEMENT DILEMMA MODALS ========== */
        .dilemma-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5000;
            padding: 20px;
        }
        
        .dilemma-modal {
            background: white;
            border-radius: 20px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 80px rgba(0,0,0,0.5);
            animation: dilemmaSlideIn 0.4s ease-out;
        }
        
        @keyframes dilemmaSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .dilemma-modal-header {
            padding: 30px 30px 25px;
            background: linear-gradient(135deg, #7c3aed 0%, #4f46e5 100%);
            color: white;
            text-align: center;
            border-radius: 20px 20px 0 0;
        }
        
        .dilemma-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }
        
        .dilemma-category {
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.9;
            margin-bottom: 8px;
        }
        
        .dilemma-title {
            font-size: 1.5em;
            font-weight: 700;
            font-family: 'Playfair Display', Georgia, serif;
            margin: 0;
        }
        
        .dilemma-modal-body {
            padding: 25px 30px 30px;
        }
        
        .dilemma-description {
            font-size: 1.05em;
            color: var(--gray-700);
            line-height: 1.7;
            margin-bottom: 25px;
        }
        
        .dilemma-choices {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .dilemma-choice {
            display: block;
            width: 100%;
            padding: 18px 20px;
            background: var(--gray-50);
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .dilemma-choice:hover {
            background: white;
            border-color: var(--primary);
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.15);
            transform: translateX(5px);
        }
        
        .choice-label {
            font-weight: 700;
            color: var(--gray-800);
            font-size: 1.05em;
            margin-bottom: 5px;
        }
        
        .choice-description {
            font-size: 0.9em;
            color: var(--gray-600);
        }
        
        .dilemma-hint {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            background: linear-gradient(135deg, #fef3c7 0%, #fef9e7 100%);
            border-radius: 10px;
            border: 1px solid #fcd34d;
        }
        
        .hint-icon {
            font-size: 1.3em;
        }
        
        .hint-text {
            font-size: 0.9em;
            color: #92400e;
            font-style: italic;
        }
        
        /* Dilemma Outcome Modal */
        .dilemma-outcome-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5000;
            padding: 20px;
        }
        
        .dilemma-outcome-modal {
            background: white;
            border-radius: 20px;
            max-width: 500px;
            width: 100%;
            text-align: center;
            box-shadow: 0 25px 80px rgba(0,0,0,0.5);
            animation: dilemmaSlideIn 0.3s ease-out;
            overflow: hidden;
        }
        
        .outcome-header {
            padding: 30px 25px;
        }
        
        .outcome-header.positive {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            color: white;
        }
        
        .outcome-header.mixed {
            background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%);
            color: white;
        }
        
        .outcome-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }
        
        .outcome-header h3 {
            margin: 0;
            font-size: 1.3em;
        }
        
        .outcome-body {
            padding: 25px 30px;
        }
        
        .outcome-choice {
            font-size: 1em;
            color: var(--gray-600);
            margin-bottom: 15px;
        }
        
        .outcome-narrative {
            font-size: 1.1em;
            color: var(--gray-800);
            line-height: 1.6;
        }
        
        .outcome-continue-btn {
            display: block;
            width: calc(100% - 60px);
            margin: 0 30px 30px;
            padding: 15px 25px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .outcome-continue-btn:hover {
            background: var(--primary-dark);
        }
        
        .credits-close-btn:hover {
            background: var(--primary-dark);
        }
        
        /* Briefing Page */
        .briefing-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: var(--white);
            padding: 50px 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }
        
        .briefing-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(241,190,72,0.15) 0%, transparent 70%);
            border-radius: 50%;
        }
        
        .briefing-header .company-logo {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.1);
            padding: 10px 20px;
            border-radius: 30px;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .briefing-header h1 {
            font-family: 'Playfair Display', Georgia, serif;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .briefing-header .tagline { font-size: 1.1em; opacity: 0.9; }
        
        .briefing-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-top: 30px;
            position: relative;
        }
        
        .briefing-stat {
            text-align: center;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
        }
        
        .briefing-stat .value { font-size: 1.8em; font-weight: 700; color: var(--gold); }
        .briefing-stat .label { font-size: 0.85em; opacity: 0.8; }
        
        .briefing-section {
            background: var(--white);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .briefing-section h2 {
            color: var(--primary);
            font-size: 1.4em;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .briefing-section h2 .icon {
            width: 35px;
            height: 35px;
            background: var(--primary-lighter);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Timeline */
        .timeline { position: relative; padding-left: 30px; }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 5px;
            bottom: 5px;
            width: 3px;
            background: var(--gray-200);
            border-radius: 2px;
        }
        
        .timeline-item { position: relative; margin-bottom: 25px; }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -26px;
            top: 6px;
            width: 12px;
            height: 12px;
            background: var(--primary);
            border-radius: 50%;
            border: 3px solid var(--white);
            box-shadow: 0 0 0 2px var(--primary-lighter);
        }
        
        .timeline-item.highlight::before {
            background: var(--gold);
            box-shadow: 0 0 0 2px var(--gold-light);
        }
        
        .timeline-year { font-weight: 700; color: var(--primary); margin-bottom: 5px; }
        .timeline-text { color: var(--gray-600); }
        
        /* Capability Grid */
        .capability-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .capability-item {
            background: var(--gray-50);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid var(--primary);
        }
        
        .capability-item h4 { color: var(--primary); margin-bottom: 8px; font-size: 1em; }
        .capability-item p { color: var(--gray-600); font-size: 0.9em; margin: 0; }
        
        /* Strategy Priorities */
        .strategy-priorities {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .priority-item {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            padding: 15px;
            background: var(--gold-light);
            border-radius: 12px;
            border: 1px solid var(--gold);
        }
        
        .priority-number {
            width: 30px;
            height: 30px;
            background: var(--gold);
            color: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            flex-shrink: 0;
        }
        
        .priority-text h4 { color: var(--gold-dark); margin-bottom: 5px; font-size: 1em; }
        .priority-text p { color: var(--gray-600); font-size: 0.9em; margin: 0; }
        
        /* Appointment Page */
        .appointment-header {
            background: var(--white);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            border-top: 5px solid var(--danger);
        }
        
        .urgent-badge {
            display: inline-block;
            background: var(--danger-light);
            color: var(--danger);
            padding: 8px 20px;
            border-radius: 30px;
            font-size: 0.85em;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        .appointment-header h1 {
            font-family: 'Playfair Display', Georgia, serif;
            font-size: 2.2em;
            color: var(--primary);
            margin-bottom: 15px;
        }
        
        .appointment-header .lead {
            font-size: 1.15em;
            color: var(--gray-600);
            max-width: 700px;
            margin: 0 auto;
        }
        
        .problem-section {
            background: var(--white);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .problem-section h2 {
            color: var(--danger);
            font-size: 1.3em;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .failure-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .failure-item {
            background: var(--danger-light);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid var(--danger);
        }
        
        .failure-item .stat { font-size: 2em; font-weight: 700; color: var(--danger); }
        .failure-item .label { color: var(--gray-700); font-size: 0.9em; }
        
        .diagnosis-box {
            background: var(--gray-50);
            border-radius: 12px;
            padding: 25px;
            border-left: 4px solid var(--primary);
        }
        
        .diagnosis-box h3 { color: var(--primary); margin-bottom: 15px; }
        .diagnosis-list { list-style: none; padding: 0; margin: 0; }
        
        .diagnosis-list li {
            padding: 10px 0;
            border-bottom: 1px solid var(--gray-200);
            color: var(--gray-700);
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .diagnosis-list li:last-child { border-bottom: none; }
        .diagnosis-list .bullet { color: var(--primary); font-weight: bold; }
        
        .mandate-section {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 16px;
            padding: 35px;
            color: var(--white);
            margin-bottom: 20px;
        }
        
        .mandate-section h2 { color: var(--gold); margin-bottom: 20px; font-size: 1.4em; }
        .mandate-section p { font-size: 1.1em; margin-bottom: 25px; opacity: 0.95; }
        
        .mandate-goals {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .mandate-goal {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .mandate-goal .icon { font-size: 1.8em; margin-bottom: 10px; }
        .mandate-goal h4 { color: var(--gold); margin-bottom: 5px; }
        .mandate-goal p { font-size: 0.9em; margin: 0; opacity: 0.85; }
        
        /* Process Design Pages */
        .design-header {
            background: var(--white);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            border-top: 5px solid var(--primary);
        }
        
        .design-header h1 {
            font-family: 'Playfair Display', Georgia, serif;
            font-size: 2em;
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .design-header p { color: var(--gray-600); max-width: 600px; margin: 0 auto; }
        
        .step-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 30px;
        }
        
        .step-badge {
            background: var(--primary);
            color: var(--white);
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
        }
        
        .step-label { color: var(--gray-500); font-size: 0.9em; }
        
        /* Decision Model Cards */
        .decision-model-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .model-card {
            background: var(--white);
            border-radius: 16px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            border: 3px solid var(--gray-200);
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .model-card:hover {
            border-color: var(--primary-light);
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(60, 16, 83, 0.15);
        }
        
        .model-card.selected {
            border-color: var(--primary);
            background: var(--primary-lighter);
        }
        
        .model-card .icon { font-size: 3em; margin-bottom: 15px; }
        .model-card h3 { color: var(--primary); margin-bottom: 10px; font-size: 1.15em; }
        .model-card p { color: var(--gray-600); font-size: 0.9em; margin-bottom: 15px; }
        
        .model-card .traits { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; }
        
        .trait-tag {
            font-size: 0.75em;
            padding: 4px 10px;
            border-radius: 12px;
            background: var(--gray-100);
            color: var(--gray-600);
        }
        
        .model-card.selected .trait-tag { background: var(--primary); color: var(--white); }
        
        /* Committee Selection */
        .committee-section {
            background: var(--white);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .committee-section h2 { color: var(--primary); margin-bottom: 10px; }
        .committee-section > p { color: var(--gray-600); margin-bottom: 25px; }
        
        /* Committee display area */
        .committee-display {
            background: var(--primary-lighter);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            min-height: 100px;
        }
        
        .committee-display h3 {
            color: var(--primary);
            font-size: 1em;
            margin-bottom: 15px;
        }
        
        .committee-members {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        
        .committee-member-chip {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--white);
            padding: 6px 12px 6px 6px;
            border-radius: 25px;
            border: 2px solid var(--primary);
            font-size: 0.9em;
        }
        
        .committee-member-chip img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .committee-member-chip .remove-btn {
            background: var(--danger-light);
            color: var(--danger);
            border: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.8em;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 5px;
        }
        
        .committee-member-chip .remove-btn:hover { background: var(--danger); color: white; }
        
        .committee-member-chip.locked {
            background: var(--gold-light);
            border-color: var(--gold);
        }
        
        .committee-member-chip .locked-badge {
            font-size: 0.8em;
            margin-left: 5px;
        }
        
        .empty-committee {
            color: var(--gray-400);
            font-style: italic;
            padding: 20px;
            text-align: center;
        }
        
        /* Staff Grid */
        .staff-category { margin-bottom: 35px; }
        
        .staff-category h3 {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.15em;
            display: flex;
            align-items: center;
            gap: 12px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-lighter);
        }
        
        .staff-category h3 .category-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--primary-lighter);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1em;
        }
        
        .staff-category h3 .category-count {
            margin-left: auto;
            font-size: 0.85em;
            font-weight: 500;
            color: var(--gray-500);
            background: var(--gray-100);
            padding: 4px 12px;
            border-radius: 20px;
        }
        
        .staff-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }
        
        .staff-card, .criteria-tile {
            background: white;
            border-radius: 16px;
            padding: 0;
            border: 2px solid var(--gray-200);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            position: relative;
        }
        
        .staff-card:hover, .criteria-tile:hover {
            border-color: var(--primary);
            box-shadow: 0 8px 25px rgba(89, 49, 95, 0.15);
            transform: translateY(-4px);
        }
        
        .staff-card.selected, .criteria-tile.selected {
            border-color: var(--primary);
            background: var(--primary-lighter);
            box-shadow: 0 4px 20px rgba(89, 49, 95, 0.2);
        }
        
        .staff-card.selected::after, .criteria-tile.selected::after {
            content: '✓';
            position: absolute;
            top: 12px;
            right: 12px;
            width: 28px;
            height: 28px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            z-index: 10;
        }
        
        /* Tile Header with illustration */
        .tile-header {
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        .tile-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0.1;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23000' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        
        .tile-icon {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            position: relative;
            z-index: 2;
        }
        
        .tile-body {
            padding: 20px;
        }
        
        .tile-title {
            font-size: 1.1em;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 4px;
        }
        
        .tile-subtitle {
            font-size: 0.85em;
            color: var(--gray-500);
            margin-bottom: 12px;
        }
        
        .tile-description {
            font-size: 0.9em;
            color: var(--gray-600);
            line-height: 1.5;
            margin-bottom: 12px;
        }
        
        .tile-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .tile-tag {
            font-size: 0.75em;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 500;
        }
        
        .tile-tag.pro { background: #dcfce7; color: #166534; }
        .tile-tag.con { background: #fef3c7; color: #92400e; }
        
        /* Staff Avatar with gradient ring */
        .staff-avatar-ring {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            padding: 4px;
            position: relative;
            z-index: 2;
        }
        
        .staff-avatar-inner {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
            font-weight: 700;
            color: var(--gray-700);
            overflow: hidden;
        }
        
        .staff-avatar-inner img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Legacy support */
        .staff-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 12px;
        }
        
        .staff-avatar {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
            border: 3px solid var(--white);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .staff-avatar-placeholder {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.1em;
            flex-shrink: 0;
            color: white;
            border: 3px solid var(--white);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .staff-info h4 { color: var(--gray-800); font-size: 1em; margin-bottom: 2px; }
        .staff-info .role { color: var(--gray-500); font-size: 0.85em; }
        .staff-info .location { color: var(--gray-400); font-size: 0.8em; }
        
        .staff-bio {
            color: var(--gray-600);
            font-size: 0.9em;
            margin-bottom: 12px;
            line-height: 1.5;
        }
        
        .staff-traits { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; }
        
        .staff-trait {
            font-size: 0.75em;
            padding: 3px 8px;
            border-radius: 10px;
        }
        
        .staff-trait.strength { background: var(--success-light); color: var(--success); }
        .staff-trait.bias { background: var(--warning-light); color: var(--warning); }
        
        /* Criteria Tiles Grid */
        .criteria-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 16px;
        }
        
        .criteria-tile .tile-header {
            height: 80px;
        }
        
        .criteria-tile .tile-icon {
            width: 60px;
            height: 60px;
            font-size: 1.6em;
        }
        
        .criteria-tile .tile-body {
            padding: 16px;
        }
        
        /* Weight tiles */
        .weight-tile {
            display: grid;
            grid-template-columns: 80px 1fr;
            gap: 0;
            background: white;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.2s;
        }
        
        .weight-tile:hover {
            border-color: var(--primary-light);
        }
        
        .weight-tile.has-value {
            border-color: var(--primary);
            background: linear-gradient(135deg, var(--primary-lighter) 0%, white 100%);
        }
        
        .weight-tile-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
            color: white;
        }
        
        .weight-tile-content {
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .weight-tile-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .weight-tile-title {
            font-weight: 600;
            color: var(--gray-800);
            font-size: 0.95em;
        }
        
        .weight-tile-value {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .weight-tile-input {
            width: 50px;
            padding: 6px 8px;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 700;
            text-align: center;
            color: var(--primary);
        }
        
        .weight-tile-input:focus {
            border-color: var(--primary);
            outline: none;
        }
        
        .weight-tile-pct {
            color: var(--gray-400);
            font-weight: 600;
        }
        
        .weight-tile-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: var(--gray-200);
            -webkit-appearance: none;
            cursor: pointer;
        }
        
        .weight-tile-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        
        /* Criteria Category Styling */
        .criteria-category {
            margin-bottom: 30px;
        }
        
        .criteria-category-header {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--primary);
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 16px;
            padding: 12px 16px;
            background: linear-gradient(135deg, var(--primary-lighter) 0%, white 100%);
            border-radius: 10px;
            border-left: 4px solid var(--primary);
        }
        
        .category-icon {
            font-size: 1.3em;
        }
        
        /* Enhanced Criteria Tile */
        .criteria-tile {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            border: 2px solid var(--gray-200);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        
        .criteria-tile:hover {
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(89, 49, 95, 0.15);
        }
        
        .criteria-tile.selected {
            border-color: var(--primary);
            background: linear-gradient(180deg, var(--primary-lighter) 0%, white 100%);
        }
        
        .criteria-tile.selected::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary);
        }
        
        .criteria-tile-header {
            padding: 20px 20px 0;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }
        
        .criteria-tile-icon {
            width: 56px;
            height: 56px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6em;
            color: white;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .criteria-tile-info {
            flex: 1;
            padding-right: 30px;
        }
        
        .criteria-tile-title {
            font-size: 1.05em;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 4px;
        }
        
        .criteria-tile-question {
            font-size: 0.85em;
            color: var(--primary);
            font-style: italic;
        }
        
        .criteria-tile-body {
            padding: 12px 20px 16px;
        }
        
        .criteria-tile-desc {
            font-size: 0.9em;
            color: var(--gray-600);
            line-height: 1.5;
            margin-bottom: 12px;
        }
        
        .criteria-tile-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .criteria-tag {
            font-size: 0.75em;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 500;
        }
        
        .criteria-tag.pro {
            background: #dcfce7;
            color: #166534;
        }
        
        .criteria-tag.con {
            background: #fef3c7;
            color: #92400e;
        }
        
        /* Selection checkmark */
        .criteria-tile .selection-check {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            border: 2px solid var(--gray-300);
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            opacity: 0;
        }
        
        .criteria-tile.selected .selection-check {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
            opacity: 1;
        }
        
        .criteria-tile .selection-check::after {
            content: '✓';
            font-size: 14px;
            font-weight: bold;
            opacity: 0;
        }
        
        .criteria-tile.selected .selection-check::after {
            opacity: 1;
        }
        
        /* Staff Tile Design */
        .staff-tile {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            border: 2px solid var(--gray-200);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        .staff-tile:hover {
            border-color: var(--primary-light);
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(0, 61, 165, 0.15);
        }
        
        .staff-tile.selected {
            border-color: var(--primary);
            background: linear-gradient(180deg, var(--primary-lighter) 0%, white 30%);
            box-shadow: 0 8px 25px rgba(0, 61, 165, 0.2);
        }
        
        .staff-tile.selected::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary);
            z-index: 5;
        }
        
        .staff-tile .selection-check {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid var(--gray-300);
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 10;
            opacity: 0;
        }
        
        .staff-tile.selected .selection-check {
            background: var(--primary);
            border-color: var(--primary);
            opacity: 1;
        }
        
        .staff-tile .selection-check::after {
            content: '✓';
            font-size: 16px;
            font-weight: bold;
            color: white;
            opacity: 0;
        }
        
        .staff-tile.selected .selection-check::after {
            opacity: 1;
        }
        
        .staff-tile-header {
            padding: 24px 20px 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            background: linear-gradient(135deg, var(--gray-50) 0%, white 100%);
            border-bottom: 1px solid var(--gray-100);
        }
        
        .staff-tile-avatar {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            padding: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.12);
            flex-shrink: 0;
        }
        
        .staff-tile-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            background: white;
        }
        
        .staff-tile-initials {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4em;
            font-weight: 700;
            color: var(--gray-600);
        }
        
        .staff-tile-header-info {
            flex: 1;
            min-width: 0;
        }
        
        .staff-tile-name {
            font-size: 1.15em;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 4px;
            line-height: 1.2;
        }
        
        .staff-tile-role {
            font-size: 0.9em;
            color: var(--primary);
            font-weight: 600;
            margin-bottom: 4px;
            line-height: 1.3;
        }
        
        .staff-tile-location {
            font-size: 0.8em;
            color: var(--gray-500);
        }
        
        .staff-tile-body {
            padding: 16px 20px 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .staff-tile-bio {
            font-size: 0.88em;
            color: var(--gray-600);
            line-height: 1.55;
            margin-bottom: 16px;
            flex: 1;
        }
        
        .staff-tile-traits {
            margin-bottom: 16px;
        }
        
        .staff-tile-traits-label {
            font-size: 0.7em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--gray-400);
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .staff-tile-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .staff-tag {
            font-size: 0.75em;
            padding: 5px 10px;
            border-radius: 6px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .staff-tag.pro { background: #dcfce7; color: #166534; }
        .staff-tag.con { background: #fef3c7; color: #92400e; }
        
        .staff-tile-actions {
            display: flex;
            gap: 10px;
            margin-top: auto;
            padding-top: 16px;
            border-top: 1px solid var(--gray-100);
        }
        
        .staff-btn-details, .staff-btn-select {
            flex: 1;
            padding: 12px 14px;
            border-radius: 10px;
            font-size: 0.88em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .staff-btn-details {
            background: var(--gray-100);
            color: var(--gray-700);
        }
        
        .staff-btn-details:hover {
            background: var(--gray-200);
        }
        
        .staff-btn-select {
            background: var(--primary);
            color: white;
        }
        
        .staff-btn-select:hover {
            background: var(--primary-dark);
            transform: scale(1.02);
        }
        
        .staff-btn-select.selected {
            background: var(--success);
        }
        
        .staff-btn-select.selected:hover {
            background: #dc2626;
        }
        
        .staff-btn-select.locked {
            background: var(--gold);
            cursor: default;
        }
        
        .staff-btn-select.locked:hover {
            background: var(--gold);
        }
        
        .staff-tile.locked {
            border-color: var(--gold);
            background: linear-gradient(135deg, #fef3c7 0%, #fef9e7 100%);
        }
        
        .staff-tile.locked .selection-check {
            background: var(--gold);
            border-color: var(--gold);
            color: white;
            font-size: 0.8em;
            opacity: 1;
        }
        
        /* Staff Category Header */
        .staff-category {
            margin-bottom: 30px;
        }
        
        .staff-category-header {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--primary);
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 16px;
            padding: 14px 18px;
            background: linear-gradient(135deg, var(--primary-lighter) 0%, white 100%);
            border-radius: 12px;
            border-left: 4px solid var(--primary);
        }
        
        .staff-category-header .category-icon {
            font-size: 1.3em;
        }
        
        .staff-category-header .category-hint {
            margin-left: auto;
            font-size: 0.75em;
            font-weight: 400;
            color: var(--gray-500);
        }
        
        @media (max-width: 600px) {
            .staff-category-header .category-hint {
                display: none;
            }
        }
        
        /* Criteria Selection Header */
        .criteria-selection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .criteria-selection-header h2 {
            margin: 0;
        }
        
        .criteria-warning {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .criteria-warning.error {
            background: #fef2f2;
            color: #991b1b;
        }
        
        .criteria-warning.warning {
            background: #fef3c7;
            color: #92400e;
        }
        
        .criteria-warning.success {
            background: #dcfce7;
            color: #166534;
        }
        
        .learn-more-btn {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .learn-more-btn:hover { background: var(--primary); color: var(--white); }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .modal-overlay.hidden { display: none; }
        
        .modal-content {
            background: var(--white);
            border-radius: 20px;
            padding: 30px;
            max-width: 550px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
        }
        
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--gray-100);
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-600);
        }
        
        .modal-close:hover { background: var(--gray-200); }
        
        .modal-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .modal-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--primary-lighter);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .modal-avatar-placeholder {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.8em;
            color: white;
            border: 4px solid var(--primary-lighter);
        }
        
        .modal-title h2 { color: var(--primary); margin-bottom: 5px; }
        .modal-title .role { color: var(--gray-500); }
        
        .modal-section { margin-bottom: 20px; }
        .modal-section h3 { color: var(--primary); font-size: 1em; margin-bottom: 10px; }
        .modal-section p, .modal-section ul { color: var(--gray-600); font-size: 0.95em; }
        .modal-section ul { padding-left: 20px; }
        .modal-section li { margin-bottom: 5px; }
        
        .cv-item {
            display: flex;
            gap: 15px;
            padding: 12px 0;
            border-bottom: 1px solid var(--gray-100);
        }
        
        .cv-year {
            color: var(--primary);
            font-weight: 600;
            font-size: 0.9em;
            width: 70px;
            flex-shrink: 0;
        }
        
        .cv-detail { color: var(--gray-700); font-size: 0.9em; }
        
        .modal-traits { display: flex; flex-wrap: wrap; gap: 8px; }
        
        .add-to-committee-btn {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            color: var(--white);
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            font-size: 1em;
        }
        
        .add-to-committee-btn:hover { background: var(--primary-light); }
        .add-to-committee-btn.remove { background: var(--danger); }
        .add-to-committee-btn.remove:hover { background: #b91c1c; }
        
        /* Common Styles */
        .card {
            background: var(--white);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        
        .card h2 { color: var(--primary); margin-bottom: 15px; font-size: 1.6em; }
        .card p { color: var(--gray-600); margin-bottom: 15px; }
        
        /* Buttons */
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin: 5px;
            font-family: inherit;
        }
        
        .btn-primary {
            background: var(--primary);
            color: var(--white);
            box-shadow: 0 4px 12px rgba(60, 16, 83, 0.25);
        }
        
        .btn-primary:hover { background: var(--primary-light); transform: translateY(-2px); }
        .btn-primary:disabled { background: var(--gray-300); cursor: not-allowed; transform: none; box-shadow: none; }
        
        .btn-secondary {
            background: var(--white);
            color: var(--gray-700);
            border: 2px solid var(--gray-300);
        }
        
        .btn-secondary:hover { background: var(--gray-50); }
        
        .btn-gold {
            background: var(--gold);
            color: var(--primary);
            box-shadow: 0 4px 12px rgba(241, 190, 72, 0.4);
        }
        
        .btn-gold:hover { background: var(--gold-dark); transform: translateY(-2px); }
        
        .btn-large { padding: 18px 40px; font-size: 1.1em; }
        .btn-small { padding: 6px 12px; font-size: 0.85em; }
        
        .button-row {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        .wbs-badge {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--gray-200);
            color: var(--gray-400);
            font-size: 0.85em;
        }
        
        .hidden { display: none !important; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .landing-title { font-size: 2.5em; }
            .briefing-stats { grid-template-columns: repeat(2, 1fr); }
            .decision-model-grid { grid-template-columns: 1fr 1fr; }
            .staff-grid { grid-template-columns: 1fr; }
        }
        
        @media (max-width: 480px) {
            .landing-title { font-size: 2em; }
            .briefing-header h1 { font-size: 1.8em; }
            .decision-model-grid { grid-template-columns: 1fr; }
        }

        /* Game UI styles */
        .phase-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            background: var(--white);
            padding: 15px 25px;
            border-radius: 50px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }
        
        .phase-dot {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            background: var(--gray-100);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9em;
            color: var(--gray-400);
            transition: all 0.3s;
        }
        
        .phase-dot.active {
            background: var(--primary);
            color: var(--white);
            transform: scale(1.15);
            box-shadow: 0 4px 12px rgba(60, 16, 83, 0.3);
        }
        
        .phase-dot.completed { background: var(--success); color: var(--white); }
        .phase-connector { width: 25px; height: 3px; background: var(--gray-200); border-radius: 2px; }
        .phase-connector.completed { background: var(--success); }

        /* Budget bar & project cards */
        .budget-bar {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 15px;
            padding: 20px 25px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            color: var(--white);
        }
        
        .budget-display { font-size: 1.2em; }
        .budget-display .amount { color: var(--gold); font-weight: 700; font-size: 1.2em; }
        .budget-display .total { color: rgba(255,255,255,0.7); }
        .projects-count { background: rgba(255,255,255,0.15); padding: 8px 16px; border-radius: 20px; font-weight: 600; }
        
        .project-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        
        .project-card {
            background: var(--white);
            border-radius: 12px;
            padding: 18px;
            border: 2px solid var(--gray-200);
            transition: all 0.2s;
            position: relative;
        }
        
        .project-card:hover { border-color: var(--primary-light); box-shadow: 0 4px 12px rgba(60, 16, 83, 0.1); }
        .project-card.selected { border-color: var(--primary); background: var(--primary-lighter); }
        .project-card.locked { opacity: 0.5; }
        
        .project-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .project-name { font-weight: 600; color: var(--gray-800); font-size: 1em; }
        .project-budget { background: var(--gold-light); color: var(--gold-dark); padding: 3px 8px; border-radius: 6px; font-size: 0.8em; font-weight: 700; white-space: nowrap; }
        .project-tagline { font-size: 0.85em; color: var(--gray-500); font-style: italic; margin-bottom: 10px; }
        .project-desc { font-size: 0.9em; color: var(--gray-600); margin-bottom: 12px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        
        .project-card-actions { display: flex; gap: 8px; }
        .project-learn-more { flex: 1; background: transparent; border: 1px solid var(--primary); color: var(--primary); padding: 8px 12px; border-radius: 6px; font-size: 0.85em; cursor: pointer; transition: all 0.2s; }
        .project-learn-more:hover { background: var(--primary); color: white; }
        .project-select-btn { flex: 1; background: var(--primary); border: none; color: white; padding: 8px 12px; border-radius: 6px; font-size: 0.85em; cursor: pointer; transition: all 0.2s; }
        .project-select-btn:hover { background: var(--primary-light); }
        .project-select-btn.selected { background: var(--success); }
        .project-select-btn:disabled { background: var(--gray-300); cursor: not-allowed; }
        
        /* Legacy Project Card Styles */
        .legacy-project-card {
            background: var(--white);
            border-radius: 14px;
            box-shadow: 0 3px 12px rgba(0,0,0,0.08);
            overflow: hidden;
            border-left: 5px solid var(--gray-300);
        }
        
        .legacy-project-card.status-green { border-left-color: var(--success); }
        .legacy-project-card.status-amber { border-left-color: var(--warning); }
        .legacy-project-card.status-red { border-left-color: var(--danger); }
        
        .legacy-card-header {
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 20px;
            cursor: pointer;
            background: var(--gray-50);
            transition: background 0.2s;
        }
        
        .legacy-card-header:hover { background: var(--gray-100); }
        
        .legacy-card-header h3 {
            margin: 0 0 6px 0;
            color: var(--gray-800);
            font-size: 1.15em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Legacy Quick Decision Buttons */
        .legacy-quick-actions {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: 12px;
        }
        
        .legacy-quick-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 10px;
            border: 2px solid var(--gray-200);
            background: white;
            border-radius: 8px;
            font-size: 0.75em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--gray-600);
        }
        
        .legacy-quick-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: var(--primary-lighter);
        }
        
        .legacy-quick-btn.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }
        
        .legacy-quick-btn.selected.decision-kill {
            border-color: var(--danger);
            background: var(--danger);
        }
        
        .legacy-quick-btn.selected.decision-pause {
            border-color: var(--warning);
            background: var(--warning);
            color: var(--gray-800);
        }
        
        .legacy-quick-btn.selected.decision-reduce_scope {
            border-color: var(--info);
            background: var(--info);
        }
        
        .legacy-quick-btn.selected.decision-accelerate {
            border-color: var(--success);
            background: var(--success);
        }
        
        .legacy-card-right {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-end;
            min-width: 140px;
        }
        
        .legacy-budget-impact {
            text-align: right;
            padding: 8px 12px;
            background: var(--gray-100);
            border-radius: 8px;
        }
        
        .legacy-budget-impact .amount {
            font-size: 1.1em;
            font-weight: 700;
            color: var(--primary);
        }
        
        .legacy-budget-impact .label {
            font-size: 0.7em;
            color: var(--gray-500);
            text-transform: uppercase;
        }
        
        .legacy-details-link {
            font-size: 0.8em;
            color: var(--primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .legacy-details-link:hover {
            text-decoration: underline;
        }
        
        .legacy-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.7em;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .legacy-badge.inherited { background: var(--primary-lighter); color: var(--primary); }
        
        .legacy-status-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.75em;
            font-weight: 600;
        }
        
        .legacy-status-badge.green { background: var(--success-light); color: var(--success); }
        .legacy-status-badge.amber { background: var(--warning-light); color: var(--warning); }
        .legacy-status-badge.red { background: var(--danger-light); color: var(--danger); }
        
        .legacy-card-summary {
            font-size: 0.9em;
            color: var(--gray-600);
            margin: 0;
        }
        
        .legacy-card-metrics {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .legacy-metric {
            font-size: 0.8em;
            color: var(--gray-500);
        }
        
        .legacy-metric strong { color: var(--gray-700); }
        
        .legacy-expand-icon {
            font-size: 1.2em;
            color: var(--gray-400);
            transition: transform 0.3s;
        }
        
        .legacy-project-card.expanded .legacy-expand-icon { transform: rotate(180deg); }
        
        .legacy-card-body {
            padding: 0 25px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }
        
        .legacy-project-card.expanded .legacy-card-body {
            padding: 20px 25px;
            max-height: 2000px;
        }
        
        .legacy-section {
            margin-bottom: 18px;
        }
        
        .legacy-section h4 {
            font-size: 0.9em;
            color: var(--primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legacy-section p {
            font-size: 0.9em;
            color: var(--gray-600);
            margin: 0;
            line-height: 1.5;
        }
        
        .legacy-timeline {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding-left: 15px;
            border-left: 3px solid var(--gray-200);
        }
        
        .legacy-timeline-item {
            position: relative;
            padding-left: 15px;
        }
        
        .legacy-timeline-item::before {
            content: '';
            position: absolute;
            left: -21px;
            top: 6px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--gray-300);
        }
        
        .legacy-timeline-item.status-green::before { background: var(--success); }
        .legacy-timeline-item.status-amber::before { background: var(--warning); }
        .legacy-timeline-item.status-red::before { background: var(--danger); }
        
        .legacy-timeline-quarter {
            font-size: 0.75em;
            font-weight: 600;
            color: var(--gray-500);
        }
        
        .legacy-timeline-narrative {
            font-size: 0.85em;
            color: var(--gray-600);
        }
        
        .legacy-decision-section {
            background: var(--gray-50);
            padding: 18px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .legacy-decision-section h4 {
            margin: 0 0 15px 0;
            font-size: 0.95em;
            color: var(--gray-800);
        }
        
        .legacy-decision-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .legacy-decision-btn {
            flex: 1;
            min-width: 130px;
            padding: 12px 15px;
            border: 2px solid var(--gray-200);
            border-radius: 10px;
            background: var(--white);
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }
        
        .legacy-decision-btn:hover {
            border-color: var(--primary-light);
            background: var(--primary-lighter);
        }
        
        .legacy-decision-btn.selected {
            border-color: var(--primary);
            background: var(--primary-lighter);
        }
        
        .legacy-decision-btn.selected.decision-kill {
            border-color: var(--danger);
            background: var(--danger-light);
        }
        
        .legacy-decision-btn.selected.decision-pause {
            border-color: var(--warning);
            background: var(--warning-light);
        }
        
        .legacy-decision-btn .decision-icon {
            font-size: 1.2em;
            margin-bottom: 5px;
        }
        
        .legacy-decision-btn .decision-label {
            font-weight: 600;
            font-size: 0.85em;
            color: var(--gray-800);
            display: block;
        }
        
        .legacy-decision-btn .decision-desc {
            font-size: 0.75em;
            color: var(--gray-500);
            margin-top: 4px;
        }
        
        .legacy-risk-box {
            background: var(--warning-light);
            border-left: 4px solid var(--warning);
            padding: 12px 15px;
            border-radius: 0 8px 8px 0;
            margin-top: 10px;
        }
        
        .legacy-risk-box.risk-kill {
            background: var(--danger-light);
            border-left-color: var(--danger);
        }
        
        .legacy-risk-box h5 {
            margin: 0 0 5px 0;
            font-size: 0.8em;
            color: var(--gray-700);
        }
        
        .legacy-risk-box p {
            margin: 0;
            font-size: 0.85em;
            color: var(--gray-600);
        }
        
        /* Project Modal Styles */
        .project-modal-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 2px solid var(--gray-100); }
        .project-modal-budget { text-align: right; }
        
        .project-financials { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; }
        .financial-item { background: var(--gray-50); padding: 12px; border-radius: 8px; text-align: center; }
        .financial-item .value { font-weight: 700; color: var(--primary); font-size: 1.1em; }
        .financial-item .label { font-size: 0.75em; color: var(--gray-500); margin-top: 4px; }
        
        .synergy-item { display: inline-block; background: var(--info-light); color: var(--info); padding: 6px 12px; border-radius: 15px; font-size: 0.85em; margin: 4px 4px 4px 0; }
        
        /* Assessment Phase Styles */
        .assessment-header { text-align: center; margin-bottom: 25px; }
        .assessment-progress-bar { height: 8px; background: var(--gray-200); border-radius: 4px; margin: 15px 0 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary) 0%, var(--gold) 100%); border-radius: 4px; transition: width 0.3s ease; }
        .assessment-progress-text { font-size: 0.9em; color: var(--gray-500); }
        
        /* Project Progress Dots */
        .project-progress-dots {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
            justify-content: center;
        }
        
        .progress-dot {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            position: relative;
        }
        
        .progress-dot:hover {
            transform: scale(1.1);
        }
        
        .progress-dot.unvisited {
            background: var(--gray-200);
            color: var(--gray-500);
        }
        
        .progress-dot.current {
            background: var(--primary);
            color: white;
            box-shadow: 0 2px 8px rgba(89, 49, 95, 0.4);
            transform: scale(1.15);
        }
        
        .progress-dot.partial {
            background: #fef3c7;
            color: #92400e;
            border-color: #f59e0b;
        }
        
        .progress-dot.complete {
            background: #dcfce7;
            color: #166534;
            border-color: #22c55e;
        }
        
        .progress-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
            font-size: 0.75em;
            color: var(--gray-500);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 4px;
        }
        
        .legend-dot.unvisited { background: var(--gray-200); }
        .legend-dot.partial { background: #fef3c7; border: 1px solid #f59e0b; }
        .legend-dot.complete { background: #dcfce7; border: 1px solid #22c55e; }
        
        .progress-dots-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }
        
        .assessment-project-view { background: var(--gray-50); border-radius: 12px; padding: 25px; margin-bottom: 25px; }
        .assessment-project-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
        .assessment-project-title { font-size: 1.4em; font-weight: 700; color: var(--primary); margin-bottom: 5px; }
        .assessment-project-tagline { color: var(--gray-500); font-style: italic; }
        .assessment-project-budget { font-size: 1.3em; font-weight: 700; color: var(--gold-dark); background: var(--gold-light); padding: 8px 15px; border-radius: 8px; }
        
        .strategic-buckets { display: flex; flex-wrap: wrap; gap: 8px; margin: 15px 0; }
        .strategic-bucket { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 20px; font-size: 0.85em; font-weight: 500; }
        
        .assessment-section { margin-bottom: 20px; }
        .assessment-section h4 { color: var(--primary); margin-bottom: 8px; font-size: 0.95em; text-transform: uppercase; letter-spacing: 0.5px; }
        .assessment-section p { color: var(--gray-600); line-height: 1.6; }
        
        .team-leads-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-top: 10px; }
        .team-lead-card { display: flex; align-items: center; gap: 10px; background: var(--white); padding: 12px; border-radius: 8px; border: 1px solid var(--gray-200); }
        .team-lead-avatar { width: 45px; height: 45px; border-radius: 50%; background: var(--primary-lighter); display: flex; align-items: center; justify-content: center; font-size: 1.2em; flex-shrink: 0; }
        .team-lead-info { flex: 1; min-width: 0; }
        .team-lead-name { font-weight: 600; color: var(--gray-800); font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .team-lead-role { font-size: 0.8em; color: var(--gray-500); }
        .team-lead-vacancy { background: var(--warning-light); border-color: var(--warning); }
        .team-lead-vacancy .team-lead-avatar { background: var(--warning-light); color: var(--warning); }
        
        .assessment-scoring { background: var(--white); border: 2px solid var(--primary-light); border-radius: 12px; padding: 25px; }
        .scoring-title { font-size: 1.1em; font-weight: 600; color: var(--primary); margin-bottom: 20px; text-align: center; }
        
        .scoring-criteria-list { display: flex; flex-direction: column; gap: 18px; }
        .scoring-criterion { display: flex; align-items: center; gap: 20px; padding: 15px; background: var(--gray-50); border-radius: 10px; }
        .criterion-info { flex: 1; }
        .criterion-name { font-weight: 600; color: var(--gray-800); margin-bottom: 3px; }
        .criterion-question { font-size: 0.85em; color: var(--gray-500); }
        
        .criterion-scale { display: flex; gap: 8px; }
        .criterion-scale.three-point { gap: 12px; }
        
        /* Legacy 5-point scale */
        .scale-option { width: 50px; height: 45px; border: 2px solid var(--gray-300); background: var(--white); border-radius: 8px; cursor: pointer; transition: all 0.15s; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .scale-option:hover { border-color: var(--primary-light); background: var(--primary-lighter); }
        .scale-option.selected { border-color: var(--primary); background: var(--primary); color: white; }
        .scale-option .scale-num { font-weight: 700; font-size: 1.1em; }
        .scale-option .scale-label { font-size: 0.6em; text-transform: uppercase; }
        
        /* 3-point scale buttons */
        .scale-btn {
            flex: 1;
            min-width: 80px;
            padding: 12px 16px;
            border: 2px solid var(--gray-300);
            background: var(--white);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .scale-btn:hover {
            border-color: var(--btn-color, var(--gray-400));
            background: color-mix(in srgb, var(--btn-color, var(--gray-400)) 10%, white);
            transform: scale(1.05);
        }
        
        .scale-btn.selected {
            border-color: var(--btn-color, var(--primary));
            background: var(--btn-color, var(--primary));
            color: white;
            box-shadow: 0 4px 12px color-mix(in srgb, var(--btn-color) 40%, transparent);
        }
        
        .scale-btn .scale-icon {
            font-size: 1.5em;
        }
        
        .scale-btn .scale-text {
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .scale-btn.selected .scale-icon {
            transform: scale(1.1);
        }
        
        @media (max-width: 500px) {
            .scale-btn {
                min-width: 60px;
                padding: 10px 12px;
            }
            .scale-btn .scale-icon { font-size: 1.3em; }
            .scale-btn .scale-text { font-size: 0.75em; }
        }
        
        .scoring-complete { text-align: center; padding: 15px; background: var(--success-light); border-radius: 8px; margin-top: 15px; color: var(--success); font-weight: 500; }
        
        /* Portfolio Builder Layout */
        .portfolio-builder-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 25px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        @media (max-width: 900px) {
            .portfolio-builder-layout {
                grid-template-columns: 1fr;
            }
            .portfolio-sidebar {
                order: 2;
            }
            .portfolio-main {
                order: 1;
            }
        }
        
        .portfolio-sidebar {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .portfolio-budget-card, .portfolio-buckets-card, .portfolio-projects-list {
            background: white;
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .portfolio-budget-card h3, .portfolio-buckets-card h3, .portfolio-projects-list h3 {
            margin: 0 0 12px;
            font-size: 0.95em;
            color: var(--gray-600);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .budget-meter {
            height: 12px;
            background: var(--gray-200);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        
        .budget-meter-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--gold) 100%);
            border-radius: 6px;
            transition: width 0.3s;
            width: 0%;
        }
        
        .budget-stats {
            font-size: 1.4em;
            font-weight: 700;
            color: var(--primary);
        }
        
        .budget-stats .budget-total {
            font-weight: 400;
            color: var(--gray-400);
            font-size: 0.7em;
        }
        
        .projects-count-mini {
            font-size: 0.85em;
            color: var(--gray-500);
            margin-top: 4px;
        }
        
        .portfolio-bucket-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid var(--gray-100);
        }
        
        .portfolio-bucket-item:last-child {
            border-bottom: none;
        }
        
        .bucket-icon {
            font-size: 1.2em;
        }
        
        .bucket-name {
            flex: 1;
            font-size: 0.85em;
            color: var(--gray-700);
        }
        
        .bucket-count {
            font-weight: 700;
            font-size: 0.9em;
            padding: 2px 8px;
            border-radius: 10px;
            background: var(--gray-100);
            color: var(--gray-600);
        }
        
        .bucket-count.filled {
            background: var(--success-light);
            color: var(--success);
        }
        
        /* Portfolio Scores Panel */
        .portfolio-scores-card {
            background: white;
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            max-height: 350px;
            display: flex;
            flex-direction: column;
        }
        
        .portfolio-scores-card h3 {
            margin: 0 0 12px;
            font-size: 0.95em;
            color: var(--gray-600);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .scores-scroll {
            overflow-y: auto;
            flex: 1;
        }
        
        .score-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            border-radius: 8px;
            margin-bottom: 4px;
            cursor: pointer;
            transition: all 0.15s;
            border: 2px solid transparent;
        }
        
        .score-row:hover {
            background: var(--gray-50);
        }
        
        .score-row.in-portfolio {
            background: var(--primary-lighter);
            border-color: var(--primary-light);
        }
        
        .score-row.is-funded {
            background: #dcfce7;
            border-color: #22c55e;
        }
        
        .score-row.is-stopped {
            opacity: 0.4;
        }
        
        .score-row-rank {
            width: 24px;
            height: 24px;
            background: var(--gray-200);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75em;
            font-weight: 700;
            color: var(--gray-600);
            flex-shrink: 0;
        }
        
        .score-row.in-portfolio .score-row-rank,
        .score-row.is-funded .score-row-rank {
            background: var(--primary);
            color: white;
        }
        
        .score-row-info {
            flex: 1;
            min-width: 0;
        }
        
        .score-row-name {
            font-size: 0.85em;
            font-weight: 600;
            color: var(--gray-800);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .score-row-meta {
            font-size: 0.75em;
            color: var(--gray-500);
        }
        
        .score-row-scores {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }
        
        .score-badge {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            font-weight: 600;
        }
        
        .score-badge.avg {
            background: var(--gray-100);
            color: var(--gray-700);
        }
        
        .score-badge.you {
            background: var(--primary-lighter);
            color: var(--primary);
        }
        
        .score-row-status {
            font-size: 0.85em;
            flex-shrink: 0;
        }
        
        .portfolio-selected-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--primary-lighter);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .portfolio-selected-item .project-name {
            flex: 1;
            font-weight: 600;
            font-size: 0.9em;
            color: var(--gray-800);
        }
        
        .portfolio-selected-item .project-budget {
            font-weight: 700;
            color: var(--primary);
            font-size: 0.85em;
        }
        
        .portfolio-selected-item .remove-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: none;
            background: var(--gray-300);
            color: white;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
        }
        
        .portfolio-selected-item .remove-btn:hover {
            background: var(--danger);
        }
        
        .empty-portfolio {
            text-align: center;
            padding: 20px;
            color: var(--gray-400);
            font-style: italic;
            font-size: 0.9em;
        }
        
        /* Matrix Main Area */
        .portfolio-main {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }
        
        .matrix-header h2 {
            margin: 0 0 5px;
            color: var(--primary);
        }
        
        .matrix-header p {
            margin: 0 0 12px;
            color: var(--gray-500);
            font-size: 0.95em;
        }
        
        .interaction-hint {
            display: flex;
            align-items: center;
            gap: 10px;
            background: linear-gradient(90deg, var(--primary-lighter) 0%, #fef3c720 100%);
            padding: 12px 18px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 2px dashed var(--primary-light);
        }
        
        .interaction-hint .hint-icon {
            font-size: 1.4em;
        }
        
        .interaction-hint span {
            color: var(--primary);
            font-weight: 500;
            font-size: 0.95em;
        }
        
        .clickable-hint {
            background: var(--primary-lighter);
            padding: 4px 8px;
            border-radius: 6px;
        }
        
        .matrix-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .matrix-tab {
            padding: 10px 16px;
            border: 2px solid var(--gray-200);
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            color: var(--gray-600);
            transition: all 0.2s;
        }
        
        .matrix-tab:hover {
            border-color: var(--primary-light);
            background: var(--primary-lighter);
        }
        
        .matrix-tab.active {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }
        
        /* 2x2 Matrix */
        .matrix-container {
            position: relative;
            width: 100%;
            aspect-ratio: 1;
            max-height: 500px;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            overflow: hidden;
        }
        
        .matrix-quadrant {
            position: absolute;
            width: 50%;
            height: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }
        
        .matrix-quadrant.q1 { top: 0; right: 0; background: #dcfce720; }
        .matrix-quadrant.q2 { top: 0; left: 0; background: #fef3c720; }
        .matrix-quadrant.q3 { bottom: 0; left: 0; background: #fee2e220; }
        .matrix-quadrant.q4 { bottom: 0; right: 0; background: #dbeafe20; }
        
        .quadrant-label {
            position: absolute;
            font-size: 0.75em;
            font-weight: 600;
            color: var(--gray-400);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-align: center;
            padding: 8px;
            pointer-events: none;
        }
        
        .q1 .quadrant-label { top: 8px; right: 8px; color: #166534; }
        .q2 .quadrant-label { top: 8px; left: 8px; color: #92400e; }
        .q3 .quadrant-label { bottom: 8px; left: 8px; color: #991b1b; }
        .q4 .quadrant-label { bottom: 8px; right: 8px; color: #1e40af; }
        
        .matrix-axis {
            position: absolute;
            background: var(--gray-300);
            pointer-events: none;
        }
        
        .matrix-axis.horizontal {
            width: 100%;
            height: 2px;
            top: 50%;
            left: 0;
        }
        
        .matrix-axis.vertical {
            width: 2px;
            height: 100%;
            top: 0;
            left: 50%;
        }
        
        .axis-label {
            position: absolute;
            font-size: 0.8em;
            font-weight: 600;
            color: var(--gray-600);
            background: white;
            padding: 4px 8px;
            border-radius: 4px;
            pointer-events: none;
        }
        
        .axis-label.x-min { bottom: 50%; left: 8px; transform: translateY(50%); }
        .axis-label.x-max { bottom: 50%; right: 8px; transform: translateY(50%); }
        .axis-label.y-min { bottom: 8px; left: 50%; transform: translateX(-50%); }
        .axis-label.y-max { top: 8px; left: 50%; transform: translateX(-50%); }
        
        /* Project Bubbles */
        .project-bubble {
            position: absolute;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.75em;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 10;
        }
        
        .project-bubble:hover {
            transform: scale(1.15);
            z-index: 20;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .project-bubble.available {
            background: var(--gray-400);
            border: 3px solid var(--gray-500);
        }
        
        .project-bubble.selected {
            background: var(--primary);
            border: 3px solid var(--gold);
            box-shadow: 0 0 0 3px var(--primary-lighter), 0 4px 12px rgba(89, 49, 95, 0.4);
        }
        
        .project-bubble.unaffordable {
            background: var(--gray-300);
            border: 3px dashed var(--gray-400);
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Triage-based bubble states */
        .project-bubble.funded {
            background: #22c55e;
            border: 3px solid #166534;
            cursor: default;
        }
        
        .project-bubble.funded:hover {
            transform: scale(1.1);
        }
        
        .project-bubble.marginal-in {
            background: var(--primary);
            border: 3px solid var(--gold);
            box-shadow: 0 0 0 3px var(--primary-lighter), 0 4px 12px rgba(89, 49, 95, 0.4);
            cursor: pointer;
        }
        
        .project-bubble.marginal-in:hover {
            background: #dc2626;
            border-color: #991b1b;
            box-shadow: 0 0 0 3px #fee2e2, 0 4px 12px rgba(220, 38, 38, 0.4);
        }
        
        .project-bubble.marginal-in:hover::after {
            content: '−';
            position: absolute;
            font-size: 1.5em;
            font-weight: bold;
        }
        
        .project-bubble.marginal-out {
            background: white;
            border: 3px dashed var(--primary);
            color: var(--primary);
            cursor: pointer;
            animation: pulse-border 2s infinite;
        }
        
        .project-bubble.marginal-out:hover {
            background: var(--primary-lighter);
            border-style: solid;
            border-color: var(--primary);
            animation: none;
            box-shadow: 0 0 0 4px var(--primary-lighter), 0 4px 12px rgba(89, 49, 95, 0.3);
        }
        
        .project-bubble.marginal-out:hover::after {
            content: '+';
            position: absolute;
            font-size: 1.5em;
            font-weight: bold;
            color: var(--primary);
        }
        
        @keyframes pulse-border {
            0%, 100% { border-color: var(--primary); opacity: 1; }
            50% { border-color: var(--primary-light); opacity: 0.7; }
        }
        
        .project-bubble.stopped {
            background: var(--gray-300);
            border: 3px solid var(--gray-400);
            opacity: 0.35;
            cursor: not-allowed;
        }
        
        .project-bubble.stopped:hover {
            transform: scale(1.05);
        }
        
        /* Year 1 Review bubble states */
        .project-bubble.review-success {
            background: #22c55e;
            border: 3px solid #166534;
            cursor: default;
        }
        
        .project-bubble.review-failed {
            background: #ef4444;
            border: 3px solid #b91c1c;
            cursor: default;
        }
        
        .project-bubble.review-killed {
            background: #6b7280;
            border: 3px solid #374151;
            cursor: default;
        }
        
        .project-bubble.review-active {
            background: #3b82f6;
            border: 3px solid #1d4ed8;
            cursor: default;
        }
        
        .project-bubble .bubble-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--gray-800);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.85em;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            margin-bottom: 8px;
            z-index: 100;
        }
        
        .project-bubble:hover .bubble-tooltip {
            opacity: 1;
        }
        
        .bubble-tooltip .tooltip-name {
            font-weight: 700;
        }
        
        .bubble-tooltip .tooltip-budget {
            color: var(--gold);
        }
        
        /* Matrix Legend */
        .matrix-legend {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--gray-200);
            flex-wrap: wrap;
        }
        
        .matrix-legend .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85em;
            color: var(--gray-600);
        }
        
        .legend-bubble {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }
        
        .legend-bubble.available {
            background: var(--gray-400);
            border: 2px solid var(--gray-500);
        }
        
        .legend-bubble.selected {
            background: var(--primary);
            border: 2px solid var(--gold);
        }
        
        .legend-bubble.unaffordable {
            background: var(--gray-300);
            border: 2px dashed var(--gray-400);
            opacity: 0.5;
        }
        
        .legend-bubble.funded {
            background: #22c55e;
            border: 2px solid #166534;
        }
        
        .legend-bubble.marginal-in {
            background: var(--primary);
            border: 2px solid var(--gold);
        }
        
        .legend-bubble.marginal-out {
            background: white;
            border: 2px dashed var(--primary);
        }
        
        .legend-bubble.stopped {
            background: var(--gray-300);
            border: 2px solid var(--gray-400);
            opacity: 0.4;
        }
        
        .legend-size {
            font-size: 0.8em;
            color: var(--gray-400);
            font-style: italic;
        }
        
        /* Triage Phase Styles */
        .triage-layout {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .triage-header {
            background: white;
            padding: 25px;
            border-radius: 16px;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .triage-header h2 {
            margin: 0 0 8px;
            color: var(--primary);
        }
        
        .triage-header p {
            margin: 0 0 20px;
            color: var(--gray-600);
        }
        
        .triage-budget-summary {
            background: var(--gray-50);
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .triage-budget-bar {
            height: 10px;
            background: var(--gray-200);
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        
        .triage-budget-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e 0%, var(--primary) 100%);
            border-radius: 5px;
            transition: width 0.3s;
        }
        
        .triage-budget-text {
            font-size: 0.9em;
            color: var(--gray-600);
        }
        
        .triage-budget-text .funded-amount {
            color: #166534;
            font-weight: 700;
        }
        
        .triage-budget-text .marginal-amount {
            color: var(--primary);
            font-weight: 600;
        }
        
        .triage-budget-text .separator {
            color: var(--gray-300);
            margin: 0 10px;
        }
        
        .triage-counts {
            display: flex;
            gap: 20px;
            justify-content: center;
        }
        
        .triage-count {
            text-align: center;
            padding: 12px 25px;
            border-radius: 10px;
        }
        
        .triage-count.fund {
            background: #dcfce7;
        }
        
        .triage-count.marginal {
            background: var(--primary-lighter);
        }
        
        .triage-count.stop {
            background: var(--gray-100);
        }
        
        .triage-count .count-num {
            display: block;
            font-size: 1.8em;
            font-weight: 700;
        }
        
        .triage-count.fund .count-num { color: #166534; }
        .triage-count.marginal .count-num { color: var(--primary); }
        .triage-count.stop .count-num { color: var(--gray-500); }
        
        .triage-count .count-label {
            font-size: 0.85em;
            color: var(--gray-600);
        }
        
        /* Triage Cards */
        .triage-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .triage-card {
            background: white;
            border-radius: 14px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.2s;
            border: 2px solid var(--gray-200);
        }
        
        .triage-card.status-fund {
            border-color: #22c55e;
            background: linear-gradient(180deg, #dcfce7 0%, white 30%);
        }
        
        .triage-card.status-marginal {
            border-color: var(--primary);
            background: linear-gradient(180deg, var(--primary-lighter) 0%, white 30%);
        }
        
        .triage-card.status-stop {
            border-color: var(--gray-300);
            opacity: 0.6;
        }
        
        .triage-card-header {
            padding: 15px 18px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 15px;
        }
        
        .triage-card-rank {
            width: 32px;
            height: 32px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9em;
            flex-shrink: 0;
        }
        
        .triage-card-title {
            flex: 1;
        }
        
        .triage-card-title h4 {
            margin: 0 0 4px;
            font-size: 1.05em;
            color: var(--gray-800);
        }
        
        .triage-card-title .tagline {
            font-size: 0.85em;
            color: var(--gray-500);
            font-style: italic;
        }
        
        .triage-card-budget {
            font-weight: 700;
            font-size: 1.1em;
            color: var(--gold-dark);
            background: var(--gold-light);
            padding: 6px 12px;
            border-radius: 8px;
            white-space: nowrap;
        }
        
        .triage-card-scores {
            padding: 0 18px 15px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .score-pill {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
        }
        
        .score-pill.your-score {
            background: var(--primary-lighter);
            color: var(--primary);
        }
        
        .score-pill.avg-score {
            background: var(--gray-100);
            color: var(--gray-700);
        }
        
        .score-pill.consensus {
            background: #fef3c7;
            color: #92400e;
        }
        
        .score-pill strong {
            font-weight: 700;
        }
        
        .triage-card-lead {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 18px;
            background: var(--gray-50);
            cursor: pointer;
            transition: background 0.2s;
            border-top: 1px solid var(--gray-100);
        }
        
        .triage-card-lead:hover {
            background: var(--primary-lighter);
        }
        
        .triage-lead-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.75em;
            flex-shrink: 0;
        }
        
        .triage-lead-info {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
        }
        
        .triage-lead-name {
            font-weight: 600;
            font-size: 0.85em;
            color: var(--gray-800);
        }
        
        .triage-lead-role {
            font-size: 0.75em;
            color: var(--gray-500);
        }
        
        .triage-lead-track {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75em;
            font-weight: 700;
        }
        
        .triage-lead-track.success {
            background: var(--success-light);
            color: var(--success);
        }
        
        .triage-lead-track.warning {
            background: var(--warning-light);
            color: var(--warning);
        }
        
        .triage-lead-track.danger {
            background: var(--danger-light);
            color: var(--danger);
        }
        
        .triage-card-actions {
            padding: 12px 18px;
            background: var(--gray-50);
            display: flex;
            gap: 8px;
        }
        
        .triage-btn {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid transparent;
            border-radius: 8px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .triage-btn.fund-btn {
            background: white;
            border-color: #22c55e;
            color: #166534;
        }
        
        .triage-btn.fund-btn:hover, .triage-btn.fund-btn.active {
            background: #22c55e;
            color: white;
        }
        
        .triage-btn.marginal-btn {
            background: white;
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .triage-btn.marginal-btn:hover, .triage-btn.marginal-btn.active {
            background: var(--primary);
            color: white;
        }
        
        .triage-btn.stop-btn {
            background: white;
            border-color: var(--gray-400);
            color: var(--gray-600);
        }
        
        .triage-btn.stop-btn:hover, .triage-btn.stop-btn.active {
            background: var(--gray-500);
            color: white;
        }
        
        .triage-btn.info-btn {
            flex: 0;
            padding: 10px 14px;
            background: white;
            border-color: var(--gray-300);
            color: var(--gray-600);
        }
        
        .triage-btn.info-btn:hover {
            background: var(--gray-100);
        }
        
        /* Modal triage actions */
        .modal-triage-actions {
            margin: 25px 0;
            padding: 20px;
            background: var(--gray-50);
            border-radius: 12px;
            border: 2px solid var(--gray-200);
        }
        
        .modal-triage-actions h3 {
            margin: 0 0 15px 0;
            font-size: 1em;
            color: var(--gray-700);
        }
        
        .modal-triage-buttons {
            display: flex;
            gap: 10px;
        }
        
        .modal-triage-buttons .triage-btn {
            flex: 1;
            padding: 14px 16px;
            font-size: 1em;
        }
        
        /* Year 2 Assessment Styles */
        .feedback-tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .feedback-tab {
            padding: 10px 20px;
            border: 2px solid var(--gray-200);
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            color: var(--gray-600);
            transition: all 0.2s;
        }
        
        .feedback-tab:hover {
            border-color: var(--primary-light);
        }
        
        .feedback-tab.active {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }
        
        .feedback-tab-content.hidden {
            display: none;
        }
        
        .rankings-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .ranking-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 10px;
            transition: all 0.2s;
        }
        
        .ranking-item:hover {
            border-color: var(--primary-light);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .ranking-item.ongoing {
            background: var(--gray-50);
            border-left: 4px solid var(--primary);
        }
        
        .ranking-rank {
            font-size: 1.3em;
            font-weight: 700;
            min-width: 45px;
            text-align: center;
        }
        
        .ranking-info {
            flex: 1;
        }
        
        .ranking-name {
            font-weight: 600;
            color: var(--gray-800);
        }
        
        .ranking-tagline {
            font-size: 0.85em;
            color: var(--gray-500);
            margin-top: 2px;
        }
        
        .ranking-scores {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .score-pill.you {
            background: var(--primary-lighter);
            color: var(--primary);
        }
        
        .score-pill.committee {
            background: var(--gold-light);
            color: var(--gold);
        }
        
        .score-pill.overall {
            background: var(--success-light);
            color: var(--success);
            font-weight: 600;
        }
        
        .ranking-budget {
            font-weight: 600;
            color: var(--gray-600);
            min-width: 80px;
            text-align: right;
        }
        
        /* Comparison View */
        .comparison-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .comparison-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
        }
        
        .comparison-item.new {
            border-left: 4px solid var(--success);
        }
        
        .comparison-item.ongoing {
            border-left: 4px solid var(--primary);
            background: var(--gray-50);
        }
        
        .comparison-rank {
            font-weight: 700;
            min-width: 35px;
            color: var(--gray-500);
        }
        
        .comparison-badge {
            font-size: 1.2em;
        }
        
        .comparison-info {
            flex: 1;
        }
        
        .comparison-name {
            font-weight: 500;
        }
        
        .comparison-score {
            font-weight: 700;
            font-size: 1.1em;
            color: var(--primary);
        }
        
        .comparison-budget {
            color: var(--gray-500);
            font-size: 0.9em;
        }
        
        .comparison-insight {
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .comparison-insight.success {
            background: var(--success-light);
            border: 1px solid var(--success);
            color: var(--success);
        }
        
        .comparison-insight.info {
            background: var(--info-light);
            border: 1px solid var(--info);
            color: var(--info);
        }
        
        /* Year 2 Triage Grid */
        .triage-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .triage-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .triage-project-info {
            flex: 1;
            min-width: 200px;
        }
        
        .triage-project-name {
            font-weight: 600;
            display: block;
        }
        
        .triage-project-score {
            font-size: 0.85em;
            color: var(--gray-500);
        }
        
        .triage-buttons {
            display: flex;
            gap: 8px;
        }
        
        .triage-btn {
            padding: 8px 16px;
            border: 2px solid var(--gray-200);
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9em;
            transition: all 0.2s;
        }
        
        .triage-btn.fund {
            border-color: var(--success);
            color: var(--success);
        }
        
        .triage-btn.fund.selected, .triage-btn.fund:hover {
            background: var(--success);
            color: white;
        }
        
        .triage-btn.marginal {
            border-color: var(--warning);
            color: var(--warning);
        }
        
        .triage-btn.marginal.selected, .triage-btn.marginal:hover {
            background: var(--warning);
            color: white;
        }
        
        .triage-btn.stop {
            border-color: var(--danger);
            color: var(--danger);
        }
        
        .triage-btn.stop.selected, .triage-btn.stop:hover {
            background: var(--danger);
            color: white;
        }
        
        .project-badge.year2 {
            background: var(--success);
            color: white;
        }
        
        /* Portfolio View Tabs */
        .portfolio-view-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .view-tab {
            padding: 10px 20px;
            border: 2px solid var(--gray-200);
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            color: var(--gray-600);
            transition: all 0.2s;
        }
        
        .view-tab:hover {
            border-color: var(--primary-light);
        }
        
        .view-tab.active {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }
        
        /* Portfolio List View */
        .portfolio-list-sections {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .portfolio-list-section {
            background: var(--gray-50);
            border-radius: 12px;
            padding: 18px;
        }
        
        .portfolio-list-section h3 {
            margin: 0 0 15px;
            font-size: 1em;
            color: var(--gray-700);
        }
        
        .portfolio-list-section .section-hint {
            font-weight: 400;
            color: var(--gray-400);
            font-size: 0.9em;
        }
        
        .portfolio-list-section.funded-section {
            background: #dcfce710;
            border: 1px solid #dcfce7;
        }
        
        .portfolio-list-section.marginal-section {
            background: var(--primary-lighter);
            border: 1px solid var(--primary-light);
        }
        
        .portfolio-list-section.stopped-section {
            opacity: 0.6;
        }
        
        .portfolio-list-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .portfolio-list-item:last-child {
            margin-bottom: 0;
        }
        
        .portfolio-list-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .portfolio-list-item.in-portfolio {
            border-left: 4px solid var(--primary);
        }
        
        .portfolio-list-item .item-rank {
            width: 28px;
            height: 28px;
            background: var(--gray-200);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.8em;
            color: var(--gray-600);
        }
        
        .portfolio-list-item .item-info {
            flex: 1;
        }
        
        .portfolio-list-item .item-name {
            font-weight: 600;
            color: var(--gray-800);
            font-size: 0.95em;
            display: block;
        }
        
        .portfolio-list-item .item-detail {
            font-size: 0.8em;
            color: var(--gray-500);
            display: block;
            margin-top: 2px;
        }
        
        .portfolio-list-item .item-status {
            font-size: 0.85em;
            font-weight: 500;
        }
        
        .portfolio-list-item .item-scores {
            font-size: 0.8em;
            color: var(--gray-500);
        }
        
        .portfolio-list-item .item-budget {
            font-weight: 700;
            color: var(--primary);
        }
        
        .portfolio-list-item .item-toggle {
            padding: 6px 14px;
            border-radius: 6px;
            border: none;
            font-size: 0.8em;
            font-weight: 600;
            cursor: pointer;
        }
        
        .portfolio-list-item .item-toggle.add {
            background: var(--primary-lighter);
            color: var(--primary);
        }
        
        .portfolio-list-item .item-toggle.remove {
            background: var(--gray-200);
            color: var(--gray-600);
        }
        
        .portfolio-list-item .item-details {
            padding: 6px 10px;
            background: transparent;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            cursor: pointer;
            color: var(--gray-500);
            font-size: 0.8em;
        }
        
        .portfolio-list-item .item-lead {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            transition: background 0.2s;
        }
        
        .portfolio-list-item .item-lead:hover {
            background: var(--primary-lighter);
        }
        
        .item-lead-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.65em;
        }
        
        .item-lead-name {
            font-size: 0.8em;
            color: var(--gray-600);
        }
        
        .item-lead-score {
            font-size: 0.7em;
            font-weight: 700;
            padding: 2px 5px;
            border-radius: 4px;
        }
        
        .item-lead-score.success {
            background: var(--success-light);
            color: var(--success);
        }
        
        .item-lead-score.warning {
            background: var(--warning-light);
            color: var(--warning);
        }
        
        .item-lead-score.danger {
            background: var(--danger-light);
            color: var(--danger);
        }
        
        /* TRL Display Styles */
        .trl-display { margin-top: 10px; }
        .trl-bar { display: flex; gap: 4px; margin-bottom: 10px; }
        .trl-level { 
            flex: 1; height: 35px; display: flex; align-items: center; justify-content: center;
            background: var(--gray-200); border-radius: 4px; font-weight: 600; font-size: 0.85em; color: var(--gray-400);
            transition: all 0.2s;
        }
        .trl-level.target { background: var(--info-light); color: var(--info); }
        .trl-level.current { background: var(--primary); color: white; }
        .trl-legend { display: flex; gap: 20px; font-size: 0.85em; color: var(--gray-600); }
        .trl-dot { display: inline-block; width: 12px; height: 12px; border-radius: 3px; margin-right: 6px; vertical-align: middle; }
        .trl-dot.current { background: var(--primary); }
        .trl-dot.target { background: var(--info-light); border: 2px solid var(--info); }
        
        .trl-explainer { margin-top: 15px; font-size: 0.85em; }
        .trl-explainer summary { cursor: pointer; color: var(--primary); font-weight: 500; }
        .trl-definitions { margin-top: 10px; display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 8px; }
        .trl-def { background: var(--white); padding: 8px 12px; border-radius: 6px; font-size: 0.9em; }
        
        /* IP Position Styles */
        .ip-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
        .ip-box { background: var(--white); padding: 15px; border-radius: 8px; border: 1px solid var(--gray-200); }
        .ip-box-header { font-weight: 600; margin-bottom: 8px; color: var(--gray-700); }
        .ip-box p { font-size: 0.9em; color: var(--gray-600); margin: 0; }
        
        .fto-assessment { 
            margin-top: 15px; padding: 12px 15px; border-radius: 8px; font-size: 0.9em;
            display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;
        }
        .fto-assessment.low-risk { background: var(--success-light); color: var(--success); }
        .fto-assessment.medium-risk { background: var(--warning-light); color: var(--warning); }
        .fto-assessment.high-risk { background: var(--danger-light); color: var(--danger); }
        .fto-risk-badge { 
            padding: 4px 10px; border-radius: 12px; font-weight: 600; font-size: 0.85em;
            background: rgba(255,255,255,0.5);
        }
        
        /* Competitors Styles */
        .competitors-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; margin-top: 10px; }
        .competitor-card { 
            background: var(--white); padding: 15px; border-radius: 8px; 
            border-left: 4px solid var(--gray-300);
        }
        .competitor-card.threat-very-high { border-left-color: var(--danger); }
        .competitor-card.threat-high { border-left-color: #f97316; }
        .competitor-card.threat-medium { border-left-color: var(--warning); }
        .competitor-card.threat-medium-high { border-left-color: #f97316; }
        .competitor-card.threat-low { border-left-color: var(--success); }
        .competitor-name { font-weight: 600; color: var(--gray-800); margin-bottom: 6px; }
        .competitor-position { font-size: 0.85em; color: var(--gray-600); margin-bottom: 8px; }
        .competitor-threat { font-size: 0.8em; color: var(--gray-500); }
        
        @media (max-width: 600px) {
            .ip-grid { grid-template-columns: 1fr; }
            .trl-bar { flex-wrap: wrap; }
            .trl-level { min-width: 30px; }
        }
        
        /* Development Costs Styles */
        .dev-costs-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-top: 12px; }
        .dev-cost-item { 
            background: var(--white); padding: 12px; border-radius: 8px; text-align: center;
            border: 1px solid var(--gray-200);
        }
        .dev-cost-item.total { background: var(--primary); color: white; border: none; }
        .dev-cost-amount { font-size: 1.2em; font-weight: 700; color: var(--primary); }
        .dev-cost-item.total .dev-cost-amount { color: white; }
        .dev-cost-label { font-size: 0.75em; color: var(--gray-500); margin-top: 2px; }
        .dev-cost-item.total .dev-cost-label { color: rgba(255,255,255,0.8); }
        .dev-cost-pct { font-size: 0.7em; color: var(--gray-400); }
        .dev-cost-item.total .dev-cost-pct { color: rgba(255,255,255,0.6); }
        
        /* Milestones Styles */
        .milestones-timeline { margin-top: 15px; }
        .milestone-item { 
            background: var(--white); border-radius: 10px; padding: 18px; margin-bottom: 15px;
            border-left: 4px solid var(--primary); position: relative;
        }
        .milestone-item::before {
            content: ''; position: absolute; left: -10px; top: 24px;
            width: 16px; height: 16px; background: var(--primary); border-radius: 50%;
            border: 3px solid var(--white);
        }
        .milestone-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; flex-wrap: wrap; gap: 10px; }
        .milestone-phase { font-weight: 700; color: var(--primary); font-size: 1.05em; }
        .milestone-meta { display: flex; gap: 15px; font-size: 0.85em; color: var(--gray-500); }
        .milestone-meta span { display: flex; align-items: center; gap: 4px; }
        
        .milestone-deliverables { margin-bottom: 12px; }
        .milestone-deliverables-title { font-size: 0.8em; font-weight: 600; color: var(--gray-600); margin-bottom: 6px; text-transform: uppercase; }
        .deliverable-tag { 
            display: inline-block; background: var(--gray-100); padding: 4px 10px; 
            border-radius: 12px; font-size: 0.8em; margin: 2px 4px 2px 0; color: var(--gray-700);
        }
        
        .milestone-metrics { background: var(--gray-50); border-radius: 8px; padding: 12px; }
        .milestone-metrics-title { font-size: 0.8em; font-weight: 600; color: var(--gray-600); margin-bottom: 8px; text-transform: uppercase; }
        .metric-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--gray-200); font-size: 0.85em; }
        .metric-row:last-child { border-bottom: none; }
        .metric-name { color: var(--gray-600); }
        .metric-target { color: var(--primary); font-weight: 500; text-align: right; max-width: 60%; }
        
        .milestone-gate { 
            margin-top: 12px; padding: 10px 12px; background: var(--warning-light); 
            border-radius: 6px; font-size: 0.85em; color: var(--warning);
            display: flex; align-items: center; gap: 8px;
        }
        .milestone-gate::before { content: '🚦'; }
        
        .milestones-summary { 
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; 
            margin-bottom: 15px; background: var(--gray-50); padding: 15px; border-radius: 10px;
        }
        .milestone-summary-item { text-align: center; }
        .milestone-summary-phase { font-size: 0.8em; color: var(--primary); font-weight: 600; margin-bottom: 4px; }
        .milestone-summary-duration { font-weight: 600; color: var(--gray-700); font-size: 0.85em; }
        .milestone-summary-cost { font-size: 0.8em; color: var(--gray-500); }
        
        @media (max-width: 600px) {
            .milestones-summary { grid-template-columns: repeat(2, 1fr); }
            .milestone-header { flex-direction: column; }
        }
        
        /* Collapsible Details Styles */
        .info-details { margin-top: 12px; }
        .info-details summary { 
            cursor: pointer; color: var(--primary); font-weight: 500; font-size: 0.9em;
            padding: 8px 12px; background: var(--primary-lighter); border-radius: 6px;
            list-style: none;
        }
        .info-details summary::-webkit-details-marker { display: none; }
        .info-details summary::before { content: '▶ '; font-size: 0.8em; }
        .info-details[open] summary::before { content: '▼ '; }
        .info-details > *:not(summary) { margin-top: 12px; }
        
        /* Key Facts Grid */
        .key-facts-grid {
            display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px;
            margin-bottom: 20px; padding: 15px; background: var(--primary); border-radius: 12px;
        }
        .key-fact { text-align: center; color: white; }
        .key-fact-value { font-size: 1.1em; font-weight: 700; }
        .key-fact-label { font-size: 0.7em; opacity: 0.8; text-transform: uppercase; letter-spacing: 0.5px; }
        .key-fact-value.fto-low, .key-fact-value.fto-lowmedium { color: #86efac; }
        .key-fact-value.fto-medium { color: #fde047; }
        .key-fact-value.fto-high, .key-fact-value.fto-mediumhigh { color: #fca5a5; }
        @media (max-width: 700px) { .key-facts-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 400px) { .key-facts-grid { grid-template-columns: repeat(2, 1fr); } }
        
        /* Section Details (major collapsible sections) */
        .section-details { 
            margin-bottom: 12px; border: 1px solid var(--gray-200); border-radius: 10px; 
            background: white; overflow: hidden;
        }
        .section-summary {
            cursor: pointer; padding: 14px 16px; display: flex; align-items: center; gap: 12px;
            background: var(--gray-50); list-style: none; transition: background 0.2s;
        }
        .section-summary:hover { background: var(--gray-100); }
        .section-summary::-webkit-details-marker { display: none; }
        .section-icon { font-size: 1.2em; }
        .section-title { font-weight: 600; color: var(--gray-800); flex: 1; }
        .section-hint { font-size: 0.85em; color: var(--gray-500); }
        .section-summary::after { content: '▶'; font-size: 0.7em; color: var(--gray-400); transition: transform 0.2s; }
        .section-details[open] .section-summary::after { transform: rotate(90deg); }
        .section-content { padding: 16px; border-top: 1px solid var(--gray-200); }
        
        /* Assessment Subsections */
        .assessment-subsection { margin-bottom: 16px; }
        .assessment-subsection:last-child { margin-bottom: 0; }
        .assessment-subsection h5 { 
            font-size: 0.85em; font-weight: 600; color: var(--primary); 
            margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .assessment-subsection p { color: var(--gray-600); line-height: 1.6; font-size: 0.95em; }
        
        /* Financial Box */
        .financial-box {
            background: var(--gray-50); padding: 12px; border-radius: 8px; text-align: center;
        }
        .financial-value { font-weight: 700; color: var(--primary); font-size: 0.95em; }
        .financial-label { font-size: 0.75em; color: var(--gray-500); margin-top: 2px; }
        
        /* Cost Breakdown Bar */
        .cost-breakdown-bar {
            display: flex; height: 24px; border-radius: 6px; overflow: hidden; margin-top: 10px;
        }
        .cost-segment { height: 100%; transition: width 0.3s; }
        .cost-legend {
            display: flex; flex-wrap: wrap; gap: 12px; margin-top: 8px; font-size: 0.8em; color: var(--gray-600);
        }
        .legend-dot { display: inline-block; width: 10px; height: 10px; border-radius: 2px; margin-right: 4px; }
        
        /* Project Short Description */
        .project-short-desc { color: var(--gray-700); line-height: 1.6; margin-bottom: 8px; }
        .full-description { padding: 15px; background: var(--gray-50); border-radius: 8px; }
        .full-description p { color: var(--gray-700); line-height: 1.7; white-space: pre-line; }
        
        /* Criteria Weighting Styles */
        .weights-container {
            background: white; border-radius: 12px; padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 25px;
        }
        .weights-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid var(--gray-100);
        }
        .weights-total-display {
            display: flex; align-items: baseline; gap: 5px;
        }
        .weights-label { font-size: 1em; color: var(--gray-500); }
        .weights-value { 
            font-size: 2.5em; font-weight: 800; 
            transition: color 0.3s;
        }
        .weights-value.under { color: var(--warning); }
        .weights-value.exact { color: var(--success); }
        .weights-value.over { color: var(--danger); }
        .weights-target { font-size: 1.2em; color: var(--gray-400); }
        .weights-status {
            padding: 8px 16px; border-radius: 20px; font-size: 0.9em; font-weight: 500;
            background: var(--gray-100); color: var(--gray-600);
        }
        .weights-status.valid { background: #dcfce7; color: #166534; }
        .weights-status.invalid { background: #fef2f2; color: #991b1b; }
        
        .weights-grid {
            display: flex; flex-direction: column; gap: 12px;
        }
        .weight-item {
            display: grid; grid-template-columns: 50px 1fr 120px 80px; gap: 15px;
            align-items: center; padding: 15px 20px;
            background: var(--gray-50); border-radius: 10px;
            border: 2px solid transparent; transition: all 0.2s;
        }
        .weight-item:hover { border-color: var(--primary-light); }
        .weight-item.has-value { background: var(--primary-lighter); }
        .weight-icon {
            width: 44px; height: 44px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.3em; color: white;
        }
        .weight-info h4 { margin: 0 0 4px; color: var(--gray-800); font-size: 1em; }
        .weight-info p { margin: 0; color: var(--gray-500); font-size: 0.85em; }
        .weight-slider-container { display: flex; flex-direction: column; gap: 6px; }
        .weight-slider {
            width: 100%; height: 8px; border-radius: 4px; background: var(--gray-200);
            -webkit-appearance: none; appearance: none; cursor: pointer;
        }
        .weight-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%;
            background: var(--primary); cursor: pointer; border: 3px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        .weight-slider::-moz-range-thumb {
            width: 20px; height: 20px; border-radius: 50%;
            background: var(--primary); cursor: pointer; border: 3px solid white;
        }
        .weight-input-group {
            display: flex; align-items: center; gap: 5px;
        }
        .weight-input {
            width: 60px; padding: 8px 10px; border: 2px solid var(--gray-200);
            border-radius: 8px; font-size: 1.1em; font-weight: 700; text-align: center;
            color: var(--primary);
        }
        .weight-input:focus { border-color: var(--primary); outline: none; }
        .weight-pct { color: var(--gray-400); font-weight: 600; }
        
        .weights-actions {
            display: flex; gap: 10px; margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--gray-200);
        }
        .btn-text {
            background: none; border: none; color: var(--primary); cursor: pointer;
            font-size: 0.9em; padding: 8px 15px; border-radius: 6px;
        }
        .btn-text:hover { background: var(--primary-lighter); }
        
        .weights-preview {
            background: white; border-radius: 12px; padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .weights-preview h3 { margin: 0 0 15px; color: var(--gray-700); font-size: 1em; }
        .weights-formula {
            display: flex; flex-wrap: wrap; gap: 8px; align-items: center;
            padding: 15px; background: var(--gray-50); border-radius: 8px;
            font-family: 'Courier New', monospace; font-size: 0.9em;
        }
        .formula-term {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 6px 10px; background: white; border-radius: 6px;
            border: 1px solid var(--gray-200);
        }
        .formula-weight { font-weight: 700; color: var(--primary); }
        .formula-criteria { color: var(--gray-600); }
        .formula-operator { color: var(--gray-400); font-weight: 700; padding: 0 5px; }
        
        @media (max-width: 700px) {
            .weight-item { grid-template-columns: 40px 1fr; gap: 10px; }
            .weight-slider-container { grid-column: span 2; }
            .weight-input-group { grid-column: span 2; justify-content: flex-end; }
        }
        
        .milestone-metrics-details { margin-top: 10px; }
        .milestone-metrics-details summary { 
            cursor: pointer; color: var(--gray-600); font-size: 0.85em; font-weight: 500;
            padding: 6px 10px; background: var(--gray-100); border-radius: 4px;
        }
        .milestone-metrics-details summary::-webkit-details-marker { display: none; }
        .milestone-metrics-details summary::before { content: '▶ '; font-size: 0.75em; }
        .milestone-metrics-details[open] summary::before { content: '▼ '; }
        .milestone-metrics-details .milestone-metrics { margin-top: 10px; }
        .milestone-metrics-details .milestone-gate { margin-top: 10px; }
        
        /* Cost Summary Styles */
        .cost-summary { 
            display: flex; flex-wrap: wrap; gap: 15px; align-items: center;
            padding: 12px 15px; background: var(--primary); border-radius: 8px; color: white;
        }
        .cost-total { font-size: 1.1em; }
        .cost-breakdown-hint { font-size: 0.85em; opacity: 0.8; }
        
        /* Competitors Summary Styles */
        .competitors-summary { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
        .competitor-pill { 
            padding: 6px 12px; border-radius: 15px; font-size: 0.85em; font-weight: 500;
            background: var(--gray-100); color: var(--gray-700);
        }
        .competitor-pill.threat-very-high { background: #fee2e2; color: #991b1b; }
        .competitor-pill.threat-high { background: #ffedd5; color: #9a3412; }
        .competitor-pill.threat-medium { background: #fef3c7; color: #92400e; }
        .competitor-pill.threat-low { background: #d1fae5; color: #065f46; }
        .competitor-more { font-size: 0.85em; color: var(--gray-500); padding: 6px 0; }
        
        /* Milestones Header */
        .milestones-header { margin-bottom: 12px; }
        .total-duration { 
            display: inline-block; padding: 8px 15px; background: var(--primary); 
            color: white; border-radius: 20px; font-size: 0.9em;
        }
        
        /* Committee Feedback Styles */
        .committee-legend { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; padding: 15px; background: var(--gray-50); border-radius: 10px; }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 0.85em; }
        .legend-avatar { width: 28px; height: 28px; border-radius: 50%; }
        
        .feedback-grid { display: flex; flex-direction: column; gap: 15px; }
        
        .feedback-card {
            background: var(--white);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid var(--gray-200);
        }
        .feedback-card.high-consensus { border-left: 4px solid var(--success); }
        .feedback-card.low-consensus { border-left: 4px solid var(--warning); }
        
        .feedback-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .feedback-rank { font-size: 1.5em; font-weight: 700; color: var(--primary); width: 40px; }
        .feedback-project { flex: 1; }
        .feedback-project .project-name { font-weight: 600; font-size: 1.1em; }
        .feedback-avg-score { text-align: right; }
        .feedback-avg-score .score { font-size: 2em; font-weight: 700; color: var(--primary); }
        .feedback-avg-score .label { font-size: 0.75em; color: var(--gray-500); }
        
        .feedback-scores { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .member-score { display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: var(--gray-50); border-radius: 20px; font-size: 0.85em; }
        .member-score img { width: 24px; height: 24px; border-radius: 50%; }
        .member-score .score-val { font-weight: 600; }
        .member-score.your-score { background: var(--primary-lighter); border: 1px solid var(--primary-light); }
        .member-score.high { color: var(--success); }
        .member-score.low { color: var(--danger); }
        
        .consensus-note { margin-top: 12px; padding: 10px 15px; border-radius: 8px; font-size: 0.85em; }
        .consensus-note.aligned { background: var(--success-light); color: var(--success); }
        .consensus-note.divergent { background: var(--warning-light); color: var(--warning); }
        
        .score-badge { font-size: 0.75em; padding: 4px 10px; border-radius: 6px; font-weight: 500; }
        .score-badge.high { background: var(--success-light); color: var(--success); }
        .score-badge.medium { background: var(--warning-light); color: var(--warning); }
        .score-badge.low { background: var(--danger-light); color: var(--danger); }
        
        /* Quarterly review */
        .quarter-header {
            text-align: center;
            padding: 25px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 15px;
            margin-bottom: 25px;
            color: var(--white);
        }
        
        .quarter-header h2 { color: var(--white); margin-bottom: 5px; }
        .quarter-header p { color: rgba(255,255,255,0.8); margin: 0; }
        
        .portfolio-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 15px; width: 100%; }
        .portfolio-stat { text-align: center; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px; }
        .portfolio-stat .num { font-size: 1.4em; font-weight: 700; color: var(--gold); }
        .portfolio-stat .lbl { font-size: 0.8em; color: rgba(255,255,255,0.7); }
        
        .review-card {
            background: var(--white);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 5px solid var(--gray-300);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .review-card.status-green { border-left-color: var(--success); }
        .review-card.status-yellow { border-left-color: var(--warning); }
        .review-card.status-red { border-left-color: var(--danger); }
        
        .review-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .review-title-section { flex: 1; }
        .review-title { font-weight: 700; font-size: 1.25em; color: var(--gray-800); display: block; }
        .review-tagline { font-size: 0.9em; color: var(--gray-500); font-style: italic; }
        
        .status-badge { padding: 6px 14px; border-radius: 20px; font-size: 0.85em; font-weight: 600; }
        .status-badge.green { background: var(--success-light); color: var(--success); }
        .status-badge.yellow { background: var(--warning-light); color: var(--warning); }
        .status-badge.red { background: var(--danger-light); color: var(--danger); }
        
        /* Key facts grid */
        .review-key-facts {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            padding: 15px;
            background: var(--gray-50);
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .review-key-facts .fact-item {
            text-align: center;
        }
        
        .review-key-facts .fact-label {
            display: block;
            font-size: 0.75em;
            color: var(--gray-500);
            margin-bottom: 4px;
        }
        
        .review-key-facts .fact-value {
            font-weight: 700;
            color: var(--primary);
            font-size: 0.95em;
        }
        
        /* Progress section */
        .review-progress-section,
        .review-milestone-section,
        .review-narrative-section,
        .review-recommendation {
            margin-bottom: 20px;
        }
        
        .review-progress-section h4,
        .review-milestone-section h4,
        .review-narrative-section h4,
        .review-recommendation h4 {
            font-size: 0.95em;
            color: var(--gray-700);
            margin: 0 0 12px;
            font-weight: 600;
        }
        
        .review-metrics { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 15px; }
        .metric { text-align: center; padding: 12px; background: var(--gray-50); border-radius: 10px; }
        .metric .value { font-size: 1.2em; font-weight: 700; color: var(--primary); }
        .metric .label { font-size: 0.7em; color: var(--gray-500); margin-top: 4px; }
        .metric.warning { background: var(--warning-light); }
        .metric.warning .value { color: var(--warning); }
        
        /* Milestone track */
        .milestone-track {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 10px;
            background: var(--gray-50);
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        .milestone-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            position: relative;
        }
        
        .milestone-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--gray-300);
            border: 3px solid var(--gray-400);
            margin-bottom: 8px;
        }
        
        .milestone-item.complete .milestone-dot {
            background: var(--success);
            border-color: #166534;
        }
        
        .milestone-item.current .milestone-dot {
            background: var(--primary);
            border-color: var(--gold);
            box-shadow: 0 0 0 4px var(--primary-lighter);
        }
        
        .milestone-item.upcoming .milestone-dot {
            background: var(--gray-200);
            border-color: var(--gray-300);
        }
        
        .milestone-name {
            font-size: 0.75em;
            color: var(--gray-600);
            text-align: center;
        }
        
        .milestone-connector {
            flex: 0.5;
            height: 3px;
            background: var(--gray-300);
            margin-bottom: 20px;
        }
        
        .milestone-narrative {
            font-size: 0.9em;
            color: var(--gray-600);
            font-style: italic;
            margin: 0;
        }
        
        .review-narrative { 
            padding: 15px 20px; 
            background: var(--gray-50); 
            border-radius: 12px; 
            font-size: 0.95em; 
            font-style: italic; 
            color: var(--gray-600); 
            border-left: 3px solid var(--gold); 
            margin: 0;
        }
        
        /* Intel grid */
        .review-intel-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .intel-card {
            padding: 15px;
            border-radius: 10px;
            background: var(--gray-50);
        }
        
        .intel-card h5 {
            font-size: 0.85em;
            color: var(--gray-700);
            margin: 0 0 8px;
            font-weight: 600;
        }
        
        .intel-card p {
            font-size: 0.85em;
            color: var(--gray-600);
            margin: 0;
            line-height: 1.5;
        }
        
        .intel-card.competitor { border-left: 3px solid #6366f1; }
        .intel-card.ip { border-left: 3px solid #f59e0b; }
        .intel-card.team { border-left: 3px solid #10b981; }
        .intel-card.risk { border-left: 3px solid #ef4444; }
        
        /* Recommendation */
        .review-recommendation {
            padding: 15px 20px;
            background: linear-gradient(135deg, var(--primary-lighter) 0%, #fef3c720 100%);
            border-radius: 12px;
            border: 1px solid var(--primary-light);
        }
        
        .review-recommendation h4 {
            color: var(--primary);
        }
        
        .review-recommendation p {
            margin: 0;
            font-size: 0.95em;
            color: var(--gray-700);
            line-height: 1.5;
        }
        
        /* Enhanced action buttons */
        .review-actions { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 10px; 
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--gray-200);
        }
        
        .action-btn { 
            padding: 15px 12px; 
            border: 2px solid transparent; 
            border-radius: 12px; 
            cursor: pointer; 
            font-weight: 600; 
            font-size: 0.85em; 
            transition: all 0.2s; 
            font-family: inherit;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        
        .action-btn .action-icon { font-size: 1.4em; }
        .action-btn .action-label { font-weight: 700; }
        .action-btn .action-desc { font-size: 0.75em; font-weight: 400; opacity: 0.8; }
        
        .action-btn:hover { transform: translateY(-2px); }
        .action-btn.continue { background: var(--success-light); color: var(--success); border-color: #a7f3d0; }
        .action-btn.accelerate { background: var(--info-light); color: var(--info); border-color: #93c5fd; }
        .action-btn.reduce { background: var(--warning-light); color: var(--warning); border-color: #fcd34d; }
        .action-btn.kill { background: var(--danger-light); color: var(--danger); border-color: #fca5a5; }
        .action-btn.selected { transform: scale(1.02); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .action-btn.continue.selected { background: var(--success); color: white; }
        .action-btn.accelerate.selected { background: var(--info); color: white; }
        .action-btn.reduce.selected { background: var(--warning); color: white; }
        .action-btn.kill.selected { background: var(--danger); color: white; }
        
        @media (max-width: 768px) {
            .review-key-facts { grid-template-columns: repeat(2, 1fr); }
            .review-metrics { grid-template-columns: repeat(2, 1fr); }
            .review-intel-grid { grid-template-columns: 1fr; }
            .review-actions { grid-template-columns: repeat(2, 1fr); }
        }
        
        /* Review Tiles Grid */
        .review-tiles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .review-tile {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-left: 5px solid var(--gray-300);
            transition: all 0.2s;
        }
        
        .review-tile:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }
        
        .review-tile.green { border-left-color: var(--success); }
        .review-tile.yellow { border-left-color: var(--warning); }
        .review-tile.red { border-left-color: var(--danger); }
        
        .tile-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .tile-status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        .tile-status-dot.green { background: var(--success); }
        .tile-status-dot.yellow { background: var(--warning); }
        .tile-status-dot.red { background: var(--danger); }
        
        .tile-name {
            font-weight: 700;
            font-size: 1.05em;
            color: var(--gray-800);
        }
        
        .tile-metrics {
            display: flex;
            gap: 15px;
            margin-bottom: 12px;
        }
        
        .tile-metric {
            text-align: center;
            flex: 1;
        }
        
        .tile-metric .metric-value {
            display: block;
            font-size: 1.3em;
            font-weight: 700;
            color: var(--primary);
        }
        
        .tile-metric .metric-value.warning {
            color: var(--danger);
        }
        
        .tile-metric .metric-label {
            font-size: 0.7em;
            color: var(--gray-500);
            text-transform: uppercase;
        }
        
        .tile-phase {
            font-size: 0.8em;
            color: var(--gray-600);
            margin-bottom: 12px;
            padding: 6px 10px;
            background: linear-gradient(135deg, #EDE9FE, #DDD6FE);
            border-radius: 6px;
            font-weight: 600;
        }
        
        .tile-objectives {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 12px;
            padding: 8px;
            background: #F9FAFB;
            border-radius: 8px;
            border: 1px solid #E5E7EB;
        }
        
        .tile-obj {
            font-size: 0.75em;
            padding: 4px 8px;
            border-radius: 4px;
            color: var(--gray-700);
        }
        
        .tile-obj.complete { background: #D1FAE5; color: #065F46; }
        .tile-obj.on-track { background: #DBEAFE; color: #1E40AF; }
        .tile-obj.in-progress { background: #FEF3C7; color: #92400E; }
        .tile-obj.at-risk, .tile-obj.behind { background: #FEE2E2; color: #991B1B; }
        
        .tile-narrative {
            font-size: 0.85em;
            font-style: italic;
            color: var(--gray-500);
            padding: 10px 12px;
            background: var(--gray-50);
            border-radius: 8px;
            margin-bottom: 12px;
            line-height: 1.4;
        }
        
        .tile-details-btn {
            width: 100%;
            padding: 10px;
            background: var(--primary-lighter);
            border: 2px solid var(--primary-light);
            border-radius: 8px;
            color: var(--primary);
            font-weight: 600;
            font-size: 0.9em;
            cursor: pointer;
            margin-bottom: 12px;
            transition: all 0.2s;
        }
        
        .tile-details-btn:hover {
            background: var(--primary);
            color: white;
        }
        
        .tile-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .tile-action {
            flex: 1;
            padding: 12px 8px;
            border: 2px solid var(--gray-200);
            border-radius: 10px;
            background: white;
            font-size: 1.3em;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .tile-action:hover {
            transform: scale(1.1);
        }
        
        .tile-action.continue:hover, .tile-action.continue.selected {
            background: var(--success);
            border-color: var(--success);
        }
        
        .tile-action.accelerate:hover, .tile-action.accelerate.selected {
            background: var(--info);
            border-color: var(--info);
        }
        
        .tile-action.reduce:hover, .tile-action.reduce.selected {
            background: var(--warning);
            border-color: var(--warning);
        }
        
        .tile-action.kill:hover, .tile-action.kill.selected {
            background: var(--danger);
            border-color: var(--danger);
        }
        
        .tile-decision-label {
            text-align: center;
        }
        
        .decision-tag {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
        }
        
        .decision-tag.continue { background: var(--success-light); color: var(--success); }
        .decision-tag.accelerate { background: var(--info-light); color: var(--info); }
        .decision-tag.reduce { background: var(--warning-light); color: var(--warning); }
        .decision-tag.kill { background: var(--danger-light); color: var(--danger); }
        
        /* Review Modal */
        .review-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }
        
        .review-modal {
            background: white;
            border-radius: 20px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .review-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 36px;
            height: 36px;
            border: none;
            background: rgba(255,255,255,0.9);
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
            z-index: 10;
            color: var(--gray-600);
        }
        
        .review-modal-close:hover {
            background: var(--gray-100);
        }
        
        .review-modal-header {
            padding: 25px 30px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border-radius: 20px 20px 0 0;
        }
        
        .review-modal-header.green {
            background: linear-gradient(135deg, #166534 0%, #22c55e 100%);
        }
        
        .review-modal-header.yellow {
            background: linear-gradient(135deg, #92400e 0%, #f59e0b 100%);
        }
        
        .review-modal-header.red {
            background: linear-gradient(135deg, #991b1b 0%, #ef4444 100%);
        }
        
        .review-modal-header h2 {
            margin: 0 0 5px;
            color: white;
        }
        
        .review-modal-header p {
            margin: 0 0 10px;
            opacity: 0.9;
        }
        
        .review-modal-header .status-badge {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        
        .review-modal-body {
            padding: 25px 30px;
        }
        
        .review-modal-section {
            margin-bottom: 25px;
        }
        
        .review-modal-section h3 {
            font-size: 1em;
            color: var(--gray-700);
            margin: 0 0 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--gray-100);
        }
        
        .modal-metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }
        
        .modal-metric {
            text-align: center;
            padding: 15px;
            background: var(--gray-50);
            border-radius: 12px;
        }
        
        .modal-metric .value {
            font-size: 1.4em;
            font-weight: 700;
            color: var(--primary);
        }
        
        .modal-metric.warning .value {
            color: var(--danger);
        }
        
        .modal-metric .label {
            font-size: 0.75em;
            color: var(--gray-500);
            margin-top: 4px;
        }
        
        .modal-facts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .modal-facts-grid div {
            padding: 10px 12px;
            background: var(--gray-50);
            border-radius: 8px;
            font-size: 0.9em;
        }
        
        .modal-intel-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .review-modal-section.recommendation {
            background: linear-gradient(135deg, var(--primary-lighter) 0%, #fef3c720 100%);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--primary-light);
            margin-bottom: 0;
        }
        
        .review-modal-section.recommendation h3 {
            color: var(--primary);
            border-bottom: none;
            padding-bottom: 0;
            margin-bottom: 10px;
        }
        
        .review-modal-section.recommendation p {
            margin: 0;
            color: var(--gray-700);
            line-height: 1.6;
        }
        
        .review-modal-footer {
            padding: 20px 30px 25px;
            background: var(--gray-50);
            border-radius: 0 0 20px 20px;
            border-top: 1px solid var(--gray-200);
        }
        
        .review-modal-footer h4 {
            margin: 0 0 15px;
            color: var(--gray-700);
            font-size: 1em;
        }
        
        .modal-actions {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        
        @media (max-width: 600px) {
            .review-tiles-grid { grid-template-columns: 1fr; }
            .modal-metrics-grid { grid-template-columns: repeat(2, 1fr); }
            .modal-facts-grid { grid-template-columns: 1fr; }
            .modal-intel-grid { grid-template-columns: 1fr; }
            .modal-actions { grid-template-columns: repeat(2, 1fr); }
        }
        
        .event-card { background: linear-gradient(135deg, var(--gold-light) 0%, var(--white) 100%); border: 2px solid var(--gold); border-radius: 15px; padding: 25px; margin-bottom: 20px; }
        .event-card h4 { color: var(--gold-dark); margin-bottom: 15px; font-size: 1.1em; }
        .outcome-success { color: var(--success); font-weight: 600; }
        .outcome-failure { color: var(--danger); font-weight: 600; }
        
        /* Results */
        .results-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin: 25px 0; }
        .result-quadrant { padding: 25px; border-radius: 15px; text-align: center; }
        .result-quadrant.tp { background: linear-gradient(135deg, var(--success-light) 0%, #fff 100%); border: 2px solid #6ee7b7; }
        .result-quadrant.fp { background: linear-gradient(135deg, var(--danger-light) 0%, #fff 100%); border: 2px solid #fca5a5; }
        .result-quadrant.fn { background: linear-gradient(135deg, var(--warning-light) 0%, #fff 100%); border: 2px solid #fcd34d; }
        .result-quadrant.tn { background: linear-gradient(135deg, var(--info-light) 0%, #fff 100%); border: 2px solid #93c5fd; }
        .quadrant-count { font-size: 3em; font-weight: 700; margin-bottom: 5px; }
        .tp .quadrant-count { color: var(--success); }
        .fp .quadrant-count { color: var(--danger); }
        .fn .quadrant-count { color: var(--warning); }
        .tn .quadrant-count { color: var(--info); }
        .quadrant-label { font-weight: 700; margin-bottom: 5px; color: var(--gray-700); }
        .quadrant-desc { font-size: 0.85em; color: var(--gray-500); }
        
        .intro-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin: 25px 0; }
        .stat-box { background: linear-gradient(135deg, var(--primary-lighter) 0%, var(--white) 100%); padding: 20px; border-radius: 15px; text-align: center; border: 1px solid var(--primary-pale); }
        .stat-box .value { font-size: 1.6em; font-weight: 700; color: var(--primary); }
        .stat-box .label { font-size: 0.85em; color: var(--gray-500); margin-top: 5px; }
        
        .insight-box { background: var(--white); border-radius: 15px; padding: 25px; margin: 25px 0; border: 1px solid var(--gray-200); }
        .insight-box h3 { color: var(--primary); margin-bottom: 20px; }
        .insight-item { padding: 15px; margin: 12px 0; background: var(--gray-50); border-radius: 10px; border-left: 4px solid var(--primary); color: var(--gray-700); }
        
        .killed-reveal { margin-top: 25px; padding: 25px; background: var(--warning-light); border-radius: 15px; border: 2px solid var(--warning); }
        .killed-reveal h4 { color: var(--warning); margin-bottom: 15px; }
        
        @media (max-width: 600px) { .results-grid { grid-template-columns: 1fr; } .project-grid { grid-template-columns: 1fr; } }
        
        /* ========== MOBILE OPTIMIZATIONS ========== */
        @media (max-width: 600px) {
            /* Larger touch targets for buttons */
            .btn { padding: 16px 24px; min-height: 48px; }
            .btn-sm { padding: 12px 18px; min-height: 44px; }
            
            /* Matrix improvements for mobile */
            .matrix-container { 
                max-height: 350px; 
                touch-action: manipulation;
            }
            .project-bubble {
                min-width: 44px !important;
                min-height: 44px !important;
            }
            .quadrant-label { font-size: 0.65em; padding: 4px; }
            .axis-label { font-size: 0.7em; }
            
            /* Scoring buttons - larger touch targets */
            .scale-btn {
                min-height: 56px;
                padding: 14px 10px;
            }
            
            /* Modal improvements */
            .modal-content { 
                max-height: 90vh; 
                margin: 10px;
                border-radius: 16px;
            }
            .modal-close {
                width: 44px;
                height: 44px;
                font-size: 1.5em;
            }
            
            /* Cockpit cards - stack better */
            .cockpit-card {
                padding: 15px;
            }
            .cockpit-project-name { font-size: 0.95em; }
            
            /* Phase indicator - wrap on mobile */
            .phase-indicator {
                padding: 10px 15px;
                gap: 6px;
            }
            .phase-step { 
                padding: 6px 10px; 
                font-size: 0.8em;
            }
            
            /* Event/Dilemma modals */
            .event-modal, .dilemma-modal {
                padding: 20px;
                margin: 15px;
            }
            
            /* Choice buttons in dilemmas */
            .dilemma-choice {
                padding: 16px;
                min-height: 60px;
            }
            
            /* Portfolio sidebar - full width on mobile */
            .portfolio-sidebar {
                padding: 10px;
            }
            .portfolio-budget-card, .portfolio-buckets-card {
                padding: 12px;
            }
            
            /* Project cards in grid */
            .project-card {
                padding: 15px;
            }
            
            /* Navigation buttons - larger */
            .nav-btn, [class*="nav-"] button {
                min-width: 44px;
                min-height: 44px;
            }
            
            /* Side panel full width on mobile */
            .cockpit-detail-panel {
                width: 100%;
                max-width: 100%;
            }
            
            /* Triage action buttons */
            .triage-action {
                padding: 14px 20px;
                min-height: 48px;
            }
            
            /* Font size adjustments for readability */
            .container { padding: 12px; }
            body { font-size: 15px; }
            
            /* Budget bar touch-friendly */
            .budget-bar, .triage-budget-bar {
                height: 14px;
            }
            
            /* Tab buttons */
            .matrix-tab {
                padding: 10px 16px;
                min-height: 44px;
            }
            
            /* Prevent horizontal scroll */
            .container, .screen {
                overflow-x: hidden;
            }
        }
        
        /* Very small screens */
        @media (max-width: 380px) {
            .scale-btn .scale-text { display: none; }
            .scale-btn .scale-icon { font-size: 1.8em; }
            .scale-btn { min-width: 50px; }
            
            .btn { padding: 14px 16px; font-size: 0.9em; }
            .landing-title { font-size: 1.6em; }
            
            .matrix-container { max-height: 280px; }
        }
        
        /* Touch device optimizations */
        @media (hover: none) and (pointer: coarse) {
            /* Remove hover effects that don't work well on touch */
            .project-bubble:hover { transform: none; }
            .btn:hover { transform: none; }
            
            /* Add active states instead */
            .project-bubble:active { transform: scale(1.1); }
            .btn:active { transform: scale(0.98); opacity: 0.9; }
            .scale-btn:active { transform: scale(1.02); }
            
            /* Ensure tooltips work on tap */
            .bubble-tooltip {
                pointer-events: auto;
            }
        }
        
        /* ========== COMMITTEE CHAOS MINI-GAME (EMBEDDED) ========== */
        .cc-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            z-index: 10000;
            background: #F0EBE3;
        }
        .cc-overlay.active { display: block; }
        .cc-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        /* ========================================
           PROJECT COCKPIT STYLES
           ======================================== */
        
        /* Cockpit Header */
        .cockpit-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 24px 30px;
            border-radius: 14px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
            color: white;
            box-shadow: 0 4px 12px rgba(0,61,165,0.2);
        }
        
        .cockpit-title-section {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .cockpit-title-section h2 {
            font-size: 1.4em;
            font-weight: 700;
            margin: 0;
        }
        
        .cockpit-quarter-badge {
            background: var(--gold);
            color: var(--primary);
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: 700;
        }
        
        .cockpit-stats {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .cockpit-stat {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: rgba(255,255,255,0.15);
            border-radius: 8px;
            font-size: 0.95em;
        }
        
        .cockpit-stat .value {
            font-weight: 700;
            font-size: 1.1em;
            color: var(--gold);
        }
        
        .cockpit-stat .label {
            color: rgba(255,255,255,0.9);
            font-size: 0.9em;
        }
        
        .cockpit-stat.alert {
            background: var(--danger);
        }
        
        .cockpit-stat.alert .value {
            color: white;
        }
        
        .rag-summary {
            display: flex;
            gap: 4px;
        }
        
        .rag-pill {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: 600;
        }
        
        .rag-pill.green { background: var(--success); }
        .rag-pill.amber { background: var(--warning); }
        .rag-pill.red { background: var(--danger); }
        
        /* Cockpit Grid */
        .cockpit-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .cockpit-section-header h3 {
            font-size: 1em;
            color: var(--primary);
        }
        
        .cockpit-legend {
            display: flex;
            gap: 15px;
            font-size: 0.8em;
            color: var(--gray-600);
        }
        
        .cockpit-legend span {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }
        
        .legend-dot.green { background: var(--success); }
        .legend-dot.amber { background: var(--warning); }
        .legend-dot.red { background: var(--danger); }
        
        .cockpit-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        /* Cockpit Project Tiles */
        .cockpit-tile {
            border-radius: 12px;
            padding: 18px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .cockpit-tile:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }
        
        .cockpit-tile.selected {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-lighter);
        }
        
        .cockpit-tile.green {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border-color: #a7f3d0;
        }
        .cockpit-tile.green:hover { border-color: var(--success); }
        
        .cockpit-tile.amber {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border-color: #fde68a;
        }
        .cockpit-tile.amber:hover { border-color: var(--warning); }
        
        .cockpit-tile.red {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border-color: #fecaca;
        }
        .cockpit-tile.red:hover { border-color: var(--danger); }
        
        .cockpit-tile-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .cockpit-tile-name {
            font-weight: 600;
            font-size: 1em;
            color: var(--gray-800);
        }
        
        .cockpit-tile-quarter {
            font-size: 0.75em;
            padding: 3px 8px;
            background: rgba(0,0,0,0.08);
            border-radius: 4px;
            color: var(--gray-600);
        }
        
        .cockpit-tile-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .cockpit-metric {
            text-align: center;
            padding: 8px;
            background: rgba(255,255,255,0.6);
            border-radius: 6px;
        }
        
        .cockpit-metric .value {
            font-size: 1.1em;
            font-weight: 700;
            color: var(--gray-800);
        }
        
        .cockpit-metric .label {
            font-size: 0.65em;
            color: var(--gray-500);
            text-transform: uppercase;
        }
        
        .cockpit-tile-progress {
            height: 6px;
            background: rgba(0,0,0,0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .cockpit-tile-progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s;
        }
        
        .cockpit-tile.green .cockpit-tile-progress-fill { background: var(--success); }
        .cockpit-tile.amber .cockpit-tile-progress-fill { background: var(--warning); }
        .cockpit-tile.red .cockpit-tile-progress-fill { background: var(--danger); }
        
        .cockpit-tile-status {
            font-size: 0.8em;
            color: var(--gray-600);
        }
        
        .cockpit-tile-btn {
            margin-top: 10px;
            padding: 6px 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.8em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }
        
        .cockpit-tile-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .cockpit-tile.amber .cockpit-tile-btn {
            background: var(--warning);
        }
        
        .cockpit-tile.amber .cockpit-tile-btn:hover {
            background: #b45309;
        }
        
        .cockpit-tile.red .cockpit-tile-btn {
            background: var(--danger);
        }
        
        .cockpit-tile.red .cockpit-tile-btn:hover {
            background: #b91c1c;
        }
        
        /* Cockpit Detail Panel */
        .cockpit-panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        
        .cockpit-panel-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .cockpit-detail-panel {
            position: fixed;
            top: 0;
            right: -500px;
            width: 480px;
            max-width: 95%;
            height: 100vh;
            background: var(--white);
            box-shadow: -10px 0 40px rgba(0,0,0,0.15);
            z-index: 1001;
            display: flex;
            flex-direction: column;
            transition: right 0.3s ease;
        }
        
        .cockpit-detail-panel.active {
            right: 0;
        }
        
        .panel-header {
            padding: 20px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .panel-header-content h3 {
            font-size: 1.2em;
            color: var(--primary);
            margin-bottom: 4px;
        }
        
        .panel-header-content .tagline {
            font-size: 0.85em;
            color: var(--gray-500);
            font-style: italic;
        }
        
        .panel-rag-badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.75em;
            font-weight: 600;
        }
        
        .panel-rag-badge.green { background: var(--success); color: white; }
        .panel-rag-badge.amber { background: var(--warning); color: white; }
        .panel-rag-badge.red { background: var(--danger); color: white; }
        
        .panel-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 32px;
            height: 32px;
            border: none;
            background: var(--gray-100);
            border-radius: 50%;
            font-size: 1.2em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-500);
        }
        
        .panel-close:hover {
            background: var(--gray-200);
            color: var(--gray-700);
        }
        
        .panel-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .panel-section {
            margin-bottom: 20px;
        }
        
        .panel-section h4 {
            font-size: 0.85em;
            color: var(--primary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        /* Project Link */
        .project-link-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px;
            background: var(--primary-lighter);
            border: 1px dashed var(--primary-light);
            border-radius: 8px;
            color: var(--primary);
            font-size: 0.8em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 15px;
            width: 100%;
        }
        
        .project-link-btn:hover {
            background: var(--primary-pale);
            border-style: solid;
        }
        
        /* Metrics Grid */
        .panel-metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        
        .panel-metric-box {
            text-align: center;
            padding: 12px 8px;
            background: var(--gray-50);
            border-radius: 8px;
        }
        
        .panel-metric-box .value {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--primary);
        }
        
        .panel-metric-box .label {
            font-size: 0.7em;
            color: var(--gray-500);
        }
        
        .panel-metric-box.warning .value { color: var(--warning); }
        .panel-metric-box.danger .value { color: var(--danger); }
        
        /* Snapshot Grid */
        .snapshot-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .snapshot-item {
            background: var(--gray-50);
            padding: 10px;
            border-radius: 8px;
        }
        
        .snapshot-item .label {
            font-size: 0.7em;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 4px;
        }
        
        .snapshot-item .value {
            font-size: 0.85em;
            color: var(--gray-800);
            font-weight: 500;
        }
        
        /* Milestone Track */
        .milestone-track {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        
        .milestone-step {
            flex: 1;
            text-align: center;
        }
        
        .milestone-step-bar {
            height: 8px;
            background: var(--gray-200);
            margin: 0 2px 8px;
            border-radius: 4px;
        }
        
        .milestone-step-bar.complete { background: var(--success); }
        .milestone-step-bar.current { background: var(--primary); animation: pulse 2s infinite; }
        .milestone-step-bar.pending { background: var(--gray-200); }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        .milestone-step-label {
            font-size: 0.7em;
            color: var(--gray-500);
        }
        
        .milestone-narrative {
            font-size: 0.85em;
            color: var(--gray-600);
            line-height: 1.5;
            padding: 12px;
            background: var(--gray-50);
            border-radius: 8px;
        }
        
        /* Intel Grid */
        .intel-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .intel-card {
            padding: 12px;
            border-radius: 8px;
            background: var(--gray-50);
        }
        
        .intel-card h5 {
            font-size: 0.75em;
            color: var(--gray-700);
            margin-bottom: 6px;
        }
        
        .intel-card p {
            font-size: 0.8em;
            color: var(--gray-600);
            line-height: 1.4;
        }
        
        /* Team Summary */
        .team-summary {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .team-lead {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .lead-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.85em;
        }
        
        .lead-info .name {
            font-weight: 600;
            font-size: 0.9em;
        }
        
        .lead-info .role {
            font-size: 0.75em;
            color: var(--gray-500);
        }
        
        .team-size {
            margin-left: auto;
            text-align: center;
        }
        
        .team-size .count {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--primary);
        }
        
        .team-size .label {
            font-size: 0.7em;
            color: var(--gray-500);
        }
        
        /* Advice Section */
        .advice-section {
            background: var(--primary-lighter);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .advice-section h4 {
            color: var(--primary);
            font-size: 0.85em;
            margin-bottom: 12px;
        }
        
        .advice-cards {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .advice-card {
            background: var(--white);
            border-radius: 8px;
            padding: 12px;
            border-left: 3px solid var(--primary);
        }
        
        .advice-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        
        .advisor-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.75em;
            color: white;
        }
        
        .advisor-info .name {
            font-weight: 600;
            font-size: 0.85em;
            color: var(--gray-800);
        }
        
        .advisor-info .role {
            font-size: 0.7em;
            color: var(--gray-500);
        }
        
        .advice-stance {
            font-size: 0.7em;
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: 600;
            margin-left: auto;
        }
        
        .advice-stance.supportive { background: var(--success-light); color: var(--success); }
        .advice-stance.cautious { background: var(--warning-light); color: var(--warning); }
        .advice-stance.concerned { background: var(--danger-light); color: var(--danger); }
        .advice-stance.neutral { background: var(--gray-100); color: var(--gray-600); }
        
        .advice-quote {
            font-size: 0.85em;
            color: var(--gray-600);
            font-style: italic;
            line-height: 1.5;
        }
        
        /* Cockpit Actions Section */
        .cockpit-actions-section {
            background: var(--white);
            padding: 15px 20px;
            border-top: 1px solid var(--gray-200);
            position: sticky;
            bottom: 0;
        }
        
        .cockpit-actions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .cockpit-actions-header h4 {
            color: var(--primary);
            font-size: 0.85em;
            margin: 0;
            font-weight: 600;
        }
        
        .cockpit-actions-hint {
            font-size: 0.7em;
            color: var(--gray-500);
        }
        
        .cockpit-action-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .cockpit-action-btn {
            padding: 14px 10px;
            border-radius: 8px;
            border: 2px solid var(--gray-200);
            background: var(--white);
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            text-align: center;
        }
        
        .cockpit-action-btn:hover {
            border-color: var(--gray-400);
            background: var(--gray-50);
        }
        
        .cockpit-action-btn.selected {
            border-color: var(--primary);
            background: var(--primary-lighter);
        }
        
        .cockpit-action-btn .action-icon {
            font-size: 1.3em;
        }
        
        .cockpit-action-btn .action-label {
            font-weight: 600;
            font-size: 0.8em;
            color: var(--gray-700);
            line-height: 1.3;
        }
        
        .cockpit-action-btn.selected .action-label {
            color: var(--primary);
        }
        
        /* Action button colors on hover/select */
        .cockpit-action-btn.continue:hover,
        .cockpit-action-btn.continue.selected { border-color: var(--success); }
        .cockpit-action-btn.continue.selected { background: var(--success-light); }
        .cockpit-action-btn.continue.selected .action-label { color: var(--success); }
        
        .cockpit-action-btn.accelerate:hover,
        .cockpit-action-btn.accelerate.selected { border-color: var(--info); }
        .cockpit-action-btn.accelerate.selected { background: var(--info-light); }
        .cockpit-action-btn.accelerate.selected .action-label { color: var(--info); }
        
        .cockpit-action-btn.reduce:hover,
        .cockpit-action-btn.reduce.selected { border-color: var(--warning); }
        .cockpit-action-btn.reduce.selected { background: var(--warning-light); }
        .cockpit-action-btn.reduce.selected .action-label { color: var(--warning); }
        
        .cockpit-action-btn.champion:hover,
        .cockpit-action-btn.champion.selected { border-color: #db2777; }
        .cockpit-action-btn.champion.selected { background: #fce7f3; }
        .cockpit-action-btn.champion.selected .action-label { color: #db2777; }
        
        .cockpit-action-btn.kill:hover,
        .cockpit-action-btn.kill.selected { border-color: var(--danger); }
        .cockpit-action-btn.kill.selected { background: var(--danger-light); }
        .cockpit-action-btn.kill.selected .action-label { color: var(--danger); }
        
        /* Action implications */
        .cockpit-implications {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            padding: 10px 14px;
            margin-bottom: 12px;
            min-height: 44px;
            display: flex;
            align-items: center;
        }
        
        .implications-placeholder {
            color: var(--gray-400);
            font-size: 0.8em;
            font-style: italic;
        }
        
        .implications-content {
            display: none;
            gap: 20px;
            width: 100%;
        }
        
        .implications-content.visible {
            display: flex;
        }
        
        .implication-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8em;
            font-weight: 500;
        }
        
        .implication-item.positive { color: var(--success); }
        .implication-item.negative { color: var(--danger); }
        .implication-item.neutral { color: var(--gray-600); }
        
        .cockpit-confirm-btn {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .cockpit-confirm-btn:hover {
            background: var(--primary-light);
        }
        
        .cockpit-confirm-btn:disabled {
            background: var(--gray-300);
            cursor: not-allowed;
        }
        
        /* Template Modal */
        .template-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(60, 16, 83, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }
        
        .template-modal {
            background: var(--white);
            border-radius: 12px;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }
        
        .template-header {
            background: var(--primary);
            color: white;
            padding: 20px 25px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .template-header h3 {
            font-size: 1.2em;
            margin: 0 0 5px;
        }
        
        .template-header .tagline {
            font-size: 0.85em;
            opacity: 0.85;
            font-style: italic;
            margin: 0;
        }
        
        .template-budget-badge {
            background: var(--gold);
            color: var(--gray-800);
            padding: 8px 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .template-budget-badge .amount {
            font-size: 1.2em;
            font-weight: 700;
        }
        
        .template-budget-badge .label {
            font-size: 0.7em;
        }
        
        .template-body {
            padding: 20px 25px;
        }
        
        .template-section {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--gray-200);
        }
        
        .template-section:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .template-section h4 {
            font-size: 0.9em;
            color: var(--primary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .template-section p {
            font-size: 0.9em;
            color: var(--gray-700);
            line-height: 1.6;
            margin: 0;
        }
        
        .template-close {
            display: block;
            width: 100%;
            padding: 14px;
            background: var(--gray-100);
            border: none;
            border-radius: 0 0 12px 12px;
            font-weight: 600;
            color: var(--gray-600);
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .template-close:hover {
            background: var(--gray-200);
        }
        
        /* Cockpit view toggle button */
        .cockpit-toggle-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .cockpit-toggle-btn:hover {
            background: var(--primary-light);
        }
        
        /* Back button in cockpit */
        .cockpit-back-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: var(--white);
            color: var(--primary);
            border: 2px solid var(--primary);
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .cockpit-back-btn:hover {
            background: var(--primary);
            color: white;
        }
        
        /* Corporate Event Modal Styles */
        .event-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
            animation: eventFadeIn 0.3s ease-out;
        }
        
        @keyframes eventFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes eventSlideIn {
            from { transform: translateY(-30px) scale(0.95); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }
        
        .event-modal {
            background: white;
            border-radius: 24px;
            max-width: 550px;
            width: 100%;
            position: relative;
            box-shadow: 0 25px 80px rgba(0,0,0,0.4);
            animation: eventSlideIn 0.4s ease-out;
            overflow: hidden;
        }
        
        .event-modal-header {
            padding: 30px 30px 25px;
            text-align: center;
            position: relative;
        }
        
        .event-modal-header.positive {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
        }
        
        .event-modal-header.negative {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
        }
        
        .event-modal-header.neutral {
            background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%);
        }
        
        .event-icon {
            font-size: 3.5em;
            margin-bottom: 15px;
            display: block;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
        }
        
        .event-category {
            display: inline-block;
            background: rgba(255,255,255,0.25);
            color: white;
            padding: 5px 14px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }
        
        .event-title {
            color: white;
            font-size: 1.6em;
            font-weight: 700;
            margin: 0;
            line-height: 1.2;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .event-modal-body {
            padding: 25px 30px 30px;
        }
        
        .event-description {
            font-size: 1.05em;
            color: var(--gray-700);
            line-height: 1.7;
            margin-bottom: 25px;
            text-align: center;
        }
        
        .event-effect-box {
            background: var(--gray-50);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .event-effect-label {
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--gray-500);
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .event-effect-text {
            font-size: 1.1em;
            font-weight: 600;
            line-height: 1.5;
        }
        
        .event-effect-text.positive {
            color: var(--success);
        }
        
        .event-effect-text.negative {
            color: var(--danger);
        }
        
        .event-effect-text.neutral {
            color: var(--warning);
        }
        
        .event-duration {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: var(--gray-500);
            font-size: 0.9em;
            margin-bottom: 20px;
        }
        
        .event-duration-icon {
            font-size: 1.1em;
        }
        
        .event-acknowledge-btn {
            width: 100%;
            padding: 16px 24px;
            font-size: 1.1em;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .event-acknowledge-btn.positive {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            color: white;
        }
        
        .event-acknowledge-btn.negative {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            color: white;
        }
        
        .event-acknowledge-btn.neutral {
            background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%);
            color: white;
        }
        
        .event-acknowledge-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }
        
        /* Event notification badge in quarter header */
        .event-active-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: var(--warning-light);
            color: var(--warning);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .event-active-badge.positive {
            background: var(--success-light);
            color: var(--success);
        }
        
        .event-active-badge.negative {
            background: var(--danger-light);
            color: var(--danger);
        }
        
        /* Project Lead Card Styles */
        .project-lead-card {
            background: var(--gray-50);
            border-radius: 12px;
            padding: 16px;
            margin-top: 15px;
        }
        
        .lead-header {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        
        .lead-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1em;
            flex-shrink: 0;
        }
        
        .lead-info {
            flex: 1;
            min-width: 0;
        }
        
        .lead-name {
            font-weight: 700;
            color: var(--gray-800);
            font-size: 1.05em;
        }
        
        .lead-role {
            color: var(--gray-600);
            font-size: 0.85em;
        }
        
        .lead-tenure {
            color: var(--gray-500);
            font-size: 0.8em;
            margin-top: 2px;
        }
        
        .lead-track-record {
            text-align: center;
            padding: 8px 12px;
            border-radius: 8px;
            flex-shrink: 0;
        }
        
        .lead-track-record.success {
            background: var(--success-light);
            color: var(--success);
        }
        
        .lead-track-record.warning {
            background: var(--warning-light);
            color: var(--warning);
        }
        
        .lead-track-record.danger {
            background: var(--danger-light);
            color: var(--danger);
        }
        
        .track-score {
            font-size: 1.3em;
            font-weight: 700;
        }
        
        .track-label {
            font-size: 0.7em;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .lead-section-title {
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--gray-500);
            margin: 16px 0 8px;
            font-weight: 600;
        }
        
        .lead-background p {
            color: var(--gray-700);
            font-size: 0.9em;
            line-height: 1.5;
            margin: 0;
        }
        
        .cv-timeline {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .cv-item {
            display: grid;
            grid-template-columns: 90px 1fr auto;
            gap: 10px;
            font-size: 0.85em;
            padding: 6px 0;
            border-bottom: 1px solid var(--gray-200);
        }
        
        .cv-item:last-child {
            border-bottom: none;
        }
        
        .cv-year {
            color: var(--gray-500);
            font-size: 0.85em;
        }
        
        .cv-role {
            color: var(--gray-800);
            font-weight: 500;
        }
        
        .cv-detail {
            color: var(--gray-500);
            text-align: right;
        }
        
        .past-projects-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .past-project {
            display: grid;
            grid-template-columns: 24px 1fr auto auto;
            gap: 8px;
            align-items: center;
            padding: 8px 10px;
            background: white;
            border-radius: 8px;
            font-size: 0.85em;
        }
        
        .past-project.success {
            border-left: 3px solid var(--success);
        }
        
        .past-project.failure {
            border-left: 3px solid var(--danger);
        }
        
        .past-project.partial {
            border-left: 3px solid var(--warning);
        }
        
        .past-project-icon {
            font-size: 1.1em;
        }
        
        .past-project.success .past-project-icon { color: var(--success); }
        .past-project.failure .past-project-icon { color: var(--danger); }
        .past-project.partial .past-project-icon { color: var(--warning); }
        
        .past-project-name {
            font-weight: 500;
            color: var(--gray-800);
        }
        
        .past-project-year {
            color: var(--gray-400);
            font-size: 0.9em;
        }
        
        .past-project-note {
            color: var(--gray-500);
            font-size: 0.85em;
            text-align: right;
        }
        
        .lead-style {
            color: var(--gray-700);
            font-size: 0.9em;
            font-style: italic;
            margin: 0 0 12px;
            line-height: 1.5;
        }
        
        .lead-traits {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .traits-column {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .traits-label {
            font-size: 0.75em;
            text-transform: uppercase;
            color: var(--gray-500);
            margin-bottom: 4px;
        }
        
        .traits-column.strengths .trait {
            color: var(--success);
        }
        
        .traits-column.weaknesses .trait {
            color: var(--warning);
        }
        
        .trait {
            font-size: 0.85em;
        }
        
        .lead-disclaimer {
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid var(--gray-200);
            font-size: 0.75em;
            color: var(--gray-400);
        }
        
        /* Lead toggle button */
        .lead-toggle-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--primary-lighter);
            color: var(--primary);
            border: none;
            border-radius: 6px;
            font-size: 0.85em;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.2s;
        }
        
        .lead-toggle-btn:hover {
            background: var(--primary-pale);
        }
        
        /* Lead CV Modal Styles */
        .lead-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2500;
            padding: 20px;
            animation: eventFadeIn 0.3s ease-out;
        }
        
        .lead-modal {
            background: white;
            border-radius: 20px;
            max-width: 600px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 25px 80px rgba(0,0,0,0.4);
            animation: eventSlideIn 0.4s ease-out;
        }
        
        .lead-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 36px;
            height: 36px;
            border: none;
            background: rgba(255,255,255,0.9);
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
            z-index: 10;
            color: var(--gray-600);
        }
        
        .lead-modal-close:hover {
            background: var(--gray-100);
        }
        
        .lead-modal-header {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 25px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 20px 20px 0 0;
        }
        
        .lead-modal-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.5em;
            color: white;
            flex-shrink: 0;
        }
        
        .lead-modal-title {
            flex: 1;
        }
        
        .lead-modal-title h2 {
            color: white;
            margin: 0 0 5px;
            font-size: 1.4em;
        }
        
        .lead-modal-title p {
            color: rgba(255,255,255,0.8);
            margin: 0;
            font-size: 0.95em;
        }
        
        .lead-modal-score {
            text-align: center;
            padding: 10px 15px;
            background: rgba(255,255,255,0.15);
            border-radius: 12px;
        }
        
        .lead-modal-score .score-value {
            font-size: 1.8em;
            font-weight: 700;
            color: white;
        }
        
        .lead-modal-score .score-label {
            font-size: 0.7em;
            text-transform: uppercase;
            color: rgba(255,255,255,0.8);
            letter-spacing: 0.5px;
        }
        
        .lead-modal-body {
            padding: 25px;
        }
        
        .lead-modal-section {
            margin-bottom: 20px;
        }
        
        .lead-modal-section:last-child {
            margin-bottom: 0;
        }
        
        .lead-modal-section-title {
            font-size: 0.8em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--gray-500);
            margin-bottom: 10px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        /* Compact lead card for inline display */
        /* Lead Link - Minimal clickable row */
        .lead-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85em;
        }
        
        .lead-link:hover {
            background: var(--primary-lighter);
            border-color: var(--primary-light);
        }
        
        .lead-link-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.7em;
        }
        
        .lead-link-name {
            font-weight: 600;
            color: var(--gray-800);
        }
        
        .lead-link-badge {
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: 600;
        }
        
        .lead-link-badge.success {
            background: var(--success-light);
            color: var(--success);
        }
        
        .lead-link-badge.warning {
            background: var(--warning-light);
            color: var(--warning);
        }
        
        .lead-link-badge.danger {
            background: var(--danger-light);
            color: var(--danger);
        }
        
        .lead-link-cta {
            color: var(--primary);
            font-weight: 500;
        }
        
        .lead-link:hover .lead-link-cta {
            text-decoration: underline;
        }
        /* Sound Toggle Button */
        .sound-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            z-index: 9999;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .sound-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }
        
        .sound-toggle:active {
            transform: scale(0.95);
        }
        
        @media (max-width: 768px) {
            .sound-toggle {
                width: 44px;
                height: 44px;
                font-size: 1.3em;
                bottom: 15px;
                right: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Sound Toggle Button -->
    <button id="sound-toggle-btn" class="sound-toggle" onclick="SoundManager.toggle()" title="Mute sounds">🔊</button>
    
    <div class="container">
        
        <!-- PHASE: LANDING -->
        <div id="phase-landing" class="phase-content landing-page">
            <div class="landing-hero">
                <div class="landing-badge">INTERACTIVE BUSINESS SIMULATION</div>
                <h1 class="landing-title">Build, Bin, Boost</h1>
                <p style="font-size: 1.5em; color: var(--primary); margin-bottom: 20px; font-weight: 500;">The R&D Portfolio Simulation</p>
                <p class="landing-subtitle">
                    You've just been promoted to Head of R&D at a fast-growing Indian tech company. 
                    Your mission: build an innovation portfolio that will shape the company's future. 
                    But with limited budget and competing priorities, every decision matters.
                </p>
            </div>
            
            <div class="landing-features">
                <div class="feature-card">
                    <div class="feature-icon">🎭</div>
                    <h3>Step Into the Role</h3>
                    <p>Take charge of an R&D portfolio with ongoing projects and fresh opportunities. Shape the future with the hand you're dealt.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">⚖️</div>
                    <h3>Assess & Select</h3>
                    <p>Design your evaluation process. Choose your criteria. Assemble a committee. Review proposals and decide which projects deserve funding—and which don't.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">⚡</div>
                    <h3>Live with the Consequences</h3>
                    <p>Projects succeed, fail, or surprise you. Navigate corporate events, manage your team, and adapt your strategy.</p>
                </div>
            </div>
            
            <div class="landing-cta">
                <button class="btn btn-gold btn-large" onclick="showPhase('briefing')">Take the Assignment →</button>
                <button class="btn btn-secondary" onclick="showTutorialModal()" style="margin-left: 15px;">📖 How to Play</button>
            </div>
            
            <div class="landing-meta">
                <span>⏱️ 20-30 minutes</span>
                <span>📱 Works on any device</span>
            </div>
            
            <div class="landing-credits">
                <p>Created by Ammon Salter, Warwick Business School</p>
                <p style="font-size: 0.8em; color: var(--gray-400);">Developed with assistance from Claude (Anthropic) and GPT-5 (OpenAI)</p>
                <p class="license-text">
                    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">
                        <img src="https://licensebuttons.net/l/by-nc-sa/4.0/88x31.png" alt="CC BY-NC-SA 4.0" style="height: 20px; vertical-align: middle;">
                    </a>
                    Licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a>
                </p>
                <button class="credits-btn" onclick="openCreditsModal()">📄 Full Credits & License</button>
            </div>
        </div>
        
        <!-- PHASE: BRIEFING -->
        <div id="phase-briefing" class="phase-content hidden">
            <div style="text-align: center; margin-bottom: 30px;">
                <div class="company-logo">🛡️ ShieldTech India</div>
                <h1 style="margin-bottom: 10px;">You've Been Promoted</h1>
                <p style="color: var(--gray-600); font-size: 1.1em;">Head of R&D, effective immediately</p>
            </div>
            
            <!-- Company history box -->
            <div onclick="document.getElementById('history-modal').classList.remove('hidden')" 
                 style="background: var(--primary-lighter); border: 2px solid var(--primary); border-radius: 12px; padding: 15px 20px; margin-bottom: 25px; cursor: pointer; display: flex; align-items: center; gap: 15px; transition: all 0.2s;"
                 onmouseover="this.style.background='var(--primary)'; this.style.color='white';"
                 onmouseout="this.style.background='var(--primary-lighter)'; this.style.color='inherit';">
                <div style="font-size: 2em;">📖</div>
                <div>
                    <strong style="font-size: 1.05em;">ShieldTech's History</strong>
                    <p style="margin: 3px 0 0; opacity: 0.8; font-size: 0.95em;">From Bangalore startup to India's #3 security company</p>
                </div>
                <div style="margin-left: auto; font-size: 1.2em;">→</div>
            </div>
            
            <!-- Email from CEO -->
            <div style="background: white; border-radius: 16px; padding: 25px; margin-bottom: 25px; border: 2px solid var(--gray-200);">
                <div style="display: flex; gap: 15px; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--gray-200);">
                    <div style="width: 50px; height: 50px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">MV</div>
                    <div>
                        <strong>Meera Venkataraman</strong> <span style="color: var(--gray-500);">CEO</span>
                        <div style="font-size: 0.85em; color: var(--gray-500);">To: You</div>
                    </div>
                </div>
                
                <div style="line-height: 1.8; color: var(--gray-700);">
                    <p>You've heard the rumours—they're true. Vikram is out, and I want you to take over R&D.</p>
                    
                    <p style="margin-top: 15px;">The last three years haven't worked. We funded 15 projects and only 4 made it. Pet projects got protected, bad news got buried, and we kept failing projects alive for years instead of cutting losses.</p>
                    
                    <p style="margin-top: 15px;"><strong>I'm giving you $50M and full authority to redesign how we select projects.</strong></p>
                </div>
            </div>
            
            <!-- Strategic Priorities -->
            <div style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border-radius: 16px; padding: 25px; margin-bottom: 25px;">
                <h2 style="color: white; margin: 0 0 10px 0;">🎯 What the Board Expects</h2>
                <p style="opacity: 0.9; margin-bottom: 20px;">Your R&D portfolio needs to address these priorities:</p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px;">
                    <div style="background: rgba(255,255,255,0.15); padding: 18px; border-radius: 12px;">
                        <div style="font-size: 1.3em; margin-bottom: 8px;">🛡️ Defend Metro Leadership</div>
                        <p style="opacity: 0.9; font-size: 0.95em; margin: 0;">We're #3 in India but competitors are catching up. Protect our position in Mumbai, Delhi, Bangalore and other major cities.</p>
                    </div>
                    <div style="background: rgba(255,255,255,0.15); padding: 18px; border-radius: 12px;">
                        <div style="font-size: 1.3em; margin-bottom: 8px;">🗺️ Expand to Tier 2/3 Cities</div>
                        <p style="opacity: 0.9; font-size: 0.95em; margin: 0;">The next wave of growth is in smaller cities—Jaipur, Lucknow, Coimbatore. We need affordable products that work there.</p>
                    </div>
                    <div style="background: rgba(255,255,255,0.15); padding: 18px; border-radius: 12px;">
                        <div style="font-size: 1.3em; margin-bottom: 8px;">💳 Build Recurring Revenue</div>
                        <p style="opacity: 0.9; font-size: 0.95em; margin: 0;">Hardware sales are lumpy. The board wants subscription services—monitoring, cloud storage, premium features.</p>
                    </div>
                    <div style="background: rgba(255,255,255,0.15); padding: 18px; border-radius: 12px;">
                        <div style="font-size: 1.3em; margin-bottom: 8px;">🤖 Lead on AI & Smart Home</div>
                        <p style="opacity: 0.9; font-size: 0.95em; margin: 0;">We acquired CloudWatch for their AI talent. Now we need products that use it—before Google and Amazon eat our lunch.</p>
                    </div>
                </div>
            </div>
            
            <!-- What you have to work with -->
            <div style="background: var(--gray-50); border-radius: 16px; padding: 25px; margin-bottom: 25px;">
                <h2 style="color: var(--primary); margin: 0 0 15px 0;">💡 What You Have to Work With</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                    <div style="background: white; padding: 12px 15px; border-radius: 8px; border-left: 3px solid var(--success);">
                        <strong>Hardware expertise</strong> — sensors, cameras, fast prototyping
                    </div>
                    <div style="background: white; padding: 12px 15px; border-radius: 8px; border-left: 3px solid var(--primary);">
                        <strong>2M app users</strong> — built-in distribution
                    </div>
                    <div style="background: white; padding: 12px 15px; border-radius: 8px; border-left: 3px solid var(--gold);">
                        <strong>40 AI engineers</strong> — from CloudWatch acquisition
                    </div>
                    <div style="background: white; padding: 12px 15px; border-radius: 8px; border-left: 3px solid var(--danger);">
                        <strong>15,000 retailers</strong> — nationwide reach
                    </div>
                </div>
            </div>
            
            <!-- Challenge summary -->
            <div style="background: var(--warning-light); border-radius: 12px; padding: 20px; margin-bottom: 25px; border-left: 4px solid var(--warning);">
                <strong>Your challenge:</strong> Build and manage a portfolio that delivers results. You'll need to decide what mix of safe and ambitious projects to fund, how to tend the portfolio over time, and when to persist versus when to cut your losses. The board will judge not just your results, but how you achieved them.
            </div>
            
            <div class="button-row">
                <button class="btn btn-secondary" onclick="showPhase('landing')">← Back</button>
                <button class="btn btn-gold btn-large" onclick="startCommitteeSelection()">Design Your Selection Process →</button>
            </div>
            

        </div>
        
        <!-- PHASE: APPOINTMENT - Now just redirects to briefing -->
        <div id="phase-appointment" class="phase-content hidden">
        </div>
        
        <!-- COMPANY HISTORY MODAL -->
        <div class="modal-overlay hidden" id="history-modal" onclick="if(event.target === this) this.classList.add('hidden')">
            <div class="modal-content" style="max-width: 700px;">
                <button class="modal-close" onclick="document.getElementById('history-modal').classList.add('hidden')">×</button>
                <h2 style="color: var(--primary); margin-bottom: 20px;">📖 The ShieldTech Story</h2>
                
                <div style="line-height: 1.8; color: var(--gray-700);">
                    <p><strong>2015 — The Beginning</strong><br>
                    Meera Venkataraman and Arjun Khanna started ShieldTech in a cramped Bangalore apartment with $36,000 and a simple idea: every Indian family deserves to feel safe at home, not just the wealthy ones. Their first product was a motion sensor that cost a tenth of the competition.</p>
                    
                    <p style="margin-top: 15px;"><strong>2017 — Series A & Growth</strong><br>
                    Sequoia India invested $45M. The "SmartGuard" product line launched. ShieldTech expanded to 8 states and hired its 100th employee.</p>
                    
                    <p style="margin-top: 15px;"><strong>2018 — Near Death</strong><br>
                    A key supplier went bankrupt, nearly taking ShieldTech with it. Three months of 18-hour days saved the company. Meera still calls it "the crucible."</p>
                    
                    <p style="margin-top: 15px;"><strong>2019 — Breakthrough</strong><br>
                    Revenue crossed $200M. Won "Most Innovative Security Company" at the India Tech Awards. Opened the Hyderabad R&D centre.</p>
                    
                    <p style="margin-top: 15px;"><strong>2021 — IPO & Acquisition</strong><br>
                    Listed on BSE. Used the capital to acquire CloudWatch, an AI analytics startup with 40 ML engineers. Entered the commercial security market.</p>
                    
                    <p style="margin-top: 15px;"><strong>2023 — The Challenge</strong><br>
                    Revenue hit $850M but growth is slowing. Chinese competitors are undercutting on price. The CloudWatch integration brought culture clashes. The previous Head of R&D was let go after too many failed projects.</p>
                    
                    <p style="margin-top: 15px;"><strong>Today</strong><br>
                    2,400 employees. #3 in India's home security market. A $50M R&D budget. And a new Head of R&D—you—tasked with picking the projects that will secure ShieldTech's future.</p>
                </div>
                
                <div class="button-row" style="margin-top: 25px;">
                    <button class="btn btn-primary" onclick="document.getElementById('history-modal').classList.add('hidden')">Got it</button>
                </div>
            </div>
        </div>
        
        <!-- PHASE: DESIGN - DECISION MODEL -->
        <div id="phase-design-decision" class="phase-content hidden">
            <div class="design-header">
                <div class="step-indicator">
                    <span class="step-badge">Step 1 of 3</span>
                    <span class="step-label">Process Design</span>
                </div>
                <h1>Who Should Make Selection Decisions?</h1>
                <p>Your first major choice: how will project funding decisions be made?</p>
            </div>
            
            <div class="decision-model-grid">
                <div class="model-card" onclick="selectDecisionModel('solo')" data-model="solo">
                    <div class="icon">👤</div>
                    <h3>You Decide Alone</h3>
                    <p>Fast decisions with clear accountability. You review all proposals and make the calls.</p>
                    <div class="traits">
                        <span class="trait-tag">Fast</span>
                        <span class="trait-tag">Consistent</span>
                        <span class="trait-tag">Risky</span>
                    </div>
                </div>
                
                <div class="model-card" onclick="selectDecisionModel('committee')" data-model="committee">
                    <div class="icon">👥</div>
                    <h3>Selection Committee</h3>
                    <p>Assemble a team of colleagues to evaluate and vote on proposals together.</p>
                    <div class="traits">
                        <span class="trait-tag">Diverse views</span>
                        <span class="trait-tag">Shared ownership</span>
                        <span class="trait-tag">Slower</span>
                    </div>
                </div>
                
                <div class="model-card" onclick="selectDecisionModel('jury')" data-model="jury">
                    <div class="icon">🗳️</div>
                    <h3>Staff Jury</h3>
                    <p>Random selection of employees from across the company vote on each proposal.</p>
                    <div class="traits">
                        <span class="trait-tag">Democratic</span>
                        <span class="trait-tag">Fresh eyes</span>
                        <span class="trait-tag">Unpredictable</span>
                    </div>
                </div>
                
                <div class="model-card" onclick="selectDecisionModel('random')" data-model="random">
                    <div class="icon">🎲</div>
                    <h3>Leave It to Chance</h3>
                    <p>Projects meeting basic criteria are randomly selected. No human bias.</p>
                    <div class="traits">
                        <span class="trait-tag">Unbiased</span>
                        <span class="trait-tag">Equal chance</span>
                        <span class="trait-tag">No expertise</span>
                    </div>
                </div>
            </div>
            
            <div class="button-row">
                <button class="btn btn-secondary" onclick="showPhase('briefing')">← Back</button>
                <button class="btn btn-primary" id="decision-model-next" onclick="proceedFromDecisionModel()" disabled>Continue →</button>
            </div>
        </div>
        
        <!-- PHASE: DESIGN - COMMITTEE SELECTION -->
        <div id="phase-design-committee" class="phase-content hidden">
            <div class="design-header">
                <div class="step-indicator">
                    <span class="step-badge">Step 1 of 2</span>
                    <span class="step-label">Build Your Committee</span>
                </div>
                <h1>Select Your Committee Members</h1>
                <p>Choose colleagues to join your selection committee. Each brings different perspectives, expertise, and biases. Add as many as you think you need.</p>
            </div>
            
            <div class="committee-section">
                <div class="committee-display">
                    <h3>Your Committee (<span id="committee-count">0</span> members)</h3>
                    <div class="committee-members" id="committee-members">
                        <div class="empty-committee">Click on staff members below to add them to your committee</div>
                    </div>
                </div>
            </div>
            
            <div class="committee-section">
                <div class="staff-category">
                    <h3 class="staff-category-header">
                        <span class="category-icon">👔</span>
                        Senior Leadership
                        <span class="category-hint">Strategic vision & organisational authority</span>
                    </h3>
                    <div class="staff-grid" id="staff-senior"></div>
                </div>
                
                <div class="staff-category">
                    <h3 class="staff-category-header">
                        <span class="category-icon">🏢</span>
                        Business Unit Heads
                        <span class="category-hint">P&L owners with market & customer insight</span>
                    </h3>
                    <div class="staff-grid" id="staff-heads"></div>
                </div>
                
                <div class="staff-category">
                    <h3 class="staff-category-header">
                        <span class="category-icon">🔬</span>
                        Technical Leaders
                        <span class="category-hint">Deep expertise in engineering & innovation</span>
                    </h3>
                    <div class="staff-grid" id="staff-tech"></div>
                </div>
                
                <div class="staff-category">
                    <h3 class="staff-category-header">
                        <span class="category-icon">💡</span>
                        Other Voices
                        <span class="category-hint">Fresh perspectives & diverse viewpoints</span>
                    </h3>
                    <div class="staff-grid" id="staff-junior"></div>
                </div>
            </div>
            
            <div class="button-row">
                <button class="btn btn-secondary" onclick="showPhase('briefing')">← Back</button>
                <button class="btn btn-primary" id="committee-next" onclick="showPhase('design-criteria')" disabled>Continue to Criteria →</button>
            </div>
        </div>
        
        <!-- PHASE: DESIGN - CRITERIA -->
        <div id="phase-design-criteria" class="phase-content hidden">
            <div class="design-header">
                <div class="step-indicator">
                    <span class="step-badge">Step 2 of 2</span>
                    <span class="step-label">Set Your Criteria</span>
                </div>
                <h1>Define Your Evaluation Criteria</h1>
                <p>What factors will you prioritise when evaluating projects? We recommend 4-6 criteria for balanced evaluation, but you can select as many as you need.</p>
            </div>
            
            <div class="committee-section">
                <div class="criteria-selection-header">
                    <h2>Primary Criteria</h2>
                    <div id="criteria-warning" class="criteria-warning">Select at least one criterion to continue</div>
                </div>
                
                <div class="criteria-category">
                    <h3 class="criteria-category-header">
                        <span class="category-icon">⚙️</span>
                        Technical & Feasibility
                    </h3>
                    <div class="criteria-grid" id="criteria-technical"></div>
                </div>
                
                <div class="criteria-category">
                    <h3 class="criteria-category-header">
                        <span class="category-icon">🎯</span>
                        Strategic Alignment
                    </h3>
                    <div class="criteria-grid" id="criteria-strategic"></div>
                </div>
                
                <div class="criteria-category">
                    <h3 class="criteria-category-header">
                        <span class="category-icon">📈</span>
                        Market & Commercial
                    </h3>
                    <div class="criteria-grid" id="criteria-market"></div>
                </div>
                
                <div class="criteria-category">
                    <h3 class="criteria-category-header">
                        <span class="category-icon">💼</span>
                        Financial & Execution
                    </h3>
                    <div class="criteria-grid" id="criteria-financial"></div>
                </div>
            </div>
            
            <div class="button-row">
                <button class="btn btn-secondary" onclick="goBackFromCriteria()">← Back</button>
                <button class="btn btn-primary" id="criteria-next" onclick="showCriteriaWeights()" disabled>Weight Your Criteria →</button>
            </div>
        </div>
        
        <!-- PHASE: CRITERIA WEIGHTING -->
        <div id="phase-criteria-weights" class="phase-content hidden">
            <div class="design-header">
                <div class="step-indicator">
                    <span class="step-badge">Step 2 of 2</span>
                    <span class="step-label">Weight Your Criteria</span>
                </div>
                <h1>Assign Importance Weights</h1>
                <p>How important is each criterion relative to the others? Distribute 100 points across your selected criteria to reflect their relative importance in your evaluation.</p>
            </div>
            
            <div class="committee-section">
                <div class="weights-container">
                    <div class="weights-header">
                        <div class="weights-total-display">
                            <span class="weights-label">Total:</span>
                            <span id="weights-total" class="weights-value">0</span>
                            <span class="weights-target">/ 100</span>
                        </div>
                        <div id="weights-status" class="weights-status">Assign exactly 100 points</div>
                    </div>
                    
                    <div id="weights-grid" class="weights-grid">
                        <!-- Populated by JavaScript -->
                    </div>
                    
                    <div class="weights-actions">
                        <button class="btn btn-text" onclick="distributeWeightsEvenly()">Distribute Evenly</button>
                        <button class="btn btn-text" onclick="resetWeights()">Reset All</button>
                    </div>
                </div>
                
                <div class="weights-preview">
                    <h3>Preview: Your Evaluation Formula</h3>
                    <div id="weights-formula" class="weights-formula">
                        <!-- Shows formula preview -->
                    </div>
                </div>
            </div>
            
            <div class="button-row">
                <button class="btn btn-secondary" onclick="showPhase('design-criteria')">← Back to Criteria</button>
                <button class="btn btn-primary" id="weights-next" onclick="confirmWeightsAndShowLegacy()" disabled>Review Current Portfolio →</button>
            </div>
        </div>
        
        <!-- PHASE: LEGACY PORTFOLIO -->
        <div id="phase-legacy-portfolio" class="phase-content hidden">
            <div class="phase-indicator">
                <div class="phase-dot completed">1</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot active">2</div>
                <div class="phase-connector"></div>
                <div class="phase-dot">3</div>
                <div class="phase-connector"></div>
                <div class="phase-dot">4</div>
            </div>
            
            <div class="briefing-header" style="margin-bottom: 25px;">
                <div class="company-logo">🏢 ShieldTech India</div>
                <h1>Current R&D Portfolio</h1>
                <p class="subtitle">Before selecting new projects, you must decide what to do with the initiatives you've inherited.</p>
            </div>
            
            <div class="legacy-summary-bar" style="background: var(--white); padding: 20px 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                <div style="display: flex; gap: 30px; flex-wrap: wrap;">
                    <div style="text-align: center;">
                        <div style="font-size: 1.8em; font-weight: 700; color: var(--primary);" id="legacy-count">7</div>
                        <div style="font-size: 0.85em; color: var(--gray-500);">Active Projects</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.8em; font-weight: 700; color: var(--warning);" id="legacy-committed-budget">$8.1M</div>
                        <div style="font-size: 0.85em; color: var(--gray-500);">Remaining Budget</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.8em; font-weight: 700; color: var(--gray-600);" id="legacy-sunk-cost">$15.1M</div>
                        <div style="font-size: 0.85em; color: var(--gray-500);">Already Spent</div>
                    </div>
                </div>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <span style="width: 12px; height: 12px; border-radius: 50%; background: var(--success);"></span>
                        <span style="font-size: 0.85em; color: var(--gray-600);" id="legacy-green-count">2 On Track</span>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <span style="width: 12px; height: 12px; border-radius: 50%; background: var(--warning);"></span>
                        <span style="font-size: 0.85em; color: var(--gray-600);" id="legacy-amber-count">3 At Risk</span>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <span style="width: 12px; height: 12px; border-radius: 50%; background: var(--danger);"></span>
                        <span style="font-size: 0.85em; color: var(--gray-600);" id="legacy-red-count">2 Troubled</span>
                    </div>
                </div>
            </div>
            
            <div id="legacy-projects-container" style="display: flex; flex-direction: column; gap: 20px;">
                <!-- Legacy projects rendered here by JavaScript -->
            </div>
            
            <div class="budget-impact-summary" style="background: var(--primary-lighter); padding: 20px 25px; border-radius: 12px; margin-top: 25px; border: 2px solid var(--primary-pale);">
                <h3 style="color: var(--primary); margin-bottom: 12px; font-size: 1.1em;">📊 Your Decisions Impact</h3>
                <div style="display: flex; gap: 40px; flex-wrap: wrap;">
                    <div>
                        <div style="font-size: 1.4em; font-weight: 700; color: var(--primary);" id="legacy-new-budget">$8.1M</div>
                        <div style="font-size: 0.85em; color: var(--gray-600);">Budget Committed to Legacy</div>
                    </div>
                    <div>
                        <div style="font-size: 1.4em; font-weight: 700; color: var(--success);" id="legacy-freed-budget">$0.0M</div>
                        <div style="font-size: 0.85em; color: var(--gray-600);">Budget Freed Up</div>
                    </div>
                    <div>
                        <div style="font-size: 1.4em; font-weight: 700; color: var(--accent);" id="legacy-available-new">$<span id="available-for-new">0.0</span>M</div>
                        <div style="font-size: 0.85em; color: var(--gray-600);">Available for New Projects</div>
                    </div>
                </div>
            </div>
            
            <div class="button-row" style="margin-top: 25px;">
                <button class="btn btn-secondary" onclick="showPhase('criteria-weights')">← Back to Criteria</button>
                <button class="btn btn-primary" id="legacy-confirm-btn" onclick="confirmLegacyDecisions()">Confirm Decisions & See New Projects →</button>
            </div>
        </div>
        
        <!-- SELECTION APPROACH MODAL -->
        <div class="approach-modal-overlay hidden" id="approach-modal">
            <div class="approach-modal">
                <div class="approach-modal-header">
                    <h2>🎯 Configure Your Selection Process</h2>
                    <p>Make two decisions that will shape how you evaluate project proposals</p>
                </div>
                
                <div class="approach-modal-body">
                    <!-- CHOICE 1: SCORING APPROACH -->
                    <div class="approach-choice-section">
                        <div class="approach-choice-header">
                            <span class="choice-number">1</span>
                            <div>
                                <h3>How will you score projects?</h3>
                                <p>Choose how much time and detail you'll invest in evaluating each proposal</p>
                            </div>
                        </div>
                        
                        <div class="approach-options-vertical">
                            <div class="approach-option" data-choice="scoring" data-value="careful" onclick="selectApproachOption('scoring', 'careful')">
                                <div class="approach-option-radio"></div>
                                <div class="approach-option-icon">🔍</div>
                                <div class="approach-option-content">
                                    <div class="approach-option-title">Careful Evaluation</div>
                                    <div class="approach-option-desc">Review full project details, financials, risks, and milestones. Score each criterion thoughtfully.</div>
                                    <div class="approach-option-effects">
                                        <span class="approach-effect pro">Full information</span>
                                        <span class="approach-effect pro">Thorough analysis</span>
                                        <span class="approach-effect neutral">~3 min per project</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="approach-option" data-choice="scoring" data-value="rapid" onclick="selectApproachOption('scoring', 'rapid')">
                                <div class="approach-option-radio"></div>
                                <div class="approach-option-icon">⚡</div>
                                <div class="approach-option-content">
                                    <div class="approach-option-title">Rapid Screening</div>
                                    <div class="approach-option-desc">See only a brief summary and key metrics. Make quick judgments based on first impressions.</div>
                                    <div class="approach-option-effects">
                                        <span class="approach-effect pro">Fast decisions</span>
                                        <span class="approach-effect con">Limited detail</span>
                                        <span class="approach-effect neutral">~30 sec per project</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="approach-option" data-choice="scoring" data-value="delegate" onclick="selectApproachOption('scoring', 'delegate')">
                                <div class="approach-option-radio"></div>
                                <div class="approach-option-icon">👥</div>
                                <div class="approach-option-content">
                                    <div class="approach-option-title">Delegate to Committee</div>
                                    <div class="approach-option-desc">Let your committee members score the projects. You'll review their recommendations and make final decisions.</div>
                                    <div class="approach-option-effects">
                                        <span class="approach-effect pro">Leverage expertise</span>
                                        <span class="approach-effect con">Less personal insight</span>
                                        <span class="approach-effect neutral">Skip to triage</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- CHOICE 2: TEAM INFORMATION BLINDING -->
                    <div class="approach-choice-section">
                        <div class="approach-choice-header">
                            <span class="choice-number">2</span>
                            <div>
                                <h3>Should team information be visible?</h3>
                                <p>Decide whether to see who is leading and working on each project</p>
                            </div>
                        </div>
                        
                        <div class="approach-options-horizontal">
                            <div class="approach-option compact" data-choice="blinding" data-value="visible" onclick="selectApproachOption('blinding', 'visible')">
                                <div class="approach-option-radio"></div>
                                <div class="approach-option-icon">👤</div>
                                <div class="approach-option-content">
                                    <div class="approach-option-title">Show Team Info</div>
                                    <div class="approach-option-desc">See project leads, team composition, and track records. People matter in project success.</div>
                                    <div class="approach-option-effects">
                                        <span class="approach-effect pro">Full context</span>
                                        <span class="approach-effect con">Potential bias</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="approach-option compact" data-choice="blinding" data-value="blind" onclick="selectApproachOption('blinding', 'blind')">
                                <div class="approach-option-radio"></div>
                                <div class="approach-option-icon">🎭</div>
                                <div class="approach-option-content">
                                    <div class="approach-option-title">Blind Review</div>
                                    <div class="approach-option-desc">Hide all team information. Judge projects purely on their merits, not personalities.</div>
                                    <div class="approach-option-effects">
                                        <span class="approach-effect pro">Reduces bias</span>
                                        <span class="approach-effect con">Missing context</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="approach-research-note">
                        <h4>📚 Research Insight</h4>
                        <p>Studies show that evaluator attention and information presentation significantly affect project selection. Time pressure leads to reliance on heuristics, while knowing team identities can introduce both valuable context and unconscious biases (Criscuolo et al., 2021; Boudreau et al., 2016).</p>
                    </div>
                </div>
                
                <div class="approach-modal-footer">
                    <button class="approach-confirm-btn" id="approach-confirm-btn" disabled onclick="confirmApproach()">
                        Make Both Selections to Continue
                    </button>
                </div>
            </div>
        </div>
        
        <!-- PHASE: PLAYER ASSESSMENT -->
        <div id="phase-assessment" class="phase-content hidden">
            <div class="phase-indicator">
                <div class="phase-dot completed">1</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot active">2</div>
                <div class="phase-connector"></div>
                <div class="phase-dot">3</div>
                <div class="phase-connector"></div>
                <div class="phase-dot">4</div>
            </div>
            
            <div class="card">
                <div class="assessment-header">
                    <h2>Assess Project Proposals</h2>
                    <div class="assessment-progress-bar">
                        <div class="progress-fill" id="assessment-progress-fill"></div>
                    </div>
                    <div class="assessment-progress-text">
                        Project <strong id="current-project-num">1</strong> of <span id="total-projects">12</span>
                    </div>
                    <div class="project-progress-dots" id="project-progress-dots">
                        <!-- Project dots will be rendered here -->
                    </div>
                </div>
                
                <div class="assessment-project-view" id="assessment-project-view">
                    <!-- Current project details will be rendered here -->
                </div>
                
                <div class="assessment-scoring" id="assessment-scoring">
                    <!-- Scoring interface will be rendered here -->
                </div>
                
                <div class="button-row">
                    <button class="btn btn-secondary" id="prev-project-btn" onclick="prevProject()" disabled>← Previous</button>
                    <button class="btn btn-primary" id="next-project-btn" onclick="nextProject()">Next Project →</button>
                </div>
            </div>
        </div>
        
        <!-- PHASE: COMMITTEE FEEDBACK -->
        <div id="phase-committee-feedback" class="phase-content hidden">
            <div class="phase-indicator">
                <div class="phase-dot completed">1</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot completed">2</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot active">3</div>
                <div class="phase-connector"></div>
                <div class="phase-dot">4</div>
            </div>
            
            <div class="triage-layout">
                <div class="triage-header">
                    <h2>Triage Your Projects</h2>
                    <p>Review committee feedback and make initial funding decisions. Categorise each project, then fine-tune the marginal cases in the portfolio view.</p>
                    
                    <div class="triage-budget-summary">
                        <div class="triage-budget-bar">
                            <div class="triage-budget-fill" id="triage-budget-fill"></div>
                        </div>
                        <div class="triage-budget-text">
                            <span class="funded-amount" id="triage-funded-amount">$0M</span> committed
                            <span class="separator">|</span>
                            <span class="remaining-amount" id="triage-remaining-amount">$30M</span> remaining
                            <span class="separator">|</span>
                            <span class="marginal-amount" id="triage-marginal-amount">$0M</span> in marginal projects
                        </div>
                    </div>
                    
                    <div class="triage-counts">
                        <div class="triage-count fund">
                            <span class="count-num" id="count-fund">0</span>
                            <span class="count-label">Funded</span>
                        </div>
                        <div class="triage-count marginal">
                            <span class="count-num" id="count-marginal">0</span>
                            <span class="count-label">Marginal</span>
                        </div>
                        <div class="triage-count stop">
                            <span class="count-num" id="count-stop">0</span>
                            <span class="count-label">Stopped</span>
                        </div>
                    </div>
                </div>
                
                <div class="triage-grid" id="triage-grid">
                    <!-- Triage cards will be rendered here -->
                </div>
                
                <div class="button-row">
                    <button class="btn btn-secondary" onclick="showPhase('assessment')">← Revise Assessment</button>
                    <button class="btn btn-primary" id="triage-continue-btn" onclick="showBudgetMeeting()">Proceed to Budget Approval →</button>
                </div>
            </div>
        </div>
        
        <!-- PHASE: BUDGET MEETING CHOICE -->
        <div id="phase-budget-meeting" class="phase-content hidden">
            <div class="phase-indicator">
                <div class="phase-dot completed">1</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot completed">2</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot active">3</div>
                <div class="phase-connector"></div>
                <div class="phase-dot">4</div>
            </div>
            
            <div class="card" style="text-align: center; padding: 40px;">
                <h2 style="color: var(--primary); margin-bottom: 20px;">🪑 Budget Approval Meeting</h2>
                <p style="max-width: 600px; margin: 0 auto 25px; color: var(--gray-600); line-height: 1.6;">
                    Before finalizing your portfolio, chair the R&D Budget Committee meeting. 
                    Your facilitation skills determine your final budget allocation.
                </p>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; max-width: 450px; margin: 0 auto 25px;">
                    <div style="background: var(--success-light); border: 2px solid var(--success); border-radius: 12px; padding: 15px;">
                        <div style="font-size: 1.8em; margin-bottom: 8px;">🏆</div>
                        <div style="font-weight: 700; color: var(--success);">Great Meeting</div>
                        <div style="font-size: 0.85em; color: var(--gray-600);">Up to $44M (+10%)</div>
                    </div>
                    <div style="background: var(--danger-light); border: 2px solid var(--danger); border-radius: 12px; padding: 15px;">
                        <div style="font-size: 1.8em; margin-bottom: 8px;">💥</div>
                        <div style="font-weight: 700; color: var(--danger);">Failed Meeting</div>
                        <div style="font-size: 0.85em; color: var(--gray-600);">Down to $34M (-15%)</div>
                    </div>
                </div>
                
                <div class="button-row" style="justify-content: center; gap: 20px;">
                    <button class="btn btn-gold btn-large" onclick="startCommitteeChaos()">🪑 Start the Meeting</button>
                </div>
            </div>
        </div>
        
        <!-- PHASE: BUDGET RESULTS -->
        <div id="phase-budget-results" class="phase-content hidden">
            <div class="phase-indicator">
                <div class="phase-dot completed">1</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot completed">2</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot active">3</div>
                <div class="phase-connector"></div>
                <div class="phase-dot">4</div>
            </div>
            
            <div class="card" style="text-align: center; padding: 40px;">
                <h2 id="budget-result-title" style="color: var(--primary); margin-bottom: 15px;">Meeting Complete</h2>
                <p id="budget-result-message" style="max-width: 500px; margin: 0 auto 20px; color: var(--gray-600);"></p>
                
                <div style="background: var(--gold-light); border: 2px solid var(--gold); border-radius: 12px; padding: 20px; max-width: 300px; margin: 0 auto 25px;">
                    <div style="font-size: 0.85em; color: var(--gray-600); margin-bottom: 5px;">Your R&D Budget</div>
                    <div id="budget-result-amount" style="font-size: 2.2em; font-weight: 700; color: var(--primary);">$30M</div>
                    <div id="budget-result-change" style="font-size: 0.95em; margin-top: 5px;"></div>
                </div>
                
                <button class="btn btn-primary btn-large" onclick="showPortfolioBuilder()">Build Your Portfolio →</button>
            </div>
        </div>
        
        <!-- PHASE: YEAR 2 BUDGET MEETING -->
        <!-- PHASE: YEAR 1 END SELECTION (Mid-Year Portfolio Refresh) -->
        <div id="phase-year1-end-selection" class="phase-content hidden">
            <div class="phase-indicator">
                <div class="phase-dot completed">1</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot completed">2</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot completed">3</div>
                <div class="phase-connector"></div>
                <div class="phase-dot active">4</div>
            </div>
            
            <div class="card">
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                    <span style="font-size: 2em;">🔄</span>
                    <div>
                        <h2 style="margin: 0; color: var(--primary);">Year 1 Portfolio Review</h2>
                        <p style="margin: 5px 0 0; color: var(--gray-500);">Q4 Complete — Time to refresh your portfolio for Year 2</p>
                    </div>
                </div>
                
                <p style="margin-bottom: 20px; color: var(--gray-600); line-height: 1.6;">
                    After a year of development, new opportunities have emerged from market shifts and technological advances. 
                    Some projects have freed up resources, and your team has identified promising new initiatives.
                    <strong>Consider how new projects might complement or rebalance your portfolio for Year 2.</strong>
                </p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: var(--success-light); border-radius: 12px; padding: 15px; text-align: center;">
                        <div style="font-size: 1.5em; margin-bottom: 5px;">📊</div>
                        <div style="font-weight: 600; color: var(--success);">Year 1 Learning</div>
                        <div style="font-size: 0.85em; color: var(--gray-600);">Market feedback informs new bets</div>
                    </div>
                    <div style="background: var(--info-light); border-radius: 12px; padding: 15px; text-align: center;">
                        <div style="font-size: 1.5em; margin-bottom: 5px;">🆕</div>
                        <div style="font-weight: 600; color: var(--info);">Fresh Opportunities</div>
                        <div style="font-size: 0.85em; color: var(--gray-600);">New projects from the pipeline</div>
                    </div>
                    <div style="background: var(--gold-light); border-radius: 12px; padding: 15px; text-align: center;">
                        <div style="font-size: 1.5em; margin-bottom: 5px;">💰</div>
                        <div style="font-weight: 600; color: var(--gold-dark);">Available Budget</div>
                        <div style="font-size: 0.85em; color: var(--gray-600);">Freed from completed/killed projects</div>
                    </div>
                </div>
                
                <div class="budget-bar">
                    <div class="budget-display">
                        Available Budget: <span class="amount" id="year1end-budget-remaining">$0M</span> <span class="total" id="year1end-budget-total">/ $30M total</span>
                    </div>
                    <div class="projects-count"><span id="year1end-projects-selected">0</span> new projects selected</div>
                </div>
                
                <div style="background: var(--warning-light); border: 1px solid var(--warning); border-radius: 8px; padding: 12px 15px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: flex-start; gap: 10px;">
                        <span style="font-size: 1.2em;">⚡</span>
                        <div style="font-size: 0.9em; color: var(--gray-700);">
                            <strong>Strategic Timing:</strong> Projects selected now will begin Q5 and can capitalise on Year 1 learnings. 
                            Choose initiatives that complement your existing portfolio or address gaps you've discovered.
                        </div>
                    </div>
                </div>
                
                <!-- Strategic Balance Display for Year 1 End -->
                <div style="margin-bottom: 20px;">
                    <h3 style="margin: 0 0 10px; color: var(--gray-700); font-size: 1em;">Portfolio Balance (Current + Selected)</h3>
                    <div id="year1end-strategic-balance" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 15px; background: var(--gray-50); border-radius: 10px;">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
                
                <div class="project-grid" id="year1end-project-grid"></div>
                
                <div class="button-row">
                    <button class="btn btn-secondary" onclick="skipYear1EndSelection()">Skip (no new projects) →</button>
                    <button class="btn btn-primary" id="confirm-year1end-selection-btn" onclick="finalConfirmYear1EndSelection()" disabled>Add Selected Projects →</button>
                </div>
            </div>
        </div>
        
        <!-- Year 1 End Portfolio Review Modal -->
        <div class="modal-overlay hidden" id="year1end-review-modal">
            <div class="modal-content" style="max-width: 700px;">
                <button class="modal-close" onclick="closeYear1EndReview()">×</button>
                <h2 style="color: var(--primary); margin-bottom: 15px;">📊 Year 2 Portfolio Review</h2>
                <p style="color: var(--gray-600); margin-bottom: 20px;">
                    Review your updated portfolio balance before proceeding. Make sure your strategic buckets align with your Year 2 goals.
                </p>
                
                <div style="margin-bottom: 25px;">
                    <h3 style="font-size: 1em; color: var(--gray-700); margin-bottom: 12px;">Strategic Balance After Adding New Projects</h3>
                    <div id="year1end-review-balance" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 15px; background: var(--gray-50); border-radius: 10px;">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
                
                <div style="margin-bottom: 25px;">
                    <h3 style="font-size: 1em; color: var(--gray-700); margin-bottom: 12px;">New Projects Being Added</h3>
                    <div id="year1end-review-projects" style="display: grid; gap: 10px;">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
                
                <div style="margin-bottom: 25px;">
                    <h3 style="font-size: 1em; color: var(--gray-700); margin-bottom: 12px;">Current Active Portfolio</h3>
                    <div id="year1end-review-existing" style="display: grid; gap: 8px; max-height: 200px; overflow-y: auto;">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px; text-align: center;">
                    <div style="background: var(--info-light); padding: 15px; border-radius: 10px;">
                        <div style="font-size: 1.5em; font-weight: 700; color: var(--info);" id="year1end-review-total-projects">0</div>
                        <div style="font-size: 0.85em; color: var(--gray-500);">Total Projects</div>
                    </div>
                    <div style="background: var(--gold-light); padding: 15px; border-radius: 10px;">
                        <div style="font-size: 1.5em; font-weight: 700; color: var(--gold-dark);" id="year1end-review-budget-used">$0</div>
                        <div style="font-size: 0.85em; color: var(--gray-500);">Budget Allocated</div>
                    </div>
                    <div style="background: var(--success-light); padding: 15px; border-radius: 10px;">
                        <div style="font-size: 1.5em; font-weight: 700; color: var(--success);" id="year1end-review-budget-remaining">$0</div>
                        <div style="font-size: 0.85em; color: var(--gray-500);">Budget Remaining</div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button class="btn btn-secondary" onclick="closeYear1EndReview()">← Adjust Selection</button>
                    <button class="btn btn-primary" onclick="finalConfirmYear1EndSelection()">Confirm & Continue to Year 2 →</button>
                </div>
            </div>
        </div>
        
        <!-- YEAR 1 PORTFOLIO REVIEW MODAL (2x2 Matrix) -->
        <div class="modal-overlay hidden" id="year1-portfolio-review-modal">
            <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                <button class="modal-close" onclick="closeYear1PortfolioReview()">×</button>
                <h2 style="color: var(--primary); margin-bottom: 10px;">📊 Portfolio Balance</h2>
                <p style="color: var(--gray-600); margin-bottom: 20px;">
                    Review your updated portfolio balance after adding new projects. Use the matrix views to assess strategic alignment before continuing to Year 2.
                </p>
                
                <div style="display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap;">
                    <button class="matrix-toggle-btn active" onclick="switchYear1Matrix('risk-speed')" data-matrix="risk-speed">Speed vs Risk</button>
                    <button class="matrix-toggle-btn" onclick="switchYear1Matrix('market-tech')" data-matrix="market-tech">Market vs Tech</button>
                    <button class="matrix-toggle-btn" onclick="switchYear1Matrix('capability-strategic')" data-matrix="capability-strategic">Capability vs Strategy</button>
                    <button class="matrix-toggle-btn" onclick="switchYear1Matrix('roi-cost')" data-matrix="roi-cost">Return on Investment vs Cost</button>
                </div>
                
                <div class="matrix-container" id="year1-matrix-container" style="max-height: 400px;">
                    <!-- Matrix will be rendered here -->
                </div>
                
                <div class="matrix-legend" style="margin-top: 15px; display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;">
                    <div class="legend-item">
                        <div class="legend-bubble" style="background: #22c55e; border: 2px solid #166534;"></div>
                        <span>Completed (Success)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-bubble" style="background: #ef4444; border: 2px solid #b91c1c;"></div>
                        <span>Completed (Failed)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-bubble" style="background: #6b7280; border: 2px solid #374151;"></div>
                        <span>Killed</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-bubble" style="background: #3b82f6; border: 2px solid #1d4ed8;"></div>
                        <span>Active (Year 2)</span>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin: 20px 0; text-align: center;">
                    <div style="background: #dcfce7; padding: 12px; border-radius: 10px; border-left: 4px solid #22c55e;">
                        <div style="font-size: 1.5em; font-weight: 700; color: #166534;" id="y1-review-success">0</div>
                        <div style="font-size: 0.8em; color: var(--gray-500);">Successes</div>
                    </div>
                    <div style="background: #fee2e2; padding: 12px; border-radius: 10px; border-left: 4px solid #ef4444;">
                        <div style="font-size: 1.5em; font-weight: 700; color: #b91c1c;" id="y1-review-failed">0</div>
                        <div style="font-size: 0.8em; color: var(--gray-500);">Failures</div>
                    </div>
                    <div style="background: #f3f4f6; padding: 12px; border-radius: 10px; border-left: 4px solid #6b7280;">
                        <div style="font-size: 1.5em; font-weight: 700; color: #374151;" id="y1-review-killed">0</div>
                        <div style="font-size: 0.8em; color: var(--gray-500);">Killed</div>
                    </div>
                    <div style="background: #dbeafe; padding: 12px; border-radius: 10px; border-left: 4px solid #3b82f6;">
                        <div style="font-size: 1.5em; font-weight: 700; color: #1d4ed8;" id="y1-review-active">0</div>
                        <div style="font-size: 0.8em; color: var(--gray-500);">Active</div>
                    </div>
                </div>
                
                <div id="y1-review-insights" style="background: var(--gray-50); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                    <!-- Insights will be populated -->
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button class="btn btn-primary" onclick="closeYear1PortfolioReviewAndContinue()">Evaluate Year 2 Opportunities →</button>
                </div>
            </div>
        </div>

        <div id="phase-year2-budget-meeting" class="phase-content hidden">
            <div class="phase-indicator">
                <div class="phase-dot completed">1</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot completed">2</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot completed">3</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot active">4</div>
            </div>
            
            <div class="card" style="text-align: center; padding: 40px;">
                <h2 style="color: var(--primary); margin-bottom: 20px;">🪑 Year 2 Budget Review</h2>
                <p style="max-width: 600px; margin: 0 auto 25px; color: var(--gray-600); line-height: 1.6;">
                    Mid-point review! The committee reconvenes to assess progress and adjust funding for Year 2.
                    Your facilitation can unlock additional resources or protect existing budget.
                </p>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; max-width: 450px; margin: 0 auto 25px;">
                    <div style="background: var(--success-light); border: 2px solid var(--success); border-radius: 12px; padding: 15px;">
                        <div style="font-size: 1.8em; margin-bottom: 8px;">📈</div>
                        <div style="font-weight: 700; color: var(--success);">Strong Review</div>
                        <div style="font-size: 0.85em; color: var(--gray-600);">Up to +10% budget boost</div>
                    </div>
                    <div style="background: var(--danger-light); border: 2px solid var(--danger); border-radius: 12px; padding: 15px;">
                        <div style="font-size: 1.8em; margin-bottom: 8px;">📉</div>
                        <div style="font-weight: 700; color: var(--danger);">Poor Review</div>
                        <div style="font-size: 0.85em; color: var(--gray-600);">Up to -15% budget cut</div>
                    </div>
                </div>
                
                <div class="button-row" style="justify-content: center; gap: 20px;">
                    <button class="btn btn-gold btn-large" onclick="startYear2CommitteeChaos()">🪑 Start the Meeting</button>
                </div>
            </div>
        </div>
        
        <!-- PHASE: YEAR 2 BUDGET RESULTS -->
        <div id="phase-year2-budget-results" class="phase-content hidden">
            <div class="phase-indicator">
                <div class="phase-dot completed">1</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot completed">2</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot completed">3</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot active">4</div>
            </div>
            
            <div class="card" style="text-align: center; padding: 40px;">
                <h2 id="year2-budget-result-title" style="color: var(--primary); margin-bottom: 15px;">Review Complete</h2>
                <p id="year2-budget-result-message" style="max-width: 500px; margin: 0 auto 20px; color: var(--gray-600);"></p>
                
                <div style="background: var(--gold-light); border: 2px solid var(--gold); border-radius: 12px; padding: 20px; max-width: 300px; margin: 0 auto 25px;">
                    <div style="font-size: 0.85em; color: var(--gray-600); margin-bottom: 5px;">Updated R&D Budget</div>
                    <div id="year2-budget-result-amount" style="font-size: 2.2em; font-weight: 700; color: var(--primary);">$30M</div>
                    <div id="year2-budget-result-change" style="font-size: 0.95em; margin-top: 5px;"></div>
                </div>
                
                <button class="btn btn-primary btn-large" onclick="continueToYear2()">Begin Year 2 Operations →</button>
            </div>
        </div>
        
        <!-- YEAR 2 APPROACH MODAL -->
        <div class="approach-modal-overlay hidden" id="year2-approach-modal">
            <div class="approach-modal">
                <div class="approach-modal-header">
                    <h2>🎯 Year 2 Evaluation Approach</h2>
                    <p>New project opportunities have emerged. How will you evaluate them?</p>
                </div>
                
                <div class="approach-modal-body">
                    <!-- YEAR 1 APPROACH REMINDER -->
                    <div class="approach-choice-section" style="background: var(--primary-lighter); border: 2px solid var(--primary); border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                            <span style="font-size: 1.5em;">📋</span>
                            <div>
                                <h4 style="margin: 0; color: var(--primary);">Your Year 1 Approach</h4>
                                <p style="margin: 5px 0 0; font-size: 0.9em; color: var(--gray-600);" id="year1-approach-summary">Loading...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- CHOICE: KEEP OR CHANGE -->
                    <div class="approach-choice-section">
                        <div class="approach-choice-header">
                            <span class="choice-number">?</span>
                            <div>
                                <h3>Use the same approach for Year 2?</h3>
                                <p>You can continue with your established process or try a different method</p>
                            </div>
                        </div>
                        
                        <div class="approach-options-horizontal">
                            <div class="approach-option compact" data-choice="year2approach" data-value="same" onclick="selectYear2ApproachOption('same')">
                                <div class="approach-option-radio"></div>
                                <div class="approach-option-icon">✅</div>
                                <div class="approach-option-content">
                                    <div class="approach-option-title">Keep Same Approach</div>
                                    <div class="approach-option-desc">Continue with your Year 1 evaluation method for consistency.</div>
                                    <div class="approach-option-effects">
                                        <span class="approach-effect pro">Consistent process</span>
                                        <span class="approach-effect pro">Comparable scores</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="approach-option compact" data-choice="year2approach" data-value="change" onclick="selectYear2ApproachOption('change')">
                                <div class="approach-option-radio"></div>
                                <div class="approach-option-icon">🔄</div>
                                <div class="approach-option-content">
                                    <div class="approach-option-title">Change Approach</div>
                                    <div class="approach-option-desc">Try a different evaluation method based on your Year 1 experience.</div>
                                    <div class="approach-option-effects">
                                        <span class="approach-effect pro">Adapt & learn</span>
                                        <span class="approach-effect con">Different baseline</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- CHANGE OPTIONS (hidden initially) -->
                    <div id="year2-change-options" class="hidden">
                        <div class="approach-choice-section">
                            <div class="approach-choice-header">
                                <span class="choice-number">1</span>
                                <div>
                                    <h3>New scoring approach</h3>
                                    <p>How will you score Year 2 projects?</p>
                                </div>
                            </div>
                            
                            <div class="approach-options-vertical">
                                <div class="approach-option" data-choice="y2scoring" data-value="careful" onclick="selectYear2ScoringOption('careful')">
                                    <div class="approach-option-radio"></div>
                                    <div class="approach-option-icon">🔍</div>
                                    <div class="approach-option-content">
                                        <div class="approach-option-title">Careful Evaluation</div>
                                        <div class="approach-option-desc">Review full project details. Score each criterion thoughtfully.</div>
                                    </div>
                                </div>
                                
                                <div class="approach-option" data-choice="y2scoring" data-value="rapid" onclick="selectYear2ScoringOption('rapid')">
                                    <div class="approach-option-radio"></div>
                                    <div class="approach-option-icon">⚡</div>
                                    <div class="approach-option-content">
                                        <div class="approach-option-title">Rapid Screening</div>
                                        <div class="approach-option-desc">Quick judgments based on summary information.</div>
                                    </div>
                                </div>
                                
                                <div class="approach-option" data-choice="y2scoring" data-value="delegate" onclick="selectYear2ScoringOption('delegate')">
                                    <div class="approach-option-radio"></div>
                                    <div class="approach-option-icon">👥</div>
                                    <div class="approach-option-content">
                                        <div class="approach-option-title">Delegate to Committee</div>
                                        <div class="approach-option-desc">Let committee members score. You review recommendations.</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="approach-choice-section">
                            <div class="approach-choice-header">
                                <span class="choice-number">2</span>
                                <div>
                                    <h3>Team information visibility</h3>
                                </div>
                            </div>
                            
                            <div class="approach-options-horizontal">
                                <div class="approach-option compact" data-choice="y2blinding" data-value="visible" onclick="selectYear2BlindingOption('visible')">
                                    <div class="approach-option-radio"></div>
                                    <div class="approach-option-icon">👤</div>
                                    <div class="approach-option-content">
                                        <div class="approach-option-title">Show Team Info</div>
                                    </div>
                                </div>
                                
                                <div class="approach-option compact" data-choice="y2blinding" data-value="blind" onclick="selectYear2BlindingOption('blind')">
                                    <div class="approach-option-radio"></div>
                                    <div class="approach-option-icon">🎭</div>
                                    <div class="approach-option-content">
                                        <div class="approach-option-title">Blind Review</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="approach-research-note">
                        <h4>📚 Learning Opportunity</h4>
                        <p>Year 2 evaluation lets you compare new opportunities against your ongoing investments. Consider: Are the new projects stronger or weaker than what you're already funding? Should you reallocate resources?</p>
                    </div>
                </div>
                
                <div class="approach-modal-footer">
                    <button class="approach-confirm-btn" id="year2-approach-confirm-btn" disabled onclick="confirmYear2Approach()">
                        Select an Option to Continue
                    </button>
                </div>
            </div>
        </div>
        
        <!-- PHASE: YEAR 2 ASSESSMENT -->
        <div id="phase-year2-assessment" class="phase-content hidden">
            <div class="phase-indicator">
                <div class="phase-dot completed">1</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot completed">2</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot completed">3</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot active">4</div>
            </div>
            
            <div class="assessment-header">
                <div class="project-counter">
                    <span class="current" id="year2-project-counter-current">1</span>
                    <span class="total">/ <span id="year2-project-counter-total">6</span></span>
                </div>
                <div class="assessment-progress-bar">
                    <div class="assessment-progress-fill" id="year2-assessment-progress"></div>
                </div>
            </div>
            
            <div class="assessment-container">
                <div class="card project-card" id="year2-project-card">
                    <!-- Project details populated by JavaScript -->
                </div>
                
                <div class="card scoring-card">
                    <h3>📊 Your Assessment</h3>
                    <p class="scoring-instructions">Rate this project on each dimension (1-5 scale)</p>
                    
                    <div class="scoring-grid" id="year2-scoring-grid">
                        <!-- Scoring sliders populated by JavaScript -->
                    </div>
                    
                    <div class="scoring-summary">
                        <div class="score-display">
                            <span class="score-label">Your Average Score:</span>
                            <span class="score-value" id="year2-player-avg-score">-</span>
                        </div>
                    </div>
                    
                    <div class="button-row">
                        <button class="btn btn-secondary" id="year2-prev-project-btn" onclick="year2PrevProject()" disabled>← Previous</button>
                        <button class="btn btn-primary" id="year2-next-project-btn" onclick="year2NextProject()">Next Project →</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- PHASE: YEAR 2 COMMITTEE FEEDBACK -->
        <div id="phase-year2-committee-feedback" class="phase-content hidden">
            <div class="phase-indicator">
                <div class="phase-dot completed">1</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot completed">2</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot completed">3</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot active">4</div>
            </div>
            
            <div class="card">
                <div class="feedback-header">
                    <h2>📊 Year 2 Project Rankings</h2>
                    <p>Compare the new opportunities against your ongoing portfolio</p>
                </div>
                
                <div class="feedback-tabs" style="margin-bottom: 20px;">
                    <button class="feedback-tab active" onclick="switchYear2FeedbackTab('new')" data-tab="new">🆕 New Projects</button>
                    <button class="feedback-tab" onclick="switchYear2FeedbackTab('ongoing')" data-tab="ongoing">📂 Ongoing Projects</button>
                    <button class="feedback-tab" onclick="switchYear2FeedbackTab('comparison')" data-tab="comparison">⚖️ Comparison</button>
                </div>
                
                <div id="year2-feedback-new" class="feedback-tab-content">
                    <h3 style="margin-bottom: 15px;">New Year 2 Opportunities (Ranked)</h3>
                    <div class="rankings-list" id="year2-new-rankings">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
                
                <div id="year2-feedback-ongoing" class="feedback-tab-content hidden">
                    <h3 style="margin-bottom: 15px;">Your Ongoing Projects (Original Scores)</h3>
                    <div class="rankings-list" id="year2-ongoing-rankings">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
                
                <div id="year2-feedback-comparison" class="feedback-tab-content hidden">
                    <h3 style="margin-bottom: 15px;">Side-by-Side Comparison</h3>
                    <p style="color: var(--gray-600); margin-bottom: 15px;">How do your new opportunities stack up against existing investments?</p>
                    <div id="year2-comparison-view">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
                
                <div class="triage-summary" style="margin-top: 25px;">
                    <h3>🏷️ Triage Your New Projects</h3>
                    <p style="color: var(--gray-600); margin-bottom: 15px;">Categorize the Year 2 opportunities based on your evaluation</p>
                    <div class="triage-grid" id="year2-triage-grid">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
                
                <div class="button-row" style="margin-top: 25px;">
                    <button class="btn btn-primary" onclick="proceedToYear2PortfolioBuilder()">Build Year 2 Portfolio →</button>
                </div>
            </div>
        </div>
        
        <!-- YEAR 2 PORTFOLIO REVIEW MODAL (2x2 Matrix) -->
        <div class="modal-overlay hidden" id="year2-portfolio-review-modal">
            <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                <button class="modal-close" onclick="closeYear2PortfolioReview()">×</button>
                <h2 style="color: var(--primary); margin-bottom: 10px;">📊 Year 2 Portfolio Balance</h2>
                <p style="color: var(--gray-600); margin-bottom: 20px;">
                    Review your updated portfolio balance after adding new projects. Use the matrix views to assess strategic alignment before continuing.
                </p>
                
                <div style="display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap;">
                    <button class="matrix-toggle-btn active" onclick="switchYear2Matrix('risk-speed')" data-matrix="risk-speed">Speed vs Risk</button>
                    <button class="matrix-toggle-btn" onclick="switchYear2Matrix('market-tech')" data-matrix="market-tech">Market vs Tech</button>
                    <button class="matrix-toggle-btn" onclick="switchYear2Matrix('capability-strategic')" data-matrix="capability-strategic">Capability vs Strategy</button>
                    <button class="matrix-toggle-btn" onclick="switchYear2Matrix('roi-cost')" data-matrix="roi-cost">Return on Investment vs Cost</button>
                </div>
                
                <div class="matrix-container" id="year2-matrix-container" style="max-height: 400px;">
                    <!-- Matrix will be rendered here -->
                </div>
                
                <div class="matrix-legend" style="margin-top: 15px; display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;">
                    <div class="legend-item">
                        <div class="legend-bubble" style="background: #22c55e; border: 2px solid #166534;"></div>
                        <span>Completed (Success)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-bubble" style="background: #ef4444; border: 2px solid #b91c1c;"></div>
                        <span>Completed (Failed)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-bubble" style="background: #6b7280; border: 2px solid #374151;"></div>
                        <span>Killed</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-bubble" style="background: #3b82f6; border: 2px solid #1d4ed8;"></div>
                        <span>Active</span>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin: 20px 0; text-align: center;">
                    <div style="background: #dcfce7; padding: 12px; border-radius: 10px; border-left: 4px solid #22c55e;">
                        <div style="font-size: 1.5em; font-weight: 700; color: #166534;" id="y2-review-success">0</div>
                        <div style="font-size: 0.8em; color: var(--gray-500);">Successes</div>
                    </div>
                    <div style="background: #fee2e2; padding: 12px; border-radius: 10px; border-left: 4px solid #ef4444;">
                        <div style="font-size: 1.5em; font-weight: 700; color: #b91c1c;" id="y2-review-failed">0</div>
                        <div style="font-size: 0.8em; color: var(--gray-500);">Failures</div>
                    </div>
                    <div style="background: #f3f4f6; padding: 12px; border-radius: 10px; border-left: 4px solid #6b7280;">
                        <div style="font-size: 1.5em; font-weight: 700; color: #374151;" id="y2-review-killed">0</div>
                        <div style="font-size: 0.8em; color: var(--gray-500);">Killed</div>
                    </div>
                    <div style="background: #dbeafe; padding: 12px; border-radius: 10px; border-left: 4px solid #3b82f6;">
                        <div style="font-size: 1.5em; font-weight: 700; color: #1d4ed8;" id="y2-review-active">0</div>
                        <div style="font-size: 0.8em; color: var(--gray-500);">Active</div>
                    </div>
                </div>
                
                <div id="y2-review-insights" style="background: var(--gray-50); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                    <!-- Insights will be populated -->
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button class="btn btn-primary" onclick="closeYear2PortfolioReviewAndContinue()">Continue to Budget Review →</button>
                </div>
            </div>
        </div>
        
        <!-- PHASE: YEAR 2 PROJECT SELECTION -->
        <div id="phase-year2-selection" class="phase-content hidden">
            <div class="phase-indicator">
                <div class="phase-dot completed">1</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot completed">2</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot completed">3</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot active">4</div>
            </div>
            
            <div class="portfolio-builder-layout">
                <div class="portfolio-sidebar">
                    <div class="portfolio-budget-card">
                        <h3>Year 2 Budget</h3>
                        <div id="year2-budget-breakdown" style="font-size: 0.85em; margin-bottom: 10px; padding: 10px; background: var(--gray-50); border-radius: 8px;">
                            <!-- Populated by JavaScript -->
                        </div>
                        <div class="budget-meter">
                            <div class="budget-meter-fill" id="year2-budget-fill"></div>
                        </div>
                        <div class="budget-stats">
                            <span class="budget-spent" id="year2-budget-remaining">$0M</span>
                            <span class="budget-total" id="year2-budget-available">available for new</span>
                        </div>
                    </div>
                    
                    <div class="portfolio-buckets-card">
                        <h3>Portfolio Summary</h3>
                        <div id="year2-portfolio-summary" style="font-size: 0.9em;">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div class="portfolio-scores-card">
                        <h3>New Project Rankings</h3>
                        <div class="scores-scroll" id="year2-new-project-list" style="max-height: 200px; overflow-y: auto;">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div class="button-row" style="flex-direction: column; gap: 10px;">
                        <button class="btn btn-primary" id="confirm-year2-portfolio-btn" onclick="confirmYear2Portfolio()">Confirm Year 2 Portfolio →</button>
                        <button class="btn btn-secondary" onclick="showPhase('year2-committee-feedback')">← Back to Rankings</button>
                    </div>
                </div>
                
                <div class="portfolio-main">
                    <div class="matrix-header">
                        <h2>Year 2 Portfolio Builder</h2>
                        <p>Your <strong>ongoing projects</strong> (blue) continue from Year 1. <strong>Click on new project bubbles</strong> (green outline) to add them to your portfolio.</p>
                    </div>
                    
                    <div class="portfolio-view-tabs">
                        <button class="view-tab active" onclick="switchYear2PortfolioView('matrix')" data-view="matrix">
                            📊 Matrix View
                        </button>
                        <button class="view-tab" onclick="switchYear2PortfolioView('list')" data-view="list">
                            📋 List View
                        </button>
                    </div>
                    
                    <div id="year2-portfolio-matrix-view">
                        <div class="matrix-tabs">
                            <button class="matrix-tab active" onclick="switchYear2PortfolioMatrix('risk-speed')" data-matrix="risk-speed">
                                ⚡ Speed vs Risk
                            </button>
                            <button class="matrix-tab" onclick="switchYear2PortfolioMatrix('market-tech')" data-matrix="market-tech">
                                🚀 Market vs Tech
                            </button>
                        </div>
                        
                        <div class="matrix-container" id="year2-portfolio-matrix">
                            <!-- Matrix rendered by JavaScript -->
                        </div>
                        
                        <div class="matrix-legend">
                            <div class="legend-item">
                                <div class="legend-bubble" style="background: #3b82f6; border: 2px solid #1d4ed8;"></div>
                                <span>Ongoing (Year 1)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-bubble" style="background: #22c55e; border: 2px solid #166534;"></div>
                                <span>New (Selected)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-bubble" style="background: white; border: 2px dashed #22c55e;"></div>
                                <span>New (Available)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-bubble" style="background: #e5e7eb; border: 2px solid #9ca3af;"></div>
                                <span>Skipped</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="year2-portfolio-list-view" class="hidden">
                        <div class="portfolio-list-sections" id="year2-portfolio-list">
                            <!-- List rendered by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- COMMITTEE CHAOS OVERLAY (EMBEDDED) -->
        <div id="cc-overlay" class="cc-overlay">
            <iframe id="cc-iframe" class="cc-iframe"></iframe>
        </div>
        <!-- PHASE: PORTFOLIO BUILDER -->
        <div id="phase-portfolio-builder" class="phase-content hidden">
            <div class="phase-indicator">
                <div class="phase-dot completed">1</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot completed">2</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot active">3</div>
                <div class="phase-connector"></div>
                <div class="phase-dot">4</div>
            </div>
            
            <div class="portfolio-builder-layout">
                <div class="portfolio-sidebar">
                    <div class="portfolio-budget-card">
                        <h3>Portfolio Budget</h3>
                        <div class="budget-breakdown" id="budget-breakdown" style="font-size: 0.85em; margin-bottom: 10px; padding: 10px; background: var(--gray-50); border-radius: 8px;">
                            <!-- Populated by JavaScript -->
                        </div>
                        <div class="budget-meter">
                            <div class="budget-meter-fill" id="portfolio-budget-fill"></div>
                        </div>
                        <div class="budget-stats">
                            <span class="budget-spent" id="portfolio-budget-spent">$0M</span>
                            <span class="budget-total" id="portfolio-budget-total">/ $30M available</span>
                        </div>
                        <div class="projects-count-mini"><span id="portfolio-project-count">0</span> projects selected</div>
                    </div>
                    
                    <div class="portfolio-buckets-card">
                        <h3>Strategic Balance</h3>
                        <div id="portfolio-buckets-summary"></div>
                    </div>
                    
                    <div class="portfolio-scores-card">
                        <h3>Project Rankings</h3>
                        <div class="scores-scroll" id="portfolio-scores-list">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div class="button-row" style="flex-direction: column; gap: 10px;">
                        <button class="btn btn-primary" id="confirm-portfolio-btn" onclick="confirmPortfolio()" disabled>Confirm Portfolio →</button>
                        <button class="btn btn-secondary" onclick="showPhase('committee-feedback')">← Back to Triage</button>
                    </div>
                </div>
                
                <div class="portfolio-main">
                    <div class="matrix-header">
                        <h2>Fine-Tune Your Portfolio</h2>
                        <p>Your <strong>funded</strong> projects (green) are locked in. <strong>Click on marginal project bubbles</strong> (purple outline) to add or remove them from your portfolio. Stopped projects are greyed out.</p>
                        <div class="interaction-hint">
                            <span class="hint-icon">👆</span>
                            <span>Click any dashed-outline bubble to toggle it in/out of your portfolio</span>
                        </div>
                    </div>
                    
                    <div class="portfolio-view-tabs">
                        <button class="view-tab active" onclick="switchPortfolioView('matrix')" data-view="matrix">
                            📊 Matrix View
                        </button>
                        <button class="view-tab" onclick="switchPortfolioView('list')" data-view="list">
                            📋 List View
                        </button>
                    </div>
                    
                    <div id="portfolio-matrix-view">
                        <div class="matrix-tabs">
                            <button class="matrix-tab active" onclick="switchMatrix('risk-speed')" data-matrix="risk-speed">
                                ⚡ Speed vs Risk
                            </button>
                            <button class="matrix-tab" onclick="switchMatrix('market-tech')" data-matrix="market-tech">
                                🚀 Market vs Technology
                            </button>
                            <button class="matrix-tab" onclick="switchMatrix('capability-strategic')" data-matrix="capability-strategic">
                                🎯 Capability vs Strategy
                            </button>
                            <button class="matrix-tab" onclick="switchMatrix('roi-cost')" data-matrix="roi-cost">
                                💰 ROI vs Cost
                            </button>
                        </div>
                        
                        <div class="matrix-container" id="matrix-container">
                            <!-- Matrix will be rendered here -->
                        </div>
                        
                        <div class="matrix-legend">
                            <div class="legend-item">
                                <div class="legend-bubble funded"></div>
                                <span>Funded (locked)</span>
                            </div>
                            <div class="legend-item clickable-hint">
                                <div class="legend-bubble marginal-in"></div>
                                <span>Marginal (in portfolio) — click to remove</span>
                            </div>
                            <div class="legend-item clickable-hint">
                                <div class="legend-bubble marginal-out"></div>
                                <span>Marginal (available) — click to add</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-bubble stopped"></div>
                                <span>Stopped</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="portfolio-list-view" class="hidden">
                        <div class="portfolio-list-sections">
                            <div class="portfolio-list-section funded-section">
                                <h3>✅ Funded Projects</h3>
                                <div id="portfolio-funded-list"></div>
                            </div>
                            <div class="portfolio-list-section marginal-section">
                                <h3>⚖️ Marginal Projects <span class="section-hint">— click to toggle</span></h3>
                                <div id="portfolio-marginal-list"></div>
                            </div>
                            <div class="portfolio-list-section stopped-section">
                                <h3>🚫 Stopped Projects</h3>
                                <div id="portfolio-stopped-list"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- PHASE: SELECTION -->
        <div id="phase-selection" class="phase-content hidden">
            <div class="phase-indicator">
                <div class="phase-dot completed">1</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot active">2</div>
                <div class="phase-connector"></div>
                <div class="phase-dot">3</div>
                <div class="phase-connector"></div>
                <div class="phase-dot">4</div>
            </div>
            
            <div class="card">
                <h2>Select Your R&D Portfolio</h2>
                <p>Projects are ranked by committee score. With limited budget, you'll need to make choices. Some projects are safer bets with predictable returns; others are more ambitious with higher uncertainty but greater potential. Consider both strategic priority coverage and your overall risk profile as you select.</p>
                
                <div class="budget-bar">
                    <div class="budget-display">
                        Budget: <span class="amount" id="budget-remaining">$30M</span> <span class="total">/ $30M available</span>
                    </div>
                    <div class="projects-count"><span id="projects-selected">0</span> projects selected</div>
                </div>
                
                <div class="strategic-balance" id="strategic-balance" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; padding: 15px; background: var(--gray-50); border-radius: 10px;">
                    <!-- Strategic bucket balance will be rendered here -->
                </div>
                
                <div class="project-grid" id="project-grid"></div>
                
                <div class="button-row">
                    <button class="btn btn-secondary" onclick="showPhase('design-criteria')">← Redesign Process</button>
                    <button class="btn btn-primary" id="start-reviews-btn" onclick="startQuarterlyReviews()" disabled>Start Year with Selected Projects →</button>
                </div>
            </div>
        </div>
        
        <!-- PROJECT DETAIL MODAL -->
        <div class="modal-overlay hidden" id="project-modal">
            <div class="modal-content" style="max-width: 700px;">
                <button class="modal-close" onclick="closeProjectModal()">×</button>
                
                <div class="project-modal-header">
                    <div>
                        <h2 id="project-modal-name" style="color: var(--primary); margin-bottom: 5px;"></h2>
                        <p id="project-modal-tagline" style="color: var(--gray-500); font-style: italic; margin: 0;"></p>
                        <div id="project-modal-buckets" style="margin-top: 10px;"></div>
                    </div>
                    <div class="project-modal-budget">
                        <span id="project-modal-budget" style="font-size: 1.5em; font-weight: 700; color: var(--gold-dark);"></span>
                        <span style="color: var(--gray-500); font-size: 0.85em;">Development Cost</span>
                    </div>
                </div>
                
                <div class="modal-section">
                    <h3>Project Overview</h3>
                    <p id="project-modal-desc"></p>
                </div>
                
                <div class="modal-section">
                    <h3>Market Context</h3>
                    <p id="project-modal-market"></p>
                </div>
                
                <div class="modal-section">
                    <h3>Capability Fit</h3>
                    <p id="project-modal-capability"></p>
                </div>
                
                <div class="modal-section">
                    <h3>Financial Projections</h3>
                    <div class="project-financials" id="project-modal-financials"></div>
                </div>
                
                <div class="modal-section">
                    <h3>Development Cost Breakdown</h3>
                    <div id="project-modal-dev-costs"></div>
                </div>
                
                <div class="modal-section">
                    <h3>Development Milestones & Success Metrics</h3>
                    <div id="project-modal-milestones"></div>
                </div>
                
                <div class="modal-section">
                    <h3>Technology Readiness Level (TRL)</h3>
                    <div id="project-modal-trl"></div>
                </div>
                
                <div class="modal-section">
                    <h3>Intellectual Property Position</h3>
                    <div id="project-modal-ip"></div>
                </div>
                
                <div class="modal-section">
                    <h3>Key Competitors</h3>
                    <div id="project-modal-competitors"></div>
                </div>
                
                <div class="modal-section">
                    <h3>Portfolio Synergies</h3>
                    <div id="project-modal-synergies"></div>
                </div>
                
                <div class="modal-section">
                    <h3>Team Assessment</h3>
                    <p id="project-modal-team" style="font-style: italic; color: var(--gray-600);"></p>
                    <div id="project-modal-team-details" style="margin-top: 15px;"></div>
                </div>
                
                <div class="modal-triage-actions hidden" id="modal-triage-actions">
                    <h3>Your Decision</h3>
                    <div class="modal-triage-buttons">
                        <button class="triage-btn fund-btn" id="modal-fund-btn" onclick="setTriageFromModal('fund')">✅ Fund</button>
                        <button class="triage-btn marginal-btn" id="modal-marginal-btn" onclick="setTriageFromModal('marginal')">⚖️ Marginal</button>
                        <button class="triage-btn stop-btn" id="modal-stop-btn" onclick="setTriageFromModal('stop')">🚫 Stop</button>
                    </div>
                </div>
                
                <button class="add-to-committee-btn" id="project-modal-btn" onclick="toggleProjectFromModal()">Add to Portfolio</button>
            </div>
        </div>
        
        <!-- LEGACY PROJECT MODAL -->
        <div class="modal-overlay hidden" id="legacy-project-modal">
            <div class="modal-content" style="max-width: 750px;">
                <button class="modal-close" onclick="closeLegacyModal()">×</button>
                
                <div class="project-modal-header">
                    <div>
                        <h2 id="legacy-modal-name" style="color: var(--primary); margin-bottom: 5px;"></h2>
                        <div style="display: flex; gap: 10px; align-items: center; margin-top: 8px;">
                            <span class="legacy-badge inherited">Inherited Project</span>
                            <span id="legacy-modal-status" class="legacy-status-badge"></span>
                        </div>
                    </div>
                    <div class="project-modal-budget" style="text-align: right;">
                        <div style="font-size: 1.4em; font-weight: 700; color: var(--primary);" id="legacy-modal-progress"></div>
                        <span style="color: var(--gray-500); font-size: 0.85em;">Complete</span>
                    </div>
                </div>
                
                <div class="modal-section">
                    <h3>📋 Project Overview</h3>
                    <p id="legacy-modal-desc"></p>
                </div>
                
                <div class="modal-section">
                    <h3>🎯 Strategic Alignment</h3>
                    <div id="legacy-modal-alignment"></div>
                </div>
                
                <div class="modal-section">
                    <h3>💰 Budget Status</h3>
                    <div id="legacy-modal-budget"></div>
                </div>
                
                <div class="modal-section">
                    <h3>🤝 External Commitments</h3>
                    <p id="legacy-modal-commitments" style="color: var(--gray-600);"></p>
                </div>
                
                <div class="modal-section">
                    <h3>🏢 Political Context</h3>
                    <p id="legacy-modal-politics" style="color: var(--gray-600);"></p>
                </div>
                
                <div class="modal-section">
                    <h3>👤 Project Lead</h3>
                    <div id="legacy-modal-lead"></div>
                </div>
                
                <div class="modal-section">
                    <h3>📊 Project History</h3>
                    <div id="legacy-modal-history"></div>
                </div>
                
                <div class="modal-section">
                    <h3>⚠️ Risk Assessment</h3>
                    <div id="legacy-modal-risks"></div>
                </div>
                
                <div class="modal-section" style="background: var(--gray-50); padding: 20px; border-radius: 12px; margin-top: 20px;">
                    <h3 style="margin-top: 0;">🎮 Your Decision</h3>
                    <div class="legacy-decision-options" id="legacy-modal-decisions"></div>
                    <div id="legacy-modal-impact" style="margin-top: 15px;"></div>
                </div>
            </div>
        </div>
        
        <!-- CORPORATE EVENT MODAL -->
        <div class="event-modal-overlay hidden" id="corporate-event-modal">
            <div class="event-modal">
                <div class="event-modal-header" id="event-modal-header">
                    <span class="event-icon" id="event-icon">📰</span>
                    <span class="event-category" id="event-category">Market News</span>
                    <h2 class="event-title" id="event-title">Event Title</h2>
                </div>
                <div class="event-modal-body">
                    <p class="event-description" id="event-description">
                        Event description goes here...
                    </p>
                    <div class="event-effect-box">
                        <div class="event-effect-label">Impact on Your Portfolio</div>
                        <div class="event-effect-text" id="event-effect">
                            Effect description
                        </div>
                    </div>
                    <div class="event-duration" id="event-duration">
                        <span class="event-duration-icon">⏱️</span>
                        <span>Effect lasts this quarter</span>
                    </div>
                    <button class="event-acknowledge-btn" id="event-acknowledge-btn" onclick="acknowledgeEvent()">
                        Understood, Continue →
                    </button>
                </div>
            </div>
        </div>
        
        <!-- PROJECT LEAD CV MODAL -->
        <div class="lead-modal-overlay hidden" id="lead-cv-modal" onclick="closeLeadModal()">
            <div class="lead-modal" onclick="event.stopPropagation()">
                <button class="lead-modal-close" onclick="closeLeadModal()">×</button>
                <div class="lead-modal-header" id="lead-modal-header">
                    <div class="lead-modal-avatar" id="lead-modal-avatar">VS</div>
                    <div class="lead-modal-title">
                        <h2 id="lead-modal-name">Lead Name</h2>
                        <p id="lead-modal-role">Role · Team</p>
                    </div>
                    <div class="lead-modal-score" id="lead-modal-score">
                        <div class="score-value">85%</div>
                        <div class="score-label">Track Record</div>
                    </div>
                </div>
                <div class="lead-modal-body" id="lead-modal-body">
                    <!-- Lead CV content will be populated dynamically -->
                </div>
            </div>
        </div>
        
        <!-- CREDITS MODAL -->
        <div class="credits-modal-overlay hidden" id="credits-modal" onclick="closeCreditsModal()">
            <div class="credits-modal" onclick="event.stopPropagation()">
                <div class="credits-modal-header">
                    <h2>Build, Bin, Boost</h2>
                    <p>The R&D Portfolio Simulation — An interactive business simulation for innovation management education</p>
                </div>
                
                <div class="credits-modal-body">
                    <div class="credits-section">
                        <h3>👨‍💻 Created By</h3>
                        <div class="credits-person">
                            <div class="credits-avatar">AS</div>
                            <div class="credits-person-info">
                                <div class="credits-person-name">Ammon Salter</div>
                                <div class="credits-person-role">Warwick Business School</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="credits-section">
                        <h3>🤝 Contributors</h3>
                        <div class="credits-person">
                            <div class="credits-avatar" style="background: #7c3aed20; color: #7c3aed;">FB</div>
                            <div class="credits-person-info">
                                <div class="credits-person-name">Federico Bignone</div>
                                <div class="credits-person-role">Contributor</div>
                            </div>
                        </div>
                        <div class="credits-person" style="margin-top: 12px;">
                            <div class="credits-avatar" style="background: #2563eb20; color: #2563eb;">PC</div>
                            <div class="credits-person-info">
                                <div class="credits-person-name">Paola Criscuolo</div>
                                <div class="credits-person-role">Contributor</div>
                            </div>
                        </div>
                        <div class="credits-person" style="margin-top: 12px;">
                            <div class="credits-avatar" style="background: #0891b220; color: #0891b2;">CK</div>
                            <div class="credits-person-info">
                                <div class="credits-person-name">Christos Kolympiris</div>
                                <div class="credits-person-role">Contributor</div>
                            </div>
                        </div>
                        <div class="credits-person" style="margin-top: 12px;">
                            <div class="credits-avatar" style="background: #05966920; color: #059669;">OM</div>
                            <div class="credits-person-info">
                                <div class="credits-person-name">Orietta Marsili</div>
                                <div class="credits-person-role">Contributor</div>
                            </div>
                        </div>
                        <div class="credits-person" style="margin-top: 12px;">
                            <div class="credits-avatar" style="background: #dc262620; color: #dc2626;">RS</div>
                            <div class="credits-person-info">
                                <div class="credits-person-name">Rossella Salandra</div>
                                <div class="credits-person-role">Contributor</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="credits-section">
                        <h3>🤖 Development Assistance</h3>
                        <div class="credits-person">
                            <div class="credits-avatar" style="background: #d4a27420; color: #d4a274;">AI</div>
                            <div class="credits-person-info">
                                <div class="credits-person-name">Claude</div>
                                <div class="credits-person-role">AI Assistant by Anthropic</div>
                            </div>
                        </div>
                        <div class="credits-person" style="margin-top: 12px;">
                            <div class="credits-avatar" style="background: #10a37f20; color: #10a37f;">AI</div>
                            <div class="credits-person-info">
                                <div class="credits-person-name">GPT-5</div>
                                <div class="credits-person-role">Project ideas contribution by OpenAI</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="credits-section">
                        <h3>📄 License</h3>
                        <div class="license-box">
                            <h4>
                                <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">
                                    <img src="https://licensebuttons.net/l/by-nc-sa/4.0/88x31.png" alt="CC BY-NC-SA 4.0" style="height: 31px;">
                                </a>
                                CC BY-NC-SA 4.0
                            </h4>
                            <div class="license-terms">
                                <p>This work is licensed under the <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.</p>
                                
                                <p><strong>You are free to:</strong></p>
                                <ul>
                                    <li><strong>Share</strong> — copy and redistribute the material in any medium or format</li>
                                    <li><strong>Adapt</strong> — remix, transform, and build upon the material</li>
                                </ul>
                                
                                <p><strong>Under the following terms:</strong></p>
                                <ul>
                                    <li><strong>Attribution</strong> — You must give appropriate credit, provide a link to the license, and indicate if changes were made</li>
                                    <li><strong>NonCommercial</strong> — You may not use the material for commercial purposes</li>
                                    <li><strong>ShareAlike</strong> — If you remix, transform, or build upon the material, you must distribute your contributions under the same license</li>
                                </ul>
                            </div>
                            
                            <div class="warranty-notice">
                                <strong>⚠️ Disclaimer:</strong> This simulation is provided "as is" without warranty of any kind, express or implied. The creators are not liable for any outcomes resulting from its use. This is an educational tool and should not be used as the sole basis for real business decisions.
                            </div>
                        </div>
                    </div>
                    
                    <div class="credits-section">
                        <h3>📚 Citation</h3>
                        <div class="license-box" style="background: var(--primary-lighter);">
                            <p style="font-size: 0.9em; color: var(--gray-700); margin: 0; font-family: monospace;">
                                Salter, A. (2025). Build, Bin, Boost: The R&D Portfolio Simulation. Warwick Business School.
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="credits-modal-footer">
                    <p style="font-size: 0.8em; color: var(--gray-500); margin: 0 0 12px;">© 2025 Ammon Salter. All rights reserved under the terms of CC BY-NC-SA 4.0.</p>
                    <button class="credits-close-btn" onclick="closeCreditsModal()">Close</button>
                </div>
            </div>
        </div>
        
        <!-- TUTORIAL MODAL -->
        <div class="credits-modal-overlay hidden" id="tutorial-modal" onclick="closeTutorialModal()">
            <div class="credits-modal" onclick="event.stopPropagation()" style="max-width: 750px;">
                <div class="credits-modal-header" style="background: linear-gradient(135deg, var(--primary) 0%, #3d1f42 100%);">
                    <h2>📖 How to Play</h2>
                    <p>A guide to Build, Bin, Boost</p>
                </div>
                
                <div class="credits-modal-body" style="max-height: 65vh; overflow-y: auto;">
                    <div class="credits-section">
                        <h3>🎯 Your Mission</h3>
                        <p style="color: var(--gray-600); line-height: 1.6;">
                            You've been appointed Head of R&D at ShieldTech India, a home security company. Your predecessor was fired after years of poor results. The board wants you to transform how the company selects and manages innovation projects—and deliver on four strategic priorities.
                        </p>
                    </div>
                    
                    <div class="credits-section">
                        <h3>🎯 Strategic Priorities</h3>
                        <p style="color: var(--gray-600); line-height: 1.6; margin-bottom: 12px;">
                            The board has set four priorities for the next 3-5 years. Your portfolio should align with these goals:
                        </p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div style="background: #2563eb15; padding: 10px 12px; border-radius: 8px; border-left: 3px solid #2563eb;">
                                <strong style="color: #2563eb;">🛡️ Defend Metro Leadership</strong>
                                <p style="margin: 4px 0 0; font-size: 0.85em; color: var(--gray-600);">Retain #1 position in top 8 cities</p>
                            </div>
                            <div style="background: #05966915; padding: 10px 12px; border-radius: 8px; border-left: 3px solid #059669;">
                                <strong style="color: #059669;">🗺️ Tier 2/3 Rollout</strong>
                                <p style="margin: 4px 0 0; font-size: 0.85em; color: var(--gray-600);">Profitable entry into 50 emerging cities</p>
                            </div>
                            <div style="background: #7c3aed15; padding: 10px 12px; border-radius: 8px; border-left: 3px solid #7c3aed;">
                                <strong style="color: #7c3aed;">💳 Recurring Revenue</strong>
                                <p style="margin: 4px 0 0; font-size: 0.85em; color: var(--gray-600);">Shift to services and subscriptions</p>
                            </div>
                            <div style="background: #dc262615; padding: 10px 12px; border-radius: 8px; border-left: 3px solid #dc2626;">
                                <strong style="color: #dc2626;">🤖 AI-First Products</strong>
                                <p style="margin: 4px 0 0; font-size: 0.85em; color: var(--gray-600);">Lead the transition to intelligent security</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="credits-section">
                        <h3>📋 Game Flow</h3>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <div style="display: flex; gap: 12px; align-items: flex-start;">
                                <div style="background: var(--primary); color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0;">1</div>
                                <div>
                                    <strong style="color: var(--gray-800);">Design Your Process</strong>
                                    <p style="margin: 4px 0 0; color: var(--gray-600); font-size: 0.9em;">Assemble a selection committee from ShieldTech's leadership. Each person brings different expertise and biases. Choose evaluation criteria to guide decisions.</p>
                                </div>
                            </div>
                            <div style="display: flex; gap: 12px; align-items: flex-start;">
                                <div style="background: var(--primary); color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0;">2</div>
                                <div>
                                    <strong style="color: var(--gray-800);">Handle Legacy Projects</strong>
                                    <p style="margin: 4px 0 0; color: var(--gray-600); font-size: 0.9em;">Your predecessor left behind ongoing projects of varying types. Review each and decide: continue, pause, or kill? Past spending is sunk—but consider each project's nature when deciding how to proceed.</p>
                                </div>
                            </div>
                            <div style="display: flex; gap: 12px; align-items: flex-start;">
                                <div style="background: var(--primary); color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0;">3</div>
                                <div>
                                    <strong style="color: var(--gray-800);">Secure Your Budget</strong>
                                    <p style="margin: 4px 0 0; color: var(--gray-600); font-size: 0.9em;">Chair a budget committee meeting (mini-game). Your facilitation skills determine whether you get $34-44M for new projects.</p>
                                </div>
                            </div>
                            <div style="display: flex; gap: 12px; align-items: flex-start;">
                                <div style="background: var(--primary); color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0;">4</div>
                                <div>
                                    <strong style="color: var(--gray-800);">Build Your Portfolio</strong>
                                    <p style="margin: 4px 0 0; color: var(--gray-600); font-size: 0.9em;">Evaluate 10-12 proposals with your committee. Projects vary in risk profile—some are safer bets, others are more ambitious. Consider your mix across strategic priorities and risk levels.</p>
                                </div>
                            </div>
                            <div style="display: flex; gap: 12px; align-items: flex-start;">
                                <div style="background: var(--primary); color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0;">5</div>
                                <div>
                                    <strong style="color: var(--gray-800);">Manage Through Time</strong>
                                    <p style="margin: 4px 0 0; color: var(--gray-600); font-size: 0.9em;">Run the portfolio for 8 quarters (2 years). Each quarter you'll review progress, respond to dilemmas, and decide whether to continue, accelerate, reduce, or kill each project. Active management matters.</p>
                                </div>
                            </div>
                            <div style="display: flex; gap: 12px; align-items: flex-start;">
                                <div style="background: var(--primary); color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0;">6</div>
                                <div>
                                    <strong style="color: var(--gray-800);">Add New Projects</strong>
                                    <p style="margin: 4px 0 0; color: var(--gray-600); font-size: 0.9em;">At the end of Year 1, new opportunities emerge. Evaluate fresh proposals and add to your portfolio for Year 2—or stay focused on existing commitments.</p>
                                </div>
                            </div>
                            <div style="display: flex; gap: 12px; align-items: flex-start;">
                                <div style="background: var(--primary); color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0;">7</div>
                                <div>
                                    <strong style="color: var(--gray-800);">See the Results</strong>
                                    <p style="margin: 4px 0 0; color: var(--gray-600); font-size: 0.9em;">Discover which projects truly succeeded. The board evaluates not just your hit rate and ROI, but how you built and managed the portfolio. Were your decisions well-timed? Was your approach too cautious—or too reckless?</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="credits-section">
                        <h3>💡 Things to Consider</h3>
                        <ul style="color: var(--gray-600); line-height: 1.8; padding-left: 20px;">
                            <li><strong>Read the details:</strong> Click on projects and staff to see full profiles. The information matters.</li>
                            <li><strong>Think about risk balance:</strong> Some projects are safer bets with predictable returns; others are ambitious with higher uncertainty. What's the right mix for your portfolio?</li>
                            <li><strong>Committee composition matters:</strong> Different people spot different things. Consider what perspectives you need.</li>
                            <li><strong>Portfolio tending:</strong> Projects need ongoing attention. When should you persist with a struggling project? When should you cut your losses? Does project type matter?</li>
                            <li><strong>Watch for signals:</strong> Project updates contain information about how things are really going. What do the signals tell you?</li>
                            <li><strong>Strategic coverage:</strong> The board set four strategic priorities. How much does alignment matter? Is concentration a risk?</li>
                            <li><strong>Make active decisions:</strong> R&D dilemmas and quarterly reviews give you choices. Passive management is a choice too—but is it the right one?</li>
                            <li><strong>Timing matters:</strong> The right decision at the wrong time can still be costly. Consider whether different project types need different amounts of patience.</li>
                        </ul>
                    </div>
                    
                    <div class="credits-section">
                        <h3>📊 How You're Evaluated</h3>
                        <p style="color: var(--gray-600); line-height: 1.6; margin-bottom: 12px;">
                            The board evaluates you across multiple dimensions:
                        </p>
                        <ul style="color: var(--gray-600); line-height: 1.8; padding-left: 20px; margin-bottom: 12px;">
                            <li><strong>Selection accuracy:</strong> Did you fund winners and reject losers?</li>
                            <li><strong>Portfolio returns:</strong> What ROI did your investments generate?</li>
                            <li><strong>Risk balance:</strong> How did you balance safe bets against ambitious projects?</li>
                            <li><strong>Strategic alignment:</strong> Did you cover the board's priorities? Was your portfolio too concentrated?</li>
                            <li><strong>Portfolio management:</strong> How well did you tend the portfolio over time? Were your kill decisions well-timed?</li>
                            <li><strong>Active leadership:</strong> Did you make decisions, or let the portfolio run itself?</li>
                        </ul>
                        <p style="color: var(--gray-600); line-height: 1.6;">
                            The board delivers their verdict—ranging from promotion to CTO down to being asked to leave. Different paths can lead to success: there's more than one way to impress the board.
                        </p>
                    </div>
                    
                    <div class="credits-section">
                        <h3>🎓 Learning Objectives</h3>
                        <p style="color: var(--gray-600); line-height: 1.6;">
                            This simulation teaches R&D portfolio management: balancing risk and reward across different project types, strategic portfolio composition, active portfolio tending (knowing when to persist vs. cut), stage-gate decisions, and the challenge of predicting innovation outcomes under uncertainty.
                        </p>
                    </div>
                </div>
                
                <div class="credits-modal-footer">
                    <button class="credits-close-btn" onclick="closeTutorialModal()">Got It — Let's Play</button>
                </div>
            </div>
        </div>
        
        <!-- PHASE: REVIEWS -->
        <div id="phase-reviews" class="phase-content hidden">
            <div class="phase-indicator">
                <div class="phase-dot completed">1</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot completed">2</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot active">3</div>
                <div class="phase-connector"></div>
                <div class="phase-dot">4</div>
            </div>
            
            <div class="quarter-header">
                <h2 id="quarter-title">Q1 Review</h2>
                <p id="quarter-subtitle">Review progress and decide how to manage each project</p>
            </div>
            
            <div class="budget-bar" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                <div class="portfolio-summary" id="portfolio-summary"></div>
                <button class="cockpit-toggle-btn" onclick="showCockpitView()">
                    🎛️ Back to Cockpit
                </button>
            </div>
            
            <div id="commercialisation-events"></div>
            <div id="review-cards"></div>
            
            <div class="button-row">
                <button class="btn btn-primary" id="next-quarter-btn" onclick="nextQuarter()">Submit Decisions & Continue →</button>
            </div>
        </div>
        
        <!-- PHASE: PROJECT COCKPIT -->
        <div id="phase-cockpit" class="phase-content hidden">
            <div class="phase-indicator">
                <div class="phase-dot completed">1</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot completed">2</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot active">3</div>
                <div class="phase-connector"></div>
                <div class="phase-dot">4</div>
            </div>
            
            <!-- Cockpit Header -->
            <div class="cockpit-header" id="cockpit-header">
                <!-- Rendered by JavaScript -->
            </div>
            
            <!-- Portfolio Grid Section -->
            <div class="card" style="padding: 20px;">
                <div class="cockpit-section-header">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <button class="cockpit-back-btn" onclick="showPhase('reviews')">
                            📊 Tile View
                        </button>
                        <h3 style="margin: 0;">Active Projects</h3>
                    </div>
                    <div class="cockpit-legend">
                        <span><span class="legend-dot green"></span> On Track</span>
                        <span><span class="legend-dot amber"></span> At Risk</span>
                        <span><span class="legend-dot red"></span> Critical</span>
                    </div>
                </div>
                
                <div class="cockpit-grid" id="cockpit-grid">
                    <!-- Project tiles rendered by JavaScript -->
                </div>
                
                <div class="button-row" style="margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="showPhase('reviews')">📊 Tile View</button>
                    <button class="btn btn-primary" id="cockpit-next-btn" onclick="nextQuarter()">Submit Decisions & Continue →</button>
                </div>
            </div>
            
            <!-- Cockpit Detail Panel -->
            <div class="cockpit-panel-overlay" id="cockpit-overlay" onclick="closeCockpitPanel()"></div>
            <div class="cockpit-detail-panel" id="cockpit-panel">
                <div class="panel-header">
                    <div class="panel-header-content">
                        <h3 id="cockpit-panel-name"></h3>
                        <p class="tagline" id="cockpit-panel-tagline"></p>
                    </div>
                    <span class="panel-rag-badge" id="cockpit-panel-badge"></span>
                    <button class="panel-close" onclick="closeCockpitPanel()">×</button>
                </div>
                
                <div class="panel-body" id="cockpit-panel-body">
                    <!-- Content rendered by JavaScript -->
                </div>
                
                <div class="cockpit-actions-section">
                    <div class="cockpit-actions-header">
                        <h4>Your Decision</h4>
                        <span class="cockpit-actions-hint">Select to see implications</span>
                    </div>
                    <div class="cockpit-action-grid">
                        <button class="cockpit-action-btn continue" onclick="selectCockpitAction('continue')">
                            <span class="action-icon">▶️</span>
                            <span class="action-label">Continue</span>
                        </button>
                        <button class="cockpit-action-btn accelerate" onclick="selectCockpitAction('accelerate')">
                            <span class="action-icon">⚡</span>
                            <span class="action-label">Accelerate</span>
                        </button>
                        <button class="cockpit-action-btn reduce" onclick="selectCockpitAction('reduce')">
                            <span class="action-icon">🔻</span>
                            <span class="action-label">Reduce</span>
                        </button>
                        <button class="cockpit-action-btn champion" onclick="selectCockpitAction('champion')">
                            <span class="action-icon">📢</span>
                            <span class="action-label">Champion</span>
                        </button>
                        <button class="cockpit-action-btn kill" onclick="selectCockpitAction('kill')">
                            <span class="action-icon">🛑</span>
                            <span class="action-label">Stop</span>
                        </button>
                    </div>
                    <div class="cockpit-implications" id="cockpit-implications">
                        <span class="implications-placeholder" id="cockpit-implications-placeholder">↑ Select an action to see trade-offs</span>
                        <div class="implications-content" id="cockpit-implications-content"></div>
                    </div>
                    <button class="cockpit-confirm-btn" id="cockpit-confirm-btn" disabled onclick="confirmCockpitDecision()">
                        Select an action to continue
                    </button>
                </div>
            </div>
        </div>
        
        <!-- PHASE: RESULTS -->
        <div id="phase-results" class="phase-content hidden">
            <div class="phase-indicator">
                <div class="phase-dot completed">1</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot completed">2</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot completed">3</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot active">4</div>
            </div>
            
            <div class="card">
                <!-- CAREER OUTCOME BANNER -->
                <div id="career-outcome-banner" style="text-align: center; padding: 30px 20px; margin: -20px -20px 25px; border-radius: 12px 12px 0 0; background: linear-gradient(135deg, var(--primary) 0%, var(--gold-dark) 100%);">
                    <div id="career-outcome-icon" style="font-size: 4em; margin-bottom: 10px;">🏆</div>
                    <h2 id="career-outcome-title" style="color: white; margin: 0 0 10px; font-size: 1.8em;">Your Career Outcome</h2>
                    <p id="career-outcome-subtitle" style="color: rgba(255,255,255,0.9); margin: 0; font-size: 1.1em; max-width: 600px; margin: 0 auto;">Loading...</p>
                </div>
                
                <!-- NARRATIVE SUMMARY -->
                <div id="career-narrative" style="background: var(--gray-50); border-radius: 12px; padding: 20px; margin-bottom: 25px; border-left: 4px solid var(--primary);">
                    <p id="career-narrative-text" style="line-height: 1.7; margin: 0; color: var(--gray-700); font-size: 1.05em;"></p>
                </div>
                
                <!-- KEY PERFORMANCE INDICATORS -->
                <div style="margin-bottom: 25px;">
                    <h3 style="color: var(--primary); margin-bottom: 15px; font-size: 1.1em;">📊 Your R&D Leadership Scorecard</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div style="background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 2em; font-weight: 800; color: #166534;" id="tp-count">0</div>
                            <div style="font-size: 0.85em; color: #166534; font-weight: 600;">Successful Projects</div>
                            <div style="font-size: 0.75em; color: #15803d; margin-top: 4px;">Funded & Delivered Value</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 2em; font-weight: 800; color: #b91c1c;" id="fp-count">0</div>
                            <div style="font-size: 0.85em; color: #b91c1c; font-weight: 600;">Failed Bets</div>
                            <div style="font-size: 0.75em; color: #dc2626; margin-top: 4px;">Funded but Disappointed</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 2em; font-weight: 800; color: #92400e;" id="fn-count">0</div>
                            <div style="font-size: 0.85em; color: #92400e; font-weight: 600;">Missed Opportunities</div>
                            <div style="font-size: 0.75em; color: #a16207; margin-top: 4px;">Would Have Succeeded</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 2em; font-weight: 800; color: #1e40af;" id="tn-count">0</div>
                            <div style="font-size: 0.85em; color: #1e40af; font-weight: 600;">Good Rejections</div>
                            <div style="font-size: 0.75em; color: #2563eb; margin-top: 4px;">Correctly Avoided</div>
                        </div>
                    </div>
                </div>
                
                <!-- PORTFOLIO METRICS -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 25px;">
                    <div style="text-align: center; padding: 15px; background: var(--gray-50); border-radius: 10px;">
                        <div style="font-size: 1.6em; font-weight: 700; color: var(--primary);" id="hit-rate">0%</div>
                        <div style="font-size: 0.8em; color: var(--gray-500);">Hit Rate</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: var(--gray-50); border-radius: 10px;">
                        <div style="font-size: 1.6em; font-weight: 700; color: var(--success);" id="roi-value">0%</div>
                        <div style="font-size: 0.8em; color: var(--gray-500);">Portfolio ROI</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: var(--gray-50); border-radius: 10px;">
                        <div style="font-size: 1.6em; font-weight: 700; color: var(--danger);" id="waste-value">$0</div>
                        <div style="font-size: 0.8em; color: var(--gray-500);">Wasted R&D</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: var(--gray-50); border-radius: 10px;">
                        <div style="font-size: 1.6em; font-weight: 700; color: var(--warning);" id="missed-value">$0</div>
                        <div style="font-size: 0.8em; color: var(--gray-500);">Missed Value</div>
                    </div>
                </div>
                
                <!-- PROCESS FEEDBACK -->
                <div style="background: white; border: 2px solid var(--gray-200); border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                    <h3 style="color: var(--primary); margin: 0 0 15px; font-size: 1.1em;">💡 What Your Leadership Style Revealed</h3>
                    <div id="process-insights"></div>
                </div>
                
                <!-- COUNTERFACTUALS -->
                <div id="killed-reveal" style="background: #fffbeb; border: 2px solid #fcd34d; border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                    <h4 style="color: #92400e; margin: 0 0 15px;">🔮 The Road Not Taken</h4>
                    <div id="counterfactuals"></div>
                </div>
                
                <!-- BOARD FEEDBACK -->
                <div id="board-feedback-section" style="background: linear-gradient(135deg, var(--primary) 0%, #3d1f42 100%); border-radius: 12px; padding: 25px; margin-bottom: 25px; color: white;">
                    <h3 style="margin: 0 0 15px; color: var(--gold);">📋 Board of Directors Feedback</h3>
                    <div id="board-feedback" style="line-height: 1.7;"></div>
                </div>
                
                <div class="button-row" style="flex-wrap: wrap; gap: 15px;">
                    <button class="btn btn-primary" onclick="restartGame()">🔄 Play Again with Different Process</button>
                    <button class="btn btn-secondary" onclick="showReferencesModal()">📚 Additional References</button>
                </div>
                
                <div style="margin-top: 30px; padding-top: 25px; border-top: 1px solid var(--gray-200); text-align: center;">
                    <p style="margin: 0 0 12px; color: var(--gray-600);">Created by Ammon Salter, Warwick Business School</p>
                    <button class="credits-btn" onclick="openCreditsModal()">📄 Full Credits & License</button>
                </div>
            </div>
        </div>
        
        <!-- STAFF PROFILE MODAL -->
        <div class="modal-overlay hidden" id="staff-modal">
            <div class="modal-content">
                <button class="modal-close" onclick="closeModal()">×</button>
                <div class="modal-header">
                    <img class="modal-avatar" id="modal-avatar" src="" alt="">
                    <div class="modal-title">
                        <h2 id="modal-name"></h2>
                        <div class="role" id="modal-role"></div>
                    </div>
                </div>
                
                <div class="modal-section">
                    <h3>Background</h3>
                    <p id="modal-bio"></p>
                </div>
                
                <div class="modal-section">
                    <h3>Career History</h3>
                    <div id="modal-cv"></div>
                </div>
                
                <div class="modal-section">
                    <h3>Decision-Making Style</h3>
                    <p id="modal-style"></p>
                </div>
                
                <div class="modal-section">
                    <h3>Known For</h3>
                    <div class="modal-traits" id="modal-traits"></div>
                </div>
                
                <button class="add-to-committee-btn" id="modal-add-btn" onclick="addFromModal()">Add to Committee</button>
            </div>
        </div>
        
        <!-- REFERENCES MODAL -->
        <div class="modal-overlay hidden" id="references-modal">
            <div class="modal-content" style="max-width: 800px; max-height: 85vh; overflow-y: auto;">
                <button class="modal-close" onclick="closeReferencesModal()">×</button>
                <h2 style="color: var(--primary); margin-bottom: 10px;">📚 Additional References</h2>
                <p style="color: var(--gray-600); margin-bottom: 20px;">
                    Academic research on R&D portfolio management, project selection, and innovation decision-making.
                </p>
                
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div style="background: var(--gray-50); padding: 15px; border-radius: 10px; border-left: 3px solid var(--primary);">
                        <p style="margin: 0; font-size: 0.95em; line-height: 1.6;">Brasil, V.C. and Eggers, J.P., 2019. Product and innovation portfolio management. In <em>Oxford Research Encyclopedia of Business and Management</em>. <a href="https://doi.org/10.1093/acrefore/9780190224851.013.28" target="_blank" style="color: var(--primary);">DOI: 10.1093/acrefore/9780190224851.013.28</a></p>
                    </div>
                    
                    <div style="background: var(--gray-50); padding: 15px; border-radius: 10px; border-left: 3px solid var(--primary);">
                        <p style="margin: 0; font-size: 0.95em; line-height: 1.6;">Brasil, V.C., Salerno, M.S., Eggers, J.P. and Gomes, L.A.V., 2021. Boosting radical innovation using ambidextrous portfolio management. <em>Research-Technology Management</em>, 64(5), pp.39-49. <a href="https://doi.org/10.1080/08956308.2021.1947605" target="_blank" style="color: var(--primary);">DOI: 10.1080/08956308.2021.1947605</a></p>
                    </div>
                    
                    <div style="background: var(--gray-50); padding: 15px; border-radius: 10px; border-left: 3px solid var(--primary);">
                        <p style="margin: 0; font-size: 0.95em; line-height: 1.6;">Boudreau, K.J., Guinan, E.C., Lakhani, K.R. and Riedl, C., 2016. Looking across and looking beyond the knowledge frontier: Intellectual distance, novelty, and resource allocation in science. <em>Management Science</em>, 62(10), pp.2765-2783. <a href="https://doi.org/10.1287/mnsc.2015.2285" target="_blank" style="color: var(--primary);">DOI: 10.1287/mnsc.2015.2285</a></p>
                    </div>
                    
                    <div style="background: var(--gray-50); padding: 15px; border-radius: 10px; border-left: 3px solid var(--primary);">
                        <p style="margin: 0; font-size: 0.95em; line-height: 1.6;">Cooper, R.G. and Sommer, A.F., 2023. Dynamic portfolio management for new product development. <em>Research-Technology Management</em>, 66(3), pp.19-31. <a href="https://doi.org/10.1080/08956308.2023.2178092" target="_blank" style="color: var(--primary);">DOI: 10.1080/08956308.2023.2178092</a></p>
                    </div>
                    
                    <div style="background: var(--gray-50); padding: 15px; border-radius: 10px; border-left: 3px solid var(--primary);">
                        <p style="margin: 0; font-size: 0.95em; line-height: 1.6;">Criscuolo, P., Dahlander, L., Grohsjean, T. and Salter, A., 2017. Evaluating novelty: The role of panels in the selection of R&D projects. <em>Academy of Management Journal</em>, 60(2), pp.433-460. <a href="https://doi.org/10.5465/amj.2014.0861" target="_blank" style="color: var(--primary);">DOI: 10.5465/amj.2014.0861</a></p>
                    </div>
                    
                    <div style="background: var(--gray-50); padding: 15px; border-radius: 10px; border-left: 3px solid var(--primary);">
                        <p style="margin: 0; font-size: 0.95em; line-height: 1.6;">Criscuolo, P., Dahlander, L., Grohsjean, T. and Salter, A., 2017. The biases that keep good R&D projects from getting funded. <em>Harvard Business Review</em>, March 17, digital article. <a href="https://hbr.org/2017/03/the-biases-that-keep-good-rd-projects-from-getting-funded" target="_blank" style="color: var(--primary);">Read article</a></p>
                    </div>
                    
                    <div style="background: var(--gray-50); padding: 15px; border-radius: 10px; border-left: 3px solid var(--primary);">
                        <p style="margin: 0; font-size: 0.95em; line-height: 1.6;">Criscuolo, P., Dahlander, L., Grohsjean, T. and Salter, A., 2021. The sequence effect on the selection of R&D projects. <em>Organization Science</em>, 32(4), pp.1046-1067. <a href="https://doi.org/10.1287/orsc.2020.1427" target="_blank" style="color: var(--primary);">DOI: 10.1287/orsc.2020.1427</a></p>
                    </div>
                    
                    <div style="background: var(--gray-50); padding: 15px; border-radius: 10px; border-left: 3px solid var(--primary);">
                        <p style="margin: 0; font-size: 0.95em; line-height: 1.6;">Dahlander, L., Beretta, M., Thomas, A., Kazemi, S., Fenger, M.H. and Frederiksen, L., 2023. Weeding out or picking winners in open innovation? Factors driving multi-stage crowd selection on LEGO ideas. <em>Research Policy</em>, 52(10), p.104875. <a href="https://doi.org/10.1016/j.respol.2023.104875" target="_blank" style="color: var(--primary);">DOI: 10.1016/j.respol.2023.104875</a></p>
                    </div>
                    
                    <div style="background: var(--gray-50); padding: 15px; border-radius: 10px; border-left: 3px solid var(--primary);">
                        <p style="margin: 0; font-size: 0.95em; line-height: 1.6;">Dahlander, L., Thomas, A., Wallin, M.W. and Ångström, R.C., 2023. Blinded by the person? Experimental evidence from idea evaluation. <em>Strategic Management Journal</em>, 44(10), pp.2443-2459. <a href="https://doi.org/10.1002/smj.3501" target="_blank" style="color: var(--primary);">DOI: 10.1002/smj.3501</a></p>
                    </div>
                    
                    <div style="background: var(--gray-50); padding: 15px; border-radius: 10px; border-left: 3px solid var(--primary);">
                        <p style="margin: 0; font-size: 0.95em; line-height: 1.6;">Kumar, A. and Operti, E., 2023. Missed chances and unfulfilled hopes: Why do firms make errors in evaluating technological opportunities? <em>Strategic Management Journal</em>, 44(13), pp.3067-3097. <a href="https://doi.org/10.1002/smj.3527" target="_blank" style="color: var(--primary);">DOI: 10.1002/smj.3527</a></p>
                    </div>
                    
                    <div style="background: var(--gray-50); padding: 15px; border-radius: 10px; border-left: 3px solid var(--primary);">
                        <p style="margin: 0; font-size: 0.95em; line-height: 1.6;">Masucci, M., Parker, S.C., Brusoni, S. and Camerani, R., 2021. How are corporate ventures evaluated and selected? <em>Technovation</em>, 99, 102126. <a href="https://doi.org/10.1016/j.technovation.2020.102126" target="_blank" style="color: var(--primary);">DOI: 10.1016/j.technovation.2020.102126</a></p>
                    </div>
                    
                    <div style="background: var(--gray-50); padding: 15px; border-radius: 10px; border-left: 3px solid var(--primary);">
                        <p style="margin: 0; font-size: 0.95em; line-height: 1.6;">Mount, M.P., Baer, M. and Lupoli, M.J., 2021. Quantum leaps or baby steps? Expertise distance, construal level, and the propensity to invest in novel technological ideas. <em>Strategic Management Journal</em>, 42(8), pp.1490-1515. <a href="https://doi.org/10.1002/smj.3269" target="_blank" style="color: var(--primary);">DOI: 10.1002/smj.3269</a></p>
                    </div>
                    
                    <div style="background: var(--gray-50); padding: 15px; border-radius: 10px; border-left: 3px solid var(--primary);">
                        <p style="margin: 0; font-size: 0.95em; line-height: 1.6;">Sharapov, D. and Dahlander, L., 2025. Selection regimes and selection errors. <em>Organization Science</em>. <a href="https://doi.org/10.1287/orsc.2023.17482" target="_blank" style="color: var(--primary);">DOI: 10.1287/orsc.2023.17482</a></p>
                    </div>
                    
                    <div style="background: var(--gray-50); padding: 15px; border-radius: 10px; border-left: 3px solid var(--primary);">
                        <p style="margin: 0; font-size: 0.95em; line-height: 1.6;">Si, H., Kavadias, S. and Loch, C., 2022. Managing innovation portfolios: From project selection to portfolio design. <em>Production and Operations Management</em>, 31(12), pp.4572-4588. <a href="https://doi.org/10.1111/poms.13849" target="_blank" style="color: var(--primary);">DOI: 10.1111/poms.13849</a></p>
                    </div>
                    
                    <div style="background: var(--gray-50); padding: 15px; border-radius: 10px; border-left: 3px solid var(--primary);">
                        <p style="margin: 0; font-size: 0.95em; line-height: 1.6;">Wilden, R., Lin, N., Hohberger, J. and Randhawa, K., 2023. Selecting innovation projects: Do middle and senior managers differ when it comes to radical innovation? <em>Journal of Management Studies</em>, 60(7), pp.1720-1751. <a href="https://doi.org/10.1111/joms.12874" target="_blank" style="color: var(--primary);">DOI: 10.1111/joms.12874</a></p>
                    </div>
                </div>
                
                <div style="margin-top: 25px; text-align: center;">
                    <button class="btn btn-primary" onclick="closeReferencesModal()">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
    // ============================================
    // SOUND SYSTEM - Fun audio feedback
    // ============================================
    
    const SoundManager = {
        audioContext: null,
        enabled: true,
        volume: 0.3,
        
        init() {
            // Create audio context on first user interaction
            if (!this.audioContext) {
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (this.audioContext.state === 'suspended') {
                this.audioContext.resume();
            }
        },
        
        toggle() {
            this.enabled = !this.enabled;
            const btn = document.getElementById('sound-toggle-btn');
            if (btn) {
                btn.innerHTML = this.enabled ? '🔊' : '🔇';
                btn.title = this.enabled ? 'Mute sounds' : 'Unmute sounds';
            }
            if (this.enabled) this.play('click');
        },
        
        play(type) {
            if (!this.enabled) return;
            this.init();
            
            const ctx = this.audioContext;
            const now = ctx.currentTime;
            
            switch(type) {
                case 'click':
                    this.playTone([800], [0.1], 'sine', 0.15);
                    break;
                case 'hover':
                    this.playTone([600], [0.05], 'sine', 0.08);
                    break;
                case 'select':
                    this.playTone([400, 600], [0.08, 0.12], 'sine', 0.2);
                    break;
                case 'deselect':
                    this.playTone([500, 350], [0.08, 0.1], 'sine', 0.15);
                    break;
                case 'success':
                    this.playTone([523, 659, 784], [0.1, 0.1, 0.15], 'sine', 0.25);
                    break;
                case 'confirm':
                    this.playTone([440, 554, 659, 880], [0.08, 0.08, 0.08, 0.2], 'sine', 0.3);
                    break;
                case 'back':
                    this.playTone([500, 400], [0.08, 0.1], 'triangle', 0.15);
                    break;
                case 'forward':
                    this.playTone([400, 550], [0.08, 0.12], 'triangle', 0.18);
                    break;
                case 'error':
                    this.playTone([300, 200], [0.15, 0.2], 'sawtooth', 0.2);
                    break;
                case 'warning':
                    this.playTone([440, 440, 440], [0.1, 0.1, 0.15], 'square', 0.1);
                    break;
                case 'whoosh':
                    this.playWhoosh();
                    break;
                case 'pop':
                    this.playTone([1200, 800], [0.03, 0.08], 'sine', 0.2);
                    break;
                case 'ding':
                    this.playTone([880], [0.4], 'sine', 0.25, true);
                    break;
                case 'coin':
                    this.playTone([988, 1319], [0.1, 0.2], 'square', 0.15);
                    break;
                case 'levelup':
                    this.playTone([523, 659, 784, 1047], [0.12, 0.12, 0.12, 0.3], 'sine', 0.25);
                    break;
                case 'dramatic':
                    this.playDramatic();
                    break;
                case 'chaos':
                    this.playChaos();
                    break;
                case 'meeting':
                    this.playMeetingStart();
                    break;
                case 'reveal':
                    this.playReveal();
                    break;
                case 'typing':
                    this.playTone([800 + Math.random() * 400], [0.03], 'square', 0.05);
                    break;
                case 'slide':
                    this.playSlide(400, 800, 0.15);
                    break;
                case 'slidedown':
                    this.playSlide(800, 400, 0.15);
                    break;
                case 'boost':
                    this.playTone([300, 450, 600, 900], [0.08, 0.08, 0.08, 0.15], 'sawtooth', 0.2);
                    break;
                case 'bin':
                    this.playTone([600, 400, 250], [0.1, 0.1, 0.2], 'triangle', 0.2);
                    break;
                case 'build':
                    this.playTone([350, 440, 523, 659], [0.1, 0.1, 0.1, 0.2], 'sine', 0.22);
                    break;
            }
        },
        
        playTone(frequencies, durations, waveType = 'sine', maxVol = 0.2, vibrato = false) {
            const ctx = this.audioContext;
            const now = ctx.currentTime;
            let time = now;
            
            frequencies.forEach((freq, i) => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                
                osc.type = waveType;
                osc.frequency.setValueAtTime(freq, time);
                
                if (vibrato) {
                    const vibOsc = ctx.createOscillator();
                    const vibGain = ctx.createGain();
                    vibOsc.frequency.value = 6;
                    vibGain.gain.value = 10;
                    vibOsc.connect(vibGain);
                    vibGain.connect(osc.frequency);
                    vibOsc.start(time);
                    vibOsc.stop(time + durations[i]);
                }
                
                gain.gain.setValueAtTime(0, time);
                gain.gain.linearRampToValueAtTime(maxVol * this.volume, time + 0.01);
                gain.gain.exponentialRampToValueAtTime(0.001, time + durations[i]);
                
                osc.connect(gain);
                gain.connect(ctx.destination);
                
                osc.start(time);
                osc.stop(time + durations[i] + 0.01);
                
                time += durations[i] * 0.7;
            });
        },
        
        playWhoosh() {
            const ctx = this.audioContext;
            const now = ctx.currentTime;
            
            const noise = ctx.createBufferSource();
            const buffer = ctx.createBuffer(1, ctx.sampleRate * 0.3, ctx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < data.length; i++) {
                data[i] = Math.random() * 2 - 1;
            }
            noise.buffer = buffer;
            
            const filter = ctx.createBiquadFilter();
            filter.type = 'bandpass';
            filter.frequency.setValueAtTime(1000, now);
            filter.frequency.exponentialRampToValueAtTime(3000, now + 0.15);
            filter.frequency.exponentialRampToValueAtTime(500, now + 0.3);
            filter.Q.value = 1;
            
            const gain = ctx.createGain();
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(0.15 * this.volume, now + 0.05);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
            
            noise.connect(filter);
            filter.connect(gain);
            gain.connect(ctx.destination);
            
            noise.start(now);
            noise.stop(now + 0.3);
        },
        
        playSlide(startFreq, endFreq, duration) {
            const ctx = this.audioContext;
            const now = ctx.currentTime;
            
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            
            osc.type = 'sine';
            osc.frequency.setValueAtTime(startFreq, now);
            osc.frequency.exponentialRampToValueAtTime(endFreq, now + duration);
            
            gain.gain.setValueAtTime(0.15 * this.volume, now);
            gain.gain.exponentialRampToValueAtTime(0.001, now + duration);
            
            osc.connect(gain);
            gain.connect(ctx.destination);
            
            osc.start(now);
            osc.stop(now + duration);
        },
        
        playDramatic() {
            const ctx = this.audioContext;
            const now = ctx.currentTime;
            
            // Deep dramatic chord
            [130.81, 164.81, 196, 261.63].forEach((freq, i) => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                
                osc.type = 'sawtooth';
                osc.frequency.value = freq;
                
                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(0.08 * this.volume, now + 0.1);
                gain.gain.exponentialRampToValueAtTime(0.001, now + 1.5);
                
                osc.connect(gain);
                gain.connect(ctx.destination);
                
                osc.start(now);
                osc.stop(now + 1.5);
            });
        },
        
        playChaos() {
            // Fun chaotic office meeting sounds
            const ctx = this.audioContext;
            const now = ctx.currentTime;
            
            // Rapid succession of tones
            for (let i = 0; i < 8; i++) {
                setTimeout(() => {
                    const freq = 300 + Math.random() * 600;
                    this.playTone([freq], [0.08], ['sine', 'triangle', 'square'][Math.floor(Math.random() * 3)], 0.1);
                }, i * 80);
            }
        },
        
        playMeetingStart() {
            // Boardroom meeting start sound
            const ctx = this.audioContext;
            const now = ctx.currentTime;
            
            // Gavel sound (thunk)
            const noise = ctx.createBufferSource();
            const buffer = ctx.createBuffer(1, ctx.sampleRate * 0.2, ctx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < data.length; i++) {
                data[i] = (Math.random() * 2 - 1) * Math.exp(-i / (ctx.sampleRate * 0.02));
            }
            noise.buffer = buffer;
            
            const filter = ctx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.value = 400;
            
            const gain = ctx.createGain();
            gain.gain.value = 0.4 * this.volume;
            
            noise.connect(filter);
            filter.connect(gain);
            gain.connect(ctx.destination);
            
            noise.start(now);
            
            // Followed by attention tone
            setTimeout(() => {
                this.playTone([523, 784], [0.15, 0.25], 'sine', 0.2);
            }, 200);
        },
        
        playReveal() {
            // Mystery reveal sound
            const ctx = this.audioContext;
            const now = ctx.currentTime;
            
            // Ascending arpeggio
            [262, 330, 392, 523, 659].forEach((freq, i) => {
                setTimeout(() => {
                    this.playTone([freq], [0.15], 'sine', 0.2);
                }, i * 100);
            });
        }
    };
    
    // Auto-init on first click anywhere
    document.addEventListener('click', () => SoundManager.init(), { once: true });
    
    // Global click handler for automatic sound effects
    document.addEventListener('click', (e) => {
        const target = e.target;
        const classList = target.classList;
        const tagName = target.tagName.toLowerCase();
        const onclick = target.getAttribute('onclick') || '';
        const text = target.textContent || '';
        
        // Skip the sound toggle itself
        if (target.id === 'sound-toggle-btn') return;
        
        // Determine sound based on element type and context
        let soundType = null;
        
        // Navigation buttons
        if (onclick.includes('showPhase') || onclick.includes('Continue') || text.includes('Continue') || text.includes('Next') || text.includes('→')) {
            if (text.includes('←') || text.includes('Back')) {
                soundType = 'back';
            } else {
                soundType = 'forward';
            }
        }
        // Back buttons
        else if (text.includes('←') || text.includes('Back') || onclick.includes('Back') || onclick.includes('prev')) {
            soundType = 'back';
        }
        // Confirm/submit buttons
        else if (onclick.includes('confirm') || onclick.includes('Confirm') || text.includes('Confirm') || classList.contains('btn-gold')) {
            soundType = 'confirm';
        }
        // Meeting start buttons
        else if (onclick.includes('startCommitteeChaos') || onclick.includes('startYear2CommitteeChaos') || text.includes('Start the Meeting')) {
            soundType = 'meeting';
        }
        // Selection cards/tiles
        else if (classList.contains('model-card') || classList.contains('staff-tile') || classList.contains('criteria-option') || classList.contains('approach-option')) {
            soundType = target.classList.contains('selected') ? 'deselect' : 'select';
        }
        // Project cards
        else if (classList.contains('project-card') || classList.contains('portfolio-item') || classList.contains('legacy-card')) {
            soundType = 'pop';
        }
        // Bin/reject buttons
        else if (text.includes('Bin') || text.includes('Reject') || onclick.includes('reject') || classList.contains('bin-btn')) {
            soundType = 'bin';
        }
        // Build/accept buttons
        else if (text.includes('Build') || text.includes('Accept') || onclick.includes('accept') || classList.contains('build-btn')) {
            soundType = 'build';
        }
        // Boost buttons
        else if (text.includes('Boost') || onclick.includes('boost') || classList.contains('boost-btn')) {
            soundType = 'boost';
        }
        // Modal close buttons
        else if (classList.contains('modal-close') || text === '×' || onclick.includes('close') || onclick.includes('Close')) {
            soundType = 'whoosh';
        }
        // Tab/toggle buttons
        else if (classList.contains('view-tab') || classList.contains('matrix-toggle-btn') || classList.contains('tab-btn')) {
            soundType = 'click';
        }
        // Slider handles
        else if (classList.contains('slider') || tagName === 'input' && target.type === 'range') {
            soundType = 'slide';
        }
        // Generic buttons
        else if (tagName === 'button' || classList.contains('btn') || classList.contains('btn-primary') || classList.contains('btn-secondary')) {
            soundType = 'click';
        }
        // Clickable cards/divs with onclick
        else if (onclick && (tagName === 'div' || tagName === 'span')) {
            soundType = 'pop';
        }
        // Details/summary elements
        else if (tagName === 'summary') {
            soundType = 'click';
        }
        
        if (soundType) {
            SoundManager.play(soundType);
        }
    });
    
    // ============================================
    // STAFF DATABASE - Diverse Indian names/regions
    // ============================================
    
    const staffDatabase = {
        senior: [
            {
                id: 'meera',
                name: 'Meera Venkataraman',
                initials: 'MV',
                gender: 'female',
                avatarColor: '#003da5',
                role: 'CEO & Co-Founder',
                location: 'Chennai → Bangalore',
                shortBio: 'Visionary founder with deep industry expertise. Strong opinions on strategic direction.',
                fullBio: 'Meera co-founded ShieldTech after 12 years at Honeywell, where she led the Security Products division for South Asia. From Chennai, she studied engineering at IIT Madras before her MBA at IIM Bangalore. Known for bold strategic bets and long-term thinking.',
                cv: [
                    { year: '2015-now', detail: 'CEO & Co-Founder, ShieldTech India' },
                    { year: '2008-2015', detail: 'VP Security Products South Asia, Honeywell' },
                    { year: '2003-2008', detail: 'Product Manager, Siemens Building Tech' },
                    { year: '2001', detail: 'MBA, IIM Bangalore' },
                    { year: '1999', detail: 'B.Tech, IIT Madras' }
                ],
                style: 'Meera favours strategic, platform-oriented projects that position ShieldTech for the long term. Less focused on short-term ROI, more interested in market-shaping opportunities.',
                strengths: ['Strategic vision', 'Industry expertise', 'Bold bets'],
                biases: ['Favours platforms', 'May overlook execution risks'],
                effects: { strategic: 1.3, market: 0.9, hiddenGem: 0.7, slowBurner: 1.2 }
            },
            {
                id: 'farhan',
                name: 'Farhan Qureshi',
                initials: 'FQ',
                gender: 'male',
                avatarColor: '#0891b2',
                role: 'CFO',
                location: 'Mumbai',
                shortBio: 'Numbers-driven executive focused on ROI and capital efficiency.',
                fullBio: 'Farhan joined ShieldTech during Series A and led the company through its IPO. From Mumbai, he trained as a chartered accountant before moving into investment banking at Goldman Sachs. Sharp eye for unit economics and capital allocation.',
                cv: [
                    { year: '2017-now', detail: 'CFO, ShieldTech India' },
                    { year: '2012-2017', detail: 'Principal, Sequoia Capital India' },
                    { year: '2007-2012', detail: 'Investment Banking, Goldman Sachs Mumbai' },
                    { year: '2005', detail: 'MSc Finance, London School of Economics' },
                    { year: '2003', detail: 'CA, ICAI' }
                ],
                style: 'Farhan prioritises projects with clear financial metrics and proven demand. Skeptical of exploratory R&D without clear payback periods.',
                strengths: ['Financial discipline', 'Quick ROI', 'Risk management'],
                biases: ['Short-term focus', 'Undervalues exploration'],
                effects: { cost: 1.4, market: 1.1, hiddenGem: 0.6, moneyPit: 0.5 }
            },
            {
                id: 'sanjay',
                name: 'Sanjay Hegde',
                initials: 'SH',
                gender: 'male',
                avatarColor: '#059669',
                role: 'COO',
                location: 'Mangalore → Bangalore',
                shortBio: 'Operations mastermind who turns strategy into execution at scale.',
                fullBio: 'Sanjay oversees all operations including manufacturing, supply chain, and customer service. From coastal Karnataka, he built his career at Infosys and Flipkart before joining ShieldTech. Known for systematic thinking and operational excellence.',
                cv: [
                    { year: '2019-now', detail: 'COO, ShieldTech India' },
                    { year: '2014-2019', detail: 'VP Operations, Flipkart' },
                    { year: '2008-2014', detail: 'Delivery Head, Infosys' },
                    { year: '2006', detail: 'MBA, IIM Calcutta' },
                    { year: '2004', detail: 'B.E. Industrial Engineering, NITK Surathkal' }
                ],
                style: 'Sanjay evaluates projects through an operational lens — can we manufacture it, support it, scale it? Pushes back on technically elegant but operationally nightmarish proposals.',
                strengths: ['Operational excellence', 'Scale thinking', 'Execution focus'],
                biases: ['Favours proven models', 'Risk-averse on new processes'],
                effects: { team: 1.3, cost: 1.2, paperTiger: 0.6, conventionalWinner: 1.2 }
            },
            {
                id: 'nandini',
                name: 'Nandini Rao',
                initials: 'NR',
                gender: 'female',
                avatarColor: '#f59e0b',
                role: 'General Counsel',
                location: 'Hyderabad → Bangalore',
                shortBio: 'Legal expert who navigates IP, compliance, and risk.',
                fullBio: 'Nandini heads legal affairs including intellectual property, contracts, and regulatory compliance. From Hyderabad, she practiced corporate law at top firms before moving in-house. Sharp on IP strategy and risk assessment.',
                cv: [
                    { year: '2019-now', detail: 'General Counsel, ShieldTech India' },
                    { year: '2014-2019', detail: 'Senior Associate, AZB & Partners' },
                    { year: '2009-2014', detail: 'Associate, Cyril Amarchand Mangaldas' },
                    { year: '2009', detail: 'LL.M., University of Cambridge' },
                    { year: '2007', detail: 'B.A. LL.B., NALSAR Hyderabad' }
                ],
                style: 'Nandini evaluates IP potential and regulatory risk. Champions projects with defensible IP, cautious about those in regulatory grey zones.',
                strengths: ['IP strategy', 'Risk assessment', 'Regulatory insight'],
                biases: ['May be overly cautious', 'Slows fast-moving projects'],
                effects: { strategic: 1.1, conventionalWinner: 1.15, hiddenGem: 0.85, pivotSuccess: 0.9 }
            }
        ],
        heads: [
            {
                id: 'rajiv',
                name: 'Rajiv Kapoor',
                initials: 'RK',
                gender: 'male',
                avatarColor: '#dc2626',
                role: 'VP Sales, North & West',
                location: 'Delhi',
                shortBio: 'P&L owner for ShieldTech\'s largest and most competitive markets.',
                fullBio: 'Rajiv runs the North and West India business — covering 55% of company revenue. From Delhi, he built his career in FMCG distribution at Hindustan Unilever before moving to tech. Known for aggressive market tactics and deep retailer relationships.',
                cv: [
                    { year: '2018-now', detail: 'VP Sales North & West, ShieldTech' },
                    { year: '2013-2018', detail: 'Regional Director, Havells India' },
                    { year: '2008-2013', detail: 'Area Sales Manager, Hindustan Unilever' },
                    { year: '2006', detail: 'MBA, FMS Delhi' }
                ],
                style: 'Rajiv thinks about channel margins, retailer incentives, and competitive response. Champions products that his sales team can push through existing networks.',
                strengths: ['Distribution expertise', 'Competitive instinct', 'Revenue focus'],
                biases: ['Short-term sales focus', 'May resist premium products'],
                effects: { market: 1.35, cost: 1.1, hiddenGem: 0.75, slowBurner: 0.8 }
            },
            {
                id: 'padmini',
                name: 'Padmini Ranganathan',
                initials: 'PR',
                gender: 'female',
                avatarColor: '#059669',
                role: 'VP Sales, South & East',
                location: 'Chennai',
                shortBio: 'Runs the profitable South & East markets known for quality-conscious customers.',
                fullBio: 'Padmini leads South and East India covering Tamil Nadu, Karnataka, Kerala, AP, Telangana, and Bengal. From Chennai, she rose through ShieldTech\'s ranks from regional sales. Known for building strong customer relationships and premium positioning.',
                cv: [
                    { year: '2019-now', detail: 'VP Sales South & East, ShieldTech' },
                    { year: '2016-2019', detail: 'Regional Sales Head South, ShieldTech' },
                    { year: '2011-2016', detail: 'Territory Manager, Godrej Security' },
                    { year: '2009', detail: 'PGDM, Great Lakes Institute of Management' }
                ],
                style: 'Padmini values product quality and brand reputation. Champions products that justify premium pricing through genuine differentiation.',
                strengths: ['Premium positioning', 'Customer relationships', 'Brand building'],
                biases: ['May resist value products', 'Conservative on risks'],
                effects: { market: 1.2, strategic: 1.15, conventionalWinner: 1.25, hiddenGem: 0.9 }
            },
            {
                id: 'deepak',
                name: 'Deepak Shenoy',
                initials: 'DS',
                gender: 'male',
                avatarColor: '#7c3aed',
                role: 'VP Products',
                location: 'Bangalore',
                shortBio: 'Owns the core product portfolio — ShieldTech\'s bread and butter.',
                fullBio: 'Deepak runs the Product division including cameras, sensors, and home security kits. From coastal Karnataka, he joined from Philips consumer electronics. Responsible for product roadmap and 65% of company revenue.',
                cv: [
                    { year: '2017-now', detail: 'VP Products, ShieldTech India' },
                    { year: '2012-2017', detail: 'Product Director, Philips India' },
                    { year: '2007-2012', detail: 'Product Manager, Samsung India' },
                    { year: '2005', detail: 'MBA, IIM Lucknow' }
                ],
                style: 'Deepak protects the core business while seeking growth. Champions products that strengthen the portfolio without cannibalizing existing lines.',
                strengths: ['Core business expertise', 'Portfolio management', 'P&L discipline'],
                biases: ['Defensive of core', 'May resist disruption'],
                effects: { market: 1.2, conventionalWinner: 1.3, strategic: 1.1, hiddenGem: 0.8 }
            },
            {
                id: 'anjali',
                name: 'Anjali Deshmukh',
                initials: 'AD',
                gender: 'female',
                avatarColor: '#ec4899',
                role: 'VP Marketing',
                location: 'Pune → Bangalore',
                shortBio: 'Brand architect who built ShieldTech\'s consumer reputation.',
                fullBio: 'Anjali leads marketing, brand, and communications. From Pune, she created the "Safety for Every Home" campaign that drove awareness. Expert at consumer insights and brand building, with experience at P&G India.',
                cv: [
                    { year: '2018-now', detail: 'VP Marketing, ShieldTech India' },
                    { year: '2014-2018', detail: 'Brand Director, Flipkart' },
                    { year: '2010-2014', detail: 'Marketing Manager, P&G India' },
                    { year: '2008', detail: 'PGDM, Symbiosis Institute of Business Management' }
                ],
                style: 'Anjali champions products with compelling consumer stories. Evaluates how well products can be marketed and differentiated in crowded markets.',
                strengths: ['Brand building', 'Consumer insight', 'Storytelling'],
                biases: ['Marketing-centric', 'May favour flash over substance'],
                effects: { market: 1.3, hiddenGem: 1.2, paperTiger: 1.15, strategic: 0.95 }
            }
        ],
        tech: [
            {
                id: 'harpreet',
                name: 'Harpreet Singh',
                initials: 'HS',
                gender: 'male',
                avatarColor: '#2563eb',
                role: 'CTO',
                location: 'Delhi → Bangalore',
                shortBio: 'Technical leader who built ShieldOS and leads 200+ engineers.',
                fullBio: 'Harpreet leads all engineering across Bangalore and Hyderabad. From Delhi, he studied at Delhi College of Engineering before joining Amazon. Built ShieldOS from the ground up and is passionate about technical excellence and scalable architecture.',
                cv: [
                    { year: '2016-now', detail: 'CTO, ShieldTech India' },
                    { year: '2011-2016', detail: 'Principal Engineer, Amazon India' },
                    { year: '2006-2011', detail: 'Software Engineer, Infosys' },
                    { year: '2006', detail: 'B.Tech Computer Science, Delhi College of Engineering' }
                ],
                style: 'Harpreet evaluates projects on technical feasibility and engineering elegance. Favours projects leveraging existing capabilities, cautious about unproven tech.',
                strengths: ['Technical accuracy', 'Platform thinking', 'Engineering leadership'],
                biases: ['Conservative on new tech', 'Undervalues market factors'],
                effects: { technical: 1.4, slowBurner: 1.3, conventionalLoser: 0.5, paperTiger: 0.7 }
            },
            {
                id: 'zara',
                name: 'Zara Sheikh',
                initials: 'ZS',
                gender: 'female',
                avatarColor: '#f59e0b',
                role: 'Head of AI & Data Science',
                location: 'Hyderabad',
                shortBio: 'ML pioneer who turns data into product intelligence.',
                fullBio: 'Zara leads the data science team that powers ShieldTech\'s AI features. From Hyderabad, she studied at University of Edinburgh and did research at Microsoft Research India. Expert in computer vision and anomaly detection.',
                cv: [
                    { year: '2020-now', detail: 'Head of AI & Data Science, ShieldTech India' },
                    { year: '2017-2020', detail: 'Research Scientist, Microsoft Research India' },
                    { year: '2017', detail: 'PhD Machine Learning, University of Edinburgh' },
                    { year: '2011', detail: 'B.Tech, IIIT Hyderabad' }
                ],
                style: 'Zara champions projects where data and ML can create defensible advantages. Skeptical of AI-washing — wants genuine technical depth.',
                strengths: ['AI/ML expertise', 'Research rigour', 'Technical depth'],
                biases: ['Favours data-rich projects', 'May overcomplicate'],
                effects: { technical: 1.3, slowBurner: 1.2, conventionalLoser: 0.6, hiddenGem: 1.1 }
            }
        ],
        junior: [
            {
                id: 'priyanka',
                name: 'Priyanka Chatterjee',
                initials: 'PC',
                gender: 'female',
                avatarColor: '#8b5cf6',
                role: 'Senior Product Analyst',
                location: 'Kolkata → Bangalore',
                shortBio: 'Data-driven analyst with fresh perspectives and no sacred cows.',
                fullBio: 'Priyanka joined after completing her MBA at Warwick Business School and has impressed everyone with analytical rigour. From Kolkata, she\'s not afraid to challenge conventional wisdom with data. Brings fresh eyes unburdened by "how things have always been done."',
                cv: [
                    { year: '2021-now', detail: 'Senior Product Analyst, ShieldTech India' },
                    { year: '2021', detail: 'MBA, Warwick Business School' },
                    { year: '2019', detail: 'B.Com Honours, Presidency University Kolkata' }
                ],
                style: 'Priyanka relies on data and challenges assumptions. Particularly good at spotting overlooked opportunities and questioning "obvious" projects.',
                strengths: ['Fresh perspective', 'Data-driven', 'Challenges assumptions'],
                biases: ['Limited experience', 'May miss political factors'],
                effects: { hiddenGem: 1.4, market: 1.1, conventionalLoser: 0.7, strategic: 0.9 }
            },
            {
                id: 'thomas',
                name: 'Thomas Varghese',
                initials: 'TV',
                gender: 'male',
                avatarColor: '#dc2626',
                role: 'Senior Field Engineer',
                location: 'Kottayam → Karnataka',
                shortBio: 'Customer-facing engineer who sees what happens in the real world.',
                fullBio: 'Thomas installs and services ShieldTech products across Karnataka. From Kerala, he talks to customers every day and knows their real pain points better than anyone at headquarters. The voice of the customer in R&D decisions.',
                cv: [
                    { year: '2020-now', detail: 'Senior Field Engineer, ShieldTech (Karnataka)' },
                    { year: '2018-2020', detail: 'Service Technician, Godrej Security' },
                    { year: '2018', detail: 'Diploma in Electronics, Bangalore Polytechnic' }
                ],
                style: 'Thomas knows what customers actually struggle with and which features they use. Brilliant at spotting products that solve real problems, skeptical of those designed in conference rooms.',
                strengths: ['Customer reality', 'Field insight', 'Practical needs'],
                biases: ['Incremental focus', 'May miss tech advances'],
                effects: { hiddenGem: 1.35, market: 1.25, paperTiger: 0.65, slowBurner: 0.85 }
            }
        ]
    };
    
    // Professional avatar configuration using DiceBear avataaars
    // Configured with South Asian skin tones and gender-appropriate styling
    const staffAvatarConfig = {
        // Female staff
        meera: { seed: 'meera-ceo-2024', facialHair: '', top: 'longHair', accessories: 'prescription02' },
        nandini: { seed: 'nandini-gc-2024', facialHair: '', top: 'longHair', accessories: 'round' },
        padmini: { seed: 'padmini-vp-2024', facialHair: '', top: 'longHair', accessories: '' },
        anjali: { seed: 'anjali-mkt-2024', facialHair: '', top: 'longHair', accessories: '' },
        zara: { seed: 'zara-ai-2024', facialHair: '', top: 'hijab', accessories: '' },
        priyanka: { seed: 'priyanka-analyst-2024', facialHair: '', top: 'longHair', accessories: '' },
        // Male staff
        farhan: { seed: 'farhan-cfo-2024', facialHair: 'beardLight', top: 'shortHairShortFlat', accessories: '' },
        sanjay: { seed: 'sanjay-coo-2024', facialHair: 'moustacheFancy', top: 'shortHairShortCurly', accessories: 'prescription01' },
        rajiv: { seed: 'rajiv-vps-2024', facialHair: 'beardMedium', top: 'shortHairShortWaved', accessories: '' },
        deepak: { seed: 'deepak-vpp-2024', facialHair: '', top: 'shortHairShortFlat', accessories: 'prescription02' },
        harpreet: { seed: 'harpreet-cto-2024', facialHair: 'beardLight', top: 'turban', accessories: '' },
        thomas: { seed: 'thomas-eng-2024', facialHair: 'beardLight', top: 'shortHairShortCurly', accessories: '' }
    };
    
    function getAvatarUrl(staff) {
        const config = staffAvatarConfig[staff.id];
        if (config) {
            // South Asian skin tones
            const skinColors = ['d08b5b', 'ae5d29', 'c68642', 'e0ac69'];
            const skinColor = skinColors[Math.abs(config.seed.charCodeAt(0)) % skinColors.length];
            
            let url = `https://api.dicebear.com/7.x/avataaars/svg?seed=${config.seed}`;
            url += `&skinColor=${skinColor}`;
            url += `&top=${config.top}`;
            url += `&clothingGraphic=`;
            url += `&clothing=blazerAndShirt,blazerAndSweater,shirtCrewNeck,shirtVNeck`;
            if (config.facialHair) {
                url += `&facialHair=${config.facialHair}`;
                url += `&facialHairColor=2c1b18,4a312c`;
            } else {
                url += `&facialHair=blank`;
            }
            if (config.accessories) {
                url += `&accessories=${config.accessories}`;
            }
            url += `&hairColor=2c1b18,4a312c,1c1c1c`;
            url += `&clothesColor=3c4f5c,262e33,5199e4,25557c`;
            
            return url;
        }
        // Fallback
        return `https://ui-avatars.com/api/?name=${encodeURIComponent(staff.name)}&background=${staff.avatarColor.replace('#', '')}&color=fff&size=200&bold=true&format=svg`;
    }
    
    // ============================================
    // GAME STATE
    // ============================================
    
    let gameState = {
        phase: 'landing',
        decisionModel: null,
        committee: ['meera'], // CEO is always on the R&D committee
        criteria: [],
        criteriaWeights: {},
        budget: 30,
        maxBudget: 30,
        selectedProjects: [],
        activeProjects: [],
        completedProjects: [],
        killedProjects: [],
        rejectedProjects: [],
        currentQuarter: 1,
        maxQuarters: 8,
        currentModalStaff: null,
        currentModalProject: null,
        rankedProjects: null,
        currentAssessmentIndex: 0,
        // Selection approach state
        scoringApproach: null,  // 'careful', 'rapid', or 'delegate'
        teamBlinding: null,     // 'visible' or 'blind'
        // Legacy project state
        legacyProjects: [],
        legacyBudget: { committed: 0, spent: 0, freed: 0 },
        legacyBudgetCommitted: 0,
        activeLegacyProjects: [],
        pausedProjects: [],
        currentLegacyProject: null,
        freedFromLegacy: 0,
        // Budget protection flag - prevents budget resets after selection is locked
        year1SelectionLocked: false,
        // Corporate events state
        currentEvent: null,
        activeEffects: [],  // Effects that persist across quarters
        eventHistory: [],
        pendingEventCallback: null,
        // Management dilemmas state
        currentDilemma: null,
        dilemmaHistory: [],
        pendingDilemmaCallback: null,
        mergedProjects: [],
        // Kill decision tracking for portfolio scoring
        killDecisions: [],  // { projectId, projectName, riskClass, killedAtQuarter, signalStrength, wasPerformingWell }
        // Active management tracking
        activeDecisionsMade: 0  // Count of kill/boost decisions
    };
    
    // ============================================
    // CORPORATE EVENTS DATABASE
    // ============================================
    
    const corporateEvents = [
        // LEADERSHIP EVENTS
        {
            id: 'new_ceo_innovation',
            category: 'Leadership',
            tone: 'positive',
            icon: '👔',
            title: 'New CEO: Innovation Mandate',
            description: 'The board has appointed a new CEO from a major tech company. She\'s announced a bold innovation agenda and wants to see ShieldTech "think bigger."',
            effectText: '+$3M additional R&D budget this quarter',
            duration: 'instant',
            apply: (gs) => { gs.budget += 3; }
        },
        {
            id: 'new_cfo_scrutiny',
            category: 'Leadership',
            tone: 'neutral',
            icon: '📊',
            title: 'New CFO: ROI Scrutiny',
            description: 'The new CFO comes from private equity and is questioning R&D spending. Projects with weak ROI metrics will face extra scrutiny from the committee.',
            effectText: 'Low-ROI projects will face tougher committee questions',
            duration: '2 quarters',
            apply: (gs) => { gs.activeEffects.push({ type: 'roi_scrutiny', remaining: 2 }); }
        },
        {
            id: 'cto_champion',
            category: 'Leadership',
            tone: 'positive',
            icon: '🦸',
            title: 'CTO Becomes Your Champion',
            description: 'The CTO mentioned your portfolio in the earnings call as "exactly the kind of strategic bets we need." Your highest-budget project gets executive air cover.',
            effectText: 'Your largest project gets +10% success probability',
            duration: 'permanent',
            apply: (gs) => { 
                const largest = gs.activeProjects.reduce((a, b) => a.budget > b.budget ? a : b, gs.activeProjects[0]);
                if (largest) largest.successProb = Math.min(0.95, largest.successProb + 0.10);
            }
        },
        {
            id: 'board_review',
            category: 'Leadership',
            tone: 'neutral',
            icon: '🔍',
            title: 'Board Orders Strategic Review',
            description: 'The board has hired consultants to review R&D efficiency. Your highest-budget project will face extra justification requirements.',
            effectText: 'Must justify your largest project or lose $1M from its budget',
            duration: 'instant',
            apply: (gs) => {
                const largest = gs.activeProjects.reduce((a, b) => a.budget > b.budget ? a : b, gs.activeProjects[0]);
                if (largest) largest.budget = Math.max(1, largest.budget - 1);
            }
        },
        {
            id: 'activist_investor',
            category: 'Leadership',
            tone: 'negative',
            icon: '🦈',
            title: 'Activist Investor Takes Stake',
            description: 'A hedge fund has acquired 8% of ShieldTech and is demanding "operational efficiency." R&D budget has been frozen at current levels.',
            effectText: 'Budget frozen for 2 quarters — no additional funding available',
            duration: '2 quarters',
            apply: (gs) => { gs.activeEffects.push({ type: 'budget_freeze', remaining: 2 }); }
        },
        {
            id: 'founder_returns',
            category: 'Leadership',
            tone: 'neutral',
            icon: '👴',
            title: 'Founder Returns as Chairman',
            description: 'ShieldTech\'s founder has returned as Executive Chairman. He\'s reshuffling leadership and questioning recent strategic directions.',
            effectText: 'One random committee member replaced with new perspective',
            duration: 'instant',
            apply: (gs) => { /* Committee shuffle handled separately if needed */ }
        },
        
        // MARKET & ECONOMY EVENTS
        {
            id: 'enterprise_surge',
            category: 'Market',
            tone: 'positive',
            icon: '📈',
            title: 'Enterprise Security Spending Surge',
            description: 'A wave of high-profile cyber attacks has spooked corporate India. Enterprise security budgets are up 30% across the board.',
            effectText: 'B2B-focused projects get +10% success probability this quarter',
            duration: '1 quarter',
            apply: (gs) => {
                gs.activeProjects.forEach(p => {
                    if (p.scores && (p.scores.marketsize >= 4 || p.archetype?.includes('enterprise') || p.archetype?.includes('soc'))) {
                        p.successProb = Math.min(0.95, p.successProb + 0.10);
                    }
                });
            }
        },
        {
            id: 'smart_home_boom',
            category: 'Market',
            tone: 'positive',
            icon: '🏠',
            title: 'Smart Home Market Boom',
            description: 'Jio and Airtel have both launched smart home bundles. Consumer awareness and adoption of connected home devices is accelerating rapidly.',
            effectText: 'Consumer-focused projects get +10% success probability',
            duration: '1 quarter',
            apply: (gs) => {
                gs.activeProjects.forEach(p => {
                    if (p.archetype?.includes('value') || p.archetype?.includes('consumer') || p.archetype?.includes('niche') || p.riskProfile === 'low') {
                        p.successProb = Math.min(0.95, p.successProb + 0.10);
                    }
                });
            }
        },
        {
            id: 'rupee_weakens',
            category: 'Market',
            tone: 'negative',
            icon: '💱',
            title: 'Rupee Weakens Against Dollar',
            description: 'The rupee has depreciated 8% against the dollar this quarter. Imported components are significantly more expensive.',
            effectText: 'Hardware-heavy projects cost +$0.5M more this quarter',
            duration: 'instant',
            apply: (gs) => {
                gs.activeProjects.forEach(p => {
                    if (p.archetype?.includes('drone') || p.archetype?.includes('robot') || p.archetype?.includes('edge') || p.archetype?.includes('wearable')) {
                        p.spentBudget = (p.spentBudget || 0) + 0.5;
                    }
                });
            }
        },
        {
            id: 'recession_fears',
            category: 'Market',
            tone: 'negative',
            icon: '📉',
            title: 'Recession Fears Grip Market',
            description: 'GDP growth forecasts have been cut to 5%. Consumer confidence is dropping and discretionary spending is under pressure.',
            effectText: 'Consumer projects get -10% success probability for 2 quarters',
            duration: '2 quarters',
            apply: (gs) => { gs.activeEffects.push({ type: 'recession', remaining: 2 }); }
        },
        {
            id: 'real_estate_boom',
            category: 'Market',
            tone: 'positive',
            icon: '🏗️',
            title: 'Real Estate Construction Boom',
            description: 'A surge in residential and commercial construction is creating massive demand for security installations in new buildings.',
            effectText: 'Geographic expansion projects get +15% success probability',
            duration: '1 quarter',
            apply: (gs) => {
                gs.activeProjects.forEach(p => {
                    if (p.scores && p.scores.geographic >= 4) {
                        p.successProb = Math.min(0.95, p.successProb + 0.15);
                    }
                });
            }
        },
        {
            id: 'interest_rate_hike',
            category: 'Market',
            tone: 'neutral',
            icon: '🏦',
            title: 'RBI Raises Interest Rates',
            description: 'The Reserve Bank has raised rates by 50 basis points. The finance team is raising ROI thresholds for all investments.',
            effectText: 'Finance team will scrutinize project ROI more carefully',
            duration: '2 quarters',
            apply: (gs) => { gs.activeEffects.push({ type: 'high_interest', remaining: 2 }); }
        },
        
        // REGULATORY & POLICY EVENTS
        {
            id: 'eu_trade_deal',
            category: 'Policy',
            tone: 'positive',
            icon: '🇪🇺',
            title: 'India-EU Trade Deal Signed',
            description: 'India and the EU have signed a comprehensive trade agreement. Security equipment exports to Europe will face zero tariffs.',
            effectText: 'One project gets "EU Market Opportunity" — potential for international expansion',
            duration: 'permanent',
            apply: (gs) => {
                const eligible = gs.activeProjects.filter(p => p.scores && p.scores.geographic >= 3);
                if (eligible.length > 0) {
                    const lucky = eligible[Math.floor(Math.random() * eligible.length)];
                    lucky.successProb = Math.min(0.95, lucky.successProb + 0.10);
                    lucky.euOpportunity = true;
                }
            }
        },
        {
            id: 'make_in_india',
            category: 'Policy',
            tone: 'positive',
            icon: '🇮🇳',
            title: 'Make in India 2.0 Incentives',
            description: 'The government has announced PLI (Production Linked Incentive) scheme for security electronics. Domestic manufacturing gets subsidies.',
            effectText: '+$1M subsidy for domestically manufactured projects',
            duration: 'instant',
            apply: (gs) => { gs.budget += 1; }
        },
        {
            id: 'dpdp_accelerated',
            category: 'Policy',
            tone: 'neutral',
            icon: '🔐',
            title: 'Digital Personal Data Protection (DPDP) Act Enforcement Accelerated',
            description: 'The Data Protection Board has announced enforcement will begin in 6 months. Privacy-compliant solutions are now a higher priority.',
            effectText: 'Privacy-focused projects become strategically important',
            duration: 'permanent',
            apply: (gs) => {
                gs.activeProjects.forEach(p => {
                    if (p.archetype?.includes('privacy') || p.archetype?.includes('compliance')) {
                        p.successProb = Math.min(0.95, p.successProb + 0.10);
                    }
                });
            }
        },
        {
            id: 'smart_city_tenders',
            category: 'Policy',
            tone: 'positive',
            icon: '🌆',
            title: 'Smart City Tenders Announced',
            description: 'The government has announced $10 billion in smart city security tenders. Infrastructure and government-focused projects are in high demand.',
            effectText: 'Government/infrastructure projects get +15% success probability',
            duration: '1 quarter',
            apply: (gs) => {
                gs.activeProjects.forEach(p => {
                    if (p.archetype?.includes('acoustic') || p.archetype?.includes('perimeter') || p.archetype?.includes('cyber_physical')) {
                        p.successProb = Math.min(0.95, p.successProb + 0.15);
                    }
                });
            }
        },
        {
            id: 'compliance_mandate',
            category: 'Policy',
            tone: 'negative',
            icon: '📋',
            title: 'New IoT Compliance Mandate',
            description: 'CERT-In has mandated security certification for all IoT devices. All connected products need additional compliance work.',
            effectText: 'All IoT projects need +$0.3M for certification',
            duration: 'instant',
            apply: (gs) => {
                gs.activeProjects.forEach(p => {
                    if (p.archetype?.includes('edge') || p.archetype?.includes('camera') || p.archetype?.includes('wearable')) {
                        p.spentBudget = (p.spentBudget || 0) + 0.3;
                    }
                });
            }
        },
        {
            id: 'drone_regs_eased',
            category: 'Policy',
            tone: 'positive',
            icon: '🚁',
            title: 'Drone Regulations Eased',
            description: 'The Directorate General of Civil Aviation (DGCA) has liberalized drone operations, allowing Beyond Visual Line of Sight (BVLOS) flights in industrial zones. Autonomous drone projects just got much more viable.',
            effectText: 'Drone projects get +15% success and -1 quarter timeline',
            duration: 'permanent',
            apply: (gs) => {
                gs.activeProjects.forEach(p => {
                    if (p.archetype?.includes('drone')) {
                        p.successProb = Math.min(0.95, p.successProb + 0.15);
                        p.timeline = Math.max(1, p.timeline - 1);
                    }
                });
            }
        },
        
        // TECHNOLOGY & COMPETITIVE EVENTS
        {
            id: 'ai_breakthrough',
            category: 'Technology',
            tone: 'positive',
            icon: '🤖',
            title: 'Major AI Breakthrough',
            description: 'A new generation of AI models has been released with dramatically improved capabilities. AI-powered features are now much easier to develop.',
            effectText: 'AI-powered projects get +10% success and -1 quarter timeline',
            duration: 'permanent',
            apply: (gs) => {
                gs.activeProjects.forEach(p => {
                    if (p.archetype?.includes('ai') || p.archetype?.includes('predictive') || p.archetype?.includes('digital_twin')) {
                        p.successProb = Math.min(0.95, p.successProb + 0.10);
                        p.timeline = Math.max(1, p.timeline - 1);
                    }
                });
            }
        },
        {
            id: 'edge_cost_drop',
            category: 'Technology',
            tone: 'positive',
            icon: '💻',
            title: 'Edge Computing Costs Drop',
            description: 'Competition in the edge AI chip market has driven prices down 40%. Hardware costs for edge computing (local on-device processing rather than cloud) projects are significantly reduced.',
            effectText: 'Edge computing projects get -$0.5M cost reduction',
            duration: 'instant',
            apply: (gs) => {
                gs.activeProjects.forEach(p => {
                    if (p.archetype?.includes('edge') || p.archetype?.includes('micro_nvr')) {
                        p.budget = Math.max(1, p.budget - 0.5);
                    }
                });
            }
        },
        {
            id: 'competitor_recall',
            category: 'Competitive',
            tone: 'positive',
            icon: '⚠️',
            title: 'Competitor Product Recall',
            description: 'CP Plus has issued a major recall due to security vulnerabilities. Customers are looking for alternatives, creating a market opportunity.',
            effectText: 'Your most similar project gets +15% success probability',
            duration: '1 quarter',
            apply: (gs) => {
                if (gs.activeProjects.length > 0) {
                    const lucky = gs.activeProjects[Math.floor(Math.random() * gs.activeProjects.length)];
                    lucky.successProb = Math.min(0.95, lucky.successProb + 0.15);
                }
            }
        },
        {
            id: 'amazon_enters',
            category: 'Competitive',
            tone: 'negative',
            icon: '📦',
            title: 'Amazon Enters Security Market',
            description: 'Amazon has announced "Amazon Secure" for India, bundling Ring cameras with Prime. Consumer security just got much more competitive.',
            effectText: 'Consumer/value segment projects get -10% success probability',
            duration: '2 quarters',
            apply: (gs) => { gs.activeEffects.push({ type: 'amazon_competition', remaining: 2 }); }
        },
        {
            id: 'competitor_launch',
            category: 'Competitive',
            tone: 'negative',
            icon: '🚀',
            title: 'Competitor Launches Rival Product',
            description: 'Hikvision has launched a product directly competing with one of your projects. The market just got more crowded.',
            effectText: 'One random project faces increased competition: -10% success',
            duration: 'permanent',
            apply: (gs) => {
                if (gs.activeProjects.length > 0) {
                    const unlucky = gs.activeProjects[Math.floor(Math.random() * gs.activeProjects.length)];
                    unlucky.successProb = Math.max(0.2, unlucky.successProb - 0.10);
                    unlucky.competitorThreat = true;
                }
            }
        },
        {
            id: 'talent_poached',
            category: 'Competitive',
            tone: 'negative',
            icon: '🚶',
            title: 'Key Engineer Poached',
            description: 'A competitor has hired away one of your senior engineers. One project loses momentum due to knowledge transfer challenges.',
            effectText: 'One random project loses -10% success for 2 quarters',
            duration: '2 quarters',
            apply: (gs) => {
                if (gs.activeProjects.length > 0) {
                    const unlucky = gs.activeProjects[Math.floor(Math.random() * gs.activeProjects.length)];
                    unlucky.talentLoss = 2;
                    unlucky.successProb = Math.max(0.2, unlucky.successProb - 0.10);
                }
            }
        },
        
        // CRISIS & WILDCARD EVENTS
        {
            id: 'security_breach_news',
            category: 'Industry',
            tone: 'positive',
            icon: '📰',
            title: 'High-Profile Security Breach in News',
            description: 'A major bank robbery due to security system failure is dominating headlines. Security spending is suddenly a boardroom priority.',
            effectText: 'All projects get +5% success probability this quarter',
            duration: '1 quarter',
            apply: (gs) => {
                gs.activeProjects.forEach(p => {
                    p.successProb = Math.min(0.95, p.successProb + 0.05);
                });
            }
        },
        {
            id: 'chip_shortage',
            category: 'Crisis',
            tone: 'negative',
            icon: '🔌',
            title: 'Global Chip Shortage',
            description: 'A major semiconductor fab has gone offline. Chip prices are spiking and lead times have doubled.',
            effectText: 'Hardware projects face +$0.75M cost increase and +1 quarter delay',
            duration: 'instant',
            apply: (gs) => {
                gs.activeProjects.forEach(p => {
                    if (p.archetype?.includes('drone') || p.archetype?.includes('robot') || p.archetype?.includes('edge') || p.archetype?.includes('camera')) {
                        p.spentBudget = (p.spentBudget || 0) + 0.75;
                        p.timeline += 1;
                    }
                });
            }
        },
        {
            id: 'cyber_attack',
            category: 'Crisis',
            tone: 'negative',
            icon: '💀',
            title: 'Cyber Attack on ShieldTech',
            description: 'Ransomware has hit ShieldTech\'s development systems. All projects lose progress while systems are restored.',
            effectText: 'All projects lose half a quarter\'s progress',
            duration: 'instant',
            apply: (gs) => {
                gs.activeProjects.forEach(p => {
                    p.currentQuarter = Math.max(0, (p.currentQuarter || 0) - 0.5);
                });
            }
        },
        {
            id: 'industry_award',
            category: 'Industry',
            tone: 'positive',
            icon: '🏆',
            title: 'ShieldTech Wins Industry Award',
            description: 'ShieldTech has won the CII Innovation Award for security technology. The brand boost is helping all market-facing projects.',
            effectText: 'All projects get +10% success probability (brand halo)',
            duration: '1 quarter',
            apply: (gs) => {
                gs.activeProjects.forEach(p => {
                    p.successProb = Math.min(0.95, p.successProb + 0.10);
                });
            }
        },
        {
            id: 'monsoon_disruption',
            category: 'Crisis',
            tone: 'negative',
            icon: '🌧️',
            title: 'Monsoon Disrupts Supply Chain',
            description: 'Severe flooding has disrupted logistics across Maharashtra. Component deliveries are delayed.',
            effectText: 'One random hardware project delayed by 1 quarter',
            duration: 'instant',
            apply: (gs) => {
                const hardware = gs.activeProjects.filter(p => 
                    p.archetype?.includes('drone') || p.archetype?.includes('robot') || 
                    p.archetype?.includes('edge') || p.archetype?.includes('wearable')
                );
                if (hardware.length > 0) {
                    const unlucky = hardware[Math.floor(Math.random() * hardware.length)];
                    unlucky.timeline += 1;
                }
            }
        },
        {
            id: 'celebrity_endorsement',
            category: 'Industry',
            tone: 'positive',
            icon: '⭐',
            title: 'Celebrity Home Uses ShieldTech',
            description: 'A Bollywood star\'s home was protected from a break-in by ShieldTech systems. The story went viral on social media.',
            effectText: 'Consumer products get +10% success probability (PR boost)',
            duration: '1 quarter',
            apply: (gs) => {
                gs.activeProjects.forEach(p => {
                    if (p.riskProfile === 'low' || p.archetype?.includes('value') || p.archetype?.includes('niche')) {
                        p.successProb = Math.min(0.95, p.successProb + 0.10);
                    }
                });
            }
        }
    ];
    
    // ============================================
    // MANAGEMENT DILEMMAS - Portfolio Tensions
    // ============================================
    
    const managementDilemmas = [
        // RESOURCE CONFLICTS
        {
            id: 'expert_conflict',
            category: 'Resource Conflict',
            icon: '👨‍🔬',
            title: 'The Expert Dilemma',
            description: 'Dr. Meera Krishnan is your only ML specialist, and two projects desperately need her expertise this quarter. {projectA} needs her for a critical algorithm, while {projectB} needs help debugging their neural network.',
            requiresProjects: 2,
            choices: [
                {
                    label: 'Prioritize {projectA}',
                    description: 'Give Dr. Krishnan to the first project full-time',
                    consequence: 'projectA_boost',
                    narrativeGood: '{projectA} makes a breakthrough with Dr. Krishnan\'s dedicated support.',
                    narrativeBad: '{projectB} struggles without ML expertise and falls behind schedule.'
                },
                {
                    label: 'Prioritize {projectB}',
                    description: 'The debugging is more urgent',
                    consequence: 'projectB_boost',
                    narrativeGood: '{projectB}\'s neural network issues are resolved quickly.',
                    narrativeBad: '{projectA}\'s algorithm work stalls without specialist guidance.'
                },
                {
                    label: 'Split her time 50/50',
                    description: 'She divides her attention between both',
                    consequence: 'both_slow',
                    narrativeGood: 'Both projects make modest progress with part-time support.',
                    narrativeBad: 'Context-switching means neither project gets her best work.'
                }
            ]
        },
        {
            id: 'lab_equipment',
            category: 'Resource Conflict',
            icon: '🔬',
            title: 'Lab Scheduling Crisis',
            description: 'The environmental testing chamber is booked solid. {projectA} needs it for certification testing, and {projectB} needs it for durability trials. Only one can have it this quarter.',
            requiresProjects: 2,
            choices: [
                {
                    label: 'Give it to {projectA}',
                    description: 'Certification is on the critical path',
                    consequence: 'projectA_boost',
                    narrativeGood: '{projectA} passes certification on schedule.',
                    narrativeBad: '{projectB}\'s durability testing is delayed by a quarter.'
                },
                {
                    label: 'Give it to {projectB}',
                    description: 'Durability issues could be catastrophic',
                    consequence: 'projectB_boost',
                    narrativeGood: '{projectB} catches a critical durability flaw early.',
                    narrativeBad: '{projectA} certification slips, delaying market entry.'
                },
                {
                    label: 'Rent external lab time',
                    description: 'Spend $0.5M on external testing facility',
                    consequence: 'budget_hit',
                    narrativeGood: 'Both projects proceed on schedule using external facilities.',
                    narrativeBad: 'Expensive, but keeps both projects moving.'
                }
            ]
        },
        
        // TECHNOLOGY SPILLOVERS
        {
            id: 'tech_breakthrough',
            category: 'Technology Spillover',
            icon: '💡',
            title: 'Unexpected Breakthrough',
            description: '{projectA} has developed a clever algorithm that could dramatically improve {projectB}\'s performance. But sharing it would slow {projectA} by a quarter while they document and transfer the knowledge.',
            requiresProjects: 2,
            choices: [
                {
                    label: 'Share the breakthrough',
                    description: 'Slow {projectA} to help {projectB}',
                    consequence: 'share_tech',
                    narrativeGood: 'Knowledge transfer creates synergy across the portfolio.',
                    narrativeBad: '{projectA} loses momentum during the documentation effort.'
                },
                {
                    label: 'Keep teams focused',
                    description: 'Each project stays in its lane',
                    consequence: 'no_share',
                    narrativeGood: '{projectA} maintains momentum and ships on time.',
                    narrativeBad: '{projectB} eventually reinvents the wheel, wasting effort.'
                },
                {
                    label: 'Hire a knowledge broker',
                    description: 'Spend $0.3M on a consultant to facilitate transfer',
                    consequence: 'paid_share',
                    narrativeGood: 'Efficient knowledge transfer with minimal disruption.',
                    narrativeBad: 'Expensive but effective cross-pollination.'
                }
            ]
        },
        {
            id: 'patent_decision',
            category: 'IP Strategy',
            icon: '📜',
            title: 'Patent or Publish?',
            description: '{projectA} has made a novel discovery. Patenting it would strengthen our IP position but delay publication. Publishing first would establish thought leadership but weaken our legal protection.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'File for patent',
                    description: 'Protect the IP, delay the project',
                    consequence: 'patent_delay',
                    narrativeGood: 'Strong patent filing gives competitive moat.',
                    narrativeBad: '{projectA} delayed by 2 months during patent process.'
                },
                {
                    label: 'Publish immediately',
                    description: 'Establish thought leadership',
                    consequence: 'publish_fast',
                    narrativeGood: 'Publication generates industry buzz and talent interest.',
                    narrativeBad: 'Competitors can now work around our approach.'
                },
                {
                    label: 'Do both (provisional patent)',
                    description: 'File provisional, then publish. Costs $0.2M extra',
                    consequence: 'both_ip',
                    narrativeGood: 'Best of both worlds with provisional protection.',
                    narrativeBad: 'Additional legal costs but good strategic positioning.'
                }
            ]
        },
        
        // TEAM DYNAMICS
        {
            id: 'star_performer_request',
            category: 'Team Dynamics',
            icon: '⭐',
            title: 'Star Performer Wants to Move',
            description: 'Rahul, your best engineer on {projectA}, has requested a transfer to {projectB} which aligns better with his career goals. Losing him would hurt {projectA}, but denying him risks resignation.',
            requiresProjects: 2,
            choices: [
                {
                    label: 'Approve the transfer',
                    description: 'Keep Rahul happy, strengthen {projectB}',
                    consequence: 'transfer_star',
                    narrativeGood: 'Rahul thrives in {projectB} and becomes even more productive.',
                    narrativeBad: '{projectA} struggles to replace his institutional knowledge.'
                },
                {
                    label: 'Deny the request',
                    description: '{projectA} needs him too much right now',
                    consequence: 'deny_transfer',
                    narrativeGood: '{projectA} maintains momentum with Rahul\'s expertise.',
                    narrativeBad: 'Rahul becomes disengaged and starts job hunting.'
                },
                {
                    label: 'Negotiate a delayed transfer',
                    description: 'He transfers after this milestone (2 months)',
                    consequence: 'delayed_transfer',
                    narrativeGood: 'Compromise keeps both projects staffed appropriately.',
                    narrativeBad: 'Rahul is distracted during transition period.'
                }
            ]
        },
        {
            id: 'team_friction',
            category: 'Team Dynamics',
            icon: '😤',
            title: 'Project Leads at Odds',
            description: 'The leads of {projectA} and {projectB} are barely speaking after a heated argument about shared resources. The tension is affecting both teams\' morale and collaboration.',
            requiresProjects: 2,
            choices: [
                {
                    label: 'Mediate personally',
                    description: 'Spend time resolving the conflict yourself',
                    consequence: 'mediate',
                    narrativeGood: 'Your intervention clears the air and rebuilds trust.',
                    narrativeBad: 'Takes your attention away from strategic decisions.'
                },
                {
                    label: 'Bring in HR',
                    description: 'Let professionals handle interpersonal conflicts',
                    consequence: 'hr_intervention',
                    narrativeGood: 'HR facilitates productive conversation.',
                    narrativeBad: 'Both leads feel they\'re being "managed" and resent it.'
                },
                {
                    label: 'Reorganize to separate them',
                    description: 'Change reporting lines to eliminate interaction',
                    consequence: 'reorg',
                    narrativeGood: 'Clean separation allows both to focus on their work.',
                    narrativeBad: 'Loses potential synergies between the projects.'
                }
            ]
        },
        {
            id: 'burnout_warning',
            category: 'Team Dynamics',
            icon: '😰',
            title: 'Team Burnout Warning',
            description: 'The {projectA} team has been working 60+ hour weeks for two months straight. They\'re exhausted but the deadline is critical. Morale is plummeting.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Push through',
                    description: 'The deadline is non-negotiable',
                    consequence: 'push_burnout',
                    narrativeGood: 'Team delivers heroically and celebrates victory.',
                    narrativeBad: 'Two key engineers quit after the milestone.'
                },
                {
                    label: 'Mandatory rest week',
                    description: 'Accept a 1-week delay for team health',
                    consequence: 'rest_week',
                    narrativeGood: 'Team returns refreshed and more productive.',
                    narrativeBad: 'Project delayed but team retention improves.'
                },
                {
                    label: 'Bring in contractors',
                    description: 'Spend $0.4M to take pressure off the team',
                    consequence: 'contractor_relief',
                    narrativeGood: 'External help allows team to maintain sustainable pace.',
                    narrativeBad: 'Contractors take time to onboard but eventually help.'
                }
            ]
        },
        
        // STRATEGIC TENSIONS
        {
            id: 'project_convergence',
            category: 'Strategic',
            icon: '🔀',
            title: 'Converging Projects',
            description: '{projectA} and {projectB} are evolving toward similar functionality. Continuing separately risks internal competition. Merging might create something stronger—or kill both.',
            requiresProjects: 2,
            choices: [
                {
                    label: 'Merge the projects',
                    description: 'Combine teams and budgets',
                    consequence: 'merge_projects',
                    narrativeGood: 'Merged project becomes stronger than either alone.',
                    narrativeBad: 'Culture clash and scope confusion slow progress.'
                },
                {
                    label: 'Let them compete',
                    description: 'Internal competition drives innovation',
                    consequence: 'internal_compete',
                    narrativeGood: 'Competition produces two distinct, viable products.',
                    narrativeBad: 'Wasted resources building similar solutions.'
                },
                {
                    label: 'Pick a winner now',
                    description: 'Kill one project, double down on the other',
                    consequence: 'pick_winner',
                    narrativeGood: 'Focused resources accelerate the surviving project.',
                    narrativeBad: 'The killed project might have been the better bet.'
                }
            ]
        },
        {
            id: 'partnership_conflict',
            category: 'Strategic',
            icon: '🤝',
            title: 'Partnership Opportunity',
            description: 'A major tech company wants to partner on {projectA}. It would accelerate development but require sharing IP. This might also conflict with {projectB}\'s competitive positioning.',
            requiresProjects: 2,
            choices: [
                {
                    label: 'Accept the partnership',
                    description: 'Accelerate {projectA} with partner resources',
                    consequence: 'accept_partner',
                    narrativeGood: 'Partnership provides resources and market access.',
                    narrativeBad: '{projectB} faces a newly-enabled competitor.'
                },
                {
                    label: 'Decline politely',
                    description: 'Protect our IP and independence',
                    consequence: 'decline_partner',
                    narrativeGood: 'Maintaining independence preserves strategic options.',
                    narrativeBad: 'Partner approaches our competitor instead.'
                },
                {
                    label: 'Counter-propose limited scope',
                    description: 'Partner on marketing only, keep tech separate',
                    consequence: 'limited_partner',
                    narrativeGood: 'Limited partnership gives benefits without IP risk.',
                    narrativeBad: 'Partner is disappointed but accepts reduced terms.'
                }
            ]
        },
        {
            id: 'scope_creep_demand',
            category: 'Strategic',
            icon: '📈',
            title: 'Sales Wants Feature Creep',
            description: 'Sales has a huge customer lined up but they need a feature from {projectA} that wasn\'t planned. Adding it would delay the project and could compromise technical debt.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Add the feature',
                    description: 'Customer demand drives product direction',
                    consequence: 'add_feature',
                    narrativeGood: 'Feature becomes popular and drives more sales.',
                    narrativeBad: 'Technical debt accumulates and slows future development.'
                },
                {
                    label: 'Hold the line',
                    description: 'Ship what we planned, feature comes later',
                    consequence: 'hold_scope',
                    narrativeGood: 'Clean architecture enables faster future iterations.',
                    narrativeBad: 'Sales loses the deal to a competitor.'
                },
                {
                    label: 'Offer a custom build',
                    description: 'Build it separately for this customer only',
                    consequence: 'custom_build',
                    narrativeGood: 'Customer happy with customization, main product stays clean.',
                    narrativeBad: 'Now maintaining two codebases.'
                }
            ]
        },
        
        // ETHICAL & QUALITY DILEMMAS
        {
            id: 'quality_shortcut',
            category: 'Quality',
            icon: '⚖️',
            title: 'The Shortcut Temptation',
            description: '{projectA} can hit its deadline if the team skips some testing protocols. The PM says the risk is low, but QA is uncomfortable signing off.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Take the shortcut',
                    description: 'Ship on time, fix issues in updates',
                    consequence: 'shortcut',
                    narrativeGood: 'Ship goes smoothly, no issues found in field.',
                    narrativeBad: 'Customer-reported bugs damage reputation.'
                },
                {
                    label: 'Do full testing',
                    description: 'Accept the delay for quality assurance',
                    consequence: 'full_test',
                    narrativeGood: 'Testing catches critical bug that would have been costly.',
                    narrativeBad: 'Delayed launch but solid product.'
                },
                {
                    label: 'Staged rollout',
                    description: 'Limited release to beta customers first',
                    consequence: 'staged_release',
                    narrativeGood: 'Beta customers catch minor issues before broad release.',
                    narrativeBad: 'Slower market penetration but controlled risk.'
                }
            ]
        },
        {
            id: 'competitor_intel',
            category: 'Ethics',
            icon: '🕵️',
            title: 'Questionable Intelligence',
            description: 'A new hire from a competitor has offered to share detailed technical specs of their competing product. It would help {projectA} enormously, but feels ethically grey.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Accept the information',
                    description: 'This is normal competitive intelligence',
                    consequence: 'accept_intel',
                    narrativeGood: 'Intel helps us leapfrog competitor\'s approach.',
                    narrativeBad: 'If discovered, could damage reputation and invite legal trouble.'
                },
                {
                    label: 'Decline firmly',
                    description: 'We compete on our own merits',
                    consequence: 'decline_intel',
                    narrativeGood: 'Ethical stance builds culture of integrity.',
                    narrativeBad: 'Competitor advantage remains unknown.'
                },
                {
                    label: 'Consult legal first',
                    description: 'Get guidance on what\'s acceptable',
                    consequence: 'legal_consult',
                    narrativeGood: 'Legal identifies what\'s safe to use.',
                    narrativeBad: 'Conservative guidance means most intel is off-limits.'
                }
            ]
        },
        {
            id: 'junior_breakthrough',
            category: 'Team Dynamics',
            icon: '🌟',
            title: 'Junior\'s Big Idea',
            description: 'A junior engineer on {projectA} has proposed a radical approach that could be brilliant—or a disaster. The senior engineers are skeptical but can\'t prove it wrong.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Back the junior',
                    description: 'Innovation requires taking risks on new voices',
                    consequence: 'back_junior',
                    narrativeGood: 'Junior\'s approach proves revolutionary.',
                    narrativeBad: 'Idea fails, wasting a quarter of effort.'
                },
                {
                    label: 'Go with the seniors',
                    description: 'Experience usually wins',
                    consequence: 'back_seniors',
                    narrativeGood: 'Senior approach delivers reliable results.',
                    narrativeBad: 'Junior becomes disengaged and leaves.'
                },
                {
                    label: 'Run a parallel prototype',
                    description: 'Test both approaches for 4 weeks',
                    consequence: 'parallel_test',
                    narrativeGood: 'Prototype reveals which approach is better.',
                    narrativeBad: 'Delays the decision but builds team buy-in.'
                }
            ]
        },
        {
            id: 'customer_data',
            category: 'Ethics',
            icon: '🔐',
            title: 'Customer Data Request',
            description: 'The {projectA} team wants access to detailed customer usage data to improve their ML model. Privacy team says it\'s technically compliant but customers weren\'t explicitly told.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Grant access',
                    description: 'It\'s compliant, and the data would really help',
                    consequence: 'grant_data',
                    narrativeGood: 'ML model improves significantly with real data.',
                    narrativeBad: 'Privacy advocacy group raises concerns publicly.'
                },
                {
                    label: 'Deny access',
                    description: 'Just because we can doesn\'t mean we should',
                    consequence: 'deny_data',
                    narrativeGood: 'Privacy-first stance becomes marketing advantage.',
                    narrativeBad: 'ML model underperforms without training data.'
                },
                {
                    label: 'Use anonymized data only',
                    description: 'Spend extra time to properly anonymize',
                    consequence: 'anonymize_data',
                    narrativeGood: 'Anonymization preserves utility while protecting privacy.',
                    narrativeBad: 'Extra processing time delays the feature.'
                }
            ]
        },
        
        // IP-SPECIFIC DILEMMAS
        {
            id: 'essential_patent_opportunity',
            category: 'IP Strategy',
            icon: '🏆',
            title: 'Essential Patent Available',
            description: 'A struggling competitor is selling a patent portfolio that includes a foundational patent essential to {projectA}. They want $1.2M—expensive, but it would eliminate a major IP risk and could be used defensively against others.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Buy the patent',
                    description: 'Secure the IP, accept the cost',
                    consequence: 'buy_patent',
                    narrativeGood: 'Patent acquisition eliminates IP risk and strengthens our position.',
                    narrativeBad: 'Expensive, but we now own a valuable defensive asset.'
                },
                {
                    label: 'Negotiate a license instead',
                    description: 'Cheaper ($0.4M) but we don\'t own it',
                    consequence: 'license_patent',
                    narrativeGood: 'License secures freedom to operate at lower cost.',
                    narrativeBad: 'We\'re still dependent on the patent holder\'s goodwill.'
                },
                {
                    label: 'Design around it',
                    description: 'Engineering effort to avoid the patent entirely',
                    consequence: 'design_around',
                    narrativeGood: 'Engineers find clever workaround that avoids IP issues.',
                    narrativeBad: 'Design-around takes longer and results in inferior solution.'
                }
            ]
        },
        {
            id: 'patent_filing_deadline',
            category: 'IP Strategy',
            icon: '⏰',
            title: 'Patent Filing Crisis',
            description: 'Legal just discovered that a key invention from {projectA} was publicly disclosed at a conference 11 months ago. We have 30 days to file before losing patent rights forever. But the filing isn\'t ready and would cost $0.3M to rush.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Rush the filing',
                    description: 'Pay premium for expedited patent work',
                    consequence: 'rush_patent',
                    narrativeGood: 'Patent filed just in time—invention protected.',
                    narrativeBad: 'Rushed filing has some quality issues but captures core claims.'
                },
                {
                    label: 'Let it go to public domain',
                    description: 'Accept that this invention won\'t be patented',
                    consequence: 'miss_patent',
                    narrativeGood: 'We save money and can still use the invention freely.',
                    narrativeBad: 'Competitors can now freely copy our innovation.'
                },
                {
                    label: 'File provisional and extend timeline',
                    description: 'Provisional filing ($0.1M) buys 12 more months',
                    consequence: 'provisional_patent',
                    narrativeGood: 'Provisional buys time for a quality full filing later.',
                    narrativeBad: 'Must remember to follow up or lose protection anyway.'
                }
            ]
        },
        {
            id: 'conference_leak',
            category: 'IP Strategy',
            icon: '🍺',
            title: 'Conference Leak',
            description: 'At an industry conference, a {projectA} engineer apparently shared technical details over drinks that included unpublished innovations. A competitor\'s blog post now references "exciting developments at ShieldTech." Our patent window may be compromised.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Emergency patent filings',
                    description: 'Rush to file everything discussed ($0.5M)',
                    consequence: 'emergency_filings',
                    narrativeGood: 'Fast filings preserve most of our IP rights.',
                    narrativeBad: 'Some innovations may already be prior art, but we salvage what we can.'
                },
                {
                    label: 'Damage assessment first',
                    description: 'Interview staff, analyze what was actually disclosed',
                    consequence: 'assess_damage',
                    narrativeGood: 'Assessment reveals the leak was less serious than feared.',
                    narrativeBad: 'Weeks of investigation delay response while competitors act.'
                },
                {
                    label: 'Discipline the employee',
                    description: 'Make an example to prevent future leaks',
                    consequence: 'discipline_leaker',
                    narrativeGood: 'Clear message sent; NDA compliance improves.',
                    narrativeBad: 'Key engineer leaves; team morale drops. IP still compromised.'
                }
            ]
        },
        {
            id: 'jurisdiction_gap',
            category: 'IP Strategy',
            icon: '🌏',
            title: 'International Patent Gap',
            description: '{projectA}\'s core patent was filed in India and the US, but not in China or Europe. A Chinese competitor is now manufacturing similar products. Extending protection now would cost $0.8M but time is running out.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'File in all major markets',
                    description: 'Full international protection ($0.8M)',
                    consequence: 'full_international',
                    narrativeGood: 'Global protection secures markets worldwide.',
                    narrativeBad: 'Expensive, but prevents international copycats.'
                },
                {
                    label: 'Focus on Europe only',
                    description: 'Partial protection where we have sales ($0.3M)',
                    consequence: 'europe_only',
                    narrativeGood: 'European protection covers our key export market.',
                    narrativeBad: 'Chinese market remains vulnerable to copying.'
                },
                {
                    label: 'Accept limited protection',
                    description: 'India and US coverage is sufficient for now',
                    consequence: 'accept_gaps',
                    narrativeGood: 'Cost savings can be invested in other projects.',
                    narrativeBad: 'Competitor\'s Chinese clone starts appearing in Indian grey market.'
                }
            ]
        },
        {
            id: 'infringement_discovered',
            category: 'IP Strategy',
            icon: '⚖️',
            title: 'Patent Infringement Discovered',
            description: 'Our IP team has found clear evidence that a competitor is infringing on {projectA}\'s key patent. We could sue, but litigation is expensive ($1.5M+) and would distract the team. They might also countersue.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Sue for infringement',
                    description: 'Enforce our rights aggressively',
                    consequence: 'sue_infringer',
                    narrativeGood: 'Court rules in our favor; competitor must pay damages and stop.',
                    narrativeBad: 'Expensive, drawn-out litigation with uncertain outcome.'
                },
                {
                    label: 'Send cease and desist',
                    description: 'Formal warning without immediate litigation',
                    consequence: 'cease_desist',
                    narrativeGood: 'Competitor backs down to avoid legal costs.',
                    narrativeBad: 'They ignore the letter and continue infringing.'
                },
                {
                    label: 'Propose licensing deal',
                    description: 'Turn infringer into paying licensee',
                    consequence: 'license_infringer',
                    narrativeGood: 'Competitor agrees to license terms—new revenue stream.',
                    narrativeBad: 'Negotiations drag on; they use the time to design around.'
                }
            ]
        },
        {
            id: 'infringement_victory',
            category: 'IP Strategy',
            icon: '🎉',
            title: 'Infringement Case Won!',
            description: 'Great news! We\'ve won our patent infringement case. The competitor must pay $2M in damages. But now we must decide: reinvest in R&D, use it defensively to build our patent portfolio, or distribute to shareholders?',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Reinvest in {projectA}',
                    description: 'Accelerate the project that generated the IP',
                    consequence: 'reinvest_winnings',
                    narrativeGood: 'Additional funding accelerates development significantly.',
                    narrativeBad: 'Money well spent on the team that earned it.'
                },
                {
                    label: 'Build patent war chest',
                    description: 'Fund defensive patent filings across portfolio',
                    consequence: 'patent_warchest',
                    narrativeGood: 'Strengthened IP position deters future infringers.',
                    narrativeBad: 'Defensive patents are valuable but don\'t ship products.'
                },
                {
                    label: 'Return to general R&D budget',
                    description: 'Spread across all projects equally',
                    consequence: 'spread_winnings',
                    narrativeGood: 'All projects benefit from the windfall.',
                    narrativeBad: 'Diluted impact—no single project sees major boost.'
                }
            ]
        },
        {
            id: 'trade_secret_vs_patent',
            category: 'IP Strategy',
            icon: '🤫',
            title: 'Trade Secret or Patent?',
            description: '{projectA} has developed a novel manufacturing process. Patenting would provide 20 years of protection but require public disclosure. Keeping it as a trade secret offers indefinite protection but risks reverse engineering or employee departure.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Patent the process',
                    description: 'Public disclosure for legal protection',
                    consequence: 'patent_process',
                    narrativeGood: 'Patent provides clear legal protection and licensing opportunity.',
                    narrativeBad: 'Competitors now know exactly how we do it.'
                },
                {
                    label: 'Keep as trade secret',
                    description: 'Maintain secrecy with strict controls',
                    consequence: 'trade_secret',
                    narrativeGood: 'Secret remains protected; competitors can\'t replicate.',
                    narrativeBad: 'Key engineer joins competitor, taking knowledge with them.'
                },
                {
                    label: 'Hybrid approach',
                    description: 'Patent some elements, keep core secret',
                    consequence: 'hybrid_ip',
                    narrativeGood: 'Strategic mix protects most valuable elements.',
                    narrativeBad: 'Complex to manage; some gaps in protection.'
                }
            ]
        },
        {
            id: 'prior_art_discovered',
            category: 'IP Strategy',
            icon: '📚',
            title: 'Prior Art Surfaces',
            description: 'A researcher has found an obscure 2015 academic paper that appears to describe key elements of {projectA}\'s pending patent application. Our patent attorney says it\'s a grey area—we could argue around it or withdraw.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Proceed and argue novelty',
                    description: 'Our implementation is sufficiently different',
                    consequence: 'argue_novelty',
                    narrativeGood: 'Patent examiner accepts our novelty arguments.',
                    narrativeBad: 'Patent granted but with narrower claims than hoped.'
                },
                {
                    label: 'Amend claims significantly',
                    description: 'Narrow the scope to avoid prior art',
                    consequence: 'narrow_claims',
                    narrativeGood: 'Narrower but solid patent that will hold up.',
                    narrativeBad: 'Reduced protection leaves some innovations unprotected.'
                },
                {
                    label: 'Withdraw and publish',
                    description: 'Abandon patent, establish prior art ourselves',
                    consequence: 'withdraw_publish',
                    narrativeGood: 'Publication prevents competitors from patenting it.',
                    narrativeBad: 'We lose exclusive rights but so does everyone else.'
                }
            ]
        },
        
        // OPEN INNOVATION & COLLABORATION DILEMMAS
        {
            id: 'supplier_codevelopment',
            category: 'Open Innovation',
            icon: '🏭',
            title: 'Supplier Wants In',
            description: 'Our key component supplier for {projectA} is offering to co-develop the next-gen sensor at 40% cost reduction—but they want access to our full system specs and the right to sell to other customers after 18 months.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Accept the partnership',
                    description: 'Cost savings outweigh exclusivity concerns',
                    consequence: 'accept_supplier_coop',
                    narrativeGood: 'Co-development yields breakthrough component at lower cost.',
                    narrativeBad: 'Supplier now understands our architecture; competitors may benefit later.'
                },
                {
                    label: 'Counter with longer exclusivity',
                    description: 'Negotiate 36-month exclusive period',
                    consequence: 'negotiate_exclusivity',
                    narrativeGood: 'Supplier agrees to extended exclusivity—we keep our edge.',
                    narrativeBad: 'Supplier walks away; we lose the cost reduction opportunity.'
                },
                {
                    label: 'Develop in-house instead',
                    description: 'Maintain full control but higher cost',
                    consequence: 'inhouse_development',
                    narrativeGood: 'Full control over roadmap and IP.',
                    narrativeBad: 'Higher costs and slower development without supplier expertise.'
                }
            ]
        },
        {
            id: 'customer_codevelopment',
            category: 'Open Innovation',
            icon: '🤝',
            title: 'Strategic Customer Offer',
            description: 'Tata Projects wants to co-fund {projectA} development ($1.5M) in exchange for 12-month exclusivity and input on the roadmap. Other potential customers might not wait.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Accept Tata partnership',
                    description: 'Guaranteed customer and funding',
                    consequence: 'accept_customer_coop',
                    narrativeGood: 'Tata funding accelerates development; strong reference customer.',
                    narrativeBad: 'Exclusivity delays broader market; product shaped too narrowly for Tata.'
                },
                {
                    label: 'Offer advisory role only',
                    description: 'Input without exclusivity or funding',
                    consequence: 'advisory_only',
                    narrativeGood: 'Tata provides valuable input without constraining our market.',
                    narrativeBad: 'Tata feels undervalued and looks at competitor solutions.'
                },
                {
                    label: 'Decline and stay independent',
                    description: 'Build for the broader market',
                    consequence: 'stay_independent',
                    narrativeGood: 'Product serves wider market without compromise.',
                    narrativeBad: 'Slower development without partner funding.'
                }
            ]
        },
        {
            id: 'university_collaboration',
            category: 'Open Innovation',
            icon: '🎓',
            title: 'University Research Partnership',
            description: 'IIT Delhi\'s AI lab offers to collaborate on {projectA}\'s machine learning challenges. They\'d contribute 3 PhD students, but want publication rights and shared IP on any discoveries.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Full research partnership',
                    description: 'Share IP for access to top talent',
                    consequence: 'full_university_partner',
                    narrativeGood: 'PhD students solve key technical challenges; papers boost reputation.',
                    narrativeBad: 'Published research helps competitors; IP ownership gets messy.'
                },
                {
                    label: 'Sponsored research (we own IP)',
                    description: 'Pay $0.4M to retain full IP rights',
                    consequence: 'sponsored_research',
                    narrativeGood: 'World-class research with clear IP ownership.',
                    narrativeBad: 'More expensive but cleaner arrangement.'
                },
                {
                    label: 'Hire graduates instead',
                    description: 'Recruit talent without research entanglement',
                    consequence: 'hire_graduates',
                    narrativeGood: 'Great hires strengthen the team long-term.',
                    narrativeBad: 'Miss out on cutting-edge academic research.'
                }
            ]
        },
        {
            id: 'consortium_invitation',
            category: 'Open Innovation',
            icon: '🌐',
            title: 'Industry Consortium Invitation',
            description: 'The Smart Home Alliance wants ShieldTech to join their consortium developing interoperability standards. Membership requires sharing some {projectA} protocols but gives access to everyone else\'s too.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Join as full member',
                    description: 'Contribute protocols, gain influence on standards',
                    consequence: 'join_consortium',
                    narrativeGood: 'Our protocols become industry standard; competitors must follow us.',
                    narrativeBad: 'Proprietary advantages shared; differentiation harder.'
                },
                {
                    label: 'Join as observer only',
                    description: 'Watch developments without contributing',
                    consequence: 'observer_status',
                    narrativeGood: 'Intelligence on competitor direction without exposure.',
                    narrativeBad: 'No vote on standards; may be disadvantaged by decisions.'
                },
                {
                    label: 'Decline and go proprietary',
                    description: 'Bet on our own ecosystem winning',
                    consequence: 'proprietary_path',
                    narrativeGood: 'Strong differentiation in fragmented market.',
                    narrativeBad: 'Industry standardizes without us; integration becomes costly.'
                }
            ]
        },
        {
            id: 'supplier_quality_crisis',
            category: 'Open Innovation',
            icon: '😱',
            title: 'Supplier Quality Crisis',
            description: 'The contract manufacturer for {projectA}\'s PCBs has delivered a batch with 15% defect rate—way above the 2% spec. They blame our design files. We need boards in 3 weeks for launch.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Work together to fix it',
                    description: 'Joint engineering effort to solve root cause',
                    consequence: 'joint_fix',
                    narrativeGood: 'Collaborative debugging finds design flaw; stronger relationship.',
                    narrativeBad: 'Takes longer than expected; launch slips by 4 weeks.'
                },
                {
                    label: 'Switch suppliers immediately',
                    description: 'Find new manufacturer, accept delay and cost',
                    consequence: 'switch_supplier',
                    narrativeGood: 'New supplier delivers quality; worth the disruption.',
                    narrativeBad: 'Expensive transition; 6-week delay while new supplier ramps.'
                },
                {
                    label: 'Accept and sort manually',
                    description: 'Screen out defects, launch with reduced volume',
                    consequence: 'manual_screening',
                    narrativeGood: 'Launch proceeds on time with adequate inventory.',
                    narrativeBad: 'Higher unit cost; some defects slip through to customers.'
                }
            ]
        },
        {
            id: 'customer_pilot_scope',
            category: 'Open Innovation',
            icon: '🧪',
            title: 'Pilot Customer Goes Rogue',
            description: 'The pilot customer for {projectA} has been so enthusiastic they\'ve built custom extensions to our product. Now they want us to support their modifications—or let them open-source the extensions.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Absorb into product roadmap',
                    description: 'Adopt their extensions as official features',
                    consequence: 'absorb_extensions',
                    narrativeGood: 'Customer innovations improve our product for everyone.',
                    narrativeBad: 'Roadmap derailed to support customer-driven features.'
                },
                {
                    label: 'Allow open-source release',
                    description: 'Let them share with the community',
                    consequence: 'allow_opensource',
                    narrativeGood: 'Community contributions emerge; ecosystem grows.',
                    narrativeBad: 'Fragmentation risk; support burden increases.'
                },
                {
                    label: 'Enforce license terms',
                    description: 'Their modifications violate our license',
                    consequence: 'enforce_license',
                    narrativeGood: 'Clear boundaries maintained; IP protected.',
                    narrativeBad: 'Customer relationship damaged; they switch to competitor.'
                }
            ]
        },
        {
            id: 'joint_venture_ip',
            category: 'Open Innovation',
            icon: '⚔️',
            title: 'JV Partner IP Dispute',
            description: 'Our joint venture partner on {projectA} claims their engineers invented the key algorithm, not ours. The JV agreement is ambiguous. They\'re threatening to license "their" IP to our competitor.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Negotiate buyout',
                    description: 'Offer to buy their share of the IP ($0.8M)',
                    consequence: 'buyout_jv_ip',
                    narrativeGood: 'Clean ownership; JV partner exits satisfied.',
                    narrativeBad: 'Expensive, but eliminates ongoing conflict.'
                },
                {
                    label: 'Arbitration',
                    description: 'Let a neutral party decide ownership',
                    consequence: 'arbitration',
                    narrativeGood: 'Arbitrator rules in our favor; IP secured.',
                    narrativeBad: 'Arbitration drags on; relationship destroyed regardless of outcome.'
                },
                {
                    label: 'Propose cross-license',
                    description: 'Both parties can use the IP independently',
                    consequence: 'cross_license',
                    narrativeGood: 'Pragmatic solution keeps both parties productive.',
                    narrativeBad: 'Competitor may eventually get access through our JV partner.'
                }
            ]
        },
        {
            id: 'open_source_decision',
            category: 'Open Innovation',
            icon: '📖',
            title: 'Open Source Opportunity',
            description: '{projectA}\'s SDK could attract developer adoption if open-sourced. The community could fix bugs and add features—but competitors could also use it. Our cloud services would still be proprietary.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Open source the SDK',
                    description: 'Build ecosystem, monetize cloud services',
                    consequence: 'opensource_sdk',
                    narrativeGood: 'Developer community forms; platform adoption accelerates.',
                    narrativeBad: 'Competitors fork and improve without contributing back.'
                },
                {
                    label: 'Source-available only',
                    description: 'Viewable code but restricted commercial use',
                    consequence: 'source_available',
                    narrativeGood: 'Transparency builds trust; license protects commercial interests.',
                    narrativeBad: 'Developers frustrated by restrictions; limited community growth.'
                },
                {
                    label: 'Keep proprietary',
                    description: 'Maintain full control over SDK',
                    consequence: 'keep_proprietary',
                    narrativeGood: 'Full control; clear monetization path.',
                    narrativeBad: 'Slower adoption; developers choose open alternatives.'
                }
            ]
        },
        {
            id: 'startup_acquisition_ip',
            category: 'Open Innovation',
            icon: '🚀',
            title: 'Startup Acquisition Opportunity',
            description: 'A 5-person startup has technology that could accelerate {projectA} by 6 months. They want $2M, but due diligence reveals their IP may have been developed while founders worked at a competitor.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Acquire anyway',
                    description: 'Accept the risk; technology is too valuable',
                    consequence: 'acquire_risky',
                    narrativeGood: 'No challenge materializes; technology integrates smoothly.',
                    narrativeBad: 'Former employer sues; acquisition becomes liability.'
                },
                {
                    label: 'Acqui-hire only',
                    description: 'Hire the team, have them rebuild from scratch',
                    consequence: 'acquihire',
                    narrativeGood: 'Talented team accelerates {projectA} with clean IP.',
                    narrativeBad: 'Slower than buying the tech; some founders decline to join.'
                },
                {
                    label: 'Walk away',
                    description: 'Risk is too high; find another path',
                    consequence: 'walk_away_acquisition',
                    narrativeGood: 'Avoided a legal landmine; found alternative solution.',
                    narrativeBad: 'Competitor acquires them instead.'
                }
            ]
        },
        {
            id: 'customer_data_sharing',
            category: 'Open Innovation',
            icon: '📊',
            title: 'Customer Wants Data Exchange',
            description: 'A major enterprise customer offers to share their usage analytics to improve {projectA}\'s algorithms—if we share aggregated insights from all customers with them. Privacy policy allows it.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Accept the exchange',
                    description: 'Mutual data sharing benefits both parties',
                    consequence: 'data_exchange',
                    narrativeGood: 'Rich data dramatically improves product performance.',
                    narrativeBad: 'Other customers uncomfortable when they learn of arrangement.'
                },
                {
                    label: 'One-way only',
                    description: 'Take their data, share nothing back',
                    consequence: 'one_way_data',
                    narrativeGood: 'We benefit without exposing aggregate insights.',
                    narrativeBad: 'Customer feels exploited; relationship strained.'
                },
                {
                    label: 'Decline entirely',
                    description: 'Keep data relationships simple',
                    consequence: 'decline_data_sharing',
                    narrativeGood: 'Clean data governance; no complicated arrangements.',
                    narrativeBad: 'Miss opportunity to improve algorithms.'
                }
            ]
        },
        {
            id: 'partner_pivot',
            category: 'Open Innovation',
            icon: '🔄',
            title: 'Partner Pivots Strategy',
            description: 'Our development partner for {projectA} just announced they\'re pivoting to compete directly with us in an adjacent market. They still have access to our APIs and roadmap.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Terminate immediately',
                    description: 'Cut off access, accept disruption',
                    consequence: 'terminate_partner',
                    narrativeGood: 'Clean break; they can\'t use our roadmap against us.',
                    narrativeBad: 'Scramble to replace their contributions; 2-month delay.'
                },
                {
                    label: 'Orderly wind-down',
                    description: '90-day transition to reduce dependencies',
                    consequence: 'orderly_winddown',
                    narrativeGood: 'Smooth transition minimizes disruption.',
                    narrativeBad: 'They continue gathering intelligence during wind-down.'
                },
                {
                    label: 'Continue partnership anyway',
                    description: 'Adjacent competition doesn\'t affect our collaboration',
                    consequence: 'continue_despite_pivot',
                    narrativeGood: 'Pragmatic approach; partnership still valuable.',
                    narrativeBad: 'They leverage inside knowledge to compete effectively.'
                }
            ]
        },
        
        // CORPORATE TENSIONS
        {
            id: 'strategy_pivot',
            category: 'Corporate',
            icon: '🎯',
            title: 'Strategic Pivot Announced',
            description: 'The CEO just announced ShieldTech is pivoting from "premium security" to "security for everyone." {projectA} was designed for the enterprise market—it may no longer align with corporate direction.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Reposition the project',
                    description: 'Adapt {projectA} to serve mass market',
                    consequence: 'reposition_project',
                    narrativeGood: 'Repositioned product finds unexpected mass-market appeal.',
                    narrativeBad: 'Neither enterprise nor consumer customers fully satisfied.'
                },
                {
                    label: 'Argue for exception',
                    description: 'Make the case that enterprise still matters',
                    consequence: 'argue_exception',
                    narrativeGood: 'Leadership agrees enterprise remains strategic; project continues.',
                    narrativeBad: 'Seen as not being a team player; project gets reduced support.'
                },
                {
                    label: 'Spin out as separate unit',
                    description: 'Create enterprise division to protect the project',
                    consequence: 'spinout_unit',
                    narrativeGood: 'Separate unit thrives serving enterprise customers.',
                    narrativeBad: 'Isolated from main company resources and attention.'
                }
            ]
        },
        {
            id: 'new_cto_agenda',
            category: 'Corporate',
            icon: '👨‍💼',
            title: 'New CTO, New Agenda',
            description: 'The new CTO comes from a cloud-first company and thinks {projectA}\'s edge-computing approach is "outdated." She wants everything moved to the cloud within 18 months.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Embrace the cloud pivot',
                    description: 'Rebuild {projectA} as cloud-native',
                    consequence: 'embrace_cloud',
                    narrativeGood: 'Cloud architecture unlocks new capabilities and scale.',
                    narrativeBad: 'Major rework delays project; edge advantages lost.'
                },
                {
                    label: 'Propose hybrid approach',
                    description: 'Edge processing with cloud backend',
                    consequence: 'hybrid_approach',
                    narrativeGood: 'Hybrid model satisfies CTO while preserving edge benefits.',
                    narrativeBad: 'Complexity of supporting both architectures strains team.'
                },
                {
                    label: 'Push back with data',
                    description: 'Present latency and reliability evidence for edge',
                    consequence: 'pushback_cto',
                    narrativeGood: 'CTO respects evidence-based argument; edge approach validated.',
                    narrativeBad: 'Marked as resistant to change; CTO finds ways to defund project.'
                }
            ]
        },
        {
            id: 'new_erp_system',
            category: 'Corporate',
            icon: '💻',
            title: 'New ERP System Rollout',
            description: 'IT is rolling out a new SAP system that requires all projects to re-enter budgets, timelines, and milestones in a completely different format. The migration will consume 2 weeks of PM time across all projects.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Comply immediately',
                    description: 'Prioritize the migration as requested',
                    consequence: 'comply_erp',
                    narrativeGood: 'Clean migration; better visibility into project finances.',
                    narrativeBad: 'Two weeks of lost productivity; some data integrity issues.'
                },
                {
                    label: 'Request exemption',
                    description: 'Ask for delayed migration until milestone complete',
                    consequence: 'request_exemption',
                    narrativeGood: 'IT grants exemption; project maintains momentum.',
                    narrativeBad: 'IT escalates to CFO; forced compliance with bad timing.'
                },
                {
                    label: 'Delegate to junior staff',
                    description: 'Have analysts handle migration while PMs focus on delivery',
                    consequence: 'delegate_erp',
                    narrativeGood: 'Analysts handle migration competently.',
                    narrativeBad: 'Data entry errors create budget discrepancies that take weeks to fix.'
                }
            ]
        },
        {
            id: 'performance_system_change',
            category: 'Corporate',
            icon: '📋',
            title: 'New Performance System',
            description: 'HR has introduced "OKRs" replacing the old annual review system. Now {projectA} team members must set quarterly objectives aligned to company goals. The team finds it bureaucratic and distracting.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Embrace enthusiastically',
                    description: 'Make OKRs meaningful for the team',
                    consequence: 'embrace_okrs',
                    narrativeGood: 'OKRs actually improve team alignment and focus.',
                    narrativeBad: 'Time spent on OKRs comes at expense of actual work.'
                },
                {
                    label: 'Minimal compliance',
                    description: 'Check the boxes but don\'t let it disrupt work',
                    consequence: 'minimal_okrs',
                    narrativeGood: 'Team maintains focus; OKRs don\'t interfere.',
                    narrativeBad: 'HR flags team for "not taking development seriously."'
                },
                {
                    label: 'Give candid feedback',
                    description: 'Tell HR the system isn\'t working for R&D',
                    consequence: 'feedback_okrs',
                    narrativeGood: 'HR adapts system for R&D teams; becomes case study.',
                    narrativeBad: 'Labelled as "difficult"; team scrutinized more closely.'
                }
            ]
        },
        {
            id: 'cost_cutting_mandate',
            category: 'Corporate',
            icon: '✂️',
            title: 'Cost Cutting Mandate',
            description: 'Finance has mandated 15% budget cuts across all departments. R&D must choose where to cut: headcount, external contractors, equipment, or travel and training.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Cut contractors',
                    description: 'Reduce external spend, keep employees',
                    consequence: 'cut_contractors',
                    narrativeGood: 'Team absorbs contractor work; capability retained.',
                    narrativeBad: 'Specialized work suffers without contractor expertise.'
                },
                {
                    label: 'Freeze hiring and training',
                    description: 'No new hires, no conferences, no courses',
                    consequence: 'freeze_growth',
                    narrativeGood: 'Short-term savings with minimal immediate impact.',
                    narrativeBad: 'Team skills stagnate; key hire vacancy hurts velocity.'
                },
                {
                    label: 'Propose project consolidation',
                    description: 'Merge {projectA} with similar effort to share resources',
                    consequence: 'consolidate_projects',
                    narrativeGood: 'Consolidated project becomes more focused and efficient.',
                    narrativeBad: 'Merged teams clash; worst of both approaches survives.'
                }
            ]
        },
        {
            id: 'reorg_announcement',
            category: 'Corporate',
            icon: '🔀',
            title: 'Reorganization Announced',
            description: 'A major reorg moves {projectA} from the Innovation division to the Product division. New management has different priorities and doesn\'t understand the project\'s exploratory nature.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Adapt to new home',
                    description: 'Reframe project in product terms',
                    consequence: 'adapt_reorg',
                    narrativeGood: 'Product framing actually helps focus and accelerate delivery.',
                    narrativeBad: 'Innovation aspects deprioritized; project becomes incremental.'
                },
                {
                    label: 'Lobby to stay in Innovation',
                    description: 'Make the case for keeping current reporting',
                    consequence: 'lobby_stay',
                    narrativeGood: 'Exception granted; project keeps exploratory mandate.',
                    narrativeBad: 'Seen as political; new Product VP becomes adversarial.'
                },
                {
                    label: 'Accept but negotiate terms',
                    description: 'Move but get commitments on timeline and approach',
                    consequence: 'negotiate_reorg',
                    narrativeGood: 'Clear agreement protects project while building new relationships.',
                    narrativeBad: 'Agreements forgotten within a quarter; back to square one.'
                }
            ]
        },
        {
            id: 'talent_poaching',
            category: 'Corporate',
            icon: '🎣',
            title: 'Competitor Poaching Talent',
            description: 'A competitor is aggressively recruiting ShieldTech engineers, offering 40% raises. Two key {projectA} team members have received offers. HR\'s hands are tied on counter-offers by company policy.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Push for exceptions',
                    description: 'Escalate to CEO for retention packages',
                    consequence: 'push_retention',
                    narrativeGood: 'CEO approves retention bonuses; key talent stays.',
                    narrativeBad: 'Sets precedent; other teams demand same treatment.'
                },
                {
                    label: 'Non-monetary retention',
                    description: 'Offer promotions, interesting work, flexibility',
                    consequence: 'nonmonetary_retain',
                    narrativeGood: 'Team values growth opportunities; most stay.',
                    narrativeBad: 'Money talks; both engineers leave despite promises.'
                },
                {
                    label: 'Let them go gracefully',
                    description: 'Wish them well, start succession planning',
                    consequence: 'graceful_departure',
                    narrativeGood: 'Departures handled well; one returns after 6 months.',
                    narrativeBad: 'Knowledge loss hurts; project momentum disrupted.'
                }
            ]
        },
        {
            id: 'compliance_overhead',
            category: 'Corporate',
            icon: '📝',
            title: 'New Compliance Requirements',
            description: 'Legal has introduced new data governance requirements after a regulatory inquiry. {projectA} must now document all data flows, conduct privacy impact assessments, and get legal sign-off on new features.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Build compliance into process',
                    description: 'Integrate requirements into sprint workflow',
                    consequence: 'integrate_compliance',
                    narrativeGood: 'Privacy-by-design becomes competitive advantage.',
                    narrativeBad: 'Velocity drops 20% from compliance overhead.'
                },
                {
                    label: 'Hire compliance specialist',
                    description: 'Dedicate headcount to handle requirements',
                    consequence: 'hire_compliance',
                    narrativeGood: 'Specialist handles compliance efficiently; team stays focused.',
                    narrativeBad: 'Budget hit for specialist; takes time to become effective.'
                },
                {
                    label: 'Batch compliance reviews',
                    description: 'Quarterly reviews instead of per-feature',
                    consequence: 'batch_compliance',
                    narrativeGood: 'Efficient approach satisfies legal with minimal disruption.',
                    narrativeBad: 'Legal rejects batching; must do per-feature after all.'
                }
            ]
        },
        {
            id: 'board_presentation',
            category: 'Corporate',
            icon: '🎤',
            title: 'Board Presentation Request',
            description: 'The CEO wants you to present {projectA} to the board next week. It\'s a visibility opportunity, but the project isn\'t ready for scrutiny—there are known issues you haven\'t resolved yet.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Present optimistically',
                    description: 'Focus on potential, downplay current issues',
                    consequence: 'present_optimistic',
                    narrativeGood: 'Board impressed; project gets champion among directors.',
                    narrativeBad: 'Board asks tough questions; unresolved issues exposed.'
                },
                {
                    label: 'Present honestly',
                    description: 'Show progress and challenges transparently',
                    consequence: 'present_honest',
                    narrativeGood: 'Board appreciates candor; offers constructive guidance.',
                    narrativeBad: 'Board questions why issues weren\'t fixed; confidence shaken.'
                },
                {
                    label: 'Request postponement',
                    description: 'Ask to present in 6 weeks when issues resolved',
                    consequence: 'postpone_presentation',
                    narrativeGood: 'CEO agrees; extra time allows stronger presentation.',
                    narrativeBad: 'Seen as not ready for prime time; slot given to another project.'
                }
            ]
        },
        {
            id: 'agile_transformation',
            category: 'Corporate',
            icon: '🔄',
            title: 'Agile Transformation Mandate',
            description: 'The COO has decreed that all teams must adopt SAFe (Scaled Agile Framework). Consultants are arriving to "transform" R&D. Your {projectA} team already uses their own lightweight agile approach that works well.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Embrace SAFe fully',
                    description: 'Adopt the framework as prescribed',
                    consequence: 'embrace_safe',
                    narrativeGood: 'SAFe actually improves cross-team coordination.',
                    narrativeBad: 'Bureaucratic overhead slows everything down.'
                },
                {
                    label: 'SAFe on paper only',
                    description: 'Use SAFe terminology but keep current practices',
                    consequence: 'safe_theater',
                    narrativeGood: 'Consultants satisfied; team keeps working effectively.',
                    narrativeBad: 'Discovered during audit; team forced to truly adopt.'
                },
                {
                    label: 'Propose pilot exemption',
                    description: 'Ask to be compared against SAFe teams as control group',
                    consequence: 'pilot_exemption',
                    narrativeGood: 'Exemption granted; your approach becomes model for others.',
                    narrativeBad: 'COO insists on consistency; no exemptions allowed.'
                }
            ]
        },
        {
            id: 'office_relocation',
            category: 'Corporate',
            icon: '🏢',
            title: 'Office Relocation',
            description: 'Facilities is moving the R&D floor to a new "open plan collaboration space." The {projectA} team is concerned about noise and loss of focus areas for deep work.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Embrace the move',
                    description: 'Make the best of the new space',
                    consequence: 'embrace_openplan',
                    narrativeGood: 'Open plan actually improves cross-team collaboration.',
                    narrativeBad: 'Constant interruptions kill deep work; productivity drops.'
                },
                {
                    label: 'Negotiate quiet zones',
                    description: 'Push for dedicated focus rooms',
                    consequence: 'negotiate_quiet',
                    narrativeGood: 'Facilities creates bookable focus rooms; balance achieved.',
                    narrativeBad: 'Token effort; one tiny room shared by 50 people.'
                },
                {
                    label: 'Go hybrid/remote',
                    description: 'Team works from home for focus, office for collaboration',
                    consequence: 'go_hybrid',
                    narrativeGood: 'Hybrid model gives best of both worlds.',
                    narrativeBad: 'Leadership sees it as "not committed"; team viewed skeptically.'
                }
            ]
        },
        
        // STARTUP COLLABORATION DILEMMAS
        {
            id: 'startup_no_track_record',
            category: 'Startup Collaboration',
            icon: '🚀',
            title: 'Promising but Unproven Startup',
            description: 'A 6-month-old startup has impressive tech that could accelerate {projectA}. Their demo is amazing, but they have zero production deployments, no paying customers, and their CTO is 24 years old.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Partner anyway',
                    description: 'Their tech is worth the risk',
                    consequence: 'partner_unproven',
                    narrativeGood: 'Startup delivers; their hunger and agility exceed expectations.',
                    narrativeBad: 'Reality hits hard—tech works in demo, fails at scale.'
                },
                {
                    label: 'Paid proof of concept first',
                    description: 'Small engagement ($0.2M) to validate capability',
                    consequence: 'startup_poc',
                    narrativeGood: 'POC succeeds; confidence to proceed with full integration.',
                    narrativeBad: 'POC reveals gaps; saved us from bigger mistake.'
                },
                {
                    label: 'Wait for them to mature',
                    description: 'Revisit in 12 months when they have customers',
                    consequence: 'wait_startup',
                    narrativeGood: 'Found alternative; startup later implodes anyway.',
                    narrativeBad: 'Competitor partners with them; gains 6-month lead.'
                }
            ]
        },
        {
            id: 'startup_moves_fast',
            category: 'Startup Collaboration',
            icon: '⚡',
            title: 'Startup Moving Too Fast',
            description: 'The startup partner on {projectA} is shipping API changes weekly without documentation or notice. Your team spends half their time chasing breaking changes. "Move fast and break things" is their motto.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Demand stable API',
                    description: 'Require versioning and deprecation policy',
                    consequence: 'demand_stability',
                    narrativeGood: 'Startup agrees to enterprise-grade API practices.',
                    narrativeBad: 'Startup frustrated by "corporate bureaucracy"; relationship sours.'
                },
                {
                    label: 'Assign integration engineer',
                    description: 'Dedicate someone to absorb the chaos',
                    consequence: 'absorb_chaos',
                    narrativeGood: 'Integration engineer becomes expert; shields team from churn.',
                    narrativeBad: 'Burnout risk; integration engineer becomes single point of failure.'
                },
                {
                    label: 'Fork and stabilize',
                    description: 'Take their code and maintain our own version',
                    consequence: 'fork_startup',
                    narrativeGood: 'Stable fork lets team focus on features.',
                    narrativeBad: 'Miss their improvements; fork diverges, becoming maintenance burden.'
                }
            ]
        },
        {
            id: 'startup_ip_careless',
            category: 'Startup Collaboration',
            icon: '😬',
            title: 'Startup IP Carelessness',
            description: 'Your startup partner casually mentioned they\'re using the same code in {projectA} that they developed for a competitor last year. Their founder says "code is just code—we own it."',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Demand IP audit',
                    description: 'Full review of code provenance before continuing',
                    consequence: 'ip_audit',
                    narrativeGood: 'Audit reveals code is clean; founder was just sloppy with words.',
                    narrativeBad: 'Audit finds problems; 3-month delay to rewrite tainted code.'
                },
                {
                    label: 'Require clean-room rewrite',
                    description: 'They rebuild from scratch with documentation',
                    consequence: 'cleanroom_rewrite',
                    narrativeGood: 'Clean-room version is actually better designed.',
                    narrativeBad: 'Expensive delay; startup bills for rewrite time.'
                },
                {
                    label: 'Get indemnification',
                    description: 'They guarantee to cover any IP claims',
                    consequence: 'indemnification',
                    narrativeGood: 'Legal protection gives confidence to proceed.',
                    narrativeBad: 'Startup\'s indemnification is worthless—they have no assets.'
                }
            ]
        },
        {
            id: 'startup_late_delivery',
            category: 'Startup Collaboration',
            icon: '⏰',
            title: 'Startup Misses Every Deadline',
            description: 'The startup has missed three consecutive delivery milestones for {projectA} components. Each time there\'s a plausible excuse. They\'re now 8 weeks behind, and your launch date is at risk.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Give final ultimatum',
                    description: 'One more miss and we terminate',
                    consequence: 'startup_ultimatum',
                    narrativeGood: 'Ultimatum focuses minds; they finally deliver.',
                    narrativeBad: 'They miss again; now 12 weeks behind with no alternative.'
                },
                {
                    label: 'Embed our engineer',
                    description: 'Send someone to work from their office',
                    consequence: 'embed_engineer',
                    narrativeGood: 'Embedded engineer unblocks issues; delivery accelerates.',
                    narrativeBad: 'Our engineer reports chaos worse than expected.'
                },
                {
                    label: 'Parallel path with backup',
                    description: 'Start alternative development while they continue',
                    consequence: 'parallel_backup',
                    narrativeGood: 'Backup ready when startup misses again.',
                    narrativeBad: 'Expensive duplication; startup actually delivers, wasting backup effort.'
                }
            ]
        },
        {
            id: 'startup_acquihire_risk',
            category: 'Startup Collaboration',
            icon: '💰',
            title: 'Startup Acquisition Rumors',
            description: 'Rumors say Google is acquiring your startup partner. If true, {projectA}\'s critical dependency could become unavailable or absorbed into a competitor\'s ecosystem. The startup won\'t confirm or deny.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Accelerate integration',
                    description: 'Get as much value as possible before deal closes',
                    consequence: 'accelerate_integration',
                    narrativeGood: 'Integration completed before acquisition; dependency reduced.',
                    narrativeBad: 'Rushed integration creates technical debt.'
                },
                {
                    label: 'Negotiate source code escrow',
                    description: 'Get access to code if they\'re acquired',
                    consequence: 'source_escrow',
                    narrativeGood: 'Escrow agreement protects us if acquisition happens.',
                    narrativeBad: 'Startup refuses; says it would kill the deal.'
                },
                {
                    label: 'Start replacing immediately',
                    description: 'Begin migration to alternative before it\'s too late',
                    consequence: 'preemptive_replace',
                    narrativeGood: 'Migration complete when acquisition announced.',
                    narrativeBad: 'Acquisition never happens; wasted effort replacing good partner.'
                }
            ]
        },
        {
            id: 'startup_pivot',
            category: 'Startup Collaboration',
            icon: '🔄',
            title: 'Startup Pivots Away',
            description: 'Your startup partner just announced they\'re pivoting from B2B to consumer. The API {projectA} depends on is being "deprecated" in 6 months. They suggest you "transition to the new platform."',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Negotiate extended support',
                    description: 'Pay for them to maintain B2B API longer',
                    consequence: 'extended_support',
                    narrativeGood: 'Extended support buys time for proper migration.',
                    narrativeBad: 'Support is expensive and half-hearted.'
                },
                {
                    label: 'Take over the B2B product',
                    description: 'License or acquire the deprecated platform',
                    consequence: 'acquire_deprecated',
                    narrativeGood: 'Acquired platform gives full control.',
                    narrativeBad: 'Maintenance burden without their expertise.'
                },
                {
                    label: 'Accelerate replacement',
                    description: 'Find alternative within 6-month window',
                    consequence: 'rapid_replacement',
                    narrativeGood: 'New vendor actually better than original.',
                    narrativeBad: 'Rushed evaluation leads to poor choice.'
                }
            ]
        },
        {
            id: 'startup_runway',
            category: 'Startup Collaboration',
            icon: '📉',
            title: 'Startup Running Out of Cash',
            description: 'Your startup partner\'s CFO quietly mentioned they have 4 months of runway. They\'re fundraising but nothing is certain. {projectA} relies on their technology.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Prepay for services',
                    description: 'Advance $0.6M to extend their runway',
                    consequence: 'prepay_startup',
                    narrativeGood: 'Prepayment helps them survive; they raise funding.',
                    narrativeBad: 'They still fail; prepayment lost.'
                },
                {
                    label: 'Strategic investment',
                    description: 'Take equity stake to ensure survival',
                    consequence: 'strategic_invest',
                    narrativeGood: 'Investment saves them; we get upside when they succeed.',
                    narrativeBad: 'Equity worthless when they fail anyway.'
                },
                {
                    label: 'Execute exit plan',
                    description: 'Begin migrating away before collapse',
                    consequence: 'exit_startup',
                    narrativeGood: 'Migration complete when they shut down.',
                    narrativeBad: 'They survive and thrive; we look disloyal.'
                }
            ]
        },
        
        // AI & RESPONSIBLE TECHNOLOGY DILEMMAS
        {
            id: 'ai_bias_discovered',
            category: 'AI & Ethics',
            icon: '⚖️',
            title: 'AI Bias Discovered',
            description: 'Testing reveals {projectA}\'s AI model has significantly higher error rates for certain demographic groups. The bias isn\'t intentional, but it\'s measurable. Launch is in 3 weeks.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Delay for retraining',
                    description: 'Fix the bias before launch',
                    consequence: 'delay_retrain',
                    narrativeGood: 'Retrained model is fair and performs well.',
                    narrativeBad: '8-week delay; competitor launches first.'
                },
                {
                    label: 'Launch with disclosure',
                    description: 'Document limitation, commit to fix in update',
                    consequence: 'launch_disclose',
                    narrativeGood: 'Transparency appreciated; update fixes issue quickly.',
                    narrativeBad: 'Press picks up "biased AI" story; PR nightmare.'
                },
                {
                    label: 'Limit deployment scope',
                    description: 'Only deploy where bias doesn\'t affect outcomes',
                    consequence: 'limit_scope',
                    narrativeGood: 'Careful deployment avoids harm while fixing issue.',
                    narrativeBad: 'Limited scope means limited revenue.'
                }
            ]
        },
        {
            id: 'ai_transparency_demand',
            category: 'AI & Ethics',
            icon: '🔍',
            title: 'Customer Demands AI Transparency',
            description: 'A major enterprise customer for {projectA} is demanding full explainability for all AI decisions. They want to audit our model. Revealing architecture could expose competitive advantages.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Full transparency',
                    description: 'Open the black box completely',
                    consequence: 'full_transparency',
                    narrativeGood: 'Customer becomes advocate; transparency becomes selling point.',
                    narrativeBad: 'Competitor learns our approach; advantage eroded.'
                },
                {
                    label: 'Explainability layer only',
                    description: 'Add interpretable explanations without revealing model',
                    consequence: 'explain_layer',
                    narrativeGood: 'Customer satisfied with explanations; IP protected.',
                    narrativeBad: 'Explanations don\'t satisfy auditors; deal stalls.'
                },
                {
                    label: 'Decline the requirement',
                    description: 'Our model is proprietary; take it or leave it',
                    consequence: 'decline_transparency',
                    narrativeGood: 'Customer accepts; others don\'t ask either.',
                    narrativeBad: 'Customer walks; regulatory pressure increases.'
                }
            ]
        },
        {
            id: 'ai_regulation_coming',
            category: 'AI & Ethics',
            icon: '📜',
            title: 'AI Regulation Looming',
            description: 'Draft AI regulations would require {projectA} to register as "high-risk AI," conduct impact assessments, and maintain human oversight. Compliance would add 20% to costs.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Proactive compliance',
                    description: 'Build compliance in now before required',
                    consequence: 'proactive_comply',
                    narrativeGood: 'Early compliance becomes competitive advantage.',
                    narrativeBad: 'Regulations change; compliance work wasted.'
                },
                {
                    label: 'Wait and see',
                    description: 'Regulations may not pass or may change',
                    consequence: 'wait_regulation',
                    narrativeGood: 'Regulations watered down; minimal changes needed.',
                    narrativeBad: 'Strict rules pass; scramble to comply.'
                },
                {
                    label: 'Redesign to avoid scope',
                    description: 'Modify architecture to fall outside "high-risk" definition',
                    consequence: 'avoid_regulation',
                    narrativeGood: 'Clever design avoids regulatory burden.',
                    narrativeBad: 'Regulator sees through workaround; penalties threatened.'
                }
            ]
        },
        {
            id: 'ai_training_data_consent',
            category: 'AI & Ethics',
            icon: '📋',
            title: 'Training Data Consent Question',
            description: 'Legal has flagged that {projectA}\'s AI was trained on customer data collected before AI training was mentioned in the privacy policy. It\'s probably fine, but there\'s risk.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Retrain on consented data',
                    description: 'Only use data with explicit AI consent',
                    consequence: 'retrain_consent',
                    narrativeGood: 'Clean training data; unassailable compliance position.',
                    narrativeBad: 'Much smaller dataset; model performance degrades.'
                },
                {
                    label: 'Get retroactive consent',
                    description: 'Update policy and ask users to re-consent',
                    consequence: 'retroactive_consent',
                    narrativeGood: 'Most users consent; good data retained.',
                    narrativeBad: 'Consent request raises questions; some users delete data.'
                },
                {
                    label: 'Accept legal risk',
                    description: 'Proceed with legal\'s "probably fine" assessment',
                    consequence: 'accept_consent_risk',
                    narrativeGood: 'No issues arise; risk was overblown.',
                    narrativeBad: 'Class action lawsuit filed; expensive settlement.'
                }
            ]
        },
        {
            id: 'ai_hallucination',
            category: 'AI & Ethics',
            icon: '👻',
            title: 'AI Hallucination in Production',
            description: '{projectA}\'s AI assistant confidently gave a customer incorrect safety information. No one was hurt, but the potential was there. The model sometimes "hallucinates" convincingly.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Add human review',
                    description: 'All AI responses reviewed before sending',
                    consequence: 'human_review',
                    narrativeGood: 'Human review catches errors; trust rebuilt.',
                    narrativeBad: 'Review bottleneck kills response time; defeats AI purpose.'
                },
                {
                    label: 'Implement guardrails',
                    description: 'Technical limits on what AI can claim',
                    consequence: 'ai_guardrails',
                    narrativeGood: 'Guardrails prevent dangerous responses effectively.',
                    narrativeBad: 'Guardrails too restrictive; AI becomes unhelpfully cautious.'
                },
                {
                    label: 'Add prominent disclaimers',
                    description: '"AI-generated, verify important information"',
                    consequence: 'ai_disclaimers',
                    narrativeGood: 'Disclaimers manage expectations appropriately.',
                    narrativeBad: 'Disclaimers undermine trust; "why use AI if unreliable?"'
                }
            ]
        },
        {
            id: 'ai_job_displacement',
            category: 'AI & Ethics',
            icon: '👥',
            title: 'AI Automation Displaces Workers',
            description: '{projectA}\'s AI would automate work currently done by 30 employees at customer sites. Customer loves the efficiency, but press is writing about "job-killing AI." Your sales team is nervous.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Position as augmentation',
                    description: 'Market as "AI that helps workers, not replaces them"',
                    consequence: 'augmentation_message',
                    narrativeGood: 'Augmentation story resonates; employees become advocates.',
                    narrativeBad: 'Customers see through spin; they want the cost savings.'
                },
                {
                    label: 'Offer transition support',
                    description: 'Include retraining programs in the package',
                    consequence: 'transition_support',
                    narrativeGood: 'Transition programs become differentiator.',
                    narrativeBad: 'Adds cost; competitors win on price.'
                },
                {
                    label: 'Let customers decide',
                    description: 'We make the tool; how they use it is their choice',
                    consequence: 'customer_choice',
                    narrativeGood: 'Pragmatic approach; market rewards efficiency.',
                    narrativeBad: 'ShieldTech branded as job-killer; talent avoids us.'
                }
            ]
        },
        {
            id: 'ai_deepfake_misuse',
            category: 'AI & Ethics',
            icon: '🎭',
            title: 'AI Feature Enables Misuse',
            description: '{projectA}\'s face recognition could easily be adapted for deepfake detection—or deepfake creation. A security researcher publicly pointed this out. Do we restrict the API?',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Restrict API access',
                    description: 'Limit who can use sensitive capabilities',
                    consequence: 'restrict_api',
                    narrativeGood: 'Responsible restriction praised by ethics community.',
                    narrativeBad: 'Legitimate users frustrated; workarounds emerge anyway.'
                },
                {
                    label: 'Add usage monitoring',
                    description: 'Detect and block potential misuse patterns',
                    consequence: 'usage_monitoring',
                    narrativeGood: 'Monitoring catches bad actors; good actors unaffected.',
                    narrativeBad: 'Monitoring creates privacy concerns; expensive to maintain.'
                },
                {
                    label: 'Publish defense tools',
                    description: 'Release deepfake detection to counter misuse',
                    consequence: 'publish_defense',
                    narrativeGood: 'Defense tools establish us as responsible AI leader.',
                    narrativeBad: 'Detection tools help bad actors improve their fakes.'
                }
            ]
        },
        {
            id: 'ai_carbon_footprint',
            category: 'AI & Ethics',
            icon: '🌍',
            title: 'AI Carbon Footprint Criticism',
            description: 'An NGO report highlights that {projectA}\'s large AI model has a significant carbon footprint from training and inference. They\'re calling for "sustainable AI" practices.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Switch to efficient models',
                    description: 'Use smaller, more efficient AI architectures',
                    consequence: 'efficient_models',
                    narrativeGood: 'Efficient models perform nearly as well; sustainability win.',
                    narrativeBad: 'Performance degradation noticeable; customers complain.'
                },
                {
                    label: 'Purchase carbon offsets',
                    description: 'Offset AI emissions through certified programs',
                    consequence: 'carbon_offsets',
                    narrativeGood: 'Carbon neutral AI becomes marketing advantage.',
                    narrativeBad: 'Offsets seen as greenwashing; criticism continues.'
                },
                {
                    label: 'Challenge the methodology',
                    description: 'Dispute the NGO\'s carbon calculations',
                    consequence: 'challenge_ngo',
                    narrativeGood: 'Independent review shows NGO overstated impact.',
                    narrativeBad: 'Public fight makes us look defensive; Streisand effect.'
                }
            ]
        },
        {
            id: 'ai_competitive_ethics',
            category: 'AI & Ethics',
            icon: '🏁',
            title: 'Competitor Cuts Ethical Corners',
            description: 'A competitor launched an AI product similar to {projectA} with none of our safety measures. They\'re faster and cheaper. Sales is asking why we "handicap ourselves with ethics."',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Stay the course',
                    description: 'Our ethics are non-negotiable',
                    consequence: 'ethics_firm',
                    narrativeGood: 'Competitor\'s product causes incident; our ethics validated.',
                    narrativeBad: 'Competitor takes market share; ethics feels like luxury.'
                },
                {
                    label: 'Offer "lite" version',
                    description: 'Faster product with fewer safety checks for low-risk uses',
                    consequence: 'ethics_lite',
                    narrativeGood: 'Tiered approach captures both markets.',
                    narrativeBad: 'Lite version has incident; "SafetyTech isn\'t so safe" headlines.'
                },
                {
                    label: 'Advocate for regulation',
                    description: 'Push for rules that would constrain competitor too',
                    consequence: 'advocate_regulation',
                    narrativeGood: 'Regulation passes; level playing field restored.',
                    narrativeBad: 'Regulation slow; competitor entrenched by the time it passes.'
                }
            ]
        }
    ];
    
    // Track dilemma history
    function checkForManagementDilemma() {
        // R&D dilemmas are project-level decisions (frequent, 1-2 per quarter)
        // These always involve meaningful choices about your portfolio
        
        // Skip dilemmas for Q4 and Q5 - players are transitioning to Year 2
        if (gameState.currentQuarter >= 4) return null;
        
        // Need at least one active project
        if (gameState.activeProjects.length === 0) return null;
        
        // Don't repeat recent dilemmas
        const recentDilemmaIds = (gameState.dilemmaHistory || []).slice(-8).map(d => d.id);
        const availableDilemmas = managementDilemmas.filter(d => !recentDilemmaIds.includes(d.id));
        
        if (availableDilemmas.length === 0) return null;
        
        // Filter by project requirements
        const validDilemmas = availableDilemmas.filter(d => {
            if (d.requiresProjects === 2) return gameState.activeProjects.length >= 2;
            return gameState.activeProjects.length >= 1;
        });
        
        if (validDilemmas.length === 0) return null;
        
        // 90% chance of at least one dilemma per quarter
        const dilemmas = [];
        if (Math.random() < 0.90) {
            const shuffled = shuffleArray([...validDilemmas]);
            dilemmas.push(shuffled[0]);
            
            // 40% chance of a second dilemma (if enough projects and dilemmas)
            if (Math.random() < 0.40 && shuffled.length > 1 && gameState.activeProjects.length >= 2) {
                dilemmas.push(shuffled[1]);
            }
        }
        
        if (dilemmas.length === 0) return null;
        
        // Assign random projects to each dilemma
        return dilemmas.map(dilemma => {
            const shuffledProjects = shuffleArray([...gameState.activeProjects]);
            return {
                ...dilemma,
                projectA: shuffledProjects[0],
                projectB: shuffledProjects[1] || shuffledProjects[0]
            };
        });
    }
    
    function showManagementDilemma(dilemma, callback) {
        gameState.currentDilemma = dilemma;
        gameState.pendingDilemmaCallback = callback;
        
        // Replace placeholders with actual project names
        const replaceProjectNames = (text) => {
            return text
                .replace(/{projectA}/g, dilemma.projectA.name)
                .replace(/{projectB}/g, dilemma.projectB?.name || dilemma.projectA.name);
        };
        
        const modalHtml = `
            <div class="dilemma-modal-overlay" id="dilemma-modal">
                <div class="dilemma-modal">
                    <div class="dilemma-modal-header">
                        <div class="dilemma-icon">${dilemma.icon}</div>
                        <div class="dilemma-category">${dilemma.category}</div>
                        <h2 class="dilemma-title">${replaceProjectNames(dilemma.title)}</h2>
                    </div>
                    <div class="dilemma-modal-body">
                        <p class="dilemma-description">${replaceProjectNames(dilemma.description)}</p>
                        
                        <div class="dilemma-choices">
                            ${dilemma.choices.map((choice, index) => `
                                <button class="dilemma-choice" onclick="selectDilemmaChoice(${index})">
                                    <div class="choice-label">${replaceProjectNames(choice.label)}</div>
                                    <div class="choice-description">${replaceProjectNames(choice.description)}</div>
                                </button>
                            `).join('')}
                        </div>
                        
                        <div class="dilemma-hint">
                            <span class="hint-icon">💭</span>
                            <span class="hint-text">There's no perfect answer here—trust your judgment.</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        const container = document.createElement('div');
        container.id = 'dilemma-modal-container';
        container.innerHTML = modalHtml;
        document.body.appendChild(container);
    }
    
    function selectDilemmaChoice(choiceIndex) {
        const dilemma = gameState.currentDilemma;
        const choice = dilemma.choices[choiceIndex];
        
        // Play choice sound
        SoundManager.play('select');
        
        // Record the decision
        if (!gameState.dilemmaHistory) gameState.dilemmaHistory = [];
        gameState.dilemmaHistory.push({
            id: dilemma.id,
            quarter: gameState.currentQuarter,
            choice: choiceIndex,
            projectA: dilemma.projectA.id,
            projectB: dilemma.projectB?.id
        });
        
        // Apply consequences
        applyDilemmaConsequence(dilemma, choice);
        
        // Show outcome
        showDilemmaOutcome(dilemma, choice);
    }
    
    function applyDilemmaConsequence(dilemma, choice) {
        const projectA = gameState.activeProjects.find(p => p.id === dilemma.projectA.id);
        const projectB = dilemma.projectB ? gameState.activeProjects.find(p => p.id === dilemma.projectB.id) : null;
        
        switch (choice.consequence) {
            case 'projectA_boost':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.10);
                if (projectB) projectB.successProb = Math.max(0.10, projectB.successProb - 0.08);
                break;
            case 'projectB_boost':
                if (projectB) projectB.successProb = Math.min(0.95, projectB.successProb + 0.10);
                if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.08);
                break;
            case 'both_slow':
                if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                if (projectB) projectB.successProb = Math.max(0.10, projectB.successProb - 0.05);
                break;
            case 'budget_hit':
                gameState.budget = Math.max(0, gameState.budget - 0.5);
                break;
            case 'share_tech':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 1);
                if (projectB) projectB.successProb = Math.min(0.95, projectB.successProb + 0.12);
                break;
            case 'no_share':
                // No immediate effect, but narrative notes the missed opportunity
                break;
            case 'paid_share':
                gameState.budget = Math.max(0, gameState.budget - 0.3);
                if (projectB) projectB.successProb = Math.min(0.95, projectB.successProb + 0.08);
                break;
            case 'patent_delay':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 1);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'publish_fast':
                if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                break;
            case 'both_ip':
                gameState.budget = Math.max(0, gameState.budget - 0.2);
                break;
            case 'transfer_star':
                if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.10);
                if (projectB) projectB.successProb = Math.min(0.95, projectB.successProb + 0.12);
                break;
            case 'deny_transfer':
                if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                break;
            case 'delayed_transfer':
                if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.03);
                if (projectB) projectB.successProb = Math.min(0.95, projectB.successProb + 0.05);
                break;
            case 'mediate':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                if (projectB) projectB.successProb = Math.min(0.95, projectB.successProb + 0.05);
                break;
            case 'hr_intervention':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.03);
                }
                break;
            case 'reorg':
                if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.03);
                if (projectB) projectB.successProb = Math.max(0.10, projectB.successProb - 0.03);
                break;
            case 'push_burnout':
                if (Math.random() > 0.4) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.10);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.15);
                }
                break;
            case 'rest_week':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.25);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'contractor_relief':
                gameState.budget = Math.max(0, gameState.budget - 0.4);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.03);
                break;
            case 'merge_projects':
                if (projectA && projectB) {
                    projectA.budget += projectB.budget * 0.5;
                    projectA.successProb = Math.min(0.95, (projectA.successProb + projectB.successProb) / 2 + 0.05);
                    projectB.status = 'merged';
                    gameState.activeProjects = gameState.activeProjects.filter(p => p.id !== projectB.id);
                    if (!gameState.mergedProjects) gameState.mergedProjects = [];
                    gameState.mergedProjects.push(projectB);
                }
                break;
            case 'internal_compete':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.03);
                if (projectB) projectB.successProb = Math.min(0.95, projectB.successProb + 0.03);
                break;
            case 'pick_winner':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                if (projectB) {
                    projectB.status = 'killed';
                    gameState.activeProjects = gameState.activeProjects.filter(p => p.id !== projectB.id);
                    gameState.killedProjects.push({...projectB, killReason: 'Deprioritized in favor of ' + projectA.name});
                }
                break;
            case 'accept_partner':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.15);
                if (projectB) projectB.successProb = Math.max(0.10, projectB.successProb - 0.08);
                break;
            case 'decline_partner':
                break;
            case 'limited_partner':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'add_feature':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 1);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'hold_scope':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.03);
                break;
            case 'custom_build':
                gameState.budget = Math.max(0, gameState.budget - 0.3);
                break;
            case 'shortcut':
                if (Math.random() > 0.6) {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.15);
                }
                break;
            case 'full_test':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.5);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'staged_release':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.25);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.03);
                break;
            case 'accept_intel':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.10);
                break;
            case 'decline_intel':
                break;
            case 'legal_consult':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.03);
                break;
            case 'back_junior':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.15);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.10);
                }
                break;
            case 'back_seniors':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.02);
                break;
            case 'parallel_test':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.5);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'grant_data':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                break;
            case 'deny_data':
                if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                break;
            case 'anonymize_data':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.25);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            
            // IP-specific consequences
            case 'buy_patent':
                gameState.budget = Math.max(0, gameState.budget - 1.2);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.15);
                break;
            case 'license_patent':
                gameState.budget = Math.max(0, gameState.budget - 0.4);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                break;
            case 'design_around':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 1);
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.08);
                }
                break;
            case 'rush_patent':
                gameState.budget = Math.max(0, gameState.budget - 0.3);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'miss_patent':
                if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.10);
                break;
            case 'provisional_patent':
                gameState.budget = Math.max(0, gameState.budget - 0.1);
                break;
            case 'emergency_filings':
                gameState.budget = Math.max(0, gameState.budget - 0.5);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.03);
                break;
            case 'assess_damage':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.5);
                break;
            case 'discipline_leaker':
                if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.08);
                break;
            case 'full_international':
                gameState.budget = Math.max(0, gameState.budget - 0.8);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.10);
                break;
            case 'europe_only':
                gameState.budget = Math.max(0, gameState.budget - 0.3);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'accept_gaps':
                if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                break;
            case 'sue_infringer':
                gameState.budget = Math.max(0, gameState.budget - 1.5);
                // High variance outcome
                if (Math.random() > 0.4) {
                    gameState.budget += 2.5; // Win damages
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.10);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                }
                break;
            case 'cease_desist':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                }
                break;
            case 'license_infringer':
                if (Math.random() > 0.4) {
                    gameState.budget += 0.5; // License revenue
                }
                break;
            case 'reinvest_winnings':
                gameState.budget += 2.0;
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.12);
                break;
            case 'patent_warchest':
                gameState.budget += 2.0;
                // Boost all projects slightly
                gameState.activeProjects.forEach(p => {
                    p.successProb = Math.min(0.95, p.successProb + 0.03);
                });
                break;
            case 'spread_winnings':
                gameState.budget += 2.0;
                break;
            case 'patent_process':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'trade_secret':
                // High risk of leak
                if (Math.random() > 0.6) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.12);
                }
                break;
            case 'hybrid_ip':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'argue_novelty':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                } else {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.03);
                }
                break;
            case 'narrow_claims':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'withdraw_publish':
                // Defensive publication - no boost but no penalty
                break;
            
            // Open Innovation consequences
            case 'accept_supplier_coop':
                gameState.budget += 0.8; // Cost savings
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                break;
            case 'negotiate_exclusivity':
                if (Math.random() > 0.5) {
                    gameState.budget += 0.6;
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.10);
                } else {
                    if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 1);
                }
                break;
            case 'inhouse_development':
                gameState.budget = Math.max(0, gameState.budget - 0.5);
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 1);
                break;
            case 'accept_customer_coop':
                gameState.budget += 1.5;
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.10);
                break;
            case 'advisory_only':
                if (Math.random() > 0.4) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                }
                break;
            case 'stay_independent':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.5);
                break;
            case 'full_university_partner':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.12);
                // Some IP risk
                if (Math.random() > 0.7) {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                }
                break;
            case 'sponsored_research':
                gameState.budget = Math.max(0, gameState.budget - 0.4);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.10);
                break;
            case 'hire_graduates':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'join_consortium':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                // Boost all projects slightly due to standards influence
                gameState.activeProjects.forEach(p => {
                    p.successProb = Math.min(0.95, p.successProb + 0.02);
                });
                break;
            case 'observer_status':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.03);
                break;
            case 'proprietary_path':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.08);
                }
                break;
            case 'joint_fix':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.5);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'switch_supplier':
                gameState.budget = Math.max(0, gameState.budget - 0.3);
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 1);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'manual_screening':
                if (Math.random() > 0.6) {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.08);
                }
                break;
            case 'absorb_extensions':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.5);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                break;
            case 'allow_opensource':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'enforce_license':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.10);
                }
                break;
            case 'buyout_jv_ip':
                gameState.budget = Math.max(0, gameState.budget - 0.8);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.10);
                break;
            case 'arbitration':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 1);
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                }
                break;
            case 'cross_license':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.03);
                break;
            case 'opensource_sdk':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.10);
                break;
            case 'source_available':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'keep_proprietary':
                if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.03);
                break;
            case 'acquire_risky':
                gameState.budget = Math.max(0, gameState.budget - 2.0);
                if (Math.random() > 0.4) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.15);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.15);
                    gameState.budget = Math.max(0, gameState.budget - 0.5); // Legal costs
                }
                break;
            case 'acquihire':
                gameState.budget = Math.max(0, gameState.budget - 1.0);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                break;
            case 'walk_away_acquisition':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                }
                break;
            case 'data_exchange':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.12);
                break;
            case 'one_way_data':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                } else {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.03);
                }
                break;
            case 'decline_data_sharing':
                break;
            case 'terminate_partner':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.5);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'orderly_winddown':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                }
                break;
            case 'continue_despite_pivot':
                if (Math.random() > 0.6) {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.10);
                } else {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.03);
                }
                break;
            
            // Corporate tension consequences
            case 'reposition_project':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 1);
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                }
                break;
            case 'argue_exception':
                if (Math.random() > 0.4) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.10);
                }
                break;
            case 'spinout_unit':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.03);
                break;
            case 'embrace_cloud':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 2);
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.10);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                }
                break;
            case 'hybrid_approach':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.5);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'pushback_cto':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.12);
                }
                break;
            case 'comply_erp':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.25);
                break;
            case 'request_exemption':
                if (Math.random() > 0.6) {
                    // Exemption granted
                } else {
                    if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.5);
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.03);
                }
                break;
            case 'delegate_erp':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                }
                break;
            case 'embrace_okrs':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                } else {
                    if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.25);
                }
                break;
            case 'minimal_okrs':
                if (Math.random() > 0.6) {
                    // No impact
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.03);
                }
                break;
            case 'feedback_okrs':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                }
                break;
            case 'cut_contractors':
                gameState.budget += 0.5;
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.08);
                }
                break;
            case 'freeze_growth':
                gameState.budget += 0.3;
                if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                break;
            case 'consolidate_projects':
                if (dilemma.projectB && gameState.activeProjects.find(p => p.id === dilemma.projectB.id)) {
                    const projB = gameState.activeProjects.find(p => p.id === dilemma.projectB.id);
                    if (projectA && projB) {
                        projectA.budget += projB.budget * 0.4;
                        gameState.activeProjects = gameState.activeProjects.filter(p => p.id !== projB.id);
                        if (!gameState.mergedProjects) gameState.mergedProjects = [];
                        gameState.mergedProjects.push(projB);
                    }
                }
                break;
            case 'adapt_reorg':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                }
                break;
            case 'lobby_stay':
                if (Math.random() > 0.6) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.08);
                }
                break;
            case 'negotiate_reorg':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                }
                break;
            case 'push_retention':
                gameState.budget = Math.max(0, gameState.budget - 0.3);
                if (Math.random() > 0.3) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                }
                break;
            case 'nonmonetary_retain':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.03);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.10);
                }
                break;
            case 'graceful_departure':
                if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.08);
                break;
            case 'integrate_compliance':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.5);
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                }
                break;
            case 'hire_compliance':
                gameState.budget = Math.max(0, gameState.budget - 0.4);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.03);
                break;
            case 'batch_compliance':
                if (Math.random() > 0.6) {
                    // Efficient
                } else {
                    if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.5);
                }
                break;
            case 'present_optimistic':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.10);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.08);
                }
                break;
            case 'present_honest':
                if (Math.random() > 0.4) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                }
                break;
            case 'postpone_presentation':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                }
                break;
            case 'embrace_safe':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                } else {
                    if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.5);
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                }
                break;
            case 'safe_theater':
                if (Math.random() > 0.6) {
                    // Get away with it
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                    if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.5);
                }
                break;
            case 'pilot_exemption':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                    // Boost other projects too as approach spreads
                    gameState.activeProjects.forEach(p => {
                        p.successProb = Math.min(0.95, p.successProb + 0.02);
                    });
                } else {
                    if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.5);
                }
                break;
            case 'embrace_openplan':
                if (Math.random() > 0.6) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.03);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.08);
                }
                break;
            case 'negotiate_quiet':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.03);
                }
                break;
            case 'go_hybrid':
                if (Math.random() > 0.4) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.03);
                }
                break;
            
            // Startup collaboration consequences
            case 'partner_unproven':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.12);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.15);
                }
                break;
            case 'startup_poc':
                gameState.budget = Math.max(0, gameState.budget - 0.2);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'wait_startup':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.08);
                }
                break;
            case 'demand_stability':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                }
                break;
            case 'absorb_chaos':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.03);
                break;
            case 'fork_startup':
                if (Math.random() > 0.6) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                } else {
                    if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.5);
                }
                break;
            case 'ip_audit':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.5);
                if (Math.random() > 0.6) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                } else {
                    if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.5);
                }
                break;
            case 'cleanroom_rewrite':
                gameState.budget = Math.max(0, gameState.budget - 0.3);
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 1);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'indemnification':
                if (Math.random() > 0.7) {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.10);
                }
                break;
            case 'startup_ultimatum':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                } else {
                    if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 1);
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                }
                break;
            case 'embed_engineer':
                if (Math.random() > 0.4) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.10);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                }
                break;
            case 'parallel_backup':
                gameState.budget = Math.max(0, gameState.budget - 0.4);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'accelerate_integration':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'source_escrow':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                }
                break;
            case 'preemptive_replace':
                gameState.budget = Math.max(0, gameState.budget - 0.3);
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.5);
                break;
            case 'extended_support':
                gameState.budget = Math.max(0, gameState.budget - 0.4);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.03);
                break;
            case 'acquire_deprecated':
                gameState.budget = Math.max(0, gameState.budget - 0.5);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                break;
            case 'rapid_replacement':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.08);
                }
                break;
            case 'prepay_startup':
                gameState.budget = Math.max(0, gameState.budget - 0.6);
                if (Math.random() > 0.4) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                } else {
                    // Lost prepayment
                }
                break;
            case 'strategic_invest':
                gameState.budget = Math.max(0, gameState.budget - 0.8);
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.10);
                    gameState.budget += 0.5; // Return on investment
                }
                break;
            case 'exit_startup':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.5);
                if (Math.random() > 0.4) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                }
                break;
            
            // AI & Ethics consequences
            case 'delay_retrain':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 1.5);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                break;
            case 'launch_disclose':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.12);
                }
                break;
            case 'limit_scope':
                if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                break;
            case 'full_transparency':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.10);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                }
                break;
            case 'explain_layer':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.5);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'decline_transparency':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.10);
                }
                break;
            case 'proactive_comply':
                gameState.budget = Math.max(0, gameState.budget - 0.3);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                break;
            case 'wait_regulation':
                if (Math.random() > 0.5) {
                    // Regulations mild
                } else {
                    if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 1);
                    gameState.budget = Math.max(0, gameState.budget - 0.4);
                }
                break;
            case 'avoid_regulation':
                if (Math.random() > 0.6) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.10);
                    gameState.budget = Math.max(0, gameState.budget - 0.3);
                }
                break;
            case 'retrain_consent':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 1);
                if (Math.random() > 0.4) {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                }
                break;
            case 'retroactive_consent':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.25);
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.03);
                }
                break;
            case 'accept_consent_risk':
                if (Math.random() > 0.7) {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.15);
                    gameState.budget = Math.max(0, gameState.budget - 0.8);
                }
                break;
            case 'human_review':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.5);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'ai_guardrails':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.03);
                }
                break;
            case 'ai_disclaimers':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.03);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                }
                break;
            case 'augmentation_message':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.03);
                }
                break;
            case 'transition_support':
                gameState.budget = Math.max(0, gameState.budget - 0.3);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'customer_choice':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.08);
                }
                break;
            case 'restrict_api':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.03);
                break;
            case 'usage_monitoring':
                gameState.budget = Math.max(0, gameState.budget - 0.2);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'publish_defense':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.03);
                }
                break;
            case 'efficient_models':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                }
                break;
            case 'carbon_offsets':
                gameState.budget = Math.max(0, gameState.budget - 0.2);
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                }
                break;
            case 'challenge_ngo':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.08);
                }
                break;
            case 'ethics_firm':
                if (Math.random() > 0.4) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.10);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.08);
                }
                break;
            case 'ethics_lite':
                if (Math.random() > 0.6) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.15);
                }
                break;
            case 'advocate_regulation':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.5);
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                    // Boost all projects from level playing field
                    gameState.activeProjects.forEach(p => {
                        p.successProb = Math.min(0.95, p.successProb + 0.02);
                    });
                }
                break;
        }
    }
    
    function showDilemmaOutcome(dilemma, choice) {
        const isPositive = Math.random() > 0.4;
        const narrative = isPositive ? choice.narrativeGood : choice.narrativeBad;
        
        // Play outcome sound
        SoundManager.play(isPositive ? 'success' : 'warning');
        
        const replaceProjectNames = (text) => {
            return text
                .replace(/{projectA}/g, dilemma.projectA.name)
                .replace(/{projectB}/g, dilemma.projectB?.name || dilemma.projectA.name);
        };
        
        const outcomeHtml = `
            <div class="dilemma-outcome-overlay" id="dilemma-outcome">
                <div class="dilemma-outcome-modal">
                    <div class="outcome-header ${isPositive ? 'positive' : 'mixed'}">
                        <div class="outcome-icon">${isPositive ? '✅' : '⚠️'}</div>
                        <h3>Decision Made</h3>
                    </div>
                    <div class="outcome-body">
                        <p class="outcome-choice"><strong>You chose:</strong> ${replaceProjectNames(choice.label)}</p>
                        <p class="outcome-narrative">${replaceProjectNames(narrative)}</p>
                    </div>
                    <button class="outcome-continue-btn" onclick="closeDilemmaOutcome()">
                        Continue →
                    </button>
                </div>
            </div>
        `;
        
        const choiceContainer = document.getElementById('dilemma-modal-container');
        if (choiceContainer) choiceContainer.remove();
        
        const outcomeContainer = document.createElement('div');
        outcomeContainer.id = 'dilemma-outcome-container';
        outcomeContainer.innerHTML = outcomeHtml;
        document.body.appendChild(outcomeContainer);
    }
    
    function closeDilemmaOutcome() {
        const container = document.getElementById('dilemma-outcome-container');
        if (container) container.remove();
        
        if (gameState.pendingDilemmaCallback) {
            gameState.pendingDilemmaCallback();
            gameState.pendingDilemmaCallback = null;
        }
    }
    
    // ============================================
    // CORPORATE EVENT FUNCTIONS
    // ============================================
    
    function checkForCorporateEvent() {
        // Corporate events are company-wide news (less frequent, ~35% per quarter)
        // These are "acknowledge" style events that set context
        
        // Skip events for Q4 - players are about to transition to Year 2
        if (gameState.currentQuarter >= 4) return null;
        
        if (Math.random() > 0.35) return null;
        
        // Don't repeat events that happened recently
        const recentEventIds = gameState.eventHistory.slice(-6).map(e => e.id);
        const availableEvents = corporateEvents.filter(e => !recentEventIds.includes(e.id));
        
        if (availableEvents.length === 0) return null;
        
        // Select one random event
        const event = availableEvents[Math.floor(Math.random() * availableEvents.length)];
        return [event]; // Return as array for consistency
    }
    
    function showCorporateEvent(event, callback) {
        gameState.currentEvent = event;
        gameState.pendingEventCallback = callback;
        
        // Update modal content
        const header = document.getElementById('event-modal-header');
        header.className = 'event-modal-header ' + event.tone;
        
        document.getElementById('event-icon').textContent = event.icon;
        document.getElementById('event-category').textContent = event.category;
        document.getElementById('event-title').textContent = event.title;
        document.getElementById('event-description').textContent = event.description;
        
        const effectText = document.getElementById('event-effect');
        effectText.textContent = event.effectText;
        effectText.className = 'event-effect-text ' + event.tone;
        
        // Duration text
        const durationEl = document.getElementById('event-duration');
        if (event.duration === 'instant') {
            durationEl.innerHTML = '<span class="event-duration-icon">⚡</span><span>Immediate effect</span>';
        } else if (event.duration === 'permanent') {
            durationEl.innerHTML = '<span class="event-duration-icon">♾️</span><span>Permanent effect</span>';
        } else {
            durationEl.innerHTML = `<span class="event-duration-icon">⏱️</span><span>Effect lasts ${event.duration}</span>`;
        }
        
        // Button style
        const btn = document.getElementById('event-acknowledge-btn');
        btn.className = 'event-acknowledge-btn ' + event.tone;
        
        // Show modal
        document.getElementById('corporate-event-modal').classList.remove('hidden');
    }
    
    function acknowledgeEvent() {
        const event = gameState.currentEvent;
        
        // Apply the event effect
        if (event && event.apply) {
            event.apply(gameState);
        }
        
        // Record in history
        gameState.eventHistory.push({
            id: event.id,
            title: event.title,
            quarter: gameState.currentQuarter,
            tone: event.tone
        });
        
        // Hide modal
        document.getElementById('corporate-event-modal').classList.add('hidden');
        gameState.currentEvent = null;
        
        // Execute callback (continue to quarterly review)
        if (gameState.pendingEventCallback) {
            gameState.pendingEventCallback();
            gameState.pendingEventCallback = null;
        }
    }
    
    function processActiveEffects() {
        // Decrement and remove expired effects
        gameState.activeEffects = gameState.activeEffects.filter(effect => {
            effect.remaining--;
            return effect.remaining > 0;
        });
        
        // Apply ongoing effect impacts
        gameState.activeEffects.forEach(effect => {
            if (effect.type === 'recession') {
                gameState.activeProjects.forEach(p => {
                    if (p.riskProfile === 'low' || p.archetype?.includes('value') || p.archetype?.includes('niche')) {
                        p.successProb = Math.max(0.2, p.successProb - 0.05);
                    }
                });
            }
            if (effect.type === 'amazon_competition') {
                gameState.activeProjects.forEach(p => {
                    if (p.archetype?.includes('value') || p.archetype?.includes('price_fighter')) {
                        p.successProb = Math.max(0.2, p.successProb - 0.05);
                    }
                });
            }
        });
    }
    
    function getActiveEffectsBadge() {
        if (gameState.activeEffects.length === 0) return '';
        
        const effect = gameState.activeEffects[0];
        let text = '';
        let tone = 'neutral';
        
        if (effect.type === 'roi_scrutiny') { text = '📊 ROI Scrutiny'; tone = 'neutral'; }
        if (effect.type === 'budget_freeze') { text = '❄️ Budget Frozen'; tone = 'negative'; }
        if (effect.type === 'recession') { text = '📉 Recession'; tone = 'negative'; }
        if (effect.type === 'amazon_competition') { text = '📦 Amazon Pressure'; tone = 'negative'; }
        if (effect.type === 'high_interest') { text = '🏦 High Interest'; tone = 'neutral'; }
        
        return `<span class="event-active-badge ${tone}">${text}</span>`;
    }
    
    // ============================================
    // PROJECT LEADS DATABASE
    // ============================================
    
    const projectLeads = [
        {
            id: 'vikram_shah',
            name: 'Vikram Shah',
            initials: 'VS',
            avatarColor: '#2563eb',
            role: 'Principal Engineer',
            team: 'Platform',
            yearsAtCompany: 7,
            background: 'IIT Bombay → Amazon (4 years) → ShieldTech. Built AWS IoT integrations at Amazon before joining to lead ShieldTech\'s connected device platform.',
            cv: [
                { year: '2017-now', role: 'Principal Engineer, ShieldTech', detail: 'Platform architecture lead' },
                { year: '2013-2017', role: 'SDE III, Amazon', detail: 'AWS IoT team, device shadows' },
                { year: '2013', role: 'B.Tech, IIT Bombay', detail: 'Computer Science' }
            ],
            pastProjects: [
                { name: 'ShieldOS 2.0', outcome: 'success', year: 2022, note: 'Delivered on time, 40% performance improvement' },
                { name: 'Matter Protocol Integration', outcome: 'success', year: 2023, note: 'First to market in India' },
                { name: 'Edge AI Module', outcome: 'partial', year: 2021, note: 'Shipped late, but strong adoption' }
            ],
            style: 'Methodical and thorough. Builds robust systems but can over-engineer. Excellent at platform thinking.',
            strengths: ['Platform architecture', 'Technical depth', 'Team mentorship'],
            weaknesses: ['Can over-engineer', 'Sometimes slow to ship'],
            trackRecord: { successes: 5, failures: 1, partial: 2 }
        },
        {
            id: 'priya_menon',
            name: 'Priya Menon',
            initials: 'PM',
            avatarColor: '#dc2626',
            role: 'Senior Product Manager',
            team: 'Consumer Products',
            yearsAtCompany: 4,
            background: 'NID Ahmedabad → Xiaomi India (3 years) → ShieldTech. Led Xiaomi\'s smart home products for India before bringing consumer expertise to ShieldTech.',
            cv: [
                { year: '2020-now', role: 'Senior PM, ShieldTech', detail: 'Consumer product line' },
                { year: '2017-2020', role: 'Product Manager, Xiaomi India', detail: 'Mi Home ecosystem' },
                { year: '2017', role: 'M.Des, NID Ahmedabad', detail: 'Product Design' }
            ],
            pastProjects: [
                { name: 'SmartCam Mini', outcome: 'success', year: 2021, note: 'Best-selling SKU, exceeded targets 2x' },
                { name: 'Family Safety App', outcome: 'success', year: 2022, note: '4.5 star rating, strong retention' },
                { name: 'Budget Sensor Pack', outcome: 'failure', year: 2023, note: 'Margin issues, quality complaints' }
            ],
            style: 'Customer-obsessed and moves fast. Great at finding product-market fit but sometimes cuts corners on quality.',
            strengths: ['Consumer insights', 'Speed to market', 'User experience'],
            weaknesses: ['Quality trade-offs', 'Impatient with process'],
            trackRecord: { successes: 6, failures: 2, partial: 1 }
        },
        {
            id: 'arjun_reddy',
            name: 'Arjun Reddy',
            initials: 'AR',
            avatarColor: '#059669',
            role: 'Engineering Manager',
            team: 'Hardware',
            yearsAtCompany: 5,
            background: 'BITS Pilani → Bosch (6 years) → ShieldTech. Deep hardware expertise from automotive sensors at Bosch. Known for bulletproof designs.',
            cv: [
                { year: '2019-now', role: 'Engineering Manager, ShieldTech', detail: 'Hardware team lead' },
                { year: '2013-2019', role: 'Senior Engineer, Bosch', detail: 'Automotive sensors' },
                { year: '2013', role: 'B.E., BITS Pilani', detail: 'Electronics' }
            ],
            pastProjects: [
                { name: 'WeatherProof Cam Pro', outcome: 'success', year: 2021, note: 'Zero field failures in 2 years' },
                { name: 'Industrial Sensor Suite', outcome: 'success', year: 2022, note: 'Won enterprise accounts' },
                { name: 'Solar Power Kit', outcome: 'partial', year: 2023, note: 'Good product, slow sales' }
            ],
            style: 'Quality-obsessed engineer. Products ship late but never fail. Can be inflexible on timelines.',
            strengths: ['Hardware reliability', 'Quality focus', 'Technical rigour'],
            weaknesses: ['Slow to ship', 'Resistant to trade-offs'],
            trackRecord: { successes: 7, failures: 0, partial: 2 }
        },
        {
            id: 'sneha_iyer',
            name: 'Sneha Iyer',
            initials: 'SI',
            avatarColor: '#7c3aed',
            role: 'Senior Data Scientist',
            team: 'AI/ML',
            yearsAtCompany: 3,
            background: 'IISc Bangalore → Google Research (2 years) → ShieldTech. PhD in computer vision. Published researcher who brings cutting-edge AI to products.',
            cv: [
                { year: '2021-now', role: 'Senior Data Scientist, ShieldTech', detail: 'AI/ML products' },
                { year: '2019-2021', role: 'Research Scientist, Google', detail: 'Computer vision' },
                { year: '2019', role: 'PhD, IISc Bangalore', detail: 'Computer Vision & ML' }
            ],
            pastProjects: [
                { name: 'Person Detection v2', outcome: 'success', year: 2022, note: '95% accuracy, industry-leading' },
                { name: 'Anomaly Detection Engine', outcome: 'partial', year: 2023, note: 'Great tech, hard to productize' },
                { name: 'Voice Recognition Module', outcome: 'failure', year: 2022, note: 'Accuracy issues in noisy environments' }
            ],
            style: 'Brilliant researcher but still learning product development. Needs strong PM partnership to ship.',
            strengths: ['AI/ML expertise', 'Research depth', 'Innovation'],
            weaknesses: ['Product sense developing', 'Can be too academic'],
            trackRecord: { successes: 3, failures: 1, partial: 2 }
        },
        {
            id: 'rahul_kumar',
            name: 'Rahul Kumar',
            initials: 'RK',
            avatarColor: '#ea580c',
            role: 'Product Manager',
            team: 'Enterprise',
            yearsAtCompany: 6,
            background: 'Delhi University → Infosys (3 years) → ShieldTech. Started as engineer, moved to product. Deep understanding of enterprise customer needs.',
            cv: [
                { year: '2018-now', role: 'Product Manager, ShieldTech', detail: 'Enterprise solutions' },
                { year: '2015-2018', role: 'Software Engineer, Infosys', detail: 'Enterprise projects' },
                { year: '2015', role: 'B.Tech, Delhi University', detail: 'Information Technology' }
            ],
            pastProjects: [
                { name: 'Enterprise Dashboard', outcome: 'success', year: 2020, note: 'Landed 3 Fortune 500 accounts' },
                { name: 'Multi-site Management', outcome: 'success', year: 2021, note: 'Key differentiator vs competition' },
                { name: 'API Platform', outcome: 'success', year: 2022, note: 'Enabled partner ecosystem' },
                { name: 'Compliance Module', outcome: 'partial', year: 2023, note: 'Delayed but delivered value' }
            ],
            style: 'Steady and reliable. Not flashy but consistently delivers. Strong enterprise relationships.',
            strengths: ['Enterprise sales', 'Customer relationships', 'Reliability'],
            weaknesses: ['Not innovative', 'Risk-averse'],
            trackRecord: { successes: 8, failures: 0, partial: 2 }
        },
        {
            id: 'ananya_das',
            name: 'Ananya Das',
            initials: 'AD',
            avatarColor: '#0891b2',
            role: 'Technical Lead',
            team: 'Mobile',
            yearsAtCompany: 4,
            background: 'Jadavpur University → Flipkart (4 years) → ShieldTech. Mobile engineering expert who scaled Flipkart\'s app to 100M+ users.',
            cv: [
                { year: '2020-now', role: 'Technical Lead, ShieldTech', detail: 'Mobile apps' },
                { year: '2016-2020', role: 'Senior Engineer, Flipkart', detail: 'Mobile platform' },
                { year: '2016', role: 'B.Tech, Jadavpur University', detail: 'Computer Science' }
            ],
            pastProjects: [
                { name: 'ShieldTech App 3.0', outcome: 'success', year: 2021, note: '4.6 star rating, 2M downloads' },
                { name: 'Real-time Alerts', outcome: 'success', year: 2022, note: '<100ms latency achieved' },
                { name: 'Widget System', outcome: 'failure', year: 2023, note: 'Low adoption, removed' }
            ],
            style: 'Strong mobile expertise. Can over-focus on technical elegance vs user needs.',
            strengths: ['Mobile development', 'Performance optimization', 'Code quality'],
            weaknesses: ['User research gaps', 'Feature creep'],
            trackRecord: { successes: 5, failures: 1, partial: 1 }
        },
        {
            id: 'karthik_nair',
            name: 'Karthik Nair',
            initials: 'KN',
            avatarColor: '#be123c',
            role: 'Program Manager',
            team: 'New Initiatives',
            yearsAtCompany: 2,
            background: 'IIM Kozhikode → McKinsey (5 years) → ShieldTech. Strategy consultant turned operator. Great at stakeholder management and big bets.',
            cv: [
                { year: '2022-now', role: 'Program Manager, ShieldTech', detail: 'Strategic initiatives' },
                { year: '2017-2022', role: 'Engagement Manager, McKinsey', detail: 'Tech & telecom practice' },
                { year: '2017', role: 'MBA, IIM Kozhikode', detail: 'Strategy' }
            ],
            pastProjects: [
                { name: 'Jio Partnership', outcome: 'partial', year: 2023, note: 'Deal structure good, execution ongoing' },
                { name: 'International Expansion Study', outcome: 'success', year: 2022, note: 'Informed SEA strategy' }
            ],
            style: 'Strategic thinker who can navigate complex stakeholders. Less hands-on with execution details.',
            strengths: ['Strategy', 'Stakeholder management', 'Big picture'],
            weaknesses: ['Execution details', 'Technical depth'],
            trackRecord: { successes: 2, failures: 0, partial: 1 }
        },
        {
            id: 'deepa_sharma',
            name: 'Deepa Sharma',
            initials: 'DS',
            avatarColor: '#4f46e5',
            role: 'Engineering Manager',
            team: 'Cloud Infrastructure',
            yearsAtCompany: 5,
            background: 'NIT Trichy → Microsoft (4 years) → ShieldTech. Azure expertise. Built ShieldTech\'s entire cloud backend from scratch.',
            cv: [
                { year: '2019-now', role: 'Engineering Manager, ShieldTech', detail: 'Cloud & backend' },
                { year: '2015-2019', role: 'Software Engineer, Microsoft', detail: 'Azure services' },
                { year: '2015', role: 'B.Tech, NIT Trichy', detail: 'Computer Science' }
            ],
            pastProjects: [
                { name: 'Cloud Migration Phase 1', outcome: 'success', year: 2020, note: '60% cost reduction' },
                { name: 'Real-time Event Pipeline', outcome: 'success', year: 2021, note: '10x throughput improvement' },
                { name: 'Multi-region Deployment', outcome: 'partial', year: 2022, note: 'Delayed but critical for scale' },
                { name: 'Serverless Rewrite', outcome: 'failure', year: 2023, note: 'Abandoned due to complexity' }
            ],
            style: 'Infrastructure expert. Excellent at scale challenges but can get lost in technical details.',
            strengths: ['Cloud architecture', 'Scale & reliability', 'Cost optimization'],
            weaknesses: ['Product thinking', 'Can over-engineer'],
            trackRecord: { successes: 5, failures: 1, partial: 2 }
        },
        {
            id: 'mohammed_ali',
            name: 'Mohammed Ali',
            initials: 'MA',
            avatarColor: '#65a30d',
            role: 'Senior Product Manager',
            team: 'Partnerships',
            yearsAtCompany: 3,
            background: 'XLRI → Vodafone (5 years) → ShieldTech. Telecom partnerships expert. Built Vodafone\'s IoT partner program before joining.',
            cv: [
                { year: '2021-now', role: 'Senior PM, ShieldTech', detail: 'Partner products' },
                { year: '2016-2021', role: 'Partner Manager, Vodafone', detail: 'IoT ecosystem' },
                { year: '2016', role: 'MBA, XLRI', detail: 'Marketing' }
            ],
            pastProjects: [
                { name: 'Builder Integration Program', outcome: 'success', year: 2022, note: '50+ builder partnerships' },
                { name: 'Insurance Bundle', outcome: 'success', year: 2023, note: 'New revenue stream' },
                { name: 'Retail Channel Expansion', outcome: 'failure', year: 2022, note: 'Economics didn\'t work' }
            ],
            style: 'Relationship builder who finds creative partnership structures. Can over-promise to partners.',
            strengths: ['Partnership development', 'Business development', 'Creative deal structures'],
            weaknesses: ['Over-promising', 'Internal alignment'],
            trackRecord: { successes: 4, failures: 1, partial: 1 }
        },
        {
            id: 'lakshmi_venkat',
            name: 'Lakshmi Venkataraman',
            initials: 'LV',
            avatarColor: '#0d9488',
            role: 'Principal Engineer',
            team: 'Security',
            yearsAtCompany: 6,
            background: 'IIIT Hyderabad → Symantec (5 years) → ShieldTech. Cybersecurity expert who ensures ShieldTech products are secure by design.',
            cv: [
                { year: '2018-now', role: 'Principal Engineer, ShieldTech', detail: 'Security architecture' },
                { year: '2013-2018', role: 'Security Engineer, Symantec', detail: 'Endpoint protection' },
                { year: '2013', role: 'M.Tech, IIIT Hyderabad', detail: 'Information Security' }
            ],
            pastProjects: [
                { name: 'End-to-end Encryption', outcome: 'success', year: 2020, note: 'Industry-first for smart home' },
                { name: 'Security Audit Framework', outcome: 'success', year: 2021, note: 'Passed enterprise audits' },
                { name: 'Zero-Trust Architecture', outcome: 'success', year: 2022, note: 'Key enterprise differentiator' },
                { name: 'Biometric Vault', outcome: 'partial', year: 2023, note: 'Secure but UX challenges' }
            ],
            style: 'Security-first mindset. Sometimes slows things down but catches critical issues. Non-negotiable on security.',
            strengths: ['Security expertise', 'Risk assessment', 'Compliance'],
            weaknesses: ['Can slow velocity', 'Perfectionist'],
            trackRecord: { successes: 7, failures: 0, partial: 1 }
        },
        {
            id: 'sanjay_gupta',
            name: 'Sanjay Gupta',
            initials: 'SG',
            avatarColor: '#9333ea',
            role: 'Technical Lead',
            team: 'Firmware',
            yearsAtCompany: 8,
            background: 'VIT Vellore → Samsung R&D (3 years) → ShieldTech (founding engineer). One of the first engineers. Deep institutional knowledge.',
            cv: [
                { year: '2016-now', role: 'Technical Lead, ShieldTech', detail: 'Firmware & embedded' },
                { year: '2013-2016', role: 'Firmware Engineer, Samsung R&D', detail: 'IoT devices' },
                { year: '2013', role: 'B.Tech, VIT Vellore', detail: 'Electronics' }
            ],
            pastProjects: [
                { name: 'Original ShieldOS', outcome: 'success', year: 2017, note: 'Foundation of all products' },
                { name: 'OTA Update System', outcome: 'success', year: 2019, note: '99.9% success rate' },
                { name: 'Power Optimization', outcome: 'success', year: 2020, note: '2x battery life improvement' },
                { name: 'New Chip Migration', outcome: 'partial', year: 2022, note: 'Delayed but necessary' },
                { name: 'Legacy Protocol Support', outcome: 'failure', year: 2023, note: 'Abandoned, too complex' }
            ],
            style: 'Institutional knowledge but can be set in his ways. Protective of legacy code. Reliable for core work.',
            strengths: ['Firmware expertise', 'Institutional knowledge', 'Reliability'],
            weaknesses: ['Resistant to change', 'Protective of legacy'],
            trackRecord: { successes: 9, failures: 1, partial: 2 }
        },
        {
            id: 'neha_kapoor',
            name: 'Neha Kapoor',
            initials: 'NK',
            avatarColor: '#db2777',
            role: 'Product Manager',
            team: 'Growth',
            yearsAtCompany: 2,
            background: 'ISB Hyderabad → Swiggy (3 years) → ShieldTech. Growth hacking expert who scaled Swiggy\'s user acquisition.',
            cv: [
                { year: '2022-now', role: 'Product Manager, ShieldTech', detail: 'Growth & activation' },
                { year: '2019-2022', role: 'Growth PM, Swiggy', detail: 'User acquisition' },
                { year: '2019', role: 'MBA, ISB Hyderabad', detail: 'General Management' }
            ],
            pastProjects: [
                { name: 'Referral Program 2.0', outcome: 'success', year: 2022, note: '30% of new users from referrals' },
                { name: 'Onboarding Redesign', outcome: 'success', year: 2023, note: '50% activation improvement' },
                { name: 'Gamification Features', outcome: 'failure', year: 2023, note: 'Low engagement, removed' }
            ],
            style: 'Data-driven and moves fast. Great at experimentation but can prioritize metrics over experience.',
            strengths: ['Growth hacking', 'Data analysis', 'Experimentation'],
            weaknesses: ['Short-term focus', 'Metric gaming'],
            trackRecord: { successes: 4, failures: 1, partial: 0 }
        }
    ];
    
    // Function to get a random project lead
    function getRandomProjectLead() {
        return projectLeads[Math.floor(Math.random() * projectLeads.length)];
    }
    
    // Function to get lead by ID
    function getProjectLead(leadId) {
        return projectLeads.find(l => l.id === leadId) || getRandomProjectLead();
    }
    
    // Function to calculate lead track record score (0-1)
    function getLeadTrackScore(lead) {
        const total = lead.trackRecord.successes + lead.trackRecord.failures + lead.trackRecord.partial;
        if (total === 0) return 0.5;
        const score = (lead.trackRecord.successes + lead.trackRecord.partial * 0.5) / total;
        return score;
    }
    
    // Generate a 100-150 word rapid summary for quick screening
    function generateRapidSummary(project) {
        const parts = [];
        
        // Core description (use desc which is more concise than fullDesc)
        parts.push(project.desc || project.fullDesc || 'No description available.');
        
        // Market context snippet
        if (project.marketContext) {
            const marketSnippet = project.marketContext.split('.').slice(0, 2).join('.') + '.';
            parts.push(marketSnippet);
        }
        
        // Key metrics in prose
        const metrics = [];
        if (project.trl) {
            metrics.push(`Technology moves from TRL ${project.trl.current} to ${project.trl.target}`);
        }
        if (project.milestones?.totalDuration) {
            metrics.push(`${project.milestones.totalDuration} timeline`);
        }
        if (project.financials?.projectedRevenue) {
            metrics.push(`projected ${project.financials.projectedRevenue} revenue`);
        }
        if (project.financials?.grossMargin) {
            metrics.push(`${project.financials.grossMargin} gross margin`);
        }
        if (metrics.length > 0) {
            parts.push(metrics.join(', ') + '.');
        }
        
        // IP/Risk note
        if (project.ipPosition?.risk) {
            const riskNote = project.ipPosition.risk === 'Low' ? 'Clear IP pathway with low risk.' :
                           project.ipPosition.risk === 'High' ? 'Significant IP risks require careful navigation.' :
                           'Moderate IP considerations to address.';
            parts.push(riskNote);
        }
        
        return parts.join(' ');
    }
    
    // Assign a project lead based on archetype and project characteristics
    function assignProjectLead(archetype, scores) {
        // Map archetypes to preferred lead teams/skills
        const archetypeLeadPreferences = {
            'core_upgrade': ['vikram_shah', 'arjun_reddy', 'sanjay_gupta'],
            'value_segment': ['priya_menon', 'neha_kapoor', 'mohammed_ali'],
            'frontier_tech': ['sneha_iyer', 'vikram_shah', 'lakshmi_venkat'],
            'premium_flagship': ['arjun_reddy', 'priya_menon', 'vikram_shah'],
            'niche_vertical': ['rahul_kumar', 'mohammed_ali', 'priya_menon'],
            'underserved_market': ['priya_menon', 'neha_kapoor', 'mohammed_ali'],
            'platform_infrastructure': ['vikram_shah', 'deepa_sharma', 'sanjay_gupta'],
            'market_explorer': ['karthik_nair', 'mohammed_ali', 'neha_kapoor'],
            'price_fighter': ['arjun_reddy', 'priya_menon', 'sanjay_gupta'],
            'esg_initiative': ['karthik_nair', 'rahul_kumar', 'priya_menon'],
            'proprietary_tech': ['lakshmi_venkat', 'sneha_iyer', 'vikram_shah'],
            'ai_guard': ['sneha_iyer', 'vikram_shah', 'ananya_das'],
            'camera_health': ['deepa_sharma', 'vikram_shah', 'rahul_kumar'],
            'smart_access': ['vikram_shah', 'arjun_reddy', 'lakshmi_venkat'],
            'services_platform': ['deepa_sharma', 'rahul_kumar', 'vikram_shah'],
            'autonomous_drone': ['sneha_iyer', 'arjun_reddy', 'karthik_nair'],
            'ground_robot': ['arjun_reddy', 'sneha_iyer', 'vikram_shah'],
            'vehicle_intelligence': ['sneha_iyer', 'arjun_reddy', 'vikram_shah'],
            'privacy_compliance': ['lakshmi_venkat', 'rahul_kumar', 'deepa_sharma'],
            'acoustic_detection': ['sneha_iyer', 'arjun_reddy', 'lakshmi_venkat'],
            'rtls_tracking': ['vikram_shah', 'arjun_reddy', 'rahul_kumar'],
            'digital_twin': ['sneha_iyer', 'vikram_shah', 'deepa_sharma'],
            'cyber_physical_soc': ['lakshmi_venkat', 'deepa_sharma', 'rahul_kumar'],
            'deepfake_defense': ['sneha_iyer', 'lakshmi_venkat', 'vikram_shah'],
            'predictive_risk': ['sneha_iyer', 'rahul_kumar', 'deepa_sharma'],
            'compliance_automation': ['rahul_kumar', 'lakshmi_venkat', 'deepa_sharma'],
            'perimeter_fusion': ['arjun_reddy', 'vikram_shah', 'sneha_iyer'],
            'evidence_chain': ['lakshmi_venkat', 'deepa_sharma', 'rahul_kumar'],
            'panic_wearable': ['arjun_reddy', 'priya_menon', 'ananya_das'],
            'edge_micro_nvr': ['arjun_reddy', 'sanjay_gupta', 'vikram_shah'],
            'rapid_deploy': ['arjun_reddy', 'mohammed_ali', 'sanjay_gupta'],
            // Year 1 End project archetypes
            'quick_win': ['arjun_reddy', 'sanjay_gupta', 'priya_menon'],
            'market_response': ['priya_menon', 'neha_kapoor', 'arjun_reddy'],
            'capability_build': ['vikram_shah', 'deepa_sharma', 'sneha_iyer'],
            'partnership_opportunity': ['karthik_nair', 'rahul_kumar', 'mohammed_ali'],
            'tech_adjacency': ['sneha_iyer', 'lakshmi_venkat', 'deepa_sharma'],
            // Base archetypes for Year 1 End (mapped versions)
            'conventional_winner': ['arjun_reddy', 'vikram_shah', 'priya_menon'],
            'conventional_loser': ['sneha_iyer', 'lakshmi_venkat', 'deepa_sharma'],
            'hidden_gem': ['priya_menon', 'mohammed_ali', 'neha_kapoor'],
            'slow_burner': ['vikram_shah', 'deepa_sharma', 'rahul_kumar'],
            'paper_tiger': ['arjun_reddy', 'sneha_iyer', 'vikram_shah'],
            'money_pit': ['sanjay_gupta', 'vikram_shah', 'deepa_sharma'],
            'pivot_success': ['karthik_nair', 'mohammed_ali', 'rahul_kumar'],
            'team_dependent': ['ananya_das', 'vikram_shah', 'sneha_iyer'],
            'competitive_casualty': ['priya_menon', 'arjun_reddy', 'sanjay_gupta'],
            'sustainability_play': ['karthik_nair', 'rahul_kumar', 'neha_kapoor'],
            'ip_fortress': ['lakshmi_venkat', 'sneha_iyer', 'vikram_shah']
        };
        
        // Get preferred leads for this archetype, or use random if not mapped
        let preferredLeads = archetypeLeadPreferences[archetype];
        if (!preferredLeads || preferredLeads.length === 0) {
            // Fallback: pick based on scores
            if (scores.technical >= 4) preferredLeads = ['vikram_shah', 'sneha_iyer', 'arjun_reddy'];
            else if (scores.marketsize >= 4) preferredLeads = ['priya_menon', 'neha_kapoor', 'mohammed_ali'];
            else preferredLeads = projectLeads.map(l => l.id);
        }
        
        // Pick a random lead from the preferred list
        const selectedLeadId = preferredLeads[Math.floor(Math.random() * preferredLeads.length)];
        return projectLeads.find(l => l.id === selectedLeadId) || getRandomProjectLead();
    }
    
    // Function to render lead mini-CV for modals
    // Render minimal lead link (clickable to open full CV modal)
    function renderLeadCard(lead, showDetails = false) {
        if (!lead) return '<p style="color: var(--gray-500);">No lead assigned.</p>';
        
        const trackScore = getLeadTrackScore(lead);
        const trackClass = trackScore >= 0.7 ? 'success' : trackScore >= 0.5 ? 'warning' : 'danger';
        
        // Minimal clickable link - opens full CV in modal
        return `
            <div class="lead-link" onclick="openLeadModal('${lead.id}')" title="Click to view full CV">
                <span class="lead-link-avatar" style="background: ${lead.avatarColor}20; color: ${lead.avatarColor};">${lead.initials}</span>
                <span class="lead-link-name">${lead.name}</span>
                <span class="lead-link-badge ${trackClass}">${Math.round(trackScore * 100)}%</span>
                <span class="lead-link-cta">View CV →</span>
            </div>
        `;
    }
    
    // Open lead CV modal
    function openLeadModal(leadId) {
        const lead = projectLeads.find(l => l.id === leadId);
        if (!lead) return;
        
        const trackScore = getLeadTrackScore(lead);
        const trackClass = trackScore >= 0.7 ? 'success' : trackScore >= 0.5 ? 'warning' : 'danger';
        
        // Populate header
        document.getElementById('lead-modal-avatar').textContent = lead.initials;
        document.getElementById('lead-modal-avatar').style.background = lead.avatarColor + '40';
        document.getElementById('lead-modal-avatar').style.color = 'white';
        document.getElementById('lead-modal-name').textContent = lead.name;
        document.getElementById('lead-modal-role').textContent = `${lead.role} · ${lead.team} · ${lead.yearsAtCompany} years at ShieldTech`;
        
        const scoreEl = document.getElementById('lead-modal-score');
        scoreEl.innerHTML = `
            <div class="score-value">${Math.round(trackScore * 100)}%</div>
            <div class="score-label">Track Record</div>
        `;
        
        // Populate body
        document.getElementById('lead-modal-body').innerHTML = `
            <div class="lead-modal-section">
                <div class="lead-modal-section-title">📚 Background</div>
                <p style="color: var(--gray-700); line-height: 1.6; margin: 0;">${lead.background}</p>
            </div>
            
            <div class="lead-modal-section">
                <div class="lead-modal-section-title">💼 Career History</div>
                <div class="cv-timeline">
                    ${lead.cv.map(item => `
                        <div class="cv-item">
                            <span class="cv-year">${item.year}</span>
                            <span class="cv-role">${item.role}</span>
                            <span class="cv-detail">${item.detail}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
            
            <div class="lead-modal-section">
                <div class="lead-modal-section-title">🏆 Past Projects at ShieldTech</div>
                <div class="past-projects-list">
                    ${lead.pastProjects.map(p => `
                        <div class="past-project ${p.outcome}">
                            <span class="past-project-icon">${p.outcome === 'success' ? '✓' : p.outcome === 'failure' ? '✗' : '◐'}</span>
                            <span class="past-project-name">${p.name}</span>
                            <span class="past-project-year">${p.year}</span>
                            <span class="past-project-note">${p.note}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
            
            <div class="lead-modal-section">
                <div class="lead-modal-section-title">💬 Working Style</div>
                <p style="color: var(--gray-700); font-style: italic; margin: 0 0 15px; line-height: 1.6;">"${lead.style}"</p>
                <div class="lead-traits">
                    <div class="traits-column strengths">
                        <div class="traits-label">Strengths</div>
                        ${lead.strengths.map(s => `<span class="trait">✓ ${s}</span>`).join('')}
                    </div>
                    <div class="traits-column weaknesses">
                        <div class="traits-label">Watch For</div>
                        ${lead.weaknesses.map(w => `<span class="trait">⚠ ${w}</span>`).join('')}
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--gray-200); font-size: 0.8em; color: var(--gray-400); font-style: italic;">
                Note: Past performance is informative but not a guarantee of future results. Project success depends on many factors beyond the lead.
            </div>
        `;
        
        // Show modal
        document.getElementById('lead-cv-modal').classList.remove('hidden');
    }
    
    // Close lead CV modal
    function closeLeadModal() {
        document.getElementById('lead-cv-modal').classList.add('hidden');
    }
    
    // Open credits modal
    function openCreditsModal() {
        document.getElementById('credits-modal').classList.remove('hidden');
    }
    
    // Close credits modal
    function closeCreditsModal() {
        document.getElementById('credits-modal').classList.add('hidden');
    }
    
    // Show tutorial modal
    function showTutorialModal() {
        document.getElementById('tutorial-modal').classList.remove('hidden');
    }
    
    // Close tutorial modal
    function closeTutorialModal() {
        document.getElementById('tutorial-modal').classList.add('hidden');
    }
    
    const projectTemplates = [
        { 
            archetype: 'core_upgrade', 
            names: ['SmartLock Pro', 'HomeGuard Elite', 'SecureCam HD', 'SensorNet Plus'], 
            descs: [
                'Biometric door lock with fingerprint scanner (capacity: 100 prints), 3D facial recognition, PIN backup, and ShieldTech app integration. Auto-lock feature, tamper alerts, and guest access codes with time limits. Retrofit design fits standard Indian door frames.',
                'Central security hub with 7-inch touchscreen, connecting up to 32 wireless sensors and 8 cameras. Includes siren (110dB), battery backup (8 hours), and cellular failover. Pre-configured automation rules for arm/disarm schedules and smart home scenes.',
                '4K security camera with 150° wide-angle lens, colour night vision (up to 10m), and on-device AI detecting humans vs animals vs vehicles. Two-way audio with noise cancellation. Weatherproof (IP66) with -10°C to 50°C operating range.',
                'Mesh network of 6 PIR motion sensors with 12m range and pet immunity (up to 25kg). Intelligent zone mapping via app calibration. 2-year battery life, instant push notifications, and integration with existing ShieldTech cameras.'
            ], 
            budgetRange: [5, 7], baseSuccess: 0.65, 
            riskProfile: 'low', rewardProfile: 'moderate',
            scores: { technical: 4, marketsize: 4, strategic: 4, team: 4, capability: 5, ip: 3, platform: 4, sustainability: 3, newmarket: 2, geographic: 3, competitive: 3, devcost: 4, roi: 4, speed: 4, risk: 4 }, 
            quarterNarratives: { good: ['Prototype meeting specifications.', 'Customer testing feedback positive.'], bad: ['Component sourcing delays emerging.', 'Competitor launched similar feature.'] }, 
            outcomeNarrative: { success: 'Solid product-market fit. Met sales targets.', failure: 'Market more competitive than expected. Required repositioning.' } 
        },
        { 
            archetype: 'value_segment', 
            names: ['BudgetSafe', 'ValueLock Basic', 'EconoSensor', 'SmartStart Kit'], 
            descs: [
                'Entry-level PIR motion sensor with 8m detection range, 90dB built-in siren, and basic app alerts via WiFi. Simple stick-on installation with included batteries (1 year life). Priced at $12 to compete with unbranded imports.',
                'Keypad-only smart lock with 4-digit PIN access, auto-lock timer, and low-battery warnings. No biometrics or app—designed for simplicity. Fits standard mortise locks common in tier-2/3 cities. Target price: $30.',
                'Pack of 3 door/window contact sensors with magnetic reed switches. Battery-powered (18 months), connects to ShieldTech app. Entry-chime mode for shops. Designed for $7/pack price point.',
                'Bundled starter kit: 1 hub, 2 door sensors, 1 motion sensor, 1 siren. Pre-paired out-of-box setup taking under 10 minutes. Targets first-time security buyers with $50 all-in price.'
            ], 
            budgetRange: [3, 4], baseSuccess: 0.65, 
            riskProfile: 'low', rewardProfile: 'moderate',
            scores: { technical: 3, marketsize: 5, strategic: 4, team: 4, capability: 4, ip: 2, platform: 3, sustainability: 3, newmarket: 3, geographic: 5, competitive: 2, devcost: 5, roi: 4, speed: 5, risk: 4 }, 
            quarterNarratives: { good: ['Cost targets on track.', 'Distribution discussions progressing.'], bad: ['Margin pressure from component costs.', 'Quality concerns at price point.'] }, 
            outcomeNarrative: { success: 'Strong volume in tier-2/3 cities.', failure: 'Margin erosion required product redesign.' } 
        },
        { 
            archetype: 'frontier_tech', 
            names: ['HoloSecurity', 'QuantumLock', 'NeuroCam', 'BioField Detector'], 
            descs: [
                'Holographic intruder deterrent projecting life-size guard images using laser-phosphor display technology. Triggered by motion sensors to create illusion of occupied premises. Requires custom optical components not yet in mass production.',
                'Door lock using quantum key distribution (QKD) for theoretically unbreakable encryption. Requires single-photon detectors and cryogenic cooling. Academic partnership with IISc for core technology development.',
                'Camera with neuromorphic vision chip mimicking human retina, processing motion at 10,000fps with ultra-low power. Silicon photomultiplier array for low-light. Chip fabrication requires 7nm process not available domestically.',
                'Perimeter security using weak electromagnetic field perturbation to detect human presence through walls. Based on research into bioelectric field sensing. Requires extensive shielding and calibration for Indian electrical environments.'
            ], 
            budgetRange: [4, 6], baseSuccess: 0.65, 
            riskProfile: 'high', rewardProfile: 'high',
            scores: { technical: 3, marketsize: 3, strategic: 4, team: 3, capability: 3, ip: 5, platform: 3, sustainability: 3, newmarket: 5, geographic: 2, competitive: 5, devcost: 2, roi: 3, speed: 2, risk: 2 }, 
            quarterNarratives: { good: ['Research milestone achieved.', 'Academic partner producing results.', 'Patent application filed.'], bad: ['Technical complexity requiring more time.', 'Prototype performance below targets.'] }, 
            outcomeNarrative: { success: 'Breakthrough technology created new category.', failure: 'Technology validated but commercialization delayed. IP retained for future.' } 
        },
        { 
            archetype: 'premium_flagship', 
            names: ['UltraVision 360', 'TotalHome Command', 'SmartFortress', 'OmniSense Pro'], 
            descs: [
                '8K resolution PTZ camera with true 360° coverage using 4-sensor array, AI-powered auto-tracking following subjects across frame, 50m night vision with IR flood, and edge computing for real-time threat classification. Targets premium segment at $420.',
                'Whole-home platform integrating security with lighting (Philips Hue, Syska), HVAC (Daikin, Voltas), entertainment (Fire TV, Chromecast), and appliances via Matter protocol. Voice control through Alexa/Google. 50+ device category integrations planned.',
                'Military-spec security system with hardened enclosures (IK10 rated), encrypted mesh networking, anti-jamming RF technology, and tamper-evident sensors. Modular design for high-net-worth residences and farmhouses.',
                'Multi-modal sensing platform combining PIR, microwave, ultrasonic, and thermal detection for zero false-alarm performance. FPGA-based sensor fusion requiring custom algorithm development for each deployment environment.'
            ], 
            budgetRange: [6, 8], baseSuccess: 0.65, 
            riskProfile: 'medium', rewardProfile: 'high',
            scores: { technical: 5, marketsize: 4, strategic: 4, team: 4, capability: 3, ip: 4, platform: 5, sustainability: 3, newmarket: 3, geographic: 3, competitive: 4, devcost: 3, roi: 4, speed: 3, risk: 3 }, 
            quarterNarratives: { good: ['Demo generated strong interest.', 'Premium positioning resonating.', 'Key technical milestone achieved.'], bad: ['Integration complexity higher than estimated.', 'Target market smaller than projected.'] }, 
            outcomeNarrative: { success: 'Premium flagship established technology leadership.', failure: 'Scope reduced to focus on core differentiators.' } 
        },
        { 
            archetype: 'niche_vertical', 
            names: ['ElderCare Alert', 'PetWatch Home', 'KidSafe Zone', 'GardenGuard'], 
            descs: [
                'Wearable pendant with fall detection accelerometer, SOS button, and two-way voice. Base station with motion pattern learning detects unusual inactivity. Automatic alerts to 5 family contacts with GPS location. Large buttons, loud speaker, no app needed for wearer.',
                'Security camera with pet-aware AI distinguishing dogs/cats from intruders (trained on 50,000 pet images). Includes treat dispenser (100g capacity), two-way audio for pet interaction, and activity monitoring. Reduces false alarms for pet owners by 94%.',
                'Child safety system with wearable GPS watch, geofence alerts, and school zone monitoring. Panic button triggers recording and family alert. Safe route tracking for school commute. Tamper-resistant band design for ages 5-12.',
                'Weatherproof outdoor security for gardens and compounds. Solar-powered cameras with 4G connectivity (no WiFi needed), motion-activated floodlights, and wildlife-immune detection. Designed for farmhouses and weekend homes.'
            ], 
            budgetRange: [5, 7], baseSuccess: 0.65, 
            riskProfile: 'medium', rewardProfile: 'moderate',
            scores: { technical: 3, marketsize: 2, strategic: 2, team: 4, capability: 4, ip: 2, platform: 3, sustainability: 5, newmarket: 5, geographic: 3, competitive: 4, devcost: 4, roi: 3, speed: 4, risk: 3 }, 
            quarterNarratives: { good: ['Customer interviews revealing strong need.', 'Word spreading in target community.'], bad: ['Market size validation ongoing.', 'Channel strategy needs refinement.'] }, 
            outcomeNarrative: { success: 'Found passionate niche with strong loyalty.', failure: 'Niche smaller than projected. Integrated features into main product line.' } 
        },
        { 
            archetype: 'underserved_market', 
            names: ['RuralSecure', 'OffGrid Guardian', 'VillageWatch', 'FarmSafe'], 
            descs: [
                'Solar-powered security kit for areas with unreliable electricity. 20W panel charges 48hr battery backup. GSM alerts (not WiFi dependent). Loud siren (120dB). Dust-resistant IP65 housing tested for Rajasthan conditions. $75 price point.',
                'Satellite-connected security for zero-coverage areas. Iridium-based alert transmission, 5W solar charging, ruggedized for extreme weather (-20°C to 60°C). Designed for remote farmhouses, mining camps, and forest lodges.',
                'Community security mesh network enabling neighbouring homes to share alerts. Village-level dashboard showing security status. LoRa-based mesh covering 2km radius without internet infrastructure. Community alert siren integration.',
                'Agricultural security system protecting crops and equipment. Perimeter beam sensors, equipment GPS trackers, and water tank level monitoring. Solar-powered with agricultural subsidy eligibility under PM-KUSUM scheme.'
            ], 
            budgetRange: [4, 6], baseSuccess: 0.65, 
            riskProfile: 'medium', rewardProfile: 'high',
            scores: { technical: 3, marketsize: 2, strategic: 3, team: 3, capability: 3, ip: 3, platform: 2, sustainability: 5, newmarket: 5, geographic: 5, competitive: 4, devcost: 3, roi: 2, speed: 3, risk: 3 }, 
            quarterNarratives: { good: ['Field testing shows strong product-market fit.', 'Government scheme partnership progressing.'], bad: ['Distribution infrastructure challenging.', 'Unit economics require volume.'] }, 
            outcomeNarrative: { success: 'Opened large underserved rural market.', failure: 'Distribution costs higher than projected. Shifted to partnership model.' } 
        },
        { 
            archetype: 'platform_infrastructure', 
            names: ['AI Learning Cam', 'SmartHome Bridge', 'EcoSystem Hub', 'UniversalConnect'], 
            descs: [
                'Camera with on-device machine learning that adapts to your home over 90 days. Learns family faces, regular visitors, delivery schedules, and normal activity patterns. Reduces false alerts by 85% without cloud dependency. Privacy-first design—all learning stays local on 4GB edge storage.',
                'Integration hub connecting ShieldTech with 50+ third-party devices: Philips Hue, Syska LED, Google Nest, Amazon Echo, Samsung SmartThings, Havells fans. Matter/Thread protocol support. Enables cross-brand automation: "When motion detected, turn on lights."',
                'Multi-protocol gateway supporting Zigbee, Z-Wave, WiFi, and Bluetooth devices through single app. Device discovery and pairing wizard. Scene builder for complex automations. Developer API for third-party integrations. $60 hardware + optional $1/month cloud.',
                'Retrofit adapter making legacy wired sensors smart. Converts traditional magnetic contacts, PIR sensors, and wired sirens to wireless ShieldTech ecosystem. Enables gradual smart home upgrade without ripping out existing installation.'
            ], 
            budgetRange: [6, 8], baseSuccess: 0.65, 
            riskProfile: 'medium', rewardProfile: 'high',
            scores: { technical: 4, marketsize: 4, strategic: 5, team: 4, capability: 4, ip: 4, platform: 5, sustainability: 3, newmarket: 4, geographic: 3, competitive: 4, devcost: 3, roi: 3, speed: 3, risk: 3 }, 
            quarterNarratives: { good: ['Platform foundation technically solid.', 'Developer community growing.', 'Partner integrations on track.'], bad: ['Adoption curve requires patience.', 'Network effects building gradually.'] }, 
            outcomeNarrative: { success: 'Platform reached critical mass. Strong ecosystem lock-in.', failure: 'Platform viable but smaller scale than hoped. Valuable infrastructure for future.' } 
        },
        { 
            archetype: 'market_explorer', 
            names: ['SecureComm', 'AlertNet', 'GuardianLink', 'CommunityWatch'], 
            descs: [
                'End-to-end encrypted messaging app for security personnel with location sharing, shift handover logs, and incident reporting. Panic button broadcasts to team with live video. Initially targeting security agencies, may pivot to gated community management.',
                'Neighbourhood alert network: when one ShieldTech system triggers, nearby subscribers receive notification. Shared suspicious activity map. Anonymous tip reporting. Requires critical mass of users in locality—network effects dependent.',
                'Subscription service connecting ShieldTech users with verified security responders. $4/month gets human response within 15 minutes of verified alert. Partnership with security agencies for responder network. Insurance tie-up for coverage.',
                'Platform for Resident Welfare Associations (RWAs) integrating visitor management, domestic help verification, and shared perimeter security. Intercom integration, vehicle RFID tracking, and society-wide alert broadcast. B2B2C model.'
            ], 
            budgetRange: [4, 6], baseSuccess: 0.65, 
            riskProfile: 'medium', rewardProfile: 'moderate',
            scores: { technical: 4, marketsize: 4, strategic: 4, team: 4, capability: 4, ip: 3, platform: 4, sustainability: 4, newmarket: 4, geographic: 4, competitive: 3, devcost: 4, roi: 3, speed: 4, risk: 3 }, 
            quarterNarratives: { good: ['Market feedback informing direction.', 'Early adopters showing engagement.', 'Adjacent opportunities identified.'], bad: ['Initial hypothesis needs refinement.', 'Pivot considerations emerging.'] }, 
            outcomeNarrative: { success: 'Iterative approach found strong product-market fit.', failure: 'Market learnings valuable. Team redirected to adjacent opportunity.' } 
        },
        { 
            archetype: 'price_fighter', 
            names: ['ValueCam Basic', 'BudgetLock Simple', 'EconoAlert'], 
            descs: [
                '1080p WiFi camera at $22 competing directly with Xiaomi Mi Home and Yi cameras. Features: night vision (8m), two-way audio, SD card slot (up to 128GB), ShieldTech app integration. Thin 18% margin requires 50,000 unit/month volume.',
                'PIN-code smart lock at $25 undercutting Chinese imports. Basic features only: 6-digit code, auto-lock, low battery alert. No app connectivity—standalone operation. Competes on "local brand trust" positioning.',
                'Budget 3-pack sensor kit at $12 matching Alibaba import pricing. Door sensor + motion sensor + siren. Basic app with push alerts. Deliberately minimal features to hit price point. Razor-thin 12% margins.'
            ], 
            budgetRange: [4, 6], baseSuccess: 0.65, 
            riskProfile: 'medium', rewardProfile: 'low',
            scores: { technical: 3, marketsize: 5, strategic: 3, team: 4, capability: 4, ip: 2, platform: 3, sustainability: 2, newmarket: 3, geographic: 5, competitive: 3, devcost: 4, roi: 3, speed: 5, risk: 3 }, 
            quarterNarratives: { good: ['Cost targets achieved.', 'Channel partnerships secured.', 'Quality holding at price point.'], bad: ['Competitor pricing aggressive.', 'Margin pressure emerging.'] }, 
            outcomeNarrative: { success: 'Volume targets met. Brand trust differentiated from imports.', failure: 'Margin erosion required repositioning upmarket.' } 
        },
        { 
            archetype: 'esg_initiative', 
            names: ['EcoSensor Green', 'SolarGuard Pro', 'RecycleReady Cam', 'CarbonLight System'], 
            descs: [
                'Motion sensor with housing made from 80% recycled ocean plastic (partnership with Plastic Bank). Packaging is 100% plastic-free. Product passport for end-of-life recycling. B-Corp certification target. Premium pricing at $18 vs $12 standard.',
                'Fully solar-powered security system with 30W panel, LiFePO4 battery (10-year life), and energy-positive operation generating excess power. Carbon-neutral manufacturing via verified offset program. Targets eco-conscious premium buyers.',
                'Modular camera designed for 10-year lifespan with replaceable components: lens module, sensor board, WiFi chip. Repair guides and spare parts program. Take-back recycling with $6 credit toward new purchase.',
                'Security installation service with carbon footprint tracking. Electric vehicle installer fleet, low-VOC mounting materials, and tree planting offset (1 tree per installation). Monthly sustainability report in app.'
            ], 
            budgetRange: [5, 7], baseSuccess: 0.65, 
            riskProfile: 'medium', rewardProfile: 'moderate',
            scores: { technical: 3, marketsize: 3, strategic: 4, team: 4, capability: 4, ip: 3, platform: 3, sustainability: 5, newmarket: 4, geographic: 3, competitive: 4, devcost: 3, roi: 3, speed: 3, risk: 4 }, 
            quarterNarratives: { good: ['Eco-conscious segment responding well.', 'Press coverage generating brand uplift.', 'Retail partner interest strong.'], bad: ['Premium positioning requires education.', 'Recycled material supply chain building.'] }, 
            outcomeNarrative: { success: 'Sustainability leadership established. Premium justified.', failure: 'Repositioned sustainability as feature rather than primary value prop.' } 
        },
        { 
            archetype: 'proprietary_tech', 
            names: ['PatentShield Pro', 'ProprieTech Sensor', 'TradeSecret Cam'], 
            descs: [
                'Camera with patented "TruePresence" detection combining visible spectrum, thermal imaging, and micro-doppler radar. 12 patents filed covering sensor fusion algorithm, false-alarm elimination, and adaptive threshold learning. Licensing potential to competitors.',
                'Novel Micro-Electro-Mechanical Systems (MEMS) based vibration sensor detecting glass break, drilling, and forced entry with 99.7% accuracy. Trade secret manufacturing process impossible to reverse-engineer. Patent family of 8 covering core sensing mechanism.',
                'Video analytics using proprietary neural network architecture achieving 40% better accuracy than open-source alternatives on Indian faces/conditions. Training data from 500,000 labelled Indian security videos. Model weights protected as trade secret.'
            ], 
            budgetRange: [5, 7], baseSuccess: 0.65, 
            riskProfile: 'medium', rewardProfile: 'high',
            scores: { technical: 4, marketsize: 4, strategic: 5, team: 4, capability: 3, ip: 5, platform: 3, sustainability: 3, newmarket: 4, geographic: 3, competitive: 5, devcost: 3, roi: 4, speed: 3, risk: 4 }, 
            quarterNarratives: { good: ['Key patent granted, strengthening defensive position.', 'Licensing interest from international manufacturer.', 'Technical breakthrough achieved ahead of schedule.'], bad: ['Patent examination taking longer than expected.', 'Competitor filing requires response.'] }, 
            outcomeNarrative: { success: 'IP moat created lasting competitive advantage with licensing revenue.', failure: 'Patents valuable but commercialisation required pivot. Licensing strategy generated returns.' } 
        },
        // ============================================
        // NEW PROJECTS FROM EXPANDED DATABASE
        // ============================================
        { 
            archetype: 'ai_guard_innovation', 
            names: ['AI Guard Co-Pilot', 'GuardAssist Pro', 'SmartPatrol AI', 'SentinelBuddy'], 
            descs: [
                'Smartphone/bodycam app with on-device AI that listens and looks for anomalies (tailgating—unauthorized following through secure doors, perimeter breach, crowd aggression). Generates step-by-step Standard Operating Procedure (SOP) prompts in real-time and auto-logs incidents with time/location/clip. Works offline-first; escalates to remote Security Operations Center (SOC) when needed.',
                'AI-powered guard companion app using multimodal context and site-specific risk graphs to provide real-time guidance. Low-bandwidth incident summarization using edge LLM. Curated incident datasets and customer SOP libraries create defensible moat.',
                'On-device Computer Vision (CV) models (compressed for mobile) with audio event detection, geofencing, and Bluetooth Low Energy (BLE) beacons. AI generates templated incident summaries. Focus on workflow and guard interaction layer to differentiate from Video Management System (VMS) vendor AI offerings.',
                'Mobile-first security assistant with secure evidence chain. Competes with Staqu (AI video analytics), IBM/ServiceNow workflow, and Motorola Solutions bodycam ecosystem. Targets the guard enablement gap in Indian market.'
            ], 
            budgetRange: [4, 6], baseSuccess: 0.65, 
            riskProfile: 'medium', rewardProfile: 'high',
            scores: { technical: 5, marketsize: 4, strategic: 5, team: 4, capability: 4, ip: 5, platform: 4, sustainability: 4, newmarket: 4, geographic: 4, competitive: 4, devcost: 3, roi: 4, speed: 3, risk: 3 }, 
            quarterNarratives: { good: ['Guard pilot feedback exceptionally positive.', 'SOP recommendation accuracy exceeding targets.', 'Incident logging adoption rate strong.'], bad: ['Edge model optimization taking longer than planned.', 'Integration with legacy bodycam systems challenging.'] }, 
            outcomeNarrative: { success: 'Transformed guard effectiveness. Became standard equipment for enterprise security teams.', failure: 'Technology impressive but guard adoption slower than expected. Repositioned as SOC tool.' } 
        },
        { 
            archetype: 'services_platform', 
            names: ['Remote Video Patrol-as-a-Service', 'CloudGuard Monitoring', 'AI-Assisted SOC', 'VirtualPatrol Pro'], 
            descs: [
                'Subscription service where operators supervise 50-200 cameras per site with AI triage reducing false alarms. Generative AI drafts incident reports and customer updates; operators approve. Confidence-calibrated alert triage with operator load balancing.',
                'Multi-tenant SOC console with VMS connectors and event broker. Retrieval-augmented report generator with human-in-the-loop QA. Service Level Agreement (SLA) analytics dashboard. Alert thresholds optimized by vertical; staffing optimization models as trade secrets.',
                'Remote guarding platform competing with Prosegur and Securitas. GenAI uplift provides 2-3 year differentiation. Eagle Eye Networks and Genetec are key competitors in cloud VMS space.',
                'Managed monitoring service with auto-drafted reports and evidence linking. Partnership model with local monitoring centers. Focus on reducing operator fatigue while improving response quality.'
            ], 
            budgetRange: [6, 8], baseSuccess: 0.65, 
            riskProfile: 'low', rewardProfile: 'moderate',
            scores: { technical: 4, marketsize: 5, strategic: 4, team: 4, capability: 4, ip: 3, platform: 5, sustainability: 4, newmarket: 3, geographic: 4, competitive: 3, devcost: 3, roi: 5, speed: 4, risk: 4 }, 
            quarterNarratives: { good: ['Customer retention exceeding targets.', 'GenAI report quality praised by clients.', 'Operator efficiency gains validated.'], bad: ['SOC staffing costs higher than modeled.', 'False alarm reduction targets not yet met.'] }, 
            outcomeNarrative: { success: 'Recurring revenue stream established. Became preferred remote monitoring partner for enterprise clients.', failure: 'Service viable but margins tighter than planned. Focused on premium segment.' } 
        },
        { 
            archetype: 'autonomous_drone', 
            names: ['Autonomous Perimeter Drone Patrol', 'SkyGuard Sentinel', 'DronePatrol Enterprise', 'AeroWatch System'], 
            descs: [
                'Tethered drones for continuous perimeter watch plus untethered scheduled patrols. Auto-dock, auto-charging, thermal imaging, spotlight, and speaker for deterrence. Route planning constrained by DGCA geofencing and site risk zones.',
                'Drone-in-a-box solution with multi-sensor alarm fusion for drone dispatch. Thermal imaging, edge detection, secure command link. Integration with access control and VMS. Flight compliance logs for regulatory requirements.',
                'Competing with IdeaForge (India), DJI ecosystem, and Percepto (global autonomous). Partner/ODM strategy for docking hardware. Focus on Indian regulatory compliance and operational maturity.',
                'Enterprise perimeter security using autonomous aerial patrol. 24-48 month timeline to TRL 8. Key differentiator is DGCA-compliant flight planning with site-specific risk zone awareness.'
            ], 
            budgetRange: [8, 11], baseSuccess: 0.65, 
            riskProfile: 'high', rewardProfile: 'high',
            scores: { technical: 5, marketsize: 3, strategic: 4, team: 3, capability: 3, ip: 4, platform: 3, sustainability: 3, newmarket: 5, geographic: 3, competitive: 4, devcost: 2, roi: 3, speed: 2, risk: 2 }, 
            quarterNarratives: { good: ['DGCA approval pathway clarified.', 'Pilot site demonstrating value.', 'Thermal detection accuracy exceeding specs.'], bad: ['Regulatory timeline uncertain.', 'Weather resilience requiring additional engineering.'] }, 
            outcomeNarrative: { success: 'First-mover in compliant autonomous perimeter patrol. Premium pricing justified by results.', failure: 'Technology validated but market timing premature. Shifted to manned drone services.' } 
        },
        { 
            archetype: 'ground_robot', 
            names: ['Autonomous Ground Patrol Robot', 'RoboGuard Campus', 'PatrolBot Enterprise', 'SecureRover'], 
            descs: [
                'Rugged indoor/outdoor UGV with 360° cameras, thermal, and lidar. Patrol routes detect open doors, loitering, and smoke. Summons human responders. Low-cost navigation stack tuned for Indian environments (dust, uneven floors).',
                'Robot plus guard cooperative protocols differentiate from competitors. SLAM, lidar/radar, edge compute, remote teleop, auto-docking. Cybersecurity hardening for enterprise deployment. Mapping and anomaly baselines per facility.',
                'Competing with Knightscope (global), Cobalt Robotics, Boston Dynamics partners, and local robotics startups. 36-60 month development timeline. Focus on Indian environmental challenges.',
                'Campus and warehouse security robot with proven navigation in challenging conditions. Trade secrets include facility-specific mapping and anomaly detection baselines.'
            ], 
            budgetRange: [9, 12], baseSuccess: 0.65, 
            riskProfile: 'high', rewardProfile: 'high',
            scores: { technical: 5, marketsize: 3, strategic: 4, team: 3, capability: 2, ip: 4, platform: 3, sustainability: 3, newmarket: 5, geographic: 2, competitive: 3, devcost: 2, roi: 2, speed: 1, risk: 2 }, 
            quarterNarratives: { good: ['Navigation stack performing well in pilot.', 'Guard acceptance higher than expected.', 'Cost targets achievable with scale.'], bad: ['Outdoor reliability needs improvement.', 'Unit economics challenging at low volumes.'] }, 
            outcomeNarrative: { success: 'Established ShieldTech in physical robotics. Premium enterprise accounts.', failure: 'Technology validated but pivoted to partnership model with robotics manufacturer.' } 
        },
        { 
            archetype: 'privacy_compliance', 
            names: ['Privacy-Preserving Video Analytics', 'DPDP-Ready Analytics', 'AnonymousWatch', 'PrivacyFirst Vision'], 
            descs: [
                'Analytics that does not store faces by default. On-device feature extraction with reversible redaction only with authorization. Encrypted audit trails. Policy-driven reversible anonymization tied to incident workflow.',
                'Selective disclosure pipelines for compliance and trust. Reduces customer legal risk under DPDP Act. Face/body redaction with homomorphic-encryption-lite approaches or secure enclaves. Role-based key management.',
                'Differentiation through DPDP compliance and privacy-by-design. Competes with Genetec privacy features and cloud CCTV vendors. Focus on regulated industries (Banking, Financial Services &amp; Insurance, healthcare, government).',
                'Privacy-tech platform addressing growing regulatory requirements. 24-48 month development to TRL 7. First-mover advantage in Indian privacy-compliant video analytics.'
            ], 
            budgetRange: [5, 7], baseSuccess: 0.65, 
            riskProfile: 'medium', rewardProfile: 'high',
            scores: { technical: 4, marketsize: 4, strategic: 5, team: 4, capability: 3, ip: 4, platform: 4, sustainability: 5, newmarket: 4, geographic: 4, competitive: 4, devcost: 3, roi: 3, speed: 3, risk: 3 }, 
            quarterNarratives: { good: ['DPDP-readiness attracting enterprise interest.', 'Privacy certification on track.', 'Legal team validating approach.'], bad: ['Regulatory requirements still evolving.', 'Performance impact of encryption higher than expected.'] }, 
            outcomeNarrative: { success: 'Became the trusted choice for privacy-conscious enterprises. Regulatory tailwind accelerated adoption.', failure: 'Market demand slower than regulations suggested. Positioned as premium add-on.' } 
        },
        { 
            archetype: 'evidence_chain', 
            names: ['Verifiable Video Evidence Chain', 'CourtReady Evidence', 'TamperProof Video', 'EvidenceLock'], 
            descs: [
                'Every clip/export is cryptographically signed with chain-of-custody reports generated automatically. Integrates with bodycams and CCTV. End-to-end evidence provenance across heterogeneous camera fleets.',
                'Multi-party attestation (client plus security provider). Hash chaining, secure timestamps, key management, watermarking, audit logs, export packaging. Aligns with digital evidence best practices.',
                'Competing with Axon evidence ecosystem, Motorola Solutions, and forensic tool providers. Standards-aligned with proprietary implementation. 18-30 month timeline to TRL 9.',
                'Court-admissible video evidence solution. Addresses growing need for legally defensible security footage. Key differentiator is heterogeneous camera fleet support.'
            ], 
            budgetRange: [7, 9], baseSuccess: 0.65, 
            riskProfile: 'low', rewardProfile: 'moderate',
            scores: { technical: 4, marketsize: 4, strategic: 4, team: 4, capability: 4, ip: 4, platform: 3, sustainability: 4, newmarket: 3, geographic: 4, competitive: 4, devcost: 4, roi: 4, speed: 4, risk: 4 }, 
            quarterNarratives: { good: ['Legal validation of evidence chain approach.', 'Integration with major VMS platforms complete.', 'Enterprise pilot generating positive feedback.'], bad: ['Key management complexity higher than expected.', 'Legacy camera integration challenging.'] }, 
            outcomeNarrative: { success: 'Standard for court-ready video evidence in India. Strong recurring revenue from enterprise accounts.', failure: 'Technology validated but sales cycle longer than expected. Focused on high-value accounts.' } 
        },
        { 
            archetype: 'smart_access', 
            names: ['Smart Access Control with RBA', 'RiskGate Pro', 'AdaptiveAccess', 'ContextualEntry'], 
            descs: [
                'Access decisions based on risk (time, crowding, badge anomalies, tailgating probability). Risk-based authentication triggers step-up checks (PIN/biometric/security question) only when needed. Risk scoring for physical access using multimodal sensors.',
                'Dynamic policies per zone with risk orchestration layer. Access controller integration, BLE/UWB, turnstile sensors, CV tailgating detection, policy engine. Focus on orchestration to differentiate from HID Global and Honeywell.',
                'Competing with Johnson Controls, Suprema, and local integrators. 24-36 month timeline to TRL 8-9. Risk-adaptive approach reduces friction while maintaining security.',
                'Next-generation access control moving beyond binary allow/deny to contextual risk assessment. Strong IP position in risk scoring algorithms.'
            ], 
            budgetRange: [6, 8], baseSuccess: 0.65, 
            riskProfile: 'medium', rewardProfile: 'moderate',
            scores: { technical: 4, marketsize: 4, strategic: 4, team: 4, capability: 4, ip: 4, platform: 4, sustainability: 3, newmarket: 3, geographic: 4, competitive: 3, devcost: 3, roi: 4, speed: 3, risk: 4 }, 
            quarterNarratives: { good: ['Risk scoring accuracy exceeding targets.', 'Tailgating detection precision validated.', 'Enterprise pilot showing reduced friction.'], bad: ['Integration with legacy access systems complex.', 'False positive rate needs optimization.'] }, 
            outcomeNarrative: { success: 'Redefined access control category. Premium positioning justified by measurable security improvement.', failure: 'Technology sound but market education required. Partnered with access control vendors.' } 
        },
        { 
            archetype: 'rtls_tracking', 
            names: ['Ultra-Wideband (UWB) Indoor Tracking Platform', 'AssetTrack Pro', 'SafeZone RTLS', 'PrecisionLocate'], 
            descs: [
                'UWB anchors plus tags to track forklifts, high-value assets, and lone workers. Alerts for proximity hazards and restricted zones. Security-grade Real-Time Location System (RTLS) with tamper detection and incident replay. Fusion with CCTV timeline.',
                'Movement and incident graphs by site type create data moat. UWB with BLE backup, RTLS engine, mobile dashboards, integration with Environment, Health &amp; Safety (EHS) and SOC. Competing with Zebra, Quuppa, Sewio.',
                'Indian RTLS solution optimized for warehouse and manufacturing environments. Focus on safety compliance and asset protection. Strong partnership potential with EHS software vendors.',
                'Enterprise positioning system combining asset tracking with staff safety. Unique integration with security infrastructure differentiates from pure RTLS vendors.'
            ], 
            budgetRange: [6, 8], baseSuccess: 0.65, 
            riskProfile: 'medium', rewardProfile: 'moderate',
            scores: { technical: 4, marketsize: 4, strategic: 4, team: 4, capability: 4, ip: 4, platform: 4, sustainability: 4, newmarket: 4, geographic: 3, competitive: 3, devcost: 3, roi: 4, speed: 4, risk: 4 }, 
            quarterNarratives: { good: ['Positioning accuracy exceeding requirements.', 'Safety use cases resonating with EHS teams.', 'CCTV integration creating differentiation.'], bad: ['UWB anchor deployment costs higher than modeled.', 'Battery life optimization needed for wearables.'] }, 
            outcomeNarrative: { success: 'Expanded ShieldTech into industrial safety market. Strong cross-sell with existing security products.', failure: 'Technology validated but focused on partnership with RTLS specialist.' } 
        },
        { 
            archetype: 'acoustic_detection', 
            names: ['Gunshot/Blast Acoustic Detection', 'SoundSentinel Network', 'AcousticAlert Pro', 'BlastDetect'], 
            descs: [
                'Distributed acoustic sensors detect gunshot-like signatures, blasts, and glass break. Triangulate location, auto-cue cameras, and dispatch responders. Low-cost acoustic localization tuned for Indian urban soundscapes.',
                'False-positive suppression using context (events, festivals, traffic). Microphone arrays, edge DSP, ML classifiers, time-sync (PTP/GPS), VMS cueing. Competing with ShotSpotter-style solutions globally.',
                'Niche acoustic detection for urban and campus environments. 36-60 month development timeline. Focus on Indian-specific sound environment challenges.',
                'Audio-based threat detection complementing video analytics. Strong IP in contextual false-positive suppression. Partnership potential with smart city initiatives.'
            ], 
            budgetRange: [7, 9], baseSuccess: 0.65, 
            riskProfile: 'high', rewardProfile: 'high',
            scores: { technical: 4, marketsize: 3, strategic: 4, team: 3, capability: 3, ip: 4, platform: 3, sustainability: 3, newmarket: 5, geographic: 3, competitive: 4, devcost: 3, roi: 3, speed: 2, risk: 3 }, 
            quarterNarratives: { good: ['Detection accuracy validated in controlled tests.', 'Urban soundscape model improving.', 'Smart city pilot interest strong.'], bad: ['False positive rate in dense urban areas challenging.', 'Hardware costs higher than targets.'] }, 
            outcomeNarrative: { success: 'Pioneered acoustic detection for Indian smart cities. Government contracts secured.', failure: 'Technology promising but market timing early. Maintained as R&D capability.' } 
        },
        { 
            archetype: 'digital_twin', 
            names: ['Secure Facility Digital Twin', 'SimulationShield', 'TwinGuard Platform', 'VirtualSite Pro'], 
            descs: [
                'Lightweight digital twin of each client site: zones, cameras, access points, patrol routes. Run what-if simulations and tabletop exercises. Generate training missions for guards. Auto-building twin from floorplans plus camera metadata.',
                'AI-generated drills tied to actual near-misses. Risk models by vertical as trade secrets. CAD/floorplan ingestion, graph model, simulation engine, training content generator, KPI tracking.',
                'Competing with large facility management platforms and niche simulation vendors. 24-48 month development to TRL 7. Focus on security-specific use cases.',
                'Training and planning platform leveraging site digital models. Strong differentiation through AI-generated scenario content based on real incident patterns.'
            ], 
            budgetRange: [8, 10], baseSuccess: 0.65, 
            riskProfile: 'medium', rewardProfile: 'moderate',
            scores: { technical: 4, marketsize: 3, strategic: 5, team: 4, capability: 3, ip: 4, platform: 5, sustainability: 4, newmarket: 4, geographic: 3, competitive: 4, devcost: 3, roi: 3, speed: 3, risk: 3 }, 
            quarterNarratives: { good: ['Auto-twin generation accuracy improving.', 'Training scenario engagement high.', 'Enterprise security teams showing strong interest.'], bad: ['Floorplan ingestion more complex than expected.', 'Simulation fidelity requirements increasing scope.'] }, 
            outcomeNarrative: { success: 'Transformed security training and planning. Platform became sticky enterprise tool.', failure: 'Technology validated but narrowed focus to training content generation.' } 
        },
        { 
            archetype: 'perimeter_fusion', 
            names: ['Multi-Sensor Perimeter System', 'FenceGuard Fusion', 'PerimeterShield Pro', 'BoundaryWatch'], 
            descs: [
                'Productized perimeter kit: fiber vibration sensing, microwave, mmWave radar, plus thermal cameras fused into single alarm feed with intrusion track. Sensor-fusion model with adaptive calibration. Terrain-aware intrusion tracking.',
                'Fiber DAS/DVS integration, mmWave radar, thermal, edge fusion, GIS map UI. Perimeter sensors commoditized; own the fusion plus UX layer. Competing with Magal, Senstar, Dahua/Hikvision perimeter.',
                'Indian perimeter integrator solution with superior fusion and user experience. Strong position against commodity sensor vendors through software differentiation.',
                'Enterprise perimeter security combining best-of-breed sensors with unified management. Quick timeline to TRL 9 given mature component technologies.'
            ], 
            budgetRange: [7, 9], baseSuccess: 0.65, 
            riskProfile: 'low', rewardProfile: 'moderate',
            scores: { technical: 4, marketsize: 4, strategic: 4, team: 4, capability: 4, ip: 3, platform: 4, sustainability: 3, newmarket: 3, geographic: 4, competitive: 3, devcost: 3, roi: 4, speed: 4, risk: 4 }, 
            quarterNarratives: { good: ['Sensor fusion accuracy exceeding targets.', 'Installation time significantly reduced.', 'Customer UX feedback very positive.'], bad: ['Fiber sensing integration more complex than planned.', 'Calibration requirements varying by terrain.'] }, 
            outcomeNarrative: { success: 'Became preferred perimeter solution for critical infrastructure. Strong margins on software layer.', failure: 'Product viable but competed on hardware integration services rather than software premium.' } 
        },
        { 
            archetype: 'cyber_physical_soc', 
            names: ['Cyber-Physical SOC Platform', 'UnifiedSOC Pro', 'ConvergenceCenter', 'HybridThreat Platform'], 
            descs: [
                'SOC product/service correlating physical events (door forced, camera offline) with IT/OT signals (VPN anomaly, PLC alert) to detect blended attacks. Cross-domain correlation rules plus anomaly graphs. Playbooks coordinating guards plus IT.',
                'SIEM/SOAR connectors, event normalization, graph analytics, playbook automation, secure multi-tenant. Partnerships with SIEM/SOAR vendors; keep correlation layer proprietary. Competing with Splunk, Microsoft Sentinel ecosystem.',
                'Addressing convergence of physical and cyber security. 24-48 month development to TRL 8. Strong differentiation through physical security expertise.',
                'Enterprise security operations platform bridging traditional silos. Unique positioning at intersection of physical security and cybersecurity markets.'
            ], 
            budgetRange: [8, 10], baseSuccess: 0.65, 
            riskProfile: 'high', rewardProfile: 'high',
            scores: { technical: 5, marketsize: 4, strategic: 5, team: 4, capability: 3, ip: 4, platform: 5, sustainability: 4, newmarket: 5, geographic: 3, competitive: 4, devcost: 2, roi: 3, speed: 2, risk: 3 }, 
            quarterNarratives: { good: ['Correlation engine detecting novel attack patterns.', 'SIEM integration partnerships progressing.', 'Enterprise pilot validating value proposition.'], bad: ['Integration complexity higher than planned.', 'Sales cycle requiring both physical and IT security buy-in.'] }, 
            outcomeNarrative: { success: 'Defined new category of converged security operations. Premium enterprise pricing.', failure: 'Technology validated but focused on partnership with SIEM vendor.' } 
        },
        { 
            archetype: 'camera_health', 
            names: ['Camera/IoT Health Assurance', 'SurveillanceHealth Pro', 'CamCare Platform', 'IoTGuardian'], 
            descs: [
                'Detect camera blind/defocus/occlusion, cable tamper, Digital Video Recorder (DVR)/Network Video Recorder (NVR) disk failures. Auto-remediate (reboot, switch stream, dispatch technician) and prove uptime SLAs. Vision-based self-diagnosis plus auto-troubleshooting decision tree.',
                'Vendor-specific fix playbooks as trade secrets. CV health checks, SNMP/ONVIF monitoring, remote device management, SLA dashboards. Quick path to TRL 9 given mature underlying technologies.',
                'Competing with VMS vendor health modules and device management startups. Differentiation through proactive remediation and SLA proof.',
                'Infrastructure reliability platform ensuring security systems perform when needed. Strong recurring revenue potential through managed service model.'
            ], 
            budgetRange: [8, 10], baseSuccess: 0.65, 
            riskProfile: 'low', rewardProfile: 'low',
            scores: { technical: 3, marketsize: 4, strategic: 3, team: 4, capability: 5, ip: 3, platform: 4, sustainability: 4, newmarket: 2, geographic: 4, competitive: 3, devcost: 4, roi: 5, speed: 5, risk: 5 }, 
            quarterNarratives: { good: ['Health detection accuracy very high.', 'Auto-remediation reducing service calls.', 'SLA dashboard praised by facility managers.'], bad: ['Legacy camera support more complex than expected.', 'Some vendors resisting deep integration.'] }, 
            outcomeNarrative: { success: 'Essential tool for managed security services. Strong attach rate to camera deployments.', failure: 'Viable product but bundled with services rather than sold standalone.' } 
        },
        { 
            archetype: 'panic_wearable', 
            names: ['Smart Panic Wearables', 'StaffSafe Pro', 'VIPGuard Wearable', 'PanicButton Plus'], 
            descs: [
                'Wearable panic button plus inertial sensors detect falls/assault. Discreet SOS with location. Auto-record audio snippet. Connects to nearest guard and SOC. Assault/fall inference plus escalation logic. Privacy-preserving audio capture with consent workflow.',
                'Hardware may be ODM; protect firmware plus backend. BLE/LTE wearables, geofencing, mobile app, SOC dispatch, battery optimization. Competing with SafeTrek-like apps and Telco IoT wearable offerings.',
                'Staff and VIP safety solution combining hardware and services. Quick timeline to TRL 9. Focus on enterprise deployment with SOC integration.',
                'Personal safety wearable with professional-grade response infrastructure. Differentiation through seamless SOC integration and evidence capture.'
            ], 
            budgetRange: [8, 10], baseSuccess: 0.65, 
            riskProfile: 'low', rewardProfile: 'moderate',
            scores: { technical: 3, marketsize: 4, strategic: 3, team: 4, capability: 4, ip: 3, platform: 3, sustainability: 4, newmarket: 3, geographic: 4, competitive: 3, devcost: 4, roi: 4, speed: 5, risk: 4 }, 
            quarterNarratives: { good: ['Fall detection accuracy validated.', 'Enterprise adoption strong in healthcare.', 'SOC integration seamless.'], bad: ['Battery life optimization ongoing.', 'Consumer market more competitive than expected.'] }, 
            outcomeNarrative: { success: 'Standard safety equipment for high-risk industries. Strong recurring revenue from monitoring service.', failure: 'Enterprise focus validated. Exited consumer market to focus on B2B.' } 
        },
        { 
            archetype: 'vehicle_intelligence', 
            names: ['LPR + Vehicle Intent Scoring', 'SmartGate Analytics', 'VehicleIQ Platform', 'IntentWatch'], 
            descs: [
                'Beyond license plate recognition: score vehicle intent using entry patterns, dwell time, driver behavior, blacklists/whitelists, route deviation. Reduce insider theft and staging. Vehicle intent scoring fused with bay schedules plus access logs.',
                'Site-specific vehicle graphs as data moat. LPR cameras, re-ID models, rule plus ML scoring, integration with gate operations. Competing with OpenALPR vendors and logistics security platforms.',
                'Advanced vehicle analytics for gated campuses and logistics facilities. 24-36 month timeline to TRL 8-9. Focus on insider threat detection.',
                'Next-generation vehicle access management moving beyond simple plate recognition to behavioral analysis. Strong IP in intent scoring algorithms.'
            ], 
            budgetRange: [7, 9], baseSuccess: 0.65, 
            riskProfile: 'medium', rewardProfile: 'moderate',
            scores: { technical: 4, marketsize: 4, strategic: 4, team: 4, capability: 4, ip: 4, platform: 4, sustainability: 3, newmarket: 3, geographic: 4, competitive: 4, devcost: 4, roi: 4, speed: 4, risk: 4 }, 
            quarterNarratives: { good: ['Intent scoring reducing false positives.', 'Logistics customers seeing theft reduction.', 'Integration with gate systems smooth.'], bad: ['Training data collection slower than planned.', 'Privacy concerns requiring additional safeguards.'] }, 
            outcomeNarrative: { success: 'Redefined vehicle access security. Strong adoption in logistics and manufacturing.', failure: 'Technology validated but market education required. Partnered with LPR vendors.' } 
        },
        { 
            archetype: 'compliance_automation', 
            names: ['One-Click Compliance Reporting', 'AuditReady Platform', 'ComplianceBot Pro', 'RegReport Suite'], 
            descs: [
                'Auto-generate monthly/quarterly security compliance packs: patrol completeness, incident MTTR, access anomalies, camera uptime, training attendance. Export to client formats. Data lake, report generator, dashboarding, e-sign approvals, audit trails.',
                'KPI benchmarks by industry as trade secrets. Defensible via integrations plus library of regulatory mappings. Competing with GRC tools and facility management suites. Quick timeline to TRL 9.',
                'Compliance automation for BFSI, pharma, and data center verticals. Focus on reducing audit burden while improving compliance posture.',
                'Enterprise compliance platform leveraging ShieldTech ecosystem data. Strong recurring revenue through subscription model.'
            ], 
            budgetRange: [8, 10], baseSuccess: 0.65, 
            riskProfile: 'low', rewardProfile: 'low',
            scores: { technical: 3, marketsize: 4, strategic: 4, team: 4, capability: 5, ip: 2, platform: 4, sustainability: 4, newmarket: 2, geographic: 4, competitive: 3, devcost: 5, roi: 5, speed: 5, risk: 5 }, 
            quarterNarratives: { good: ['Report templates well-received by compliance teams.', 'Integration with audit workflows smooth.', 'Time savings quantified and significant.'], bad: ['Regulatory mapping more complex than expected.', 'Customization requests increasing scope.'] }, 
            outcomeNarrative: { success: 'Essential tool for regulated industries. High attach rate to enterprise deployments.', failure: 'Viable product but competed with established GRC vendors. Focused on security-specific compliance.' } 
        },
        { 
            archetype: 'deepfake_defense', 
            names: ['Deepfake-Resistant Authorization', 'TrueIdentity Pro', 'LivenessGuard', 'AuthentiCheck'], 
            descs: [
                'For remote gate approvals, fund/asset release, or VIP access: multi-factor liveness plus challenge-response plus device attestation. Detects deepfake video/voice and replay attacks. Risk-adaptive liveness plus context checks for physical security approvals.',
                'Use licensed liveness where needed; own orchestration plus policy engine. Liveness detection, voice anti-spoofing, secure enclave/attestation, transaction signing, audit trails. 24-48 month timeline to TRL 7-8.',
                'Addressing emerging deepfake threat to remote authorization. Competing with ID verification vendors and fintech KYC providers. Physical security-specific focus differentiates.',
                'Future-proof authentication for high-value approvals. Strong IP in risk-adaptive orchestration. Partnership potential with biometric vendors.'
            ], 
            budgetRange: [8, 10], baseSuccess: 0.65, 
            riskProfile: 'high', rewardProfile: 'high',
            scores: { technical: 5, marketsize: 3, strategic: 5, team: 4, capability: 3, ip: 4, platform: 4, sustainability: 4, newmarket: 5, geographic: 3, competitive: 4, devcost: 3, roi: 3, speed: 2, risk: 3 }, 
            quarterNarratives: { good: ['Deepfake detection accuracy improving rapidly.', 'High-value use cases generating strong interest.', 'Partnership with liveness vendor progressing.'], bad: ['Deepfake technology evolving faster than detection.', 'User experience friction requiring optimization.'] }, 
            outcomeNarrative: { success: 'Became trusted solution for high-stakes remote authorization. Premium pricing for critical use cases.', failure: 'Technology validated but market timing early. Maintained as advanced authentication option.' } 
        },
        { 
            archetype: 'edge_micro_nvr', 
            names: ['Edge AI Micro-NVR', 'LocalGuard Box', 'SiteCache Pro', 'EdgeVault'], 
            descs: [
                'Small rugged box (or camera firmware package) running analytics plus storing encrypted footage locally. Syncs only events to cloud. Ideal for Tier-2/3 cities and remote plants. Event-first sync plus bandwidth-aware retention policy.',
                'Hardware is commodity; protect firmware plus orchestration software. Edge compute, containerized analytics, encrypted local storage, delta sync, remote management. Competing with Verkada-style closed ecosystems.',
                'Low-bandwidth video security for underserved markets. Quick timeline to TRL 8-9. Strong fit with ShieldTech rural/semi-urban expansion strategy.',
                'Hybrid cloud-edge architecture optimized for Indian infrastructure reality. Differentiation through intelligent sync and bandwidth management.'
            ], 
            budgetRange: [7, 9], baseSuccess: 0.65, 
            riskProfile: 'low', rewardProfile: 'moderate',
            scores: { technical: 4, marketsize: 5, strategic: 4, team: 4, capability: 4, ip: 3, platform: 4, sustainability: 4, newmarket: 4, geographic: 5, competitive: 4, devcost: 4, roi: 4, speed: 4, risk: 4 }, 
            quarterNarratives: { good: ['Bandwidth reduction exceeding targets.', 'Tier-2/3 city pilots very successful.', 'Edge analytics performance validated.'], bad: ['Hardware supply chain challenges.', 'Remote management requiring more features.'] }, 
            outcomeNarrative: { success: 'Enabled expansion into bandwidth-constrained markets. Strong volume growth.', failure: 'Technology validated but competed with cloud-only pricing. Repositioned as premium option.' } 
        },
        { 
            archetype: 'rapid_deploy_kit', 
            names: ['Rapid-Deploy Pop-up Security Kit', 'EventGuard Express', 'TempSecure Box', 'InstantShield'], 
            descs: [
                'Boxed kit deployed in under 2 hours: solar plus LTE cameras, perimeter beacons, portable access control, panic buttons, command tablet. Priced per day/week. LTE cameras, battery/solar, mesh networking, temporary mounts, preconfigured SOC profiles.',
                'Mostly system design plus logistics; patent limited but defensible via packaging plus SOP plus rental network. Strong operational moat. Quick timeline to TRL 9.',
                'Competing with event security providers and CCTV rental firms. Differentiation through integrated solution and rapid deployment.',
                'Temporary security solution for events, construction sites, and emergency response. Rental model creates recurring revenue opportunity.'
            ], 
            budgetRange: [8, 10], baseSuccess: 0.65, 
            riskProfile: 'low', rewardProfile: 'low',
            scores: { technical: 3, marketsize: 4, strategic: 3, team: 4, capability: 4, ip: 2, platform: 3, sustainability: 3, newmarket: 4, geographic: 4, competitive: 3, devcost: 4, roi: 4, speed: 5, risk: 4 }, 
            quarterNarratives: { good: ['Deployment time meeting targets.', 'Event security market responding well.', 'Rental economics validated.'], bad: ['Logistics network build-out slower than planned.', 'Damage/loss rates higher than modeled.'] }, 
            outcomeNarrative: { success: 'Created new revenue stream in temporary security market. Strong utilization rates.', failure: 'Viable business but logistics challenges led to partnership with event rental company.' } 
        },
        { 
            archetype: 'predictive_risk', 
            names: ['Predictive Security Risk Engine', 'RiskForecast Pro', 'ThreatPredict Platform', 'SecurityAI Planner'], 
            descs: [
                'Use historical incidents plus environment signals (shift patterns, holidays, local events, weather, footfall) to forecast risk by site/zone. Recommend patrol schedules, staffing, and sensor upgrades. Security-specific causal features plus counterfactual staffing simulator.',
                'Multi-client anonymized benchmarks (with consent plus privacy controls) as data moat. Time-series forecasting, causal modeling, optimization, integration with rostering plus SOC plus digital twin. 36-60 month development timeline.',
                'Competing with analytics consultancies and workforce management vendors adding AI. Focus on security-specific modeling expertise.',
                'Advanced analytics platform for security resource optimization. Long development timeline but significant differentiation potential through proprietary models.'
            ], 
            budgetRange: [7, 9], baseSuccess: 0.65, 
            riskProfile: 'high', rewardProfile: 'high',
            scores: { technical: 5, marketsize: 3, strategic: 5, team: 4, capability: 3, ip: 5, platform: 5, sustainability: 4, newmarket: 5, geographic: 3, competitive: 5, devcost: 2, roi: 3, speed: 1, risk: 2 }, 
            quarterNarratives: { good: ['Forecast accuracy improving with more data.', 'Early adopters seeing measurable improvements.', 'Model interpretability praised by security directors.'], bad: ['Data collection and normalization challenging.', 'Proving ROI requires longer customer engagement.'] }, 
            outcomeNarrative: { success: 'Transformed security from reactive to predictive. Strategic differentiator for enterprise accounts.', failure: 'Technology validated but narrowed focus to specific use cases. Continued as R&D initiative.' } 
        },
        { 
            archetype: 'visitor_flow', 
            names: ['VisitorFlow Pro', 'QueueGuard Service', 'EntryCare Manager', 'LobbyControl System'], 
            descs: [
                'Managed service keeping entrances calm at high-footfall sites. Pre-registration + walk-in handling, badge issuing, queue monitoring with supervisor visibility, incident logging with photo/clip evidence, and monthly insights on peak times and bottlenecks.',
                'Corporate lobby and clinic entrance management combining visitor check-in workflow, crowd density monitoring via cameras, rule-based alerts for crowding thresholds, and audit-ready incident records with time-stamped actions.',
                'Campus and event venue queue security with SMS/WhatsApp pass links, people counting for queue length, escalation procedures for denied entry patterns, and monthly performance reporting with recommended fixes.',
                'Plant and warehouse visitor management integrating access control, dwell-time monitoring near sensitive doors, supervisor dashboards for peak hours, and compliance-ready documentation for client reviews.'
            ], 
            budgetRange: [4, 6], baseSuccess: 0.70, 
            riskProfile: 'low', rewardProfile: 'moderate',
            scores: { technical: 3, marketsize: 4, strategic: 4, team: 4, capability: 5, ip: 2, platform: 3, sustainability: 4, newmarket: 3, geographic: 4, competitive: 3, devcost: 4, roi: 4, speed: 5, risk: 4 }, 
            quarterNarratives: { good: ['Visitor check-in workflow streamlined.', 'Client feedback on queue management positive.', 'Incident documentation praised by auditors.'], bad: ['Peak hour staffing coordination challenging.', 'Integration with existing access systems complex.'] }, 
            outcomeNarrative: { success: 'Became standard offering for corporate clients. Strong recurring revenue from managed service.', failure: 'Service viable but scaled back to high-value sites only.' } 
        },
        { 
            archetype: 'security_score', 
            names: ['SiteScore Pro', 'SecurityHealth Check', 'GuardMetrics Monthly', 'FacilityAudit Service'], 
            descs: [
                'Monthly or quarterly security review scoring sites on camera uptime, blind spots, door misuse, guard tour completion, alarm response time, and incident patterns. Board-ready reports with improvement roadmaps and gap registers.',
                'Standardized 8-12 metric scorecard with on-site walk-throughs, remote system checks, and benchmark comparisons by industry. Clients use reports to justify upgrades and track year-over-year improvements.',
                'Quarterly health check combining patrol log analysis, CCTV health monitoring, access control anomalies, and incident MTTR tracking. Delivers prioritized action lists: quick fixes vs capital projects.',
                'Enterprise security assessment service with industry benchmarks for warehouses, offices, hospitals. Dashboard pulling data from patrol apps, camera health tools, and access logs for comprehensive site evaluation.'
            ], 
            budgetRange: [3, 5], baseSuccess: 0.75, 
            riskProfile: 'low', rewardProfile: 'moderate',
            scores: { technical: 3, marketsize: 4, strategic: 4, team: 4, capability: 5, ip: 2, platform: 3, sustainability: 4, newmarket: 3, geographic: 5, competitive: 3, devcost: 5, roi: 4, speed: 5, risk: 5 }, 
            quarterNarratives: { good: ['Scoring methodology validated by clients.', 'Benchmark library growing rapidly.', 'Renewal rates exceeding projections.'], bad: ['Data collection from legacy systems challenging.', 'Standardization across site types complex.'] }, 
            outcomeNarrative: { success: 'Essential service for multi-site enterprises. High attach rate to existing contracts.', failure: 'Valuable but bundled with other services rather than standalone.' } 
        },
        { 
            archetype: 'smart_key_control', 
            names: ['KeyVault Pro', 'AssetCustody System', 'SmartLocker Plus', 'ShiftControl Manager'], 
            descs: [
                'Smart key cabinet and locker system preventing loss of master keys, radios, and shared tools. Role-based access, shift handover workflows, supervisor sign-off, and alerts for late returns or unusual access patterns.',
                'RFID/iButton tagged asset management for warehouses and plants. Tamper-logged lockers with audit reports supporting investigations. Integration with HR rostering and access control systems.',
                'Hospital and campus key control with custody chain tracking, exception handling workflows, and after-hours asset removal alerts. Compliance reporting for regulatory audits.',
                'Industrial asset accountability system combining smart cabinets, mobile supervisor dashboards, anomaly detection for frequency/duration/time-of-day patterns, and effortless audit documentation.'
            ], 
            budgetRange: [5, 7], baseSuccess: 0.70, 
            riskProfile: 'low', rewardProfile: 'moderate',
            scores: { technical: 3, marketsize: 4, strategic: 3, team: 4, capability: 4, ip: 3, platform: 3, sustainability: 4, newmarket: 3, geographic: 4, competitive: 3, devcost: 4, roi: 4, speed: 4, risk: 4 }, 
            quarterNarratives: { good: ['Handover workflow reducing disputes.', 'Audit capabilities praised by compliance teams.', 'Hardware reliability exceeding expectations.'], bad: ['Legacy locker integration more complex than planned.', 'User adoption requiring additional training.'] }, 
            outcomeNarrative: { success: 'Standard solution for industrial clients. Strong margins on hardware + service bundle.', failure: 'Hardware viable but software differentiation limited. Partnered with locker vendors.' } 
        },
        { 
            archetype: 'emergency_muster', 
            names: ['MusterPoint Pro', 'RollCall System', 'EvacTrack Platform', 'HeadCount Manager'], 
            descs: [
                'Mustering system for drills and real emergencies quickly confirming who is safe, who is missing, and their last-known zone. Zone-based check-in via QR/NFC badges, offline-capable app for weak network areas, and after-action timeline reports.',
                'Factory and warehouse roll-call solution with real-time missing person lists, integration with access systems for last-known location, and incident commander dashboard for coordinated response.',
                'Construction site and campus evacuation tracking using BLE/UWB for zone accuracy in complex facilities. Exportable logs for compliance and improvement action documentation.',
                'Large office mustering platform with automatic escalation workflows, offline-first design syncing on network return, and drill performance analytics for continuous improvement.'
            ], 
            budgetRange: [4, 6], baseSuccess: 0.65, 
            riskProfile: 'medium', rewardProfile: 'moderate',
            scores: { technical: 4, marketsize: 4, strategic: 4, team: 4, capability: 4, ip: 3, platform: 3, sustainability: 4, newmarket: 3, geographic: 4, competitive: 3, devcost: 4, roi: 4, speed: 4, risk: 4 }, 
            quarterNarratives: { good: ['Drill response times significantly improved.', 'Offline mode performing reliably.', 'EHS teams championing adoption.'], bad: ['BLE accuracy in industrial environments challenging.', 'Integration with legacy access systems complex.'] }, 
            outcomeNarrative: { success: 'Required system for large industrial sites. Strong cross-sell with other safety solutions.', failure: 'Technology validated but market fragmented. Focused on vertical specialization.' } 
        },
        { 
            archetype: 'night_escort', 
            names: ['SafeRoute Service', 'NightGuard Escort', 'CampusSafe Tracker', 'EscortLink Platform'], 
            descs: [
                'Campus and corporate park night escort service with app-based requests, guard dispatch with response SLAs, live GPS tracking to destination, and SOS/panic escalation to supervisors or remote monitoring.',
                'University safety service combining request-to-dispatch workflow, automatic start/end journey confirmations, supervisor visibility dashboard, and monthly hotspot reports for high-request areas.',
                'Corporate park escort tracking with optional wearable panic buttons for higher-risk users, integration with guard shift rosters, and performance analytics proving response times to clients.',
                'Tech park night safety solution with geofenced alerts, route tracking with audit trails, and monthly insights identifying areas and times with elevated incidents or requests.'
            ], 
            budgetRange: [3, 5], baseSuccess: 0.70, 
            riskProfile: 'low', rewardProfile: 'moderate',
            scores: { technical: 3, marketsize: 3, strategic: 3, team: 4, capability: 5, ip: 2, platform: 3, sustainability: 4, newmarket: 3, geographic: 4, competitive: 3, devcost: 4, roi: 4, speed: 5, risk: 4 }, 
            quarterNarratives: { good: ['User adoption exceeding expectations.', 'Response SLAs consistently met.', 'Campus administrators highly satisfied.'], bad: ['Coverage density requiring more resources than planned.', 'App reliability in low-connectivity areas challenging.'] }, 
            outcomeNarrative: { success: 'Differentiating service for campus security contracts. Strong recurring revenue.', failure: 'Service valuable but labor-intensive. Optimized for premium locations only.' } 
        },
        { 
            archetype: 'guard_training_sim', 
            names: ['GuardSim Pro', 'ScenarioDrill Platform', 'TrainingEdge System', 'SOPTrainer Mobile'], 
            descs: [
                'Phone-based guard training with 30-60 branching scenarios per industry: tailgating, suspicious packages, aggressive visitors, medical emergencies. SOP-aligned feedback, certification tracking, and monthly micro-drill schedules.',
                'Mobile learning platform with multilingual support, short video/audio prompts, and offline mode. Supervisor dashboard showing completion rates, scores, and coaching suggestions for underperformers.',
                'Convert real incidents into new training scenarios. Scenario library mapped to client SOPs, scoring rubrics for consistent evaluation, and refresher schedules ensuring continuous readiness.',
                'Guard readiness platform reducing variation in service quality through realistic drills. Quick quizzes, branching decisions, and performance analytics identifying training gaps across the workforce.'
            ], 
            budgetRange: [4, 6], baseSuccess: 0.70, 
            riskProfile: 'low', rewardProfile: 'moderate',
            scores: { technical: 3, marketsize: 4, strategic: 4, team: 4, capability: 4, ip: 3, platform: 4, sustainability: 4, newmarket: 3, geographic: 5, competitive: 3, devcost: 4, roi: 4, speed: 4, risk: 4 }, 
            quarterNarratives: { good: ['Scenario engagement rates high.', 'Guard performance metrics improving.', 'Client feedback on training quality positive.'], bad: ['Content localization more extensive than planned.', 'Offline sync reliability requiring fixes.'] }, 
            outcomeNarrative: { success: 'Standard training platform for security workforce. Strong differentiation in contract bids.', failure: 'Content valuable but delivery platform competitive. Licensed scenarios to training partners.' } 
        },
        { 
            archetype: 'incident_invoice', 
            names: ['ProofPack Service', 'ResponseDoc System', 'IncidentBill Pro', 'EvidenceChain Platform'], 
            descs: [
                'System packaging response work into clean billing records: dispatch time, arrival time, actions taken, photos/video clips, and digital sign-offs. Reduces disputes with automated proof pack PDFs for each call-out.',
                'Guard and supervisor mobile reporting with standard incident forms, evidence attachments, and client contact approvals. Monthly service summaries showing volumes, response times, and recommendations.',
                'Field service documentation combining CCTV clip links, time-stamps, digital signatures, and exportable reporting. Makes performance visible to clients and auditors.',
                'Evidence-backed billing platform integrating dispatch/ticketing systems, standard response steps per incident type, and transparent proof of service delivery for enterprise accounts.'
            ], 
            budgetRange: [3, 5], baseSuccess: 0.70, 
            riskProfile: 'low', rewardProfile: 'moderate',
            scores: { technical: 3, marketsize: 4, strategic: 3, team: 4, capability: 5, ip: 2, platform: 3, sustainability: 4, newmarket: 3, geographic: 4, competitive: 3, devcost: 4, roi: 5, speed: 5, risk: 5 }, 
            quarterNarratives: { good: ['Billing disputes significantly reduced.', 'Client satisfaction with transparency high.', 'Audit documentation praised.'], bad: ['Guard adoption requiring workflow changes.', 'Integration with legacy systems challenging.'] }, 
            outcomeNarrative: { success: 'Transformed client relationships through transparency. Essential for enterprise contracts.', failure: 'Valuable but integrated into broader service platform rather than standalone.' } 
        },
        { 
            archetype: 'parking_security', 
            names: ['ParkWatch Pro', 'VehicleAlert System', 'LotGuard Platform', 'ParkingSafe Service'], 
            descs: [
                'Parking lot and campus road security reducing theft, stalking risk, and misuse. Flags wrong-way entry, repeated late-night visits, plate mismatches, and long-dwell vehicles near sensitive doors.',
                'LPR-based parking security with rule engine for time-of-day, dwell time, and repeat attempt patterns. Gate/barrier integration for manual approval and deny lists. Weekly hotspot reporting.',
                'Campus parking analytics with zone-specific rules for visitor lots, staff lots, loading bays. Guard/SOC alerts with supporting snapshots and recommended actions.',
                'Logistics yard security combining license plate recognition, vehicle behavior scoring by zone, barrier controller integration, and monthly analysis with recommended fixes.'
            ], 
            budgetRange: [5, 7], baseSuccess: 0.65, 
            riskProfile: 'medium', rewardProfile: 'moderate',
            scores: { technical: 4, marketsize: 4, strategic: 4, team: 4, capability: 4, ip: 3, platform: 3, sustainability: 3, newmarket: 3, geographic: 4, competitive: 3, devcost: 4, roi: 4, speed: 4, risk: 4 }, 
            quarterNarratives: { good: ['False alarm rates lower than expected.', 'Integration with barriers smooth.', 'Security teams finding alerts actionable.'], bad: ['LPR accuracy in poor lighting challenging.', 'Rule tuning requiring more site-specific work.'] }, 
            outcomeNarrative: { success: 'Standard add-on for campus and logistics contracts. Strong margins on analytics layer.', failure: 'Technology validated but competed with parking management vendors. Focused on security-specific use cases.' } 
        },
        { 
            archetype: 'shrink_prevention', 
            names: ['ShrinkGuard Package', 'WarehouseLoss Control', 'DockWatch System', 'InventoryShield Service'], 
            descs: [
                'Bundled warehouse shrink prevention combining dock-door monitoring, high-risk area coverage, checklist inspections, and exception reports highlighting suspicious patterns. Monthly shrink driver analysis.',
                'Logistics hub loss prevention with cameras alerting after-hours movement, door-open duration, and restricted zone entry. Mobile inspection checklists with supervisor sign-off and evidence clips.',
                'Shrink risk mapping for docks, high-value aisles, returns areas, scrap zones, and exits. Standard operating checks for seal verification and random inspections with audit documentation.',
                'Distribution center security package integrating access log analysis, camera alerts, inspection workflows, and monthly reporting with corrective action tracking and ROI measurement.'
            ], 
            budgetRange: [5, 7], baseSuccess: 0.65, 
            riskProfile: 'medium', rewardProfile: 'moderate',
            scores: { technical: 3, marketsize: 4, strategic: 4, team: 4, capability: 4, ip: 2, platform: 3, sustainability: 4, newmarket: 3, geographic: 4, competitive: 3, devcost: 4, roi: 4, speed: 4, risk: 4 }, 
            quarterNarratives: { good: ['Shrink rates measurably reduced at pilot sites.', 'Exception alerts catching real issues.', 'Operations teams embracing methodology.'], bad: ['Integration with WMS systems complex.', 'False positive tuning requiring ongoing effort.'] }, 
            outcomeNarrative: { success: 'Proven ROI drove rapid adoption in logistics vertical. Premium pricing justified by measurable results.', failure: 'Methodology validated but delivery labor-intensive. Repositioned as consulting engagement.' } 
        },
        { 
            archetype: 'alarm_response_network', 
            names: ['ResponseNet Service', 'SharedPatrol Network', 'AlarmGuard Subscription', 'MobileResponse Pro'], 
            descs: [
                'Subscription mobile response service with teams responding to alarms for multiple customers. Defined coverage plans, response SLAs, incident proof packs, and customer portal for performance tracking and billing.',
                'Shared response network reducing cost vs dedicated guards. GPS-tracked dispatch, step-by-step mobile procedures, arrival verification, and transparent evidence documentation.',
                'Alarm monitoring add-on with physical response capability. Integration with alarm panels, standard response procedures, reset actions, escalation notes, and performance analytics.',
                'Multi-client response service with route optimization, staffing density management, and partnership model for coverage expansion. Customer portal showing response times and incident details.'
            ], 
            budgetRange: [6, 8], baseSuccess: 0.65, 
            riskProfile: 'medium', rewardProfile: 'moderate',
            scores: { technical: 3, marketsize: 5, strategic: 4, team: 4, capability: 4, ip: 2, platform: 3, sustainability: 4, newmarket: 4, geographic: 4, competitive: 3, devcost: 3, roi: 4, speed: 4, risk: 3 }, 
            quarterNarratives: { good: ['Response SLAs consistently met.', 'Customer acquisition costs lower than projected.', 'Responder network scaling efficiently.'], bad: ['Coverage density in new areas challenging.', 'Alarm panel integration more complex than expected.'] }, 
            outcomeNarrative: { success: 'Became major service line with strong recurring revenue. Network effects creating barrier to entry.', failure: 'Viable in dense urban areas but rural economics challenging. Focused on metro markets.' } 
        },
        { 
            archetype: 'camera_subscription', 
            names: ['CamCare Subscription', 'VideoGuard aaS', 'CCTV Refresh Plan', 'SurveillanceCloud Service'], 
            descs: [
                'Subscription camera service removing upfront spending. Standard packages with install, maintenance, planned refresh cycles, remote health monitoring, and uptime reporting. Attractive for multi-site customers.',
                'Camera-as-a-Service with cloud/hybrid storage, preventative maintenance, automatic replacements, and technology roadmap per site. Service ticketing and spares logistics included.',
                'CCTV subscription bundles: basic/standard/premium tiers with clear inclusions. Remote device health monitoring detecting offline cameras, storage errors, and degradation.',
                'Multi-site camera program with centralized management, refresh planning, and consistent SLA delivery across locations. Financing model enabling cash-flow-conscious buyers.'
            ], 
            budgetRange: [5, 7], baseSuccess: 0.70, 
            riskProfile: 'low', rewardProfile: 'moderate',
            scores: { technical: 3, marketsize: 5, strategic: 4, team: 4, capability: 5, ip: 2, platform: 3, sustainability: 4, newmarket: 3, geographic: 4, competitive: 3, devcost: 4, roi: 4, speed: 4, risk: 4 }, 
            quarterNarratives: { good: ['Subscription uptake exceeding projections.', 'Churn rates very low.', 'Service delivery costs optimized.'], bad: ['Working capital requirements significant.', 'Equipment refresh timing complex to manage.'] }, 
            outcomeNarrative: { success: 'Transformed business model with predictable recurring revenue. Strong customer lock-in.', failure: 'Model viable but capital-intensive. Partnered with financing provider for scale.' } 
        },
        { 
            archetype: 'privacy_analytics', 
            names: ['PrivacyFirst Analytics', 'BlurGuard Platform', 'ConsentView System', 'DataSafe CCTV'], 
            descs: [
                'Analytics service reducing privacy risk. Default face blurring, event-only clip retention, restricted evidence access with approval workflows, and audit logs of all exports. Privacy-by-design configuration.',
                'Office and hospital video analytics with masking/redaction tools, role-based access control, retention automation, and evidence handling processes documenting who can unmask footage.',
                'Campus CCTV privacy solution with workshop-based configuration, documented settings per zone, secure evidence vault, and compliance reporting for GDPR-style requirements.',
                'Privacy-preserving video platform enabling analytics while protecting individuals. Reversible blur with approval workflows, access audit trails, and regulatory-ready documentation.'
            ], 
            budgetRange: [4, 6], baseSuccess: 0.60, 
            riskProfile: 'medium', rewardProfile: 'moderate',
            scores: { technical: 4, marketsize: 3, strategic: 4, team: 4, capability: 4, ip: 3, platform: 4, sustainability: 5, newmarket: 4, geographic: 3, competitive: 4, devcost: 3, roi: 3, speed: 3, risk: 3 }, 
            quarterNarratives: { good: ['Privacy workflow design praised by legal teams.', 'Compliance positioning resonating with enterprises.', 'Audit capabilities exceeding requirements.'], bad: ['Performance impact of real-time masking challenging.', 'Policy complexity requiring extensive customization.'] }, 
            outcomeNarrative: { success: 'Essential for privacy-conscious enterprises. Premium positioning justified by compliance value.', failure: 'Technology validated but market education required. Focused on regulated verticals.' } 
        },
        { 
            archetype: 'guard_tour_proof', 
            names: ['TourVerify Pro', 'PatrolProof System', 'AntiSpoof GuardTrack', 'TamperGuard Tours'], 
            descs: [
                'Guard tour system reducing fake patrol risk with tamper-resistant checkpoints, randomized routes, GPS validation, and cross-checks on time/location patterns. Supervisor dashboards with exception alerts.',
                'NFC/QR checkpoint deployment with BLE beacons for indoor zones. Rules detecting missed points, too-fast scans, and suspicious sequences. Client reporting proving patrol completion.',
                'Anti-fraud patrol verification using randomization and multi-sensor checks. Historical patrol data building trust with governance-focused clients.',
                'Tamper-resistant tour system combining checkpoint scanning, phone GPS validation, random route prompts, and anomaly detection for scan speed and sequence irregularities.'
            ], 
            budgetRange: [3, 5], baseSuccess: 0.70, 
            riskProfile: 'low', rewardProfile: 'moderate',
            scores: { technical: 3, marketsize: 4, strategic: 3, team: 4, capability: 5, ip: 3, platform: 3, sustainability: 4, newmarket: 2, geographic: 5, competitive: 3, devcost: 4, roi: 4, speed: 5, risk: 4 }, 
            quarterNarratives: { good: ['Fraud detection catching real issues.', 'Client confidence in patrol data high.', 'Checkpoint deployment efficient.'], bad: ['GPS accuracy in indoor environments variable.', 'Guard resistance to increased monitoring.'] }, 
            outcomeNarrative: { success: 'Standard tool for managed guarding. Strong differentiation in contract proposals.', failure: 'Technology validated but competitive with existing tour apps. Bundled with service contracts.' } 
        },
        { 
            archetype: 'smart_intercom', 
            names: ['GateCall Pro', 'IntercomPlus System', 'SmartEntry Manager', 'VisitorGate Platform'], 
            descs: [
                'Auditable gated entry with IP intercoms, mobile answering app, decision logging with photo/video snapshots, call recording, and monthly insights on peak times and repeat issues.',
                'Factory and campus gate management integrating intercom hardware, barrier controls, allow/deny decision logs with evidence, and searchable history for investigations.',
                'Corporate campus entry system with visitor verification, approval workflows, gate integration, and analytics on entry patterns and improvement opportunities.',
                'High-visitor office intercom solution combining smooth operator workflows, decision audit trails, call recording with role-based access, and gate delay reduction metrics.'
            ], 
            budgetRange: [4, 6], baseSuccess: 0.70, 
            riskProfile: 'low', rewardProfile: 'moderate',
            scores: { technical: 3, marketsize: 4, strategic: 3, team: 4, capability: 4, ip: 3, platform: 3, sustainability: 3, newmarket: 3, geographic: 4, competitive: 3, devcost: 4, roi: 4, speed: 4, risk: 4 }, 
            quarterNarratives: { good: ['Gate delays significantly reduced.', 'Decision logging praised by compliance teams.', 'Integration with barriers smooth.'], bad: ['Call quality in noisy environments challenging.', 'Recording consent workflow requiring clarification.'] }, 
            outcomeNarrative: { success: 'Standard entry solution for gated facilities. Strong margins on integration services.', failure: 'Viable product but competed with intercom manufacturers. Focused on software/service layer.' } 
        },
        { 
            archetype: 'wander_management', 
            names: ['WanderGuard Care', 'PatientSafe System', 'ExitAlert Healthcare', 'VulnerableWatch Platform'], 
            descs: [
                'Hospital and care site safety solution reducing wandering risk. BLE/UWB tags for high-risk patients, exit/zone rules with approach alerts, staff response playbooks, and compliance reporting.',
                'Opt-in tagging program with consent workflows, door-side alerts, calm reunite procedures, and incident documentation for regulatory compliance.',
                'Pediatric and elder care wander prevention with early warning alerts to security and nursing stations. False-alarm reduction through zone-specific tuning.',
                'Healthcare facility exit monitoring integrating tags, door sensors, alerting dashboards, and response playbooks designed for non-disruptive patient handling.'
            ], 
            budgetRange: [5, 7], baseSuccess: 0.60, 
            riskProfile: 'medium', rewardProfile: 'moderate',
            scores: { technical: 4, marketsize: 3, strategic: 4, team: 4, capability: 3, ip: 3, platform: 3, sustainability: 5, newmarket: 4, geographic: 3, competitive: 4, devcost: 3, roi: 3, speed: 3, risk: 3 }, 
            quarterNarratives: { good: ['Clinical staff adoption strong.', 'False alarm rates acceptably low.', 'Family feedback on safety very positive.'], bad: ['Tag battery life requiring optimization.', 'Integration with nurse call systems complex.'] }, 
            outcomeNarrative: { success: 'Essential safety system for hospitals and care homes. Strong cross-sell with other healthcare solutions.', failure: 'Technology validated but healthcare sales cycle long. Partnered with healthcare IT vendors.' } 
        },
        { 
            archetype: 'contractor_screening', 
            names: ['StaffScreen Service', 'VendorVerify Platform', 'ContractorCheck System', 'TrustGate Background'], 
            descs: [
                'Consent-based screening for temporary staff, vendors, and contractors. Document verification, reference checks, and performance flags from prior assignments. Pass/fail outcomes with review workflows.',
                'Risk-tiered screening packages: basic/standard/high-risk roles. Consent capture, secure data handling, and optional re-screening on role changes or periodic schedules.',
                'Vendor management integration providing screening status, assignment history, and compliance documentation. Audit logs and retention controls for regulatory requirements.',
                'Contract workforce screening combining identity verification, reference checks, incident history from prior deployments, and ongoing monitoring with flag alerts.'
            ], 
            budgetRange: [4, 6], baseSuccess: 0.65, 
            riskProfile: 'medium', rewardProfile: 'moderate',
            scores: { technical: 3, marketsize: 4, strategic: 3, team: 4, capability: 4, ip: 2, platform: 3, sustainability: 4, newmarket: 3, geographic: 4, competitive: 3, devcost: 4, roi: 4, speed: 4, risk: 4 }, 
            quarterNarratives: { good: ['Verification turnaround times fast.', 'Client trust in screening quality high.', 'Repeat screening adoption growing.'], bad: ['Reference check response rates variable.', 'Cross-border verification more complex than expected.'] }, 
            outcomeNarrative: { success: 'Trusted screening provider for enterprise clients. Strong integration with vendor management processes.', failure: 'Service viable but competed with established background verification firms. Focused on security-specific screening.' } 
        },
        { 
            archetype: 'ai_video_search', 
            names: ['VideoSearch AI', 'ClipFinder Pro', 'InvestigateIQ Platform', 'SmartRetrieve System'], 
            descs: [
                'AI-assisted video search by description: person in red, white truck, movement near loading bay after 11 PM. Policy controls on who can search, audit trails, and responsible-use guidelines.',
                'Indexed video search with attribute detection for vehicles, uniforms, bags, helmets. Evidence export workflows with review steps and role-based access control.',
                'Investigation acceleration platform reducing hours of manual review. Search interface connected to VMS, privacy-aware query restrictions, and misuse prevention through approvals.',
                'Video analytics search combining object detection, temporal queries, and governance controls. Operator training program and tuning services for each deployment environment.'
            ], 
            budgetRange: [6, 8], baseSuccess: 0.55, 
            riskProfile: 'high', rewardProfile: 'high',
            scores: { technical: 5, marketsize: 4, strategic: 5, team: 4, capability: 3, ip: 4, platform: 4, sustainability: 4, newmarket: 4, geographic: 3, competitive: 4, devcost: 3, roi: 3, speed: 2, risk: 3 }, 
            quarterNarratives: { good: ['Search accuracy exceeding expectations.', 'Investigation time savings dramatic.', 'Governance controls praised by compliance.'], bad: ['Training data requirements significant.', 'Privacy concerns requiring careful positioning.'] }, 
            outcomeNarrative: { success: 'Transformed investigation workflows. Premium feature driving enterprise upgrades.', failure: 'Technology validated but competed with VMS vendor features. Focused on governance differentiation.' } 
        },
        { 
            archetype: 'safety_security_soc', 
            names: ['UnifiedWatch Center', 'SafetySecure SOC', 'CombinedOps Platform', 'IntegratedCommand Service'], 
            descs: [
                'Merged safety and security monitoring: PPE compliance, unsafe zones, near-misses combined with intrusion, access anomalies, and incident response. Single dashboard, unified playbooks, joint monthly reviews.',
                'Combined command center reducing tool sprawl. Camera analytics for PPE and unsafe behaviors, integration with alarms and access control, and reporting layer covering both domains.',
                'Industrial operations platform handling safety events (confined space entry, hot work) and security events (unauthorized access, theft indicators) through coordinated response.',
                'Unified monitoring service with cross-trained operators, integrated incident workflows, and consolidated KPI reporting for safety and security leadership.'
            ], 
            budgetRange: [6, 8], baseSuccess: 0.60, 
            riskProfile: 'medium', rewardProfile: 'high',
            scores: { technical: 4, marketsize: 4, strategic: 5, team: 4, capability: 3, ip: 3, platform: 4, sustainability: 5, newmarket: 4, geographic: 3, competitive: 4, devcost: 3, roi: 4, speed: 3, risk: 3 }, 
            quarterNarratives: { good: ['Unified operations reducing response times.', 'Client consolidation appetite strong.', 'Operator efficiency improved.'], bad: ['Playbook integration more complex than planned.', 'Safety and security team coordination challenging.'] }, 
            outcomeNarrative: { success: 'Defined new category of unified operations. Strong differentiation in industrial verticals.', failure: 'Integration validated but organizational silos persistent. Offered as optional unification service.' } 
        },
        { 
            archetype: 'anti_drone_service', 
            names: ['DroneWatch Service', 'AirspaceGuard Platform', 'UAVAlert System', 'SkyShield Detection'], 
            descs: [
                'Compliance-first drone detection for sensitive sites. RF-based sensors with optional camera/thermal confirmation, detection-confirmation workflow reducing false alarms, evidence packs, and escalation procedures.',
                'Perimeter airspace monitoring with site survey, coverage design, geofenced rules by time and zone, and alert integration with SOC/dispatch. Regular testing and performance reports.',
                'Critical infrastructure drone detection combining multi-sensor deployment, incident documentation, and response playbooks. Focus on detection and escalation, not takedown.',
                'Data center and industrial site airspace security with RF detection, visual confirmation, time-stamped evidence, and regulatory-compliant incident handling procedures.'
            ], 
            budgetRange: [5, 7], baseSuccess: 0.55, 
            riskProfile: 'high', rewardProfile: 'moderate',
            scores: { technical: 4, marketsize: 3, strategic: 4, team: 4, capability: 3, ip: 2, platform: 3, sustainability: 3, newmarket: 4, geographic: 3, competitive: 3, devcost: 3, roi: 3, speed: 3, risk: 3 }, 
            quarterNarratives: { good: ['Detection reliability validated in pilots.', 'False alarm handling workflows effective.', 'Client interest from critical infrastructure strong.'], bad: ['RF environment variability affecting detection.', 'Regulatory clarity on response options limited.'] }, 
            outcomeNarrative: { success: 'Trusted provider for critical infrastructure. Strong government and enterprise relationships.', failure: 'Technology viable but market smaller than projected. Offered as add-on for high-security sites.' } 
        },
        { 
            archetype: 'predictive_door_maintenance', 
            names: ['DoorHealth Pro', 'EntryPoint Predict', 'AccessMaintain Platform', 'TurnstileCare Service'], 
            descs: [
                'Predictive maintenance for doors, locks, and turnstiles. Usage pattern analysis detecting early warning signs: abnormal open duration, repeated retries, unusual after-hours use. Maintenance tickets with priority and parts recommendations.',
                'Critical entry infrastructure reliability service combining door sensors, access event logs, optional motor/vibration monitoring, and integration with maintenance ticketing.',
                'Turnstile and gate health monitoring with instrumentation planning, threshold configuration, uptime dashboards, and monthly reliability reports with improvement actions.',
                'Access hardware predictive maintenance reducing security gaps from failures. Anomaly detection, proactive scheduling, and documented downtime reduction for client reviews.'
            ], 
            budgetRange: [4, 6], baseSuccess: 0.60, 
            riskProfile: 'medium', rewardProfile: 'moderate',
            scores: { technical: 4, marketsize: 3, strategic: 3, team: 4, capability: 4, ip: 3, platform: 3, sustainability: 4, newmarket: 3, geographic: 4, competitive: 4, devcost: 4, roi: 4, speed: 3, risk: 4 }, 
            quarterNarratives: { good: ['Failure prediction accuracy improving.', 'Maintenance cost savings documented.', 'Facility managers praising proactive approach.'], bad: ['Sensor deployment in legacy doors challenging.', 'Integration with diverse maintenance systems complex.'] }, 
            outcomeNarrative: { success: 'Essential service for large campuses. Strong cross-sell with access control contracts.', failure: 'Technology validated but market fragmented. Focused on enterprise accounts with centralized maintenance.' } 
        }
    ];
    
    // ============================================
    // LEGACY R&D PORTFOLIO PROJECTS
    // ============================================
    // These are projects inherited from previous leadership decisions
    // Players must decide what to do with them before selecting new projects
    
    const legacyProjectTemplates = [
        {
            id: 'legacy-1',
            name: 'SmartLock 2.0',
            archetype: 'legacy_incremental',
            desc: 'Incremental update to existing SmartLock product line. Adds Bluetooth 5.0, improves battery life by 20%, and adds Hindi voice prompts. Announced to 200+ channel dealers at last year\'s distributor conference.',
            quarterStarted: -3,
            quartersRemaining: 8,
            totalBudget: 3.5,
            spentBudget: 2.0,
            remainingBudget: 1.5,
            progress: 72,
            status: 'amber',
            teamSize: 4,
            strategicAlignment: 'low',
            alignmentNote: 'Core business incremental. Won\'t differentiate us, but maintains dealer relationships.',
            externalCommitment: 'Announced to 200+ dealers at annual conference. Price lists distributed.',
            politicalContext: 'Sales team strongly committed. VP Sales (Deepak) championed this at leadership.',
            quarterlyUpdates: [
                { quarter: -3, status: 'green', narrative: 'Project kickoff smooth. Team assembled.' },
                { quarter: -2, status: 'green', narrative: 'BT 5.0 integration completed. Voice prompts recorded.' },
                { quarter: -1, status: 'amber', narrative: 'Battery optimisation hitting limits. May only hit 15% improvement.' }
            ],
            scores: { technical: 4, marketsize: 3, strategic: 2, team: 4, capability: 5, ip: 2, newmarket: 1, roi: 3 },
            riskIfContinued: 'Resources tied up in incremental work. Opportunity cost for breakthrough projects.',
            riskIfKilled: 'Sales team loses credibility with dealers. Deepak vocal at leadership. Q3 revenue gap.'
        },
        {
            id: 'legacy-2',
            name: 'Regional Language App',
            archetype: 'legacy_incremental',
            desc: 'ShieldTech app localisation for Tamil, Telugu, Kannada, and Malayalam. Press release already issued announcing "India\'s first vernacular smart home security app".',
            quarterStarted: -2,
            quartersRemaining: 8,
            totalBudget: 1.5,
            spentBudget: 1.0,
            remainingBudget: 0.5,
            progress: 85,
            status: 'green',
            teamSize: 2,
            strategicAlignment: 'medium',
            alignmentNote: 'Supports Tier 2/3 city expansion. Modest strategic value but good optics.',
            externalCommitment: 'Press release issued. Tech media covered the announcement.',
            politicalContext: 'Marketing (Anjali) championed this. Good PR value but limited revenue impact.',
            quarterlyUpdates: [
                { quarter: -2, status: 'green', narrative: 'Translation partners engaged. UI adaptation started.' },
                { quarter: -1, status: 'green', narrative: 'Tamil and Telugu complete. Southern languages on track.' }
            ],
            scores: { technical: 3, marketsize: 3, strategic: 3, team: 4, capability: 5, ip: 1, newmarket: 3, roi: 2 },
            riskIfContinued: 'Small resource drain. Minor opportunity cost.',
            riskIfKilled: 'Press release already out. Embarrassing public reversal. Anjali upset.'
        },
        {
            id: 'legacy-3',
            name: 'Executive Analytics Dashboard',
            archetype: 'legacy_pet_project',
            desc: 'Enterprise analytics dashboard showing security metrics, trends, and ROI calculations for corporate customers. Former COO\'s initiative before his departure.',
            quarterStarted: -4,
            quartersRemaining: 9,
            totalBudget: 5.0,
            spentBudget: 2.5,
            remainingBudget: 2.5,
            progress: 38,
            status: 'red',
            teamSize: 5,
            strategicAlignment: 'questionable',
            alignmentNote: 'Former COO\'s vision for B2B pivot. New strategy focuses on consumer premium.',
            externalCommitment: 'Pilot agreement with 3 enterprise customers. Non-binding.',
            politicalContext: 'Project orphaned after COO left. Team demoralised. No executive sponsor.',
            quarterlyUpdates: [
                { quarter: -4, status: 'green', narrative: 'Strong executive backing. Architecture defined.' },
                { quarter: -3, status: 'amber', narrative: 'Scope creep. Additional requirements from enterprise pilots.' },
                { quarter: -2, status: 'amber', narrative: 'COO departure. Project direction uncertain.' },
                { quarter: -1, status: 'red', narrative: 'Team attrition. Lead developer resigned. Velocity down 60%.' }
            ],
            scores: { technical: 4, marketsize: 3, strategic: 2, team: 2, capability: 3, ip: 2, newmarket: 4, roi: 2 },
            riskIfContinued: 'Zombie project consuming resources. Team morale deteriorating further.',
            riskIfKilled: 'Sunk cost write-off. 3 enterprise pilots disappointed. Team layoffs required.'
        },
        {
            id: 'legacy-4',
            name: 'ShieldOS 3.0 Platform Rewrite',
            archetype: 'legacy_strategic_troubled',
            desc: 'Complete rewrite of core operating system for all ShieldTech devices. Promises 50% faster OTA updates, better security, and unified codebase. Critical for future platform strategy.',
            quarterStarted: -5,
            quartersRemaining: 9,
            totalBudget: 10.0,
            spentBudget: 6.0,
            remainingBudget: 4.0,
            progress: 30,
            status: 'red',
            teamSize: 8,
            strategicAlignment: 'high',
            alignmentNote: 'Critical platform enabler. All future products depend on this. But massively behind schedule.',
            externalCommitment: 'Internal roadmap. No external commitments yet.',
            politicalContext: 'CTO (Vikram) staked his reputation on this. Board asking hard questions.',
            quarterlyUpdates: [
                { quarter: -5, status: 'green', narrative: 'Ambitious vision. Team excited. Architecture approved.' },
                { quarter: -4, status: 'amber', narrative: 'Complexity higher than estimated. Timeline slipping.' },
                { quarter: -3, status: 'amber', narrative: 'Legacy system integration challenges. Technical debt.' },
                { quarter: -2, status: 'red', narrative: 'Major architectural revision required. 6-month slip.' },
                { quarter: -1, status: 'red', narrative: 'Burn rate concerns. Quality issues in testing.' }
            ],
            scores: { technical: 5, marketsize: 4, strategic: 5, team: 3, capability: 3, ip: 4, newmarket: 3, roi: 3 },
            riskIfContinued: 'Continues to drain resources. Risk of becoming a "bet the company" project.',
            riskIfKilled: 'Platform roadmap collapses. CTO credibility damaged. $5.6M write-off.'
        },
        {
            id: 'legacy-5',
            name: 'OEM White-Label Program',
            archetype: 'legacy_partnership',
            desc: 'White-label security devices for major telecom (Jio) to bundle with broadband. Partnership negotiation has stalled twice. Deal terms unfavorable but revenue significant.',
            quarterStarted: -3,
            quartersRemaining: 9,
            totalBudget: 5.0,
            spentBudget: 2.0,
            remainingBudget: 3.0,
            progress: 45,
            status: 'amber',
            teamSize: 4,
            strategicAlignment: 'questionable',
            alignmentNote: 'Volume revenue but destroys brand differentiation. Sets dangerous precedent.',
            externalCommitment: 'LOI signed with Jio. Exclusivity period expires in 60 days.',
            politicalContext: 'CEO initially excited about Jio scale. Now having second thoughts on brand dilution.',
            quarterlyUpdates: [
                { quarter: -3, status: 'green', narrative: 'Jio excited. LOI signed. Technical integration started.' },
                { quarter: -2, status: 'amber', narrative: 'Pricing negotiation stalled. Jio wants 45% discount.' },
                { quarter: -1, status: 'amber', narrative: 'Terms improved slightly. Still margin negative at volume.' }
            ],
            scores: { technical: 3, marketsize: 5, strategic: 2, team: 4, capability: 4, ip: 1, newmarket: 2, roi: 2 },
            riskIfContinued: 'Even if successful, low margins and brand dilution. Sets precedent for commoditisation.',
            riskIfKilled: 'Write off $1.9M. Jio relationship damaged. CEO loses a strategic bet.'
        },
        {
            id: 'legacy-6',
            name: 'Cost-Reduced Sensor v2',
            archetype: 'legacy_defensive',
            desc: 'Re-engineering door/window sensors to reduce BOM cost by 30%. Switches to cheaper Chinese MCU, simplifies antenna design, and uses injection-molded housing. Response to Xiaomi\'s aggressive pricing.',
            quarterStarted: -2,
            quartersRemaining: 8,
            totalBudget: 2.8,
            spentBudget: 0.8,
            remainingBudget: 2.0,
            progress: 40,
            status: 'green',
            teamSize: 3,
            strategicAlignment: 'medium',
            alignmentNote: 'Necessary defensive move for Tier 2/3 price-sensitive market. But risk of quality perception damage.',
            externalCommitment: 'None external. Internal commitment to hit $5 price point.',
            politicalContext: 'Hardware Lead (Anand) driving this. Finance supportive. Quality team has concerns.',
            quarterlyUpdates: [
                { quarter: -2, status: 'green', narrative: 'Alternative components identified. Testing begun.' },
                { quarter: -1, status: 'green', narrative: 'New MCU validated. Antenna redesign in progress.' }
            ],
            scores: { technical: 3, marketsize: 4, strategic: 3, team: 4, capability: 5, ip: 1, newmarket: 2, roi: 4 },
            riskIfContinued: 'May affect quality reputation. Race to bottom on pricing.',
            riskIfKilled: 'Cedes low-end market to Xiaomi. Finance team unhappy with margin trajectory.'
        },
        {
            id: 'legacy-7',
            name: 'Cloud Migration Initiative',
            archetype: 'legacy_infrastructure',
            desc: 'Moving ShieldTech cloud infrastructure from on-premise data centre to AWS India region. Promises 40% cost reduction and better scalability. IT team\'s top priority.',
            quarterStarted: -3,
            quartersRemaining: 9,
            totalBudget: 3.0,
            spentBudget: 1.5,
            remainingBudget: 1.5,
            progress: 65,
            status: 'amber',
            teamSize: 3,
            strategicAlignment: 'medium',
            alignmentNote: 'Important infrastructure modernisation. Enables future scale but not customer-visible.',
            externalCommitment: 'AWS partnership agreement signed. Data centre lease expires in 6 months.',
            politicalContext: 'IT Director (Suresh) driving. Low visibility project. Easy to defer.',
            quarterlyUpdates: [
                { quarter: -3, status: 'green', narrative: 'AWS architecture designed. Migration plan approved.' },
                { quarter: -2, status: 'green', narrative: 'Non-production workloads migrated. Testing positive.' },
                { quarter: -1, status: 'amber', narrative: 'Production migration hitting latency issues. Optimisation needed.' }
            ],
            scores: { technical: 4, marketsize: 3, strategic: 3, team: 4, capability: 4, ip: 1, newmarket: 1, roi: 4 },
            riskIfContinued: 'Moderate resource drain. Some customer experience risk during migration.',
            riskIfKilled: 'Data centre lease renewal expensive. Technical debt accumulates. Suresh demotivated.'
        }
    ];
    
    // Legacy project decision options
    const legacyDecisionOptions = {
        continue: {
            label: 'Continue as Planned',
            icon: '▶️',
            description: 'Maintain current scope, timeline, and budget allocation.',
            budgetImpact: 1.0 // 100% of remaining budget
        },
        accelerate: {
            label: 'Accelerate',
            icon: '⏩',
            description: 'Add resources to complete faster. Higher cost but earlier delivery.',
            budgetImpact: 1.4 // 140% of remaining budget
        },
        reduce_scope: {
            label: 'Reduce Scope',
            icon: '✂️',
            description: 'Cut features to ship sooner with lower cost. May affect commitments.',
            budgetImpact: 0.6 // 60% of remaining budget
        },
        pause: {
            label: 'Pause',
            icon: '⏸️',
            description: 'Stop active work but preserve option to resume. Minimal holding cost.',
            budgetImpact: 0.1 // 10% holding cost
        },
        kill: {
            label: 'Kill Project',
            icon: '⛔',
            description: 'Terminate completely. Write off sunk cost. Free up team.',
            budgetImpact: 0 // No further budget
        }
    };
    
    // ============================================
    // UI FUNCTIONS
    // ============================================
    
    function showPhase(phase) {
        document.querySelectorAll('.phase-content').forEach(el => el.classList.add('hidden'));
        const phaseEl = document.getElementById(`phase-${phase}`);
        if (phaseEl) {
            phaseEl.classList.remove('hidden');
        } else {
            console.error('Phase not found:', phase);
        }
        gameState.phase = phase;
        window.scrollTo(0, 0);
        
        if (phase === 'design-committee') {
            renderStaffCards();
            updateCommitteeDisplay();
        }
    }
    
    function startCommitteeSelection() {
        // Set default decision model to committee
        gameState.decisionModel = 'committee';
        renderStaffCards();
        showPhase('design-committee');
    }
    
    function selectDecisionModel(model) {
        gameState.decisionModel = model;
        document.querySelectorAll('.model-card').forEach(card => card.classList.remove('selected'));
        document.querySelector(`[data-model="${model}"]`).classList.add('selected');
        document.getElementById('decision-model-next').disabled = false;
    }
    
    function proceedFromDecisionModel() {
        if (gameState.decisionModel === 'committee') {
            showPhase('design-committee');
        } else {
            showPhase('design-criteria');
        }
    }
    
    function renderStaffCards() {
        Object.keys(staffDatabase).forEach(category => {
            const container = document.getElementById(`staff-${category}`);
            container.innerHTML = staffDatabase[category].map(staff => {
                const isSelected = gameState.committee.includes(staff.id);
                const isCEO = staff.id === 'meera';
                return `
                <div class="staff-tile ${isSelected ? 'selected' : ''} ${isCEO ? 'locked' : ''}" 
                     data-staff-id="${staff.id}">
                    <div class="selection-check">${isCEO ? '🔒' : ''}</div>
                    <div class="staff-tile-header" style="background: linear-gradient(135deg, ${staff.avatarColor}08 0%, ${staff.avatarColor}15 100%);">
                        <div class="staff-tile-avatar" style="background: linear-gradient(135deg, ${staff.avatarColor} 0%, ${staff.avatarColor}cc 100%);">
                            <img src="${getAvatarUrl(staff)}" alt="${staff.name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <span class="staff-tile-initials" style="display: none;">${staff.initials}</span>
                        </div>
                        <div class="staff-tile-header-info">
                            <div class="staff-tile-name">${staff.name}</div>
                            <div class="staff-tile-role">${staff.role}</div>
                            <div class="staff-tile-location">📍 ${staff.location}</div>
                        </div>
                    </div>
                    <div class="staff-tile-body">
                        <p class="staff-tile-bio">${staff.shortBio}</p>
                        <div class="staff-tile-traits">
                            <div class="staff-tile-traits-label">Key Traits</div>
                            <div class="staff-tile-tags">
                                ${staff.strengths.slice(0,2).map(s => `<span class="staff-tag pro">✓ ${s}</span>`).join('')}
                                ${staff.biases.slice(0,1).map(b => `<span class="staff-tag con">⚠ ${b}</span>`).join('')}
                            </div>
                        </div>
                        <div class="staff-tile-actions">
                            <button class="staff-btn-details" onclick="event.stopPropagation(); openStaffModal('${staff.id}')">
                                <span>👤</span> Profile
                            </button>
                            ${isCEO ? `
                            <button class="staff-btn-select selected locked" disabled title="CEO is a mandatory committee member">
                                <span>🔒</span> Required
                            </button>
                            ` : `
                            <button class="staff-btn-select ${isSelected ? 'selected' : ''}" onclick="toggleStaff('${staff.id}')">
                                ${isSelected ? '<span>✓</span> Selected' : '<span>+</span> Add'}
                            </button>
                            `}
                        </div>
                    </div>
                </div>
            `}).join('');
        });
    }
    
    function findStaff(id) {
        for (const category of Object.values(staffDatabase)) {
            const found = category.find(s => s.id === id);
            if (found) return found;
        }
        return null;
    }
    
    function toggleStaff(staffId) {
        // CEO is a mandatory committee member
        if (staffId === 'meera') return;
        
        const index = gameState.committee.indexOf(staffId);
        if (index > -1) {
            gameState.committee.splice(index, 1);
            SoundManager.play('deselect');
        } else {
            gameState.committee.push(staffId);
            SoundManager.play('select');
        }
        renderStaffCards();
        updateCommitteeDisplay();
    }
    
    function updateCommitteeDisplay() {
        const container = document.getElementById('committee-members');
        document.getElementById('committee-count').textContent = gameState.committee.length;
        
        if (gameState.committee.length === 0) {
            container.innerHTML = '<div class="empty-committee">Click on staff members below to add them to your committee</div>';
        } else {
            container.innerHTML = gameState.committee.map(staffId => {
                const staff = findStaff(staffId);
                const isCEO = staffId === 'meera';
                return `
                    <div class="committee-member-chip ${isCEO ? 'locked' : ''}">
                        <img src="${getAvatarUrl(staff)}" alt="${staff.name}" onerror="this.style.background='${staff.avatarColor}'; this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22/>';">
                        <span>${staff.name.split(' ')[0]}</span>
                        ${isCEO ? '<span class="locked-badge" title="CEO is a mandatory committee member">🔒</span>' : `<button class="remove-btn" onclick="removeFromCommittee('${staffId}')">×</button>`}
                    </div>
                `;
            }).join('');
        }
        
        document.getElementById('committee-next').disabled = gameState.committee.length === 0;
    }
    
    function removeFromCommittee(staffId) {
        // CEO is a mandatory committee member
        if (staffId === 'meera') return;
        
        const index = gameState.committee.indexOf(staffId);
        if (index > -1) {
            gameState.committee.splice(index, 1);
            renderStaffCards();
            updateCommitteeDisplay();
        }
    }
    
    function openStaffModal(staffId) {
        const staff = findStaff(staffId);
        if (!staff) return;
        
        gameState.currentModalStaff = staffId;
        
        document.getElementById('modal-avatar').src = getAvatarUrl(staff);
        document.getElementById('modal-avatar').style.background = staff.avatarColor;
        document.getElementById('modal-name').textContent = staff.name;
        document.getElementById('modal-role').textContent = `${staff.role} • ${staff.location}`;
        document.getElementById('modal-bio').textContent = staff.fullBio;
        document.getElementById('modal-style').textContent = staff.style;
        
        document.getElementById('modal-cv').innerHTML = staff.cv.map(item => `
            <div class="cv-item">
                <span class="cv-year">${item.year}</span>
                <span class="cv-detail">${item.detail}</span>
            </div>
        `).join('');
        
        document.getElementById('modal-traits').innerHTML = [
            ...staff.strengths.map(s => `<span class="staff-trait strength">${s}</span>`),
            ...staff.biases.map(b => `<span class="staff-trait bias">${b}</span>`)
        ].join('');
        
        const addBtn = document.getElementById('modal-add-btn');
        const inCommittee = gameState.committee.includes(staffId);
        
        if (inCommittee) {
            addBtn.textContent = 'Remove from Committee';
            addBtn.className = 'add-to-committee-btn remove';
        } else {
            addBtn.textContent = 'Add to Committee';
            addBtn.className = 'add-to-committee-btn';
        }
        
        document.getElementById('staff-modal').classList.remove('hidden');
    }
    
    function closeModal() {
        document.getElementById('staff-modal').classList.add('hidden');
        gameState.currentModalStaff = null;
    }
    
    function showReferencesModal() {
        document.getElementById('references-modal').classList.remove('hidden');
    }
    
    function closeReferencesModal() {
        document.getElementById('references-modal').classList.add('hidden');
    }
    
    function addFromModal() {
        if (gameState.currentModalStaff) {
            toggleStaff(gameState.currentModalStaff);
            closeModal();
        }
    }
    
    function toggleCriteria(criteriaId) {
        const index = gameState.criteria.indexOf(criteriaId);
        const card = document.querySelector(`[data-criteria="${criteriaId}"]`);
        
        if (index > -1) {
            gameState.criteria.splice(index, 1);
            card.classList.remove('selected');
            SoundManager.play('deselect');
        } else {
            gameState.criteria.push(criteriaId);
            card.classList.add('selected');
            SoundManager.play('select');
        }
        
        // Update button and recommendation message
        const count = gameState.criteria.length;
        document.getElementById('criteria-next').disabled = count < 1;
        
        // Show recommendation warning
        const warningEl = document.getElementById('criteria-warning');
        if (warningEl) {
            if (count === 0) {
                warningEl.textContent = 'Select at least one criterion to continue';
                warningEl.className = 'criteria-warning error';
            } else if (count < 4) {
                warningEl.textContent = `${count} selected — we recommend 4-6 criteria for balanced evaluation`;
                warningEl.className = 'criteria-warning warning';
            } else if (count > 6) {
                warningEl.textContent = `${count} selected — more than 6 criteria may dilute focus`;
                warningEl.className = 'criteria-warning warning';
            } else {
                warningEl.textContent = `${count} selected — good balance ✓`;
                warningEl.className = 'criteria-warning success';
            }
        }
    }
    
    function goBackFromCriteria() {
        showPhase('design-committee');
    }
    
    // ============================================
    // CRITERIA WEIGHTING
    // ============================================
    
    const criteriaDetails = {
        technical: { 
            name: 'Technical Feasibility', 
            icon: '🔧', 
            color: '#6366f1', 
            short: 'Tech',
            question: 'Can we build it?',
            desc: 'Assess engineering complexity, technology readiness, and whether we have the technical skills to deliver.',
            pro: 'Catches unrealistic projects',
            con: 'May favour incremental',
            category: 'technical'
        },
        capability: { 
            name: 'Core Capability Fit', 
            icon: '🏗️', 
            color: '#8b5cf6', 
            short: 'Cap',
            question: 'Does it leverage what we\'re good at?',
            desc: 'Evaluate alignment with existing capabilities in hardware, software, distribution, and customer relationships.',
            pro: 'Builds on strengths',
            con: 'May block diversification',
            category: 'technical'
        },
        ip: { 
            name: 'IP & Defensibility', 
            icon: '🛡️', 
            color: '#0891b2', 
            short: 'IP',
            question: 'Can we protect the innovation?',
            desc: 'Assess patent potential, trade secrets, and barriers to imitation by competitors.',
            pro: 'Long-term protection',
            con: 'Favours novel tech over execution',
            category: 'technical'
        },
        strategic: { 
            name: 'Strategic Priority Fit', 
            icon: '🎯', 
            color: '#7c3aed', 
            short: 'Strat',
            question: 'Does it address board priorities?',
            desc: 'Check alignment with the four strategic priorities: defend core, tier-2/3 expansion, platform ecosystem, R&D productivity.',
            pro: 'Board alignment',
            con: 'May reject disruptive ideas',
            category: 'strategic'
        },
        platform: { 
            name: 'Platform & Ecosystem', 
            icon: '🔗', 
            color: '#059669', 
            short: 'Plat',
            question: 'Does it strengthen our platform?',
            desc: 'Evaluate contribution to smart home ecosystem, partner integrations, and network effects.',
            pro: 'Long-term positioning',
            con: 'Slow payback periods',
            category: 'strategic'
        },
        sustainability: { 
            name: 'Sustainability Impact', 
            icon: '🌱', 
            color: '#16a34a', 
            short: 'Sust',
            question: 'Does it create positive impact?',
            desc: 'Consider environmental footprint, social benefit, and alignment with corporate responsibility goals.',
            pro: 'ESG alignment',
            con: 'May trade off profitability',
            category: 'strategic'
        },
        marketsize: { 
            name: 'Market Size (TAM)', 
            icon: '📊', 
            color: '#f59e0b', 
            short: 'Mkt',
            question: 'How big is the opportunity?',
            desc: 'Evaluate total addressable market, serviceable market, and realistic revenue potential.',
            pro: 'Revenue focused',
            con: 'May miss valuable niches',
            category: 'market'
        },
        competitive: { 
            name: 'Competitive Differentiation', 
            icon: '⚔️', 
            color: '#ef4444', 
            short: 'Comp',
            question: 'Will we stand out from rivals?',
            desc: 'Assess uniqueness versus Chinese imports, local competitors, and global players entering India.',
            pro: 'Avoids price wars',
            con: 'May overvalue novelty',
            category: 'market'
        },
        newmarket: { 
            name: 'New Market Creation', 
            icon: '🚀', 
            color: '#ec4899', 
            short: 'New',
            question: 'Does it open new segments?',
            desc: 'Assess potential to create new product categories, reach non-consumers, or disrupt adjacent markets.',
            pro: 'Growth potential',
            con: 'Higher uncertainty',
            category: 'market'
        },
        geographic: { 
            name: 'Geographic Expansion', 
            icon: '🗺️', 
            color: '#14b8a6', 
            short: 'Geo',
            question: 'Does it help us expand to new regions?',
            desc: 'Evaluate fit for tier-2/3 cities, rural markets, or eventual international expansion.',
            pro: 'Distribution growth',
            con: 'May require adaptation',
            category: 'market'
        },
        devcost: { 
            name: 'Development Cost', 
            icon: '💵', 
            color: '#dc2626', 
            short: 'Cost',
            question: 'What\'s the R&D investment required?',
            desc: 'Evaluate total development budget, resource requirements, and cost predictability.',
            pro: 'Budget discipline',
            con: 'May kill ambitious projects',
            category: 'financial'
        },
        roi: { 
            name: 'Expected ROI', 
            icon: '📈', 
            color: '#65a30d', 
            short: 'ROI',
            question: 'What\'s the return on investment?',
            desc: 'Calculate expected returns relative to investment, including payback period and NPV.',
            pro: 'Financial rigour',
            con: 'Underweights optionality',
            category: 'financial'
        },
        speed: { 
            name: 'Time to Market', 
            icon: '⚡', 
            color: '#f97316', 
            short: 'Speed',
            question: 'How fast can we launch?',
            desc: 'Prioritise projects that can reach customers quickly and capture market windows.',
            pro: 'Captures urgency',
            con: 'May skip big bets',
            category: 'financial'
        },
        team: { 
            name: 'Team Capability', 
            icon: '👥', 
            color: '#8b5cf6', 
            short: 'Team',
            question: 'Can this team deliver?',
            desc: 'Assess the project team\'s track record, skills, bandwidth, and leadership quality.',
            pro: 'Execution focused',
            con: 'Favours known teams',
            category: 'financial'
        },
        risk: { 
            name: 'Risk Profile', 
            icon: '⚠️', 
            color: '#78716c', 
            short: 'Risk',
            question: 'What could go wrong?',
            desc: 'Evaluate technical, market, regulatory, and execution risks. Consider downside scenarios.',
            pro: 'Avoids disasters',
            con: 'May be too conservative',
            category: 'financial'
        }
    };
    
    function renderCriteriaTiles() {
        const categories = {
            technical: document.getElementById('criteria-technical'),
            strategic: document.getElementById('criteria-strategic'),
            market: document.getElementById('criteria-market'),
            financial: document.getElementById('criteria-financial')
        };
        
        Object.entries(criteriaDetails).forEach(([id, detail]) => {
            const container = categories[detail.category];
            if (!container) return;
            
            const isSelected = gameState.criteria.includes(id);
            const tile = document.createElement('div');
            tile.className = `criteria-tile ${isSelected ? 'selected' : ''}`;
            tile.setAttribute('data-criteria', id);
            tile.onclick = () => toggleCriteria(id);
            
            tile.innerHTML = `
                <div class="selection-check"></div>
                <div class="criteria-tile-header">
                    <div class="criteria-tile-icon" style="background: ${detail.color};">
                        ${detail.icon}
                    </div>
                    <div class="criteria-tile-info">
                        <div class="criteria-tile-title">${detail.name}</div>
                        <div class="criteria-tile-question">${detail.question}</div>
                    </div>
                </div>
                <div class="criteria-tile-body">
                    <div class="criteria-tile-desc">${detail.desc}</div>
                    <div class="criteria-tile-tags">
                        <span class="criteria-tag pro">✓ ${detail.pro}</span>
                        <span class="criteria-tag con">⚡ ${detail.con}</span>
                    </div>
                </div>
            `;
            
            container.appendChild(tile);
        });
    }
    
    // Initialize criteria tiles when page loads
    document.addEventListener('DOMContentLoaded', () => {
        renderCriteriaTiles();
    });
    
    function showCriteriaWeights() {
        // Initialize weights if not set
        if (!gameState.criteriaWeights) {
            gameState.criteriaWeights = {};
        }
        
        // Set equal weights initially if empty
        if (Object.keys(gameState.criteriaWeights).length === 0) {
            const equalWeight = Math.floor(100 / gameState.criteria.length);
            const remainder = 100 - (equalWeight * gameState.criteria.length);
            gameState.criteria.forEach((c, i) => {
                gameState.criteriaWeights[c] = equalWeight + (i === 0 ? remainder : 0);
            });
        }
        
        renderWeightsGrid();
        showPhase('criteria-weights');
    }
    
    function renderWeightsGrid() {
        const grid = document.getElementById('weights-grid');
        grid.innerHTML = gameState.criteria.map(criteriaId => {
            const detail = criteriaDetails[criteriaId] || { name: criteriaId, icon: '📋', color: '#6b7280', short: criteriaId, question: '' };
            const weight = gameState.criteriaWeights[criteriaId] || 0;
            return `
                <div class="weight-tile ${weight > 0 ? 'has-value' : ''}" data-criteria="${criteriaId}">
                    <div class="weight-tile-icon" style="background: linear-gradient(135deg, ${detail.color} 0%, ${detail.color}dd 100%);">
                        ${detail.icon}
                    </div>
                    <div class="weight-tile-content">
                        <div class="weight-tile-header">
                            <div>
                                <div class="weight-tile-title">${detail.name}</div>
                                <div style="font-size: 0.8em; color: var(--gray-500); font-style: italic;">${detail.question || ''}</div>
                            </div>
                            <div class="weight-tile-value">
                                <input type="number" class="weight-tile-input" min="0" max="100" step="1"
                                       value="${weight}" onchange="updateWeight('${criteriaId}', this.value)"
                                       id="weight-input-${criteriaId}">
                                <span class="weight-tile-pct">%</span>
                            </div>
                        </div>
                        <input type="range" class="weight-tile-slider" min="0" max="100" step="1" 
                               value="${weight}" onchange="updateWeight('${criteriaId}', this.value)"
                               oninput="updateWeightPreview('${criteriaId}', this.value)">
                    </div>
                </div>
            `;
        }).join('');
        
        updateWeightsTotal();
        updateWeightsFormula();
    }
    
    function updateWeightPreview(criteriaId, value) {
        document.getElementById(`weight-input-${criteriaId}`).value = value;
        // Update total preview
        const tempWeights = { ...gameState.criteriaWeights };
        tempWeights[criteriaId] = parseInt(value) || 0;
        const total = Object.values(tempWeights).reduce((sum, w) => sum + w, 0);
        
        const totalEl = document.getElementById('weights-total');
        totalEl.textContent = total;
        totalEl.className = 'weights-value ' + (total < 100 ? 'under' : total > 100 ? 'over' : 'exact');
    }
    
    function updateWeight(criteriaId, value) {
        const numValue = Math.max(0, Math.min(100, parseInt(value) || 0));
        gameState.criteriaWeights[criteriaId] = numValue;
        
        // Update slider and input to match
        const item = document.querySelector(`.weight-tile[data-criteria="${criteriaId}"]`);
        if (item) {
            item.querySelector('.weight-tile-slider').value = numValue;
            item.querySelector('.weight-tile-input').value = numValue;
            item.classList.toggle('has-value', numValue > 0);
        }
        
        updateWeightsTotal();
        updateWeightsFormula();
    }
    
    function updateWeightsTotal() {
        const total = Object.values(gameState.criteriaWeights).reduce((sum, w) => sum + (w || 0), 0);
        
        const totalEl = document.getElementById('weights-total');
        const wasNotHundred = totalEl.textContent !== '100';
        totalEl.textContent = total;
        totalEl.className = 'weights-value ' + (total < 100 ? 'under' : total > 100 ? 'over' : 'exact');
        
        const statusEl = document.getElementById('weights-status');
        if (total === 100) {
            statusEl.textContent = '✓ Perfect! Ready to continue';
            statusEl.className = 'weights-status valid';
            if (wasNotHundred) SoundManager.play('success');
        } else if (total < 100) {
            statusEl.textContent = `${100 - total} points remaining`;
            statusEl.className = 'weights-status';
        } else {
            statusEl.textContent = `${total - 100} points over limit`;
            statusEl.className = 'weights-status invalid';
        }
        
        // Enable/disable next button
        document.getElementById('weights-next').disabled = total !== 100;
    }
    
    function updateWeightsFormula() {
        const formula = document.getElementById('weights-formula');
        const terms = gameState.criteria
            .filter(c => gameState.criteriaWeights[c] > 0)
            .map((c, i, arr) => {
                const detail = criteriaDetails[c] || { short: c };
                const weight = gameState.criteriaWeights[c];
                return `
                    <span class="formula-term">
                        <span class="formula-weight">${weight}%</span>
                        <span class="formula-criteria">${detail.short}</span>
                    </span>
                    ${i < arr.length - 1 ? '<span class="formula-operator">+</span>' : ''}
                `;
            }).join('');
        
        formula.innerHTML = terms || '<span style="color: var(--gray-400);">Assign weights to see your formula</span>';
    }
    
    function distributeWeightsEvenly() {
        const count = gameState.criteria.length;
        const equalWeight = Math.floor(100 / count);
        const remainder = 100 - (equalWeight * count);
        
        gameState.criteria.forEach((c, i) => {
            gameState.criteriaWeights[c] = equalWeight + (i === 0 ? remainder : 0);
        });
        
        renderWeightsGrid();
    }
    
    function resetWeights() {
        gameState.criteria.forEach(c => {
            gameState.criteriaWeights[c] = 0;
        });
        renderWeightsGrid();
    }
    
    function confirmWeightsAndStart() {
        // Verify total is 100
        const total = Object.values(gameState.criteriaWeights).reduce((sum, w) => sum + (w || 0), 0);
        if (total !== 100) {
            alert('Please ensure your weights add up to exactly 100%');
            return;
        }
        
        // Proceed to project selection
        startProjectSelection();
    }
    
    // New function to show legacy portfolio first
    function confirmWeightsAndShowLegacy() {
        // Verify total is 100
        const total = Object.values(gameState.criteriaWeights).reduce((sum, w) => sum + (w || 0), 0);
        if (total !== 100) {
            alert('Please ensure your weights add up to exactly 100%');
            return;
        }
        
        // Generate and show legacy portfolio
        generateLegacyPortfolio();
        renderLegacyPortfolio();
        showPhase('legacy-portfolio');
    }
    
    // ============================================
    // LEGACY PORTFOLIO FUNCTIONS
    // ============================================
    
    function generateLegacyPortfolio() {
        // Lead assignments for legacy projects
        const legacyLeadAssignments = {
            'legacy-1': 'sanjay_gupta',      // SmartLock 2.0 - firmware expertise
            'legacy-2': 'ananya_das',        // Regional Language App - mobile
            'legacy-3': 'rahul_kumar',       // Executive Dashboard - enterprise
            'legacy-4': 'vikram_shah',       // ShieldOS 3.0 - platform
            'legacy-5': 'mohammed_ali',      // OEM White-Label - partnerships
            'legacy-6': 'arjun_reddy',       // Cost-Reduced Sensor - hardware
            'legacy-7': 'deepa_sharma'       // Cloud Migration - infrastructure
        };
        
        // Initialize legacy projects from templates with leads
        gameState.legacyProjects = legacyProjectTemplates.map(template => ({
            ...template,
            decision: 'continue', // Default decision
            lead: projectLeads.find(l => l.id === legacyLeadAssignments[template.id]) || getRandomProjectLead()
        }));
        
        // Calculate initial budget sums
        gameState.legacyBudget = {
            committed: gameState.legacyProjects.reduce((sum, p) => sum + p.remainingBudget, 0),
            spent: gameState.legacyProjects.reduce((sum, p) => sum + p.spentBudget, 0),
            freed: 0
        };
    }
    
    function renderLegacyPortfolio() {
        const container = document.getElementById('legacy-projects-container');
        if (!container) return;
        
        // Update summary stats
        const greenCount = gameState.legacyProjects.filter(p => p.status === 'green').length;
        const amberCount = gameState.legacyProjects.filter(p => p.status === 'amber').length;
        const redCount = gameState.legacyProjects.filter(p => p.status === 'red').length;
        
        document.getElementById('legacy-count').textContent = gameState.legacyProjects.length;
        document.getElementById('legacy-committed-budget').textContent = `$${gameState.legacyBudget.committed.toFixed(1)}M`;
        document.getElementById('legacy-sunk-cost').textContent = `$${gameState.legacyBudget.spent.toFixed(1)}M`;
        document.getElementById('legacy-green-count').textContent = `${greenCount} On Track`;
        document.getElementById('legacy-amber-count').textContent = `${amberCount} At Risk`;
        document.getElementById('legacy-red-count').textContent = `${redCount} Troubled`;
        
        // Render simplified project cards with inline decision buttons
        container.innerHTML = gameState.legacyProjects.map(project => {
            const budgetImpact = project.decision === 'continue' ? project.remainingBudget :
                project.decision === 'accelerate' ? (project.remainingBudget * 1.4) :
                project.decision === 'reduce_scope' ? (project.remainingBudget * 0.6) :
                project.decision === 'pause' ? (project.remainingBudget * 0.1) : 0;
            
            return `
            <div class="legacy-project-card status-${project.status}" id="legacy-card-${project.id}">
                <div class="legacy-card-header" style="cursor: default;">
                    <div style="flex: 1;">
                        <h3>
                            ${project.name}
                            <span class="legacy-badge inherited">Inherited</span>
                            <span class="legacy-status-badge ${project.status}">${project.status.toUpperCase()}</span>
                        </h3>
                        <p class="legacy-card-summary">${project.desc.substring(0, 120)}...</p>
                        <div class="legacy-card-metrics">
                            <span class="legacy-metric"><strong>${project.progress}%</strong> complete</span>
                            <span class="legacy-metric"><strong>$${project.remainingBudget}M </strong> remaining</span>
                            <span class="legacy-metric"><strong>${project.quartersRemaining}Q</strong> to finish</span>
                            <span class="legacy-metric">Alignment: <strong style="color: ${project.strategicAlignment === 'high' ? 'var(--success)' : project.strategicAlignment === 'medium' ? 'var(--warning)' : 'var(--danger)'};">${project.strategicAlignment}</strong></span>
                        </div>
                        
                        <div class="legacy-quick-actions" id="legacy-actions-${project.id}">
                            <button class="legacy-quick-btn decision-continue ${project.decision === 'continue' ? 'selected' : ''}" 
                                    onclick="setLegacyDecisionQuick('${project.id}', 'continue')" title="Continue as planned">
                                ▶️ Continue
                            </button>
                            <button class="legacy-quick-btn decision-accelerate ${project.decision === 'accelerate' ? 'selected' : ''}" 
                                    onclick="setLegacyDecisionQuick('${project.id}', 'accelerate')" title="Add resources, faster delivery (+40% cost)">
                                ⏩ Accelerate
                            </button>
                            <button class="legacy-quick-btn decision-reduce_scope ${project.decision === 'reduce_scope' ? 'selected' : ''}" 
                                    onclick="setLegacyDecisionQuick('${project.id}', 'reduce_scope')" title="Cut features, save 40%">
                                ✂️ Reduce
                            </button>
                            <button class="legacy-quick-btn decision-pause ${project.decision === 'pause' ? 'selected' : ''}" 
                                    onclick="setLegacyDecisionQuick('${project.id}', 'pause')" title="Stop work, keep option to resume (10% holding cost)">
                                ⏸️ Pause
                            </button>
                            <button class="legacy-quick-btn decision-kill ${project.decision === 'kill' ? 'selected' : ''}" 
                                    onclick="setLegacyDecisionQuick('${project.id}', 'kill')" title="Terminate and free budget">
                                ⛔ Kill
                            </button>
                        </div>
                    </div>
                    <div class="legacy-card-right">
                        <div class="legacy-budget-impact" id="legacy-budget-${project.id}">
                            <div class="amount">$${budgetImpact.toFixed(1)}M </div>
                            <div class="label">Budget Required</div>
                        </div>
                        <span class="legacy-details-link" onclick="openLegacyModal('${project.id}')">
                            📋 View full details →
                        </span>
                    </div>
                </div>
            </div>
        `}).join('');
        
        updateLegacyBudgetSummary();
    }
    
    // Quick decision setter for legacy cards (no modal)
    function setLegacyDecisionQuick(projectId, decision) {
        const project = gameState.legacyProjects.find(p => p.id === projectId);
        if (!project) return;
        
        project.decision = decision;
        
        // Update button states
        const actionsContainer = document.getElementById(`legacy-actions-${projectId}`);
        if (actionsContainer) {
            actionsContainer.querySelectorAll('.legacy-quick-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            const selectedBtn = actionsContainer.querySelector(`.decision-${decision}`);
            if (selectedBtn) {
                selectedBtn.classList.add('selected');
            }
        }
        
        // Update budget display
        const budgetImpact = decision === 'continue' ? project.remainingBudget :
            decision === 'accelerate' ? (project.remainingBudget * 1.4) :
            decision === 'reduce_scope' ? (project.remainingBudget * 0.6) :
            decision === 'pause' ? (project.remainingBudget * 0.1) : 0;
        
        const budgetEl = document.getElementById(`legacy-budget-${projectId}`);
        if (budgetEl) {
            budgetEl.innerHTML = `
                <div class="amount" style="color: ${decision === 'kill' ? 'var(--success)' : 'var(--primary)'};">
                    ${decision === 'kill' ? '$0' : '$' + budgetImpact.toFixed(1)} M
                </div>
                <div class="label">${decision === 'kill' ? 'Budget Freed' : 'Budget Required'}</div>
            `;
        }
        
        // Update summary
        updateLegacyBudgetSummary();
    }
    
    function openLegacyModal(projectId) {
        const project = gameState.legacyProjects.find(p => p.id === projectId);
        if (!project) return;
        
        gameState.currentLegacyProject = projectId;
        
        // Populate modal header
        document.getElementById('legacy-modal-name').textContent = project.name;
        document.getElementById('legacy-modal-progress').textContent = `${project.progress}%`;
        
        const statusBadge = document.getElementById('legacy-modal-status');
        statusBadge.textContent = project.status.toUpperCase();
        statusBadge.className = `legacy-status-badge ${project.status}`;
        
        // Project overview
        document.getElementById('legacy-modal-desc').textContent = project.desc;
        
        // Strategic alignment
        const alignmentColor = project.strategicAlignment === 'high' ? 'var(--success)' : 
            project.strategicAlignment === 'medium' ? 'var(--warning)' : 'var(--danger)';
        document.getElementById('legacy-modal-alignment').innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                <span style="font-weight: 600; color: ${alignmentColor}; text-transform: uppercase;">${project.strategicAlignment} Alignment</span>
            </div>
            <p style="color: var(--gray-600); margin: 0;">${project.alignmentNote}</p>
        `;
        
        // Budget status
        const progressPct = (project.spentBudget / project.totalBudget) * 100;
        document.getElementById('legacy-modal-budget').innerHTML = `
            <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 15px;">
                <div class="financial-item" style="background: var(--gray-100);">
                    <div class="value" style="color: var(--gray-600);">$${project.spentBudget}M </div>
                    <div class="label">Already Spent (Sunk Cost)</div>
                </div>
                <div class="financial-item" style="background: var(--primary-lighter);">
                    <div class="value">$${project.remainingBudget}M </div>
                    <div class="label">Remaining to Complete</div>
                </div>
                <div class="financial-item" style="background: var(--gold-light);">
                    <div class="value" style="color: var(--gold-dark);">$${project.totalBudget}M </div>
                    <div class="label">Total Budget</div>
                </div>
                <div class="financial-item">
                    <div class="value">${project.teamSize}</div>
                    <div class="label">Team Members</div>
                </div>
                <div class="financial-item">
                    <div class="value">${project.quartersRemaining}Q</div>
                    <div class="label">Quarters Remaining</div>
                </div>
            </div>
            <div style="background: var(--gray-100); border-radius: 8px; height: 10px; overflow: hidden;">
                <div style="background: linear-gradient(90deg, var(--primary) 0%, var(--gold) 100%); height: 100%; width: ${progressPct}%; border-radius: 8px;"></div>
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 0.8em; color: var(--gray-500); margin-top: 5px;">
                <span>${project.progress}% complete</span>
                <span>${progressPct.toFixed(0)}% of budget consumed</span>
            </div>
        `;
        
        // External commitments
        document.getElementById('legacy-modal-commitments').textContent = project.externalCommitment;
        
        // Political context
        document.getElementById('legacy-modal-politics').textContent = project.politicalContext;
        
        // Project history timeline
        document.getElementById('legacy-modal-history').innerHTML = `
            <div class="legacy-timeline">
                ${project.quarterlyUpdates.map(update => `
                    <div class="legacy-timeline-item status-${update.status}">
                        <div class="legacy-timeline-quarter">Q${update.quarter < 0 ? update.quarter : '+' + update.quarter}</div>
                        <div class="legacy-timeline-narrative">${update.narrative}</div>
                    </div>
                `).join('')}
            </div>
        `;
        
        // Project lead
        document.getElementById('legacy-modal-lead').innerHTML = project.lead ? 
            renderLeadCard(project.lead) : 
            '<p style="color: var(--gray-500);">No lead currently assigned.</p>';
        
        // Risk assessment
        document.getElementById('legacy-modal-risks').innerHTML = `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="legacy-risk-box" style="display: block; margin: 0;">
                    <h5>⚠️ Risk if Continued</h5>
                    <p>${project.riskIfContinued}</p>
                </div>
                <div class="legacy-risk-box risk-kill" style="display: block; margin: 0;">
                    <h5>💥 Risk if Killed</h5>
                    <p>${project.riskIfKilled}</p>
                </div>
            </div>
        `;
        
        // Decision options
        document.getElementById('legacy-modal-decisions').innerHTML = Object.entries(legacyDecisionOptions).map(([key, option]) => {
            const budgetAmount = key === 'continue' ? project.remainingBudget :
                key === 'accelerate' ? (project.remainingBudget * 1.4) :
                key === 'reduce_scope' ? (project.remainingBudget * 0.6) :
                key === 'pause' ? (project.remainingBudget * 0.1) : 0;
            const freedAmount = project.remainingBudget - budgetAmount;
            
            return `
                <button class="legacy-decision-btn decision-${key} ${project.decision === key ? 'selected' : ''}" 
                        onclick="setLegacyDecision('${project.id}', '${key}')">
                    <span class="decision-icon">${option.icon}</span>
                    <span class="decision-label">${option.label}</span>
                    <span class="decision-desc">
                        ${key === 'kill' ? 'Frees $' + project.remainingBudget.toFixed(1) + 'M' :
                          key === 'pause' ? 'Frees $' + freedAmount.toFixed(1) + 'M' :
                          '$' + budgetAmount.toFixed(1) + 'M'}
                    </span>
                </button>
            `;
        }).join('');
        
        // Budget impact preview
        updateLegacyModalImpact(project);
        
        // Show modal
        document.getElementById('legacy-project-modal').classList.remove('hidden');
    }
    
    function updateLegacyModalImpact(project) {
        const option = legacyDecisionOptions[project.decision];
        const budgetAmount = project.remainingBudget * option.budgetImpact;
        const freedAmount = project.remainingBudget - budgetAmount;
        
        document.getElementById('legacy-modal-impact').innerHTML = `
            <div style="display: flex; gap: 20px; padding: 15px; background: ${freedAmount > 0 ? 'var(--success-light)' : 'var(--primary-lighter)'}; border-radius: 8px;">
                <div>
                    <div style="font-size: 0.8em; color: var(--gray-600);">Budget Required</div>
                    <div style="font-size: 1.2em; font-weight: 700; color: var(--primary);">$${budgetAmount.toFixed(1)}M </div>
                </div>
                ${freedAmount > 0 ? `
                <div>
                    <div style="font-size: 0.8em; color: var(--gray-600);">Budget Freed</div>
                    <div style="font-size: 1.2em; font-weight: 700; color: var(--success);">+$${freedAmount.toFixed(1)}M </div>
                </div>
                ` : ''}
            </div>
        `;
    }
    
    function closeLegacyModal() {
        document.getElementById('legacy-project-modal').classList.add('hidden');
        gameState.currentLegacyProject = null;
    }
    
    function setLegacyDecision(projectId, decision) {
        const project = gameState.legacyProjects.find(p => p.id === projectId);
        if (!project) return;
        
        project.decision = decision;
        
        // Update button states in modal if open
        const modal = document.getElementById('legacy-project-modal');
        if (!modal.classList.contains('hidden')) {
            modal.querySelectorAll('.legacy-decision-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            modal.querySelector(`.decision-${decision}`).classList.add('selected');
            updateLegacyModalImpact(project);
        }
        
        // Update card quick buttons
        const actionsContainer = document.getElementById(`legacy-actions-${projectId}`);
        if (actionsContainer) {
            actionsContainer.querySelectorAll('.legacy-quick-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            const selectedBtn = actionsContainer.querySelector(`.decision-${decision}`);
            if (selectedBtn) {
                selectedBtn.classList.add('selected');
            }
        }
        
        // Update card budget display
        const budgetImpact = decision === 'continue' ? project.remainingBudget :
            decision === 'accelerate' ? (project.remainingBudget * 1.4) :
            decision === 'reduce_scope' ? (project.remainingBudget * 0.6) :
            decision === 'pause' ? (project.remainingBudget * 0.1) : 0;
        
        const budgetEl = document.getElementById(`legacy-budget-${projectId}`);
        if (budgetEl) {
            budgetEl.innerHTML = `
                <div class="amount" style="color: ${decision === 'kill' ? 'var(--success)' : 'var(--primary)'};">
                    ${decision === 'kill' ? '$0' : '$' + budgetImpact.toFixed(1)} M
                </div>
                <div class="label">${decision === 'kill' ? 'Budget Freed' : 'Budget Required'}</div>
            `;
        }
        
        updateLegacyBudgetSummary();
    }
    
    function updateLegacyBudgetSummary() {
        let newCommitted = 0;
        let freed = 0;
        
        gameState.legacyProjects.forEach(project => {
            const option = legacyDecisionOptions[project.decision];
            const impact = project.remainingBudget * option.budgetImpact;
            newCommitted += impact;
            
            if (project.decision === 'kill' || project.decision === 'pause') {
                freed += project.remainingBudget - impact;
            } else if (project.decision === 'reduce_scope') {
                freed += project.remainingBudget * 0.4; // 40% freed from scope reduction
            }
        });
        
        gameState.legacyBudget.committed = newCommitted;
        gameState.legacyBudget.freed = freed;
        
        // Update UI
        document.getElementById('legacy-new-budget').textContent = `$${newCommitted.toFixed(1)}M`;
        document.getElementById('legacy-freed-budget').textContent = `$${freed.toFixed(1)}M`;
        
        // Calculate available for new projects (base budget + freed from legacy)
        // Base budget for new projects + any freed legacy budget
        const baseBudgetForNew = gameState.maxBudget; // Use the game's max budget
        const availableForNew = baseBudgetForNew + freed;
        document.getElementById('available-for-new').textContent = availableForNew.toFixed(1);
    }
    
    function confirmLegacyDecisions() {
        // Calculate the budget impact of legacy decisions
        let legacyBudgetCommitted = 0;
        
        gameState.legacyProjects.forEach(project => {
            const option = legacyDecisionOptions[project.decision];
            const impact = project.remainingBudget * option.budgetImpact;
            legacyBudgetCommitted += impact;
        });
        
        // Store legacy budget commitment in game state
        gameState.legacyBudgetCommitted = legacyBudgetCommitted;
        
        // CORRECT BUDGET CALCULATION:
        // Available for new projects = Annual budget - Legacy commitments
        // If you kill a project (budgetImpact=0), it doesn't consume budget
        // If you continue a project (budgetImpact=1.0), it consumes its remaining budget
        gameState.budget = gameState.maxBudget - legacyBudgetCommitted;
        
        // Move killed/paused projects to a separate list
        gameState.killedProjects = gameState.legacyProjects.filter(p => p.decision === 'kill');
        gameState.pausedProjects = gameState.legacyProjects.filter(p => p.decision === 'pause');
        
        // Keep active legacy projects (they'll appear in the portfolio alongside new selections)
        gameState.activeLegacyProjects = gameState.legacyProjects.filter(p => 
            !['kill', 'pause'].includes(p.decision)
        );
        
        // Now proceed to new project selection
        startProjectSelection();
    }
    
    // ============================================
    // GAME LOGIC
    // ============================================
    
    function calculateCommitteeEffects() {
        const effects = { technical: 1, market: 1, strategic: 1, team: 1, cost: 1, hiddenGem: 1, slowBurner: 1, paperTiger: 1, moneyPit: 1, conventionalWinner: 1, conventionalLoser: 1, pivotSuccess: 1 };
        
        gameState.committee.forEach(staffId => {
            const staff = findStaff(staffId);
            if (staff && staff.effects) {
                Object.keys(staff.effects).forEach(key => {
                    effects[key] = (effects[key] || 1) * staff.effects[key];
                });
            }
        });
        
        return effects;
    }
    
    function generateProjectPool() {
        const pool = [];
        const usedNames = new Set();
        const effects = calculateCommitteeEffects();
        
        let projectId = 1;
        
        // Target pool size: random between 10-12 projects (manageable to review)
        const targetPoolSize = 10 + Math.floor(Math.random() * 3);
        
        // Minimum total budget should be ~2.5x the max possible budget (50M * 2.5 = 125M)
        // Budget multiplier creates scarcity while keeping projects affordable enough for 4-6 selections
        const minTotalBudget = 100;
        const budgetMultiplier = 1.3;
        
        // Shuffle templates
        const shuffled = shuffleArray([...projectTemplates]);
        
        let totalBudget = 0;
        let templateIndex = 0;
        
        // Keep generating until we have enough projects AND enough total budget
        while ((pool.length < targetPoolSize || totalBudget < minTotalBudget) && templateIndex < shuffled.length) {
            const template = shuffled[templateIndex];
            
            // Pick 1-2 projects from each template
            const count = 1 + Math.floor(Math.random() * 2);
            const indices = shuffleArray([...Array(template.names.length).keys()]).slice(0, count);
            
            for (const i of indices) {
                const name = template.names[i];
                if (usedNames.has(name)) continue;
                usedNames.add(name);
                
                const budgetRaw = template.budgetRange[0] + Math.random() * (template.budgetRange[1] - template.budgetRange[0]);
                const budget = Math.round(budgetRaw * budgetMultiplier * 10) / 10; // Apply multiplier and round to 1 decimal
                
                // Get risk classification for this archetype
                const riskClass = getProjectRiskClass(template.archetype);
                const successRange = riskClassSuccessProb[riskClass];
                const roiRange = riskClassROI[riskClass];
                
                // Calculate success probability based on risk class (with some variance)
                let successProb = successRange.min + Math.random() * (successRange.max - successRange.min);
                
                // Calculate ROI multiplier for this project
                const roiMultiplier = roiRange.min + Math.random() * (roiRange.max - roiRange.min);
                
                // Apply committee effects based on archetype
                const archetypeMapping = {
                    'conventional_winner': 'conventionalWinner',
                    'conventional_loser': 'conventionalLoser',
                    'hidden_gem': 'hiddenGem',
                    'slow_burner': 'slowBurner',
                    'paper_tiger': 'paperTiger',
                    'money_pit': 'moneyPit',
                    'pivot_success': 'pivotSuccess',
                    'sustainability_play': 'sustainability',
                    'ip_fortress': 'ip',
                    'team_dependent': 'team',
                    'competitive_casualty': 'competitive'
                };
                const mappedKey = archetypeMapping[template.archetype];
                if (mappedKey && effects[mappedKey]) {
                    successProb *= effects[mappedKey];
                }
                
                pool.push({
                    id: 'proj-' + projectId,
                    numId: projectId,
                    name: name,
                    desc: template.descs[i],
                    shortDesc: template.descs[i],
                    tagline: getTagline(template.archetype),
                    fullDesc: generateFullDesc(name, template.descs[i], template.archetype),
                    marketContext: generateMarketContext(template.archetype),
                    capabilityFit: generateCapabilityFit(template.archetype, template.scores.capability),
                    risks: generateRisks(template.archetype),
                    teamNote: generateTeamNote(template.archetype),
                    teamDetails: generateTeamDetails(name, template.archetype, template.scores),
                    strategicBuckets: getStrategicBuckets(template.archetype),
                    trl: getTRL(template.archetype),
                    ipPosition: getIPPosition(template.archetype, name),
                    competitors: getCompetitors(template.archetype),
                    developmentCosts: getDevelopmentCosts(budget, template.archetype),
                    milestones: getMilestones(template.archetype, budget),
                    financials: generateFinancials(budget, template.archetype),
                    synergies: generateSynergies(name, template.archetype),
                    archetype: template.archetype,
                    riskClass: riskClass,
                    roiMultiplier: roiMultiplier,
                    budget: budget,
                    successProb: Math.max(0.05, Math.min(0.95, successProb)),
                    scores: { ...template.scores },
                    quarterNarratives: template.quarterNarratives,
                    outcomeNarrative: template.outcomeNarrative,
                    pivotRequired: template.pivotRequired || false,
                    teamSensitive: template.teamSensitive || false,
                    timeline: getTimelineByArchetype(template.archetype),
                    status: 'proposed',
                    currentQuarter: 0,
                    spentBudget: 0,
                    quarterlyUpdates: [],
                    decision: null,
                    outcome: null,
                    playerScores: {},
                    committeeScores: {},
                    lead: assignProjectLead(template.archetype, template.scores)
                });
                
                totalBudget += budget;
                projectId++;
                
                // Stop if we have enough projects AND enough budget
                if (pool.length >= targetPoolSize && totalBudget >= minTotalBudget) break;
            }
            
            templateIndex++;
        }
        
        return pool;
    }
    
    function getTimelineByArchetype(archetype) {
        // Different project types have different realistic development timelines
        // This ensures portfolio doesn't empty out during the 8-quarter game
        const timelineRanges = {
            // Long-term research/platform projects (10-12 quarters) - extend beyond game
            'frontier_tech': { min: 10, max: 12 },
            'moonshot': { min: 11, max: 12 },
            'platform_infrastructure': { min: 9, max: 12 },
            'slow_burner': { min: 9, max: 12 },
            
            // Medium-term strategic projects (8-11 quarters)
            'premium_flagship': { min: 8, max: 11 },
            'paper_tiger': { min: 8, max: 11 },
            'money_pit': { min: 9, max: 12 },
            'niche_vertical': { min: 8, max: 10 },
            'market_explorer': { min: 8, max: 10 },
            'ip_fortress': { min: 8, max: 11 },
            
            // Standard projects (8-10 quarters) - span the full game
            'core_upgrade': { min: 8, max: 10 },
            'conventional_winner': { min: 8, max: 10 },
            'conventional_loser': { min: 8, max: 11 },
            'hidden_gem': { min: 8, max: 10 },
            'pivot_success': { min: 8, max: 10 },
            'team_dependent': { min: 8, max: 10 },
            'sustainability_play': { min: 8, max: 10 },
            'esg_initiative': { min: 8, max: 10 },
            'underserved_market': { min: 8, max: 10 },
            
            // Previously shorter projects - now 8-9 quarters to ensure game-length duration
            'value_segment': { min: 8, max: 10 },
            'price_fighter': { min: 8, max: 10 },
            'competitive_casualty': { min: 8, max: 10 },
            'defensive': { min: 8, max: 10 },
            
            // Service/product archetypes (8-10 quarters)
            'visitor_flow': { min: 8, max: 10 },
            'security_score': { min: 8, max: 10 },
            'smart_key_control': { min: 8, max: 10 },
            'emergency_muster': { min: 8, max: 10 },
            'night_escort': { min: 8, max: 10 },
            'guard_training_sim': { min: 8, max: 10 },
            'incident_invoice': { min: 8, max: 10 },
            'parking_security': { min: 8, max: 10 },
            'shrink_prevention': { min: 8, max: 10 },
            'alarm_response_network': { min: 8, max: 11 },
            'camera_subscription': { min: 8, max: 10 },
            'privacy_analytics': { min: 8, max: 10 },
            'guard_tour_proof': { min: 8, max: 10 },
            'smart_intercom': { min: 8, max: 10 },
            'wander_management': { min: 8, max: 10 },
            'contractor_screening': { min: 8, max: 10 },
            'ai_video_search': { min: 9, max: 12 },
            'safety_security_soc': { min: 8, max: 11 },
            'anti_drone_service': { min: 8, max: 11 },
            'predictive_door_maintenance': { min: 8, max: 10 }
        };
        
        const range = timelineRanges[archetype] || { min: 8, max: 10 };
        return range.min + Math.floor(Math.random() * (range.max - range.min + 1));
    }
    
    function getTagline(archetype) {
        const taglines = {
            'conventional_winner': 'Proven opportunity with clear path to success',
            'conventional_loser': 'Ambitious technology with uncertain feasibility',
            'hidden_gem': 'Overlooked opportunity in an underserved segment',
            'slow_burner': 'Long-term strategic play requiring patience',
            'paper_tiger': 'Impressive specs but execution challenges ahead',
            'money_pit': 'High ambition project with scope risk',
            'pivot_success': 'Flexible concept that may need to evolve',
            'team_dependent': 'Success depends heavily on key people',
            'competitive_casualty': 'Value play in a price-competitive segment',
            'sustainability_play': 'ESG-focused product for conscious consumers',
            'ip_fortress': 'Innovation with strong IP protection potential'
        };
        return taglines[archetype] || 'Strategic opportunity for growth';
    }
    
    function generateFullDesc(name, shortDesc, archetype) {
        // The short description now contains product details, so fullDesc adds strategic context
        const strategicContext = {
            'conventional_winner': `This project builds on ShieldTech's proven capabilities and addresses validated market demand. The technology path is well-understood and supplier relationships are established. Key success factors: execution quality, maintaining differentiation, and timing the launch window. Risk profile: Lower technical risk, moderate competitive risk.`,
            'conventional_loser': `This ambitious research initiative explores breakthrough technology that could establish ShieldTech as an innovation leader. Academic partnerships provide access to world-class expertise, and the extended timeline allows methodical de-risking through stage-gated investment. Key success factors: research breakthroughs, talent retention, and patient capital. Risk profile: Higher technical uncertainty, but transformative upside if successful.`,
            'hidden_gem': `This project targets an underserved segment with passionate users that mainstream competitors have overlooked. Early customer research shows strong unmet demand and willingness to pay premium prices. The focused scope keeps development lean while niche positioning reduces competitive pressure. Key success factors: deep customer understanding, community building, and word-of-mouth growth. Risk profile: Market validation risk, but limited downside and loyal customer potential.`,
            'slow_burner': `This strategic platform investment builds foundational capabilities with compounding returns. While early metrics may appear modest, ecosystem control and partner lock-in create durable competitive advantage. Key success factors: sustained commitment, partner acquisition, and patience through the J-curve. Risk profile: Execution timeline risk, but strategic value compounds over time.`,
            'paper_tiger': `This technically ambitious project demonstrates ShieldTech's engineering leadership in premium segments. The specifications would lead the market and command premium pricing. Modular architecture enables incremental validation. Key success factors: integration discipline, quality focus, and premium positioning. Risk profile: Higher complexity risk, but strong margin potential and brand halo effects.`,
            'money_pit': `This foundational infrastructure investment addresses technical debt constraining future growth. Phased delivery with clear milestones ensures business continuity while enabling capability transformation. Comparable rewrites at peer companies have delivered substantial operational efficiencies. Key success factors: scope discipline, stakeholder alignment, and milestone-based governance. Risk profile: Execution and timeline risk, but enables future product velocity.`,
            'pivot_success': `This exploratory project tests new market directions with minimal upfront commitment. The lean approach emphasises validated learning, with explicit decision points to scale winning directions or redirect quickly. Key success factors: rapid experimentation, market listening, and pivot readiness. Risk profile: Direction uncertainty, but structured to limit downside while preserving optionality.`,
            'team_dependent': `This project leverages exceptional talent with unique domain expertise and strong track record. The team's capabilities make ambitious outcomes possible. Clear knowledge transfer plans ensure organisational learning. Key success factors: team retention, autonomy, and executive sponsorship. Risk profile: Concentration risk on key individuals, but high ceiling with right team.`,
            'competitive_casualty': `This project responds to market pressure with a cost-optimised offering leveraging ShieldTech's scale advantages. Aggressive timeline tests execution speed and operational discipline. Key success factors: supply chain optimisation, disciplined scope, and channel partnerships. Risk profile: Margin pressure and competitive response, but strengthens market position if executed well.`,
            'sustainability_play': `This project positions ShieldTech at the forefront of sustainable product development as consumer and regulatory interest grows. First-mover advantage in green security products creates brand differentiation and premium positioning. Key success factors: authentic sustainability credentials, certification, and effective storytelling. Risk profile: Market timing and premium realisation, but growing tailwinds and PR value.`,
            'ip_fortress': `This project builds proprietary technology protected by strong intellectual property. Patent filings create defensive moats against commoditisation and potential licensing revenue. Key success factors: novel innovation, IP prosecution, and enforcement readiness. Risk profile: Technical and legal complexity, but durable competitive advantage if patents hold.`
        };
        
        return shortDesc + '\n\n' + (strategicContext[archetype] || '');
    }
    
    function generateMarketContext(archetype) {
        const contexts = {
            'conventional_winner': 'The Indian home security market is growing at 18% CAGR, driven by rising disposable incomes and urbanisation. Smart locks and cameras are the fastest-growing categories. Main competitors include Godrej, Yale, CP Plus, and Xiaomi. Premium segments ($125+) are less price-sensitive and value brand trust. ShieldTech\'s brand and service network provide differentiation opportunities.',
            'conventional_loser': 'This technology targets an emerging market that\'s currently nascent but growing as underlying capabilities mature. Defence and enterprise segments provide near-term revenue while consumer adoption develops. Positioning investment now creates first-mover advantage as the market scales—similar bets on AI and IoT by peers have generated strong returns.',
            'hidden_gem': 'This segment has been overlooked because mainstream competitors focus on high-volume urban markets. However, passionate niche users become powerful brand advocates. Word-of-mouth in tight communities drives organic growth with lower customer acquisition costs. Market size appears limited but adjacencies create expansion pathways.',
            'slow_burner': 'Platform markets follow a J-curve: slow initial adoption accelerating as network effects compound. The Indian smart home market is fragmented with 20+ incompatible ecosystems. Winning the integration battle means owning the customer relationship long-term. Patience is rewarded—early platform investments at Amazon and Apple now dominate their categories.',
            'paper_tiger': 'Premium buyers in metros compare specifications obsessively via YouTube reviews and ratings. Winning on paper drives recommendations and justifies premium pricing. While the premium segment is 5% of volume, it\'s 25% of industry profit. Early adopters influence mainstream perception and create brand halo effects.',
            'money_pit': 'This is infrastructure investment enabling future product velocity. Value is measured by capabilities unlocked and technical debt reduced. Comparable platform modernisations at peer companies have delivered 40%+ improvement in development speed and significant operational cost reduction.',
            'pivot_success': 'Adjacent markets this could address include: housing society management (5,000+ societies in Bangalore alone), security agency coordination, and insurance partnerships. Customer discovery will reveal best product-market fit. The lean approach means early market feedback shapes direction before major commitment.',
            'team_dependent': 'Market opportunity depends on team discoveries. Similar "innovation lab" initiatives have spawned breakthrough products (Gmail, Post-it Notes, AWS). The key is assembling the right talent and giving them autonomy to explore. Structured milestone reviews balance exploration with accountability.',
            'competitive_casualty': 'The budget segment is competitive but massive—60% of unit volume. Xiaomi and Chinese imports have thin margins but ShieldTech\'s local service, warranty, and ecosystem integration provide differentiation. Competitive pressure is real but market share gains at scale drive meaningful revenue and strengthen overall position.',
            'sustainability_play': 'ESG-conscious consumers are 8-12% of premium buyers and growing rapidly, especially among younger demographics. Willingness-to-pay studies show 15-25% premium acceptable for genuinely sustainable products. Beyond direct sales, sustainability leadership generates strong PR, retail channel preference, and B2B opportunities.',
            'ip_fortress': 'Patent protection in India has strengthened significantly, and international patents (US, EU) are increasingly valuable for licensing and defensive purposes. The patent examination backlog means 3-4 years to grant, but early filing establishes priority. Strong IP positions command acquisition premiums and partnership leverage.'
        };
        return contexts[archetype] || 'Market analysis pending.';
    }
    
    function generateCapabilityFit(archetype, capScore) {
        const capabilityDetails = {
            'conventional_winner': 'Strong fit with existing hardware design and ShieldOS platform capabilities. Manufacturing can leverage current ODM partners (Foxconn, Salcomp). App team has delivered similar features successfully. QA processes are established and proven. Low capability risk—focus is on execution excellence.',
            'conventional_loser': 'Requires new capabilities in advanced research: physics/materials expertise, academic partnerships, and experimental prototyping. Plan includes hiring 3-5 specialist researchers and establishing lab facilities. IISc partnership provides access to talent pipeline. Capability building is part of the investment thesis.',
            'hidden_gem': 'Core sensing technology transfers from existing products—engineering lift is manageable. New capabilities needed: deep segment research (budgeted for user research program), specialised channel partnerships (conversations initiated), and adapted support processes. Gap analysis shows clear paths to address each.',
            'slow_burner': 'Platform engineering team has strong API and integration experience from ShieldOS. Requires dedicated partnership resources—business development and legal capacity being added. Developer relations capability being built with industry hires. Foundation exists; scaling the team is the focus.',
            'paper_tiger': 'Pushes hardware capabilities into new territory—exciting growth opportunity for engineering. New chip partnerships identified (Qualcomm, Ambarella). Manufacturing process development budgeted. Will consume senior engineering bandwidth but builds valuable institutional capability for future premium products.',
            'money_pit': 'Engineering team has the technical skills; capacity planning accounts for dual-track development. Phased approach with dedicated platform squad maintains existing products. Historical lessons from peer companies inform our governance model. Capability is present; execution discipline is the focus.',
            'pivot_success': 'Initial concept fits current capabilities well. Team assembled with learning agility and entrepreneurial mindset—flexibility is a selection criterion. External hiring budget reserved for capabilities gaps that emerge from market feedback. Adaptability built into team design.',
            'team_dependent': 'Capability assessment centres on team composition. Identified candidates have strong track records and relevant domain expertise. Retention packages and autonomy commitments designed to secure and motivate key individuals. Success depends on assembling the right people—selection process is rigorous.',
            'competitive_casualty': 'Manufacturing and supply chain capabilities exist. Cost engineering has been gap—now addressed with new procurement leadership hire. Operations team trained on lean methodology. Finance processes tightened for thin-margin discipline. Capability gaps are being actively closed.',
            'sustainability_play': 'Core product capabilities transfer directly. Addressing specific gaps: sustainable material sourcing (3 suppliers identified), environmental certification (B-Corp consultant engaged), and eco-segment marketing (agency with relevant experience shortlisted). Clear plan to build new capabilities.',
            'ip_fortress': 'R&D team fully capable of novel technology development. Patent strategy gap addressed: external IP counsel retained, and patent engineer role budgeted. Building IP capability is strategic priority with clear investment. Legal and technical tracks aligned.'
        };
        
        return capabilityDetails[archetype] || (capScore >= 4 
            ? 'Strong alignment with existing capabilities. Team has relevant experience and infrastructure is in place.'
            : capScore >= 3 
                ? 'Moderate fit with current capabilities. Specific gaps identified with plans to address.'
                : 'Requires targeted capability building. Clear investment plan to address gaps. Higher execution complexity but achievable with focus.');
    }
    
    function generateRisks(archetype) {
        const risks = {
            'conventional_winner': 'Competitive response: Godrej or Yale could match features and undercut on price within 6 months. Component supply: Biometric modules from single supplier (Fingerprint Cards AB). Premium pricing requires flawless launch—early quality issues would damage brand positioning.',
            'conventional_loser': 'Technology risk is fundamental—underlying physics may not support consumer product. Academic research rarely translates to manufacturable products. Team morale will suffer if repeated setbacks occur. Budget and timeline estimates are highly speculative.',
            'hidden_gem': 'Market size risk: Passionate users in research may not translate to sustainable business. Customer acquisition cost could exceed LTV if segment proves smaller than surveys suggest. May cannibalise resources from core products for uncertain return.',
            'slow_burner': 'Patience risk: Q2-Q3 metrics will disappoint, creating pressure to cut funding before network effects materialise. Platform dependency: Google/Amazon could prioritise India integrations, making our bridge redundant. Team retention through slow early phases.',
            'paper_tiger': 'Execution risk is severe: 8K processing generates heat requiring redesigned thermal management. Integration complexity grows exponentially with features. Quality issues in premium segment amplified by vocal reviewers. Key engineer single-point-of-failure.',
            'money_pit': 'Scope creep is near-certain: discovery of additional technical debt will expand requirements. Opportunity cost: engineering bandwidth unavailable for customer-facing features. Sunk cost fallacy may prevent rational stop decision. 2-3x budget overrun is industry norm.',
            'pivot_success': 'Direction uncertainty: original concept may fail requiring pivot, but pivot direction is unknown. Team may resist abandoning initial vision. Multiple pivots could exhaust budget before finding fit. Market timing window may close during iteration.',
            'team_dependent': 'Key person risk is existential: 2 of 6 team members have received Google/Amazon offers in past year. Team chemistry is fragile—one personality conflict could derail project. Knowledge concentration means departure = project failure.',
            'competitive_casualty': 'Price war risk is extreme: Xiaomi can sustain losses to gain market share. Rupee weakness directly impacts component costs (70% imported). Single supply chain disruption eliminates thin margin. Brand dilution from "budget" positioning.',
            'sustainability_play': 'Greenwashing accusations if claims don\'t withstand scrutiny. Ocean plastic supply chain unproven at scale. Premium pricing may limit to <10,000 units/year—subscale for manufacturing efficiency. ESG standards evolving rapidly.',
            'ip_fortress': 'Patent prosecution takes 3-4 years—competitors may design around. Legal costs for defence against challenges: $60K-$120K. Key patents could be invalidated on prior art grounds. Technology may become obsolete before patent enforcement possible.'
        };
        return risks[archetype] || 'Risk assessment pending.';
    }
    
    function generateTeamNote(archetype) {
        const notes = {
            'conventional_winner': 'Standard product team can execute. Clear ownership and accountability.',
            'conventional_loser': 'Needs researchers comfortable with uncertainty. May struggle with ambiguity.',
            'hidden_gem': 'Requires product manager who deeply understands the target segment.',
            'slow_burner': 'Team must be comfortable with delayed gratification. Not for impatient builders.',
            'paper_tiger': 'Best engineers needed. Will stretch the team significantly.',
            'money_pit': 'Requires strong project management. Scope discipline is critical.',
            'pivot_success': 'Entrepreneurial team needed. Must embrace uncertainty and iteration.',
            'team_dependent': 'Success tied to specific individuals. Their engagement is essential.',
            'competitive_casualty': 'Cost engineering expertise required. Manufacturing efficiency critical.',
            'sustainability_play': 'Need supply chain expertise for sustainable materials.',
            'ip_fortress': 'Legal and engineering alignment required. Patent strategy is key.'
        };
        return notes[archetype] || 'Team assignment pending.';
    }
    
    function generateTeamDetails(name, archetype, scores) {
        // Select appropriate team leads based on project type
        const teamLeads = {
            'conventional_winner': [
                { role: 'Project Lead', staffId: 'deepak', reason: 'Core product expertise and P&L experience' },
                { role: 'Technical Lead', staffId: 'harpreet', reason: 'Platform integration and engineering leadership' },
                { role: 'Product Manager', staffId: null, reason: 'To be assigned from product team' }
            ],
            'conventional_loser': [
                { role: 'Research Lead', staffId: 'zara', reason: 'Advanced R&D and experimental technology expertise' },
                { role: 'Technical Advisor', staffId: 'aisha', reason: 'Systems architecture for novel approaches' },
                { role: 'Feasibility Reviewer', staffId: 'mohammed', reason: 'Honest technical assessment' }
            ],
            'hidden_gem': [
                { role: 'Market Champion', staffId: 'bandana', reason: 'Understanding of underserved segments' },
                { role: 'Field Insight', staffId: 'thomas', reason: 'Direct customer knowledge from the field' },
                { role: 'Product Lead', staffId: null, reason: 'Requires hire with segment expertise' }
            ],
            'slow_burner': [
                { role: 'Platform Lead', staffId: 'krishna', reason: 'Ecosystem thinking and partnership building' },
                { role: 'Architecture', staffId: 'aisha', reason: 'Long-term technical vision' },
                { role: 'Technical Lead', staffId: 'prakash', reason: 'Infrastructure and scalability expertise' }
            ],
            'paper_tiger': [
                { role: 'Engineering Lead', staffId: 'harpreet', reason: 'Can push team to ambitious specs' },
                { role: 'Hardware Lead', staffId: 'anand', reason: 'Complex hardware integration' },
                { role: 'QA Oversight', staffId: null, reason: 'Will need dedicated QA resources' }
            ],
            'money_pit': [
                { role: 'Program Manager', staffId: 'sanjay', reason: 'Operations discipline and scope control' },
                { role: 'Technical Sponsor', staffId: 'harpreet', reason: 'Platform ownership and architecture' },
                { role: 'Finance Oversight', staffId: 'farhan', reason: 'Budget governance and milestone tracking' }
            ],
            'pivot_success': [
                { role: 'Venture Lead', staffId: null, reason: 'Needs entrepreneurial mindset - internal or external hire' },
                { role: 'Market Guidance', staffId: 'joseph', reason: 'Customer feedback loops and iteration' },
                { role: 'Technical Support', staffId: 'mohammed', reason: 'Flexible problem-solving across pivots' }
            ],
            'team_dependent': [
                { role: 'Team Lead', staffId: 'mohammed', reason: 'Distinguished engineer with cross-functional respect' },
                { role: 'Technical Sponsor', staffId: 'aisha', reason: 'Chief architect oversight' },
                { role: 'Retention Support', staffId: 'kavitha', reason: 'HR support for team engagement' }
            ],
            'competitive_casualty': [
                { role: 'Cost Engineering', staffId: 'anand', reason: 'Hardware cost optimization expertise' },
                { role: 'Manufacturing', staffId: 'sanjay', reason: 'Operations and supply chain efficiency' },
                { role: 'Sales Input', staffId: 'rajiv', reason: 'Channel pricing and competitive intelligence' }
            ],
            'sustainability_play': [
                { role: 'Sustainability Lead', staffId: null, reason: 'Requires new hire with ESG expertise' },
                { role: 'Supply Chain', staffId: 'sanjay', reason: 'Sustainable sourcing and manufacturing' },
                { role: 'Marketing', staffId: 'anjali', reason: 'Brand positioning for eco-conscious segment' }
            ],
            'ip_fortress': [
                { role: 'Legal Lead', staffId: 'nandini', reason: 'IP strategy and patent portfolio management' },
                { role: 'Technical Inventor', staffId: 'zara', reason: 'Novel algorithm development' },
                { role: 'Patent Liaison', staffId: null, reason: 'Needs dedicated patent engineer' }
            ]
        };
        
        const team = teamLeads[archetype] || teamLeads['conventional_winner'];
        
        // Generate team strength assessment
        let teamStrength = 'moderate';
        let teamRisks = [];
        let teamStrengths = [];
        
        // Check if we have strong leads assigned
        const assignedLeads = team.filter(t => t.staffId !== null);
        if (assignedLeads.length >= 2) {
            teamStrength = 'strong';
            teamStrengths.push('Experienced leadership identified');
        } else {
            teamRisks.push('Key roles require new hires');
        }
        
        // Add archetype-specific assessments
        if (archetype === 'paper_tiger' || archetype === 'money_pit') {
            teamRisks.push('Project complexity will stretch resources');
        }
        if (archetype === 'hidden_gem') {
            teamStrengths.push('Field team brings customer insight');
        }
        if (archetype === 'team_dependent') {
            teamRisks.push('High dependency on key individuals');
            teamRisks.push('Retention critical to success');
        }
        if (scores.team >= 4) {
            teamStrengths.push('Strong team capability scores');
        } else if (scores.team <= 2) {
            teamRisks.push('Team capability gaps identified');
        }
        
        return {
            leads: team,
            strength: teamStrength,
            risks: teamRisks,
            strengths: teamStrengths,
            headcount: getHeadcount(archetype),
            skillsNeeded: getSkillsNeeded(archetype)
        };
    }
    
    function getHeadcount(archetype) {
        const headcounts = {
            'conventional_winner': { engineers: '4-6', product: 1, design: 1, qa: 1, total: '7-9' },
            'conventional_loser': { engineers: '6-10', product: 1, design: 1, qa: 2, research: 2, total: '12-16' },
            'hidden_gem': { engineers: '3-4', product: 1, design: 1, qa: 1, field: 2, total: '8-9' },
            'slow_burner': { engineers: '5-8', product: 2, design: 1, qa: 1, partnerships: 1, total: '10-13' },
            'paper_tiger': { engineers: '8-12', product: 2, design: 2, qa: 3, total: '15-19' },
            'money_pit': { engineers: '10-15', product: 2, design: 1, qa: 3, devops: 2, total: '18-23' },
            'pivot_success': { engineers: '3-5', product: 1, design: 1, qa: 1, total: '6-8' },
            'team_dependent': { engineers: '4-6', product: 1, design: 1, qa: 1, total: '7-9' },
            'competitive_casualty': { engineers: '3-4', product: 1, qa: 1, manufacturing: 2, total: '7-8' },
            'sustainability_play': { engineers: '3-5', product: 1, design: 1, qa: 1, supply_chain: 1, total: '7-9' },
            'ip_fortress': { engineers: '5-7', product: 1, design: 1, qa: 1, legal: 1, total: '9-11' }
        };
        return headcounts[archetype] || headcounts['conventional_winner'];
    }
    
    function getSkillsNeeded(archetype) {
        const skills = {
            'conventional_winner': ['Mobile development', 'Hardware integration', 'Cloud backend', 'UX design'],
            'conventional_loser': ['Research methodology', 'Experimental design', 'Advanced physics/ML', 'Prototyping'],
            'hidden_gem': ['User research', 'Field testing', 'Segment expertise', 'Rapid iteration'],
            'slow_burner': ['API development', 'Partner integration', 'Platform architecture', 'Developer relations'],
            'paper_tiger': ['Advanced hardware', 'Firmware optimisation', 'System integration', 'Performance tuning'],
            'money_pit': ['Legacy systems', 'Migration planning', 'Architecture refactoring', 'DevOps'],
            'pivot_success': ['Lean methodology', 'Customer development', 'Rapid prototyping', 'Flexibility'],
            'team_dependent': ['Cross-functional collaboration', 'Innovation process', 'Self-direction'],
            'competitive_casualty': ['Cost engineering', 'Manufacturing optimisation', 'Supply chain', 'Value engineering'],
            'sustainability_play': ['Sustainable materials', 'Lifecycle analysis', 'ESG compliance', 'Eco-design'],
            'ip_fortress': ['Patent drafting', 'Prior art research', 'Defensive design', 'IP strategy']
        };
        return skills[archetype] || skills['conventional_winner'];
    }
    
    function generateFinancials(budget, archetype) {
        const multipliers = {
            // Original archetypes
            'conventional_winner': { rev1: 12, rev2: 20, margin: 38, breakeven: 14 },
            'conventional_loser': { rev1: 3, rev2: 8, margin: 20, breakeven: 36 },
            'hidden_gem': { rev1: 6, rev2: 15, margin: 42, breakeven: 16 },
            'slow_burner': { rev1: 3, rev2: 12, margin: 55, breakeven: 26 },
            'paper_tiger': { rev1: 10, rev2: 18, margin: 35, breakeven: 20 },
            'money_pit': { rev1: 0, rev2: 5, margin: 30, breakeven: 40 },
            'pivot_success': { rev1: 5, rev2: 14, margin: 45, breakeven: 18 },
            'team_dependent': { rev1: 8, rev2: 16, margin: 40, breakeven: 15 },
            'competitive_casualty': { rev1: 15, rev2: 22, margin: 18, breakeven: 10 },
            'sustainability_play': { rev1: 5, rev2: 12, margin: 38, breakeven: 16 },
            'ip_fortress': { rev1: 6, rev2: 15, margin: 45, breakeven: 22 },
            
            // Core/upgrade archetypes
            'core_upgrade': { rev1: 10, rev2: 18, margin: 40, breakeven: 12 },
            'value_segment': { rev1: 8, rev2: 16, margin: 28, breakeven: 10 },
            'premium_flagship': { rev1: 6, rev2: 14, margin: 48, breakeven: 18 },
            'niche_vertical': { rev1: 4, rev2: 10, margin: 45, breakeven: 15 },
            'underserved_market': { rev1: 5, rev2: 12, margin: 32, breakeven: 14 },
            'platform_infrastructure': { rev1: 2, rev2: 10, margin: 65, breakeven: 24 },
            'market_explorer': { rev1: 3, rev2: 9, margin: 50, breakeven: 20 },
            'price_fighter': { rev1: 12, rev2: 20, margin: 18, breakeven: 8 },
            'esg_initiative': { rev1: 4, rev2: 10, margin: 42, breakeven: 18 },
            'proprietary_tech': { rev1: 5, rev2: 14, margin: 52, breakeven: 20 },
            'frontier_tech': { rev1: 1, rev2: 6, margin: 55, breakeven: 36 },
            
            // AI and advanced tech
            'ai_guard_innovation': { rev1: 4, rev2: 12, margin: 58, breakeven: 18 },
            'services_platform': { rev1: 6, rev2: 16, margin: 62, breakeven: 16 },
            'autonomous_drone': { rev1: 2, rev2: 8, margin: 45, breakeven: 30 },
            'ground_robot': { rev1: 1, rev2: 6, margin: 42, breakeven: 36 },
            'privacy_compliance': { rev1: 5, rev2: 14, margin: 55, breakeven: 18 },
            'evidence_chain': { rev1: 6, rev2: 15, margin: 58, breakeven: 16 },
            'smart_access': { rev1: 8, rev2: 18, margin: 48, breakeven: 14 },
            'rtls_tracking': { rev1: 4, rev2: 12, margin: 52, breakeven: 20 },
            'acoustic_detection': { rev1: 3, rev2: 10, margin: 50, breakeven: 24 },
            'digital_twin': { rev1: 2, rev2: 8, margin: 60, breakeven: 28 },
            'perimeter_fusion': { rev1: 5, rev2: 14, margin: 48, breakeven: 18 },
            'cyber_physical_soc': { rev1: 4, rev2: 12, margin: 55, breakeven: 22 },
            'camera_health': { rev1: 7, rev2: 16, margin: 65, breakeven: 12 },
            'panic_wearable': { rev1: 6, rev2: 14, margin: 42, breakeven: 14 },
            'vehicle_intelligence': { rev1: 5, rev2: 14, margin: 50, breakeven: 18 },
            'compliance_automation': { rev1: 8, rev2: 18, margin: 68, breakeven: 12 },
            'deepfake_defense': { rev1: 3, rev2: 10, margin: 58, breakeven: 24 },
            'edge_micro_nvr': { rev1: 8, rev2: 18, margin: 38, breakeven: 12 },
            'rapid_deploy_kit': { rev1: 10, rev2: 20, margin: 35, breakeven: 10 },
            'predictive_risk': { rev1: 3, rev2: 10, margin: 62, breakeven: 26 },
            'visitor_flow': { rev1: 6, rev2: 14, margin: 55, breakeven: 14 },
            'security_score': { rev1: 5, rev2: 12, margin: 70, breakeven: 16 },
            'smart_key_control': { rev1: 7, rev2: 16, margin: 45, breakeven: 14 },
            'emergency_muster': { rev1: 5, rev2: 12, margin: 52, breakeven: 16 },
            'night_escort': { rev1: 4, rev2: 10, margin: 48, breakeven: 18 },
            'guard_training_sim': { rev1: 3, rev2: 8, margin: 65, breakeven: 20 },
            'incident_invoice': { rev1: 6, rev2: 14, margin: 72, breakeven: 12 },
            'parking_security': { rev1: 7, rev2: 16, margin: 48, breakeven: 14 },
            'shrink_prevention': { rev1: 8, rev2: 18, margin: 55, breakeven: 12 },
            'alarm_response_network': { rev1: 5, rev2: 14, margin: 58, breakeven: 16 },
            'camera_subscription': { rev1: 4, rev2: 12, margin: 68, breakeven: 14 },
            'privacy_analytics': { rev1: 5, rev2: 14, margin: 60, breakeven: 18 },
            'guard_tour_proof': { rev1: 6, rev2: 14, margin: 62, breakeven: 14 },
            'smart_intercom': { rev1: 8, rev2: 18, margin: 42, breakeven: 12 },
            'wander_management': { rev1: 4, rev2: 10, margin: 52, breakeven: 18 },
            'contractor_screening': { rev1: 5, rev2: 12, margin: 65, breakeven: 14 },
            'ai_video_search': { rev1: 4, rev2: 12, margin: 58, breakeven: 18 },
            'safety_security_soc': { rev1: 5, rev2: 14, margin: 55, breakeven: 20 },
            'anti_drone_service': { rev1: 3, rev2: 10, margin: 52, breakeven: 24 },
            'predictive_door_maintenance': { rev1: 6, rev2: 14, margin: 68, breakeven: 14 },
            
            // Legacy archetypes
            'legacy_incremental': { rev1: 8, rev2: 16, margin: 38, breakeven: 12 },
            'legacy_pet_project': { rev1: 2, rev2: 6, margin: 25, breakeven: 30 },
            'legacy_strategic_troubled': { rev1: 4, rev2: 10, margin: 32, breakeven: 24 },
            'legacy_partnership': { rev1: 6, rev2: 14, margin: 35, breakeven: 18 },
            'legacy_defensive': { rev1: 10, rev2: 18, margin: 30, breakeven: 10 },
            'legacy_infrastructure': { rev1: 0, rev2: 4, margin: 0, breakeven: 48 }
        };
        const m = multipliers[archetype] || { rev1: 8, rev2: 15, margin: 35, breakeven: 18 };
        return {
            devCost: '$' + budget.toFixed(1) + 'M',
            timeline: (2 + Math.floor(Math.random() * 3)) + ' quarters',
            projectedRevenue: '$' + Math.round(budget * m.rev1) + ' M (Y1), $' + Math.round(budget * m.rev2) + ' M (Y2)',
            grossMargin: m.margin + '%',
            breakeven: m.breakeven + ' months'
        };
    }
    
    function generateSynergies(name, archetype) {
        const baseSynergies = [
            'Shares app and cloud infrastructure with other products',
            'Could bundle with complementary products',
            'Distribution channels apply to other offerings'
        ];
        if (archetype === 'slow_burner' || archetype === 'paper_tiger') {
            baseSynergies.push('Platform capabilities benefit entire portfolio');
        }
        if (archetype === 'hidden_gem') {
            baseSynergies.push('Opens new customer segment for cross-selling');
        }
        return baseSynergies.slice(0, 2 + Math.floor(Math.random() * 2));
    }
    
    // Strategic buckets aligned to ShieldTech's corporate priorities
    const strategicBuckets = {
        'defend-metro': {
            id: 'defend-metro',
            name: 'Defend Metro Leadership',
            color: '#2563eb',
            description: 'Retain #1 position in top 8 cities',
            icon: '🛡️'
        },
        'tier23-rollout': {
            id: 'tier23-rollout',
            name: 'Tier 2/3 Rollout',
            color: '#059669',
            description: 'Profitable entry into 50 emerging cities',
            icon: '🗺️'
        },
        'recurring-revenue': {
            id: 'recurring-revenue',
            name: 'Recurring Revenue',
            color: '#7c3aed',
            description: 'Shift to services and subscription model',
            icon: '💳'
        },
        'ai-first': {
            id: 'ai-first',
            name: 'AI-First Products',
            color: '#dc2626',
            description: 'Lead the transition to intelligent security',
            icon: '🤖'
        }
    };
    
    function getStrategicBuckets(archetype) {
        const bucketMapping = {
            // Defend Metro Leadership
            'core_upgrade': ['defend-metro'],
            'premium_flagship': ['defend-metro'],
            'proprietary_tech': ['defend-metro'],
            'smart_access': ['defend-metro'],
            'evidence_chain': ['defend-metro'],
            'deepfake_defense': ['defend-metro'],
            'camera_health': ['defend-metro'],
            'compliance_automation': ['defend-metro'],
            'legacy_incremental': ['defend-metro'],
            'legacy_defensive': ['defend-metro'],
            
            // Tier 2/3 Rollout
            'value_segment': ['tier23-rollout'],
            'underserved_market': ['tier23-rollout'],
            'price_fighter': ['tier23-rollout'],
            'edge_micro_nvr': ['tier23-rollout'],
            'rapid_deploy_kit': ['tier23-rollout'],
            'camera_subscription': ['tier23-rollout'],
            'niche_vertical': ['tier23-rollout'],
            'panic_wearable': ['tier23-rollout'],
            'smart_key_control': ['tier23-rollout'],
            'night_escort': ['tier23-rollout'],
            'smart_intercom': ['tier23-rollout'],
            'guard_training_sim': ['tier23-rollout'],
            
            // Recurring Revenue
            'services_platform': ['recurring-revenue'],
            'platform_infrastructure': ['recurring-revenue'],
            'market_explorer': ['recurring-revenue'],
            'alarm_response_network': ['recurring-revenue'],
            'visitor_flow': ['recurring-revenue'],
            'guard_tour_proof': ['recurring-revenue'],
            'incident_invoice': ['recurring-revenue'],
            'parking_security': ['recurring-revenue'],
            'shrink_prevention': ['recurring-revenue'],
            'security_score': ['recurring-revenue'],
            
            // AI-First Products
            'frontier_tech': ['ai-first'],
            'ai_guard_innovation': ['ai-first'],
            'autonomous_drone': ['ai-first'],
            'ground_robot': ['ai-first'],
            'privacy_compliance': ['ai-first'],
            'acoustic_detection': ['ai-first'],
            'digital_twin': ['ai-first'],
            'perimeter_fusion': ['ai-first'],
            'cyber_physical_soc': ['ai-first'],
            'rtls_tracking': ['ai-first'],
            'vehicle_intelligence': ['ai-first'],
            'predictive_risk': ['ai-first'],
            'ai_video_search': ['ai-first'],
            'safety_security_soc': ['ai-first'],
            'anti_drone_service': ['ai-first'],
            'predictive_door_maintenance': ['ai-first']
            
            // No bucket assigned (cross-cutting or doesn't fit):
            // esg_initiative, wander_management, contractor_screening, emergency_muster
            // legacy_pet_project, legacy_strategic_troubled, legacy_partnership, legacy_infrastructure
        };
        
        const bucketIds = bucketMapping[archetype] || [];
        return bucketIds.map(id => strategicBuckets[id]);
    }
    
    // Risk classification for portfolio balance scoring
    // Transformational = high risk, high reward (lower success prob, higher ROI)
    // Incremental = lower risk, lower reward (higher success prob, lower ROI)
    const projectRiskClassification = {
        // Transformational projects (30-45% base success, 4-6x ROI potential)
        'frontier_tech': 'transformational',
        'ai_guard_innovation': 'transformational',
        'autonomous_drone': 'transformational',
        'ground_robot': 'transformational',
        'digital_twin': 'transformational',
        'perimeter_fusion': 'transformational',
        'cyber_physical_soc': 'transformational',
        'acoustic_detection': 'transformational',
        'deepfake_defense': 'transformational',
        'platform_infrastructure': 'transformational',
        'predictive_risk': 'transformational',
        'ai_video_search': 'transformational',
        'safety_security_soc': 'transformational',
        'anti_drone_service': 'transformational',
        'moonshot': 'transformational',
        'hidden_gem': 'transformational',
        
        // Incremental projects (60-75% base success, 1.5-2x ROI potential)
        'core_upgrade': 'incremental',
        'value_segment': 'incremental',
        'price_fighter': 'incremental',
        'edge_micro_nvr': 'incremental',
        'rapid_deploy_kit': 'incremental',
        'camera_subscription': 'incremental',
        'compliance_automation': 'incremental',
        'camera_health': 'incremental',
        'smart_access': 'incremental',
        'guard_tour_proof': 'incremental',
        'incident_invoice': 'incremental',
        'parking_security': 'incremental',
        'visitor_flow': 'incremental',
        'smart_intercom': 'incremental',
        'guard_training_sim': 'incremental',
        'legacy_incremental': 'incremental',
        'legacy_defensive': 'incremental',
        
        // Moderate risk projects (45-55% base success, 2.5-3.5x ROI potential)
        'premium_flagship': 'moderate',
        'niche_vertical': 'moderate',
        'underserved_market': 'moderate',
        'services_platform': 'moderate',
        'market_explorer': 'moderate',
        'esg_initiative': 'moderate',
        'proprietary_tech': 'moderate',
        'privacy_compliance': 'moderate',
        'evidence_chain': 'moderate',
        'rtls_tracking': 'moderate',
        'vehicle_intelligence': 'moderate',
        'panic_wearable': 'moderate',
        'alarm_response_network': 'moderate',
        'shrink_prevention': 'moderate',
        'security_score': 'moderate',
        'wander_management': 'moderate',
        'contractor_screening': 'moderate',
        'emergency_muster': 'moderate',
        'smart_key_control': 'moderate',
        'night_escort': 'moderate',
        'predictive_door_maintenance': 'moderate',
        'legacy_pet_project': 'moderate',
        'legacy_strategic_troubled': 'moderate',
        'legacy_partnership': 'moderate',
        'legacy_infrastructure': 'moderate'
    };
    
    // Get risk classification for a project archetype
    function getProjectRiskClass(archetype) {
        return projectRiskClassification[archetype] || 'moderate';
    }
    
    // ROI multipliers by risk class (applied to successful projects)
    const riskClassROI = {
        'incremental': { min: 1.3, max: 2.0 },      // Safe but capped upside
        'moderate': { min: 2.0, max: 3.5 },         // Balanced risk/reward
        'transformational': { min: 3.5, max: 6.0 }  // High risk, high reward
    };
    
    // Base success probabilities by risk class
    const riskClassSuccessProb = {
        'incremental': { min: 0.60, max: 0.75 },
        'moderate': { min: 0.45, max: 0.55 },
        'transformational': { min: 0.28, max: 0.42 }
    };
    
    // Technology Readiness Level definitions
    const trlDefinitions = {
        1: { level: 1, name: 'Basic Research', desc: 'Basic principles observed, scientific research begins' },
        2: { level: 2, name: 'Concept Formulated', desc: 'Technology concept and application formulated' },
        3: { level: 3, name: 'Proof of Concept', desc: 'Analytical and experimental proof of concept' },
        4: { level: 4, name: 'Lab Validation', desc: 'Technology validated in laboratory environment' },
        5: { level: 5, name: 'Relevant Environment', desc: 'Technology validated in relevant environment' },
        6: { level: 6, name: 'Prototype Demo', desc: 'Prototype demonstrated in relevant environment' },
        7: { level: 7, name: 'Operational Demo', desc: 'System prototype demonstrated in operational environment' },
        8: { level: 8, name: 'System Complete', desc: 'Actual system completed and qualified through testing' },
        9: { level: 9, name: 'Production Ready', desc: 'Actual system proven in operational environment' }
    };
    
    function getTRL(archetype) {
        const trlMapping = {
            // Original archetypes
            'conventional_winner': { current: 6, target: 9, note: 'Core technology proven in lab and field tests. Engineering focus is productionisation and scale-up—well-understood process.' },
            'conventional_loser': { current: 2, target: 6, note: 'Fundamental research stage with promising early results. Stage-gated approach de-risks investment through validated learning milestones.' },
            'hidden_gem': { current: 5, target: 8, note: 'Technology validated in related applications. Adaptation for new use case is straightforward engineering with manageable technical risk.' },
            'slow_burner': { current: 5, target: 9, note: 'Platform architecture proven. Focus is ecosystem development and integration breadth—execution rather than technical uncertainty.' },
            'paper_tiger': { current: 4, target: 9, note: 'Lab demonstrations successful. Scaling to production requires engineering discipline but follows established patterns. Technical stretch builds capability.' },
            'money_pit': { current: 3, target: 7, note: 'Architecture defined with clear technical path. Implementation complexity is known and budgeted. Modern tooling reduces migration risk.' },
            'pivot_success': { current: 5, target: 8, note: 'Base technology ready for multiple market directions. Flexibility to adapt reduces technical commitment until market validated.' },
            'team_dependent': { current: 4, target: 8, note: 'Concept proven with team expertise. Technical path depends on direction chosen—team capability provides confidence in delivery.' },
            'competitive_casualty': { current: 7, target: 9, note: 'Technology mature and production-ready. Challenge is cost optimisation, not technical capability—operations focus.' },
            'sustainability_play': { current: 5, target: 8, note: 'Product technology proven. Sustainable supply chain and manufacturing processes are the development focus—known but new to ShieldTech.' },
            'ip_fortress': { current: 4, target: 8, note: 'Novel technology in active development with encouraging results. Patent protection being established as technical milestones achieved.' },
            
            // Core product archetypes
            'core_upgrade': { current: 6, target: 9, note: 'Incremental improvement on proven platform. Low technical risk with well-understood engineering path.' },
            'value_segment': { current: 7, target: 9, note: 'Cost-reduced version of existing technology. Focus is supply chain and manufacturing optimisation.' },
            'premium_flagship': { current: 5, target: 9, note: 'Advanced features require integration of multiple technologies. Complex but achievable engineering challenge.' },
            'niche_vertical': { current: 5, target: 8, note: 'Adaptation of core technology for specific use case. Domain expertise more critical than technical innovation.' },
            'underserved_market': { current: 6, target: 9, note: 'Ruggedisation and simplification of proven tech. Engineering focus on reliability in challenging conditions.' },
            'platform_infrastructure': { current: 4, target: 8, note: 'Software platform development with known architecture patterns. Integration complexity is the main challenge.' },
            'market_explorer': { current: 5, target: 8, note: 'Technology proven; market fit uncertain. Rapid iteration capability more important than deep R&D.' },
            'price_fighter': { current: 7, target: 9, note: 'Aggressive cost engineering on mature technology. Manufacturing and sourcing innovation required.' },
            'esg_initiative': { current: 5, target: 8, note: 'Sustainability technology with proven alternatives. Supply chain transformation is key challenge.' },
            'proprietary_tech': { current: 4, target: 8, note: 'Novel technology development with strong IP potential. Technical risk balanced by competitive moat creation.' },
            'frontier_tech': { current: 2, target: 6, note: 'Early-stage research with breakthrough potential. High technical uncertainty but transformative upside.' },
            
            // AI and advanced tech archetypes
            'ai_guard_innovation': { current: 4, target: 8, note: 'On-device AI requires edge optimisation. Model compression and real-time inference are key challenges.' },
            'services_platform': { current: 5, target: 9, note: 'Cloud platform with proven architecture. Scale and reliability engineering are primary focus.' },
            'autonomous_drone': { current: 3, target: 7, note: 'Autonomous systems require extensive testing. Regulatory compliance adds to development timeline.' },
            'ground_robot': { current: 2, target: 6, note: 'Mobile robotics in unstructured environments. Navigation and reliability require significant R&D.' },
            'privacy_compliance': { current: 4, target: 8, note: 'Privacy-preserving computation techniques. Cryptographic methods add performance challenges.' },
            'evidence_chain': { current: 5, target: 9, note: 'Blockchain and cryptographic signing. Well-understood technology, integration is key.' },
            'smart_access': { current: 5, target: 9, note: 'Risk-based authentication with proven components. ML model training on access patterns required.' },
            'rtls_tracking': { current: 5, target: 8, note: 'UWB positioning technology maturing rapidly. Integration with security systems is straightforward.' },
            'acoustic_detection': { current: 3, target: 7, note: 'Audio ML models require extensive training data. False positive management is critical.' },
            'digital_twin': { current: 3, target: 7, note: 'Simulation technology with heavy data requirements. Model fidelity requires iterative refinement.' },
            'perimeter_fusion': { current: 4, target: 8, note: 'Multi-sensor fusion algorithms proven in defence. Adaptation for commercial use manageable.' },
            'cyber_physical_soc': { current: 4, target: 8, note: 'Integration of IT and OT security. Architecture complexity is main challenge.' },
            'camera_health': { current: 6, target: 9, note: 'Predictive analytics on camera telemetry. Well-understood ML application.' },
            'panic_wearable': { current: 6, target: 9, note: 'Wearable technology with proven components. Miniaturisation and battery life optimisation needed.' },
            'vehicle_intelligence': { current: 4, target: 8, note: 'Computer vision for vehicle analysis. Training data collection is key milestone.' },
            'compliance_automation': { current: 6, target: 9, note: 'Report automation with standard integrations. Template library development is main effort.' },
            'deepfake_defense': { current: 3, target: 7, note: 'Rapidly evolving adversarial landscape. Continuous model updates required.' },
            'edge_micro_nvr': { current: 6, target: 9, note: 'Edge computing with proven hardware. Software optimisation for resource constraints.' },
            'rapid_deploy_kit': { current: 7, target: 9, note: 'Packaging of existing technology. Industrial design and logistics focus.' },
            'predictive_risk': { current: 3, target: 7, note: 'ML models require extensive historical data. Model validation is critical milestone.' },
            'visitor_flow': { current: 5, target: 9, note: 'People counting with mature CV technology. Integration with access systems needed.' },
            'security_score': { current: 4, target: 8, note: 'Risk scoring algorithms require calibration. Data collection for model training.' },
            'smart_key_control': { current: 6, target: 9, note: 'Key management with proven technology. Hardware-software integration focus.' },
            'emergency_muster': { current: 5, target: 9, note: 'Location tracking with standard protocols. Integration with HR systems required.' },
            'night_escort': { current: 6, target: 9, note: 'Mobile app with proven location services. Service design more critical than technology.' },
            'guard_training_sim': { current: 4, target: 8, note: 'Simulation technology with VR/AR elements. Content development is major effort.' },
            'incident_invoice': { current: 6, target: 9, note: 'Billing automation with standard integrations. Workflow customisation for each client.' },
            'parking_security': { current: 5, target: 9, note: 'LPR technology mature. Integration with parking systems is key challenge.' },
            'shrink_prevention': { current: 5, target: 8, note: 'Retail analytics with CV and POS integration. Model training on loss patterns.' },
            'alarm_response_network': { current: 5, target: 9, note: 'Dispatch platform with proven architecture. Partner integration is main effort.' },
            'camera_subscription': { current: 6, target: 9, note: 'Cloud video with proven infrastructure. Provisioning automation focus.' },
            'privacy_analytics': { current: 4, target: 8, note: 'Privacy-preserving analytics. Edge processing to avoid data transmission.' },
            'guard_tour_proof': { current: 6, target: 9, note: 'NFC/GPS tracking with proven technology. Mobile app and reporting focus.' },
            'smart_intercom': { current: 6, target: 9, note: 'Video intercom with proven components. Cloud integration and mobile app.' },
            'wander_management': { current: 5, target: 8, note: 'Location tracking for healthcare. Regulatory compliance (HIPAA-like) required.' },
            'contractor_screening': { current: 5, target: 9, note: 'Background check integration. API connections to verification databases.' },
            'ai_video_search': { current: 4, target: 8, note: 'Natural language video search. Large-scale indexing infrastructure required.' },
            'safety_security_soc': { current: 4, target: 8, note: 'EHS and security integration. Multi-system correlation engine development.' },
            'anti_drone_service': { current: 3, target: 7, note: 'Counter-drone technology evolving rapidly. Regulatory framework still developing.' },
            'predictive_door_maintenance': { current: 5, target: 9, note: 'IoT sensors with predictive ML. Failure mode data collection needed.' },
            
            // Legacy archetypes
            'legacy_incremental': { current: 7, target: 9, note: 'Enhancement of production system. Well-understood development path.' },
            'legacy_pet_project': { current: 3, target: 7, note: 'Technically uncertain project with sponsor protection. Real TRL may be lower than claimed.' },
            'legacy_strategic_troubled': { current: 4, target: 8, note: 'Strategic technology facing execution challenges. Recovery plan needed.' },
            'legacy_partnership': { current: 5, target: 8, note: 'Partner-dependent technology. Integration complexity is main risk.' },
            'legacy_defensive': { current: 6, target: 9, note: 'Competitive response with proven technology. Speed to market is critical.' },
            'legacy_infrastructure': { current: 3, target: 7, note: 'Internal systems modernisation. Migration complexity is significant.' }
        };
        return trlMapping[archetype] || { current: 5, target: 8, note: 'Standard development path with manageable technical risk.' };
    }
    
    function getIPPosition(archetype, projectName) {
        const ipPositions = {
            'conventional_winner': {
                shieldtech: 'ShieldTech holds 3 design patents on housing aesthetics and 2 utility patents on ShieldOS integration protocols. Trade secrets protect manufacturing processes. Solid defensive position.',
                competitors: 'Yale holds foundational smart lock patents (US8593249, expiring 2026). Godrej has Indian design registrations. Xiaomi relies on Chinese utility models not enforceable in India. Landscape is navigable.',
                fto: 'Freedom to operate is CLEAR. No blocking patents identified. Design-around for Yale\'s motorised deadbolt mechanism documented as precaution.',
                risk: 'Low'
            },
            'conventional_loser': {
                shieldtech: 'Research partnership with IISc includes joint IP provisions—ShieldTech gets exclusive commercial license for security applications. Early filing opportunity as field develops.',
                competitors: 'Field is pre-competitive with mostly academic publications. IBM and Google hold broad patents that may become relevant but licensing is standard. First-mover advantage possible.',
                fto: 'Freedom to operate assessment ongoing as technology develops. Early-stage means opportunity to design around any issues identified. IP counsel monitoring landscape.',
                risk: 'Medium'
            },
            'hidden_gem': {
                shieldtech: 'Limited existing IP in this segment—opportunity to establish position. Design patents on form factor and utility patents on detection algorithms filed with this project.',
                competitors: 'Philips holds elder care monitoring patents focused on clinical settings, not home use. Indian market has few registered IP rights in niche. First-mover advantage achievable.',
                fto: 'Freedom to operate is LIKELY CLEAR. FTO search completed for core functionality. Philips patents don\'t cover home monitoring use case.',
                risk: 'Low'
            },
            'slow_burner': {
                shieldtech: 'ShieldTech holds API design copyrights and ShieldOS trademark. Platform architecture documented as trade secret. Opportunity to patent integration innovations.',
                competitors: 'Matter protocol is royalty-free standard. Amazon and Google license smart home patents freely within their ecosystems. Standard licensing terms apply.',
                fto: 'Freedom to operate is CLEAR for Matter-compliant implementations. Proprietary integrations designed to avoid known patent clusters.',
                risk: 'Low'
            },
            'paper_tiger': {
                shieldtech: 'Opportunity to patent sensor fusion algorithms and thermal-visual combination methods. Engineering team documenting innovations for IP review.',
                competitors: 'Hikvision holds CCTV patents globally. Ambarella patents on edge AI chips available through standard licensing. Licensing costs budgeted in BOM.',
                fto: 'Freedom to operate REQUIRES LICENSING. Ambarella chip licensing standard and budgeted. Custom algorithms designed to create new protectable IP.',
                risk: 'Medium'
            },
            'money_pit': {
                shieldtech: 'All platform code is proprietary work product. Architecture documents protected as trade secrets. New platform will generate additional trade secrets.',
                competitors: 'No direct IP conflict—internal infrastructure. Cloud architecture uses standard AWS/Azure services under normal licensing terms.',
                fto: 'Freedom to operate is CLEAR. Internal platform choices with standard cloud provider terms. No external IP dependencies.',
                risk: 'Low'
            },
            'pivot_success': {
                shieldtech: 'Messaging encryption uses open-source Signal protocol (MIT license). Opportunity to patent novel workflow and coordination features.',
                competitors: 'WhatsApp/Signal encryption freely licensed. Community platform IP fragmented across small players—limited blocking risk.',
                fto: 'Freedom to operate is CLEAR with open protocols. Novel features being documented for potential patent filing.',
                risk: 'Low'
            },
            'team_dependent': {
                shieldtech: 'IP position depends on innovation direction. Clear invention assignment agreements in place. Team briefed on documentation requirements.',
                competitors: 'Landscape assessment will be conducted once direction chosen. Team includes IP-aware engineers who will flag freedom-to-operate considerations.',
                fto: 'Freedom to operate to be assessed as technical direction emerges. Standard process integrated into milestone reviews.',
                risk: 'Low'
            },
            'competitive_casualty': {
                shieldtech: 'Budget products use commodity components with minimal proprietary elements. Focus on trade secrets in cost engineering and supply chain.',
                competitors: 'Chinese manufacturers hold design registrations in China with limited international protection. No blocking patents in commodity segment.',
                fto: 'Freedom to operate is CLEAR. Commodity technology with no blocking patents. Design differentiation documented.',
                risk: 'Low'
            },
            'sustainability_play': {
                shieldtech: 'Opportunity to patent sustainable manufacturing processes and material compositions. First-mover advantage in green security IP.',
                competitors: 'Limited IP in sustainable security products. Broader green tech patents are material-supplier owned—licensing included in supply agreements.',
                fto: 'Freedom to operate is CLEAR. Emerging field with limited patent density. Material supplier agreements include necessary IP rights.',
                risk: 'Low'
            },
            'ip_fortress': {
                shieldtech: '12 patents pending covering sensor fusion, detection algorithms, and signal processing. 3 trade secrets in calibration methods. Building strong defensive position.',
                competitors: 'Bosch holds MEMS sensor patents. Texas Instruments has signal processing IP. Design choices made to work within or around existing patents.',
                fto: 'Freedom to operate LARGELY CLEAR. Core novel algorithms clear. MEMS implementation uses licensed Bosch technology per standard terms.',
                risk: 'Low-Medium'
            },
            
            // Core product archetypes
            'core_upgrade': {
                shieldtech: 'Builds on existing ShieldTech IP portfolio. Incremental innovations documented for potential filing.',
                competitors: 'Established players hold relevant patents but licensing paths clear. No blocking IP identified.',
                fto: 'Freedom to operate CLEAR. Extension of existing licensed technologies.',
                risk: 'Low'
            },
            'value_segment': {
                shieldtech: 'Focus on manufacturing trade secrets rather than patents. Cost engineering methods protected.',
                competitors: 'Generic Chinese imports have limited IP protection. No blocking patents for commodity features.',
                fto: 'Freedom to operate CLEAR. Commodity technology segment with minimal IP barriers.',
                risk: 'Low'
            },
            'premium_flagship': {
                shieldtech: 'Multiple patent opportunities in advanced features. Design patents on premium aesthetics.',
                competitors: 'Premium competitors have strong IP but focused on enterprise. Consumer premium segment less protected.',
                fto: 'Freedom to operate REQUIRES REVIEW. Premium features may touch competitor patents—design-arounds documented.',
                risk: 'Medium'
            },
            'niche_vertical': {
                shieldtech: 'Limited existing IP in niche. Opportunity to establish defensive position early.',
                competitors: 'Niche segments typically have fragmented IP landscape. No dominant patent holders identified.',
                fto: 'Freedom to operate LIKELY CLEAR. Niche application reduces patent density.',
                risk: 'Low'
            },
            'underserved_market': {
                shieldtech: 'Ruggedisation methods documented as trade secrets. Limited patentable innovations.',
                competitors: 'Industrial players hold rugged design patents but different application domain.',
                fto: 'Freedom to operate CLEAR. Consumer ruggedisation distinct from industrial IP.',
                risk: 'Low'
            },
            'platform_infrastructure': {
                shieldtech: 'APIs and architecture protected as trade secrets. Copyright on code base.',
                competitors: 'Platform patents held by major tech companies but licensing terms standard.',
                fto: 'Freedom to operate CLEAR with standard licenses. Architecture choices avoid known patents.',
                risk: 'Low'
            },
            'market_explorer': {
                shieldtech: 'IP strategy TBD pending market validation. Documentation practices in place.',
                competitors: 'Emerging market with limited patent density. First-mover IP advantage possible.',
                fto: 'Freedom to operate assessment ongoing. Early stage reduces IP risk.',
                risk: 'Low'
            },
            'price_fighter': {
                shieldtech: 'Cost engineering trade secrets. No patentable innovations expected.',
                competitors: 'Low-cost segment has minimal IP protection. Commodity technology.',
                fto: 'Freedom to operate CLEAR. Commodity segment with no blocking patents.',
                risk: 'Low'
            },
            'esg_initiative': {
                shieldtech: 'Sustainable process innovations may be patentable. Supply chain trade secrets.',
                competitors: 'Green technology IP held by material suppliers—licensing included.',
                fto: 'Freedom to operate CLEAR. Material suppliers provide necessary IP rights.',
                risk: 'Low'
            },
            'proprietary_tech': {
                shieldtech: 'Strong patent filing strategy. 5+ patent applications planned.',
                competitors: 'Novel technology area with limited prior art. Defensive moat building.',
                fto: 'Freedom to operate being established. Novel approach minimizes conflict.',
                risk: 'Low-Medium'
            },
            'frontier_tech': {
                shieldtech: 'Research IP strategy with academic partners. Joint filing provisions in place.',
                competitors: 'Pre-competitive research with mostly academic IP. Licensing paths available.',
                fto: 'Freedom to operate evolving. Early stage allows design flexibility.',
                risk: 'Medium'
            },
            
            // AI and advanced tech archetypes
            'ai_guard_innovation': {
                shieldtech: 'AI model architecture as trade secret. Edge deployment methods documented for filing.',
                competitors: 'Computer vision patents dense but specific implementations clear. Standard ML techniques freely available.',
                fto: 'Freedom to operate LARGELY CLEAR. Custom models avoid competitor IP.',
                risk: 'Low-Medium'
            },
            'services_platform': {
                shieldtech: 'Platform code protected by copyright. Service delivery methods as trade secrets.',
                competitors: 'Monitoring service IP fragmented. No blocking patents for cloud delivery model.',
                fto: 'Freedom to operate CLEAR. Service innovation rather than technology IP.',
                risk: 'Low'
            },
            'autonomous_drone': {
                shieldtech: 'Flight control customisations documented. Regulatory compliance methods unique.',
                competitors: 'DJI holds extensive drone patents. Design choices made for India-specific compliance.',
                fto: 'Freedom to operate REQUIRES LICENSING. DJI patents navigable with standard terms.',
                risk: 'Medium'
            },
            'ground_robot': {
                shieldtech: 'Navigation algorithms in development. Trade secrets on Indian environment adaptation.',
                competitors: 'Mobile robotics patents held by Boston Dynamics, Knightscope. Licensing paths exist.',
                fto: 'Freedom to operate REQUIRES REVIEW. Novel navigation approach being validated.',
                risk: 'Medium-High'
            },
            'privacy_compliance': {
                shieldtech: 'Privacy-preserving algorithms potentially patentable. Implementation as trade secret.',
                competitors: 'Privacy tech IP emerging. Apple, Google hold broad patents but licensing available.',
                fto: 'Freedom to operate LARGELY CLEAR. Compliance implementation distinct from platform IP.',
                risk: 'Low-Medium'
            },
            'evidence_chain': {
                shieldtech: 'Blockchain implementation uses open protocols. Evidence packaging innovations protectable.',
                competitors: 'Axon holds body camera evidence IP. Enterprise security evidence chains less protected.',
                fto: 'Freedom to operate CLEAR. Open blockchain protocols and standard cryptography.',
                risk: 'Low'
            },
            'smart_access': {
                shieldtech: 'Risk scoring algorithms as trade secrets. Integration methods documented.',
                competitors: 'Access control IP held by HID, Suprema. Standard integration approaches clear.',
                fto: 'Freedom to operate LARGELY CLEAR. Novel risk approach avoids existing IP.',
                risk: 'Low'
            },
            'rtls_tracking': {
                shieldtech: 'UWB implementation uses standard protocols. Fusion with security systems novel.',
                competitors: 'UWB patents held by Apple, Zebra. Licensing costs factored into BOM.',
                fto: 'Freedom to operate with LICENSE. Standard UWB licensing terms.',
                risk: 'Low-Medium'
            },
            'acoustic_detection': {
                shieldtech: 'Audio ML models as trade secrets. Detection algorithms potentially patentable.',
                competitors: 'Gunshot detection patents held by ShotSpotter. Different approach minimizes conflict.',
                fto: 'Freedom to operate LARGELY CLEAR. Novel acoustic approach documented.',
                risk: 'Low-Medium'
            },
            'digital_twin': {
                shieldtech: 'Simulation models as trade secrets. Facility-specific optimizations proprietary.',
                competitors: 'Digital twin IP held by Siemens, GE in industrial context. Security application distinct.',
                fto: 'Freedom to operate CLEAR for security application. Industrial patents not relevant.',
                risk: 'Low'
            },
            'perimeter_fusion': {
                shieldtech: 'Sensor fusion algorithms potentially patentable. Integration architecture as trade secret.',
                competitors: 'Defence contractors hold perimeter IP but different application domain.',
                fto: 'Freedom to operate LARGELY CLEAR. Commercial adaptation distinct from defence IP.',
                risk: 'Low-Medium'
            },
            'cyber_physical_soc': {
                shieldtech: 'Correlation engine as trade secret. Integration methods documented.',
                competitors: 'SIEM vendors hold IT security IP. Physical security integration less protected.',
                fto: 'Freedom to operate CLEAR. Novel IT-OT convergence approach.',
                risk: 'Low'
            },
            'camera_health': {
                shieldtech: 'Predictive models as trade secrets. Diagnostic methods potentially patentable.',
                competitors: 'Camera vendors have limited predictive maintenance IP. Field is open.',
                fto: 'Freedom to operate CLEAR. Novel predictive approach in security domain.',
                risk: 'Low'
            },
            'panic_wearable': {
                shieldtech: 'Wearable design potentially protectable. Fall detection algorithms as trade secrets.',
                competitors: 'Medical alert IP held by Philips Lifeline. Consumer safety distinct.',
                fto: 'Freedom to operate LARGELY CLEAR. Consumer focus avoids medical device IP.',
                risk: 'Low'
            },
            'vehicle_intelligence': {
                shieldtech: 'Intent scoring algorithms as trade secrets. Vehicle pattern analysis protectable.',
                competitors: 'LPR patents dense but commodity. Advanced analytics less protected.',
                fto: 'Freedom to operate CLEAR. Novel behavioral analysis distinct from basic LPR.',
                risk: 'Low'
            },
            'compliance_automation': {
                shieldtech: 'Report templates as trade secrets. Workflow automation proprietary.',
                competitors: 'GRC vendors have broad patents but different domain. Security compliance distinct.',
                fto: 'Freedom to operate CLEAR. Security-specific compliance tooling.',
                risk: 'Low'
            },
            'deepfake_defense': {
                shieldtech: 'Detection models as trade secrets. Liveness methods potentially patentable.',
                competitors: 'Biometric vendors hold liveness IP. Licensing paths available.',
                fto: 'Freedom to operate REQUIRES LICENSING. Liveness component licensing standard.',
                risk: 'Medium'
            },
            'edge_micro_nvr': {
                shieldtech: 'Firmware as trade secret. Sync protocol potentially protectable.',
                competitors: 'NVR patents held by Hikvision, Verkada. Edge approach provides differentiation.',
                fto: 'Freedom to operate LARGELY CLEAR. Edge-first architecture distinct.',
                risk: 'Low'
            },
            'rapid_deploy_kit': {
                shieldtech: 'Packaging design protectable. Quick-deploy methods as trade secrets.',
                competitors: 'Temporary security IP fragmented. No blocking patents identified.',
                fto: 'Freedom to operate CLEAR. Novel packaging and deployment approach.',
                risk: 'Low'
            },
            'predictive_risk': {
                shieldtech: 'Risk prediction models as trade secrets. Scoring methodology proprietary.',
                competitors: 'Insurance and security risk IP fragmented. Novel approach has freedom.',
                fto: 'Freedom to operate CLEAR. Unique risk scoring methodology.',
                risk: 'Low'
            },
            'visitor_flow': {
                shieldtech: 'People counting algorithms widely available. Integration approach proprietary.',
                competitors: 'Retail analytics IP dense but different application. Security use distinct.',
                fto: 'Freedom to operate CLEAR. Security integration distinct from retail analytics.',
                risk: 'Low'
            },
            'security_score': {
                shieldtech: 'Scoring algorithms as trade secrets. Methodology proprietary to ShieldTech.',
                competitors: 'No direct competitor IP. Novel category with freedom to establish.',
                fto: 'Freedom to operate CLEAR. First-mover in security scoring.',
                risk: 'Low'
            },
            'smart_key_control': {
                shieldtech: 'Key management methods as trade secrets. Hardware design protectable.',
                competitors: 'Key cabinet IP held by KeyTrak, others. Electronic key control distinct.',
                fto: 'Freedom to operate LARGELY CLEAR. Smart approach avoids mechanical IP.',
                risk: 'Low'
            },
            'emergency_muster': {
                shieldtech: 'Muster algorithms as trade secrets. Integration with access systems proprietary.',
                competitors: 'EHS vendors have broad IP but muster-specific coverage limited.',
                fto: 'Freedom to operate CLEAR. Security-first muster approach distinct.',
                risk: 'Low'
            },
            'night_escort': {
                shieldtech: 'Service design as trade secret. App features standard.',
                competitors: 'Safety app IP fragmented. Service innovation rather than technology.',
                fto: 'Freedom to operate CLEAR. Service model distinct from technology IP.',
                risk: 'Low'
            },
            'guard_training_sim': {
                shieldtech: 'Training content as trade secret. Simulation methods potentially protectable.',
                competitors: 'Training simulation IP in defence sector. Commercial security training open.',
                fto: 'Freedom to operate CLEAR. Commercial training distinct from defence IP.',
                risk: 'Low'
            },
            'incident_invoice': {
                shieldtech: 'Billing automation as trade secret. Integration methods proprietary.',
                competitors: 'Billing software IP not relevant. Security-specific integration novel.',
                fto: 'Freedom to operate CLEAR. Novel security billing automation.',
                risk: 'Low'
            },
            'parking_security': {
                shieldtech: 'Integration approach proprietary. Analytics methods as trade secrets.',
                competitors: 'Parking IP held by specialized vendors. Security overlay distinct.',
                fto: 'Freedom to operate CLEAR. Security integration distinct from parking IP.',
                risk: 'Low'
            },
            'shrink_prevention': {
                shieldtech: 'Loss detection algorithms as trade secrets. POS integration proprietary.',
                competitors: 'Retail LP IP held by Checkpoint, Sensormatic. Analytics approach distinct.',
                fto: 'Freedom to operate LARGELY CLEAR. Analytics-first approach avoids hardware IP.',
                risk: 'Low'
            },
            'alarm_response_network': {
                shieldtech: 'Dispatch algorithms as trade secrets. Partner network proprietary.',
                competitors: 'Monitoring centre IP fragmented. Network model novel.',
                fto: 'Freedom to operate CLEAR. Novel response network approach.',
                risk: 'Low'
            },
            'camera_subscription': {
                shieldtech: 'Subscription management as trade secret. Cloud architecture standard.',
                competitors: 'VSaaS IP held by Eagle Eye, Verkada. Provisioning approach distinct.',
                fto: 'Freedom to operate CLEAR. Subscription model distinct from technology IP.',
                risk: 'Low'
            },
            'privacy_analytics': {
                shieldtech: 'Edge processing methods as trade secrets. Privacy approach potentially patentable.',
                competitors: 'Privacy analytics emerging field. Limited blocking IP.',
                fto: 'Freedom to operate LARGELY CLEAR. Novel privacy-first approach.',
                risk: 'Low'
            },
            'guard_tour_proof': {
                shieldtech: 'Proof methods as trade secrets. Verification algorithms proprietary.',
                competitors: 'Guard tour IP held by STANLEY, Trackforce. Proof-centric approach distinct.',
                fto: 'Freedom to operate CLEAR. Novel verification methodology.',
                risk: 'Low'
            },
            'smart_intercom': {
                shieldtech: 'Cloud integration as trade secret. Video calling uses standard protocols.',
                competitors: 'Intercom IP held by Aiphone, 2N. Cloud approach provides differentiation.',
                fto: 'Freedom to operate LARGELY CLEAR. Cloud-first approach distinct.',
                risk: 'Low'
            },
            'wander_management': {
                shieldtech: 'Tracking algorithms as trade secrets. Healthcare integration proprietary.',
                competitors: 'Healthcare tracking IP in different regulatory context. Consumer version distinct.',
                fto: 'Freedom to operate CLEAR. Consumer healthcare distinct from clinical IP.',
                risk: 'Low'
            },
            'contractor_screening': {
                shieldtech: 'Verification workflow as trade secret. Integration methods proprietary.',
                competitors: 'Background check IP held by service providers. Integration approach distinct.',
                fto: 'Freedom to operate CLEAR. Orchestration distinct from verification IP.',
                risk: 'Low'
            },
            'ai_video_search': {
                shieldtech: 'Search algorithms potentially patentable. Index methods as trade secrets.',
                competitors: 'Video search IP held by Google, Amazon. Security context provides distinction.',
                fto: 'Freedom to operate LARGELY CLEAR. Security-specific search implementation.',
                risk: 'Low-Medium'
            },
            'safety_security_soc': {
                shieldtech: 'Correlation algorithms as trade secrets. Integration architecture proprietary.',
                competitors: 'EHS and security SOC IP fragmented. Convergence approach novel.',
                fto: 'Freedom to operate CLEAR. Novel safety-security convergence.',
                risk: 'Low'
            },
            'anti_drone_service': {
                shieldtech: 'Detection methods as trade secrets. Response protocols proprietary.',
                competitors: 'Counter-drone IP held by defence contractors. Commercial service distinct.',
                fto: 'Freedom to operate LARGELY CLEAR. Service model distinct from equipment IP.',
                risk: 'Low-Medium'
            },
            'predictive_door_maintenance': {
                shieldtech: 'Prediction models as trade secrets. Sensor fusion proprietary.',
                competitors: 'Predictive maintenance IP in industrial context. Door-specific application distinct.',
                fto: 'Freedom to operate CLEAR. Door-specific application novel.',
                risk: 'Low'
            },
            
            // Legacy archetypes
            'legacy_incremental': {
                shieldtech: 'Builds on existing IP portfolio. Incremental improvements documented.',
                competitors: 'Established landscape. No new IP concerns.',
                fto: 'Freedom to operate CLEAR. Extension of existing position.',
                risk: 'Low'
            },
            'legacy_pet_project': {
                shieldtech: 'IP position unclear. Documentation practices inconsistent.',
                competitors: 'Unknown IP landscape. Assessment needed.',
                fto: 'Freedom to operate UNCERTAIN. IP review recommended.',
                risk: 'Medium'
            },
            'legacy_strategic_troubled': {
                shieldtech: 'Original IP strategy may need revision. Documentation review underway.',
                competitors: 'Competitive IP landscape may have shifted. Reassessment needed.',
                fto: 'Freedom to operate REQUIRES REVIEW. Strategy pivot may affect IP.',
                risk: 'Medium'
            },
            'legacy_partnership': {
                shieldtech: 'Joint IP provisions in partnership agreement. ShieldTech retains implementation rights.',
                competitors: 'Partner provides IP coverage for joint technology.',
                fto: 'Freedom to operate CLEAR per partnership terms.',
                risk: 'Low'
            },
            'legacy_defensive': {
                shieldtech: 'Competitive response uses established technology. Limited new IP.',
                competitors: 'Responding to competitor move. Established IP landscape.',
                fto: 'Freedom to operate CLEAR. Defensive position well-understood.',
                risk: 'Low'
            },
            'legacy_infrastructure': {
                shieldtech: 'Internal systems with no external IP exposure.',
                competitors: 'Not applicable for internal infrastructure.',
                fto: 'Freedom to operate CLEAR. Internal use only.',
                risk: 'Low'
            }
        };
        return ipPositions[archetype] || { shieldtech: 'IP assessment in progress.', competitors: 'Competitor IP analysis underway.', fto: 'FTO review scheduled.', risk: 'Low' };
    }
    
    function getCompetitors(archetype) {
        const competitors = {
            'conventional_winner': [
                { name: 'Yale (ASSA ABLOY)', position: 'Global leader with strong brand. Premium pricing creates space for value positioning. Weak in India-specific features—opportunity for differentiation.', threat: 'Medium' },
                { name: 'Godrej Locks', position: 'Trusted Indian brand with strong distribution. Slower on smart features—ShieldTech can lead on innovation and user experience.', threat: 'Medium' },
                { name: 'Xiaomi Mi Home', position: 'Aggressive pricing but limited local support and service. ShieldTech\'s service network is competitive advantage.', threat: 'Medium' },
                { name: 'CP Plus', position: 'CCTV leader moving into smart home. Strong installer network but less refined apps and ecosystem.', threat: 'Low' }
            ],
            'conventional_loser': [
                { name: 'IBM Research', position: 'Leading research but not focused on consumer security applications. Potential future partner rather than competitor.', threat: 'Low' },
                { name: 'Academic Labs', position: 'Potential partners or collaborators. Technology transfer is slow—commercial execution is ShieldTech advantage.', threat: 'Low' },
                { name: 'Defence contractors', position: 'May commercialise military tech but different market focus and price points. Unlikely to compete in consumer segment.', threat: 'Low' }
            ],
            'hidden_gem': [
                { name: 'Philips Lifeline', position: 'Global leader in medical alert but premium pricing and clinical focus. Not present in India—clear runway for market entry.', threat: 'Low' },
                { name: 'Local startups', position: 'Small players in adjacent health monitoring. Fragmented market—consolidation opportunity for ShieldTech.', threat: 'Low' },
                { name: 'Telecom bundles', position: 'Jio/Airtel exploring IoT but unfocused approach. Potential partners for distribution rather than direct competitors.', threat: 'Low' }
            ],
            'slow_burner': [
                { name: 'Amazon Alexa/Echo', position: 'Dominant smart home hub but Amazon-centric. ShieldTech can be the security-first neutral platform alternative.', threat: 'Medium' },
                { name: 'Google Home', position: 'Strong AI but less retail presence in India. Google\'s privacy concerns create opening for privacy-focused alternative.', threat: 'Medium' },
                { name: 'Samsung SmartThings', position: 'Broad compatibility but fragmented experience. ShieldTech can win on integration quality and local support.', threat: 'Low' },
                { name: 'Apple HomeKit', position: 'Premium segment only with strict requirements. Limited India focus creates opportunity for mass market platform.', threat: 'Low' }
            ],
            'paper_tiger': [
                { name: 'Hikvision', position: 'Global CCTV leader but facing government scrutiny in Western markets. ShieldTech can position as trusted alternative.', threat: 'Medium' },
                { name: 'Dahua', position: 'Strong on price but similar scrutiny issues. Premium buyers seeking alternatives—opportunity for brand positioning.', threat: 'Medium' },
                { name: 'Axis Communications', position: 'Premium enterprise positioning. Limited consumer presence creates gap ShieldTech can fill.', threat: 'Low' },
                { name: 'Bosch Security', position: 'Quality reputation but enterprise focus and premium pricing. Consumer segment is underserved.', threat: 'Low' }
            ],
            'money_pit': [
                { name: 'Internal legacy', position: 'The real challenge is organisational change management. Technical migration is well-understood; culture change is the focus.', threat: 'Medium' },
                { name: 'Cloud platforms', position: 'AWS/Azure offer managed services but ShieldTech\'s domain expertise and integration depth are differentiators.', threat: 'Low' }
            ],
            'pivot_success': [
                { name: 'MyGate', position: 'Leading gated community app but focused on visitor management. Security integration is add-on, not core—ShieldTech advantage.', threat: 'Medium' },
                { name: 'NoBroker', position: 'Real estate platform adding features but unfocused. Security is afterthought—dedicated solution can win.', threat: 'Low' },
                { name: 'JEEVES (Tata)', position: 'Tata Housing bundled app. Limited to new developments—existing societies are open market.', threat: 'Low' },
                { name: 'Local security agencies', position: 'Existing relationships but limited technology capability. Potential partners for integrated solution.', threat: 'Low' }
            ],
            'team_dependent': [
                { name: 'Well-funded startups', position: 'Competing for talent but ShieldTech offers stability, scale, and impact. Equity + mission can compete.', threat: 'Medium' },
                { name: 'Google/Amazon India', position: 'Deep pockets for talent but corporate bureaucracy. ShieldTech offers autonomy and ownership that big tech can\'t match.', threat: 'Medium' }
            ],
            'competitive_casualty': [
                { name: 'Xiaomi Mi Home', position: 'Ecosystem pricing but thin margins are not sustainable. ShieldTech\'s service and quality can command premium.', threat: 'Medium' },
                { name: 'Generic Chinese imports', position: 'Rock-bottom prices but no brand, warranty, or support. Quality-conscious buyers choose ShieldTech.', threat: 'Medium' },
                { name: 'Realme/OnePlus IoT', position: 'Smartphone brands entering market. Young demographic but limited commitment to security category.', threat: 'Low' }
            ],
            'sustainability_play': [
                { name: 'No direct competitors', position: 'No major player has sustainable security line in India. Clear first-mover opportunity.', threat: 'Low' },
                { name: 'Generic green claims', position: 'Many brands making unsubstantiated claims. Certification and authenticity are ShieldTech differentiators.', threat: 'Low' },
                { name: 'European imports', position: 'Netatmo and others have credentials but premium pricing and limited distribution. ShieldTech can own India market.', threat: 'Low' }
            ],
            'ip_fortress': [
                { name: 'Bosch Security', position: 'Strong sensor patents but potential licensor rather than competitor. Licensing relationship possible.', threat: 'Low' },
                { name: 'Patent aggregators', position: 'NPEs active in IoT but ShieldTech\'s defensive portfolio provides leverage and cross-licensing options.', threat: 'Low' },
                { name: 'Chinese fast-followers', position: 'Will copy if successful but patents create barriers and licensing opportunities. Enforcement improving.', threat: 'Medium' }
            ]
        };
        return competitors[archetype] || [];
    }
    
    function getDevelopmentCosts(budget, archetype) {
        // Break down total budget into cost categories
        const costProfiles = {
            'conventional_winner': { personnel: 0.45, hardware: 0.25, software: 0.10, external: 0.10, contingency: 0.10 },
            'conventional_loser': { personnel: 0.35, hardware: 0.15, software: 0.05, external: 0.25, contingency: 0.20 },
            'hidden_gem': { personnel: 0.50, hardware: 0.20, software: 0.10, external: 0.10, contingency: 0.10 },
            'slow_burner': { personnel: 0.55, hardware: 0.05, software: 0.20, external: 0.10, contingency: 0.10 },
            'paper_tiger': { personnel: 0.40, hardware: 0.30, software: 0.10, external: 0.05, contingency: 0.15 },
            'money_pit': { personnel: 0.50, hardware: 0.05, software: 0.15, external: 0.10, contingency: 0.20 },
            'pivot_success': { personnel: 0.50, hardware: 0.10, software: 0.15, external: 0.10, contingency: 0.15 },
            'team_dependent': { personnel: 0.60, hardware: 0.10, software: 0.10, external: 0.05, contingency: 0.15 },
            'competitive_casualty': { personnel: 0.35, hardware: 0.35, software: 0.10, external: 0.10, contingency: 0.10 },
            'sustainability_play': { personnel: 0.40, hardware: 0.25, software: 0.10, external: 0.15, contingency: 0.10 },
            'ip_fortress': { personnel: 0.40, hardware: 0.20, software: 0.10, external: 0.20, contingency: 0.10 }
        };
        
        const profile = costProfiles[archetype] || costProfiles['conventional_winner'];
        
        return {
            total: budget,
            personnel: { 
                amount: (budget * profile.personnel).toFixed(1), 
                pct: Math.round(profile.personnel * 100),
                detail: 'Engineering salaries, product management, design, QA'
            },
            hardware: { 
                amount: (budget * profile.hardware).toFixed(1), 
                pct: Math.round(profile.hardware * 100),
                detail: 'Prototyping, components, testing equipment, tooling'
            },
            software: { 
                amount: (budget * profile.software).toFixed(1), 
                pct: Math.round(profile.software * 100),
                detail: 'Cloud infrastructure, development tools, licenses'
            },
            external: { 
                amount: (budget * profile.external).toFixed(1), 
                pct: Math.round(profile.external * 100),
                detail: 'Consultants, contractors, legal, certifications'
            },
            contingency: { 
                amount: (budget * profile.contingency).toFixed(1), 
                pct: Math.round(profile.contingency * 100),
                detail: 'Risk buffer for scope changes and unknowns'
            }
        };
    }
    
    function getMilestones(archetype, budget) {
        const milestoneTemplates = {
            'conventional_winner': {
                totalDuration: '12 months',
                milestones: [
                    { 
                        phase: 'M1: Design & Prototype', 
                        quarters: 'Q1-Q2',
                        duration: '6 months', 
                        cost: 0.35,
                        deliverables: ['Industrial design approved', 'Functional prototype', 'BOM finalised', 'User testing complete'],
                        metrics: [
                            { name: 'Prototype sign-off', target: 'Product & Engineering approval' },
                            { name: 'BOM cost', target: '< target for 35% gross margin' },
                            { name: 'User testing NPS', target: '> 40 from 20 beta testers' }
                        ],
                        gate: 'Design Review Board approval'
                    },
                    { 
                        phase: 'M2: Engineering & Certification', 
                        quarters: 'Q3',
                        duration: '3 months', 
                        cost: 0.35,
                        deliverables: ['DVT units (50)', 'BIS certification', 'App integration', 'Manufacturing setup'],
                        metrics: [
                            { name: 'DVT pass rate', target: '> 95% units pass all tests' },
                            { name: 'Certifications', target: 'BIS, WiFi Alliance complete' },
                            { name: 'Production yield', target: '> 98% first-pass' }
                        ],
                        gate: 'Quality & Operations sign-off'
                    },
                    { 
                        phase: 'M3: Launch & Scale', 
                        quarters: 'Q4',
                        duration: '3 months', 
                        cost: 0.30,
                        deliverables: ['Market launch', 'Channel inventory', 'Support operations', 'Marketing campaign'],
                        metrics: [
                            { name: 'Launch inventory', target: '5,000 units in channel' },
                            { name: 'Day-30 sales', target: '> 1,000 units' },
                            { name: 'Return rate', target: '< 3%' }
                        ],
                        gate: 'Commercial success review'
                    }
                ]
            },
            'conventional_loser': {
                totalDuration: '36-48 months',
                milestones: [
                    { 
                        phase: 'M1: Research & Proof of Concept', 
                        quarters: 'Q1-Q6',
                        duration: '18 months', 
                        cost: 0.45,
                        deliverables: ['Research team assembled', 'Lab setup', 'Core technology demonstration', 'Patent applications filed'],
                        metrics: [
                            { name: 'Technical proof', target: 'Demonstrate core principle' },
                            { name: 'IP filings', target: '2+ provisional patents' },
                            { name: 'Publication', target: 'Paper submitted to journal' }
                        ],
                        gate: 'Scientific Advisory Board review'
                    },
                    { 
                        phase: 'M2: Lab Validation', 
                        quarters: 'Q7-Q12',
                        duration: '18 months', 
                        cost: 0.35,
                        deliverables: ['Working lab prototype', 'Performance characterisation', 'Repeatability testing', 'Productisation assessment'],
                        metrics: [
                            { name: 'Performance', target: 'Within 50% of theoretical' },
                            { name: 'Repeatability', target: '> 80% consistent results' },
                            { name: 'Cost path', target: 'Route to viable unit cost' }
                        ],
                        gate: 'Go/No-Go on commercialisation'
                    },
                    { 
                        phase: 'M3: Development Planning', 
                        quarters: 'Q13-Q16',
                        duration: '12 months', 
                        cost: 0.20,
                        deliverables: ['Product roadmap', 'Resource plan', 'Partnership agreements', 'Phase 2 business case'],
                        metrics: [
                            { name: 'Roadmap clarity', target: '24-month plan defined' },
                            { name: 'Resource commitment', target: 'Team & budget approved' },
                            { name: 'Strategic fit', target: 'Board endorsement' }
                        ],
                        gate: 'Full development authorisation'
                    }
                ]
            },
            'hidden_gem': {
                totalDuration: '12 months',
                milestones: [
                    { 
                        phase: 'M1: Discovery & MVP', 
                        quarters: 'Q1-Q2',
                        duration: '6 months', 
                        cost: 0.40,
                        deliverables: ['50+ user interviews', 'Persona documentation', 'MVP launched', 'Beta program active'],
                        metrics: [
                            { name: 'Problem validation', target: '> 70% confirm pain point' },
                            { name: 'Beta signups', target: '> 100 users' },
                            { name: 'Activation rate', target: '> 60% complete setup' }
                        ],
                        gate: 'Product-market fit signal'
                    },
                    { 
                        phase: 'M2: Pilot Launch', 
                        quarters: 'Q3',
                        duration: '3 months', 
                        cost: 0.35,
                        deliverables: ['Limited market launch', 'Feedback integration', 'Unit economics validated', 'Referral program'],
                        metrics: [
                            { name: 'Pilot sales', target: '> 500 units' },
                            { name: 'NPS score', target: '> 50' },
                            { name: 'Referral rate', target: '> 20%' }
                        ],
                        gate: 'Scalability assessment'
                    },
                    { 
                        phase: 'M3: Scale & Expand', 
                        quarters: 'Q4',
                        duration: '3 months', 
                        cost: 0.25,
                        deliverables: ['Multi-city launch', 'Marketing playbook', 'Support operations', 'Channel partnerships'],
                        metrics: [
                            { name: 'Geographic reach', target: 'Live in 5 cities' },
                            { name: 'Growth rate', target: '> 30% MoM' },
                            { name: 'CAC payback', target: '< 6 months' }
                        ],
                        gate: 'Mainstream market readiness'
                    }
                ]
            },
            'slow_burner': {
                totalDuration: '24 months',
                milestones: [
                    { 
                        phase: 'M1: Platform Foundation', 
                        quarters: 'Q1-Q3',
                        duration: '9 months', 
                        cost: 0.40,
                        deliverables: ['Core API architecture', 'SDK v1.0', 'Developer documentation', '5 device integrations'],
                        metrics: [
                            { name: 'API stability', target: '< 5% breaking changes' },
                            { name: 'Documentation', target: '100% API coverage' },
                            { name: 'Internal adoption', target: '3 ShieldTech products' }
                        ],
                        gate: 'Platform architecture review'
                    },
                    { 
                        phase: 'M2: Ecosystem Growth', 
                        quarters: 'Q4-Q6',
                        duration: '9 months', 
                        cost: 0.35,
                        deliverables: ['25 partner integrations', 'Developer program', 'App marketplace', 'Community forums'],
                        metrics: [
                            { name: 'Partners certified', target: '25 devices' },
                            { name: 'Developers', target: '> 500 registered' },
                            { name: 'Third-party apps', target: '> 20 in marketplace' }
                        ],
                        gate: 'Ecosystem traction review'
                    },
                    { 
                        phase: 'M3: Network Effects', 
                        quarters: 'Q7-Q8',
                        duration: '6 months', 
                        cost: 0.25,
                        deliverables: ['Viral growth mechanics', 'Cross-promotion', 'Platform monetisation', 'Self-sustaining growth'],
                        metrics: [
                            { name: 'Organic growth', target: '> 40% from referral' },
                            { name: 'Multi-device homes', target: '> 30% have 3+ integrations' },
                            { name: 'Platform revenue', target: 'First $12K partner fees' }
                        ],
                        gate: 'Self-sustaining growth achieved'
                    }
                ]
            },
            'paper_tiger': {
                totalDuration: '18 months',
                milestones: [
                    { 
                        phase: 'M1: Architecture & Subsystems', 
                        quarters: 'Q1-Q3',
                        duration: '9 months', 
                        cost: 0.40,
                        deliverables: ['System architecture', 'All subsystems functional', 'Interface definitions', 'Unit test coverage'],
                        metrics: [
                            { name: 'Spec completeness', target: '100% documented' },
                            { name: 'Subsystems', target: 'All 5 individually working' },
                            { name: 'Test coverage', target: '> 80%' }
                        ],
                        gate: 'Architecture review board'
                    },
                    { 
                        phase: 'M2: Integration & Testing', 
                        quarters: 'Q4-Q5',
                        duration: '6 months', 
                        cost: 0.35,
                        deliverables: ['Integrated system', 'Performance benchmarks', 'Stress testing', 'Quality certification'],
                        metrics: [
                            { name: 'Integration', target: 'All subsystems working together' },
                            { name: 'Performance', target: '> 90% of spec targets' },
                            { name: 'Stability', target: '< 1 crash per 1,000 hours' }
                        ],
                        gate: 'Quality release criteria'
                    },
                    { 
                        phase: 'M3: Production & Launch', 
                        quarters: 'Q6',
                        duration: '3 months', 
                        cost: 0.25,
                        deliverables: ['Production units', 'Launch materials', 'Support readiness', 'Premium positioning'],
                        metrics: [
                            { name: 'Production yield', target: '> 92%' },
                            { name: 'Launch inventory', target: '2,000 units' },
                            { name: 'Support certification', target: '100% staff trained' }
                        ],
                        gate: 'Commercial launch authorisation'
                    }
                ]
            },
            'money_pit': {
                totalDuration: '30-36 months',
                milestones: [
                    { 
                        phase: 'M1: Discovery & Foundation', 
                        quarters: 'Q1-Q4',
                        duration: '12 months', 
                        cost: 0.35,
                        deliverables: ['Technical discovery', 'Architecture blueprint', 'Core infrastructure', 'Data layer'],
                        metrics: [
                            { name: 'Scope definition', target: 'Complete inventory documented' },
                            { name: 'Dependencies', target: '100% mapped' },
                            { name: 'Foundation deployed', target: 'Core services in staging' }
                        ],
                        gate: 'Scope and budget validation'
                    },
                    { 
                        phase: 'M2: Feature Parity', 
                        quarters: 'Q5-Q10',
                        duration: '18 months', 
                        cost: 0.45,
                        deliverables: ['All features rebuilt', 'Performance benchmarks', 'User acceptance testing', 'Security audit'],
                        metrics: [
                            { name: 'Feature completion', target: '100% existing features' },
                            { name: 'Performance', target: '> 95% of current' },
                            { name: 'UAT sign-off', target: 'All business units' }
                        ],
                        gate: 'Migration readiness certification'
                    },
                    { 
                        phase: 'M3: Migration & Cutover', 
                        quarters: 'Q11-Q12',
                        duration: '6 months', 
                        cost: 0.20,
                        deliverables: ['Phased migration', 'User transition', 'Legacy decommission', 'Documentation'],
                        metrics: [
                            { name: 'User migration', target: '100% on new platform' },
                            { name: 'Incidents', target: '< 5 P1 during migration' },
                            { name: 'Legacy shutdown', target: 'Old systems decommissioned' }
                        ],
                        gate: 'Project closure and benefits'
                    }
                ]
            },
            'pivot_success': {
                totalDuration: '12-15 months',
                milestones: [
                    { 
                        phase: 'M1: Hypothesis & Prototype', 
                        quarters: 'Q1-Q2',
                        duration: '6 months', 
                        cost: 0.35,
                        deliverables: ['Market hypotheses tested', 'Clickable prototype', 'Landing page tests', 'Direction selected'],
                        metrics: [
                            { name: 'Hypotheses tested', target: '5 core validated/invalidated' },
                            { name: 'Prototype feedback', target: '> 60% positive' },
                            { name: 'Waitlist', target: '> 500 interested users' }
                        ],
                        gate: 'Direction decision point'
                    },
                    { 
                        phase: 'M2: MVP & Validation', 
                        quarters: 'Q3-Q4',
                        duration: '6 months', 
                        cost: 0.40,
                        deliverables: ['Working product', 'Paid pilot customers', 'Iteration backlog', 'Unit economics'],
                        metrics: [
                            { name: 'Paying customers', target: '> 50' },
                            { name: 'Revenue', target: 'First $6K' },
                            { name: 'Retention', target: '> 70% month-2' }
                        ],
                        gate: 'Product-market fit assessment'
                    },
                    { 
                        phase: 'M3: Scale or Pivot', 
                        quarters: 'Q5',
                        duration: '3 months', 
                        cost: 0.25,
                        deliverables: ['Growth playbook OR pivot plan', 'Resource request', 'Updated business case'],
                        metrics: [
                            { name: 'Growth rate', target: '> 20% MoM OR pivot thesis' },
                            { name: 'Unit economics', target: 'LTV > 3x CAC trajectory' },
                            { name: 'Team alignment', target: 'Clear path forward' }
                        ],
                        gate: 'Investment committee review'
                    }
                ]
            },
            'team_dependent': {
                totalDuration: '15 months',
                milestones: [
                    { 
                        phase: 'M1: Team & Exploration', 
                        quarters: 'Q1-Q2',
                        duration: '6 months', 
                        cost: 0.35,
                        deliverables: ['Team assembled', 'Working agreements', '3-5 concept prototypes', 'User research synthesis'],
                        metrics: [
                            { name: 'Team composition', target: 'All 6 roles with A-players' },
                            { name: 'Concepts explored', target: 'Minimum 3 prototyped' },
                            { name: 'User research', target: '50+ hours completed' }
                        ],
                        gate: 'Concept selection decision'
                    },
                    { 
                        phase: 'M2: Deep Development', 
                        quarters: 'Q3-Q4',
                        duration: '6 months', 
                        cost: 0.45,
                        deliverables: ['Production-quality build', 'Beta testing', 'Launch plan', 'Knowledge documentation'],
                        metrics: [
                            { name: 'Product quality', target: 'Meets ShieldTech bar' },
                            { name: 'Beta NPS', target: '> 50' },
                            { name: 'Team retention', target: '100% core retained' }
                        ],
                        gate: 'Launch readiness review'
                    },
                    { 
                        phase: 'M3: Launch & Handover', 
                        quarters: 'Q5',
                        duration: '3 months', 
                        cost: 0.20,
                        deliverables: ['Market launch', 'Transition to product team', 'Knowledge transfer', 'Team redeployment'],
                        metrics: [
                            { name: 'Launch success', target: 'Success metrics met' },
                            { name: 'Handover', target: 'Receiving team trained' },
                            { name: 'Team next steps', target: 'All have next assignment' }
                        ],
                        gate: 'Project completion'
                    }
                ]
            },
            'competitive_casualty': {
                totalDuration: '9 months',
                milestones: [
                    { 
                        phase: 'M1: Cost Engineering', 
                        quarters: 'Q1',
                        duration: '3 months', 
                        cost: 0.30,
                        deliverables: ['Cost-reduced BOM', 'Supplier negotiations', 'Value engineering', 'Certification prep'],
                        metrics: [
                            { name: 'BOM cost', target: '20% below competitor' },
                            { name: 'Supplier terms', target: '60-day payment' },
                            { name: 'Feature parity', target: '90% at 70% cost' }
                        ],
                        gate: 'Cost target confirmed'
                    },
                    { 
                        phase: 'M2: Rapid Production', 
                        quarters: 'Q2',
                        duration: '3 months', 
                        cost: 0.40,
                        deliverables: ['Production-ready design', 'BIS certification', 'First production run', 'Channel seeding'],
                        metrics: [
                            { name: 'Certification', target: 'BIS obtained' },
                            { name: 'Production', target: '10,000 units' },
                            { name: 'Channel placement', target: '500 retail points' }
                        ],
                        gate: 'Manufacturing & go-to-market'
                    },
                    { 
                        phase: 'M3: Market Battle', 
                        quarters: 'Q3',
                        duration: '3 months', 
                        cost: 0.30,
                        deliverables: ['Full launch', 'Competitive response plan', 'Cost reduction roadmap', 'Volume ramp'],
                        metrics: [
                            { name: 'Market share', target: '> 5% in 90 days' },
                            { name: 'Velocity', target: '> 2,000 units/month' },
                            { name: 'Margin', target: '> 15% gross sustained' }
                        ],
                        gate: 'Sustainable position'
                    }
                ]
            },
            'sustainability_play': {
                totalDuration: '15 months',
                milestones: [
                    { 
                        phase: 'M1: Sustainable Design', 
                        quarters: 'Q1-Q2',
                        duration: '6 months', 
                        cost: 0.35,
                        deliverables: ['Eco-design specs', 'Material sourcing', 'Lifecycle assessment', 'Consumer testing'],
                        metrics: [
                            { name: 'Recycled content', target: '> 80%' },
                            { name: 'Suppliers', target: '3 certified sustainable' },
                            { name: 'Consumer belief', target: '> 70% trust claims' }
                        ],
                        gate: 'Sustainability authenticity'
                    },
                    { 
                        phase: 'M2: Green Production', 
                        quarters: 'Q3-Q4',
                        duration: '6 months', 
                        cost: 0.40,
                        deliverables: ['Sustainable manufacturing', 'Carbon-neutral production', 'Plastic-free packaging', 'Take-back program'],
                        metrics: [
                            { name: 'Manufacturing', target: 'Carbon-neutral achieved' },
                            { name: 'Packaging', target: '100% plastic-free' },
                            { name: 'Circularity', target: 'Take-back operational' }
                        ],
                        gate: 'Full sustainability certification'
                    },
                    { 
                        phase: 'M3: Green Launch', 
                        quarters: 'Q5',
                        duration: '3 months', 
                        cost: 0.25,
                        deliverables: ['Market launch', 'PR campaign', 'Impact reporting', 'Certification badges'],
                        metrics: [
                            { name: 'Media coverage', target: '> 10 mentions' },
                            { name: 'Price premium', target: '20% above standard' },
                            { name: 'Impact report', target: 'Quarterly published' }
                        ],
                        gate: 'Sustainability brand established'
                    }
                ]
            },
            'ip_fortress': {
                totalDuration: '24 months',
                milestones: [
                    { 
                        phase: 'M1: IP Strategy & Filing', 
                        quarters: 'Q1-Q3',
                        duration: '9 months', 
                        cost: 0.40,
                        deliverables: ['Patent landscape', 'FTO clearance', '8 provisional patents', 'Trade secret protocols'],
                        metrics: [
                            { name: 'FTO', target: 'Freedom to operate confirmed' },
                            { name: 'Filings', target: '8 provisional applications' },
                            { name: 'Trade secrets', target: 'Protocols implemented' }
                        ],
                        gate: 'IP strategy approval'
                    },
                    { 
                        phase: 'M2: Development & Protection', 
                        quarters: 'Q4-Q6',
                        duration: '9 months', 
                        cost: 0.35,
                        deliverables: ['Core technology validated', 'Full patent applications', 'Working prototype', 'Licensing framework'],
                        metrics: [
                            { name: 'Patents converted', target: 'All provisionals to full' },
                            { name: 'Technical validation', target: 'Algorithm performance proven' },
                            { name: 'Licensing terms', target: 'Standard agreement ready' }
                        ],
                        gate: 'Commercial IP package'
                    },
                    { 
                        phase: 'M3: Launch & Defend', 
                        quarters: 'Q7-Q8',
                        duration: '6 months', 
                        cost: 0.25,
                        deliverables: ['Product launch', 'Competitor monitoring', 'Enforcement readiness', 'Licensing outreach'],
                        metrics: [
                            { name: 'Launch', target: 'Product in market with IP' },
                            { name: 'Monitoring', target: 'Watch service active' },
                            { name: 'Defence', target: 'Legal team briefed' }
                        ],
                        gate: 'IP moat established'
                    }
                ]
            },
            // Core product archetypes with varied durations
            'core_upgrade': { totalDuration: '9-12 months', milestones: [{ phase: 'M1: Design', quarters: 'Q1-Q2', duration: '6 months', cost: 0.40 }, { phase: 'M2: Build', quarters: 'Q3', duration: '3 months', cost: 0.35 }, { phase: 'M3: Launch', quarters: 'Q4', duration: '3 months', cost: 0.25 }] },
            'value_segment': { totalDuration: '6-9 months', milestones: [{ phase: 'M1: Cost Design', quarters: 'Q1', duration: '3 months', cost: 0.35 }, { phase: 'M2: Sourcing', quarters: 'Q2', duration: '3 months', cost: 0.40 }, { phase: 'M3: Launch', quarters: 'Q3', duration: '3 months', cost: 0.25 }] },
            'premium_flagship': { totalDuration: '18-24 months', milestones: [{ phase: 'M1: Concept', quarters: 'Q1-Q3', duration: '9 months', cost: 0.35 }, { phase: 'M2: Engineering', quarters: 'Q4-Q6', duration: '9 months', cost: 0.40 }, { phase: 'M3: Premium Launch', quarters: 'Q7-Q8', duration: '6 months', cost: 0.25 }] },
            'niche_vertical': { totalDuration: '12-15 months', milestones: [{ phase: 'M1: Discovery', quarters: 'Q1-Q2', duration: '6 months', cost: 0.40 }, { phase: 'M2: Adapt', quarters: 'Q3-Q4', duration: '6 months', cost: 0.35 }, { phase: 'M3: Niche Launch', quarters: 'Q5', duration: '3 months', cost: 0.25 }] },
            'underserved_market': { totalDuration: '12-18 months', milestones: [{ phase: 'M1: Field Research', quarters: 'Q1-Q2', duration: '6 months', cost: 0.35 }, { phase: 'M2: Ruggedise', quarters: 'Q3-Q4', duration: '6 months', cost: 0.40 }, { phase: 'M3: Distribution', quarters: 'Q5-Q6', duration: '6 months', cost: 0.25 }] },
            'platform_infrastructure': { totalDuration: '18-24 months', milestones: [{ phase: 'M1: Architecture', quarters: 'Q1-Q3', duration: '9 months', cost: 0.40 }, { phase: 'M2: Build & Integrate', quarters: 'Q4-Q6', duration: '9 months', cost: 0.40 }, { phase: 'M3: Ecosystem', quarters: 'Q7-Q8', duration: '6 months', cost: 0.20 }] },
            'market_explorer': { totalDuration: '9-12 months', milestones: [{ phase: 'M1: MVP', quarters: 'Q1-Q2', duration: '6 months', cost: 0.50 }, { phase: 'M2: Iterate', quarters: 'Q3', duration: '3 months', cost: 0.30 }, { phase: 'M3: Scale/Pivot', quarters: 'Q4', duration: '3 months', cost: 0.20 }] },
            'price_fighter': { totalDuration: '6-9 months', milestones: [{ phase: 'M1: Cost Engineering', quarters: 'Q1-Q2', duration: '6 months', cost: 0.45 }, { phase: 'M2: Volume Production', quarters: 'Q3', duration: '3 months', cost: 0.55 }] },
            'esg_initiative': { totalDuration: '15-18 months', milestones: [{ phase: 'M1: Sustainability Design', quarters: 'Q1-Q3', duration: '9 months', cost: 0.40 }, { phase: 'M2: Supply Chain', quarters: 'Q4-Q5', duration: '6 months', cost: 0.35 }, { phase: 'M3: Certified Launch', quarters: 'Q6', duration: '3 months', cost: 0.25 }] },
            'proprietary_tech': { totalDuration: '18-24 months', milestones: [{ phase: 'M1: Innovation', quarters: 'Q1-Q4', duration: '12 months', cost: 0.45 }, { phase: 'M2: Protection', quarters: 'Q5-Q6', duration: '6 months', cost: 0.30 }, { phase: 'M3: Commercialise', quarters: 'Q7-Q8', duration: '6 months', cost: 0.25 }] },
            'frontier_tech': { totalDuration: '36-48 months', milestones: [{ phase: 'M1: Research', quarters: 'Q1-Q8', duration: '24 months', cost: 0.50 }, { phase: 'M2: Validation', quarters: 'Q9-Q12', duration: '12 months', cost: 0.30 }, { phase: 'M3: Path to Product', quarters: 'Q13-Q16', duration: '12 months', cost: 0.20 }] },
            
            // AI and advanced tech archetypes
            'ai_guard_innovation': { totalDuration: '15-18 months', milestones: [{ phase: 'M1: AI Development', quarters: 'Q1-Q3', duration: '9 months', cost: 0.45 }, { phase: 'M2: Edge Deploy', quarters: 'Q4-Q5', duration: '6 months', cost: 0.35 }, { phase: 'M3: Field Pilot', quarters: 'Q6', duration: '3 months', cost: 0.20 }] },
            'services_platform': { totalDuration: '12-15 months', milestones: [{ phase: 'M1: Platform Build', quarters: 'Q1-Q3', duration: '9 months', cost: 0.45 }, { phase: 'M2: SOC Setup', quarters: 'Q4', duration: '3 months', cost: 0.35 }, { phase: 'M3: Service Launch', quarters: 'Q5', duration: '3 months', cost: 0.20 }] },
            'autonomous_drone': { totalDuration: '30-36 months', milestones: [{ phase: 'M1: Development', quarters: 'Q1-Q6', duration: '18 months', cost: 0.45 }, { phase: 'M2: Regulatory', quarters: 'Q7-Q10', duration: '12 months', cost: 0.35 }, { phase: 'M3: Commercial Ops', quarters: 'Q11-Q12', duration: '6 months', cost: 0.20 }] },
            'ground_robot': { totalDuration: '36-48 months', milestones: [{ phase: 'M1: Robotics R&D', quarters: 'Q1-Q8', duration: '24 months', cost: 0.50 }, { phase: 'M2: Field Testing', quarters: 'Q9-Q14', duration: '18 months', cost: 0.35 }, { phase: 'M3: Deployment', quarters: 'Q15-Q16', duration: '6 months', cost: 0.15 }] },
            'privacy_compliance': { totalDuration: '18-24 months', milestones: [{ phase: 'M1: Privacy Tech', quarters: 'Q1-Q4', duration: '12 months', cost: 0.45 }, { phase: 'M2: Certification', quarters: 'Q5-Q6', duration: '6 months', cost: 0.30 }, { phase: 'M3: Enterprise Sales', quarters: 'Q7-Q8', duration: '6 months', cost: 0.25 }] },
            'evidence_chain': { totalDuration: '12-18 months', milestones: [{ phase: 'M1: Chain Development', quarters: 'Q1-Q3', duration: '9 months', cost: 0.45 }, { phase: 'M2: Legal Validation', quarters: 'Q4-Q5', duration: '6 months', cost: 0.30 }, { phase: 'M3: Market Entry', quarters: 'Q6', duration: '3 months', cost: 0.25 }] },
            'smart_access': { totalDuration: '15-18 months', milestones: [{ phase: 'M1: Risk Engine', quarters: 'Q1-Q3', duration: '9 months', cost: 0.40 }, { phase: 'M2: Integration', quarters: 'Q4-Q5', duration: '6 months', cost: 0.35 }, { phase: 'M3: Pilot & Scale', quarters: 'Q6', duration: '3 months', cost: 0.25 }] },
            'rtls_tracking': { totalDuration: '15-18 months', milestones: [{ phase: 'M1: UWB Platform', quarters: 'Q1-Q3', duration: '9 months', cost: 0.40 }, { phase: 'M2: Security Fusion', quarters: 'Q4-Q5', duration: '6 months', cost: 0.35 }, { phase: 'M3: Enterprise Deploy', quarters: 'Q6', duration: '3 months', cost: 0.25 }] },
            'acoustic_detection': { totalDuration: '24-30 months', milestones: [{ phase: 'M1: Audio ML', quarters: 'Q1-Q5', duration: '15 months', cost: 0.45 }, { phase: 'M2: Network Deploy', quarters: 'Q6-Q8', duration: '9 months', cost: 0.35 }, { phase: 'M3: City Pilot', quarters: 'Q9-Q10', duration: '6 months', cost: 0.20 }] },
            'digital_twin': { totalDuration: '24-30 months', milestones: [{ phase: 'M1: Simulation Engine', quarters: 'Q1-Q6', duration: '18 months', cost: 0.50 }, { phase: 'M2: Facility Modeling', quarters: 'Q7-Q9', duration: '9 months', cost: 0.30 }, { phase: 'M3: Predictive Ops', quarters: 'Q10', duration: '3 months', cost: 0.20 }] },
            'perimeter_fusion': { totalDuration: '18-24 months', milestones: [{ phase: 'M1: Sensor Fusion', quarters: 'Q1-Q4', duration: '12 months', cost: 0.45 }, { phase: 'M2: Enterprise Config', quarters: 'Q5-Q6', duration: '6 months', cost: 0.30 }, { phase: 'M3: Multi-site', quarters: 'Q7-Q8', duration: '6 months', cost: 0.25 }] },
            'cyber_physical_soc': { totalDuration: '21-24 months', milestones: [{ phase: 'M1: Convergence Platform', quarters: 'Q1-Q5', duration: '15 months', cost: 0.45 }, { phase: 'M2: Correlation Engine', quarters: 'Q6-Q7', duration: '6 months', cost: 0.35 }, { phase: 'M3: SOC Operations', quarters: 'Q8', duration: '3 months', cost: 0.20 }] },
            'camera_health': { totalDuration: '9-12 months', milestones: [{ phase: 'M1: Analytics Build', quarters: 'Q1-Q2', duration: '6 months', cost: 0.45 }, { phase: 'M2: Fleet Integration', quarters: 'Q3', duration: '3 months', cost: 0.35 }, { phase: 'M3: Service Launch', quarters: 'Q4', duration: '3 months', cost: 0.20 }] },
            'panic_wearable': { totalDuration: '12-15 months', milestones: [{ phase: 'M1: Hardware Design', quarters: 'Q1-Q3', duration: '9 months', cost: 0.45 }, { phase: 'M2: SOC Connect', quarters: 'Q4', duration: '3 months', cost: 0.30 }, { phase: 'M3: Enterprise Roll', quarters: 'Q5', duration: '3 months', cost: 0.25 }] },
            'vehicle_intelligence': { totalDuration: '18-21 months', milestones: [{ phase: 'M1: Intent Models', quarters: 'Q1-Q4', duration: '12 months', cost: 0.45 }, { phase: 'M2: Gate Integration', quarters: 'Q5-Q6', duration: '6 months', cost: 0.35 }, { phase: 'M3: Logistics Pilot', quarters: 'Q7', duration: '3 months', cost: 0.20 }] },
            'compliance_automation': { totalDuration: '9-12 months', milestones: [{ phase: 'M1: Report Engine', quarters: 'Q1-Q2', duration: '6 months', cost: 0.45 }, { phase: 'M2: Template Library', quarters: 'Q3', duration: '3 months', cost: 0.30 }, { phase: 'M3: Enterprise Sales', quarters: 'Q4', duration: '3 months', cost: 0.25 }] },
            'deepfake_defense': { totalDuration: '24-30 months', milestones: [{ phase: 'M1: Detection R&D', quarters: 'Q1-Q6', duration: '18 months', cost: 0.50 }, { phase: 'M2: Liveness Integration', quarters: 'Q7-Q8', duration: '6 months', cost: 0.30 }, { phase: 'M3: High-Security Deploy', quarters: 'Q9-Q10', duration: '6 months', cost: 0.20 }] },
            'edge_micro_nvr': { totalDuration: '9-12 months', milestones: [{ phase: 'M1: Firmware Dev', quarters: 'Q1-Q2', duration: '6 months', cost: 0.45 }, { phase: 'M2: Cloud Sync', quarters: 'Q3', duration: '3 months', cost: 0.35 }, { phase: 'M3: Channel Launch', quarters: 'Q4', duration: '3 months', cost: 0.20 }] },
            'rapid_deploy_kit': { totalDuration: '6-9 months', milestones: [{ phase: 'M1: Kit Design', quarters: 'Q1-Q2', duration: '6 months', cost: 0.50 }, { phase: 'M2: Production', quarters: 'Q3', duration: '3 months', cost: 0.50 }] },
            'predictive_risk': { totalDuration: '24-30 months', milestones: [{ phase: 'M1: Data & Models', quarters: 'Q1-Q6', duration: '18 months', cost: 0.50 }, { phase: 'M2: Validation', quarters: 'Q7-Q8', duration: '6 months', cost: 0.30 }, { phase: 'M3: Insurance Partnership', quarters: 'Q9-Q10', duration: '6 months', cost: 0.20 }] },
            'visitor_flow': { totalDuration: '9-12 months', milestones: [{ phase: 'M1: CV Integration', quarters: 'Q1-Q2', duration: '6 months', cost: 0.45 }, { phase: 'M2: Access Linkage', quarters: 'Q3', duration: '3 months', cost: 0.30 }, { phase: 'M3: Enterprise Sales', quarters: 'Q4', duration: '3 months', cost: 0.25 }] },
            'security_score': { totalDuration: '12-15 months', milestones: [{ phase: 'M1: Scoring Algorithm', quarters: 'Q1-Q3', duration: '9 months', cost: 0.45 }, { phase: 'M2: Dashboard Build', quarters: 'Q4', duration: '3 months', cost: 0.30 }, { phase: 'M3: B2B Launch', quarters: 'Q5', duration: '3 months', cost: 0.25 }] },
            'smart_key_control': { totalDuration: '12-15 months', milestones: [{ phase: 'M1: Hardware Dev', quarters: 'Q1-Q3', duration: '9 months', cost: 0.45 }, { phase: 'M2: Cloud Platform', quarters: 'Q4', duration: '3 months', cost: 0.30 }, { phase: 'M3: Facility Deploy', quarters: 'Q5', duration: '3 months', cost: 0.25 }] },
            'emergency_muster': { totalDuration: '9-12 months', milestones: [{ phase: 'M1: Platform Build', quarters: 'Q1-Q2', duration: '6 months', cost: 0.45 }, { phase: 'M2: HR Integration', quarters: 'Q3', duration: '3 months', cost: 0.30 }, { phase: 'M3: EHS Sales', quarters: 'Q4', duration: '3 months', cost: 0.25 }] },
            'night_escort': { totalDuration: '6-9 months', milestones: [{ phase: 'M1: App Development', quarters: 'Q1-Q2', duration: '6 months', cost: 0.50 }, { phase: 'M2: Service Operations', quarters: 'Q3', duration: '3 months', cost: 0.50 }] },
            'guard_training_sim': { totalDuration: '18-24 months', milestones: [{ phase: 'M1: Simulation Dev', quarters: 'Q1-Q5', duration: '15 months', cost: 0.50 }, { phase: 'M2: Content Library', quarters: 'Q6-Q7', duration: '6 months', cost: 0.30 }, { phase: 'M3: Training Deploy', quarters: 'Q8', duration: '3 months', cost: 0.20 }] },
            'incident_invoice': { totalDuration: '9-12 months', milestones: [{ phase: 'M1: Billing Engine', quarters: 'Q1-Q2', duration: '6 months', cost: 0.45 }, { phase: 'M2: ERP Integration', quarters: 'Q3', duration: '3 months', cost: 0.35 }, { phase: 'M3: Enterprise Roll', quarters: 'Q4', duration: '3 months', cost: 0.20 }] },
            'parking_security': { totalDuration: '12-15 months', milestones: [{ phase: 'M1: LPR Integration', quarters: 'Q1-Q3', duration: '9 months', cost: 0.45 }, { phase: 'M2: Parking Systems', quarters: 'Q4', duration: '3 months', cost: 0.30 }, { phase: 'M3: Multi-site', quarters: 'Q5', duration: '3 months', cost: 0.25 }] },
            'shrink_prevention': { totalDuration: '12-15 months', milestones: [{ phase: 'M1: Retail Analytics', quarters: 'Q1-Q3', duration: '9 months', cost: 0.45 }, { phase: 'M2: POS Integration', quarters: 'Q4', duration: '3 months', cost: 0.30 }, { phase: 'M3: Retail Pilot', quarters: 'Q5', duration: '3 months', cost: 0.25 }] },
            'alarm_response_network': { totalDuration: '12-15 months', milestones: [{ phase: 'M1: Dispatch Platform', quarters: 'Q1-Q3', duration: '9 months', cost: 0.40 }, { phase: 'M2: Partner Network', quarters: 'Q4', duration: '3 months', cost: 0.35 }, { phase: 'M3: Service Launch', quarters: 'Q5', duration: '3 months', cost: 0.25 }] },
            'camera_subscription': { totalDuration: '9-12 months', milestones: [{ phase: 'M1: Cloud Platform', quarters: 'Q1-Q2', duration: '6 months', cost: 0.45 }, { phase: 'M2: Provisioning', quarters: 'Q3', duration: '3 months', cost: 0.30 }, { phase: 'M3: Channel Enable', quarters: 'Q4', duration: '3 months', cost: 0.25 }] },
            'privacy_analytics': { totalDuration: '15-18 months', milestones: [{ phase: 'M1: Edge Processing', quarters: 'Q1-Q4', duration: '12 months', cost: 0.50 }, { phase: 'M2: Privacy Cert', quarters: 'Q5', duration: '3 months', cost: 0.25 }, { phase: 'M3: Enterprise Sales', quarters: 'Q6', duration: '3 months', cost: 0.25 }] },
            'guard_tour_proof': { totalDuration: '9-12 months', milestones: [{ phase: 'M1: Proof System', quarters: 'Q1-Q2', duration: '6 months', cost: 0.45 }, { phase: 'M2: Mobile App', quarters: 'Q3', duration: '3 months', cost: 0.30 }, { phase: 'M3: Security Partner', quarters: 'Q4', duration: '3 months', cost: 0.25 }] },
            'smart_intercom': { totalDuration: '12-15 months', milestones: [{ phase: 'M1: Hardware Dev', quarters: 'Q1-Q3', duration: '9 months', cost: 0.45 }, { phase: 'M2: Cloud Video', quarters: 'Q4', duration: '3 months', cost: 0.30 }, { phase: 'M3: Builder Channel', quarters: 'Q5', duration: '3 months', cost: 0.25 }] },
            'wander_management': { totalDuration: '15-18 months', milestones: [{ phase: 'M1: Tracking System', quarters: 'Q1-Q4', duration: '12 months', cost: 0.45 }, { phase: 'M2: Healthcare Cert', quarters: 'Q5', duration: '3 months', cost: 0.30 }, { phase: 'M3: Facility Sales', quarters: 'Q6', duration: '3 months', cost: 0.25 }] },
            'contractor_screening': { totalDuration: '9-12 months', milestones: [{ phase: 'M1: Verification APIs', quarters: 'Q1-Q2', duration: '6 months', cost: 0.45 }, { phase: 'M2: Workflow Build', quarters: 'Q3', duration: '3 months', cost: 0.30 }, { phase: 'M3: FM Partner', quarters: 'Q4', duration: '3 months', cost: 0.25 }] },
            'ai_video_search': { totalDuration: '18-24 months', milestones: [{ phase: 'M1: Search Engine', quarters: 'Q1-Q5', duration: '15 months', cost: 0.50 }, { phase: 'M2: Index Scale', quarters: 'Q6-Q7', duration: '6 months', cost: 0.30 }, { phase: 'M3: Enterprise Deploy', quarters: 'Q8', duration: '3 months', cost: 0.20 }] },
            'safety_security_soc': { totalDuration: '18-24 months', milestones: [{ phase: 'M1: Convergence Build', quarters: 'Q1-Q5', duration: '15 months', cost: 0.45 }, { phase: 'M2: EHS Integration', quarters: 'Q6-Q7', duration: '6 months', cost: 0.35 }, { phase: 'M3: Operations', quarters: 'Q8', duration: '3 months', cost: 0.20 }] },
            'anti_drone_service': { totalDuration: '24-30 months', milestones: [{ phase: 'M1: Detection R&D', quarters: 'Q1-Q6', duration: '18 months', cost: 0.50 }, { phase: 'M2: Response Protocol', quarters: 'Q7-Q8', duration: '6 months', cost: 0.30 }, { phase: 'M3: Service Ops', quarters: 'Q9-Q10', duration: '6 months', cost: 0.20 }] },
            'predictive_door_maintenance': { totalDuration: '12-15 months', milestones: [{ phase: 'M1: IoT Sensors', quarters: 'Q1-Q3', duration: '9 months', cost: 0.45 }, { phase: 'M2: ML Models', quarters: 'Q4', duration: '3 months', cost: 0.30 }, { phase: 'M3: Service Launch', quarters: 'Q5', duration: '3 months', cost: 0.25 }] },
            
            // Legacy archetypes
            'legacy_incremental': { totalDuration: '6-9 months', milestones: [{ phase: 'M1: Enhancement', quarters: 'Q1-Q2', duration: '6 months', cost: 0.60 }, { phase: 'M2: Release', quarters: 'Q3', duration: '3 months', cost: 0.40 }] },
            'legacy_pet_project': { totalDuration: '24-36 months', milestones: [{ phase: 'M1: Validation', quarters: 'Q1-Q6', duration: '18 months', cost: 0.50 }, { phase: 'M2: Reassess', quarters: 'Q7-Q10', duration: '12 months', cost: 0.30 }, { phase: 'M3: Decision Point', quarters: 'Q11-Q12', duration: '6 months', cost: 0.20 }] },
            'legacy_strategic_troubled': { totalDuration: '18-24 months', milestones: [{ phase: 'M1: Recovery Plan', quarters: 'Q1-Q4', duration: '12 months', cost: 0.50 }, { phase: 'M2: Execution', quarters: 'Q5-Q7', duration: '9 months', cost: 0.35 }, { phase: 'M3: Validation', quarters: 'Q8', duration: '3 months', cost: 0.15 }] },
            'legacy_partnership': { totalDuration: '15-18 months', milestones: [{ phase: 'M1: Partner Align', quarters: 'Q1-Q3', duration: '9 months', cost: 0.40 }, { phase: 'M2: Joint Development', quarters: 'Q4-Q5', duration: '6 months', cost: 0.40 }, { phase: 'M3: Market Entry', quarters: 'Q6', duration: '3 months', cost: 0.20 }] },
            'legacy_defensive': { totalDuration: '6-9 months', milestones: [{ phase: 'M1: Rapid Response', quarters: 'Q1-Q2', duration: '6 months', cost: 0.65 }, { phase: 'M2: Counter Launch', quarters: 'Q3', duration: '3 months', cost: 0.35 }] },
            'legacy_infrastructure': { totalDuration: '36-48 months', milestones: [{ phase: 'M1: Planning', quarters: 'Q1-Q4', duration: '12 months', cost: 0.25 }, { phase: 'M2: Migration', quarters: 'Q5-Q12', duration: '24 months', cost: 0.55 }, { phase: 'M3: Stabilise', quarters: 'Q13-Q16', duration: '12 months', cost: 0.20 }] }
        };
        
        const template = milestoneTemplates[archetype] || milestoneTemplates['conventional_winner'];
        
        // Add actual costs based on budget
        return {
            totalDuration: template.totalDuration,
            milestones: template.milestones.map(m => ({
                ...m,
                costAmount: (budget * m.cost).toFixed(1)
            }))
        };
    }
    
    function shuffleArray(array) {
        const shuffled = [...array];
        for (let i = shuffled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        return shuffled;
    }
    
    function startProjectSelection() {
        gameState.projectPool = generateProjectPool();
        gameState.selectedProjects = [];
        // If legacy decisions were made, budget was already set in confirmLegacyDecisions
        // Otherwise use maxBudget (no legacy projects scenario)
        if (gameState.legacyBudgetCommitted === undefined) {
            gameState.budget = gameState.maxBudget;
        }
        // Otherwise the budget was already set in confirmLegacyDecisions
        
        // If solo mode, skip assessment and go directly to selection
        if (gameState.decisionModel === 'solo') {
            showPhase('selection');
        } else if (gameState.decisionModel === 'random') {
            // Random selection - auto-select projects
            autoSelectRandomProjects();
            showPhase('selection');
        } else {
            // Committee or jury - show approach modal first, then go through assessment
            showApproachModal();
        }
    }
    
    // ============================================
    // SELECTION APPROACH MODAL FUNCTIONS
    // ============================================
    
    function showApproachModal() {
        // Reset selection state
        gameState.scoringApproach = null;
        gameState.teamBlinding = null;
        
        document.querySelectorAll('.approach-option').forEach(opt => opt.classList.remove('selected'));
        document.getElementById('approach-confirm-btn').disabled = true;
        document.getElementById('approach-confirm-btn').textContent = 'Make Both Selections to Continue';
        
        // Show modal
        document.getElementById('approach-modal').classList.remove('hidden');
    }
    
    function selectApproachOption(choice, value) {
        // Update the selection for this choice group
        if (choice === 'scoring') {
            gameState.scoringApproach = value;
        } else if (choice === 'blinding') {
            gameState.teamBlinding = value;
        }
        
        // Update visual selection within this choice group
        document.querySelectorAll(`.approach-option[data-choice="${choice}"]`).forEach(opt => {
            opt.classList.remove('selected');
        });
        document.querySelector(`.approach-option[data-choice="${choice}"][data-value="${value}"]`).classList.add('selected');
        
        // Check if both choices are made
        updateApproachConfirmButton();
    }
    
    function updateApproachConfirmButton() {
        const btn = document.getElementById('approach-confirm-btn');
        
        if (gameState.scoringApproach && gameState.teamBlinding) {
            btn.disabled = false;
            
            // Build descriptive button text
            const scoringLabels = {
                'careful': 'Careful Evaluation',
                'rapid': 'Rapid Screening',
                'delegate': 'Committee Scoring'
            };
            const blindingLabels = {
                'visible': 'Team Visible',
                'blind': 'Blind Review'
            };
            
            btn.textContent = `Begin with ${scoringLabels[gameState.scoringApproach]} + ${blindingLabels[gameState.teamBlinding]} →`;
        } else {
            btn.disabled = true;
            btn.textContent = 'Make Both Selections to Continue';
        }
    }
    
    function confirmApproach() {
        if (!gameState.scoringApproach || !gameState.teamBlinding) return;
        
        // Close modal
        document.getElementById('approach-modal').classList.add('hidden');
        
        // Initialize projectTriage if needed
        if (!gameState.projectTriage) {
            gameState.projectTriage = {};
        }
        
        // Route based on scoring approach
        if (gameState.scoringApproach === 'delegate') {
            // Skip player assessment, generate committee scores, go to triage
            generateCommitteeOnlyScores();
            renderTriageCards();
            showPhase('committee-feedback');
        } else {
            // Player will score projects (careful or rapid mode)
            renderAssessmentGrid();
            showPhase('assessment');
        }
    }
    
    function generateCommitteeOnlyScores() {
        // When player delegates scoring, generate committee scores for all projects
        gameState.projectPool.forEach(project => {
            // Initialize player scores as empty (they didn't score)
            project.playerScores = {};
            
            // Generate committee scores
            project.committeeScores = {};
            gameState.committee.forEach(staffId => {
                const staff = findStaff(staffId);
                if (staff) {
                    project.committeeScores[staffId] = calculateCommitteeScore(project, staff);
                }
            });
        });
    }
    
    function calculateCommitteeScore(project, staff) {
        // Base score influenced by project archetype and staff biases
        let score = 3; // Neutral starting point
        
        const archetype = project.archetype;
        const effects = staff.effects || {};
        
        // Apply staff-specific modifiers
        if (archetype === 'hidden_gem' && effects.hiddenGem) {
            score *= effects.hiddenGem;
        }
        if (archetype === 'slow_burner' && effects.slowBurner) {
            score *= effects.slowBurner;
        }
        if (archetype === 'money_pit' && effects.moneyPit) {
            score *= effects.moneyPit;
        }
        if (effects.strategic && project.scores?.strategic > 7) {
            score *= effects.strategic;
        }
        if (effects.market && project.scores?.market > 7) {
            score *= effects.market;
        }
        if (effects.cost && project.budget < 6) {
            score *= effects.cost;
        }
        
        // Add some randomness
        score += (Math.random() - 0.5) * 1.5;
        
        // Factor in project's inherent quality
        const avgQuality = (project.scores?.strategic + project.scores?.technical + project.scores?.market) / 3 || 5;
        score = (score + avgQuality / 2) / 2;
        
        // Clamp to valid range
        return Math.max(1, Math.min(5, Math.round(score)));
    }
    
    // Helper function to check if team info should be shown
    function shouldShowTeamInfo() {
        return gameState.teamBlinding !== 'blind';
    }
    
    // Helper function to check if using rapid scoring mode
    function isRapidScoringMode() {
        return gameState.scoringApproach === 'rapid';
    }
    
    // Helper function to check if player is delegating to committee
    function isDelegateMode() {
        return gameState.scoringApproach === 'delegate';
    }
    
    function autoSelectRandomProjects() {
        // Randomly select projects until budget is exhausted
        const shuffled = shuffleArray([...gameState.projectPool]);
        gameState.selectedProjects = [];
        let budget = gameState.maxBudget;
        
        for (const project of shuffled) {
            if (project.budget <= budget) {
                gameState.selectedProjects.push(project.id);
                budget -= project.budget;
            }
        }
        gameState.budget = budget;
    }
    
    function renderAssessmentGrid() {
        // Now we render one project at a time
        gameState.currentAssessmentIndex = 0;
        renderCurrentProject();
    }
    
    function renderCurrentProject() {
        const project = gameState.projectPool[gameState.currentAssessmentIndex];
        const criteria = gameState.criteria;
        const total = gameState.projectPool.length;
        const current = gameState.currentAssessmentIndex + 1;
        
        const isRapid = isRapidScoringMode();
        const showTeam = shouldShowTeamInfo();
        
        // Update progress
        document.getElementById('current-project-num').textContent = current;
        document.getElementById('total-projects').textContent = total;
        document.getElementById('assessment-progress-fill').style.width = `${(current / total) * 100}%`;
        
        // Render progress dots
        renderProgressDots();
        
        // Update navigation buttons
        document.getElementById('prev-project-btn').disabled = gameState.currentAssessmentIndex === 0;
        const isLastProject = gameState.currentAssessmentIndex === total - 1;
        const nextBtn = document.getElementById('next-project-btn');
        nextBtn.textContent = isLastProject ? 'See Committee Feedback →' : 'Next Project →';
        
        // Extract short description (first sentence or up to 150 chars)
        const fullDesc = project.fullDesc || project.desc || 'No description available.';
        const shortDesc = fullDesc.length > 150 ? fullDesc.substring(0, 150) + '...' : fullDesc;
        
        // Generate rapid summary for rapid mode
        const rapidSummary = generateRapidSummary(project);
        
        // Render project view based on mode
        const projectView = document.getElementById('assessment-project-view');
        
        if (isRapid) {
            // Calculate lead track record percentage
            const leadTrackPct = project.lead ? Math.round(getLeadTrackScore(project.lead) * 100) : null;
            const leadTrackClass = leadTrackPct >= 70 ? 'success' : leadTrackPct >= 50 ? 'warning' : 'danger';
            
            // RAPID SCORING MODE - Condensed view
            projectView.innerHTML = `
                <div class="rapid-mode-badge">⚡ Rapid Screening Mode</div>
                
                <div class="assessment-project-header">
                    <div>
                        <div class="assessment-project-title">${project.name}</div>
                        <div class="assessment-project-tagline">${project.tagline}</div>
                    </div>
                    <div class="assessment-project-budget">$${project.budget}M </div>
                </div>
                
                <div class="strategic-buckets">
                    ${(project.strategicBuckets || []).map(bucket => `
                        <span class="strategic-bucket" style="background: ${bucket.color}20; color: ${bucket.color}; border: 1px solid ${bucket.color}40;">
                            ${bucket.icon} ${bucket.name}
                        </span>
                    `).join('')}
                </div>
                
                <!-- RAPID KEY FACTS -->
                <div class="key-facts-grid rapid-facts">
                    <div class="key-fact">
                        <div class="key-fact-value">${project.milestones?.totalDuration || '12 months'}</div>
                        <div class="key-fact-label">Duration</div>
                    </div>
                    <div class="key-fact">
                        <div class="key-fact-value">TRL ${project.trl?.current || '?'} → ${project.trl?.target || '?'}</div>
                        <div class="key-fact-label">Tech Readiness</div>
                    </div>
                    <div class="key-fact">
                        <div class="key-fact-value">${project.financials?.grossMargin || 'TBD'}</div>
                        <div class="key-fact-label">Gross Margin</div>
                    </div>
                    <div class="key-fact">
                        <div class="key-fact-value fto-${(project.ipPosition?.risk || 'unknown').toLowerCase().replace('-', '')}">${project.ipPosition?.risk || '?'}</div>
                        <div class="key-fact-label">IP Risk</div>
                    </div>
                </div>
                
                <!-- RAPID SUMMARY - 100-150 words -->
                <div class="assessment-section rapid-summary">
                    <p class="project-rapid-desc">${rapidSummary}</p>
                </div>
                
                ${showTeam && project.lead ? `
                    <div class="rapid-team-hint">
                        <span class="team-icon">👤</span>
                        <span class="team-text">Lead: <strong>${project.lead.name}</strong> · <span class="track-record-badge ${leadTrackClass}">${leadTrackPct}% track record</span></span>
                    </div>
                ` : !showTeam ? `
                    <div class="rapid-team-hint blinded">
                        <span class="team-icon">🎭</span>
                        <span class="team-text">Team information hidden (Blind Review)</span>
                    </div>
                ` : ''}
                
                <div class="rapid-details-link">
                    <button class="btn btn-sm btn-secondary" onclick="openProjectTemplateModal('${project.id}')">
                        📋 View Full Project Details
                    </button>
                </div>
            `;
        } else {
            // CAREFUL SCORING MODE - Full detailed view
            projectView.innerHTML = `
            <div class="assessment-project-header">
                <div>
                    <div class="assessment-project-title">${project.name}</div>
                    <div class="assessment-project-tagline">${project.tagline}</div>
                </div>
                <div class="assessment-project-budget">$${project.budget}M </div>
            </div>
            
            <div class="strategic-buckets">
                ${(project.strategicBuckets || []).map(bucket => `
                    <span class="strategic-bucket" style="background: ${bucket.color}20; color: ${bucket.color}; border: 1px solid ${bucket.color}40;">
                        ${bucket.icon} ${bucket.name}
                    </span>
                `).join('')}
            </div>
            
            <!-- KEY FACTS SUMMARY -->
            <div class="key-facts-grid">
                <div class="key-fact">
                    <div class="key-fact-value">${project.milestones?.totalDuration || '12 months'}</div>
                    <div class="key-fact-label">Duration</div>
                </div>
                <div class="key-fact">
                    <div class="key-fact-value">TRL ${project.trl?.current || '?'} → ${project.trl?.target || '?'}</div>
                    <div class="key-fact-label">Tech Readiness</div>
                </div>
                <div class="key-fact">
                    <div class="key-fact-value">${project.financials?.grossMargin || 'TBD'}</div>
                    <div class="key-fact-label">Gross Margin</div>
                </div>
                <div class="key-fact">
                    <div class="key-fact-value">${project.financials?.breakeven || 'TBD'}</div>
                    <div class="key-fact-label">Breakeven</div>
                </div>
                <div class="key-fact">
                    <div class="key-fact-value fto-${(project.ipPosition?.risk || 'unknown').toLowerCase().replace('-', '')}">${project.ipPosition?.risk || '?'}</div>
                    <div class="key-fact-label">IP Risk</div>
                </div>
                <div class="key-fact">
                    <div class="key-fact-value">${(project.competitors || []).filter(c => c.threat === 'High' || c.threat === 'Very High').length}</div>
                    <div class="key-fact-label">High Threats</div>
                </div>
            </div>
            
            <!-- PROJECT DESCRIPTION - Collapsible -->
            <div class="assessment-section">
                <h4>📋 Project Overview</h4>
                <p class="project-short-desc">${shortDesc}</p>
                <details class="info-details">
                    <summary>Read Full Description</summary>
                    <div class="full-description">
                        <p>${project.fullDesc || project.desc}</p>
                    </div>
                </details>
            </div>
            
            <!-- MARKET & COMPETITION - Collapsible -->
            <details class="section-details">
                <summary class="section-summary">
                    <span class="section-icon">🎯</span>
                    <span class="section-title">Market & Competition</span>
                    <span class="section-hint">${(project.competitors || []).length} competitors identified</span>
                </summary>
                <div class="section-content">
                    <div class="assessment-subsection">
                        <h5>Market Context</h5>
                        <p>${project.marketContext || 'Market analysis pending.'}</p>
                    </div>
                    <div class="assessment-subsection">
                        <h5>Key Competitors</h5>
                        <div class="competitors-grid">
                            ${(project.competitors || []).map(comp => `
                                <div class="competitor-card threat-${comp.threat?.toLowerCase().replace(' ', '-') || 'unknown'}">
                                    <div class="competitor-name">${comp.name}</div>
                                    <div class="competitor-position">${comp.position}</div>
                                    <div class="competitor-threat">Threat: <strong>${comp.threat}</strong></div>
                                </div>
                            `).join('') || '<p>Competitor analysis pending.</p>'}
                        </div>
                    </div>
                </div>
            </details>
            
            <!-- FINANCIAL PROJECTIONS - Collapsible -->
            <details class="section-details">
                <summary class="section-summary">
                    <span class="section-icon">💰</span>
                    <span class="section-title">Financial Projections</span>
                    <span class="section-hint">${project.financials?.projectedRevenue?.split(',')[0] || 'TBD'} Y1</span>
                </summary>
                <div class="section-content">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
                        <div class="financial-box">
                            <div class="financial-value">${project.financials?.devCost || '$' + project.budget + 'M'}</div>
                            <div class="financial-label">Development Cost</div>
                        </div>
                        <div class="financial-box">
                            <div class="financial-value">${project.financials?.timeline || '3 quarters'}</div>
                            <div class="financial-label">Timeline</div>
                        </div>
                        <div class="financial-box">
                            <div class="financial-value">${project.financials?.projectedRevenue?.split(',')[0] || 'TBD'}</div>
                            <div class="financial-label">Year 1 Revenue</div>
                        </div>
                        <div class="financial-box">
                            <div class="financial-value">${project.financials?.projectedRevenue?.split(',')[1]?.trim() || 'TBD'}</div>
                            <div class="financial-label">Year 2 Revenue</div>
                        </div>
                        <div class="financial-box">
                            <div class="financial-value">${project.financials?.grossMargin || 'TBD'}</div>
                            <div class="financial-label">Gross Margin</div>
                        </div>
                        <div class="financial-box">
                            <div class="financial-value">${project.financials?.breakeven || 'TBD'}</div>
                            <div class="financial-label">Breakeven</div>
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <h5>Cost Breakdown</h5>
                        <div class="cost-breakdown-bar">
                            <div class="cost-segment" style="width: ${project.developmentCosts?.personnel?.pct || 0}%; background: #6366f1;" title="Personnel ${project.developmentCosts?.personnel?.pct || 0}%"></div>
                            <div class="cost-segment" style="width: ${project.developmentCosts?.hardware?.pct || 0}%; background: #22c55e;" title="Hardware ${project.developmentCosts?.hardware?.pct || 0}%"></div>
                            <div class="cost-segment" style="width: ${project.developmentCosts?.software?.pct || 0}%; background: #3b82f6;" title="Software ${project.developmentCosts?.software?.pct || 0}%"></div>
                            <div class="cost-segment" style="width: ${project.developmentCosts?.external?.pct || 0}%; background: #f59e0b;" title="External ${project.developmentCosts?.external?.pct || 0}%"></div>
                            <div class="cost-segment" style="width: ${project.developmentCosts?.contingency?.pct || 0}%; background: #ef4444;" title="Contingency ${project.developmentCosts?.contingency?.pct || 0}%"></div>
                        </div>
                        <div class="cost-legend">
                            <span><span class="legend-dot" style="background: #6366f1;"></span>Personnel ${project.developmentCosts?.personnel?.pct || 0}%</span>
                            <span><span class="legend-dot" style="background: #22c55e;"></span>Hardware ${project.developmentCosts?.hardware?.pct || 0}%</span>
                            <span><span class="legend-dot" style="background: #3b82f6;"></span>Software ${project.developmentCosts?.software?.pct || 0}%</span>
                            <span><span class="legend-dot" style="background: #f59e0b;"></span>External ${project.developmentCosts?.external?.pct || 0}%</span>
                            <span><span class="legend-dot" style="background: #ef4444;"></span>Contingency ${project.developmentCosts?.contingency?.pct || 0}%</span>
                        </div>
                    </div>
                </div>
            </details>
            
            <!-- DEVELOPMENT PLAN - Collapsible -->
            <details class="section-details">
                <summary class="section-summary">
                    <span class="section-icon">📅</span>
                    <span class="section-title">Development Plan</span>
                    <span class="section-hint">${project.milestones?.milestones?.length || 3} milestones over ${project.milestones?.totalDuration || '12 months'}</span>
                </summary>
                <div class="section-content">
                    <div class="milestones-summary">
                        ${(project.milestones?.milestones || []).map((m, i) => `
                            <div class="milestone-summary-item">
                                <div class="milestone-summary-phase">${m.quarters}</div>
                                <div class="milestone-summary-duration">${m.phase.split(': ')[1] || m.phase}</div>
                                <div class="milestone-summary-cost">$${m.costAmount}M </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="milestones-timeline">
                        ${(project.milestones?.milestones || []).map(m => `
                            <div class="milestone-item">
                                <div class="milestone-header">
                                    <div class="milestone-phase">${m.phase}</div>
                                    <div class="milestone-meta">
                                        <span>📆 ${m.quarters}</span>
                                        <span>⏱️ ${m.duration}</span>
                                        <span>💰 $${m.costAmount}M </span>
                                    </div>
                                </div>
                                <div class="milestone-deliverables">
                                    ${m.deliverables.map(d => `<span class="deliverable-tag">${d}</span>`).join('')}
                                </div>
                                <details class="milestone-metrics-details">
                                    <summary>Success Metrics & Gate</summary>
                                    <div class="milestone-metrics">
                                        ${m.metrics.map(metric => `
                                            <div class="metric-row">
                                                <span class="metric-name">${metric.name}</span>
                                                <span class="metric-target">${metric.target}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                    <div class="milestone-gate">${m.gate}</div>
                                </details>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </details>
            
            <!-- TEAM & CAPABILITIES - Collapsible (Conditionally shown/blinded) -->
            ${showTeam ? `
            <details class="section-details" open>
                <summary class="section-summary">
                    <span class="section-icon">👥</span>
                    <span class="section-title">Team & Project Lead</span>
                    <span class="section-hint">${project.lead?.name || 'Lead TBD'}</span>
                </summary>
                <div class="section-content">
                    <div class="assessment-subsection">
                        <h5>🎯 Project Lead</h5>
                        ${project.lead ? renderLeadCard(project.lead) : '<p style="color: var(--gray-500);">Project lead to be assigned.</p>'}
                    </div>
                    <div class="assessment-subsection" style="margin-top: 20px;">
                        <h5>📋 Capability Fit</h5>
                        <p>${project.capabilityFit || 'Capability assessment pending.'}</p>
                    </div>
                    <div class="assessment-subsection">
                        <h5>👨‍💻 Supporting Team</h5>
                        <div class="team-leads-grid">
                            ${renderTeamLeads(project.teamDetails)}
                        </div>
                    </div>
                </div>
            </details>
            ` : `
            <div class="blinded-section">
                <div class="blinded-icon">🎭</div>
                <div class="blinded-text">
                    <strong>Team Information Hidden</strong>
                    <span>You've chosen Blind Review — team details are not visible to reduce bias.</span>
                </div>
            </div>
            `}
            
            <!-- TECHNICAL & IP - Collapsible -->
            <details class="section-details">
                <summary class="section-summary">
                    <span class="section-icon">🔬</span>
                    <span class="section-title">Technical & IP Position</span>
                    <span class="section-hint">TRL ${project.trl?.current || '?'} → ${project.trl?.target || '?'} • ${project.ipPosition?.risk || 'Unknown'} IP Risk</span>
                </summary>
                <div class="section-content">
                    <div class="assessment-subsection">
                        <h5>Technology Readiness Level</h5>
                        <div class="trl-display">
                            <div class="trl-bar">
                                ${[1,2,3,4,5,6,7,8,9].map(level => `
                                    <div class="trl-level ${level <= project.trl?.current ? 'current' : ''} ${level <= project.trl?.target ? 'target' : ''}" title="TRL ${level}: ${trlDefinitions[level]?.name}">
                                        ${level}
                                    </div>
                                `).join('')}
                            </div>
                            <div class="trl-legend">
                                <span><span class="trl-dot current"></span> Current: TRL ${project.trl?.current || '?'}</span>
                                <span><span class="trl-dot target"></span> Target: TRL ${project.trl?.target || '?'}</span>
                            </div>
                            <p style="margin-top: 10px; font-size: 0.9em;">${project.trl?.note || ''}</p>
                        </div>
                    </div>
                    <div class="assessment-subsection">
                        <h5>Intellectual Property</h5>
                        <div class="fto-assessment ${project.ipPosition?.risk === 'High' ? 'high-risk' : project.ipPosition?.risk === 'Medium' || project.ipPosition?.risk === 'Medium-High' ? 'medium-risk' : 'low-risk'}">
                            <strong>Freedom to Operate:</strong> ${project.ipPosition?.fto || 'FTO review needed.'}
                            <span class="fto-risk-badge">${project.ipPosition?.risk || 'Unknown'} Risk</span>
                        </div>
                        <details class="info-details" style="margin-top: 10px;">
                            <summary>View IP Details</summary>
                            <div class="ip-grid">
                                <div class="ip-box">
                                    <div class="ip-box-header">🛡️ ShieldTech IP</div>
                                    <p>${project.ipPosition?.shieldtech || 'Assessment pending.'}</p>
                                </div>
                                <div class="ip-box">
                                    <div class="ip-box-header">🏢 Competitor IP</div>
                                    <p>${project.ipPosition?.competitors || 'Assessment pending.'}</p>
                                </div>
                            </div>
                        </details>
                    </div>
                </div>
            </details>
        `;
        } // End of else (careful mode)
        
        // Render scoring interface
        renderScoringInterface(project, criteria);
    }
    
    function renderTeamLeads(teamDetails) {
        if (!teamDetails || !teamDetails.leads) return '<p style="color: var(--gray-500);">Team assignment pending.</p>';
        
        return teamDetails.leads.map(lead => {
            const staff = lead.staffId ? findStaff(lead.staffId) : null;
            
            if (staff) {
                // Get initials for avatar fallback
                const initials = staff.name.split(' ').map(n => n[0]).join('');
                return `
                    <div class="team-lead-card">
                        <div class="team-lead-avatar" style="background: ${staff.avatarColor || '#003da5'}; color: white; font-weight: 600;">
                            ${initials}
                        </div>
                        <div class="team-lead-info">
                            <div class="team-lead-name">${staff.name}</div>
                            <div class="team-lead-role">${lead.role}</div>
                        </div>
                    </div>
                `;
            } else {
                return `
                    <div class="team-lead-card team-lead-vacancy">
                        <div class="team-lead-avatar">?</div>
                        <div class="team-lead-info">
                            <div class="team-lead-name">To Be Hired</div>
                            <div class="team-lead-role">${lead.role}</div>
                        </div>
                    </div>
                `;
            }
        }).join('');
    }
    
    function renderScoringInterface(project, criteria) {
        const criteriaInfo = {
            technical: { name: 'Technical Feasibility', question: 'Can we realistically build this?' },
            capability: { name: 'Capability Fit', question: 'Do we have the skills and resources?' },
            ip: { name: 'IP & Defensibility', question: 'Can we protect this innovation?' },
            strategic: { name: 'Strategic Fit', question: 'Does it align with board priorities?' },
            platform: { name: 'Platform Value', question: 'Does it strengthen our ecosystem?' },
            sustainability: { name: 'Sustainability', question: 'Does it create positive impact?' },
            marketsize: { name: 'Market Size', question: 'How big is the opportunity?' },
            newmarket: { name: 'New Market Creation', question: 'Does it open new segments?' },
            geographic: { name: 'Geographic Expansion', question: 'Does it expand our reach?' },
            competitive: { name: 'Competitive Differentiation', question: 'Will we stand out from rivals?' },
            devcost: { name: 'Development Cost', question: 'Is the investment reasonable?' },
            roi: { name: 'Expected ROI', question: 'Will we get a good return?' },
            speed: { name: 'Time to Market', question: 'Can we launch quickly?' },
            team: { name: 'Team Capability', question: 'Can the team deliver?' },
            risk: { name: 'Risk Profile', question: 'Are the risks manageable?' }
        };
        
        // 3-point scale: Weak (1), OK (3), Strong (5) - keeps same numerical range for calculations
        const scaleOptions = [
            { value: 1, label: 'Weak', icon: '👎', color: '#ef4444' },
            { value: 3, label: 'OK', icon: '👋', color: '#f59e0b' },
            { value: 5, label: 'Strong', icon: '👍', color: '#22c55e' }
        ];
        
        const scoringDiv = document.getElementById('assessment-scoring');
        scoringDiv.innerHTML = `
            <div class="scoring-title">Rate This Project on Your Criteria</div>
            <div class="scoring-criteria-list">
                ${criteria.map(c => {
                    const info = criteriaInfo[c] || { name: c, question: '' };
                    const currentScore = project.playerScores[c];
                    
                    return `
                        <div class="scoring-criterion">
                            <div class="criterion-info">
                                <div class="criterion-name">${info.name}</div>
                                <div class="criterion-question">${info.question}</div>
                            </div>
                            <div class="criterion-scale three-point">
                                ${scaleOptions.map(opt => `
                                    <button class="scale-btn ${currentScore === opt.value ? 'selected' : ''}" 
                                            style="--btn-color: ${opt.color}"
                                            onclick="scoreCurrentProject('${c}', ${opt.value})">
                                        <span class="scale-icon">${opt.icon}</span>
                                        <span class="scale-text">${opt.label}</span>
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
            ${isProjectFullyScored(project) ? '<div class="scoring-complete">✓ All criteria rated — ready to continue</div>' : ''}
        `;
    }
    
    function scoreCurrentProject(criterion, score) {
        const project = gameState.projectPool[gameState.currentAssessmentIndex];
        project.playerScores[criterion] = score;
        renderScoringInterface(project, gameState.criteria);
        renderProgressDots(); // Update progress dots when score changes
    }
    
    function isProjectFullyScored(project) {
        return gameState.criteria.every(c => project.playerScores[c] !== undefined);
    }
    
    function getProjectScoringStatus(project) {
        const scoredCount = gameState.criteria.filter(c => project.playerScores[c] !== undefined).length;
        const totalCriteria = gameState.criteria.length;
        
        if (scoredCount === 0) return 'unvisited';
        if (scoredCount === totalCriteria) return 'complete';
        return 'partial';
    }
    
    function renderProgressDots() {
        const container = document.getElementById('project-progress-dots');
        if (!container) return;
        
        const currentIndex = gameState.currentAssessmentIndex;
        
        container.innerHTML = `
            <div class="progress-dots-row">
                ${gameState.projectPool.map((project, index) => {
                    let status = getProjectScoringStatus(project);
                    if (index === currentIndex) status = 'current';
                    
                    const isComplete = isProjectFullyScored(project);
                    const displayText = isComplete && index !== currentIndex ? '✓' : (index + 1);
                    
                    return `
                        <div class="progress-dot ${status}" 
                             onclick="jumpToProject(${index})"
                             title="Project ${index + 1}: ${project.name}">
                            ${displayText}
                        </div>
                    `;
                }).join('')}
            </div>
            <div class="progress-legend">
                <div class="legend-item">
                    <div class="legend-dot unvisited"></div>
                    <span>Not scored</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot partial"></div>
                    <span>Partially scored</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot complete"></div>
                    <span>Complete</span>
                </div>
            </div>
        `;
    }
    
    function jumpToProject(index) {
        gameState.currentAssessmentIndex = index;
        renderCurrentProject();
        document.getElementById('phase-assessment').scrollIntoView({ behavior: 'smooth' });
    }
    
    function nextProject() {
        const total = gameState.projectPool.length;
        
        if (gameState.currentAssessmentIndex === total - 1) {
            // Last project - proceed to committee feedback
            showCommitteeFeedback();
        } else {
            gameState.currentAssessmentIndex++;
            renderCurrentProject();
            // Scroll to top of card
            document.getElementById('phase-assessment').scrollIntoView({ behavior: 'smooth' });
        }
    }
    
    function prevProject() {
        if (gameState.currentAssessmentIndex > 0) {
            gameState.currentAssessmentIndex--;
            renderCurrentProject();
            document.getElementById('phase-assessment').scrollIntoView({ behavior: 'smooth' });
        }
    }
    
    function scoreProject(projectId, criterion, score) {
        const project = gameState.projectPool.find(p => p.id === projectId);
        if (project) {
            project.playerScores[criterion] = score;
        }
    }
    
    function updateAssessmentProgress() {
        // Legacy function - no longer needed with new design
    }
    
    function generateCommitteeScores() {
        // Each committee member scores projects based on their expertise and biases
        const committee = gameState.committee;
        const criteria = gameState.criteria;
        
        gameState.projectPool.forEach(project => {
            project.committeeScores = {};
            
            committee.forEach(memberId => {
                const member = findStaff(memberId);
                if (!member) return;
                
                // Calculate member's score based on their effects and project scores
                let totalScore = 0;
                let weightSum = 0;
                
                criteria.forEach(c => {
                    const baseScore = project.scores[c] || 3;
                    let adjustedScore = baseScore;
                    
                    // Apply member's effects/biases
                    if (member.effects) {
                        // Check if member has relevant expertise
                        if (c === 'technical' && member.effects.technical) {
                            adjustedScore = baseScore * (member.effects.technical > 1 ? 1.1 : 0.9);
                        }
                        if (c === 'marketsize' && member.effects.market) {
                            adjustedScore = baseScore * (member.effects.market > 1 ? 1.1 : 0.9);
                        }
                        if (c === 'strategic' && member.effects.strategic) {
                            adjustedScore = baseScore * (member.effects.strategic > 1 ? 1.1 : 0.9);
                        }
                        if (c === 'team' && member.effects.team) {
                            adjustedScore = baseScore * (member.effects.team > 1 ? 1.1 : 0.9);
                        }
                        
                        // Apply archetype preferences
                        const archetypeEffects = {
                            'conventional_winner': member.effects.conventionalWinner || 1,
                            'hidden_gem': member.effects.hiddenGem || 1,
                            'slow_burner': member.effects.slowBurner || 1,
                            'paper_tiger': member.effects.paperTiger || 1
                        };
                        if (archetypeEffects[project.archetype]) {
                            adjustedScore *= archetypeEffects[project.archetype];
                        }
                    }
                    
                    // Add some randomness for personality
                    adjustedScore += (Math.random() - 0.5) * 0.8;
                    
                    totalScore += Math.max(1, Math.min(5, adjustedScore));
                    weightSum++;
                });
                
                // Member's overall score is average across criteria, with some variance
                const avgScore = totalScore / weightSum;
                project.committeeScores[memberId] = Math.round(Math.max(1, Math.min(5, avgScore)) * 10) / 10;
            });
        });
    }
    
    function showCommitteeFeedback() {
        // For jury mode, randomly select some staff to give feedback
        if (gameState.decisionModel === 'jury' && gameState.committee.length === 0) {
            // Pick 4-6 random staff members for the jury
            const allStaff = [
                ...staffDatabase.senior,
                ...staffDatabase.heads,
                ...staffDatabase.tech,
                ...staffDatabase.junior
            ];
            const shuffled = shuffleArray(allStaff);
            gameState.committee = shuffled.slice(0, 4 + Math.floor(Math.random() * 3)).map(s => s.id);
        }
        
        // Initialize triage state if needed
        if (!gameState.projectTriage) {
            gameState.projectTriage = {};
        }
        
        generateCommitteeScores();
        renderTriageCards();
        showPhase('committee-feedback');
    }
    
    function renderTriageCards() {
        const criteria = gameState.criteria;
        
        // Calculate average scores and rank projects
        const projectsWithScores = gameState.projectPool.map(project => {
            // Player's average score
            const playerScores = Object.values(project.playerScores);
            const playerAvg = playerScores.length > 0 
                ? playerScores.reduce((a, b) => a + b, 0) / playerScores.length 
                : 3;
            
            // Committee average
            const committeeScores = Object.values(project.committeeScores);
            const committeeAvg = committeeScores.length > 0 
                ? committeeScores.reduce((a, b) => a + b, 0) / committeeScores.length 
                : 3;
            
            // Overall average (player counts as one voice)
            const allScores = [playerAvg, ...committeeScores];
            const overallAvg = allScores.reduce((a, b) => a + b, 0) / allScores.length;
            
            // Calculate consensus (standard deviation)
            const variance = allScores.reduce((sum, s) => sum + Math.pow(s - overallAvg, 2), 0) / allScores.length;
            const stdDev = Math.sqrt(variance);
            
            return {
                ...project,
                playerAvg,
                committeeAvg,
                overallAvg,
                stdDev,
                highConsensus: stdDev < 0.6
            };
        });
        
        // Sort by overall average
        projectsWithScores.sort((a, b) => b.overallAvg - a.overallAvg);
        
        // Store ranked projects
        gameState.rankedProjects = projectsWithScores;
        
        // Auto-suggest triage based on scores (if not already set)
        projectsWithScores.forEach((project, index) => {
            if (!gameState.projectTriage[project.id]) {
                // Top third: suggest fund, middle third: marginal, bottom third: stop
                const percentile = index / projectsWithScores.length;
                if (percentile < 0.33) {
                    gameState.projectTriage[project.id] = 'marginal'; // Default to marginal to encourage thought
                } else if (percentile < 0.67) {
                    gameState.projectTriage[project.id] = 'marginal';
                } else {
                    gameState.projectTriage[project.id] = 'marginal';
                }
            }
        });
        
        // Render triage cards
        const grid = document.getElementById('triage-grid');
        grid.innerHTML = projectsWithScores.map((project, index) => {
            const rank = index + 1;
            const status = gameState.projectTriage[project.id] || 'marginal';
            
            return `
                <div class="triage-card status-${status}" data-project-id="${project.id}">
                    <div class="triage-card-header">
                        <div class="triage-card-rank">#${rank}</div>
                        <div class="triage-card-title">
                            <h4>${project.name}</h4>
                            <span class="tagline">${project.tagline}</span>
                        </div>
                        <div class="triage-card-budget">$${project.budget}M </div>
                    </div>
                    
                    <div class="triage-card-scores">
                        <div class="score-pill avg-score">
                            Avg: <strong>${project.overallAvg.toFixed(1)}</strong>
                        </div>
                        <div class="score-pill your-score">
                            You: <strong>${project.playerAvg.toFixed(1)}</strong>
                        </div>
                        ${!project.highConsensus ? `
                            <div class="score-pill consensus">
                                ⚠️ Views differ
                            </div>
                        ` : ''}
                    </div>
                    
                    ${project.lead && shouldShowTeamInfo() ? `
                    <div class="lead-link" onclick="openLeadModal('${project.lead.id}')" title="Click to view full CV" style="margin: 8px 0;">
                        <span class="lead-link-avatar" style="background: ${project.lead.avatarColor}20; color: ${project.lead.avatarColor};">${project.lead.initials}</span>
                        <span class="lead-link-name">${project.lead.name}</span>
                        <span class="lead-link-badge ${getLeadTrackScore(project.lead) >= 0.7 ? 'success' : getLeadTrackScore(project.lead) >= 0.5 ? 'warning' : 'danger'}">${Math.round(getLeadTrackScore(project.lead) * 100)}%</span>
                        <span class="lead-link-cta">View CV →</span>
                    </div>
                    ` : !shouldShowTeamInfo() ? `
                    <div class="lead-link blinded" style="margin: 8px 0;">
                        <span class="lead-link-avatar" style="background: #e0e7ff; color: #4338ca;">🎭</span>
                        <span class="lead-link-name" style="color: #6366f1;">Team info hidden</span>
                    </div>
                    ` : ''}
                    
                    <div class="triage-card-actions">
                        <button class="triage-btn fund-btn ${status === 'fund' ? 'active' : ''}" 
                                onclick="setTriage('${project.id}', 'fund')">
                            ✅ Fund
                        </button>
                        <button class="triage-btn marginal-btn ${status === 'marginal' ? 'active' : ''}" 
                                onclick="setTriage('${project.id}', 'marginal')">
                            ⚖️ Marginal
                        </button>
                        <button class="triage-btn stop-btn ${status === 'stop' ? 'active' : ''}" 
                                onclick="setTriage('${project.id}', 'stop')">
                            🚫 Stop
                        </button>
                        <button class="triage-btn info-btn" onclick="openProjectModal('${project.id}')">
                            ℹ️
                        </button>
                    </div>
                </div>
            `;
        }).join('');
        
        updateTriageSummary();
    }
    
    function setTriage(projectId, status) {
        gameState.projectTriage[projectId] = status;
        
        // Update card styling
        const card = document.querySelector(`.triage-card[data-project-id="${projectId}"]`);
        if (card) {
            card.className = `triage-card status-${status}`;
            card.querySelectorAll('.triage-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.classList.contains(`${status}-btn`)) {
                    btn.classList.add('active');
                }
            });
        }
        
        updateTriageSummary();
    }
    
    function updateTriageSummary() {
        const projects = gameState.rankedProjects || gameState.projectPool;
        
        let fundedCount = 0, marginalCount = 0, stopCount = 0;
        let fundedBudget = 0, marginalBudget = 0;
        
        projects.forEach(project => {
            const status = gameState.projectTriage[project.id] || 'marginal';
            if (status === 'fund') {
                fundedCount++;
                fundedBudget += project.budget;
            } else if (status === 'marginal') {
                marginalCount++;
                marginalBudget += project.budget;
            } else {
                stopCount++;
            }
        });
        
        // Update counts
        document.getElementById('count-fund').textContent = fundedCount;
        document.getElementById('count-marginal').textContent = marginalCount;
        document.getElementById('count-stop').textContent = stopCount;
        
        // Update budget bar
        const percentage = (fundedBudget / gameState.maxBudget) * 100;
        document.getElementById('triage-budget-fill').style.width = `${Math.min(100, percentage)}%`;
        document.getElementById('triage-funded-amount').textContent = `$${fundedBudget.toFixed(1)}M`;
        document.getElementById('triage-remaining-amount').textContent = `$${(gameState.maxBudget - fundedBudget).toFixed(1)}M`;
        document.getElementById('triage-marginal-amount').textContent = `$${marginalBudget.toFixed(1)}M`;
        
        // Check if over budget
        if (fundedBudget > gameState.maxBudget) {
            document.getElementById('triage-budget-fill').style.background = '#ef4444';
        } else {
            document.getElementById('triage-budget-fill').style.background = 'linear-gradient(90deg, #22c55e 0%, var(--primary) 100%)';
        }
    }
    
    // Legacy function - keep for compatibility
    function renderCommitteeFeedback() {
        renderTriageCards();
    }
    
    function showFinalSelection() {
        // Prevent budget reset if selection has already been locked
        if (gameState.year1SelectionLocked) {
            console.warn('Portfolio already locked - cannot reset budget');
            return;
        }
        
        gameState.selectedProjects = [];
        // Reset budget: Annual budget minus legacy commitments
        gameState.budget = gameState.maxBudget - (gameState.legacyBudgetCommitted || 0);
        renderProjectGrid();
        showPhase('selection');
    }
    
    // ============================================
    // PORTFOLIO BUILDER - 2x2 MATRIX VISUALIZATION
    // ============================================
    
    const matrixConfigs = {
        'risk-speed': {
            title: 'Speed vs Risk',
            xAxis: { label: 'Time to Market', min: 'Slower', max: 'Faster', key: 'speed' },
            yAxis: { label: 'Risk Level', min: 'Lower Risk', max: 'Higher Risk', key: 'risk' },
            quadrants: {
                q1: { label: 'Quick Wins', desc: 'Fast & risky - move quickly' },
                q2: { label: 'Big Bets', desc: 'Slow & risky - high uncertainty' },
                q3: { label: 'Safe & Steady', desc: 'Slow & safe - proven path' },
                q4: { label: 'Low Hanging Fruit', desc: 'Fast & safe - easy wins' }
            }
        },
        'market-tech': {
            title: 'Market vs Technology',
            xAxis: { label: 'Technology Novelty', min: 'Existing Tech', max: 'New Tech', key: 'technical' },
            yAxis: { label: 'Market Expansion', min: 'Existing Markets', max: 'New Markets', key: 'newmarket' },
            quadrants: {
                q1: { label: 'Breakthrough', desc: 'New tech, new markets' },
                q2: { label: 'Market Pioneer', desc: 'Existing tech, new markets' },
                q3: { label: 'Core Enhancement', desc: 'Existing tech, existing markets' },
                q4: { label: 'Tech Leadership', desc: 'New tech, existing markets' }
            }
        },
        'capability-strategic': {
            title: 'Capability vs Strategy',
            xAxis: { label: 'Capability Fit', min: 'New Capabilities', max: 'Core Strengths', key: 'capability' },
            yAxis: { label: 'Strategic Priority', min: 'Lower Priority', max: 'Board Priority', key: 'strategic' },
            quadrants: {
                q1: { label: 'Strategic Core', desc: 'High priority, leverages strengths' },
                q2: { label: 'Strategic Stretch', desc: 'High priority, needs new skills' },
                q3: { label: 'Exploration', desc: 'Lower priority, builds new capabilities' },
                q4: { label: 'Efficiency Plays', desc: 'Lower priority, uses existing skills' }
            }
        },
        'roi-cost': {
            title: 'ROI vs Investment',
            xAxis: { label: 'Development Cost', min: 'Lower Cost', max: 'Higher Cost', key: 'devcost' },
            yAxis: { label: 'Expected ROI', min: 'Lower ROI', max: 'Higher ROI', key: 'roi' },
            quadrants: {
                q1: { label: 'Premium Bets', desc: 'High ROI, high cost - flagship projects' },
                q2: { label: 'Stars', desc: 'High ROI, low cost - prioritise these' },
                q3: { label: 'Fillers', desc: 'Low ROI, low cost - opportunistic' },
                q4: { label: 'Question Marks', desc: 'Low ROI, high cost - reconsider' }
            }
        }
    };
    
    let currentMatrix = 'risk-speed';
    
    function showPortfolioBuilder() {
        // Prevent budget reset if selection has already been locked
        if (gameState.year1SelectionLocked) {
            console.warn('Portfolio already locked - cannot reset budget');
            return;
        }
        
        // Initialize selected projects based on triage
        gameState.selectedProjects = [];
        // Reset budget: Annual budget minus legacy commitments
        gameState.budget = gameState.maxBudget - (gameState.legacyBudgetCommitted || 0);
        
        // Auto-include funded projects
        const projects = gameState.rankedProjects || gameState.projectPool;
        projects.forEach(project => {
            const status = gameState.projectTriage[project.id];
            if (status === 'fund') {
                gameState.selectedProjects.push(project.id);
                gameState.budget -= project.budget;
            }
        });
        
        currentMatrix = 'risk-speed';
        currentPortfolioView = 'matrix';
        
        // Compute matrix positions for all projects
        computeProjectPositions();
        
        renderMatrix();
        renderPortfolioListView();
        updatePortfolioSidebar();
        showPhase('portfolio-builder');
    }
    
    let currentPortfolioView = 'matrix';
    
    function switchPortfolioView(view) {
        currentPortfolioView = view;
        
        document.querySelectorAll('.view-tab').forEach(tab => {
            tab.classList.toggle('active', tab.dataset.view === view);
        });
        
        document.getElementById('portfolio-matrix-view').classList.toggle('hidden', view !== 'matrix');
        document.getElementById('portfolio-list-view').classList.toggle('hidden', view !== 'list');
        
        if (view === 'list') {
            renderPortfolioListView();
        }
    }
    
    function switchMatrix(matrixType) {
        currentMatrix = matrixType;
        
        // Update tab UI
        document.querySelectorAll('.matrix-tab').forEach(tab => {
            tab.classList.toggle('active', tab.dataset.matrix === matrixType);
        });
        
        renderMatrix();
    }
    
    // Store computed positions so they're consistent
    let projectMatrixPositions = {};
    
    function computeProjectPositions() {
        // Clear previous positions
        projectMatrixPositions = {};
        
        const projects = gameState.rankedProjects || gameState.projectPool;
        
        // For each matrix type, compute positions based on project attributes
        projects.forEach((project, index) => {
            projectMatrixPositions[project.id] = {};
            
            // Use a seeded random based on project id for consistent jitter
            const seed = hashString(project.id);
            const jitterX = seededRandom(seed) * 15 - 7.5;
            const jitterY = seededRandom(seed + 1) * 15 - 7.5;
            
            // Risk-Speed: Use TRL and timeline
            const trlCurrent = project.trl?.current || 3;
            const speed = mapToRange(trlCurrent, 1, 9, 15, 85); // Higher TRL = faster
            const riskBase = project.criteriaScores?.risk || (6 - (project.baseSuccessRate || 70) / 20);
            const risk = mapToRange(riskBase, 1, 5, 15, 85);
            projectMatrixPositions[project.id]['risk-speed'] = {
                x: clamp(speed + jitterX, 8, 92),
                y: clamp(risk + jitterY, 8, 92)
            };
            
            // Market-Tech: Use archetype and market indicators
            const techNovelty = getTechNoveltyScore(project);
            const marketExpansion = getMarketExpansionScore(project);
            projectMatrixPositions[project.id]['market-tech'] = {
                x: clamp(techNovelty + jitterX, 8, 92),
                y: clamp(marketExpansion + jitterY, 8, 92)
            };
            
            // Capability-Strategic: Use capability fit and strategic alignment
            const capabilityFit = project.criteriaScores?.capability || getCapabilityScore(project);
            const strategicPriority = project.criteriaScores?.strategic || getStrategicScore(project);
            projectMatrixPositions[project.id]['capability-strategic'] = {
                x: clamp(mapToRange(capabilityFit, 1, 5, 15, 85) + jitterX, 8, 92),
                y: clamp(mapToRange(strategicPriority, 1, 5, 15, 85) + jitterY, 8, 92)
            };
            
            // ROI-Cost: Use budget and expected returns
            const costScore = mapToRange(project.budget, 2, 15, 15, 85); // Higher budget = higher cost
            const roiScore = project.criteriaScores?.roi || getROIScore(project);
            projectMatrixPositions[project.id]['roi-cost'] = {
                x: clamp(costScore + jitterX, 8, 92),
                y: clamp(mapToRange(roiScore, 1, 5, 15, 85) + jitterY, 8, 92)
            };
        });
    }
    
    function hashString(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash;
        }
        return Math.abs(hash);
    }
    
    function seededRandom(seed) {
        const x = Math.sin(seed) * 10000;
        return x - Math.floor(x);
    }
    
    function mapToRange(value, inMin, inMax, outMin, outMax) {
        return ((value - inMin) / (inMax - inMin)) * (outMax - outMin) + outMin;
    }
    
    function clamp(value, min, max) {
        return Math.max(min, Math.min(max, value));
    }
    
    function getTechNoveltyScore(project) {
        // Based on archetype and TRL
        const archetype = project.archetype || '';
        const trl = project.trl?.current || 5;
        
        let base = 50;
        if (archetype.includes('platform') || archetype.includes('moonshot')) base = 75;
        else if (archetype.includes('incremental') || archetype.includes('cost')) base = 25;
        else if (archetype.includes('adjacent')) base = 55;
        else if (archetype.includes('ip') || archetype.includes('tech')) base = 70;
        
        // Lower TRL = more novel tech
        const trlAdjust = (5 - trl) * 5;
        return mapToRange(base + trlAdjust, 0, 100, 15, 85);
    }
    
    function getMarketExpansionScore(project) {
        // Based on strategic buckets and archetype
        const buckets = project.strategicBuckets || [];
        const bucketIds = buckets.map(b => b.id).join(' ');
        
        let score = 50;
        if (bucketIds.includes('ai-first')) score = 80;
        else if (bucketIds.includes('tier23-rollout')) score = 70;
        else if (bucketIds.includes('defend-metro')) score = 25;
        else if (bucketIds.includes('recurring-revenue')) score = 60;
        
        return mapToRange(score, 0, 100, 15, 85);
    }
    
    function getCapabilityScore(project) {
        // Higher TRL and familiar archetype = better capability fit
        const trl = project.trl?.current || 5;
        const archetype = project.archetype || '';
        
        let base = 3;
        if (archetype.includes('incremental') || archetype.includes('derivative')) base = 4.5;
        else if (archetype.includes('moonshot') || archetype.includes('pivot')) base = 1.5;
        else if (archetype.includes('platform')) base = 2.5;
        
        // Higher TRL = better capability fit
        const trlBonus = (trl - 3) * 0.2;
        return clamp(base + trlBonus, 1, 5);
    }
    
    function getStrategicScore(project) {
        // Based on strategic buckets
        const buckets = project.strategicBuckets || [];
        if (buckets.length === 0) return 3;
        
        // Having a bucket = strategic alignment
        let score = 3.5;
        
        // Certain buckets are higher priority
        const bucketIds = buckets.map(b => b.id).join(' ');
        if (bucketIds.includes('defend-metro')) score += 0.5;
        if (bucketIds.includes('recurring-revenue')) score += 0.3;
        
        return clamp(score, 1, 5);
    }
    
    function getROIScore(project) {
        // Based on financials and success rate
        const successRate = project.baseSuccessRate || 65;
        const margin = parseFloat(project.financials?.grossMargin) || 40;
        
        let score = 3;
        if (successRate > 75) score += 0.8;
        else if (successRate < 55) score -= 0.8;
        
        if (margin > 50) score += 0.5;
        else if (margin < 30) score -= 0.5;
        
        return clamp(score, 1, 5);
    }
    
    function getProjectMatrixScore(project, key, axis) {
        // Use pre-computed positions
        const pos = projectMatrixPositions[project.id]?.[currentMatrix];
        if (pos) {
            return axis === 'x' ? pos.x : pos.y;
        }
        // Fallback
        return 50;
    }
    
    function renderMatrix() {
        const config = matrixConfigs[currentMatrix];
        const container = document.getElementById('matrix-container');
        const projects = gameState.rankedProjects || gameState.projectPool;
        
        // Build quadrant labels
        const quadrantsHtml = `
            <div class="matrix-quadrant q1"><div class="quadrant-label">${config.quadrants.q1.label}</div></div>
            <div class="matrix-quadrant q2"><div class="quadrant-label">${config.quadrants.q2.label}</div></div>
            <div class="matrix-quadrant q3"><div class="quadrant-label">${config.quadrants.q3.label}</div></div>
            <div class="matrix-quadrant q4"><div class="quadrant-label">${config.quadrants.q4.label}</div></div>
        `;
        
        // Build axes
        const axesHtml = `
            <div class="matrix-axis horizontal"></div>
            <div class="matrix-axis vertical"></div>
            <div class="axis-label x-min">${config.xAxis.min}</div>
            <div class="axis-label x-max">${config.xAxis.max}</div>
            <div class="axis-label y-min">${config.yAxis.min}</div>
            <div class="axis-label y-max">${config.yAxis.max}</div>
        `;
        
        // Build project bubbles with triage status
        const bubblesHtml = projects.map(project => {
            const triageStatus = gameState.projectTriage[project.id] || 'marginal';
            const isSelected = gameState.selectedProjects.includes(project.id);
            const canAfford = isSelected || project.budget <= gameState.budget;
            
            // Get positions (0-100) from pre-computed positions
            const xPos = getProjectMatrixScore(project, config.xAxis.key, 'x');
            const yPos = 100 - getProjectMatrixScore(project, config.yAxis.key, 'y'); // Invert Y
            
            // Size based on budget (40-75px for better mobile touch targets)
            const minBudget = 2, maxBudget = 15;
            const budgetNorm = (project.budget - minBudget) / (maxBudget - minBudget);
            const size = 40 + budgetNorm * 35;
            
            // Determine bubble class based on triage status
            let statusClass;
            let clickable = true;
            
            if (triageStatus === 'fund') {
                statusClass = 'funded';
                clickable = false; // Funded projects are locked
            } else if (triageStatus === 'stop') {
                statusClass = 'stopped';
                clickable = false; // Stopped projects are locked
            } else {
                // Marginal - can toggle
                if (isSelected) {
                    statusClass = 'marginal-in';
                } else if (canAfford) {
                    statusClass = 'marginal-out';
                } else {
                    statusClass = 'unaffordable';
                    clickable = false;
                }
            }
            
            const avgScore = project.overallAvg ? project.overallAvg.toFixed(1) : '?';
            
            return `
                <div class="project-bubble ${statusClass}" 
                     style="left: calc(${xPos}% - ${size/2}px); top: calc(${yPos}% - ${size/2}px); width: ${size}px; height: ${size}px;"
                     onclick="${clickable ? `togglePortfolioProject('${project.id}')` : ''}"
                     data-project-id="${project.id}">
                    <div class="bubble-tooltip">
                        <div class="tooltip-name">${project.name}</div>
                        <div class="tooltip-budget">$${project.budget}M • Score: ${avgScore}</div>
                        <div style="font-size: 0.85em; margin-top: 4px; opacity: 0.8;">
                            ${triageStatus === 'fund' ? '✅ Funded (locked)' : 
                              triageStatus === 'stop' ? '🚫 Stopped' : 
                              isSelected ? '⚖️ Marginal (in portfolio)' : '⚖️ Marginal (available)'}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = quadrantsHtml + axesHtml + bubblesHtml;
    }
    
    function renderPortfolioListView() {
        const projects = gameState.rankedProjects || gameState.projectPool;
        
        const funded = projects.filter(p => gameState.projectTriage[p.id] === 'fund');
        const marginal = projects.filter(p => gameState.projectTriage[p.id] === 'marginal' || !gameState.projectTriage[p.id]);
        const stopped = projects.filter(p => gameState.projectTriage[p.id] === 'stop');
        
        // Render funded list
        document.getElementById('portfolio-funded-list').innerHTML = funded.length === 0 
            ? '<div style="color: var(--gray-400); font-style: italic; padding: 10px;">No projects marked as funded</div>'
            : funded.map((project, i) => renderListItem(project, i, 'fund')).join('');
        
        // Render marginal list
        document.getElementById('portfolio-marginal-list').innerHTML = marginal.length === 0
            ? '<div style="color: var(--gray-400); font-style: italic; padding: 10px;">No marginal projects</div>'
            : marginal.map((project, i) => renderListItem(project, i, 'marginal')).join('');
        
        // Render stopped list
        document.getElementById('portfolio-stopped-list').innerHTML = stopped.length === 0
            ? '<div style="color: var(--gray-400); font-style: italic; padding: 10px;">No projects stopped</div>'
            : stopped.map((project, i) => renderListItem(project, i, 'stop')).join('');
    }
    
    function renderListItem(project, index, triageStatus) {
        const isSelected = gameState.selectedProjects.includes(project.id);
        const canAfford = project.budget <= gameState.budget;
        const rank = gameState.rankedProjects ? gameState.rankedProjects.findIndex(p => p.id === project.id) + 1 : index + 1;
        const avgScore = project.overallAvg ? project.overallAvg.toFixed(1) : '?';
        const yourScore = project.playerAvg ? project.playerAvg.toFixed(1) : '?';
        
        const isMarginal = triageStatus === 'marginal';
        const showToggle = isMarginal && (isSelected || canAfford);
        
        // Lead info
        const leadHtml = project.lead ? `
            <div class="item-lead" onclick="event.stopPropagation(); openLeadModal('${project.lead.id}')" title="Click to view CV">
                <span class="item-lead-avatar" style="background: ${project.lead.avatarColor}20; color: ${project.lead.avatarColor};">${project.lead.initials}</span>
                <span class="item-lead-name">${project.lead.name.split(' ')[0]}</span>
                <span class="item-lead-score ${getLeadTrackScore(project.lead) >= 0.7 ? 'success' : getLeadTrackScore(project.lead) >= 0.5 ? 'warning' : 'danger'}">${Math.round(getLeadTrackScore(project.lead) * 100)}%</span>
            </div>
        ` : '';
        
        return `
            <div class="portfolio-list-item ${isSelected ? 'in-portfolio' : ''}" data-project-id="${project.id}">
                <div class="item-rank">#${rank}</div>
                <div class="item-info">
                    <div class="item-name">${project.name}</div>
                    <div class="item-scores">Avg: ${avgScore} • You: ${yourScore}</div>
                </div>
                ${leadHtml}
                <div class="item-budget">$${project.budget}M </div>
                ${showToggle ? `
                    <button class="item-toggle ${isSelected ? 'remove' : 'add'}" 
                            onclick="togglePortfolioProject('${project.id}')">
                        ${isSelected ? '− Remove' : '+ Add'}
                    </button>
                ` : ''}
                <button class="item-details" onclick="openProjectModal('${project.id}')">
                    Details
                </button>
            </div>
        `;
    }
    
    function togglePortfolioProject(projectId) {
        const project = gameState.projectPool.find(p => p.id === projectId);
        if (!project) return;
        
        // Only allow toggling marginal projects
        const triageStatus = gameState.projectTriage[projectId];
        if (triageStatus === 'fund' || triageStatus === 'stop') {
            return; // Locked
        }
        
        const index = gameState.selectedProjects.indexOf(projectId);
        
        if (index > -1) {
            // Remove from portfolio
            gameState.selectedProjects.splice(index, 1);
            gameState.budget += project.budget;
        } else {
            // Check if can afford
            if (project.budget > gameState.budget) {
                // Show feedback that can't afford
                return;
            }
            // Add to portfolio
            gameState.selectedProjects.push(projectId);
            gameState.budget -= project.budget;
        }
        
        renderMatrix();
        renderPortfolioListView();
        updatePortfolioSidebar();
    }
    
    function updatePortfolioSidebar() {
        // Calculate budget breakdown
        const legacyCommitted = gameState.legacyBudgetCommitted || 0;
        const availableForNew = gameState.maxBudget - legacyCommitted;
        
        // Calculate spending on new projects only
        const newProjectSpending = gameState.selectedProjects.reduce((sum, projectId) => {
            const project = (gameState.rankedProjects || gameState.projectPool).find(p => p.id === projectId);
            return sum + (project?.budget || 0);
        }, 0);
        
        const remainingBudget = availableForNew - newProjectSpending;
        const percentageUsed = availableForNew > 0 ? (newProjectSpending / availableForNew) * 100 : 0;
        
        // Update budget breakdown display
        const breakdownEl = document.getElementById('budget-breakdown');
        if (breakdownEl) {
            let breakdownHtml = `
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                    <span>Annual Budget:</span>
                    <strong>$${gameState.maxBudget.toFixed(1)}M </strong>
                </div>`;
            
            if (legacyCommitted > 0) {
                breakdownHtml += `
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px; color: var(--warning);">
                    <span>Legacy Commitments:</span>
                    <strong>-$${legacyCommitted.toFixed(1)}M </strong>
                </div>`;
            }
            
            breakdownHtml += `
                <div style="display: flex; justify-content: space-between; padding-top: 6px; border-top: 1px solid var(--gray-200); color: var(--primary); font-weight: 600;">
                    <span>Available for New:</span>
                    <span>$${availableForNew.toFixed(1)}M </span>
                </div>`;
            
            breakdownEl.innerHTML = breakdownHtml;
        }
        
        // Update budget meter (shows new project spending as % of available)
        document.getElementById('portfolio-budget-fill').style.width = `${Math.min(100, percentageUsed)}%`;
        document.getElementById('portfolio-budget-spent').textContent = `$${newProjectSpending.toFixed(1)}M spent`;
        document.getElementById('portfolio-budget-total').textContent = `/ $${availableForNew.toFixed(1)}M available`;
        document.getElementById('portfolio-project-count').textContent = gameState.selectedProjects.length;
        
        // Warn if over budget
        const fillEl = document.getElementById('portfolio-budget-fill');
        if (newProjectSpending > availableForNew) {
            fillEl.style.background = 'var(--danger)';
        } else if (percentageUsed > 90) {
            fillEl.style.background = 'var(--warning)';
        } else {
            fillEl.style.background = 'linear-gradient(90deg, var(--primary) 0%, var(--gold) 100%)';
        }
        
        // Update strategic buckets
        const bucketCounts = {};
        const allBuckets = [
            { id: 'defend-metro', name: 'Defend Metro Leadership', icon: '🛡️', color: '#2563eb' },
            { id: 'tier23-rollout', name: 'Tier 2/3 Rollout', icon: '🗺️', color: '#059669' },
            { id: 'recurring-revenue', name: 'Recurring Revenue', icon: '💳', color: '#7c3aed' },
            { id: 'ai-first', name: 'AI-First Products', icon: '🤖', color: '#dc2626' }
        ];
        
        allBuckets.forEach(b => bucketCounts[b.id] = 0);
        
        gameState.selectedProjects.forEach(projectId => {
            const project = gameState.projectPool.find(p => p.id === projectId);
            if (project?.strategicBuckets) {
                project.strategicBuckets.forEach(bucket => {
                    // Match to our buckets by id
                    if (bucket.id && bucketCounts.hasOwnProperty(bucket.id)) {
                        bucketCounts[bucket.id]++;
                    }
                });
            }
        });
        
        const bucketsHtml = allBuckets.map(bucket => `
            <div class="portfolio-bucket-item">
                <span class="bucket-icon">${bucket.icon}</span>
                <span class="bucket-name">${bucket.name}</span>
                <span class="bucket-count ${bucketCounts[bucket.id] > 0 ? 'filled' : ''}">${bucketCounts[bucket.id]}</span>
            </div>
        `).join('');
        
        document.getElementById('portfolio-buckets-summary').innerHTML = bucketsHtml;
        
        // Render project scores list
        renderPortfolioScoresList();
        
        // Enable/disable confirm button - must have projects AND not be over budget
        const isOverBudget = newProjectSpending > availableForNew;
        document.getElementById('confirm-portfolio-btn').disabled = gameState.selectedProjects.length === 0 || isOverBudget;
        
        // Update button text if over budget
        const confirmBtn = document.getElementById('confirm-portfolio-btn');
        if (isOverBudget) {
            confirmBtn.textContent = '⚠️ Over Budget - Remove Projects';
        } else {
            confirmBtn.textContent = 'Confirm Portfolio →';
        }
    }
    
    function renderPortfolioScoresList() {
        const projects = gameState.rankedProjects || gameState.projectPool;
        const container = document.getElementById('portfolio-scores-list');
        if (!container) return;
        
        container.innerHTML = projects.map((project, index) => {
            const triageStatus = gameState.projectTriage[project.id] || 'marginal';
            const isSelected = gameState.selectedProjects.includes(project.id);
            const isFunded = triageStatus === 'fund';
            const isStopped = triageStatus === 'stop';
            
            const avgScore = project.overallAvg ? project.overallAvg.toFixed(1) : '?';
            const yourScore = project.playerAvg ? project.playerAvg.toFixed(1) : '?';
            
            let statusIcon = '';
            if (isFunded) statusIcon = '✅';
            else if (isStopped) statusIcon = '🚫';
            else if (isSelected) statusIcon = '⚖️';
            
            let rowClass = 'score-row';
            if (isFunded) rowClass += ' is-funded';
            else if (isStopped) rowClass += ' is-stopped';
            else if (isSelected) rowClass += ' in-portfolio';
            
            return `
                <div class="${rowClass}" onclick="openProjectModal('${project.id}')" data-project-id="${project.id}">
                    <div class="score-row-rank">${index + 1}</div>
                    <div class="score-row-info">
                        <div class="score-row-name">${project.name}</div>
                        <div class="score-row-meta">$${project.budget}M </div>
                    </div>
                    <div class="score-row-scores">
                        <span class="score-badge avg">${avgScore}</span>
                        <span class="score-badge you">${yourScore}</span>
                    </div>
                    <div class="score-row-status">${statusIcon}</div>
                </div>
            `;
        }).join('');
    }
    
    function confirmPortfolio() {
        // Start quarterly reviews with selected portfolio
        if (gameState.selectedProjects.length === 0) {
            SoundManager.play('error');
            alert('Please select at least one project for your portfolio.');
            return;
        }
        // Lock the Year 1 selection to prevent budget manipulation
        gameState.year1SelectionLocked = true;
        SoundManager.play('levelup');
        startQuarterlyReviews();
    }
    
    function renderProjectGrid() {
        const grid = document.getElementById('project-grid');
        
        // Use ranked projects if available, otherwise use projectPool
        const projects = gameState.rankedProjects || gameState.projectPool;
        
        grid.innerHTML = projects.map((project, index) => {
            const isSelected = gameState.selectedProjects.includes(project.id);
            const canAfford = project.budget <= gameState.budget;
            const isLocked = !isSelected && !canAfford;
            const rank = gameState.rankedProjects ? index + 1 : null;
            
            const bucketsHtml = (project.strategicBuckets || []).map(bucket => `
                <span style="display: inline-block; background: ${bucket.color}20; color: ${bucket.color}; padding: 2px 8px; border-radius: 10px; font-size: 0.7em; font-weight: 500;">
                    ${bucket.icon} ${bucket.name}
                </span>
            `).join('');
            
            return `
                <div class="project-card ${isSelected ? 'selected' : ''} ${isLocked ? 'locked' : ''}" data-id="${project.id}">
                    ${rank ? `<div style="position: absolute; top: -10px; left: -10px; background: var(--primary); color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85em;">#${rank}</div>` : ''}
                    <div class="project-header" style="margin-left: ${rank ? '20px' : '0'};">
                        <span class="project-name">${project.name}</span>
                        <span class="project-budget">$${project.budget}M </span>
                    </div>
                    <div class="project-tagline">${project.tagline || ''}</div>
                    <div style="margin: 8px 0;">${bucketsHtml}</div>
                    ${project.overallAvg ? `
                        <div style="display: flex; gap: 10px; margin-bottom: 10px; font-size: 0.85em;">
                            <span style="background: var(--gray-100); padding: 4px 8px; border-radius: 4px;">
                                Avg: <strong>${project.overallAvg.toFixed(1)}</strong>
                            </span>
                            <span style="background: var(--primary-lighter); padding: 4px 8px; border-radius: 4px;">
                                You: <strong>${project.playerAvg.toFixed(1)}</strong>
                            </span>
                            ${!project.highConsensus ? '<span style="color: var(--warning);">⚠️ Views differ</span>' : ''}
                        </div>
                    ` : ''}
                    <div class="project-desc">${project.shortDesc || project.desc}</div>
                    <div class="project-card-actions">
                        <button class="project-learn-more" onclick="openProjectModal('${project.id}')">Learn More</button>
                        <button class="project-select-btn ${isSelected ? 'selected' : ''}" 
                                onclick="toggleProject('${project.id}')" 
                                ${isLocked ? 'disabled' : ''}>
                            ${isSelected ? '✓ Selected' : isLocked ? 'Over Budget' : 'Select'}
                        </button>
                    </div>
                </div>
            `;
        }).join('');
        
        updateBudgetDisplay();
        updateStrategicBalance();
    }
    
    function updateStrategicBalance() {
        const balanceDiv = document.getElementById('strategic-balance');
        if (!balanceDiv) return;
        
        const projects = gameState.rankedProjects || gameState.projectPool;
        const selectedProjects = projects.filter(p => gameState.selectedProjects.includes(p.id));
        
        // Count projects per bucket
        const bucketCounts = {};
        Object.values(strategicBuckets).forEach(bucket => {
            bucketCounts[bucket.id] = 0;
        });
        
        selectedProjects.forEach(project => {
            (project.strategicBuckets || []).forEach(bucket => {
                bucketCounts[bucket.id]++;
            });
        });
        
        // Render balance display
        balanceDiv.innerHTML = '<div style="width: 100%; margin-bottom: 8px; font-weight: 600; color: var(--gray-600);">Strategic Balance:</div>' +
            Object.values(strategicBuckets).map(bucket => {
                const count = bucketCounts[bucket.id];
                const hasProjects = count > 0;
                return `
                    <div style="display: flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 20px; 
                                background: ${hasProjects ? bucket.color + '20' : 'var(--gray-100)'}; 
                                color: ${hasProjects ? bucket.color : 'var(--gray-400)'}; 
                                border: 1px solid ${hasProjects ? bucket.color + '40' : 'var(--gray-200)'};">
                        <span>${bucket.icon}</span>
                        <span style="font-size: 0.85em;">${bucket.name}</span>
                        <span style="font-weight: 700; margin-left: 4px;">${count}</span>
                    </div>
                `;
            }).join('');
    }
    
    function openProjectModal(projectId, context = 'year1') {
        // Find project in Year 1 pools, Year 2 pools, or active projects
        const year1Projects = gameState.rankedProjects || gameState.projectPool || [];
        const year2Projects = year2RankedProjects || [];
        const activeProjects = gameState.activeProjects || [];
        
        let project = year1Projects.find(p => p.id === projectId);
        if (!project) project = year2Projects.find(p => p.id === projectId);
        if (!project) project = activeProjects.find(p => p.id === projectId);
        if (!project) return;
        
        gameState.currentModalProject = projectId;
        gameState.currentModalContext = context; // 'year1', 'year2', or 'ongoing'
        
        document.getElementById('project-modal-name').textContent = project.name;
        document.getElementById('project-modal-tagline').textContent = project.tagline || '';
        document.getElementById('project-modal-budget').textContent = `$${project.budget}M`;
        document.getElementById('project-modal-desc').textContent = project.fullDesc || project.desc;
        document.getElementById('project-modal-market').textContent = project.marketContext || 'Market analysis pending.';
        document.getElementById('project-modal-capability').textContent = project.capabilityFit || 'Capability assessment pending.';
        
        // Render Development Costs
        const devCosts = project.developmentCosts || {};
        document.getElementById('project-modal-dev-costs').innerHTML = `
            <div class="dev-costs-grid">
                <div class="dev-cost-item total">
                    <div class="dev-cost-amount">$${devCosts.total || project.budget}M </div>
                    <div class="dev-cost-label">Total Budget</div>
                </div>
                <div class="dev-cost-item">
                    <div class="dev-cost-amount">$${devCosts.personnel?.amount || '?'}M </div>
                    <div class="dev-cost-label">Personnel</div>
                    <div class="dev-cost-pct">${devCosts.personnel?.pct || '?'}%</div>
                </div>
                <div class="dev-cost-item">
                    <div class="dev-cost-amount">$${devCosts.hardware?.amount || '?'}M </div>
                    <div class="dev-cost-label">Hardware/Components</div>
                    <div class="dev-cost-pct">${devCosts.hardware?.pct || '?'}%</div>
                </div>
                <div class="dev-cost-item">
                    <div class="dev-cost-amount">$${devCosts.software?.amount || '?'}M </div>
                    <div class="dev-cost-label">Software/Tools</div>
                    <div class="dev-cost-pct">${devCosts.software?.pct || '?'}%</div>
                </div>
                <div class="dev-cost-item">
                    <div class="dev-cost-amount">$${devCosts.external?.amount || '?'}M </div>
                    <div class="dev-cost-label">External/Legal</div>
                    <div class="dev-cost-pct">${devCosts.external?.pct || '?'}%</div>
                </div>
                <div class="dev-cost-item">
                    <div class="dev-cost-amount">$${devCosts.contingency?.amount || '?'}M </div>
                    <div class="dev-cost-label">Contingency</div>
                    <div class="dev-cost-pct">${devCosts.contingency?.pct || '?'}%</div>
                </div>
            </div>
        `;
        
        // Render Milestones
        const milestonesData = project.milestones || { totalDuration: '12 months', milestones: [] };
        const milestonesList = milestonesData.milestones || [];
        document.getElementById('project-modal-milestones').innerHTML = `
            <div class="milestones-header">
                <span class="total-duration">📅 Total Duration: <strong>${milestonesData.totalDuration}</strong></span>
            </div>
            <div class="milestones-summary">
                ${milestonesList.map((m, i) => `
                    <div class="milestone-summary-item">
                        <div class="milestone-summary-phase">${m.quarters}</div>
                        <div class="milestone-summary-duration">${m.phase.split(': ')[1] || m.phase}</div>
                        <div class="milestone-summary-cost">$${m.costAmount}M </div>
                    </div>
                `).join('')}
            </div>
            <div class="milestones-timeline">
                ${milestonesList.map(m => `
                    <div class="milestone-item">
                        <div class="milestone-header">
                            <div class="milestone-phase">${m.phase}</div>
                            <div class="milestone-meta">
                                <span>📆 ${m.quarters}</span>
                                <span>⏱️ ${m.duration}</span>
                                <span>💰 $${m.costAmount}M </span>
                            </div>
                        </div>
                        <div class="milestone-deliverables">
                            <div class="milestone-deliverables-title">Key Deliverables</div>
                            ${(m.deliverables || []).map(d => `<span class="deliverable-tag">${d}</span>`).join('') || '<span class="deliverable-tag">TBD</span>'}
                        </div>
                        <details class="milestone-metrics-details">
                            <summary>Success Metrics & Gate</summary>
                            <div class="milestone-metrics">
                                ${(m.metrics || []).map(metric => `
                                    <div class="metric-row">
                                        <span class="metric-name">${metric.name}</span>
                                        <span class="metric-target">${metric.target}</span>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="milestone-gate">${m.gate || 'Gate criteria TBD'}</div>
                        </details>
                    </div>
                `).join('')}
            </div>
        `;
        
        // Render TRL
        const trl = project.trl || { current: 5, target: 8, note: '' };
        document.getElementById('project-modal-trl').innerHTML = `
            <div class="trl-display">
                <div class="trl-bar">
                    ${[1,2,3,4,5,6,7,8,9].map(level => `
                        <div class="trl-level ${level <= trl.current ? 'current' : ''} ${level <= trl.target ? 'target' : ''}" title="TRL ${level}">
                            ${level}
                        </div>
                    `).join('')}
                </div>
                <div class="trl-legend">
                    <span><span class="trl-dot current"></span> Current: TRL ${trl.current}</span>
                    <span><span class="trl-dot target"></span> Target: TRL ${trl.target}</span>
                </div>
                <p style="margin-top: 10px; font-size: 0.9em;">${trl.note}</p>
            </div>
        `;
        
        // Render IP Position
        const ip = project.ipPosition || {};
        const ipRiskClass = ip.risk === 'High' ? 'high-risk' : (ip.risk === 'Medium' || ip.risk === 'Medium-High') ? 'medium-risk' : 'low-risk';
        document.getElementById('project-modal-ip').innerHTML = `
            <div class="ip-grid">
                <div class="ip-box">
                    <div class="ip-box-header">🛡️ ShieldTech IP</div>
                    <p>${ip.shieldtech || 'Assessment pending.'}</p>
                </div>
                <div class="ip-box">
                    <div class="ip-box-header">🏢 Competitor IP</div>
                    <p>${ip.competitors || 'Assessment pending.'}</p>
                </div>
            </div>
            <div class="fto-assessment ${ipRiskClass}">
                <strong>Freedom to Operate:</strong> ${ip.fto || 'FTO review needed.'}
                <span class="fto-risk-badge">${ip.risk || 'Unknown'} Risk</span>
            </div>
        `;
        
        // Render Competitors
        const comps = project.competitors || [];
        document.getElementById('project-modal-competitors').innerHTML = comps.length > 0 ? `
            <div class="competitors-grid">
                ${comps.map(comp => `
                    <div class="competitor-card threat-${(comp.threat || 'unknown').toLowerCase().replace(' ', '-')}">
                        <div class="competitor-name">${comp.name}</div>
                        <div class="competitor-position">${comp.position}</div>
                        <div class="competitor-threat">Threat: <strong>${comp.threat}</strong></div>
                    </div>
                `).join('')}
            </div>
        ` : '<p>Competitor analysis pending.</p>';
        
        // Render strategic buckets
        const bucketsHtml = (project.strategicBuckets || []).map(bucket => `
            <span class="strategic-bucket" style="background: ${bucket.color}20; color: ${bucket.color}; border: 1px solid ${bucket.color}40;">
                ${bucket.icon} ${bucket.name}
            </span>
        `).join('');
        document.getElementById('project-modal-buckets').innerHTML = bucketsHtml;
        
        // Render detailed team information (respects blinding setting)
        const teamDetails = project.teamDetails;
        if (shouldShowTeamInfo()) {
            // Show team info normally
            if (teamDetails) {
                let teamHtml = '';
                
                // Project Lead - primary responsibility
                if (project.lead) {
                    teamHtml += '<div style="margin-bottom: 20px;">';
                    teamHtml += '<div style="margin-bottom: 10px;"><strong>🎯 Project Lead:</strong></div>';
                    teamHtml += renderLeadCard(project.lead);
                    teamHtml += '</div>';
                }
                
                // Team leads - using initials instead of images
                teamHtml += '<div style="margin-bottom: 15px;"><strong>👨‍💻 Supporting Team Leads:</strong></div>';
                teamHtml += '<div class="team-leads-grid" style="margin-bottom: 20px;">';
                teamDetails.leads.forEach(lead => {
                    const staff = lead.staffId ? findStaff(lead.staffId) : null;
                    if (staff) {
                        const initials = staff.name.split(' ').map(n => n[0]).join('');
                        teamHtml += `
                            <div class="team-lead-card">
                                <div class="team-lead-avatar" style="background: ${staff.avatarColor || '#003da5'}; color: white; font-weight: 600;">
                                    ${initials}
                                </div>
                                <div class="team-lead-info">
                                    <div class="team-lead-name">${staff.name}</div>
                                    <div class="team-lead-role">${lead.role}</div>
                                </div>
                            </div>
                        `;
                    } else {
                        teamHtml += `
                            <div class="team-lead-card team-lead-vacancy">
                                <div class="team-lead-avatar">?</div>
                                <div class="team-lead-info">
                                    <div class="team-lead-name">To Be Hired</div>
                                    <div class="team-lead-role">${lead.role}</div>
                                </div>
                            </div>
                        `;
                    }
                });
                teamHtml += '</div>';
                
                // Headcount
                const hc = teamDetails.headcount;
                teamHtml += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-bottom: 15px;">';
                teamHtml += `<div style="background: var(--info-light); padding: 10px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 1.2em; font-weight: 700; color: var(--info);">${hc.engineers}</div>
                    <div style="font-size: 0.75em; color: var(--gray-500);">Engineers</div>
                </div>`;
                teamHtml += `<div style="background: var(--info-light); padding: 10px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 1.2em; font-weight: 700; color: var(--info);">${hc.product}</div>
                    <div style="font-size: 0.75em; color: var(--gray-500);">Product</div>
                </div>`;
                teamHtml += `<div style="background: var(--info-light); padding: 10px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 1.2em; font-weight: 700; color: var(--info);">${hc.design || 1}</div>
                    <div style="font-size: 0.75em; color: var(--gray-500);">Design</div>
                </div>`;
                teamHtml += `<div style="background: var(--info-light); padding: 10px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 1.2em; font-weight: 700; color: var(--info);">${hc.qa}</div>
                    <div style="font-size: 0.75em; color: var(--gray-500);">QA</div>
                </div>`;
                teamHtml += `<div style="background: var(--primary-lighter); padding: 10px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 1.2em; font-weight: 700; color: var(--primary);">${hc.total}</div>
                    <div style="font-size: 0.75em; color: var(--gray-500);">Total FTE</div>
                </div>`;
                teamHtml += '</div>';
                
                // Skills needed
                teamHtml += '<div style="margin-bottom: 15px;"><strong>Key Skills Required:</strong></div>';
                teamHtml += '<div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px;">';
                teamDetails.skillsNeeded.forEach(skill => {
                    teamHtml += `<span style="background: var(--gray-100); padding: 6px 12px; border-radius: 15px; font-size: 0.85em;">${skill}</span>`;
                });
                teamHtml += '</div>';
                
                // Team assessment summary
                if (teamDetails.strengths.length > 0 || teamDetails.risks.length > 0) {
                    teamHtml += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">';
                    if (teamDetails.strengths.length > 0) {
                        teamHtml += '<div style="background: var(--success-light); padding: 12px; border-radius: 8px;">';
                        teamHtml += '<div style="font-weight: 600; color: var(--success); margin-bottom: 8px;">✓ Team Strengths</div>';
                        teamDetails.strengths.forEach(s => {
                            teamHtml += `<div style="font-size: 0.85em; color: var(--gray-600); margin-bottom: 4px;">• ${s}</div>`;
                        });
                        teamHtml += '</div>';
                    }
                    if (teamDetails.risks.length > 0) {
                        teamHtml += '<div style="background: var(--danger-light); padding: 12px; border-radius: 8px;">';
                        teamHtml += '<div style="font-weight: 600; color: var(--danger); margin-bottom: 8px;">⚠ Team Risks</div>';
                        teamDetails.risks.forEach(r => {
                            teamHtml += `<div style="font-size: 0.85em; color: var(--gray-600); margin-bottom: 4px;">• ${r}</div>`;
                        });
                        teamHtml += '</div>';
                    }
                    teamHtml += '</div>';
                }
                
                document.getElementById('project-modal-team-details').innerHTML = teamHtml;
            } else {
                // Still show project lead even if no team details
                if (project.lead) {
                    let leadHtml = '<div style="margin-bottom: 15px;">';
                    leadHtml += '<div style="margin-bottom: 10px;"><strong>🎯 Project Lead:</strong></div>';
                    leadHtml += renderLeadCard(project.lead);
                    leadHtml += '</div>';
                    document.getElementById('project-modal-team-details').innerHTML = leadHtml;
                } else {
                    document.getElementById('project-modal-team-details').innerHTML = '';
                }
            }
            // Show team note
            document.getElementById('project-modal-team').textContent = project.teamNote || 'Team assignment pending.';
        } else {
            // Blind mode - hide all team information
            document.getElementById('project-modal-team-details').innerHTML = `
                <div class="blinded-section">
                    <div class="blinded-icon">🎭</div>
                    <div class="blinded-text">
                        <strong>Team Information Hidden</strong>
                        <span>You've chosen Blind Review — team details are not visible to reduce bias.</span>
                    </div>
                </div>
            `;
            document.getElementById('project-modal-team').textContent = 'Team information hidden (Blind Review mode)';
        }
        
        // Financials
        const financials = project.financials || {};
        document.getElementById('project-modal-financials').innerHTML = `
            <div class="financial-item"><div class="value">${financials.devCost || '$' + project.budget + 'M'}</div><div class="label">Development Cost</div></div>
            <div class="financial-item"><div class="value">${financials.timeline || project.timeline + ' quarters'}</div><div class="label">Timeline</div></div>
            <div class="financial-item"><div class="value">${financials.projectedRevenue || 'TBD'}</div><div class="label">Projected Revenue</div></div>
            <div class="financial-item"><div class="value">${financials.grossMargin || 'TBD'}</div><div class="label">Gross Margin</div></div>
            <div class="financial-item"><div class="value">${financials.breakeven || 'TBD'}</div><div class="label">Breakeven</div></div>
        `;
        
        // Synergies
        const synergies = project.synergies || [];
        document.getElementById('project-modal-synergies').innerHTML = synergies.length > 0 
            ? synergies.map(s => `<span class="synergy-item">${s}</span>`).join('')
            : '<p style="color: var(--gray-500);">No identified synergies with other portfolio projects.</p>';
        
        // Button state - handle both Year 1 and Year 2
        const btn = document.getElementById('project-modal-btn');
        const triageActions = document.getElementById('modal-triage-actions');
        
        if (gameState.currentModalContext === 'year2') {
            // Year 2 portfolio builder
            const isSelected = year2SelectedProjects.includes(project.id);
            const isSkipped = year2ProjectTriage[project.id] === 'stop';
            const canAfford = project.budget <= year2AvailableBudget || isSelected;
            
            triageActions.classList.add('hidden');
            btn.classList.remove('hidden');
            btn.onclick = function() { toggleProjectFromModal(); };
            
            if (isSkipped) {
                btn.textContent = '🚫 Skipped by Committee';
                btn.className = 'add-to-committee-btn';
                btn.disabled = true;
                btn.style.background = 'var(--gray-300)';
            } else if (isSelected) {
                btn.textContent = 'Remove from Portfolio';
                btn.className = 'add-to-committee-btn remove';
                btn.disabled = false;
                btn.style.background = '';
            } else if (canAfford) {
                btn.textContent = 'Add to Portfolio';
                btn.className = 'add-to-committee-btn';
                btn.disabled = false;
                btn.style.background = '';
            } else {
                btn.textContent = 'Exceeds Remaining Budget';
                btn.className = 'add-to-committee-btn';
                btn.disabled = true;
                btn.style.background = 'var(--gray-300)';
            }
        } else if (gameState.currentModalContext === 'ongoing') {
            // Ongoing project - view only
            triageActions.classList.add('hidden');
            btn.classList.remove('hidden');
            btn.textContent = '📂 Ongoing Project';
            btn.className = 'add-to-committee-btn';
            btn.disabled = true;
            btn.style.background = 'var(--primary)';
            btn.style.color = 'white';
        } else {
            // Year 1 logic
            const isSelected = gameState.selectedProjects.includes(project.id);
            const canAfford = project.budget <= gameState.budget;
            
            if (isSelected) {
                btn.textContent = 'Remove from Portfolio';
                btn.className = 'add-to-committee-btn remove';
                btn.disabled = false;
            } else if (canAfford) {
                btn.textContent = 'Add to Portfolio';
                btn.className = 'add-to-committee-btn';
                btn.disabled = false;
            } else {
                btn.textContent = 'Exceeds Remaining Budget';
                btn.className = 'add-to-committee-btn';
                btn.disabled = true;
                btn.style.background = 'var(--gray-300)';
            }
            
            // Show/hide triage buttons based on current phase
            if (gameState.phase === 'committee-feedback') {
                triageActions.classList.remove('hidden');
                btn.classList.add('hidden');
                
                const currentTriage = gameState.projectTriage[projectId] || 'marginal';
                ['fund', 'marginal', 'stop'].forEach(status => {
                    const triageBtn = document.getElementById('modal-' + status + '-btn');
                    if (triageBtn) {
                        if (currentTriage === status) {
                            triageBtn.classList.add('active');
                        } else {
                            triageBtn.classList.remove('active');
                        }
                    }
                });
            } else {
                triageActions.classList.add('hidden');
                btn.classList.remove('hidden');
            }
        }
        
        document.getElementById('project-modal').classList.remove('hidden');
    }
    
    function setTriageFromModal(status) {
        if (gameState.currentModalProject) {
            setTriage(gameState.currentModalProject, status);
            closeProjectModal();
        }
    }
    
    function closeProjectModal() {
        document.getElementById('project-modal').classList.add('hidden');
        // Reset button styles
        const btn = document.getElementById('project-modal-btn');
        if (btn) {
            btn.style.background = '';
            btn.style.color = '';
        }
        gameState.currentModalProject = null;
        gameState.currentModalContext = null;
    }
    
    function toggleProjectFromModal() {
        if (gameState.currentModalProject) {
            // Check if we're in Year 1 End selection context
            if (gameState.currentModalContext === 'year1end') {
                toggleYear1EndProject(gameState.currentModalProject);
                openYear1EndProjectModal(gameState.currentModalProject); // Refresh modal state
            } else if (gameState.currentModalContext === 'year2') {
                year2Toggle(gameState.currentModalProject);
                openProjectModal(gameState.currentModalProject, 'year2'); // Refresh modal state
            } else {
                // Default: original project selection
                const project = gameState.projectPool.find(p => p.id === gameState.currentModalProject);
                if (project) {
                    toggleProject(project.id);
                    openProjectModal(gameState.currentModalProject); // Refresh modal state
                }
            }
        }
    }
    
    function toggleProject(projectId) {
        // Find project in either rankedProjects or projectPool
        const projects = gameState.rankedProjects || gameState.projectPool;
        const project = projects.find(p => p.id === projectId);
        if (!project) return;
        
        const index = gameState.selectedProjects.indexOf(projectId);
        
        if (index > -1) {
            gameState.selectedProjects.splice(index, 1);
            gameState.budget += project.budget;
            SoundManager.play('deselect');
        } else if (project.budget <= gameState.budget) {
            gameState.selectedProjects.push(projectId);
            gameState.budget -= project.budget;
            SoundManager.play('coin');
        } else {
            SoundManager.play('error');
        }
        
        renderProjectGrid();
    }
    
    function updateBudgetDisplay() {
        document.getElementById('budget-remaining').textContent = `$${gameState.budget.toFixed(1)}M`;
        document.getElementById('projects-selected').textContent = gameState.selectedProjects.length;
        document.getElementById('start-reviews-btn').disabled = gameState.selectedProjects.length === 0;
    }
    
    function startQuarterlyReviews() {
        // Use rankedProjects if available, otherwise projectPool
        const projects = gameState.rankedProjects || gameState.projectPool;
        
        // Add new selected projects
        const newActiveProjects = gameState.selectedProjects.map(id => {
            const project = projects.find(p => p.id === id);
            return { ...project, status: 'active', currentQuarter: 0, spentBudget: 0, quarterlyUpdates: [], decision: 'continue', isLegacy: false };
        });
        
        // Add active legacy projects (continue, accelerate, reduce_scope)
        const legacyNarratives = {
            good: [
                'Team making solid progress on deliverables.',
                'Key milestone achieved ahead of schedule.',
                'Integration testing going smoothly.',
                'Stakeholder feedback positive.',
                'Technical challenges resolved efficiently.'
            ],
            bad: [
                'Unexpected technical debt slowing progress.',
                'Key team member out sick, causing delays.',
                'Scope creep emerging from stakeholder requests.',
                'Integration issues with legacy systems.',
                'Quality issues requiring rework.'
            ]
        };
        
        const activeLegacy = (gameState.activeLegacyProjects || []).map(p => {
            // Calculate success probability based on decision
            let successProb = 0.65;
            if (p.decision === 'accelerate') successProb = 0.55; // Higher risk
            if (p.decision === 'reduce_scope') successProb = 0.75; // Lower risk
            if (p.status === 'green') successProb += 0.1;
            if (p.status === 'red') successProb -= 0.15;
            
            return {
                ...p,
                status: 'active',
                currentQuarter: p.quarterlyUpdates?.length || 0,
                decision: p.decision || 'continue',
                isLegacy: true,
                budget: p.remainingBudget + p.spentBudget,
                timeline: p.quartersRemaining + (p.quarterlyUpdates?.length || 0),
                successProb: successProb,
                quarterNarratives: legacyNarratives,
                quarterlyUpdates: p.quarterlyUpdates || [], // Ensure array exists
                outcomeNarrative: {
                    success: 'Legacy project completed successfully. Delivered on remaining commitments.',
                    failure: 'Legacy project faced challenges. Some objectives met but others deferred.'
                },
                milestones: { phases: [
                    { phase: 'Completion Phase', deliverables: ['Final development', 'Testing', 'Documentation'] }
                ]}
            };
        });
        
        // Combine both types
        gameState.activeProjects = [...newActiveProjects, ...activeLegacy];
        
        gameState.rejectedProjects = projects.filter(p => !gameState.selectedProjects.includes(p.id)).map(p => ({...p, status: 'rejected'}));
        gameState.currentQuarter = 1;
        gameState.completedProjects = [];
        // Keep killed projects from legacy decisions
        if (!gameState.killedProjects) gameState.killedProjects = [];
        
        // Start the quarterly review process (cockpit will be shown after projects are updated)
        renderQuarterlyReview();
    }
    
    function renderQuarterlyReview() {
        // Process any active effects from previous events
        processActiveEffects();
        
        // TWO-TIER EVENT SYSTEM:
        // 1. Corporate Events (~35% per quarter): Company-wide news, acknowledge only
        // 2. R&D Dilemmas (~90% per quarter, 1-2): Project-level decisions with choices
        
        // Check for corporate events first (less frequent, context-setting)
        const events = checkForCorporateEvent();
        if (events && events.length > 0) {
            showCorporateEventsSequentially(events, 0, () => {
                checkAndShowDilemma();
            });
        } else {
            checkAndShowDilemma();
        }
    }
    
    function showCorporateEventsSequentially(events, index, finalCallback) {
        if (index >= events.length) {
            // All events shown, proceed to final callback
            finalCallback();
            return;
        }
        
        const event = events[index];
        showCorporateEvent(event, () => {
            // Show next event after this one is acknowledged
            showCorporateEventsSequentially(events, index + 1, finalCallback);
        });
    }
    
    function checkAndShowDilemma() {
        // Check for R&D dilemmas (1-2 per quarter, 90% chance)
        const dilemmas = checkForManagementDilemma();
        if (dilemmas && dilemmas.length > 0) {
            showDilemmasSequentially(dilemmas, 0, () => {
                actuallyRenderQuarterlyReview();
            });
        } else {
            actuallyRenderQuarterlyReview();
        }
    }
    
    function showDilemmasSequentially(dilemmas, index, finalCallback) {
        if (index >= dilemmas.length) {
            finalCallback();
            return;
        }
        
        const dilemma = dilemmas[index];
        showManagementDilemma(dilemma, () => {
            showDilemmasSequentially(dilemmas, index + 1, finalCallback);
        });
    }
    
    function actuallyRenderQuarterlyReview() {
        var year = gameState.currentQuarter <= 4 ? 1 : 2;
        var quarterInYear = gameState.currentQuarter <= 4 ? gameState.currentQuarter : gameState.currentQuarter - 4;
        
        // Add active effects badge to title
        const effectsBadge = getActiveEffectsBadge();
        document.getElementById('quarter-title').innerHTML = `Q${gameState.currentQuarter} Review ${effectsBadge}`;
        document.getElementById('quarter-subtitle').textContent = `Year ${year}, Quarter ${quarterInYear}`;
        document.getElementById('portfolio-summary').innerHTML = `
            <div class="portfolio-stat"><div class="num">${gameState.activeProjects.length}</div><div class="lbl">Active</div></div>
            <div class="portfolio-stat"><div class="num">${gameState.completedProjects.length}</div><div class="lbl">Completed</div></div>
            <div class="portfolio-stat"><div class="num">${gameState.killedProjects.length}</div><div class="lbl">Killed</div></div>
            <div class="portfolio-stat"><div class="num">$${gameState.budget.toFixed(1)}M </div><div class="lbl">Remaining</div></div>
        `;
        
        document.getElementById('commercialisation-events').innerHTML = renderCommercializationEvents();
        
        // Generate updates for all projects first
        gameState.activeProjects.forEach(project => {
            const update = generateQuarterlyUpdate(project);
            project.latestUpdate = update; // Store for modal access
            project.quarterlyUpdates.push(update);
            project.currentQuarter++;
        });
        
        // Render compact tiles
        document.getElementById('review-cards').innerHTML = `
            <div class="review-tiles-grid">
                ${gameState.activeProjects.map(project => {
                    const update = project.latestUpdate;
                    const statusClass = update.status;
                    const budgetPct = Math.round((update.spent / project.budget) * 100);
                    
                    return `
                        <div class="review-tile ${statusClass}" data-project-id="${project.id}">
                            <div class="tile-header">
                                <span class="tile-status-dot ${statusClass}"></span>
                                <span class="tile-name">${project.name}</span>
                            </div>
                            
                            <div class="tile-phase">📍 ${update.currentMilestone} (${update.milestonesComplete}/${update.totalMilestones} phases)</div>
                            
                            <div class="tile-metrics">
                                <div class="tile-metric">
                                    <span class="metric-value">${update.progress}%</span>
                                    <span class="metric-label">Progress</span>
                                </div>
                                <div class="tile-metric">
                                    <span class="metric-value ${budgetPct > 80 ? 'warning' : ''}">${budgetPct}%</span>
                                    <span class="metric-label">Budget</span>
                                </div>
                                <div class="tile-metric">
                                    <span class="metric-value">${Math.max(0, project.timeline - project.currentQuarter)}Q</span>
                                    <span class="metric-label">Left</span>
                                </div>
                            </div>
                            
                            <div class="tile-objectives">
                                ${(update.objectiveStatus || []).map(obj => 
                                    '<div class="tile-obj ' + obj.status + '">' + obj.icon + ' ' + obj.name.substring(0, 35) + (obj.name.length > 35 ? '...' : '') + '</div>'
                                ).join('')}
                            </div>
                            
                            <div class="tile-narrative">"${update.narrative.substring(0, 80)}${update.narrative.length > 80 ? '...' : ''}"</div>
                            
                            <button class="tile-details-btn" onclick="openReviewModal('${project.id}')">
                                📋 View Details & Intel
                            </button>
                            
                            <div class="tile-actions">
                                <button class="tile-action continue ${project.decision === 'continue' ? 'selected' : ''}" 
                                        onclick="event.stopPropagation(); setDecision('${project.id}', 'continue')" title="Continue at current pace">
                                    ▶️
                                </button>
                                <button class="tile-action accelerate ${project.decision === 'accelerate' ? 'selected' : ''}" 
                                        onclick="event.stopPropagation(); setDecision('${project.id}', 'accelerate')" title="Accelerate: +50% budget, -1Q">
                                    ⚡
                                </button>
                                <button class="tile-action reduce ${project.decision === 'reduce' ? 'selected' : ''}" 
                                        onclick="event.stopPropagation(); setDecision('${project.id}', 'reduce')" title="Reduce: -30% budget, +1Q">
                                    🔻
                                </button>
                                <button class="tile-action kill ${project.decision === 'kill' ? 'selected' : ''}" 
                                        onclick="event.stopPropagation(); setDecision('${project.id}', 'kill')" title="Kill project">
                                    🛑
                                </button>
                            </div>
                            
                            <div class="tile-decision-label" id="decision-label-${project.id}">
                                ${getDecisionLabel(project.decision)}
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        `;
        
        const btn = document.getElementById('next-quarter-btn');
        const cockpitBtn = document.getElementById('cockpit-next-btn');
        var nextLabel;
        if (gameState.currentQuarter >= gameState.maxQuarters || gameState.activeProjects.length === 0) {
            nextLabel = 'View Final Results →';
        } else if (gameState.currentQuarter === 4) {
            nextLabel = 'Proceed to Year 2 Budget Review →';
        } else {
            nextLabel = 'Submit Decisions & Go to Q' + (gameState.currentQuarter + 1) + ' →';
        }
        if (btn) btn.textContent = nextLabel;
        if (cockpitBtn) cockpitBtn.textContent = nextLabel;
        
        // Update cockpit view AFTER projects have been updated with quarterly data
        showCockpitView();
    }
    
    function getDecisionLabel(decision) {
        const labels = {
            'continue': '<span class="decision-tag continue">▶️ Continuing</span>',
            'accelerate': '<span class="decision-tag accelerate">⚡ Accelerating</span>',
            'reduce': '<span class="decision-tag reduce">🔻 Reducing</span>',
            'kill': '<span class="decision-tag kill">🛑 Killing</span>'
        };
        return labels[decision] || labels['continue'];
    }
    
    function openReviewModal(projectId) {
        const project = gameState.activeProjects.find(p => String(p.id) === String(projectId));
        if (!project) return;
        
        const update = project.latestUpdate;
        const milestoneInfo = getMilestoneProgress(project);
        const competitorUpdate = getCompetitorUpdate(project, update.isGoodQuarter);
        const ipUpdate = getIPUpdate(project, update.isGoodQuarter);
        const teamUpdate = getTeamUpdate(project, update.isGoodQuarter);
        const riskAssessment = getRiskAssessment(project, update);
        const recommendation = getCommitteeRecommendation(project, update);
        
        const modalHtml = `
            <div class="review-modal-overlay" onclick="closeReviewModal()">
                <div class="review-modal" onclick="event.stopPropagation()">
                    <button class="review-modal-close" onclick="closeReviewModal()">×</button>
                    
                    <div class="review-modal-header ${update.status}">
                        <h2>${project.name}</h2>
                        <p>${project.tagline || ''}</p>
                        <span class="status-badge ${update.status}">${update.status.toUpperCase()}</span>
                    </div>
                    
                    <div class="review-modal-body">
                        <div class="review-modal-section">
                            <h3>📊 Key Metrics</h3>
                            <div class="modal-metrics-grid">
                                <div class="modal-metric">
                                    <div class="value">${update.progress}%</div>
                                    <div class="label">Progress</div>
                                </div>
                                <div class="modal-metric">
                                    <div class="value">$${update.spent.toFixed(1)}M </div>
                                    <div class="label">Spent</div>
                                </div>
                                <div class="modal-metric">
                                    <div class="value">${Math.max(0, project.timeline - project.currentQuarter)}Q</div>
                                    <div class="label">Remaining</div>
                                </div>
                                <div class="modal-metric ${update.spent > project.budget * 0.8 ? 'warning' : ''}">
                                    <div class="value">${Math.round((update.spent / project.budget) * 100)}%</div>
                                    <div class="label">Budget Used</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="review-modal-section">
                            <h3>📋 Project Snapshot</h3>
                            <div class="modal-facts-grid">
                                <div><strong>Original Budget:</strong> $${project.budget.toFixed(1)}M </div>
                                <div><strong>Timeline:</strong> ${project.timeline} quarters</div>
                                <div><strong>TRL:</strong> ${project.trl?.current || '?'} → ${project.trl?.target || '?'}</div>
                                <div><strong>Strategic Focus:</strong> ${(project.strategicBuckets || []).map(b => b.icon + ' ' + b.name).join(', ') || '—'}</div>
                            </div>
                        </div>
                        
                        <div class="review-modal-section">
                            <h3>🎯 Milestone Progress</h3>
                            <div class="milestone-track">${milestoneInfo.html}</div>
                            <p class="milestone-narrative">${milestoneInfo.narrative}</p>
                        </div>
                        
                        <div class="review-modal-section">
                            <h3>📝 Team Update</h3>
                            <div class="review-narrative">"${update.narrative}"</div>
                        </div>
                        
                        <div class="review-modal-section">
                            <h3>👤 Project Lead</h3>
                            ${project.lead ? renderLeadCard(project.lead) : '<p style="color: var(--gray-500);">No lead assigned.</p>'}
                        </div>
                        
                        <div class="review-modal-section">
                            <h3>🔍 Intelligence Report</h3>
                            <div class="modal-intel-grid">
                                <div class="intel-card competitor">
                                    <h5>🏁 Competitor Intel</h5>
                                    <p>${competitorUpdate}</p>
                                </div>
                                <div class="intel-card ip">
                                    <h5>🛡️ IP Position</h5>
                                    <p>${ipUpdate}</p>
                                </div>
                                <div class="intel-card team">
                                    <h5>👥 Team & Resources</h5>
                                    <p>${teamUpdate}</p>
                                </div>
                                <div class="intel-card risk">
                                    <h5>⚠️ Risk Assessment</h5>
                                    <p>${riskAssessment}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="review-modal-section recommendation">
                            <h3>💡 Committee Recommendation</h3>
                            <p>${recommendation}</p>
                        </div>
                    </div>
                    
                    <div class="review-modal-footer">
                        <h4>Your Decision</h4>
                        <div class="modal-actions">
                            <button class="action-btn continue ${project.decision === 'continue' ? 'selected' : ''}" 
                                    onclick="setDecisionAndUpdate('${project.id}', 'continue')">
                                <span class="action-icon">▶️</span>
                                <span class="action-label">Continue</span>
                                <span class="action-desc">Maintain current pace</span>
                            </button>
                            <button class="action-btn accelerate ${project.decision === 'accelerate' ? 'selected' : ''}" 
                                    onclick="setDecisionAndUpdate('${project.id}', 'accelerate')">
                                <span class="action-icon">⚡</span>
                                <span class="action-label">Accelerate</span>
                                <span class="action-desc">+50% budget, -1Q timeline</span>
                            </button>
                            <button class="action-btn reduce ${project.decision === 'reduce' ? 'selected' : ''}" 
                                    onclick="setDecisionAndUpdate('${project.id}', 'reduce')">
                                <span class="action-icon">🔻</span>
                                <span class="action-label">Reduce</span>
                                <span class="action-desc">-30% budget, +1Q timeline</span>
                            </button>
                            <button class="action-btn kill ${project.decision === 'kill' ? 'selected' : ''}" 
                                    onclick="setDecisionAndUpdate('${project.id}', 'kill')">
                                <span class="action-icon">🛑</span>
                                <span class="action-label">Kill</span>
                                <span class="action-desc">Stop project</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Add modal to DOM
        const modalContainer = document.createElement('div');
        modalContainer.id = 'review-modal-container';
        modalContainer.innerHTML = modalHtml;
        document.body.appendChild(modalContainer);
    }
    
    function closeReviewModal() {
        const container = document.getElementById('review-modal-container');
        if (container) {
            container.remove();
        }
    }
    
    function setDecisionAndUpdate(projectId, decision) {
        setDecision(projectId, decision);
        
        // Update modal buttons
        const modalActions = document.querySelector('.modal-actions');
        if (modalActions) {
            modalActions.querySelectorAll('.action-btn').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.classList.contains(decision)) {
                    btn.classList.add('selected');
                }
            });
        }
        
        // Auto-close modal after brief delay to show selection feedback
        setTimeout(() => {
            closeReviewModal();
        }, 300);
    }
    
    function getMilestoneProgress(project) {
        const milestones = project.milestones?.milestones || project.milestones?.phases || [
            { name: 'Research', duration: '3 months' },
            { name: 'Development', duration: '6 months' },
            { name: 'Testing', duration: '2 months' },
            { name: 'Launch', duration: '1 month' }
        ];
        
        const quarterProgress = project.currentQuarter / project.timeline;
        const currentMilestoneIndex = Math.min(Math.floor(quarterProgress * milestones.length), milestones.length - 1);
        
        const html = milestones.map((m, i) => {
            let status = 'upcoming';
            if (i < currentMilestoneIndex) status = 'complete';
            else if (i === currentMilestoneIndex) status = 'current';
            
            return `<div class="milestone-item ${status}">
                <div class="milestone-dot"></div>
                <div class="milestone-name">${m.name || m.phase || `Phase ${i+1}`}</div>
            </div>`;
        }).join('<div class="milestone-connector"></div>');
        
        const currentMilestone = milestones[currentMilestoneIndex];
        const narratives = [
            `Currently in ${currentMilestone?.name || 'development'} phase. Team is ${quarterProgress > 0.5 ? 'making good progress' : 'ramping up'}.`,
            `${currentMilestone?.name || 'Current phase'} underway. ${Math.round(quarterProgress * 100)}% through planned timeline.`,
            `Working on ${currentMilestone?.name || 'deliverables'}. ${currentMilestoneIndex > 0 ? 'Previous milestones completed.' : 'Initial phase.'}`
        ];
        
        return { 
            html, 
            narrative: narratives[Math.floor(Math.random() * narratives.length)]
        };
    }
    
    function getCompetitorUpdate(project, isGoodQuarter) {
        const competitors = project.competitors || [];
        const competitorNames = competitors.map(c => c.name || c).slice(0, 2);
        
        const goodUpdates = [
            `Market analysis shows our approach is differentiated. ${competitorNames[0] || 'Key competitor'} facing delays.`,
            `Competitive position strengthening. Early customer feedback favours our solution.`,
            `No major competitor moves detected. Our first-mover advantage intact.`,
            `${competitorNames[0] || 'Primary rival'} pivoted away from this segment. Less competitive pressure.`
        ];
        
        const badUpdates = [
            `${competitorNames[0] || 'Major competitor'} announced similar product. Time pressure increasing.`,
            `Competitor pricing aggressive. May need to adjust our go-to-market strategy.`,
            `New entrant detected in adjacent space. Monitoring closely.`,
            `${competitorNames[0] || 'Rival'} secured key partnership. Competitive dynamics shifting.`
        ];
        
        const updates = isGoodQuarter ? goodUpdates : badUpdates;
        return updates[Math.floor(Math.random() * updates.length)];
    }
    
    function getIPUpdate(project, isGoodQuarter) {
        const ipPosition = project.ipAnalysis?.shieldtechIP || 'Limited existing IP';
        
        const goodUpdates = [
            `Patent application progressing well. Freedom to operate confirmed for key features.`,
            `Strengthened defensive position. Two provisional patents filed this quarter.`,
            `IP landscape clear. No blocking patents identified in target markets.`,
            `Trade secret protections in place. Key algorithms secured.`
        ];
        
        const badUpdates = [
            `IP review flagged potential overlap with existing patents. Legal assessing options.`,
            `Competitor filed broad claims in adjacent area. May need design-around.`,
            `Patent search revealed prior art. Adjusting claims strategy.`,
            `Freedom to operate analysis ongoing. Some uncertainty in key markets.`
        ];
        
        const updates = isGoodQuarter ? goodUpdates : badUpdates;
        return updates[Math.floor(Math.random() * updates.length)];
    }
    
    function getTeamUpdate(project, isGoodQuarter) {
        const teamLeads = project.teamLeads || [];
        const leadName = teamLeads[0]?.name || 'Project lead';
        
        const goodUpdates = [
            `Team morale high. ${leadName} reports strong collaboration across functions.`,
            `Successfully onboarded key specialist. Capability gaps addressed.`,
            `Team velocity improving. Sprint commitments being met consistently.`,
            `Cross-functional alignment strong. No resource conflicts this quarter.`
        ];
        
        const badUpdates = [
            `Key engineer departed. Knowledge transfer underway but causing delays.`,
            `Team stretched thin across multiple priorities. ${leadName} requesting additional headcount.`,
            `Some friction between engineering and product. Working to resolve.`,
            `Resource contention with other projects. May need to reprioritise.`
        ];
        
        const updates = isGoodQuarter ? goodUpdates : badUpdates;
        return updates[Math.floor(Math.random() * updates.length)];
    }
    
    function getRiskAssessment(project, update) {
        const progress = update.progress;
        const budgetUsed = (update.spent / project.budget) * 100;
        const timeUsed = (project.currentQuarter / project.timeline) * 100;
        
        if (update.status === 'red') {
            if (budgetUsed > timeUsed + 20) {
                return `⛔ HIGH RISK: Budget burn rate ${Math.round(budgetUsed - timeUsed)}% ahead of timeline. Cost overrun likely without intervention.`;
            } else if (progress < timeUsed - 25) {
                return `⛔ HIGH RISK: Progress ${Math.round(timeUsed - progress)}% behind schedule. Timeline at risk. Consider scope reduction.`;
            }
            return `⛔ HIGH RISK: Multiple warning indicators. Recommend thorough review before proceeding.`;
        } else if (update.status === 'yellow') {
            return `⚠️ MODERATE RISK: Some concerns flagged. Close monitoring recommended. Mitigation actions underway.`;
        } else {
            return `✅ LOW RISK: Project tracking to plan. No immediate concerns. Continue current approach.`;
        }
    }
    
    function getCommitteeRecommendation(project, update) {
        const progress = update.progress;
        const budgetUsed = (update.spent / project.budget) * 100;
        const timeUsed = (project.currentQuarter / project.timeline) * 100;
        
        // Get committee members' perspectives
        const committee = gameState.committee || [];
        const memberOpinions = committee.slice(0, 2).map(memberId => {
            const member = findStaff(memberId);
            if (!member) return null;
            
            let opinion;
            if (update.status === 'green') {
                opinion = member.bias?.includes('growth') ? 'accelerate' : 'continue';
            } else if (update.status === 'red') {
                opinion = member.bias?.includes('risk') ? 'kill' : 'reduce';
            } else {
                opinion = 'continue';
            }
            return { name: member.name.split(' ')[0], opinion };
        }).filter(Boolean);
        
        let recommendation = '';
        
        if (update.status === 'green' && progress > timeUsed) {
            recommendation = `Strong performance suggests opportunity to accelerate. ROI case strengthening.`;
        } else if (update.status === 'red' && budgetUsed > timeUsed + 15) {
            recommendation = `Significant concerns warrant serious consideration of scope reduction or termination.`;
        } else if (update.status === 'yellow') {
            recommendation = `Mixed signals. Recommend maintaining current pace while addressing flagged issues.`;
        } else {
            recommendation = `On track. No changes recommended at this time.`;
        }
        
        if (memberOpinions.length > 0) {
            recommendation += ` ${memberOpinions[0].name} suggests "${memberOpinions[0].opinion}".`;
        }
        
        return recommendation;
    }
    
    function generateQuarterlyUpdate(project) {
        const quarterNum = project.currentQuarter;
        let isGoodQuarter = Math.random() < project.successProb;
        
        if (project.archetype === 'slow_burner' && quarterNum < 5) isGoodQuarter = Math.random() < 0.3;
        if (project.archetype === 'paper_tiger' && quarterNum < 3) isGoodQuarter = Math.random() < 0.7;
        if (project.archetype === 'money_pit') isGoodQuarter = Math.random() < 0.4;
        if (project.archetype === 'hidden_gem' && quarterNum > 3) isGoodQuarter = Math.random() < 0.75;
        
        const narratives = isGoodQuarter ? project.quarterNarratives.good : project.quarterNarratives.bad;
        const narrative = narratives[Math.floor(Math.random() * narratives.length)];
        const expectedProgress = (quarterNum / project.timeline) * 100;
        const progressVariance = isGoodQuarter ? Math.random() * 15 : -Math.random() * 25;
        // Cap progress at 99% until project reaches its final quarter (prevents misleading 100% before completion)
        const maxProgress = quarterNum >= project.timeline ? 100 : 99;
        const progress = Math.min(maxProgress, Math.max(0, Math.round(expectedProgress + progressVariance)));
        const quarterlyBudget = project.budget / project.timeline;
        const spent = project.spentBudget + quarterlyBudget * (1 + (isGoodQuarter ? 0 : Math.random() * 0.3));
        project.spentBudget = spent;
        
        let status = 'green';
        if (!isGoodQuarter) status = 'yellow';
        if (progress < expectedProgress - 20 || spent > project.budget * 0.9) status = 'red';
        
        // Generate milestone status
        const milestones = project.milestones?.milestones || project.milestones?.phases || [];
        const totalMilestones = milestones.length || 3;
        const milestonesComplete = Math.min(totalMilestones, Math.floor((quarterNum / project.timeline) * totalMilestones));
        const currentMilestone = milestones[milestonesComplete] || { phase: 'Development', deliverables: ['Core features'] };
        
        // Generate objective status
        const objectiveStatus = generateObjectiveStatus(project, quarterNum, isGoodQuarter);
        
        return { 
            status, 
            progress, 
            spent, 
            narrative, 
            isGoodQuarter,
            milestonesComplete,
            totalMilestones,
            currentMilestone: currentMilestone.phase || 'In Progress',
            objectiveStatus
        };
    }
    
    function generateObjectiveStatus(project, quarterNum, isGoodQuarter) {
        // Generate 3-4 specific objectives with status
        const objectives = [];
        const milestones = project.milestones?.milestones || project.milestones?.phases || [];
        const currentPhase = milestones[Math.min(milestones.length - 1, Math.floor((quarterNum / project.timeline) * milestones.length))] || {};
        const deliverables = currentPhase.deliverables || ['Core development', 'Testing', 'Documentation'];
        const metrics = currentPhase.metrics || [];
        
        // Add deliverable-based objectives
        deliverables.slice(0, 2).forEach((d, i) => {
            const complete = isGoodQuarter ? Math.random() > 0.3 : Math.random() > 0.7;
            const inProgress = !complete && Math.random() > 0.4;
            objectives.push({
                name: d,
                status: complete ? 'complete' : (inProgress ? 'in-progress' : 'at-risk'),
                icon: complete ? '✅' : (inProgress ? '🔄' : '⚠️')
            });
        });
        
        // Add metric-based objectives
        metrics.slice(0, 2).forEach((m, i) => {
            const onTrack = isGoodQuarter ? Math.random() > 0.25 : Math.random() > 0.6;
            objectives.push({
                name: m.name + ': ' + m.target,
                status: onTrack ? 'on-track' : 'behind',
                icon: onTrack ? '📊' : '📉'
            });
        });
        
        // Ensure at least 3 objectives
        if (objectives.length < 3) {
            const genericObjectives = [
                { name: 'Technical milestones', status: isGoodQuarter ? 'on-track' : 'behind', icon: isGoodQuarter ? '✅' : '⚠️' },
                { name: 'Budget compliance', status: project.spentBudget < project.budget * 0.8 ? 'on-track' : 'at-risk', icon: project.spentBudget < project.budget * 0.8 ? '💰' : '⚠️' },
                { name: 'Timeline adherence', status: isGoodQuarter ? 'on-track' : 'behind', icon: isGoodQuarter ? '📅' : '⏰' }
            ];
            while (objectives.length < 3 && genericObjectives.length > 0) {
                objectives.push(genericObjectives.shift());
            }
        }
        
        return objectives.slice(0, 4);
    }
    
    function renderCommercializationEvents() {
        const completing = gameState.activeProjects.filter(p => p.currentQuarter >= p.timeline && p.decision !== 'kill');
        if (!completing.length) return '';
        
        // Default narratives for legacy projects or projects without outcomeNarrative
        const defaultNarratives = {
            success: 'Project delivered successfully and met key objectives.',
            failure: 'Project faced challenges but provided valuable learnings for future initiatives.'
        };
        
        return completing.map(project => {
            const success = Math.random() < project.successProb;
            project.outcome = success ? 'success' : 'failure';
            project.status = 'completed';
            gameState.completedProjects.push(project);
            // Use risk-based ROI multiplier for successful projects
            const baseMultiplier = project.roiMultiplier || 2.5;
            const variance = 0.5 + Math.random() * 0.5; // 0.5-1.0 variance factor
            project.revenue = success ? project.budget * baseMultiplier * variance : -project.spentBudget;
            
            // Use project's narrative or default
            const narrative = project.outcomeNarrative || defaultNarratives;
            const narrativeText = success ? narrative.success : narrative.failure;
            
            return `
                <div class="event-card">
                    <h4>🎉 Project Completed: ${project.name}</h4>
                    <p class="${success ? 'outcome-success' : 'outcome-failure'}" style="font-size: 1.1em; margin-bottom: 10px;">${success ? '✅ SUCCESS' : '❌ FAILURE'}</p>
                    <p style="color: var(--gray-600); margin-bottom: 10px;">${narrativeText}</p>
                    <p><strong>Financial Impact:</strong> <span class="${success ? 'outcome-success' : 'outcome-failure'}">${project.revenue >= 0 ? '+' : ''}$${Math.abs(project.revenue).toFixed(1)}M </span></p>
                </div>
            `;
        }).join('');
    }
    
    function setDecision(projectId, decision) {
        // Ensure projectId is a string for comparison
        const targetId = String(projectId);
        const project = gameState.activeProjects.find(p => String(p.id) === targetId);
        if (project) {
            project.decision = decision;
            
            // Update tile buttons
            const tile = document.querySelector(`.review-tile[data-project-id="${targetId}"]`);
            if (tile) {
                tile.querySelectorAll('.tile-action').forEach(btn => btn.classList.remove('selected'));
                const selectedBtn = tile.querySelector(`.tile-action.${decision}`);
                if (selectedBtn) {
                    selectedBtn.classList.add('selected');
                }
                
                // Update decision label
                const label = document.getElementById(`decision-label-${targetId}`);
                if (label) {
                    label.innerHTML = getDecisionLabel(decision);
                }
            }
            
            // Update card buttons (legacy)
            const card = document.querySelector(`.review-card[data-project-id="${targetId}"]`);
            if (card) {
                card.querySelectorAll('.action-btn').forEach(btn => btn.classList.remove('selected'));
                const selectedBtn = card.querySelector(`.action-btn.${decision}`);
                if (selectedBtn) {
                    selectedBtn.classList.add('selected');
                }
            }
        }
    }
    
    function nextQuarter() {
        gameState.activeProjects = gameState.activeProjects.filter(p => p.status !== 'completed');
        gameState.activeProjects = gameState.activeProjects.filter(project => {
            if (project.decision === 'kill') {
                project.status = 'killed';
                
                // Track kill decision for portfolio scoring
                const latestUpdate = project.latestUpdate || {};
                const signalStrength = latestUpdate.status || 'unknown'; // green, yellow, red
                const wasPerformingWell = signalStrength === 'green' || (signalStrength === 'yellow' && latestUpdate.isGoodQuarter);
                
                gameState.killDecisions.push({
                    projectId: project.id,
                    projectName: project.name,
                    riskClass: project.riskClass || getProjectRiskClass(project.archetype),
                    killedAtQuarter: gameState.currentQuarter,
                    signalStrength: signalStrength,
                    wasPerformingWell: wasPerformingWell,
                    successProb: project.successProb
                });
                
                gameState.activeDecisionsMade++;
                gameState.killedProjects.push(project);
                return false;
            }
            if (project.decision === 'accelerate') { 
                project.budget *= 1.5; 
                project.timeline = Math.max(1, project.timeline - 1); 
                project.successProb += 0.05; 
                gameState.activeDecisionsMade++;
            }
            if (project.decision === 'reduce') { 
                project.budget *= 0.7; 
                project.timeline += 1; 
                project.successProb -= 0.1; 
                gameState.activeDecisionsMade++;
            }
            project.decision = 'continue';
            return true;
        });
        
        gameState.currentQuarter++;
        
        if (gameState.currentQuarter > gameState.maxQuarters || gameState.activeProjects.length === 0) {
            gameState.activeProjects.forEach(project => {
                const success = Math.random() < project.successProb;
                project.outcome = success ? 'success' : 'failure';
                project.status = 'completed';
                // Use risk-based ROI multiplier for successful projects
                const baseMultiplier = project.roiMultiplier || 2.5;
                const variance = 0.5 + Math.random() * 0.5; // 0.5-1.0 variance factor
                project.revenue = success ? project.budget * baseMultiplier * variance : -project.spentBudget;
                gameState.completedProjects.push(project);
            });
            gameState.activeProjects = [];
            showResults();
        } else if (gameState.currentQuarter === 5) {
            // End of Year 1 (entering Q5) - go directly to Year 1 Portfolio Review
            // Year 2 project assessment will follow from there
            showYear1PortfolioReview();
        } else {
            // Start the quarterly review process (cockpit will be shown after projects are updated)
            renderQuarterlyReview();
        }
    }
    
    function showResults() {
        SoundManager.play('dramatic');
        const results = calculateResults();
        
        // Calculate career outcome
        const careerOutcome = calculateCareerOutcome(results);
        
        // Update career outcome banner
        const banner = document.getElementById('career-outcome-banner');
        banner.style.background = careerOutcome.gradient;
        document.getElementById('career-outcome-icon').textContent = careerOutcome.icon;
        document.getElementById('career-outcome-title').textContent = careerOutcome.title;
        document.getElementById('career-outcome-subtitle').textContent = careerOutcome.subtitle;
        
        // Update narrative
        document.getElementById('career-narrative-text').textContent = careerOutcome.narrative;
        
        // Update stats
        document.getElementById('tp-count').textContent = results.truePositives;
        document.getElementById('fp-count').textContent = results.falsePositives;
        document.getElementById('fn-count').textContent = results.falseNegatives;
        document.getElementById('tn-count').textContent = results.trueNegatives;
        document.getElementById('roi-value').textContent = `${results.roi}%`;
        document.getElementById('hit-rate').textContent = `${results.hitRate}%`;
        document.getElementById('waste-value').textContent = `$${results.waste.toFixed(1)}M`;
        document.getElementById('missed-value').textContent = `$${results.missed.toFixed(1)}M`;
        
        // Update process insights and counterfactuals
        document.getElementById('process-insights').innerHTML = generateProcessInsights(results);
        document.getElementById('counterfactuals').innerHTML = generateCounterfactuals();
        
        // Generate board feedback
        document.getElementById('board-feedback').innerHTML = generateBoardFeedback(results, careerOutcome);
        
        showPhase('results');
    }
    
    function calculateCareerOutcome(results) {
        // Base score calculation (0-100)
        const hitRateScore = results.hitRate;
        const roiScore = Math.min(100, Math.max(0, (results.roi + 50))); // Normalize ROI to 0-100
        const fnPenalty = Math.min(100, Math.max(0, 100 - (results.falseNegatives * 20))); // Fewer FN = better
        const tnBonus = Math.min(100, results.trueNegatives * 20); // More TN = better
        
        let baseScore = (hitRateScore * 0.35) + (roiScore * 0.25) + (fnPenalty * 0.15) + (tnBonus * 0.10);
        
        // Apply portfolio balance multiplier (0.7 - 1.1)
        const balanceMultiplier = results.portfolioBalance?.multiplier || 1.0;
        
        // Apply bucket coverage bonus/penalty (-0.1 to +0.2)
        const bucketBonus = results.bucketCoverage?.netBonus || 0;
        
        // Apply kill quality points (-20 to +20 roughly, normalize to percentage)
        const killPoints = results.killQuality?.points || 0;
        const killBonus = Math.max(-15, Math.min(15, killPoints)); // Cap at ±15
        
        // Apply active management bonus (0 or 5)
        const activeBonus = results.activeManagementBonus?.bonus || 0;
        
        // Calculate final composite score
        const compositeScore = (baseScore * balanceMultiplier) * (1 + bucketBonus) + killBonus + activeBonus;
        
        // Additional factors
        const totalProjects = results.truePositives + results.falsePositives;
        
        // Success with transformational projects (high risk, high reward path)
        const hasTransformationalSuccess = results.transformationalSuccesses >= 1;
        const hasBlockbuster = results.truePositives >= 2 && results.roi > 60 && hasTransformationalSuccess;
        
        // Disaster scenarios
        const isDisaster = results.falsePositives > results.truePositives && results.roi < -30;
        const missedBigOnes = results.falseNegatives >= 3;
        
        // Good portfolio management indicators
        const goodKillDiscipline = results.killQuality?.points >= 5;
        const excellentBalance = results.portfolioBalance?.category === 'optimal';
        const perfectTriage = results.falseNegatives === 0 && results.trueNegatives >= 2;
        
        // Penalty for all-safe portfolio (pedagogical: don't just play it safe)
        const tooConservative = results.portfolioBalance?.category === 'too_safe';
        const playedItSafe = results.incrementalCount >= results.totalPortfolio * 0.7 && results.transformationalSuccesses === 0;
        
        // Determine outcome based on composite score and factors
        
        // TOP TIER: CTO or Venture Lead
        if (compositeScore >= 75 || hasBlockbuster) {
            if (hasBlockbuster && excellentBalance && goodKillDiscipline) {
                return {
                    outcome: 'cto',
                    icon: '🚀',
                    title: 'Promoted to Chief Technology Officer',
                    subtitle: 'The board was so impressed, they\'ve elevated you to the C-suite',
                    gradient: 'linear-gradient(135deg, #059669 0%, #10b981 100%)',
                    narrative: `Your exceptional R&D leadership delivered ${results.truePositives} successful project(s) including transformational wins, with a ${results.roi}% ROI. Your balanced portfolio strategy — mixing stable bets with breakthrough opportunities — proved masterful. The board unanimously voted to promote you to CTO, citing your "rare combination of strategic vision, risk management, and execution discipline." Your willingness to both back bold bets AND cut underperformers showed true portfolio management skill.`,
                    boardMood: 'delighted',
                    compositeScore
                };
            } else {
                return {
                    outcome: 'venture_lead',
                    icon: '⭐',
                    title: 'Tapped to Lead New Corporate Venture',
                    subtitle: 'Your success has earned you a high-profile spin-off opportunity',
                    gradient: 'linear-gradient(135deg, #7c3aed 0%, #a78bfa 100%)',
                    narrative: `With ${results.truePositives} successful launches and a ${results.hitRate}% hit rate${hasTransformationalSuccess ? ', including breakthrough project wins' : ''}, the board sees you as someone who can spot and scale winners. They've asked you to lead a new corporate venture unit with $100M in seed capital. Your appetite for strategic risk, combined with your ${results.killQuality?.points > 0 ? 'good portfolio discipline' : 'results focus'}, makes you the right choice for this growth role.`,
                    boardMood: 'impressed',
                    compositeScore
                };
            }
        } 
        
        // UPPER-MID TIER: Senior Director or Retention
        else if (compositeScore >= 50 || (results.truePositives >= 2 && results.roi >= 0)) {
            if (goodKillDiscipline && perfectTriage) {
                return {
                    outcome: 'senior_director',
                    icon: '📈',
                    title: 'Promoted to Senior Director of R&D',
                    subtitle: 'Your portfolio discipline caught leadership\'s attention',
                    gradient: 'linear-gradient(135deg, #2563eb 0%, #60a5fa 100%)',
                    narrative: `While not every bet paid off, your ${results.trueNegatives} well-reasoned rejections and zero missed opportunities demonstrated strong judgment. Your kill quality score of ${results.killQuality?.points} points shows you understand when to persist and when to cut. The CFO particularly appreciated how you "avoided throwing good money after bad." You've been promoted to Senior Director with expanded oversight.`,
                    boardMood: 'satisfied',
                    compositeScore
                };
            } else if (tooConservative || playedItSafe) {
                // Penalty for playing it too safe even with decent results
                return {
                    outcome: 'reassigned_safe',
                    icon: '🔒',
                    title: 'Reassigned to Operations Role',
                    subtitle: 'Your safe approach limited upside potential',
                    gradient: 'linear-gradient(135deg, #ea580c 0%, #f97316 100%)',
                    narrative: `Your portfolio achieved modest returns with a ${results.hitRate}% hit rate, but the board is concerned about your conservative approach. With ${results.incrementalCount} incremental projects and no transformational wins, you missed the growth opportunities ShieldTech needed. "We hired you to find breakthrough innovations, not optimise existing products," the CEO noted. You've been reassigned to Operations where your risk-averse approach may be more suitable.`,
                    boardMood: 'disappointed',
                    compositeScore
                };
            } else {
                return {
                    outcome: 'retention',
                    icon: '🤝',
                    title: 'Retained with Performance Bonus',
                    subtitle: 'Solid results — you\'ve earned another year to prove yourself',
                    gradient: 'linear-gradient(135deg, #0891b2 0%, #22d3ee 100%)',
                    narrative: `Your portfolio achieved ${results.truePositives} success(es) with a ${results.hitRate}% hit rate. ${excellentBalance ? 'Your balanced approach to risk was noted.' : 'The board would like to see more strategic risk-taking.'} ${results.killQuality?.points > 0 ? 'Your portfolio tending showed promise.' : 'Consider being more active in managing underperformers.'} You've earned a continuation with modest bonus.`,
                    boardMood: 'neutral',
                    compositeScore
                };
            }
        } 
        
        // LOWER-MID TIER: Probation or Reassignment
        else if (compositeScore >= 30 || results.truePositives >= 1) {
            if (missedBigOnes) {
                return {
                    outcome: 'reassigned',
                    icon: '↩️',
                    title: 'Reassigned to Operations Role',
                    subtitle: 'The board has "found a better fit" for your talents',
                    gradient: 'linear-gradient(135deg, #ea580c 0%, #f97316 100%)',
                    narrative: `While you had ${results.truePositives} success(es), the board is troubled by the ${results.falseNegatives} opportunities you passed on that would have succeeded. ${results.killQuality?.points < -5 ? 'Your kill decisions also raised concerns — several projects you cut were showing promise.' : ''} "You showed good execution but poor selection," the CEO noted. You've been reassigned to Operations Excellence — away from strategic R&D decisions.`,
                    boardMood: 'disappointed',
                    compositeScore
                };
            } else if (results.killQuality?.points < -5) {
                return {
                    outcome: 'probation_kills',
                    icon: '⚠️',
                    title: 'Placed on Performance Improvement Plan',
                    subtitle: 'Your portfolio management needs work',
                    gradient: 'linear-gradient(135deg, #d97706 0%, #fbbf24 100%)',
                    narrative: `With a ${results.hitRate}% hit rate, the board has concerns about your portfolio management. ${results.killQuality.analysis.filter(k => k.points < 0).slice(0, 2).map(k => k.analysis).join('. ')}. You've been placed on a 90-day improvement plan. The board wants to see more thoughtful tending of the portfolio — knowing when to persist with transformational bets and when to cut incremental losers.`,
                    boardMood: 'concerned',
                    compositeScore
                };
            } else {
                return {
                    outcome: 'probation',
                    icon: '⚠️',
                    title: 'Placed on Performance Improvement Plan',
                    subtitle: 'The board is giving you 90 days to turn things around',
                    gradient: 'linear-gradient(135deg, #d97706 0%, #fbbf24 100%)',
                    narrative: `With a ${results.hitRate}% hit rate and ${results.falsePositives} failed investment(s), the board has concerns. ${!excellentBalance ? 'Your portfolio balance could be improved. ' : ''}${results.activeManagementBonus?.qualifies ? '' : 'The board would like to see more active portfolio management. '}You've been placed on a 90-day improvement plan with monthly reviews.`,
                    boardMood: 'concerned',
                    compositeScore
                };
            }
        } 
        
        // BOTTOM TIER: Fired or Demoted
        else {
            if (isDisaster) {
                return {
                    outcome: 'fired',
                    icon: '📦',
                    title: 'Position Eliminated',
                    subtitle: 'The board has decided to "restructure" the R&D function',
                    gradient: 'linear-gradient(135deg, #b91c1c 0%, #ef4444 100%)',
                    narrative: `With ${results.falsePositives} failed projects, $${results.waste.toFixed(0)}M in wasted R&D spend, and a ${results.roi}% ROI, the board has lost confidence. ${tooConservative ? 'Your conservative portfolio produced neither safety nor returns.' : 'Random project selection would have performed as well.'} ${results.killQuality?.points < 0 ? 'Your kill decisions compounded the problem.' : ''} The R&D organization is being restructured.`,
                    boardMood: 'furious',
                    compositeScore
                };
            } else {
                return {
                    outcome: 'demoted',
                    icon: '⬇️',
                    title: 'Demoted to Project Manager',
                    subtitle: 'The board has "rightsized" your responsibilities',
                    gradient: 'linear-gradient(135deg, #dc2626 0%, #f87171 100%)',
                    narrative: `Your portfolio's ${results.hitRate}% hit rate and ${results.roi < 0 ? 'negative' : 'weak'} returns have convinced the board you're not ready for portfolio-level decisions. ${!results.activeManagementBonus?.qualifies ? 'Your passive management approach didn\'t help. ' : ''}You've been demoted to Project Manager for a single lower-risk initiative. It's a significant step back, but a chance to rebuild through execution.`,
                    boardMood: 'frustrated',
                    compositeScore
                };
            }
        }
    }
    
    function generateBoardFeedback(results, careerOutcome) {
        const feedback = [];
        
        // CEO feedback based on outcome
        const ceoQuotes = {
            delighted: `"Exceptional performance. You've demonstrated exactly the kind of strategic thinking we need at the executive level. I'm personally recommending you to the board."`,
            impressed: `"You've shown real talent for identifying winners. I want you working on our highest-priority strategic initiatives going forward."`,
            satisfied: `"Solid work this year. You've proven you can manage a portfolio responsibly. Let's see if you can push for more breakthrough wins next year."`,
            neutral: `"Mixed results, but you've shown potential. The board is watching closely to see how you adapt your approach."`,
            concerned: `"We expected more from someone in your position. You need to demonstrate better judgment in project selection going forward."`,
            disappointed: `"I'm disappointed. We missed opportunities and wasted resources. Something needs to change."`,
            frustrated: `"This isn't working. We need to see immediate improvement or we'll need to make changes."`,
            furious: `"I won't sugarcoat this — your tenure has been a failure. We're taking corrective action immediately."`
        };
        
        feedback.push(`<div style="margin-bottom: 15px;"><strong>CEO Meera Venkataraman:</strong><br/><em style="color: rgba(255,255,255,0.85);">${ceoQuotes[careerOutcome.boardMood]}</em></div>`);
        
        // CFO feedback on financials
        if (results.roi > 30) {
            feedback.push(`<div style="margin-bottom: 15px;"><strong>CFO Farhan Qureshi:</strong><br/><em style="color: rgba(255,255,255,0.85);">"${results.roi}% ROI — these are the returns we need to see. Your financial discipline is commendable."</em></div>`);
        } else if (results.roi < 0) {
            feedback.push(`<div style="margin-bottom: 15px;"><strong>CFO Farhan Qureshi:</strong><br/><em style="color: rgba(255,255,255,0.85);">"$${results.waste.toFixed(0)}M in sunk costs with negative returns. We need to have a serious conversation about your evaluation criteria."</em></div>`);
        }
        
        // Portfolio balance feedback
        if (results.portfolioBalance) {
            const balance = results.portfolioBalance;
            if (balance.category === 'optimal') {
                feedback.push(`<div style="margin-bottom: 15px;"><strong>CTO Vikram Patel:</strong><br/><em style="color: rgba(255,255,255,0.85);">"Excellent portfolio balance. You understood that we need both stable revenue streams and breakthrough bets. That's sophisticated R&D thinking."</em></div>`);
            } else if (balance.category === 'too_safe') {
                feedback.push(`<div style="margin-bottom: 15px;"><strong>CTO Vikram Patel:</strong><br/><em style="color: rgba(255,255,255,0.85);">"Your portfolio was too conservative. We hired you to find transformational opportunities, not just optimise what we already have. Where's the ambition?"</em></div>`);
            } else if (balance.category === 'too_risky') {
                feedback.push(`<div style="margin-bottom: 15px;"><strong>CTO Vikram Patel:</strong><br/><em style="color: rgba(255,255,255,0.85);">"All moonshots and no foundation. We need some stable projects to fund the bold bets. Pure gambling isn't a strategy."</em></div>`);
            }
        }
        
        // Kill quality feedback
        if (results.killQuality) {
            const kills = results.killQuality;
            if (kills.points >= 8) {
                feedback.push(`<div style="margin-bottom: 15px;"><strong>Board Observer:</strong><br/><em style="color: rgba(255,255,255,0.85);">"Impressive portfolio tending. You knew when to be patient with transformational projects and when to cut incremental losers. That's rare judgment."</em></div>`);
            } else if (kills.points >= 3) {
                feedback.push(`<div style="margin-bottom: 15px;"><strong>Board Observer:</strong><br/><em style="color: rgba(255,255,255,0.85);">"Good discipline in managing the portfolio. Your kill decisions saved capital and freed resources for better opportunities."</em></div>`);
            } else if (kills.points <= -5) {
                const badKills = kills.analysis.filter(k => k.points < 0).slice(0, 1);
                const example = badKills.length > 0 ? ` ${badKills[0].analysis}.` : '';
                feedback.push(`<div style="margin-bottom: 15px;"><strong>Board Observer:</strong><br/><em style="color: rgba(255,255,255,0.85);">"Your kill timing needs work.${example} Understanding when to persist vs. cut is a critical skill you should develop."</em></div>`);
            }
        }
        
        // Strategic bucket coverage feedback
        if (results.bucketCoverage) {
            const coverage = results.bucketCoverage;
            if (coverage.coveredBuckets === 4) {
                feedback.push(`<div style="margin-bottom: 15px;"><strong>Strategy Director:</strong><br/><em style="color: rgba(255,255,255,0.85);">"Full strategic coverage. Your portfolio touched all our key growth vectors. That's aligned thinking."</em></div>`);
            } else if (coverage.concentrationPenalty > 0) {
                feedback.push(`<div style="margin-bottom: 15px;"><strong>Strategy Director:</strong><br/><em style="color: rgba(255,255,255,0.85);">"Concentration risk concerns me. Over 60% of budget in one strategic bucket exposes us to sector-specific downturns."</em></div>`);
            }
        }
        
        // Transformational success feedback
        if (results.transformationalSuccesses >= 2) {
            feedback.push(`<div style="margin-bottom: 15px;"><strong>Innovation Committee Chair:</strong><br/><em style="color: rgba(255,255,255,0.85);">"Multiple breakthrough wins! You proved that strategic risk-taking pays off when done thoughtfully. This is exactly what we hoped for."</em></div>`);
        } else if (results.transformationalCount === 0) {
            feedback.push(`<div style="margin-bottom: 15px;"><strong>Innovation Committee Chair:</strong><br/><em style="color: rgba(255,255,255,0.85);">"I'm concerned we had no transformational projects in the portfolio. Where's our next growth engine going to come from?"</em></div>`);
        }
        
        // Active management feedback
        if (results.activeManagementBonus && !results.activeManagementBonus.qualifies) {
            feedback.push(`<div><strong>HR Director:</strong><br/><em style="color: rgba(255,255,255,0.85);">"The portfolio seemed to run itself. Active management — making tough calls on when to accelerate, reduce, or kill — is part of the job."</em></div>`);
        }
        
        return feedback.join('');
    }
    
    function calculateResults() {
        let truePositives = 0, falsePositives = 0, falseNegatives = 0, trueNegatives = 0, totalRevenue = 0, totalSpent = 0, waste = 0, missed = 0;
        
        // Track risk class distribution of funded projects
        let incrementalCount = 0, moderateCount = 0, transformationalCount = 0;
        let incrementalSuccesses = 0, transformationalSuccesses = 0;
        
        gameState.completedProjects.forEach(p => {
            totalSpent += p.spentBudget;
            const riskClass = p.riskClass || getProjectRiskClass(p.archetype);
            
            if (riskClass === 'incremental') incrementalCount++;
            else if (riskClass === 'transformational') transformationalCount++;
            else moderateCount++;
            
            if (p.outcome === 'success') { 
                truePositives++; 
                totalRevenue += p.revenue;
                if (riskClass === 'incremental') incrementalSuccesses++;
                if (riskClass === 'transformational') transformationalSuccesses++;
            }
            else { falsePositives++; waste += p.spentBudget; }
        });
        
        // Count active projects too for portfolio composition
        gameState.activeProjects.forEach(p => {
            const riskClass = p.riskClass || getProjectRiskClass(p.archetype);
            if (riskClass === 'incremental') incrementalCount++;
            else if (riskClass === 'transformational') transformationalCount++;
            else moderateCount++;
        });
        
        gameState.killedProjects.forEach(p => {
            totalSpent += p.spentBudget;
            const wouldSucceed = Math.random() < p.successProb;
            p.wouldSucceed = wouldSucceed;
            if (wouldSucceed) { falseNegatives++; missed += p.budget * (p.roiMultiplier || 2.5); } else { trueNegatives++; }
        });
        
        gameState.rejectedProjects.forEach(p => {
            const wouldSucceed = Math.random() < p.successProb;
            p.wouldSucceed = wouldSucceed;
            if (wouldSucceed) { falseNegatives++; missed += p.budget * (p.roiMultiplier || 2.5); } else { trueNegatives++; }
        });
        
        const totalFunded = truePositives + falsePositives;
        const totalPortfolio = incrementalCount + moderateCount + transformationalCount;
        
        // Calculate Portfolio Balance Score
        const portfolioBalance = calculatePortfolioBalance(incrementalCount, moderateCount, transformationalCount, totalPortfolio);
        
        // Calculate Strategic Bucket Coverage
        const bucketCoverage = calculateBucketCoverage();
        
        // Calculate Kill Decision Quality
        const killQuality = calculateKillQuality();
        
        // Calculate Active Management Bonus
        const activeManagementBonus = calculateActiveManagementBonus();
        
        return {
            truePositives, falsePositives, falseNegatives, trueNegatives,
            hitRate: totalFunded > 0 ? Math.round((truePositives / totalFunded) * 100) : 0,
            roi: totalSpent > 0 ? Math.round(((totalRevenue - totalSpent) / totalSpent) * 100) : 0,
            waste, missed, totalRevenue, totalSpent,
            // New portfolio scoring dimensions
            portfolioBalance,
            bucketCoverage,
            killQuality,
            activeManagementBonus,
            // Risk distribution stats
            incrementalCount,
            moderateCount, 
            transformationalCount,
            incrementalSuccesses,
            transformationalSuccesses,
            totalPortfolio
        };
    }
    
    // Calculate portfolio balance multiplier based on risk mix
    function calculatePortfolioBalance(incremental, moderate, transformational, total) {
        if (total === 0) return { multiplier: 1.0, description: 'No projects to evaluate', category: 'neutral' };
        
        const incrementalPct = (incremental / total) * 100;
        const transformationalPct = (transformational / total) * 100;
        
        // All incremental - penalize playing it too safe
        if (incrementalPct >= 80) {
            return { 
                multiplier: 0.7, 
                description: 'Portfolio too conservative - all safe bets limit upside',
                category: 'too_safe'
            };
        }
        
        // All transformational - penalize reckless betting
        if (transformationalPct >= 80) {
            return { 
                multiplier: 0.8, 
                description: 'Portfolio too risky - no stable foundation',
                category: 'too_risky'
            };
        }
        
        // Heavily unbalanced (>70% either way)
        if (incrementalPct >= 70 || transformationalPct >= 70) {
            return { 
                multiplier: 0.9, 
                description: 'Portfolio somewhat unbalanced',
                category: 'unbalanced'
            };
        }
        
        // Optimal balance (some incremental, some transformational, room for moderate)
        const hasIncremental = incremental >= 1;
        const hasTransformational = transformational >= 1;
        const goodMix = hasIncremental && hasTransformational && incrementalPct >= 20 && transformationalPct >= 20;
        
        if (goodMix) {
            return { 
                multiplier: 1.1, 
                description: 'Excellent portfolio balance - stable foundation with growth bets',
                category: 'optimal'
            };
        }
        
        // Balanced but not optimal
        return { 
            multiplier: 1.0, 
            description: 'Reasonable portfolio balance',
            category: 'balanced'
        };
    }
    
    // Calculate strategic bucket coverage bonus/penalty
    function calculateBucketCoverage() {
        const bucketIds = ['defend-metro', 'tier23-rollout', 'recurring-revenue', 'ai-first'];
        const bucketCounts = {};
        let totalBudgetByBucket = {};
        let totalBudget = 0;
        
        bucketIds.forEach(id => {
            bucketCounts[id] = 0;
            totalBudgetByBucket[id] = 0;
        });
        
        // Count projects in each bucket (completed + active)
        const allProjects = [...gameState.completedProjects, ...gameState.activeProjects];
        allProjects.forEach(p => {
            totalBudget += p.budget;
            (p.strategicBuckets || []).forEach(bucket => {
                if (bucket && bucket.id) {
                    bucketCounts[bucket.id] = (bucketCounts[bucket.id] || 0) + 1;
                    totalBudgetByBucket[bucket.id] = (totalBudgetByBucket[bucket.id] || 0) + p.budget;
                }
            });
        });
        
        // Calculate coverage bonus (+5% per bucket with at least one project)
        const coveredBuckets = bucketIds.filter(id => bucketCounts[id] > 0).length;
        const coverageBonus = coveredBuckets * 0.05;
        
        // Calculate concentration penalty (-10% if >60% of budget in single bucket)
        let concentrationPenalty = 0;
        let concentratedBucket = null;
        bucketIds.forEach(id => {
            if (totalBudget > 0 && (totalBudgetByBucket[id] / totalBudget) > 0.6) {
                concentrationPenalty = 0.10;
                concentratedBucket = id;
            }
        });
        
        return {
            coveredBuckets,
            coverageBonus,
            concentrationPenalty,
            concentratedBucket,
            netBonus: coverageBonus - concentrationPenalty,
            bucketCounts,
            description: concentrationPenalty > 0 
                ? `${coveredBuckets}/4 buckets covered, but over-concentrated in one area`
                : `${coveredBuckets}/4 strategic buckets covered`
        };
    }
    
    // Calculate kill decision quality score
    function calculateKillQuality() {
        let killQualityPoints = 0;
        const killAnalysis = [];
        
        gameState.killDecisions.forEach(kill => {
            const quarter = kill.killedAtQuarter;
            const riskClass = kill.riskClass;
            const signal = kill.signalStrength;
            const wasGood = kill.wasPerformingWell;
            
            // Determine kill timing category
            let timing = 'mid'; // Q3-4
            if (quarter <= 2) timing = 'early'; // Q1-2
            else if (quarter >= 5) timing = 'late'; // Q5+
            
            // Score based on project type, timing, and signals
            let points = 0;
            let analysis = '';
            
            if (riskClass === 'incremental') {
                // Incremental projects with poor signals should be killed early/mid
                if (signal === 'red' || !wasGood) {
                    if (timing === 'early') { points = 5; analysis = 'Good discipline: killed underperforming safe bet early'; }
                    else if (timing === 'mid') { points = 3; analysis = 'Reasonable: killed struggling incremental project'; }
                    else { points = -3; analysis = 'Wasted resources: held failing incremental too long'; }
                } else {
                    // Incremental with good signals - killing is questionable
                    if (timing === 'early') { points = -3; analysis = 'Premature: killed promising incremental project'; }
                    else { points = 0; analysis = 'Neutral: killed performing incremental project'; }
                }
            } else if (riskClass === 'transformational') {
                // Transformational projects need patience - early kills are bad
                if (signal === 'red' || !wasGood) {
                    if (timing === 'early') { points = -5; analysis = 'Too hasty: transformational projects need runway'; }
                    else if (timing === 'mid') { points = 0; analysis = 'Reasonable: gave transformational project a chance'; }
                    else { points = 5; analysis = 'Good judgment: appropriate persistence before cutting'; }
                } else {
                    // Transformational with good signals - killing is very bad
                    if (timing === 'early') { points = -8; analysis = 'Major mistake: killed promising breakthrough project'; }
                    else if (timing === 'mid') { points = -5; analysis = 'Questionable: killed transformational project showing progress'; }
                    else { points = -3; analysis = 'Late pivot: killed breakthrough project that was working'; }
                }
            } else {
                // Moderate risk projects - balanced approach
                if (signal === 'red' || !wasGood) {
                    if (timing === 'early') { points = 2; analysis = 'Proactive: cut moderate-risk project showing problems'; }
                    else if (timing === 'mid') { points = 3; analysis = 'Good timing: killed struggling project mid-cycle'; }
                    else { points = 0; analysis = 'Late but reasonable: finally cut underperformer'; }
                } else {
                    points = -2; analysis = 'Questionable: killed moderate project that was on track';
                }
            }
            
            killQualityPoints += points;
            killAnalysis.push({
                projectName: kill.projectName,
                points,
                analysis,
                timing,
                riskClass,
                signal
            });
        });
        
        return {
            points: killQualityPoints,
            analysis: killAnalysis,
            totalKills: gameState.killDecisions.length,
            description: killQualityPoints > 5 
                ? 'Excellent kill discipline - you tended the portfolio well'
                : killQualityPoints < -5 
                    ? 'Poor kill timing - review when to cut vs. persist'
                    : 'Reasonable kill decisions overall'
        };
    }
    
    // Calculate active management bonus
    function calculateActiveManagementBonus() {
        const totalProjects = gameState.completedProjects.length + gameState.activeProjects.length + gameState.killedProjects.length;
        const decisionsRatio = totalProjects > 0 ? gameState.activeDecisionsMade / totalProjects : 0;
        
        // Active management bonus if player made decisions on 50%+ of projects
        const qualifies = decisionsRatio >= 0.5;
        const bonus = qualifies ? 5 : 0;
        
        return {
            bonus,
            decisionsRatio: Math.round(decisionsRatio * 100),
            qualifies,
            description: qualifies 
                ? 'Active portfolio management demonstrated'
                : 'Portfolio was largely passive - consider more active tending'
        };
    }
    
    function generateProcessInsights(results) {
        const insights = [];
        
        if (gameState.decisionModel === 'solo') {
            insights.push(`<div class="insight-item">You made all decisions alone. Speed was maximized but individual biases shaped the portfolio. ${results.falsePositives > 2 ? 'Several failures suggest blind spots.' : ''}</div>`);
        } else if (gameState.decisionModel === 'committee') {
            const names = gameState.committee.slice(0, 4).map(id => findStaff(id)?.name.split(' ')[0]).join(', ');
            const more = gameState.committee.length > 4 ? ` and ${gameState.committee.length - 4} others` : '';
            insights.push(`<div class="insight-item">Your committee (${names}${more}) brought ${gameState.committee.length} perspectives. ${results.truePositives > results.falsePositives ? 'Diverse views helped find opportunities.' : 'However, collective biases may have emerged.'}</div>`);
        } else if (gameState.decisionModel === 'jury') {
            insights.push(`<div class="insight-item">Staff jury selection democratized decisions. ${results.hitRate > 50 ? 'Fresh eyes found winners.' : 'Variable expertise led to inconsistent results.'}</div>`);
        } else {
            insights.push(`<div class="insight-item">Random selection removed bias entirely. ${results.hitRate}% hit rate shows expertise's value (or lack thereof) in uncertain domains.</div>`);
        }
        
        // Criteria-based insights
        const criteria = gameState.criteria;
        
        if (criteria.includes('strategic') && !criteria.includes('newmarket')) {
            insights.push(`<div class="insight-item">Prioritising strategic fit without new market creation may have led to internally coherent but incrementally focused choices.</div>`);
        }
        
        if (criteria.includes('marketsize') && !criteria.includes('sustainability')) {
            insights.push(`<div class="insight-item">Focus on market size without sustainability criteria may have missed emerging ESG-conscious segments.</div>`);
        }
        
        if (criteria.includes('devcost') && criteria.includes('roi')) {
            insights.push(`<div class="insight-item">Double emphasis on development cost and ROI created strong financial discipline — but may have filtered out higher-risk, higher-reward opportunities.</div>`);
        }
        
        if (criteria.includes('ip') && results.truePositives > 0) {
            insights.push(`<div class="insight-item">IP focus helped identify projects with defensible advantages. Consider if this came at the cost of speed to market.</div>`);
        }
        
        if (criteria.includes('geographic') && results.falseNegatives > 2) {
            insights.push(`<div class="insight-item">Geographic expansion focus may have overlooked strong opportunities in existing markets.</div>`);
        }
        
        if (criteria.includes('capability') && !criteria.includes('newmarket')) {
            insights.push(`<div class="insight-item">Strong focus on core capabilities without new market criteria may have reinforced existing strengths while missing adjacent opportunities.</div>`);
        }
        
        if (criteria.includes('risk') && results.falseNegatives > results.falsePositives) {
            insights.push(`<div class="insight-item">Risk-focused criteria protected against failures but may have filtered out promising uncertain opportunities (more false negatives than false positives).</div>`);
        }
        
        if (criteria.includes('speed') && !criteria.includes('platform')) {
            insights.push(`<div class="insight-item">Time-to-market focus without platform thinking may have favoured quick wins over long-term positioning.</div>`);
        }
        
        if (criteria.includes('technical') && results.falsePositives > 2) {
            insights.push(`<div class="insight-item">Technical feasibility was prioritised, but ${results.falsePositives} projects still failed. Technical excellence ≠ market success.</div>`);
        }
        
        return insights.length ? insights.join('') : '<div class="insight-item">Your process produced mixed results. Consider how different criteria choices might change outcomes.</div>';
    }
    
    function generateCounterfactuals() {
        const reveals = [];
        
        gameState.killedProjects.filter(p => p.wouldSucceed).slice(0, 3).forEach(p => {
            reveals.push(`<div class="insight-item" style="border-left-color: var(--warning);"><strong>${p.name}</strong> (Killed): Would have succeeded. ${p.outcomeNarrative.success}</div>`);
        });
        
        gameState.rejectedProjects.filter(p => p.wouldSucceed).slice(0, 3).forEach(p => {
            reveals.push(`<div class="insight-item" style="border-left-color: var(--warning);"><strong>${p.name}</strong> (Never funded): Would have succeeded. ${p.outcomeNarrative.success}</div>`);
        });
        
        const goodKills = gameState.killedProjects.filter(p => !p.wouldSucceed);
        if (goodKills.length) {
            reveals.push(`<div class="insight-item" style="border-left-color: var(--success);"><strong>Good calls:</strong> Killed ${goodKills.length} project(s) that would have failed.</div>`);
        }
        
        return reveals.length ? reveals.join('') : '<div class="insight-item">All decisions aligned with outcomes — impressive!</div>';
    }
    
    function restartGame() {
        gameState = {
            phase: 'landing', decisionModel: null, committee: ['meera'], criteria: [],
            criteriaWeights: {},
            budget: 30, maxBudget: 30, selectedProjects: [], activeProjects: [],
            completedProjects: [], killedProjects: [], rejectedProjects: [],
            currentQuarter: 1, maxQuarters: 8, currentModalStaff: null, 
            currentModalProject: null, rankedProjects: null, projectPool: [],
            currentAssessmentIndex: 0,
            // Legacy project state
            legacyProjects: [], legacyBudget: { committed: 0, spent: 0, freed: 0 },
            legacyBudgetCommitted: 0, activeLegacyProjects: [], pausedProjects: [],
            currentLegacyProject: null, freedFromLegacy: 0,
            // Budget protection flag
            year1SelectionLocked: false,
            // Corporate events state
            currentEvent: null, activeEffects: [], eventHistory: [], pendingEventCallback: null,
            // Kill decision tracking for portfolio scoring
            killDecisions: [],
            activeDecisionsMade: 0
        };
        document.querySelectorAll('.model-card').forEach(c => c.classList.remove('selected'));
        document.querySelectorAll('.criteria-card').forEach(c => c.classList.remove('selected'));
        document.querySelectorAll('.criteria-tile').forEach(c => c.classList.remove('selected'));
        showPhase('landing');
    }
    
    // ========== COMMITTEE CHAOS MINI-GAME (EMBEDDED) ==========
    
    var CC_GAME_BASE64 = "PCFET0NUWVBFIGh0bWw+CjxodG1sIGxhbmc9ImVuIj4KPGhlYWQ+CiAgICA8bWV0YSBjaGFyc2V0PSJVVEYtOCI+CiAgICA8bWV0YSBuYW1lPSJ2aWV3cG9ydCIgY29udGVudD0id2lkdGg9ZGV2aWNlLXdpZHRoLCBpbml0aWFsLXNjYWxlPTEuMCI+CiAgICA8dGl0bGU+Q29tbWl0dGVlIENoYW9zPC90aXRsZT4KICAgIDxzdHlsZT4KICAgICAgICAqIHsgbWFyZ2luOiAwOyBwYWRkaW5nOiAwOyBib3gtc2l6aW5nOiBib3JkZXItYm94OyB9CiAgICAgICAgCiAgICAgICAgOnJvb3QgewogICAgICAgICAgICAtLWF1YmVyZ2luZTogIzVDMkQ1QzsKICAgICAgICAgICAgLS1hdWJlcmdpbmUtbGlnaHQ6ICM3QTQwODA7CiAgICAgICAgICAgIC0tZ29sZDogI0M5QTIyNzsKICAgICAgICAgICAgLS1nb2xkLWxpZ2h0OiAjRThDNTQ3OwogICAgICAgICAgICAtLXN1Y2Nlc3M6ICMxNkEzNEE7CiAgICAgICAgICAgIC0td2FybmluZzogI0Q5NzcwNjsKICAgICAgICAgICAgLS1kYW5nZXI6ICNEQzI2MjY7CiAgICAgICAgICAgIC0tYmctcGFnZTogI0YwRUJFMzsKICAgICAgICAgICAgLS1iZy13aGl0ZTogI0ZGRkZGRjsKICAgICAgICAgICAgLS1iZy1jcmVhbTogI0ZBRjhGNTsKICAgICAgICAgICAgLS1iZy1saWdodDogI0Y1RjBFODsKICAgICAgICAgICAgLS10ZXh0LWRhcms6ICMxRjI5Mzc7CiAgICAgICAgICAgIC0tdGV4dC1tZWRpdW06ICM0QjU1NjM7CiAgICAgICAgICAgIC0tdGV4dC1saWdodDogIzZCNzI4MDsKICAgICAgICAgICAgLS1ib3JkZXI6ICNEMUM3Qjc7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGJvZHkgewogICAgICAgICAgICBmb250LWZhbWlseTogJ1NlZ29lIFVJJywgc3lzdGVtLXVpLCBzYW5zLXNlcmlmOwogICAgICAgICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1iZy1wYWdlKTsKICAgICAgICAgICAgaGVpZ2h0OiAxMDB2aDsKICAgICAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICAgICAgYWxpZ24taXRlbXM6IHN0cmV0Y2g7CiAgICAgICAgICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgICAgICAgICBwYWRkaW5nOiAwOwogICAgICAgICAgICBtYXJnaW46IDA7CiAgICAgICAgICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC5nYW1lLWNvbnRhaW5lciB7CiAgICAgICAgICAgIHdpZHRoOiAxMDAlOwogICAgICAgICAgICBoZWlnaHQ6IDEwMHZoOwogICAgICAgICAgICBtYXgtd2lkdGg6IDEwMCU7CiAgICAgICAgICAgIGJhY2tncm91bmQ6IHZhcigtLWJnLXdoaXRlKTsKICAgICAgICAgICAgb3ZlcmZsb3c6IGhpZGRlbjsKICAgICAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICAgICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLyogPT09PT09PT09PSBUSVRMRSBTQ1JFRU4gPT09PT09PT09PSAqLwogICAgICAgIC50aXRsZS1zY3JlZW4gewogICAgICAgICAgICBwYWRkaW5nOiAzdmggM3Z3OwogICAgICAgICAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTgwZGVnLCB2YXIoLS1iZy1jcmVhbSkgMCUsIHZhcigtLWJnLXdoaXRlKSAxMDAlKTsKICAgICAgICAgICAgb3ZlcmZsb3cteTogYXV0bzsKICAgICAgICAgICAgaGVpZ2h0OiAxMDB2aDsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLnRpdGxlLWhlYWRlciB7CiAgICAgICAgICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogM3ZoOwogICAgICAgICAgICBwYWRkaW5nLWJvdHRvbTogMnZoOwogICAgICAgICAgICBib3JkZXItYm90dG9tOiAycHggc29saWQgdmFyKC0tYm9yZGVyKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLnRpdGxlLWhlYWRlciBoMSB7IAogICAgICAgICAgICBmb250LXNpemU6IGNsYW1wKDEuOGVtLCA1dncsIDNlbSk7IAogICAgICAgICAgICBjb2xvcjogdmFyKC0tYXViZXJnaW5lKTsgCiAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDF2aDsKICAgICAgICB9CiAgICAgICAgLnRpdGxlLWhlYWRlciAuc3VidGl0bGUgeyAKICAgICAgICAgICAgZm9udC1zaXplOiBjbGFtcCgwLjllbSwgMnZ3LCAxLjNlbSk7IAogICAgICAgICAgICBjb2xvcjogdmFyKC0tdGV4dC1tZWRpdW0pOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAudHV0b3JpYWwtY29udGFpbmVyIHsKICAgICAgICAgICAgbWF4LXdpZHRoOiA5MDBweDsKICAgICAgICAgICAgbWFyZ2luOiAwIGF1dG87CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC50dXRvcmlhbC1zZWN0aW9uIHsKICAgICAgICAgICAgYmFja2dyb3VuZDogdmFyKC0tYmctbGlnaHQpOwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiAxMnB4OwogICAgICAgICAgICBwYWRkaW5nOiAydmggMnZ3OwogICAgICAgICAgICBtYXJnaW4tYm90dG9tOiAydmg7CiAgICAgICAgICAgIGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWJvcmRlcik7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC50dXRvcmlhbC1zZWN0aW9uIGgzIHsKICAgICAgICAgICAgY29sb3I6IHZhcigtLWF1YmVyZ2luZSk7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogY2xhbXAoMC45NWVtLCAyLjJ2dywgMS4zZW0pOwogICAgICAgICAgICBtYXJnaW4tYm90dG9tOiAxLjV2aDsKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDcwMDsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLnR1dG9yaWFsLXNlY3Rpb24gcCB7CiAgICAgICAgICAgIGNvbG9yOiB2YXIoLS10ZXh0LWRhcmspOwogICAgICAgICAgICBmb250LXNpemU6IGNsYW1wKDAuODVlbSwgMS44dncsIDEuMWVtKTsKICAgICAgICAgICAgbGluZS1oZWlnaHQ6IDEuNjsKICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogMS41dmg7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC5oaWdobGlnaHQgeyBjb2xvcjogdmFyKC0tYXViZXJnaW5lKTsgZm9udC13ZWlnaHQ6IDcwMDsgfQogICAgICAgIC5kYW5nZXItdGV4dCB7IGNvbG9yOiB2YXIoLS1kYW5nZXIpOyBmb250LXdlaWdodDogNjAwOyB9CiAgICAgICAgLnN1Y2Nlc3MtdGV4dCB7IGNvbG9yOiB2YXIoLS1zdWNjZXNzKTsgZm9udC13ZWlnaHQ6IDYwMDsgfQogICAgICAgIAogICAgICAgIC50d28tY29sIHsKICAgICAgICAgICAgZGlzcGxheTogZ3JpZDsKICAgICAgICAgICAgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOiAxZnIgMWZyOwogICAgICAgICAgICBnYXA6IDJ2dzsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLmluZm8tcm93IHsKICAgICAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICAgICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgICAgICAgICAgZ2FwOiAxLjV2dzsKICAgICAgICAgICAgcGFkZGluZzogMS41dmggMS41dnc7CiAgICAgICAgICAgIGJhY2tncm91bmQ6IHZhcigtLWJnLXdoaXRlKTsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogMTBweDsKICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogMS41dmg7CiAgICAgICAgICAgIGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWJvcmRlcik7CiAgICAgICAgfQogICAgICAgIC5pbmZvLXJvdzpsYXN0LWNoaWxkIHsgbWFyZ2luLWJvdHRvbTogMDsgfQogICAgICAgIC5pbmZvLXJvdyAuaS1pY29uIHsgZm9udC1zaXplOiBjbGFtcCgxLjJlbSwgMi41dncsIDEuNmVtKTsgbWluLXdpZHRoOiAzNXB4OyB0ZXh0LWFsaWduOiBjZW50ZXI7IH0KICAgICAgICAuaW5mby1yb3cgLmktbmFtZSB7IGZvbnQtd2VpZ2h0OiA3MDA7IGNvbG9yOiB2YXIoLS10ZXh0LWRhcmspOyBmb250LXNpemU6IGNsYW1wKDAuODVlbSwgMS44dncsIDEuMWVtKTsgbWluLXdpZHRoOiA4MHB4OyB9CiAgICAgICAgLmluZm8tcm93IC5pLWRlc2MgeyBjb2xvcjogdmFyKC0tdGV4dC1tZWRpdW0pOyBmb250LXNpemU6IGNsYW1wKDAuNzhlbSwgMS42dncsIDFlbSk7IGZsZXg6IDE7IGxpbmUtaGVpZ2h0OiAxLjU7IH0KICAgICAgICAuaW5mby1yb3cgLmktbGltaXQgeyAKICAgICAgICAgICAgYmFja2dyb3VuZDogI0ZFRjNDNzsKICAgICAgICAgICAgY29sb3I6IHZhcigtLXdhcm5pbmcpOwogICAgICAgICAgICBmb250LXNpemU6IGNsYW1wKDAuN2VtLCAxLjR2dywgMC45ZW0pOyAKICAgICAgICAgICAgcGFkZGluZzogMC41dmggMXZ3OyAKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNnB4OwogICAgICAgICAgICB3aGl0ZS1zcGFjZTogbm93cmFwOwogICAgICAgICAgICBmb250LXdlaWdodDogNzAwOwogICAgICAgICAgICBib3JkZXI6IDFweCBzb2xpZCAjRkNEMzREOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAua2V5LXBvaW50IHsKICAgICAgICAgICAgYmFja2dyb3VuZDogI0ZFRjlFNzsKICAgICAgICAgICAgYm9yZGVyOiAycHggc29saWQgdmFyKC0tZ29sZCk7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDEycHg7CiAgICAgICAgICAgIHBhZGRpbmc6IDEuNXZoIDJ2dzsKICAgICAgICAgICAgbWFyZ2luLXRvcDogMnZoOwogICAgICAgIH0KICAgICAgICAua2V5LXBvaW50IC5rcC10aXRsZSB7IGNvbG9yOiB2YXIoLS1nb2xkKTsgZm9udC1zaXplOiBjbGFtcCgwLjg1ZW0sIDEuOHZ3LCAxLjFlbSk7IGZvbnQtd2VpZ2h0OiA3MDA7IG1hcmdpbi1ib3R0b206IDF2aDsgfQogICAgICAgIC5rZXktcG9pbnQgLmtwLXRleHQgeyBjb2xvcjogdmFyKC0tdGV4dC1kYXJrKTsgZm9udC1zaXplOiBjbGFtcCgwLjhlbSwgMS42dncsIDFlbSk7IGxpbmUtaGVpZ2h0OiAxLjU7IH0KICAgICAgICAKICAgICAgICAuZmFpbC1ncmlkIHsKICAgICAgICAgICAgZGlzcGxheTogZ3JpZDsKICAgICAgICAgICAgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOiByZXBlYXQoMywgMWZyKTsKICAgICAgICAgICAgZ2FwOiAxLjV2dzsKICAgICAgICAgICAgbWFyZ2luLXRvcDogMnZoOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAuZmFpbC1pdGVtIHsKICAgICAgICAgICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgICAgICAgICBwYWRkaW5nOiAxLjV2aCAxdnc7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICNGRUYyRjI7CiAgICAgICAgICAgIGJvcmRlcjogMXB4IHNvbGlkICNGRUNBQ0E7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDEycHg7CiAgICAgICAgfQogICAgICAgIC5mYWlsLWl0ZW0gLmYtaWNvbiB7IGZvbnQtc2l6ZTogY2xhbXAoMS40ZW0sIDN2dywgMmVtKTsgfQogICAgICAgIC5mYWlsLWl0ZW0gLmYtdGV4dCB7IGNvbG9yOiB2YXIoLS1kYW5nZXIpOyBmb250LXNpemU6IGNsYW1wKDAuNzVlbSwgMS41dncsIDAuOTVlbSk7IG1hcmdpbi10b3A6IDF2aDsgbGluZS1oZWlnaHQ6IDEuNDsgZm9udC13ZWlnaHQ6IDYwMDsgfQogICAgICAgIAogICAgICAgIC5zdGFydC1zZWN0aW9uIHsKICAgICAgICAgICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgICAgICAgICBwYWRkaW5nLXRvcDogMnZoOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAuc3RhcnQtYnRuIHsKICAgICAgICAgICAgcGFkZGluZzogMnZoIDV2dzsKICAgICAgICAgICAgZm9udC1zaXplOiBjbGFtcCgxLjFlbSwgMi41dncsIDEuNWVtKTsKICAgICAgICAgICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDEzNWRlZywgdmFyKC0tYXViZXJnaW5lKSwgdmFyKC0tYXViZXJnaW5lLWxpZ2h0KSk7CiAgICAgICAgICAgIGNvbG9yOiB3aGl0ZTsKICAgICAgICAgICAgYm9yZGVyOiBub25lOwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiAzNXB4OwogICAgICAgICAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA3MDA7CiAgICAgICAgICAgIHRyYW5zaXRpb246IGFsbCAwLjJzOwogICAgICAgICAgICBib3gtc2hhZG93OiAwIDRweCAxNXB4IHJnYmEoOTIsNDUsOTIsMC4zNSk7CiAgICAgICAgfQogICAgICAgIC5zdGFydC1idG46aG92ZXIgeyAKICAgICAgICAgICAgdHJhbnNmb3JtOiBzY2FsZSgxLjA1KTsgCiAgICAgICAgICAgIGJveC1zaGFkb3c6IDAgNnB4IDIwcHggcmdiYSg5Miw0NSw5MiwwLjQ1KTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLyogPT09PT09PT09PSBHQU1FIFNDUkVFTiA9PT09PT09PT09ICovCiAgICAgICAgLmdhbWUtc2NyZWVuIHsgZGlzcGxheTogbm9uZTsgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsgaGVpZ2h0OiAxMDB2aDsgfQogICAgICAgIC5nYW1lLXNjcmVlbi5hY3RpdmUgeyBkaXNwbGF5OiBmbGV4OyB9CiAgICAgICAgCiAgICAgICAgLmdhbWUtaGVhZGVyIHsKICAgICAgICAgICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCB2YXIoLS1hdWJlcmdpbmUpLCB2YXIoLS1hdWJlcmdpbmUtbGlnaHQpKTsKICAgICAgICAgICAgcGFkZGluZzogMC44dmggMnZ3OwogICAgICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgICAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47CiAgICAgICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgICAgICAgIHRyYW5zaXRpb246IGJhY2tncm91bmQgMC4zczsKICAgICAgICAgICAgZmxleC1zaHJpbms6IDA7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC5nYW1lLWhlYWRlci5kYW5nZXIgewogICAgICAgICAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsICM5OTFCMUIsICNEQzI2MjYpOwogICAgICAgICAgICBhbmltYXRpb246IGhlYWRlclB1bHNlIDAuNXMgaW5maW5pdGU7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIEBrZXlmcmFtZXMgaGVhZGVyUHVsc2UgewogICAgICAgICAgICAwJSwgMTAwJSB7IG9wYWNpdHk6IDE7IH0KICAgICAgICAgICAgNTAlIHsgb3BhY2l0eTogMC44NTsgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICAuaGVhZGVyLWxlZnQgeyBkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogY2VudGVyOyBnYXA6IDJ2dzsgfQogICAgICAgIAogICAgICAgIC50aW1lci1ib3ggeyAKICAgICAgICAgICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjMDAwOwogICAgICAgICAgICBwYWRkaW5nOiAwLjh2aCAxLjV2dzsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogMTBweDsKICAgICAgICAgICAgYm9yZGVyOiA0cHggc29saWQgI0ZFRjA4QTsKICAgICAgICAgICAgYm94LXNoYWRvdzogMCAwIDI1cHggcmdiYSgyNTQsMjQwLDEzOCwwLjcpOwogICAgICAgIH0KICAgICAgICAudGltZXItYm94IC50aW1lIHsKICAgICAgICAgICAgZm9udC1zaXplOiBjbGFtcCgyZW0sIDV2aCwgNGVtKTsKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDcwMDsKICAgICAgICAgICAgY29sb3I6ICNGRUYwOEE7CiAgICAgICAgICAgIGZvbnQtZmFtaWx5OiAnQ291cmllciBOZXcnLCBtb25vc3BhY2U7CiAgICAgICAgICAgIHRleHQtc2hhZG93OiAwIDAgMTVweCByZ2JhKDI1NCwyNDAsMTM4LDAuOCk7CiAgICAgICAgICAgIGxpbmUtaGVpZ2h0OiAxOwogICAgICAgIH0KICAgICAgICAudGltZXItYm94IC50aW1lLnVyZ2VudCB7IGNvbG9yOiAjRkNBNUE1OyBhbmltYXRpb246IHB1bHNlIDAuM3MgaW5maW5pdGU7IH0KICAgICAgICAudGltZXItYm94IC5sYWJlbCB7IGZvbnQtc2l6ZTogY2xhbXAoMC41ZW0sIDF2aCwgMC43ZW0pOyBjb2xvcjogcmdiYSgyNTUsMjU1LDI1NSwwLjkpOyBmb250LXdlaWdodDogNjAwOyBsZXR0ZXItc3BhY2luZzogMXB4OyB9CiAgICAgICAgCiAgICAgICAgQGtleWZyYW1lcyBwdWxzZSB7IDAlLCAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxKTsgfSA1MCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMDgpOyB9IH0KICAgICAgICAKICAgICAgICAucHJvZ3Jlc3MtYm94IHsgdGV4dC1hbGlnbjogY2VudGVyOyB9CiAgICAgICAgLnByb2dyZXNzLWJveCAuY291bnQgeyBmb250LXNpemU6IGNsYW1wKDEuMmVtLCAzdmgsIDJlbSk7IGZvbnQtd2VpZ2h0OiA3MDA7IGNvbG9yOiAjODZFRkFDOyB9CiAgICAgICAgLnByb2dyZXNzLWJveCAubGFiZWwgeyBmb250LXNpemU6IGNsYW1wKDAuNWVtLCAxdmgsIDAuN2VtKTsgY29sb3I6IHJnYmEoMjU1LDI1NSwyNTUsMC44KTsgZm9udC13ZWlnaHQ6IDYwMDsgfQogICAgICAgIAogICAgICAgIC5wYWNlLWJveCB7CiAgICAgICAgICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgICAgICAgICAgcGFkZGluZzogMC44dmggMS4ydnc7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDEwcHg7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogY2xhbXAoMC43ZW0sIDEuNHZoLCAxZW0pOwogICAgICAgICAgICBmb250LXdlaWdodDogNzAwOwogICAgICAgIH0KICAgICAgICAucGFjZS1ib3guZ29vZCB7IGJhY2tncm91bmQ6IHJnYmEoMjU1LDI1NSwyNTUsMC4yKTsgY29sb3I6ICM4NkVGQUM7IH0KICAgICAgICAucGFjZS1ib3gud2FybiB7IGJhY2tncm91bmQ6IHJnYmEoMjU1LDI1NSwyNTUsMC4yKTsgY29sb3I6ICNGREUwNDc7IH0KICAgICAgICAucGFjZS1ib3guYmFkIHsgYmFja2dyb3VuZDogcmdiYSgyNTUsMjU1LDI1NSwwLjIpOyBjb2xvcjogI0ZDQTVBNTsgfQogICAgICAgIC5wYWNlLWJveCAucGFjZS1sYWJlbCB7IGZvbnQtc2l6ZTogMC45ZW07IH0KICAgICAgICAKICAgICAgICAuaGVhZGVyLW1ldGVycyB7IGRpc3BsYXk6IGZsZXg7IGdhcDogMS41dnc7IH0KICAgICAgICAKICAgICAgICAuaC1tZXRlciB7IHdpZHRoOiBjbGFtcCgxMDBweCwgMTR2dywgMTgwcHgpOyB9CiAgICAgICAgLmgtbWV0ZXIgLm1ldGVyLWxhYmVsIHsKICAgICAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICAgICAganVzdGlmeS1jb250ZW50OiBzcGFjZS1iZXR3ZWVuOwogICAgICAgICAgICBmb250LXNpemU6IGNsYW1wKDAuNmVtLCAxLjJ2aCwgMC44NWVtKTsKICAgICAgICAgICAgY29sb3I6IHdoaXRlOwogICAgICAgICAgICBtYXJnaW4tYm90dG9tOiAycHg7CiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA2MDA7CiAgICAgICAgfQogICAgICAgIC5oLW1ldGVyIC5tZXRlci1iYXIgewogICAgICAgICAgICBoZWlnaHQ6IGNsYW1wKDEwcHgsIDJ2aCwgMTZweCk7CiAgICAgICAgICAgIGJhY2tncm91bmQ6IHJnYmEoMCwwLDAsMC4yNSk7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDZweDsKICAgICAgICAgICAgb3ZlcmZsb3c6IGhpZGRlbjsKICAgICAgICAgICAgYm9yZGVyOiAycHggc29saWQgcmdiYSgyNTUsMjU1LDI1NSwwLjMpOwogICAgICAgIH0KICAgICAgICAuaC1tZXRlciAubWV0ZXItZmlsbCB7CiAgICAgICAgICAgIGhlaWdodDogMTAwJTsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgICAgICAgICB0cmFuc2l0aW9uOiB3aWR0aCAwLjNzOwogICAgICAgIH0KICAgICAgICAuaC1tZXRlci5lbmVyZ3kgLm1ldGVyLWZpbGwgeyBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsICNFRjQ0NDQsICNGQkJGMjQsICMyMkM1NUUpOyB9CiAgICAgICAgLmgtbWV0ZXIudGVuc2lvbiAubWV0ZXItZmlsbCB7IGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgIzIyQzU1RSwgI0ZCQkYyNCwgI0VGNDQ0NCk7IH0KICAgICAgICAKICAgICAgICAuaC1tZXRlciAubWV0ZXItYmFyLmNyaXRpY2FsIHsgYW5pbWF0aW9uOiBtZXRlclB1bHNlIDAuNHMgaW5maW5pdGU7IH0KICAgICAgICBAa2V5ZnJhbWVzIG1ldGVyUHVsc2UgeyAwJSwgMTAwJSB7IGJveC1zaGFkb3c6IDAgMCA4cHggI0VGNDQ0NDsgfSA1MCUgeyBib3gtc2hhZG93OiAwIDAgMTZweCAjRUY0NDQ0OyB9IH0KICAgICAgICAKICAgICAgICAuZ2FtZS1tYWluIHsgCiAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7IAogICAgICAgICAgICBmbGV4OiAxOwogICAgICAgICAgICBtaW4taGVpZ2h0OiAwOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAvKiBNZWV0aW5nIFJvb20gKi8KICAgICAgICAubWVldGluZy1yb29tIHsKICAgICAgICAgICAgd2lkdGg6IDM4JTsKICAgICAgICAgICAgcG9zaXRpb246IHJlbGF0aXZlOwogICAgICAgICAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTgwZGVnLCAjRThGNEZELCAjRDFFOEZBKTsKICAgICAgICAgICAgb3ZlcmZsb3c6IGhpZGRlbjsKICAgICAgICAgICAgYm9yZGVyLXJpZ2h0OiAzcHggc29saWQgdmFyKC0tYm9yZGVyKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLmZsYXNoLW92ZXJsYXkgewogICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICAgICAgICAgIHRvcDogMDsgbGVmdDogMDsgcmlnaHQ6IDA7IGJvdHRvbTogMDsKICAgICAgICAgICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICAgICAgICAgIG9wYWNpdHk6IDA7CiAgICAgICAgICAgIHRyYW5zaXRpb246IG9wYWNpdHkgMC4xczsKICAgICAgICAgICAgei1pbmRleDogNTA7CiAgICAgICAgfQogICAgICAgIC5mbGFzaC1vdmVybGF5LmJhZCB7IGJhY2tncm91bmQ6IHJnYmEoMjM5LDY4LDY4LDAuMzUpOyB9CiAgICAgICAgLmZsYXNoLW92ZXJsYXkuZ29vZCB7IGJhY2tncm91bmQ6IHJnYmEoMzQsMTk3LDk0LDAuMzUpOyB9CiAgICAgICAgLmZsYXNoLW92ZXJsYXkuY2VvIHsgYmFja2dyb3VuZDogcmdiYSgxNDcsNTEsMjM0LDAuMzUpOyB9CiAgICAgICAgLmZsYXNoLW92ZXJsYXkuYWN0aXZlIHsgb3BhY2l0eTogMTsgfQogICAgICAgIAogICAgICAgIC5yb29tLXN0YXR1cyB7CiAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICAgICAgdG9wOiA1MCU7CiAgICAgICAgICAgIGxlZnQ6IDUwJTsKICAgICAgICAgICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogY2xhbXAoMi41ZW0sIDZ2dywgNGVtKTsKICAgICAgICAgICAgb3BhY2l0eTogMDsKICAgICAgICAgICAgei1pbmRleDogNjA7CiAgICAgICAgICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAycHggNXB4IHJnYmEoMCwwLDAsMC4zKSk7CiAgICAgICAgfQogICAgICAgIC5yb29tLXN0YXR1cy5zaG93IHsgb3BhY2l0eTogMTsgYW5pbWF0aW9uOiBzdGF0dXNQb3AgMC4zNXMgZWFzZTsgfQogICAgICAgIEBrZXlmcmFtZXMgc3RhdHVzUG9wIHsgMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLC01MCUpIHNjYWxlKDAuNSk7IH0gNTAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwtNTAlKSBzY2FsZSgxLjE1KTsgfSAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwtNTAlKSBzY2FsZSgxKTsgfSB9CiAgICAgICAgCiAgICAgICAgLm1lZXRpbmctdGFibGUgewogICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICAgICAgICAgIHRvcDogNTAlOwogICAgICAgICAgICBsZWZ0OiA1MCU7CiAgICAgICAgICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgICAgICAgICB3aWR0aDogY2xhbXAoNjBweCwgMTB2dywgMTAwcHgpOwogICAgICAgICAgICBoZWlnaHQ6IGNsYW1wKDQwcHgsIDd2dywgNzBweCk7CiAgICAgICAgICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxODBkZWcsICNBNjdDNTIsICM4QjZCNDUpOwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICAgICAgICAgIGJveC1zaGFkb3c6IDAgNHB4IDE1cHggcmdiYSgwLDAsMCwwLjI1KTsKICAgICAgICAgICAgYm9yZGVyOiAzcHggc29saWQgIzdBNUMzQjsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLm1lbWJlciB7CiAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICAgICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgICAgICAgICB3aWR0aDogY2xhbXAoNTVweCwgOHZ3LCA5NXB4KTsKICAgICAgICAgICAgdHJhbnNpdGlvbjogYWxsIDAuMTVzOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAubWVtYmVyLWF2YXRhciB7CiAgICAgICAgICAgIHdpZHRoOiBjbGFtcCg0MHB4LCA2dncsIDcwcHgpOwogICAgICAgICAgICBoZWlnaHQ6IGNsYW1wKDQwcHgsIDZ2dywgNzBweCk7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgICAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICAgICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgICAgICAgICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICAgICAgICAgIG1hcmdpbjogMCBhdXRvOwogICAgICAgICAgICBib3JkZXI6IDNweCBzb2xpZCB3aGl0ZTsKICAgICAgICAgICAgdHJhbnNpdGlvbjogYWxsIDAuMTVzOwogICAgICAgICAgICBib3gtc2hhZG93OiAwIDNweCAxMHB4IHJnYmEoMCwwLDAsMC4yKTsKICAgICAgICAgICAgcG9zaXRpb246IHJlbGF0aXZlOwogICAgICAgICAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAuYXZhdGFyLWZhY2UgewogICAgICAgICAgICB3aWR0aDogMTAwJTsKICAgICAgICAgICAgaGVpZ2h0OiAxMDAlOwogICAgICAgICAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC5hdmF0YXItZmFjZSAuZmFjZS1iZyB7CiAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICAgICAgd2lkdGg6IDEwMCU7CiAgICAgICAgICAgIGhlaWdodDogMTAwJTsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAvKiBFeWVzICovCiAgICAgICAgLmF2YXRhci1mYWNlIC5leWVzIHsKICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgICAgICAgICB0b3A6IDMyJTsKICAgICAgICAgICAgbGVmdDogNTAlOwogICAgICAgICAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoLTUwJSk7CiAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgICAgIGdhcDogY2xhbXAoNnB4LCAxLjJ2dywgMTFweCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC5hdmF0YXItZmFjZSAuZXllIHsKICAgICAgICAgICAgd2lkdGg6IGNsYW1wKDVweCwgMXZ3LCA5cHgpOwogICAgICAgICAgICBoZWlnaHQ6IGNsYW1wKDVweCwgMXZ3LCA5cHgpOwogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjMUYyOTM3OwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICAgICAgICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLmF2YXRhci1mYWNlIC5leWU6OmFmdGVyIHsKICAgICAgICAgICAgY29udGVudDogJyc7CiAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICAgICAgd2lkdGg6IGNsYW1wKDFweCwgMC4zdncsIDNweCk7CiAgICAgICAgICAgIGhlaWdodDogY2xhbXAoMXB4LCAwLjN2dywgM3B4KTsKICAgICAgICAgICAgYmFja2dyb3VuZDogd2hpdGU7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgICAgICAgICAgdG9wOiAxcHg7CiAgICAgICAgICAgIGxlZnQ6IDFweDsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLyogRXllYnJvd3MgKi8KICAgICAgICAuYXZhdGFyLWZhY2UgLmV5ZWJyb3dzIHsKICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgICAgICAgICB0b3A6IDI0JTsKICAgICAgICAgICAgbGVmdDogNTAlOwogICAgICAgICAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoLTUwJSk7CiAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgICAgIGdhcDogY2xhbXAoMTBweCwgMS44dncsIDE2cHgpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAuYXZhdGFyLWZhY2UgLmV5ZWJyb3cgewogICAgICAgICAgICB3aWR0aDogY2xhbXAoN3B4LCAxLjN2dywgMTFweCk7CiAgICAgICAgICAgIGhlaWdodDogM3B4OwogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjNEI1NTYzOwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiAycHg7CiAgICAgICAgICAgIHRyYW5zaXRpb246IGFsbCAwLjJzOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAvKiBNb3V0aCAqLwogICAgICAgIC5hdmF0YXItZmFjZSAubW91dGggewogICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICAgICAgICAgIGJvdHRvbTogMjIlOwogICAgICAgICAgICBsZWZ0OiA1MCU7CiAgICAgICAgICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlWCgtNTAlKTsKICAgICAgICAgICAgd2lkdGg6IDE2cHg7CiAgICAgICAgICAgIGhlaWdodDogOHB4OwogICAgICAgICAgICBib3JkZXI6IDNweCBzb2xpZCAjNEI1NTYzOwogICAgICAgICAgICBib3JkZXItdG9wOiBub25lOwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiAwIDAgMTZweCAxNnB4OwogICAgICAgICAgICBiYWNrZ3JvdW5kOiB0cmFuc3BhcmVudDsKICAgICAgICAgICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC8qIEhhaXIgc3R5bGVzICovCiAgICAgICAgLmF2YXRhci1mYWNlIC5oYWlyIHsKICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgICAgICAgICB0b3A6IDA7CiAgICAgICAgICAgIGxlZnQ6IDUwJTsKICAgICAgICAgICAgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC01MCUpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAvKiBDaGFyYWN0ZXItc3BlY2lmaWMgc3R5bGVzICovCiAgICAgICAgLmF2YXRhci1tZWVyYSAuZmFjZS1iZyB7IGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxMzVkZWcsICNEREQ2RkUsICNDNEI1RkQpOyB9CiAgICAgICAgLmF2YXRhci1tZWVyYSAuaGFpciB7CiAgICAgICAgICAgIHdpZHRoOiA1MHB4OwogICAgICAgICAgICBoZWlnaHQ6IDIwcHg7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICMxRjI5Mzc7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDI1cHggMjVweCAwIDA7CiAgICAgICAgICAgIHRvcDogLTJweDsKICAgICAgICB9CiAgICAgICAgLmF2YXRhci1tZWVyYSAuaGFpcjo6YWZ0ZXIgewogICAgICAgICAgICBjb250ZW50OiAnJzsKICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgICAgICAgICB3aWR0aDogOHB4OwogICAgICAgICAgICBoZWlnaHQ6IDhweDsKICAgICAgICAgICAgYmFja2dyb3VuZDogIzkzMzNFQTsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgICAgICAgICB0b3A6IDhweDsKICAgICAgICAgICAgbGVmdDogMjFweDsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLmF2YXRhci1yYWogLmZhY2UtYmcgeyBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCAjQkFFNkZELCAjN0REM0ZDKTsgfQogICAgICAgIC5hdmF0YXItcmFqIC5oYWlyIHsKICAgICAgICAgICAgd2lkdGg6IDQ1cHg7CiAgICAgICAgICAgIGhlaWdodDogMTZweDsKICAgICAgICAgICAgYmFja2dyb3VuZDogIzFGMjkzNzsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogMjBweCAyMHB4IDAgMDsKICAgICAgICAgICAgdG9wOiAtMnB4OwogICAgICAgIH0KICAgICAgICAuYXZhdGFyLXJhajo6YWZ0ZXIgewogICAgICAgICAgICBjb250ZW50OiAn8J+UrCc7CiAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICAgICAgZm9udC1zaXplOiAwLjVlbTsKICAgICAgICAgICAgdG9wOiAycHg7CiAgICAgICAgICAgIHJpZ2h0OiAycHg7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC5hdmF0YXItcHJpeWEgLmZhY2UtYmcgeyBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCAjQkJGN0QwLCAjODZFRkFDKTsgfQogICAgICAgIC5hdmF0YXItcHJpeWEgLmhhaXIgewogICAgICAgICAgICB3aWR0aDogNTVweDsKICAgICAgICAgICAgaGVpZ2h0OiAyNXB4OwogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjMUYyOTM3OwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiAzMHB4IDMwcHggMCAwOwogICAgICAgICAgICB0b3A6IC00cHg7CiAgICAgICAgfQogICAgICAgIC5hdmF0YXItcHJpeWEgLmhhaXI6OmJlZm9yZSB7CiAgICAgICAgICAgIGNvbnRlbnQ6ICcnOwogICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICAgICAgICAgIHdpZHRoOiAxMHB4OwogICAgICAgICAgICBoZWlnaHQ6IDMwcHg7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICMxRjI5Mzc7CiAgICAgICAgICAgIGxlZnQ6IC01cHg7CiAgICAgICAgICAgIHRvcDogMTVweDsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogMCAwIDVweCAxMHB4OwogICAgICAgIH0KICAgICAgICAuYXZhdGFyLXByaXlhIC5oYWlyOjphZnRlciB7CiAgICAgICAgICAgIGNvbnRlbnQ6ICcnOwogICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICAgICAgICAgIHdpZHRoOiAxMHB4OwogICAgICAgICAgICBoZWlnaHQ6IDMwcHg7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICMxRjI5Mzc7CiAgICAgICAgICAgIHJpZ2h0OiAtNXB4OwogICAgICAgICAgICB0b3A6IDE1cHg7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDAgMCAxMHB4IDVweDsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLmF2YXRhci1kZXYgLmZhY2UtYmcgeyBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCAjRkVGM0M3LCAjRkRFNjhBKTsgfQogICAgICAgIC5hdmF0YXItZGV2IC5oYWlyIHsKICAgICAgICAgICAgd2lkdGg6IDQ4cHg7CiAgICAgICAgICAgIGhlaWdodDogMTRweDsKICAgICAgICAgICAgYmFja2dyb3VuZDogIzc4MzUwRjsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogMjBweCAyMHB4IDAgMDsKICAgICAgICAgICAgdG9wOiAtMnB4OwogICAgICAgIH0KICAgICAgICAuYXZhdGFyLWRldiAuZ2xhc3NlcyB7CiAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICAgICAgdG9wOiAyOCU7CiAgICAgICAgICAgIGxlZnQ6IDUwJTsKICAgICAgICAgICAgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC01MCUpOwogICAgICAgICAgICB3aWR0aDogMzZweDsKICAgICAgICAgICAgaGVpZ2h0OiAxNHB4OwogICAgICAgICAgICBib3JkZXI6IDJweCBzb2xpZCAjNzgzNTBGOwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA0cHg7CiAgICAgICAgfQogICAgICAgIC5hdmF0YXItZGV2IC5nbGFzc2VzOjpiZWZvcmUgewogICAgICAgICAgICBjb250ZW50OiAnJzsKICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgICAgICAgICB3aWR0aDogNnB4OwogICAgICAgICAgICBoZWlnaHQ6IDJweDsKICAgICAgICAgICAgYmFja2dyb3VuZDogIzc4MzUwRjsKICAgICAgICAgICAgbGVmdDogNTAlOwogICAgICAgICAgICB0b3A6IDRweDsKICAgICAgICAgICAgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC01MCUpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAuYXZhdGFyLWFuaXRhIC5mYWNlLWJnIHsgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDEzNWRlZywgI0ZFQ0FDQSwgI0ZDQTVBNSk7IH0KICAgICAgICAuYXZhdGFyLWFuaXRhIC5oYWlyIHsKICAgICAgICAgICAgd2lkdGg6IDUycHg7CiAgICAgICAgICAgIGhlaWdodDogMjJweDsKICAgICAgICAgICAgYmFja2dyb3VuZDogIzFGMjkzNzsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogMjZweCAyNnB4IDAgMDsKICAgICAgICAgICAgdG9wOiAtM3B4OwogICAgICAgIH0KICAgICAgICAuYXZhdGFyLWFuaXRhIC5oYWlyOjphZnRlciB7CiAgICAgICAgICAgIGNvbnRlbnQ6ICcnOwogICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICAgICAgICAgIHdpZHRoOiA2cHg7CiAgICAgICAgICAgIGhlaWdodDogNnB4OwogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjRUY0NDQ0OwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICAgICAgICAgIHRvcDogNXB4OwogICAgICAgICAgICByaWdodDogNXB4OwogICAgICAgIH0KICAgICAgICAKICAgICAgICAvKiBFbW90aW9uYWwgc3RhdGVzICovCiAgICAgICAgLm1lbWJlci5hbmdyeSAuZXllYnJvdzpmaXJzdC1jaGlsZCB7IHRyYW5zZm9ybTogcm90YXRlKDIwZGVnKSB0cmFuc2xhdGVZKDJweCk7IH0KICAgICAgICAubWVtYmVyLmFuZ3J5IC5leWVicm93Omxhc3QtY2hpbGQgeyB0cmFuc2Zvcm06IHJvdGF0ZSgtMjBkZWcpIHRyYW5zbGF0ZVkoMnB4KTsgfQogICAgICAgIC5tZW1iZXIuYW5ncnkgLm1vdXRoIHsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogMTZweCAxNnB4IDAgMDsKICAgICAgICAgICAgYm9yZGVyOiAzcHggc29saWQgI0RDMjYyNjsKICAgICAgICAgICAgYm9yZGVyLWJvdHRvbTogbm9uZTsKICAgICAgICAgICAgaGVpZ2h0OiA2cHg7CiAgICAgICAgfQogICAgICAgIC5tZW1iZXIuYW5ncnkgLmV5ZSB7IGJhY2tncm91bmQ6ICNEQzI2MjY7IH0KICAgICAgICAKICAgICAgICAubWVtYmVyLnRlbnNlIC5leWVicm93OmZpcnN0LWNoaWxkIHsgdHJhbnNmb3JtOiByb3RhdGUoMTBkZWcpIHRyYW5zbGF0ZVkoMXB4KTsgfQogICAgICAgIC5tZW1iZXIudGVuc2UgLmV5ZWJyb3c6bGFzdC1jaGlsZCB7IHRyYW5zZm9ybTogcm90YXRlKC0xMGRlZykgdHJhbnNsYXRlWSgxcHgpOyB9CiAgICAgICAgLm1lbWJlci50ZW5zZSAubW91dGggewogICAgICAgICAgICB3aWR0aDogMTJweDsKICAgICAgICAgICAgaGVpZ2h0OiA0cHg7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDJweDsKICAgICAgICAgICAgYm9yZGVyOiBub25lOwogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjNEI1NTYzOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAubWVtYmVyLmhhcHB5IC5tb3V0aCB7CiAgICAgICAgICAgIHdpZHRoOiAyMHB4OwogICAgICAgICAgICBoZWlnaHQ6IDEwcHg7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDAgMCAyMHB4IDIwcHg7CiAgICAgICAgICAgIGJvcmRlci1jb2xvcjogIzE2QTM0QTsKICAgICAgICB9CiAgICAgICAgLm1lbWJlci5oYXBweSAuZXllIHsgCiAgICAgICAgICAgIGhlaWdodDogNHB4OwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA0cHggNHB4IDAgMDsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLm1lbWJlci5zcGVha2luZyAubW91dGggewogICAgICAgICAgICB3aWR0aDogMTRweDsKICAgICAgICAgICAgaGVpZ2h0OiAxNHB4OwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICAgICAgICAgIGJvcmRlcjogM3B4IHNvbGlkICM0QjU1NjM7CiAgICAgICAgICAgIGFuaW1hdGlvbjogdGFsa2luZyAwLjJzIGluZmluaXRlOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAubWVtYmVyLnRpcmVkIC5leWUgewogICAgICAgICAgICBoZWlnaHQ6IDZweDsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogMCAwIDZweCA2cHg7CiAgICAgICAgICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlWSgycHgpOwogICAgICAgIH0KICAgICAgICAubWVtYmVyLnRpcmVkIC5leWVicm93IHsKICAgICAgICAgICAgdHJhbnNmb3JtOiB0cmFuc2xhdGVZKDNweCk7CiAgICAgICAgfQogICAgICAgIC5tZW1iZXIudGlyZWQgLm1vdXRoIHsKICAgICAgICAgICAgd2lkdGg6IDEycHg7CiAgICAgICAgICAgIGhlaWdodDogM3B4OwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiAycHg7CiAgICAgICAgICAgIGJvcmRlcjogbm9uZTsKICAgICAgICAgICAgYmFja2dyb3VuZDogIzlDQTNBRjsKICAgICAgICB9CiAgICAgICAgLm1lbWJlci50aXJlZCAubWVtYmVyLWF2YXRhciB7CiAgICAgICAgICAgIG9wYWNpdHk6IDAuODU7CiAgICAgICAgICAgIGZpbHRlcjogc2F0dXJhdGUoMC43KTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgQGtleWZyYW1lcyB0YWxraW5nIHsKICAgICAgICAgICAgMCUsIDEwMCUgeyBoZWlnaHQ6IDEwcHg7IHdpZHRoOiAxMnB4OyB9CiAgICAgICAgICAgIDUwJSB7IGhlaWdodDogMTZweDsgd2lkdGg6IDE0cHg7IH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLm1lbWJlci5jZW8tbW9kZSAubW91dGggewogICAgICAgICAgICB3aWR0aDogMThweDsKICAgICAgICAgICAgaGVpZ2h0OiA4cHg7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDAgMCAxOHB4IDE4cHg7CiAgICAgICAgICAgIGJvcmRlci1jb2xvcjogIzdDM0FFRDsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLyogUm9vbSB0aXJlZG5lc3Mgb3ZlcmxheSAqLwogICAgICAgIC5tZWV0aW5nLXJvb20udGlyZWQtcm9vbSB7CiAgICAgICAgICAgIGZpbHRlcjogc2F0dXJhdGUoMC44NSkgYnJpZ2h0bmVzcygwLjk1KTsKICAgICAgICB9CiAgICAgICAgLm1lZXRpbmctcm9vbS5leGhhdXN0ZWQtcm9vbSB7CiAgICAgICAgICAgIGZpbHRlcjogc2F0dXJhdGUoMC43KSBicmlnaHRuZXNzKDAuOSk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC5tZW1iZXItZW1vdGlvbiB7CiAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICAgICAgYm90dG9tOiAtMnB4OwogICAgICAgICAgICByaWdodDogLTJweDsKICAgICAgICAgICAgZm9udC1zaXplOiBjbGFtcCgwLjZlbSwgMS40dncsIDAuODVlbSk7CiAgICAgICAgICAgIGJhY2tncm91bmQ6IHdoaXRlOwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICAgICAgICAgIHdpZHRoOiBjbGFtcCgxNHB4LCAyLjV2dywgMjJweCk7CiAgICAgICAgICAgIGhlaWdodDogY2xhbXAoMTRweCwgMi41dncsIDIycHgpOwogICAgICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgICAgICAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgICAgICAgICAgYm94LXNoYWRvdzogMCAxcHggNHB4IHJnYmEoMCwwLDAsMC4yKTsKICAgICAgICAgICAgYm9yZGVyOiAycHggc29saWQgd2hpdGU7CiAgICAgICAgICAgIG9wYWNpdHk6IDA7CiAgICAgICAgICAgIHRyYW5zZm9ybTogc2NhbGUoMC41KTsKICAgICAgICAgICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7CiAgICAgICAgICAgIHotaW5kZXg6IDEwOwogICAgICAgIH0KICAgICAgICAubWVtYmVyLWVtb3Rpb24uc2hvdyB7CiAgICAgICAgICAgIG9wYWNpdHk6IDE7CiAgICAgICAgICAgIHRyYW5zZm9ybTogc2NhbGUoMSk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC5tZW1iZXIuc3BlYWtpbmcgLm1lbWJlci1hdmF0YXIgewogICAgICAgICAgICBib3JkZXItY29sb3I6IHZhcigtLWdvbGQpOwogICAgICAgICAgICBhbmltYXRpb246IHNwZWFrUHVsc2UgMC4zcyBpbmZpbml0ZTsKICAgICAgICAgICAgYm94LXNoYWRvdzogMCAwIDIwcHggcmdiYSgyMDEsMTYyLDM5LDAuOCk7CiAgICAgICAgfQogICAgICAgIC5tZW1iZXIuc3BlYWtpbmcgLm1lbWJlci1lbW90aW9uIHsKICAgICAgICAgICAgb3BhY2l0eTogMTsKICAgICAgICAgICAgdHJhbnNmb3JtOiBzY2FsZSgxKTsKICAgICAgICB9CiAgICAgICAgLm1lbWJlci5hbmdyeSAubWVtYmVyLWF2YXRhciB7CiAgICAgICAgICAgIGJvcmRlci1jb2xvcjogdmFyKC0tZGFuZ2VyKTsKICAgICAgICAgICAgYW5pbWF0aW9uOiBhbmdyeVNoYWtlIDAuMXMgaW5maW5pdGU7CiAgICAgICAgICAgIGJveC1zaGFkb3c6IDAgMCAyNXB4IHJnYmEoMjIwLDM4LDM4LDAuOSk7CiAgICAgICAgfQogICAgICAgIC5tZW1iZXIuYW5ncnkgLm1lbWJlci1lbW90aW9uIHsKICAgICAgICAgICAgb3BhY2l0eTogMTsKICAgICAgICAgICAgdHJhbnNmb3JtOiBzY2FsZSgxLjIpOwogICAgICAgIH0KICAgICAgICAubWVtYmVyLnRlbnNlIC5tZW1iZXItYXZhdGFyIHsKICAgICAgICAgICAgYm9yZGVyLWNvbG9yOiB2YXIoLS13YXJuaW5nKTsKICAgICAgICAgICAgYW5pbWF0aW9uOiB0ZW5zZVB1bHNlIDAuNnMgaW5maW5pdGU7CiAgICAgICAgICAgIGJveC1zaGFkb3c6IDAgMCAxOHB4IHJnYmEoMjQ1LDE1OCwxMSwwLjcpOwogICAgICAgIH0KICAgICAgICAubWVtYmVyLnRlbnNlIC5tZW1iZXItZW1vdGlvbiB7CiAgICAgICAgICAgIG9wYWNpdHk6IDE7CiAgICAgICAgICAgIHRyYW5zZm9ybTogc2NhbGUoMSk7CiAgICAgICAgfQogICAgICAgIC5tZW1iZXIuaGFwcHkgLm1lbWJlci1hdmF0YXIgewogICAgICAgICAgICBib3JkZXItY29sb3I6IHZhcigtLXN1Y2Nlc3MpOwogICAgICAgICAgICBib3gtc2hhZG93OiAwIDAgMThweCByZ2JhKDIyLDE2Myw3NCwwLjcpOwogICAgICAgIH0KICAgICAgICAubWVtYmVyLmhhcHB5IC5tZW1iZXItZW1vdGlvbiB7CiAgICAgICAgICAgIG9wYWNpdHk6IDE7CiAgICAgICAgICAgIHRyYW5zZm9ybTogc2NhbGUoMSk7CiAgICAgICAgfQogICAgICAgIC5tZW1iZXIuY2VvLW1vZGUgLm1lbWJlci1hdmF0YXIgewogICAgICAgICAgICBib3JkZXItY29sb3I6ICM5MzMzRUE7CiAgICAgICAgICAgIGJveC1zaGFkb3c6IDAgMCAyNXB4IHJnYmEoMTQ3LDUxLDIzNCwwLjgpOwogICAgICAgICAgICBhbmltYXRpb246IGNlb1B1bHNlIDAuM3MgaW5maW5pdGU7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIEBrZXlmcmFtZXMgc3BlYWtQdWxzZSB7IDAlLCAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxKTsgfSA1MCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMDUpOyB9IH0KICAgICAgICBAa2V5ZnJhbWVzIGFuZ3J5U2hha2UgeyAwJSwgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgwKTsgfSAzMyUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoLTNweCk7IH0gNjYlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKDNweCk7IH0gfQogICAgICAgIEBrZXlmcmFtZXMgdGVuc2VQdWxzZSB7IDAlLCAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxKTsgYm94LXNoYWRvdzogMCAwIDEycHggcmdiYSgyNDUsMTU4LDExLDAuNSk7IH0gNTAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjAzKTsgYm94LXNoYWRvdzogMCAwIDIycHggcmdiYSgyNDUsMTU4LDExLDAuOCk7IH0gfQogICAgICAgIEBrZXlmcmFtZXMgY2VvUHVsc2UgeyAwJSwgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMSk7IH0gNTAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjA1KTsgfSB9CiAgICAgICAgCiAgICAgICAgLm1lbWJlci1uYW1lIHsgCiAgICAgICAgICAgIGZvbnQtc2l6ZTogY2xhbXAoMC42NWVtLCAxLjV2dywgMC45NWVtKTsgCiAgICAgICAgICAgIGNvbG9yOiB2YXIoLS10ZXh0LWRhcmspOyAKICAgICAgICAgICAgbWFyZ2luLXRvcDogMC41dmg7IAogICAgICAgICAgICBmb250LXdlaWdodDogNzAwOwogICAgICAgICAgICB0ZXh0LXNoYWRvdzogMCAxcHggMnB4IHJnYmEoMjU1LDI1NSwyNTUsMC45KTsKICAgICAgICAgICAgYmFja2dyb3VuZDogcmdiYSgyNTUsMjU1LDI1NSwwLjgpOwogICAgICAgICAgICBwYWRkaW5nOiAwLjJ2aCAwLjZ2dzsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgICAgIH0KICAgICAgICAKICAgICAgICAubWVtYmVyLXJvbGUgewogICAgICAgICAgICBmb250LXNpemU6IGNsYW1wKDAuNWVtLCAxLjJ2dywgMC44ZW0pOwogICAgICAgICAgICBjb2xvcjogdmFyKC0tdGV4dC1tZWRpdW0pOwogICAgICAgICAgICBtYXJnaW4tdG9wOiAwLjF2aDsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLm1lbWJlci1zdGF0dXMgewogICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICAgICAgICAgIHRvcDogLTAuNXZoOwogICAgICAgICAgICByaWdodDogMC41dnc7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogY2xhbXAoMC45ZW0sIDJ2dywgMS4zZW0pOwogICAgICAgICAgICBvcGFjaXR5OiAwOwogICAgICAgICAgICB0cmFuc2l0aW9uOiBhbGwgMC4yczsKICAgICAgICB9CiAgICAgICAgLm1lbWJlci1zdGF0dXMuc2hvdyB7IG9wYWNpdHk6IDE7IH0KICAgICAgICAKICAgICAgICAubWVtYmVyLWJhciB7CiAgICAgICAgICAgIHdpZHRoOiBjbGFtcCgzNXB4LCA1dncsIDYwcHgpOwogICAgICAgICAgICBoZWlnaHQ6IGNsYW1wKDRweCwgMC44dmgsIDdweCk7CiAgICAgICAgICAgIGJhY2tncm91bmQ6IHJnYmEoMCwwLDAsMC4xNSk7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDNweDsKICAgICAgICAgICAgbWFyZ2luOiAwLjN2aCBhdXRvIDA7CiAgICAgICAgICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICAgICAgICAgIGJvcmRlcjogMXB4IHNvbGlkIHJnYmEoMCwwLDAsMC4xKTsKICAgICAgICB9CiAgICAgICAgLm1lbWJlci1iYXItZmlsbCB7CiAgICAgICAgICAgIGhlaWdodDogMTAwJTsKICAgICAgICAgICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCAjMjJDNTVFLCAjRkJCRjI0LCAjRUY0NDQ0KTsKICAgICAgICAgICAgYmFja2dyb3VuZC1zaXplOiAyMDAlIDEwMCU7CiAgICAgICAgICAgIHRyYW5zaXRpb246IGFsbCAwLjJzOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAuc3BlZWNoLWJ1YmJsZSB7CiAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICAgICAgYmFja2dyb3VuZDogd2hpdGU7CiAgICAgICAgICAgIHBhZGRpbmc6IDAuOHZoIDF2dzsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogMTBweDsKICAgICAgICAgICAgZm9udC1zaXplOiBjbGFtcCgwLjdlbSwgMS42dncsIDAuOTVlbSk7CiAgICAgICAgICAgIG1heC13aWR0aDogY2xhbXAoMTAwcHgsIDE1dncsIDE3MHB4KTsKICAgICAgICAgICAgbWluLXdpZHRoOiBjbGFtcCg2MHB4LCA4dncsIDEwMHB4KTsKICAgICAgICAgICAgYm94LXNoYWRvdzogMCA0cHggMTRweCByZ2JhKDAsMCwwLDAuMik7CiAgICAgICAgICAgIG9wYWNpdHk6IDA7CiAgICAgICAgICAgIHRyYW5zZm9ybTogc2NhbGUoMC44KTsKICAgICAgICAgICAgdHJhbnNpdGlvbjogYWxsIDAuMTVzOwogICAgICAgICAgICB6LWluZGV4OiAxMDA7CiAgICAgICAgICAgIGNvbG9yOiB2YXIoLS10ZXh0LWRhcmspOwogICAgICAgICAgICBmb250LXdlaWdodDogNjAwOwogICAgICAgICAgICBsaW5lLWhlaWdodDogMS4zNTsKICAgICAgICAgICAgYm9yZGVyOiAycHggc29saWQgdmFyKC0tYm9yZGVyKTsKICAgICAgICB9CiAgICAgICAgLnNwZWVjaC1idWJibGU6OmFmdGVyIHsKICAgICAgICAgICAgY29udGVudDogJyc7CiAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICAgICAgYm90dG9tOiAtOHB4OwogICAgICAgICAgICBsZWZ0OiA1MCU7CiAgICAgICAgICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlWCgtNTAlKTsKICAgICAgICAgICAgYm9yZGVyOiA4cHggc29saWQgdHJhbnNwYXJlbnQ7CiAgICAgICAgICAgIGJvcmRlci10b3AtY29sb3I6IHdoaXRlOwogICAgICAgICAgICBib3JkZXItYm90dG9tOiBub25lOwogICAgICAgIH0KICAgICAgICAuc3BlZWNoLWJ1YmJsZS52aXNpYmxlIHsgb3BhY2l0eTogMTsgdHJhbnNmb3JtOiBzY2FsZSgxKTsgfQogICAgICAgIC5zcGVlY2gtYnViYmxlLmFuZ3J5IHsgCiAgICAgICAgICAgIGJhY2tncm91bmQ6ICNGRUYyRjI7IAogICAgICAgICAgICBib3JkZXItY29sb3I6IHZhcigtLWRhbmdlcik7IAogICAgICAgICAgICBjb2xvcjogIzk5MUIxQjsgCiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA3MDA7CiAgICAgICAgICAgIGFuaW1hdGlvbjogYW5ncnlTcGVlY2ggMC4xNXMgaW5maW5pdGU7CiAgICAgICAgfQogICAgICAgIC5zcGVlY2gtYnViYmxlLmFuZ3J5OjphZnRlciB7IGJvcmRlci10b3AtY29sb3I6ICNGRUYyRjI7IH0KICAgICAgICAuc3BlZWNoLWJ1YmJsZS5nb29kIHsgYmFja2dyb3VuZDogI0YwRkRGNDsgYm9yZGVyLWNvbG9yOiB2YXIoLS1zdWNjZXNzKTsgY29sb3I6ICMxNjY1MzQ7IH0KICAgICAgICAuc3BlZWNoLWJ1YmJsZS5nb29kOjphZnRlciB7IGJvcmRlci10b3AtY29sb3I6ICNGMEZERjQ7IH0KICAgICAgICAuc3BlZWNoLWJ1YmJsZS5jZW8geyBiYWNrZ3JvdW5kOiAjRkFGNUZGOyBib3JkZXItY29sb3I6ICM5MzMzRUE7IGNvbG9yOiAjNkIyMUE4OyBmb250LXdlaWdodDogNzAwOyB9CiAgICAgICAgLnNwZWVjaC1idWJibGUuY2VvOjphZnRlciB7IGJvcmRlci10b3AtY29sb3I6ICNGQUY1RkY7IH0KICAgICAgICAKICAgICAgICBAa2V5ZnJhbWVzIGFuZ3J5U3BlZWNoIHsKICAgICAgICAgICAgMCUsIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEpOyB9CiAgICAgICAgICAgIDUwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wMik7IH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLyogQ3VycmVudCBzcGVha2VyIGhpZ2hsaWdodCAqLwogICAgICAgIC5jdXJyZW50LXNwZWFrZXIgewogICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICAgICAgICAgIGJvdHRvbTogMXZoOwogICAgICAgICAgICBsZWZ0OiA1MCU7CiAgICAgICAgICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlWCgtNTAlKTsKICAgICAgICAgICAgYmFja2dyb3VuZDogd2hpdGU7CiAgICAgICAgICAgIHBhZGRpbmc6IDAuNXZoIDEuNXZ3OwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiAxNXB4OwogICAgICAgICAgICBib3gtc2hhZG93OiAwIDNweCAxMHB4IHJnYmEoMCwwLDAsMC4xNSk7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogY2xhbXAoMC43ZW0sIDEuNnZ3LCAwLjk1ZW0pOwogICAgICAgICAgICBmb250LXdlaWdodDogNjAwOwogICAgICAgICAgICBjb2xvcjogdmFyKC0tdGV4dC1kYXJrKTsKICAgICAgICAgICAgb3BhY2l0eTogMDsKICAgICAgICAgICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7CiAgICAgICAgICAgIHotaW5kZXg6IDgwOwogICAgICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgICAgICAgICBnYXA6IDAuOHZ3OwogICAgICAgIH0KICAgICAgICAuY3VycmVudC1zcGVha2VyLnNob3cgeyBvcGFjaXR5OiAxOyB9CiAgICAgICAgLmN1cnJlbnQtc3BlYWtlciAuc3BlYWtlci1pY29uIHsgZm9udC1zaXplOiAxLjFlbTsgfQogICAgICAgIC5jdXJyZW50LXNwZWFrZXIgLnNwZWFrZXItdGV4dCB7IG1heC13aWR0aDogMjB2dzsgd2hpdGUtc3BhY2U6IG5vd3JhcDsgb3ZlcmZsb3c6IGhpZGRlbjsgdGV4dC1vdmVyZmxvdzogZWxsaXBzaXM7IH0KICAgICAgICAuY3VycmVudC1zcGVha2VyLmFuZ3J5IHsgYmFja2dyb3VuZDogI0ZFRjJGMjsgYm9yZGVyOiAycHggc29saWQgdmFyKC0tZGFuZ2VyKTsgfQogICAgICAgIC5jdXJyZW50LXNwZWFrZXIuZ29vZCB7IGJhY2tncm91bmQ6ICNGMEZERjQ7IGJvcmRlcjogMnB4IHNvbGlkIHZhcigtLXN1Y2Nlc3MpOyB9CiAgICAgICAgCiAgICAgICAgLmZsb2F0LWVmZmVjdCB7CiAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICAgICAgZm9udC1zaXplOiBjbGFtcCgxLjhlbSwgNHZ3LCAyLjVlbSk7CiAgICAgICAgICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgICAgICAgICBhbmltYXRpb246IGZsb2F0VXAgMC41cyBlYXNlLW91dCBmb3J3YXJkczsKICAgICAgICAgICAgei1pbmRleDogMjAwOwogICAgICAgICAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMnB4IDRweCByZ2JhKDAsMCwwLDAuMykpOwogICAgICAgIH0KICAgICAgICBAa2V5ZnJhbWVzIGZsb2F0VXAgeyAwJSB7IG9wYWNpdHk6IDE7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgwKSBzY2FsZSgxKTsgfSAxMDAlIHsgb3BhY2l0eTogMDsgdHJhbnNmb3JtOiB0cmFuc2xhdGVZKC00dmgpIHNjYWxlKDEuMSk7IH0gfQogICAgICAgIAogICAgICAgIEBrZXlmcmFtZXMgcm9vbVB1bHNlIHsgCiAgICAgICAgICAgIDAlLCAxMDAlIHsgYm94LXNoYWRvdzogaW5zZXQgMCAwIDMwcHggcmdiYSgyMjAsMzgsMzgsMC4zKTsgfSAKICAgICAgICAgICAgNTAlIHsgYm94LXNoYWRvdzogaW5zZXQgMCAwIDUwcHggcmdiYSgyMjAsMzgsMzgsMC41KTsgfSAKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgQGtleWZyYW1lcyB0ZW5zaW9uU2hha2UgewogICAgICAgICAgICAwJSwgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgwKTsgfQogICAgICAgICAgICAyNSUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoLTJweCk7IH0KICAgICAgICAgICAgNzUlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKDJweCk7IH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLm1lZXRpbmctcm9vbS50ZW5zZSB7CiAgICAgICAgICAgIGFuaW1hdGlvbjogcm9vbVB1bHNlIDAuOHMgaW5maW5pdGU7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC5tZWV0aW5nLXJvb20uY3JpdGljYWwgewogICAgICAgICAgICBhbmltYXRpb246IHJvb21QdWxzZSAwLjRzIGluZmluaXRlLCB0ZW5zaW9uU2hha2UgMC4xcyBpbmZpbml0ZTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLyogQ29udHJvbCBQYW5lbCAqLwogICAgICAgIC5jb250cm9sLXBhbmVsIHsKICAgICAgICAgICAgZmxleDogMTsKICAgICAgICAgICAgYmFja2dyb3VuZDogdmFyKC0tYmctY3JlYW0pOwogICAgICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgICAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgICAgICAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgICAgICAgICBtaW4td2lkdGg6IDA7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC5wcm9qZWN0LXNlY3Rpb24gewogICAgICAgICAgICBwYWRkaW5nOiAxdmggMS41dnc7CiAgICAgICAgICAgIGJhY2tncm91bmQ6IHZhcigtLWJnLWxpZ2h0KTsKICAgICAgICAgICAgYm9yZGVyLWJvdHRvbTogMnB4IHNvbGlkIHZhcigtLWJvcmRlcik7CiAgICAgICAgICAgIGZsZXgtc2hyaW5rOiAwOwogICAgICAgIH0KICAgICAgICAucHJvamVjdC1oZWFkZXIgewogICAgICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgICAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47CiAgICAgICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDAuNXZoOwogICAgICAgIH0KICAgICAgICAucHJvamVjdC1oZWFkZXIgaDMgeyBjb2xvcjogdmFyKC0tYXViZXJnaW5lKTsgZm9udC1zaXplOiBjbGFtcCgwLjc1ZW0sIDEuNXZoLCAxZW0pOyBmb250LXdlaWdodDogNzAwOyB9CiAgICAgICAgLnByb2plY3QtdGltZXIgewogICAgICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgICAgICAgICBnYXA6IDF2dzsKICAgICAgICAgICAgZm9udC1zaXplOiBjbGFtcCgwLjdlbSwgMS40dmgsIDAuOWVtKTsKICAgICAgICAgICAgY29sb3I6IHZhcigtLXRleHQtbWVkaXVtKTsKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDYwMDsKICAgICAgICB9CiAgICAgICAgLnByb2plY3QtdGltZXIgLnB0LXRpbWUgewogICAgICAgICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1iZy13aGl0ZSk7CiAgICAgICAgICAgIHBhZGRpbmc6IDAuM3ZoIDAuOHZ3OwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA1cHg7CiAgICAgICAgICAgIGNvbG9yOiB2YXIoLS10ZXh0LWRhcmspOwogICAgICAgICAgICBmb250LWZhbWlseTogbW9ub3NwYWNlOwogICAgICAgICAgICBmb250LXdlaWdodDogNzAwOwogICAgICAgICAgICBib3JkZXI6IDJweCBzb2xpZCB2YXIoLS1ib3JkZXIpOwogICAgICAgIH0KICAgICAgICAucHJvamVjdC10aW1lciAucHQtdGltZS5zbG93IHsgY29sb3I6IHZhcigtLXdhcm5pbmcpOyBib3JkZXItY29sb3I6ICNGQ0QzNEQ7IGJhY2tncm91bmQ6ICNGRkZCRUI7IH0KICAgICAgICAucHJvamVjdC10aW1lciAucHQtdGltZS5kcmFnIHsgY29sb3I6IHZhcigtLWRhbmdlcik7IGJvcmRlci1jb2xvcjogI0ZFQ0FDQTsgYmFja2dyb3VuZDogI0ZFRjJGMjsgfQogICAgICAgIC5wcm9qZWN0LWNhcmQgewogICAgICAgICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1iZy13aGl0ZSk7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDhweDsKICAgICAgICAgICAgcGFkZGluZzogMC44dmggMXZ3OwogICAgICAgICAgICBib3JkZXI6IDJweCBzb2xpZCB2YXIoLS1ib3JkZXIpOwogICAgICAgIH0KICAgICAgICAucHJvamVjdC1uYW1lIHsgZm9udC1zaXplOiBjbGFtcCgwLjhlbSwgMS42dmgsIDFlbSk7IGZvbnQtd2VpZ2h0OiA3MDA7IGNvbG9yOiB2YXIoLS10ZXh0LWRhcmspOyB9CiAgICAgICAgLnByb2plY3QtZGVzYyB7IGZvbnQtc2l6ZTogY2xhbXAoMC42NWVtLCAxLjJ2aCwgMC44NWVtKTsgY29sb3I6IHZhcigtLXRleHQtbWVkaXVtKTsgbGluZS1oZWlnaHQ6IDEuMzsgfQogICAgICAgIAogICAgICAgIC5zdGF0dXMtc2VjdGlvbiB7CiAgICAgICAgICAgIHBhZGRpbmc6IDF2aCAxLjV2dzsKICAgICAgICAgICAgYmFja2dyb3VuZDogdmFyKC0tYmctd2hpdGUpOwogICAgICAgICAgICBib3JkZXItYm90dG9tOiAycHggc29saWQgdmFyKC0tYm9yZGVyKTsKICAgICAgICAgICAgZmxleC1zaHJpbms6IDA7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC5jcmlzaXMtYmFubmVyIHsKICAgICAgICAgICAgYmFja2dyb3VuZDogI0ZFRjJGMjsKICAgICAgICAgICAgYm9yZGVyOiAycHggc29saWQgdmFyKC0tZGFuZ2VyKTsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogOHB4OwogICAgICAgICAgICBwYWRkaW5nOiAwLjh2aCAxdnc7CiAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDF2aDsKICAgICAgICAgICAgZGlzcGxheTogbm9uZTsKICAgICAgICAgICAgYW5pbWF0aW9uOiBjcmlzaXNQdWxzZSAwLjVzIGluZmluaXRlOwogICAgICAgIH0KICAgICAgICAuY3Jpc2lzLWJhbm5lci5zaG93IHsgZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IGNlbnRlcjsganVzdGlmeS1jb250ZW50OiBzcGFjZS1iZXR3ZWVuOyB9CiAgICAgICAgLmNyaXNpcy1iYW5uZXIgLmNyaXNpcy10ZXh0IHsgY29sb3I6IHZhcigtLWRhbmdlcik7IGZvbnQtd2VpZ2h0OiA3MDA7IGZvbnQtc2l6ZTogY2xhbXAoMC43ZW0sIDEuNHZoLCAwLjk1ZW0pOyB9CiAgICAgICAgLmNyaXNpcy1iYW5uZXIgLmNyaXNpcy1oaW50IHsgY29sb3I6IHZhcigtLWRhbmdlcik7IGZvbnQtc2l6ZTogY2xhbXAoMC42ZW0sIDEuMnZoLCAwLjg1ZW0pOyB9CiAgICAgICAgQGtleWZyYW1lcyBjcmlzaXNQdWxzZSB7IDAlLCAxMDAlIHsgb3BhY2l0eTogMTsgfSA1MCUgeyBvcGFjaXR5OiAwLjg1OyB9IH0KICAgICAgICAKICAgICAgICAuZHJhZy13YXJuaW5nIHsKICAgICAgICAgICAgYmFja2dyb3VuZDogI0ZGRkJFQjsKICAgICAgICAgICAgYm9yZGVyOiAycHggc29saWQgI0ZDRDM0RDsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNnB4OwogICAgICAgICAgICBwYWRkaW5nOiAwLjV2aCAxdnc7CiAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDF2aDsKICAgICAgICAgICAgZGlzcGxheTogbm9uZTsKICAgICAgICAgICAgZm9udC1zaXplOiBjbGFtcCgwLjY1ZW0sIDEuM3ZoLCAwLjg1ZW0pOwogICAgICAgICAgICBjb2xvcjogdmFyKC0td2FybmluZyk7CiAgICAgICAgICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDYwMDsKICAgICAgICB9CiAgICAgICAgLmRyYWctd2FybmluZy5zaG93IHsgZGlzcGxheTogYmxvY2s7IH0KICAgICAgICAKICAgICAgICAuc3RhdHVzLXJvdyB7CiAgICAgICAgICAgIGRpc3BsYXk6IGdyaWQ7CiAgICAgICAgICAgIGdyaWQtdGVtcGxhdGUtY29sdW1uczogcmVwZWF0KDMsIDFmcik7CiAgICAgICAgICAgIGdhcDogMC44dnc7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC5zdGF0dXMtY2hpcCB7CiAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICAgICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgICAgICAgIHBhZGRpbmc6IDAuNnZoOwogICAgICAgICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1iZy1saWdodCk7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDhweDsKICAgICAgICAgICAgYm9yZGVyOiAycHggc29saWQgdmFyKC0tYm9yZGVyKTsKICAgICAgICB9CiAgICAgICAgLnN0YXR1cy1jaGlwLmFsZXJ0IHsgYmFja2dyb3VuZDogI0ZFRjJGMjsgYm9yZGVyLWNvbG9yOiB2YXIoLS1kYW5nZXIpOyB9CiAgICAgICAgLnN0YXR1cy1jaGlwLndhcm4geyBiYWNrZ3JvdW5kOiAjRkZGQkVCOyBib3JkZXItY29sb3I6ICNGQ0QzNEQ7IH0KICAgICAgICAuc3RhdHVzLWNoaXAuZ29vZCB7IGJhY2tncm91bmQ6ICNGMEZERjQ7IGJvcmRlci1jb2xvcjogdmFyKC0tc3VjY2Vzcyk7IH0KICAgICAgICAuc3RhdHVzLWNoaXAgLmNoaXAtaWNvbiB7IGZvbnQtc2l6ZTogY2xhbXAoMWVtLCAydmgsIDEuNWVtKTsgfQogICAgICAgIC5zdGF0dXMtY2hpcCAuY2hpcC10ZXh0IHsgY29sb3I6IHZhcigtLXRleHQtZGFyayk7IGZvbnQtc2l6ZTogY2xhbXAoMC42ZW0sIDEuMnZoLCAwLjhlbSk7IGZvbnQtd2VpZ2h0OiA2MDA7IH0KICAgICAgICAKICAgICAgICAuYXR0ZW50aW9uLXJvdyB7CiAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgICAgIGdhcDogMC41dnc7CiAgICAgICAgICAgIG1hcmdpbi10b3A6IDAuOHZoOwogICAgICAgICAgICBmbGV4LXdyYXA6IHdyYXA7CiAgICAgICAgICAgIG1pbi1oZWlnaHQ6IDJ2aDsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLmF0dG4tY2hpcCB7CiAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgICAgICAgIGdhcDogMC4zdnc7CiAgICAgICAgICAgIHBhZGRpbmc6IDAuM3ZoIDAuNnZ3OwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA1cHg7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogY2xhbXAoMC42ZW0sIDEuMnZoLCAwLjhlbSk7CiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA2MDA7CiAgICAgICAgfQogICAgICAgIC5hdHRuLWNoaXAuYW5ncnkgeyBiYWNrZ3JvdW5kOiAjRkVFMkUyOyBib3JkZXI6IDFweCBzb2xpZCAjRkVDQUNBOyBjb2xvcjogdmFyKC0tZGFuZ2VyKTsgfQogICAgICAgIC5hdHRuLWNoaXAud2FpdGluZyB7IGJhY2tncm91bmQ6ICNEQkVBRkU7IGJvcmRlcjogMXB4IHNvbGlkICM5M0M1RkQ7IGNvbG9yOiAjMUQ0RUQ4OyB9CiAgICAgICAgLmF0dG4tY2hpcC5xdWlldCB7IGJhY2tncm91bmQ6ICNGM0U4RkY7IGJvcmRlcjogMXB4IHNvbGlkICNEOEI0RkU7IGNvbG9yOiAjN0MzQUVEOyB9CiAgICAgICAgCiAgICAgICAgLmFjdGlvbi1zZWN0aW9uIHsKICAgICAgICAgICAgZmxleDogMTsKICAgICAgICAgICAgcGFkZGluZzogMS4ydmggMS41dnc7CiAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICAgICAgICAgIGJhY2tncm91bmQ6IHZhcigtLWJnLWNyZWFtKTsKICAgICAgICAgICAgbWluLWhlaWdodDogMDsKICAgICAgICAgICAgb3ZlcmZsb3c6IGhpZGRlbjsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLmFjdGlvbi1oZWFkZXIgewogICAgICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgICAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47CiAgICAgICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDF2aDsKICAgICAgICAgICAgZmxleC1zaHJpbms6IDA7CiAgICAgICAgfQogICAgICAgIC5hY3Rpb24taGVhZGVyIGg0IHsgY29sb3I6IHZhcigtLWF1YmVyZ2luZSk7IGZvbnQtc2l6ZTogY2xhbXAoMC44ZW0sIDEuNnZoLCAxZW0pOyBmb250LXdlaWdodDogNzAwOyB9CiAgICAgICAgLmFjdGlvbi1oZWFkZXIgLmxpbWl0ZWQtaW5mbyB7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogY2xhbXAoMC43ZW0sIDEuNHZoLCAwLjllbSk7CiAgICAgICAgICAgIGNvbG9yOiB2YXIoLS10ZXh0LW1lZGl1bSk7CiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA2MDA7CiAgICAgICAgfQogICAgICAgIC5hY3Rpb24taGVhZGVyIC5saW1pdGVkLWluZm8gc3BhbiB7IAogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjRkVGM0M3OwogICAgICAgICAgICBwYWRkaW5nOiAwLjN2aCAwLjh2dzsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNXB4OwogICAgICAgICAgICBtYXJnaW4tbGVmdDogMC41dnc7CiAgICAgICAgICAgIGNvbG9yOiB2YXIoLS13YXJuaW5nKTsKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDcwMDsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLmFjdGlvbi1ncmlkIHsKICAgICAgICAgICAgZGlzcGxheTogZ3JpZDsKICAgICAgICAgICAgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOiByZXBlYXQoMywgMWZyKTsKICAgICAgICAgICAgZ3JpZC10ZW1wbGF0ZS1yb3dzOiByZXBlYXQoMiwgMWZyKTsKICAgICAgICAgICAgZ2FwOiAxdmggMXZ3OwogICAgICAgICAgICBmbGV4OiAxOwogICAgICAgICAgICBtaW4taGVpZ2h0OiAwOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAuYWN0aW9uLWJ0biB7CiAgICAgICAgICAgIHBhZGRpbmc6IDF2aCAwLjV2dzsKICAgICAgICAgICAgYmFja2dyb3VuZDogdmFyKC0tYmctd2hpdGUpOwogICAgICAgICAgICBib3JkZXI6IDNweCBzb2xpZCB2YXIoLS1ib3JkZXIpOwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiAxMHB4OwogICAgICAgICAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICAgICAgICAgIHRyYW5zaXRpb246IGFsbCAwLjFzOwogICAgICAgICAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICAgICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgICAgICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgICAgICAgICBnYXA6IDAuNXZoOwogICAgICAgICAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICAgICAgICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICAgICAgICAgIG1pbi1oZWlnaHQ6IDYwcHg7CiAgICAgICAgfQogICAgICAgIC5hY3Rpb24tYnRuOmhvdmVyOm5vdCg6ZGlzYWJsZWQpIHsKICAgICAgICAgICAgYmFja2dyb3VuZDogdmFyKC0tYmctbGlnaHQpOwogICAgICAgICAgICBib3JkZXItY29sb3I6IHZhcigtLWF1YmVyZ2luZSk7CiAgICAgICAgICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlWSgtMnB4KTsKICAgICAgICAgICAgYm94LXNoYWRvdzogMCA0cHggMTJweCByZ2JhKDAsMCwwLDAuMTUpOwogICAgICAgIH0KICAgICAgICAuYWN0aW9uLWJ0bjpkaXNhYmxlZCB7IG9wYWNpdHk6IDAuMzU7IGN1cnNvcjogbm90LWFsbG93ZWQ7IH0KICAgICAgICAuYWN0aW9uLWJ0bi5yZWNvbW1lbmRlZCB7IAogICAgICAgICAgICBib3JkZXItY29sb3I6IHZhcigtLWdvbGQpOyAKICAgICAgICAgICAgYm9yZGVyLXdpZHRoOiAzcHg7CiAgICAgICAgICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4IHJnYmEoMjAxLDE2MiwzOSwwLjYpOyAKICAgICAgICAgICAgYW5pbWF0aW9uOiByZWNQdWxzZSAwLjZzIGluZmluaXRlOwogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjRkZGQkVCOwogICAgICAgIH0KICAgICAgICAuYWN0aW9uLWJ0bi5saW1pdGVkIHsgYm9yZGVyLWNvbG9yOiB2YXIoLS13YXJuaW5nKTsgfQogICAgICAgIC5hY3Rpb24tYnRuIC51c2VzIHsgCiAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsgCiAgICAgICAgICAgIHRvcDogM3B4OyAKICAgICAgICAgICAgcmlnaHQ6IDVweDsgCiAgICAgICAgICAgIGJhY2tncm91bmQ6IHZhcigtLXdhcm5pbmcpOwogICAgICAgICAgICBjb2xvcjogd2hpdGU7IAogICAgICAgICAgICBmb250LXNpemU6IGNsYW1wKDAuNmVtLCAxLjF2aCwgMC44ZW0pOyAKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDcwMDsgCiAgICAgICAgICAgIHBhZGRpbmc6IDJweCA2cHg7IAogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA1cHg7IAogICAgICAgIH0KICAgICAgICAKICAgICAgICBAa2V5ZnJhbWVzIHJlY1B1bHNlIHsgCiAgICAgICAgICAgIDAlLCAxMDAlIHsgYm94LXNoYWRvdzogMCAwIDZweCByZ2JhKDIwMSwxNjIsMzksMC40KTsgdHJhbnNmb3JtOiBzY2FsZSgxKTsgfSAKICAgICAgICAgICAgNTAlIHsgYm94LXNoYWRvdzogMCAwIDE4cHggcmdiYSgyMDEsMTYyLDM5LDAuOCk7IHRyYW5zZm9ybTogc2NhbGUoMS4wMik7IH0gCiAgICAgICAgfQogICAgICAgIAogICAgICAgIC5hY3Rpb24tYnRuIC5pY29uIHsgZm9udC1zaXplOiBjbGFtcCgxLjNlbSwgM3ZoLCAyZW0pOyB9CiAgICAgICAgLmFjdGlvbi1idG4gLmxhYmVsIHsgZm9udC1zaXplOiBjbGFtcCgwLjdlbSwgMS40dmgsIDAuOTVlbSk7IGNvbG9yOiB2YXIoLS10ZXh0LWRhcmspOyBmb250LXdlaWdodDogNzAwOyB9CiAgICAgICAgLmFjdGlvbi1idG4gLndoZW4geyBmb250LXNpemU6IGNsYW1wKDAuNTVlbSwgMS4xdmgsIDAuNzVlbSk7IGNvbG9yOiB2YXIoLS10ZXh0LWxpZ2h0KTsgfQogICAgICAgIAogICAgICAgIC5hY3Rpb24tYnRuLmNvb2xkb3duOjphZnRlciB7CiAgICAgICAgICAgIGNvbnRlbnQ6ICcnOwogICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICAgICAgICAgIGJvdHRvbTogMDsgbGVmdDogMDsgcmlnaHQ6IDA7CiAgICAgICAgICAgIGhlaWdodDogMTAwJTsKICAgICAgICAgICAgYmFja2dyb3VuZDogcmdiYSgwLDAsMCwwLjUpOwogICAgICAgICAgICBhbmltYXRpb246IGNvb2xkb3duIHZhcigtLWNkKSBsaW5lYXIgZm9yd2FyZHM7CiAgICAgICAgfQogICAgICAgIEBrZXlmcmFtZXMgY29vbGRvd24geyBmcm9tIHsgaGVpZ2h0OiAxMDAlOyB9IHRvIHsgaGVpZ2h0OiAwJTsgfSB9CiAgICAgICAgCiAgICAgICAgLmRlY2lzaW9uLXNlY3Rpb24gewogICAgICAgICAgICBwYWRkaW5nOiAxdmggMS41dnc7CiAgICAgICAgICAgIGJhY2tncm91bmQ6IHZhcigtLWJnLWxpZ2h0KTsKICAgICAgICAgICAgYm9yZGVyLXRvcDogMnB4IHNvbGlkIHZhcigtLWJvcmRlcik7CiAgICAgICAgICAgIGZsZXgtc2hyaW5rOiAwOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAucXVhbGl0eS1kaXNwbGF5IHsKICAgICAgICAgICAgYmFja2dyb3VuZDogdmFyKC0tYmctd2hpdGUpOwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiAxMHB4OwogICAgICAgICAgICBwYWRkaW5nOiAxdmggMS41dnc7CiAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDF2aDsKICAgICAgICAgICAgYm9yZGVyOiAzcHggc29saWQgdmFyKC0tYm9yZGVyKTsKICAgICAgICAgICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgICAgICAgICB0cmFuc2l0aW9uOiBib3JkZXItY29sb3IgMC4zczsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLnF1YWxpdHktZGlzcGxheS5sb3cgeyBib3JkZXItY29sb3I6IHZhcigtLWRhbmdlcik7IGJhY2tncm91bmQ6ICNGRUYyRjI7IH0KICAgICAgICAucXVhbGl0eS1kaXNwbGF5Lm1lZGl1bSB7IGJvcmRlci1jb2xvcjogdmFyKC0td2FybmluZyk7IGJhY2tncm91bmQ6ICNGRkZCRUI7IH0KICAgICAgICAucXVhbGl0eS1kaXNwbGF5Lmdvb2QgeyBib3JkZXItY29sb3I6IHZhcigtLXN1Y2Nlc3MpOyBiYWNrZ3JvdW5kOiAjRjBGREY0OyB9CiAgICAgICAgLnF1YWxpdHktZGlzcGxheS5ncmVhdCB7IGJvcmRlci1jb2xvcjogIzA1OTY2OTsgYmFja2dyb3VuZDogI0VDRkRGNTsgfQogICAgICAgIAogICAgICAgIEBrZXlmcmFtZXMgc2hha2UgewogICAgICAgICAgICAwJSwgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgwKTsgfQogICAgICAgICAgICAyMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoLTZweCk7IH0KICAgICAgICAgICAgNDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKDZweCk7IH0KICAgICAgICAgICAgNjAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC02cHgpOyB9CiAgICAgICAgICAgIDgwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCg2cHgpOyB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC5xdWFsaXR5LWhlYWRlciB7CiAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgICAgIGp1c3RpZnktY29udGVudDogc3BhY2UtYmV0d2VlbjsKICAgICAgICAgICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogMC41dmg7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC5xdWFsaXR5LXRpdGxlIHsKICAgICAgICAgICAgZm9udC1zaXplOiBjbGFtcCgwLjdlbSwgMS40dmgsIDAuOWVtKTsKICAgICAgICAgICAgY29sb3I6IHZhcigtLXRleHQtbWVkaXVtKTsKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDYwMDsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLnF1YWxpdHktc2NvcmUgewogICAgICAgICAgICBmb250LXNpemU6IGNsYW1wKDEuOGVtLCA0dmgsIDNlbSk7CiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA4MDA7CiAgICAgICAgICAgIHRyYW5zaXRpb246IGFsbCAwLjNzOwogICAgICAgIH0KICAgICAgICAucXVhbGl0eS1zY29yZS5sb3cgeyBjb2xvcjogdmFyKC0tZGFuZ2VyKTsgfQogICAgICAgIC5xdWFsaXR5LXNjb3JlLm1lZGl1bSB7IGNvbG9yOiB2YXIoLS13YXJuaW5nKTsgfQogICAgICAgIC5xdWFsaXR5LXNjb3JlLmdvb2QgeyBjb2xvcjogdmFyKC0tc3VjY2Vzcyk7IH0KICAgICAgICAucXVhbGl0eS1zY29yZS5ncmVhdCB7IGNvbG9yOiAjMDU5NjY5OyB0ZXh0LXNoYWRvdzogMCAwIDEwcHggcmdiYSg1LDE1MCwxMDUsMC4zKTsgfQogICAgICAgIAogICAgICAgIC5xdWFsaXR5LXNjb3JlLnB1bHNlIHsKICAgICAgICAgICAgYW5pbWF0aW9uOiBxdWFsaXR5UHVsc2UgMC4zcyBlYXNlOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBAa2V5ZnJhbWVzIHF1YWxpdHlQdWxzZSB7CiAgICAgICAgICAgIDAlLCAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxKTsgfQogICAgICAgICAgICA1MCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMSk7IH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLnF1YWxpdHktYmFyLWNvbnRhaW5lciB7CiAgICAgICAgICAgIGhlaWdodDogY2xhbXAoOHB4LCAxLjV2aCwgMTRweCk7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICNFNUU3RUI7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDZweDsKICAgICAgICAgICAgb3ZlcmZsb3c6IGhpZGRlbjsKICAgICAgICAgICAgbWFyZ2luOiAwLjV2aCAwOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAucXVhbGl0eS1iYXIgewogICAgICAgICAgICBoZWlnaHQ6IDEwMCU7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDZweDsKICAgICAgICAgICAgdHJhbnNpdGlvbjogYWxsIDAuM3M7CiAgICAgICAgICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgdmFyKC0tZGFuZ2VyKSwgdmFyKC0td2FybmluZyksIHZhcigtLXN1Y2Nlc3MpKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLnF1YWxpdHktZmFjdG9ycyB7CiAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgICAgICAgICBnYXA6IDF2dzsKICAgICAgICAgICAgZmxleC13cmFwOiB3cmFwOwogICAgICAgICAgICBmb250LXNpemU6IGNsYW1wKDAuNmVtLCAxLjJ2aCwgMC44NWVtKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLnF1YWxpdHktZmFjdG9yIHsKICAgICAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICAgICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgICAgICAgICAgZ2FwOiAwLjN2dzsKICAgICAgICAgICAgcGFkZGluZzogMC4zdmggMC44dnc7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDVweDsKICAgICAgICAgICAgYmFja2dyb3VuZDogdmFyKC0tYmctbGlnaHQpOwogICAgICAgIH0KICAgICAgICAucXVhbGl0eS1mYWN0b3IucG9zaXRpdmUgeyBjb2xvcjogdmFyKC0tc3VjY2Vzcyk7IGJhY2tncm91bmQ6ICNEQ0ZDRTc7IH0KICAgICAgICAucXVhbGl0eS1mYWN0b3IubmVnYXRpdmUgeyBjb2xvcjogdmFyKC0tZGFuZ2VyKTsgYmFja2dyb3VuZDogI0ZFRTJFMjsgfQogICAgICAgIC5xdWFsaXR5LWZhY3Rvci5uZXV0cmFsIHsgY29sb3I6IHZhcigtLXRleHQtbWVkaXVtKTsgfQogICAgICAgIAogICAgICAgIC5kZWNpc2lvbi1pbmZvIHsKICAgICAgICAgICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgICAgICAgICBtYXJnaW4tYm90dG9tOiAxdmg7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogY2xhbXAoMC43ZW0sIDEuNXZoLCAxZW0pOwogICAgICAgICAgICBjb2xvcjogdmFyKC0tdGV4dC1tZWRpdW0pOwogICAgICAgICAgICBmb250LXdlaWdodDogNjAwOwogICAgICAgIH0KICAgICAgICAuZGVjaXNpb24taW5mby5yZWFkeSB7IGNvbG9yOiB2YXIoLS1zdWNjZXNzKTsgZm9udC13ZWlnaHQ6IDcwMDsgfQogICAgICAgIC5kZWNpc2lvbi1pbmZvLndhcm4geyBjb2xvcjogdmFyKC0td2FybmluZyk7IGZvbnQtd2VpZ2h0OiA3MDA7IH0KICAgICAgICAKICAgICAgICAuZGVjaXNpb24tYnRucyB7IGRpc3BsYXk6IGZsZXg7IGdhcDogMXZ3OyB9CiAgICAgICAgCiAgICAgICAgLmRlY2lzaW9uLWJ0biB7CiAgICAgICAgICAgIGZsZXg6IDE7CiAgICAgICAgICAgIHBhZGRpbmc6IDEuMnZoOwogICAgICAgICAgICBib3JkZXI6IG5vbmU7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDEwcHg7CiAgICAgICAgICAgIGN1cnNvcjogcG9pbnRlcjsKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDcwMDsKICAgICAgICAgICAgZm9udC1zaXplOiBjbGFtcCgwLjhlbSwgMS42dmgsIDEuMWVtKTsKICAgICAgICAgICAgdHJhbnNpdGlvbjogYWxsIDAuMXM7CiAgICAgICAgICAgIGJveC1zaGFkb3c6IDAgM3B4IDEwcHggcmdiYSgwLDAsMCwwLjE1KTsKICAgICAgICB9CiAgICAgICAgLmRlY2lzaW9uLWJ0bi5hcHByb3ZlIHsgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDEzNWRlZywgIzIyQzU1RSwgIzE2QTM0QSk7IGNvbG9yOiB3aGl0ZTsgfQogICAgICAgIC5kZWNpc2lvbi1idG4ucmVqZWN0IHsgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDEzNWRlZywgIzlDQTNBRiwgIzZCNzI4MCk7IGNvbG9yOiB3aGl0ZTsgfQogICAgICAgIC5kZWNpc2lvbi1idG46aG92ZXI6bm90KDpkaXNhYmxlZCkgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMDIpOyBib3gtc2hhZG93OiAwIDVweCAxNXB4IHJnYmEoMCwwLDAsMC4yKTsgfQogICAgICAgIAogICAgICAgIC5ldmVudC1sb2cgewogICAgICAgICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1iZy13aGl0ZSk7CiAgICAgICAgICAgIHBhZGRpbmc6IDAuNXZoIDF2dzsKICAgICAgICAgICAgbWF4LWhlaWdodDogMy41dmg7CiAgICAgICAgICAgIG92ZXJmbG93LXk6IGF1dG87CiAgICAgICAgICAgIGZvbnQtc2l6ZTogY2xhbXAoMC42ZW0sIDEuMnZoLCAwLjhlbSk7CiAgICAgICAgICAgIGJvcmRlci10b3A6IDFweCBzb2xpZCB2YXIoLS1ib3JkZXIpOwogICAgICAgICAgICBmbGV4LXNocmluazogMDsKICAgICAgICB9CiAgICAgICAgLmV2ZW50LWl0ZW0geyBjb2xvcjogdmFyKC0tdGV4dC1tZWRpdW0pOyBwYWRkaW5nOiAwLjJ2aCAwOyB9CiAgICAgICAgLmV2ZW50LWl0ZW0uYmFkIHsgY29sb3I6IHZhcigtLWRhbmdlcik7IGZvbnQtd2VpZ2h0OiA3MDA7IH0KICAgICAgICAuZXZlbnQtaXRlbS5nb29kIHsgY29sb3I6IHZhcigtLXN1Y2Nlc3MpOyBmb250LXdlaWdodDogNzAwOyB9CiAgICAgICAgLmV2ZW50LWl0ZW0ud2FybiB7IGNvbG9yOiB2YXIoLS13YXJuaW5nKTsgZm9udC13ZWlnaHQ6IDcwMDsgfQogICAgICAgIC5ldmVudC1pdGVtLmNlbyB7IGNvbG9yOiAjOTMzM0VBOyBmb250LXdlaWdodDogNzAwOyB9CiAgICAgICAgCiAgICAgICAgLyogPT09PT09PT09PSBSRVNVTFQgU0NSRUVOID09PT09PT09PT0gKi8KICAgICAgICAucmVzdWx0LXNjcmVlbiB7CiAgICAgICAgICAgIGRpc3BsYXk6IG5vbmU7CiAgICAgICAgICAgIHBhZGRpbmc6IDM1cHggMzBweDsKICAgICAgICAgICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgICAgICAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTgwZGVnLCB2YXIoLS1iZy1jcmVhbSksIHZhcigtLWJnLWxpZ2h0KSk7CiAgICAgICAgfQogICAgICAgIC5yZXN1bHQtc2NyZWVuLmFjdGl2ZSB7IGRpc3BsYXk6IGJsb2NrOyB9CiAgICAgICAgLnJlc3VsdC1zY3JlZW4gaDIgeyBmb250LXNpemU6IDEuN2VtOyBtYXJnaW4tYm90dG9tOiAxMnB4OyB9CiAgICAgICAgLnJlc3VsdC1zY3JlZW4ud2luIGgyIHsgY29sb3I6IHZhcigtLXN1Y2Nlc3MpOyB9CiAgICAgICAgLnJlc3VsdC1zY3JlZW4ucGFydGlhbCBoMiB7IGNvbG9yOiB2YXIoLS13YXJuaW5nKTsgfQogICAgICAgIC5yZXN1bHQtc2NyZWVuLmxvc2UgaDIgeyBjb2xvcjogdmFyKC0tZGFuZ2VyKTsgfQogICAgICAgIAogICAgICAgIC5yZXN1bHQtbWVzc2FnZSB7IAogICAgICAgICAgICBjb2xvcjogdmFyKC0tdGV4dC1kYXJrKTsgCiAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDIycHg7IAogICAgICAgICAgICBsaW5lLWhlaWdodDogMS41OyAKICAgICAgICAgICAgZm9udC1zaXplOiAwLjk1ZW07IAogICAgICAgICAgICBtYXgtd2lkdGg6IDUwMHB4OyAKICAgICAgICAgICAgbWFyZ2luLWxlZnQ6IGF1dG87IAogICAgICAgICAgICBtYXJnaW4tcmlnaHQ6IGF1dG87CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC5yZXN1bHQtZ3JpZCB7IGRpc3BsYXk6IGZsZXg7IGp1c3RpZnktY29udGVudDogY2VudGVyOyBnYXA6IDE0cHg7IGZsZXgtd3JhcDogd3JhcDsgbWFyZ2luLWJvdHRvbTogMjJweDsgfQogICAgICAgIC5yZXN1bHQtY2FyZCB7IAogICAgICAgICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1iZy13aGl0ZSk7IAogICAgICAgICAgICBwYWRkaW5nOiAxNHB4IDIycHg7IAogICAgICAgICAgICBib3JkZXItcmFkaXVzOiAxMnB4OyAKICAgICAgICAgICAgbWluLXdpZHRoOiAxMDBweDsKICAgICAgICAgICAgYm9yZGVyOiAycHggc29saWQgdmFyKC0tYm9yZGVyKTsKICAgICAgICAgICAgYm94LXNoYWRvdzogMCAzcHggMTBweCByZ2JhKDAsMCwwLDAuMDgpOwogICAgICAgIH0KICAgICAgICAucmVzdWx0LWNhcmQgLnItdmFsdWUgeyBmb250LXNpemU6IDEuNWVtOyBmb250LXdlaWdodDogNzAwOyBjb2xvcjogdmFyKC0tYXViZXJnaW5lKTsgfQogICAgICAgIC5yZXN1bHQtY2FyZCAuci1sYWJlbCB7IGZvbnQtc2l6ZTogMC43ZW07IGNvbG9yOiB2YXIoLS10ZXh0LW1lZGl1bSk7IG1hcmdpbi10b3A6IDRweDsgZm9udC13ZWlnaHQ6IDYwMDsgfQogICAgICAgIC5yZXN1bHQtY2FyZC5nb29kIC5yLXZhbHVlIHsgY29sb3I6IHZhcigtLXN1Y2Nlc3MpOyB9CiAgICAgICAgLnJlc3VsdC1jYXJkLmJhZCAuci12YWx1ZSB7IGNvbG9yOiB2YXIoLS1kYW5nZXIpOyB9CiAgICAgICAgCiAgICAgICAgLmhpZGRlbiB7IGRpc3BsYXk6IG5vbmUgIWltcG9ydGFudDsgfQogICAgPC9zdHlsZT4KPC9oZWFkPgo8Ym9keT4KICAgIDxkaXYgY2xhc3M9ImdhbWUtY29udGFpbmVyIj4KICAgICAgICA8IS0tID09PT09PT09PT0gVElUTEUgU0NSRUVOID09PT09PT09PT0gLS0+CiAgICAgICAgPGRpdiBjbGFzcz0idGl0bGUtc2NyZWVuIiBpZD0idGl0bGUtc2NyZWVuIj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0idGl0bGUtaGVhZGVyIj4KICAgICAgICAgICAgICAgIDxoMT7wn6qRIENvbW1pdHRlZSBDaGFvczwvaDE+CiAgICAgICAgICAgICAgICA8cCBjbGFzcz0ic3VidGl0bGUiPkdldCA1IGhpZ2gtcXVhbGl0eSBkZWNpc2lvbnMgdGhyb3VnaCBhIHRlbnNlIGNvbW1pdHRlZSBtZWV0aW5nPC9wPgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgCiAgICAgICAgICAgIDxkaXYgY2xhc3M9InR1dG9yaWFsLWNvbnRhaW5lciI+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJ0dXRvcmlhbC1zZWN0aW9uIj4KICAgICAgICAgICAgICAgICAgICA8aDM+8J+OryBZb3VyIEdvYWw6IFF1YWxpdHkgRGVjaXNpb25zPC9oMz4KICAgICAgICAgICAgICAgICAgICA8cD5Zb3UncmUgY2hhaXJpbmcgYW4gUiZEIGNvbW1pdHRlZS4gR2V0IDxzcGFuIGNsYXNzPSJoaWdobGlnaHQiPjUgaGlnaC1xdWFsaXR5IGRlY2lzaW9uczwvc3Bhbj4gKDU1JSsgZWFjaCkgaW4gPHNwYW4gY2xhc3M9ImhpZ2hsaWdodCI+NzUgc2Vjb25kczwvc3Bhbj4uPC9wPgogICAgICAgICAgICAgICAgICAgIDxwPjxzcGFuIGNsYXNzPSJzdWNjZXNzLXRleHQiPlRoZSBrZXk6PC9zcGFuPiA8c3Ryb25nPldhaXQgZm9yIHBlb3BsZSB0byBzcGVhayE8L3N0cm9uZz4gUXVhbGl0eSBqdW1wcyArMTUlIGZvciBlYWNoIHZvaWNlIGhlYXJkLiBUaGUgYmFyIHR1cm5zIGdyZWVuIHdoZW4gMysgcGVvcGxlIGhhdmUgY29udHJpYnV0ZWQuIDxzcGFuIGNsYXNzPSJkYW5nZXItdGV4dCI+UnVzaGluZyA9IGxvdyBxdWFsaXR5ITwvc3Bhbj48L3A+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0idHV0b3JpYWwtc2VjdGlvbiI+CiAgICAgICAgICAgICAgICAgICAgPGgzPuKaoSBUaGUgRHJhbWE8L2gzPgogICAgICAgICAgICAgICAgICAgIDxwPjxzcGFuIGNsYXNzPSJkYW5nZXItdGV4dCI+Q29uZmxpY3RzIGJ1aWxkIHVwITwvc3Bhbj4gUmFqIHZzIFByaXlhIGFuZCBEZXYgdnMgQW5pdGEgYXJlIHJpdmFscy4gWW91J2xsIHNlZSA8c3BhbiBjbGFzcz0iaGlnaGxpZ2h0Ij53YXJuaW5nIHNpZ25zPC9zcGFuPiBiZWZvcmUgdGhleSBjbGFzaCDigJQgdGVuc2UgbG9va3MsIHNuaXBweSBjb21tZW50cy48L3A+CiAgICAgICAgICAgICAgICAgICAgPHA+PHNwYW4gY2xhc3M9InN1Y2Nlc3MtdGV4dCI+UHJvIHRpcDo8L3NwYW4+IFVzZSDwn5WK77iPIERlZnVzZSBkdXJpbmcgdGhlIGJ1aWxkdXAgdG8gPHN0cm9uZz5wcmV2ZW50IHRoZSBjb25mbGljdCBlbnRpcmVseSE8L3N0cm9uZz4gV2F0Y2ggZm9yIHllbGxvdyBnbG93aW5nIGF2YXRhcnMuPC9wPgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InR3by1jb2wiPgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InR1dG9yaWFsLXNlY3Rpb24iPgogICAgICAgICAgICAgICAgICAgICAgICA8aDM+8J+TiiBXaGF0IEFmZmVjdHMgUXVhbGl0eTwvaDM+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImluZm8tcm93Ij4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJpLWljb24iPvCfl6PvuI88L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iaS1uYW1lIj5Wb2ljZXM8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iaS1kZXNjIj48c3Ryb25nPisxNSUgcGVyIHBlcnNvbiE8L3N0cm9uZz4gV2FpdCBmb3IgMy00IHZvaWNlcyBiZWZvcmUgZGVjaWRpbmcuIFRoaXMgaXMgdGhlIGtleSE8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJpbmZvLXJvdyI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iaS1pY29uIj7ij7M8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iaS1uYW1lIj5QYXRpZW5jZTwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJpLWRlc2MiPjxzdHJvbmc+RG9uJ3QgcnVzaCE8L3N0cm9uZz4gRGVjaWRpbmcgd2l0aCAmbHQ7MiB2b2ljZXMgPSBiaWcgcGVuYWx0eSArIGFuZ3J5IHBlb3BsZS48L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJpbmZvLXJvdyI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iaS1pY29uIj7imqE8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iaS1uYW1lIj5Db25mbGljdHM8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iaS1kZXNjIj48c3Ryb25nPi0xMiUgcXVhbGl0eTwvc3Ryb25nPiB3aGlsZSBhY3RpdmUuIERlZnVzZSBiZWZvcmUgZGVjaWRpbmchPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iaW5mby1yb3ciPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImktaWNvbiI+8J+RlDwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJpLW5hbWUiPkNFTyBDYXJkPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImktZGVzYyI+PHN0cm9uZz4tMTAlIHF1YWxpdHk8L3N0cm9uZz4gcGVuYWx0eS4gTnVjbGVhciBvcHRpb24gb25seS48L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InR1dG9yaWFsLXNlY3Rpb24iPgogICAgICAgICAgICAgICAgICAgICAgICA8aDM+8J+OrCBZb3VyIEFjdGlvbnM8L2gzPgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJpbmZvLXJvdyI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iaS1pY29uIj7wn5GPPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImktbmFtZSI+QWNrbm93bGVkZ2U8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iaS1kZXNjIj5WYWxpZGF0ZSBhIHNwZWFrZXIuIENhbG1zIGZydXN0cmF0ZWQgcGVvcGxlLjwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImluZm8tcm93IiBzdHlsZT0iYmFja2dyb3VuZDogI0YzRThGRjsgYm9yZGVyLWNvbG9yOiAjRDhCNEZFOyI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iaS1pY29uIj7wn5ej77iPPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImktbmFtZSI+SW52aXRlPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImktZGVzYyI+PHN0cm9uZz5LRVkgQUNUSU9OITwvc3Ryb25nPiBCcmluZ3MgaW4gcXVpZXQgbWVtYmVycy4gU29tZSB3b24ndCBzcGVhayB3aXRob3V0IHRoaXMhPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iaW5mby1yb3ciPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImktaWNvbiI+8J+Viu+4jzwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJpLW5hbWUiPkRlZnVzZTwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJpLWRlc2MiPjxzdHJvbmc+UHJldmVudCBvciByZXNvbHZlIGNvbmZsaWN0cyE8L3N0cm9uZz4gVXNlIHdoZW4geW91IHNlZSB3YXJuaW5nIHNpZ25zLjwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImluZm8tcm93Ij4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJpLWljb24iPvCfmII8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iaS1uYW1lIj5Kb2tlPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImktZGVzYyI+PHN0cm9uZz5SZXN0b3JlcyBlbmVyZ3khPC9zdHJvbmc+IFJlbGlldmVzIHRlbnNpb24uIEJldHRlciB3aGVuIHRpcmVkLjwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJpLWxpbWl0Ij7DlzI8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJpbmZvLXJvdyIgc3R5bGU9ImJhY2tncm91bmQ6ICNGRUYzQzc7IGJvcmRlci1jb2xvcjogI0ZERTY4QTsiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImktaWNvbiI+4piVPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImktbmFtZSI+QnJlYWs8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iaS1kZXNjIj48c3Ryb25nPkJJRyBlbmVyZ3kgcmVzdG9yZTwvc3Ryb25nPiArIHJlc2V0IGNvb2xkb3ducy4gTW9yZSBlZmZlY3RpdmUgd2hlbiB0aXJlZCE8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iaS1saW1pdCI+w5cxPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iaW5mby1yb3ciPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImktaWNvbiI+8J+RlDwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJpLW5hbWUiPkNFTzwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJpLWRlc2MiPk51Y2xlYXIgb3B0aW9uLiBFbmRzIGNyaXNpcywgdGFua3MgbW9yYWxlLjwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJpLWxpbWl0Ij7DlzE8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InR1dG9yaWFsLXNlY3Rpb24iPgogICAgICAgICAgICAgICAgICAgIDxoMz7imqDvuI8gSG93IFlvdSBMb3NlPC9oMz4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJmYWlsLWdyaWQiPgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJmYWlsLWl0ZW0iPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZi1pY29uIj7wn5KlPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJmLXRleHQiPlRlbnNpb24gaGl0cyAxMDAlPGJyPk1lZXRpbmcgZXhwbG9kZXM8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImZhaWwtaXRlbSI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJmLWljb24iPvCfmKk8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImYtdGV4dCI+RW5lcmd5IGhpdHMgMCU8YnI+RXZlcnlvbmUgZ2l2ZXMgdXA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImZhaWwtaXRlbSI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJmLWljb24iPuKPsDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZi10ZXh0Ij5NaXNzIGRlY2lzaW9uczxicj4tMTUlIHF1YWxpdHkgZWFjaDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJrZXktcG9pbnQiPgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJrcC10aXRsZSI+8J+SoSBLZXkgU3RyYXRlZ3k6IEludml0ZSB0aGUgUXVpZXQgT25lcyE8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ia3AtdGV4dCI+U29tZSBtZW1iZXJzIChsaWtlIEFuaXRhKSBhcmUgPHN0cm9uZz5xdWlldCBhbmQgd29uJ3Qgc3BlYWsgdXA8L3N0cm9uZz4gd2l0aG91dCBiZWluZyBpbnZpdGVkLiBXYXRjaCBmb3IgInF1aWV0IiB0YWdzIGFuZCB1c2Ug8J+Xo++4jyBJbnZpdGUgdG8gYnJpbmcgdGhlbSBpbi4gVGhlIFF1YWxpdHkgYmFyIHR1cm5zIGdyZWVuIGF0IDMrIHZvaWNlcyDigJQgeW91IG5lZWQgdG8gYWN0aXZlbHkgbWFuYWdlIHBhcnRpY2lwYXRpb24hPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ia2V5LXBvaW50IiBzdHlsZT0iYmFja2dyb3VuZDogI0ZFRjNDNzsgYm9yZGVyLWNvbG9yOiAjRkRFNjhBOyI+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImtwLXRpdGxlIj7imqEgV2F0Y2ggdGhlIEVuZXJneSE8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ia3AtdGV4dCI+RW5lcmd5IGRyYWlucyB0aHJvdWdob3V0IHRoZSBtZWV0aW5nLiA8c3Ryb25nPkxvdyBlbmVyZ3kgPSB0aXJlZCBmYWNlcywgd29yc2UgZGVjaXNpb25zPC9zdHJvbmc+LCBmYXN0ZXIgY29uZmxpY3RzLiBVc2Ug8J+YgiBKb2tlcyBmb3Igc21hbGwgZW5lcmd5IGJvb3N0cy4gU2F2ZSB0aGUg4piVIEJyZWFrIGZvciB3aGVuIGVuZXJneSBnZXRzIGNyaXRpY2FsITwvZGl2PgogICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAKICAgICAgICAgICAgPGRpdiBjbGFzcz0ic3RhcnQtc2VjdGlvbiI+CiAgICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJzdGFydC1idG4iIG9uY2xpY2s9InN0YXJ0R2FtZSgpIj5TdGFydCB0aGUgTWVldGluZyDwn46sPC9idXR0b24+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICAgIAogICAgICAgIDwhLS0gPT09PT09PT09PSBHQU1FIFNDUkVFTiA9PT09PT09PT09IC0tPgogICAgICAgIDxkaXYgY2xhc3M9ImdhbWUtc2NyZWVuIiBpZD0iZ2FtZS1zY3JlZW4iPgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJnYW1lLWhlYWRlciI+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJoZWFkZXItbGVmdCI+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0idGltZXItYm94Ij4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0idGltZSIgaWQ9InRpbWVyIj4xOjAwPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImxhYmVsIj5UT1RBTCBUSU1FPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0icHJvZ3Jlc3MtYm94Ij4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY291bnQiIGlkPSJkZWNpZGVkLWNvdW50Ij4wLzU8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ibGFiZWwiPkRFQ0lERUQ8L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJwYWNlLWJveCBnb29kIiBpZD0icGFjZS1ib3giPgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2Pk9uIFBhY2U8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0icGFjZS1sYWJlbCI+8J+RjTwvZGl2PgogICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImhlYWRlci1tZXRlcnMiPgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImgtbWV0ZXIgZW5lcmd5Ij4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ibWV0ZXItbGFiZWwiPjxzcGFuPuKaoSBFbmVyZ3k8L3NwYW4+PHNwYW4gaWQ9ImVuZXJneS12YWwiPjgwJTwvc3Bhbj48L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ibWV0ZXItYmFyIiBpZD0iZW5lcmd5LWJhci1jIj48ZGl2IGNsYXNzPSJtZXRlci1maWxsIiBpZD0iZW5lcmd5LWJhciIgc3R5bGU9IndpZHRoOjgwJSI+PC9kaXY+PC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iaC1tZXRlciB0ZW5zaW9uIj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ibWV0ZXItbGFiZWwiPjxzcGFuPvCflKUgVGVuc2lvbjwvc3Bhbj48c3BhbiBpZD0idGVuc2lvbi12YWwiPjI1JTwvc3Bhbj48L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ibWV0ZXItYmFyIiBpZD0idGVuc2lvbi1iYXItYyI+PGRpdiBjbGFzcz0ibWV0ZXItZmlsbCIgaWQ9InRlbnNpb24tYmFyIiBzdHlsZT0id2lkdGg6MjUlIj48L2Rpdj48L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgCiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImdhbWUtbWFpbiI+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJtZWV0aW5nLXJvb20iIGlkPSJtZWV0aW5nLXJvb20iPgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImZsYXNoLW92ZXJsYXkgYmFkIiBpZD0iZmxhc2gtYmFkIj48L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJmbGFzaC1vdmVybGF5IGdvb2QiIGlkPSJmbGFzaC1nb29kIj48L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJmbGFzaC1vdmVybGF5IGNlbyIgaWQ9ImZsYXNoLWNlbyI+PC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ibWVldGluZy10YWJsZSI+PC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0icm9vbS1zdGF0dXMiIGlkPSJyb29tLXN0YXR1cyI+PC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBpZD0ibWVtYmVycy1jb250YWluZXIiPjwvZGl2PgogICAgICAgICAgICAgICAgICAgIDxkaXYgaWQ9ImJ1YmJsZXMtY29udGFpbmVyIj48L2Rpdj4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJjb250cm9sLXBhbmVsIj4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJwcm9qZWN0LXNlY3Rpb24iPgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJwcm9qZWN0LWhlYWRlciI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8aDM+8J+TiyBERUNJU0lPTiA8c3BhbiBpZD0icHJvamVjdC1udW0iPjEvNTwvc3Bhbj48L2gzPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0icHJvamVjdC10aW1lciI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4+VGhpcyBpdGVtOjwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0icHQtdGltZSIgaWQ9Iml0ZW0tdGltZSI+MHM8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InByb2plY3QtY2FyZCI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJwcm9qZWN0LW5hbWUiIGlkPSJwcm9qZWN0LW5hbWUiPkxvYWRpbmcuLi48L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InByb2plY3QtZGVzYyIgaWQ9InByb2plY3QtZGVzYyI+Li4uPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InN0YXR1cy1zZWN0aW9uIj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY3Jpc2lzLWJhbm5lciIgaWQ9ImNyaXNpcy1iYW5uZXIiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImNyaXNpcy10ZXh0IiBpZD0iY3Jpc2lzLXRleHQiPuKaoSBDT05GTElDVDwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJjcmlzaXMtaGludCI+VXNlIPCflYrvuI8gRGVmdXNlITwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImRyYWctd2FybmluZyIgaWQ9ImRyYWctd2FybmluZyI+4o+zIERpc2N1c3Npb24gZHJhZ2dpbmcg4oCUIHRlbnNpb24gcmlzaW5nIGZhc3RlciE8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InN0YXR1cy1yb3ciPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ic3RhdHVzLWNoaXAiIGlkPSJjaGlwLXZvaWNlcyI+PHNwYW4gY2xhc3M9ImNoaXAtaWNvbiI+8J+Xo++4jzwvc3Bhbj48c3BhbiBjbGFzcz0iY2hpcC10ZXh0IiBpZD0idm9pY2VzLXRleHQiPjAvNDwvc3Bhbj48L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InN0YXR1cy1jaGlwIiBpZD0iY2hpcC1mYXRpZ3VlIj48c3BhbiBjbGFzcz0iY2hpcC1pY29uIj7wn5iKPC9zcGFuPjxzcGFuIGNsYXNzPSJjaGlwLXRleHQiIGlkPSJmYXRpZ3VlLXRleHQiPkZyZXNoPC9zcGFuPjwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ic3RhdHVzLWNoaXAiIGlkPSJjaGlwLXJvb20iPjxzcGFuIGNsYXNzPSJjaGlwLWljb24iPvCfmJA8L3NwYW4+PHNwYW4gY2xhc3M9ImNoaXAtdGV4dCI+T0s8L3NwYW4+PC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iYXR0ZW50aW9uLXJvdyIgaWQ9ImF0dGVudGlvbi1yb3ciPjwvZGl2PgogICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImFjdGlvbi1zZWN0aW9uIj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iYWN0aW9uLWhlYWRlciI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8aDQ+8J+OrCBBQ1RJT05TPC9oND4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImxpbWl0ZWQtaW5mbyI+TGltaXRlZDo8c3BhbiBpZD0ibGltLWpva2UiPjI8L3NwYW4+8J+YgiA8c3BhbiBpZD0ibGltLWJyZWFrIj4xPC9zcGFuPuKYlSA8c3BhbiBpZD0ibGltLWNlbyI+MTwvc3Bhbj7wn5GUPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJhY3Rpb24tZ3JpZCI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJhY3Rpb24tYnRuIiBpZD0iYnRuLWFjayIgb25jbGljaz0iZG9BY3Rpb24oJ2FjaycpIj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iaWNvbiI+8J+Rjzwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0ibGFiZWwiPkFja25vd2xlZGdlPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJ3aGVuIj5yZWNlbnQgc3BlYWtlcjwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvYnV0dG9uPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYWN0aW9uLWJ0biIgaWQ9ImJ0bi1pbnZpdGUiIG9uY2xpY2s9ImRvQWN0aW9uKCdpbnZpdGUnKSI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9Imljb24iPvCfl6PvuI88L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImxhYmVsIj5JbnZpdGU8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9IndoZW4iPnF1aWV0IG1lbWJlcnM8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2J1dHRvbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImFjdGlvbi1idG4iIGlkPSJidG4tZGVmdXNlIiBvbmNsaWNrPSJkb0FjdGlvbignZGVmdXNlJykiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJpY29uIj7wn5WK77iPPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJsYWJlbCI+RGVmdXNlPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJ3aGVuIj5wcmV2ZW50L3Jlc29sdmU8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2J1dHRvbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImFjdGlvbi1idG4gbGltaXRlZCIgaWQ9ImJ0bi1qb2tlIiBvbmNsaWNrPSJkb0FjdGlvbignam9rZScpIj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0idXNlcyIgaWQ9InUtam9rZSI+Mjwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iaWNvbiI+8J+Ygjwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0ibGFiZWwiPkpva2U8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9IndoZW4iPitlbmVyZ3k8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2J1dHRvbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImFjdGlvbi1idG4gbGltaXRlZCIgaWQ9ImJ0bi1icmVhayIgb25jbGljaz0iZG9BY3Rpb24oJ2JyZWFrJykiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJ1c2VzIiBpZD0idS1icmVhayI+MTwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iaWNvbiI+4piVPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJsYWJlbCI+QnJlYWs8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9IndoZW4iPnJlc3RvcmUgZW5lcmd5ITwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvYnV0dG9uPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYWN0aW9uLWJ0biBsaW1pdGVkIiBpZD0iYnRuLWNlbyIgb25jbGljaz0iZG9BY3Rpb24oJ2NlbycpIj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0idXNlcyIgaWQ9InUtY2VvIj4xPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJpY29uIj7wn5GUPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJsYWJlbCI+Q0VPPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJ3aGVuIj5udWNsZWFyPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9idXR0b24+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImRlY2lzaW9uLXNlY3Rpb24iPgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJxdWFsaXR5LWRpc3BsYXkiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0icXVhbGl0eS1oZWFkZXIiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJxdWFsaXR5LXRpdGxlIj7wn46vIERFQ0lTSU9OIFFVQUxJVFk8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9InF1YWxpdHktdGl0bGUiIGlkPSJxdWFsaXR5LWdvYWwiPk5lZWQgMysgdm9pY2VzIGZvciBncmVlbjwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0icXVhbGl0eS1zY29yZSBtZWRpdW0iIGlkPSJxdWFsaXR5LXNjb3JlIj4zNSU8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InF1YWxpdHktYmFyLWNvbnRhaW5lciI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0icXVhbGl0eS1iYXIiIGlkPSJxdWFsaXR5LWJhciIgc3R5bGU9IndpZHRoOiAzNSUiPjwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJxdWFsaXR5LWZhY3RvcnMiIGlkPSJxdWFsaXR5LWZhY3RvcnMiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJxdWFsaXR5LWZhY3RvciBuZXV0cmFsIj7wn5ej77iPIDAvNCB2b2ljZXM8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9InF1YWxpdHktZmFjdG9yIG5ldXRyYWwiPuKPsyBXYWl0aW5nLi4uPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJkZWNpc2lvbi1pbmZvIiBpZD0iZGVjaXNpb24taW5mbyI+R2V0IG1vcmUgdm9pY2VzIGhlYXJkIHRvIGltcHJvdmUgcXVhbGl0eTwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJkZWNpc2lvbi1idG5zIj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImRlY2lzaW9uLWJ0biBhcHByb3ZlIiBvbmNsaWNrPSJtYWtlRGVjaXNpb24oJ2FwcHJvdmUnKSI+4pyTIEFwcHJvdmU8L2J1dHRvbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImRlY2lzaW9uLWJ0biByZWplY3QiIG9uY2xpY2s9Im1ha2VEZWNpc2lvbigncmVqZWN0JykiPuKclyBSZWplY3Q8L2J1dHRvbj4KICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIAogICAgICAgICAgICA8ZGl2IGNsYXNzPSJldmVudC1sb2ciIGlkPSJldmVudC1sb2ciPjwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICAgIAogICAgICAgIDwhLS0gPT09PT09PT09PSBSRVNVTFQgU0NSRUVOID09PT09PT09PT0gLS0+CiAgICAgICAgPGRpdiBjbGFzcz0icmVzdWx0LXNjcmVlbiIgaWQ9InJlc3VsdC1zY3JlZW4iPgogICAgICAgICAgICA8aDIgaWQ9InJlc3VsdC10aXRsZSI+TWVldGluZyBPdmVyPC9oMj4KICAgICAgICAgICAgPHAgY2xhc3M9InJlc3VsdC1tZXNzYWdlIiBpZD0icmVzdWx0LW1lc3NhZ2UiPjwvcD4KICAgICAgICAgICAgPGRpdiBjbGFzcz0icmVzdWx0LWdyaWQiIGlkPSJyZXN1bHQtZ3JpZCI+PC9kaXY+CiAgICAgICAgICAgIDxidXR0b24gY2xhc3M9InN0YXJ0LWJ0biIgb25jbGljaz0ic2VuZFJlc3VsdFRvUGFyZW50KCkiPkNvbnRpbnVlIOKGkjwvYnV0dG9uPgogICAgICAgIDwvZGl2PgogICAgPC9kaXY+CiAgICAKICAgIDxzY3JpcHQ+CiAgICAgICAgY29uc3QgTUVNQkVSUyA9IFsKICAgICAgICAgICAgeyBpZDogJ2NlbycsIG5hbWU6ICdNZWVyYScsIGljb246ICfwn5GUJywgY29sb3I6ICcjOTMzM0VBJywgcG9zOiB7IHRvcDogJzMlJywgbGVmdDogJzUwJScsIHRyYW5zZm9ybTogJ3RyYW5zbGF0ZVgoLTUwJSknIH0sIGlzQ0VPOiB0cnVlIH0sCiAgICAgICAgICAgIHsgaWQ6ICd0ZWNoJywgbmFtZTogJ1JhaicsIGljb246ICfwn5SsJywgY29sb3I6ICcjMEVBNUU5JywgcG9zOiB7IHRvcDogJzMyJScsIGxlZnQ6ICcyJScgfSwgcml2YWw6ICdmaW5hbmNlJywgYXNzZXJ0aXZlOiAwLjggfSwKICAgICAgICAgICAgeyBpZDogJ2ZpbmFuY2UnLCBuYW1lOiAnUHJpeWEnLCBpY29uOiAn8J+SsCcsIGNvbG9yOiAnIzIyQzU1RScsIHBvczogeyB0b3A6ICczMiUnLCByaWdodDogJzIlJyB9LCByaXZhbDogJ3RlY2gnLCBhc3NlcnRpdmU6IDAuODUgfSwKICAgICAgICAgICAgeyBpZDogJ21rdCcsIG5hbWU6ICdEZXYnLCBpY29uOiAn8J+ToicsIGNvbG9yOiAnI0Y1OUUwQicsIHBvczogeyBib3R0b206ICcxOCUnLCBsZWZ0OiAnMiUnIH0sIHJpdmFsOiAnb3BzJywgYXNzZXJ0aXZlOiAwLjYgfSwKICAgICAgICAgICAgeyBpZDogJ29wcycsIG5hbWU6ICdBbml0YScsIGljb246ICfimpnvuI8nLCBjb2xvcjogJyNFRjQ0NDQnLCBwb3M6IHsgYm90dG9tOiAnMTglJywgcmlnaHQ6ICcyJScgfSwgcml2YWw6ICdta3QnLCBhc3NlcnRpdmU6IDAuNDUgfQogICAgICAgIF07CiAgICAgICAgCiAgICAgICAgY29uc3QgUFJPSkVDVFMgPSBbCiAgICAgICAgICAgIHsgbmFtZTogJ/CfpJYgQUkgQXNzaXN0YW50JywgZGVzYzogJ0N1c3RvbWVyIGNoYXRib3QuIFRlY2ggdnMgRmluYW5jZSBjbGFzaC4nIH0sCiAgICAgICAgICAgIHsgbmFtZTogJ/CfjLEgR3JlZW4gSW5pdGlhdGl2ZScsIGRlc2M6ICdDYXJib24gcmVkdWN0aW9uLiBPcHMgZHJlYWRzIGl0LicgfSwKICAgICAgICAgICAgeyBuYW1lOiAn8J+TiCBBbmFseXRpY3MgUGxhdGZvcm0nLCBkZXNjOiAnRGF0YSB1bmlmaWNhdGlvbi4gRXZlcnlvbmUgZGlzYWdyZWVzLicgfSwKICAgICAgICAgICAgeyBuYW1lOiAn4pqZ77iPIFByb2Nlc3MgQXV0b21hdGlvbicsIGRlc2M6ICdRdWljayBmaXggdnMgcHJvcGVyIGFyY2hpdGVjdHVyZS4nIH0sCiAgICAgICAgICAgIHsgbmFtZTogJ/CflKwgTGFiIEV4cGFuc2lvbicsIGRlc2M6ICdMb25nLXRlcm0gdnMgaW1tZWRpYXRlIGJ1ZGdldC4nIH0KICAgICAgICBdOwogICAgICAgIAogICAgICAgIGNvbnN0IFBIUkFTRVMgPSB7CiAgICAgICAgICAgIGFuZ3J5OiBbIlJpZGljdWxvdXMhIiwgIk5vdCBsaXN0ZW5pbmchIiwgIkFic3VyZCEiLCAiRGlzYWdyZWUhIiwgIlVuYWNjZXB0YWJsZSEiLCAiTm8gd2F5ISIsICJUaGlzIGlzIHdyb25nISJdLAogICAgICAgICAgICBjb25jZXJuOiBbIkNvbmNlcm5zIGhlcmUuIiwgIkJ1ZGdldCBpc3N1ZS4iLCAiVG9vIHJpc2t5LiIsICJST0k/IiwgIlRpbWVsaW5lPyIsICJSZXNvdXJjZXM/IiwgIldobyBvd25zIHRoaXM/Il0sCiAgICAgICAgICAgIHRpcmVkOiBbIip5YXduKiIsICIqc2lnaCoiLCAiV3JhcCB1cD8iLCAiR29pbmcgbG9uZy4uLiIsICJDYW4gd2UgbW92ZSBvbj8iLCAiSG93IG11Y2ggbG9uZ2VyPyIsICJOZWVkIGNvZmZlZS4uLiIsICJMb3N0IG15IHRyYWluIG9mIHRob3VnaHQiLCAiV2hhdCB3ZXJlIHdlIHNheWluZz8iLCAiSSdtIGZhZGluZyBoZXJlLi4uIl0sCiAgICAgICAgICAgIGdvb2Q6IFsiRmFpciBwb2ludC4iLCAiTWFrZXMgc2Vuc2UuIiwgIkFncmVlZC4iLCAiSSBjYW4gd29yayB3aXRoIHRoYXQuIiwgIkdvb2QgaWRlYS4iXSwKICAgICAgICAgICAgY29uZmxpY3Q6IFsiV3JvbmchIiwgIk5vbnNlbnNlISIsICJMZXQgbWUgZmluaXNoISIsICJZb3UgYWx3YXlzIGRvIHRoaXMhIiwgIlRoYXQncyBub3QgdHJ1ZSEiLCAiTGlzdGVuIHRvIG1lISJdLAogICAgICAgICAgICBqb2tlczogWyJUb28gbWFueSBzdGFrZWhvbGRlcnMhIPCfpYEiLCAiVGltZWxpbmU/IEFzcGlyYXRpb25hbCEg8J+YhSIsICJCdWRnZXQgPSByZWplY3QhIPCfkrgiXSwKICAgICAgICAgICAgY2VvOiBbIkknbSBkZWNpZGluZy4iLCAiTW92aW5nIG9uLiIsICJFbm91Z2guIiwgIkZpbmFsIHdvcmQuIiwgIldlJ3JlIGRvbmUgaGVyZS4iXSwKICAgICAgICAgICAgZW5lcmd5TG93OiBbIkV2ZXJ5b25lIGxvb2tzIHRpcmVkLi4uIiwgIlRoZSByb29tIGlzIGxvc2luZyBmb2N1cy4iLCAiQXR0ZW50aW9uIGlzIGRyaWZ0aW5nLiIsICJQZW9wbGUgYXJlIGNoZWNraW5nIHBob25lcy4iXQogICAgICAgIH07CiAgICAgICAgCiAgICAgICAgbGV0IEcgPSB7fTsKICAgICAgICBsZXQgdGltZXJJbnQsIHRpY2tJbnQsIHRlbnNpb25JbnQ7CiAgICAgICAgCiAgICAgICAgZnVuY3Rpb24gc3RhcnRHYW1lKCkgewogICAgICAgICAgICBHID0gewogICAgICAgICAgICAgICAgcnVubmluZzogdHJ1ZSwKICAgICAgICAgICAgICAgIHRpbWU6IDc1LAogICAgICAgICAgICAgICAgZW5lcmd5OiA5MCwKICAgICAgICAgICAgICAgIHRlbnNpb246IDEwLAogICAgICAgICAgICAgICAgcHJvamVjdDogMCwKICAgICAgICAgICAgICAgIGl0ZW1UaW1lOiAwLAogICAgICAgICAgICAgICAgZGVjaXNpb25zOiBbXSwKICAgICAgICAgICAgICAgIGRpc2N1c3Npb246IHsgdm9pY2VzOiBuZXcgU2V0KCksIHBvaW50czogMCB9LAogICAgICAgICAgICAgICAgbWVtYmVyczoge30sCiAgICAgICAgICAgICAgICBjb25mbGljdDogbnVsbCwKICAgICAgICAgICAgICAgIHVzZXM6IHsgam9rZTogMiwgYnJlYWs6IDEsIGNlbzogMSB9LAogICAgICAgICAgICAgICAgY2VvVXNlZDogMCwKICAgICAgICAgICAgICAgIGNvb2xkb3duczoge30sCiAgICAgICAgICAgICAgICBsYXN0U3BlYWtlcjogbnVsbCwKICAgICAgICAgICAgICAgIGNvbmZsaWN0Q291bnQ6IDAsCiAgICAgICAgICAgICAgICBsYXN0Q29uZmxpY3RUaW1lOiAwLAogICAgICAgICAgICAgICAgZ3VhcmFudGVlZENvbmZsaWN0czogW10sCiAgICAgICAgICAgICAgICBydXNoV2FybmVkOiBmYWxzZQogICAgICAgICAgICB9OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTG93ZXIgc3RhcnRpbmcgZnJ1c3RyYXRpb24KICAgICAgICAgICAgTUVNQkVSUy5mb3JFYWNoKG0gPT4gewogICAgICAgICAgICAgICAgRy5tZW1iZXJzW20uaWRdID0gewogICAgICAgICAgICAgICAgICAgIGZydXN0cmF0aW9uOiAxMCArIE1hdGgucmFuZG9tKCkgKiAxMiwKICAgICAgICAgICAgICAgICAgICB3YW50c1NwZWFrOiBNYXRoLnJhbmRvbSgpIDwgKG0uYXNzZXJ0aXZlIHx8IDAuNSkgKiAwLjYsIC8vIE1vcmUgbGlrZWx5IHRvIHdhbnQgdG8gc3BlYWsKICAgICAgICAgICAgICAgICAgICBsYXN0U3Bva2U6IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDMpCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJpdmFscyBhIGJpdCBtb3JlIGZydXN0cmF0ZWQgYnV0IG5vdCB0b28gbXVjaAogICAgICAgICAgICBHLm1lbWJlcnMudGVjaC5mcnVzdHJhdGlvbiA9IDI1OwogICAgICAgICAgICBHLm1lbWJlcnMuZmluYW5jZS5mcnVzdHJhdGlvbiA9IDI0OwogICAgICAgICAgICBHLm1lbWJlcnMubWt0LmZydXN0cmF0aW9uID0gMjA7CiAgICAgICAgICAgIEcubWVtYmVycy5vcHMuZnJ1c3RyYXRpb24gPSAyMjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEdVQVJBTlRFRSAyIGNvbmZsaWN0cyBhdCBzcGVjaWZpYyB0aW1lcyAtIHBsZW50eSBvZiB3YXJuaW5nCiAgICAgICAgICAgIC8vIEZpcnN0IGNvbmZsaWN0OiBiZXR3ZWVuIDIyLTMyIHNlY29uZHMgKHdpdGggMTAgc2VjIGJ1aWxkdXAgc3RhcnRpbmcgYXQgMTItMjIpCiAgICAgICAgICAgIGNvbnN0IGNvbmZsaWN0MVRpbWUgPSAyMiArIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDEwKTsKICAgICAgICAgICAgLy8gU2Vjb25kIGNvbmZsaWN0OiBiZXR3ZWVuIDUwLTY1IHNlY29uZHMgIAogICAgICAgICAgICBjb25zdCBjb25mbGljdDJUaW1lID0gNTAgKyBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAxNSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBHLmd1YXJhbnRlZWRDb25mbGljdHMgPSBbCiAgICAgICAgICAgICAgICB7IHRpbWU6IGNvbmZsaWN0MVRpbWUsIHBhaXI6IFsndGVjaCcsICdmaW5hbmNlJ10sIHRyaWdnZXJlZDogZmFsc2UgfSwKICAgICAgICAgICAgICAgIHsgdGltZTogY29uZmxpY3QyVGltZSwgcGFpcjogWydta3QnLCAnb3BzJ10sIHRyaWdnZXJlZDogZmFsc2UgfQogICAgICAgICAgICBdOwogICAgICAgICAgICAKICAgICAgICAgICAgYnVpbGRSb29tKCk7CiAgICAgICAgICAgIGxvYWRQcm9qZWN0KDApOwogICAgICAgICAgICAKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RpdGxlLXNjcmVlbicpLmNsYXNzTGlzdC5hZGQoJ2hpZGRlbicpOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVzdWx0LXNjcmVlbicpLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ2FtZS1zY3JlZW4nKS5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2V2ZW50LWxvZycpLmlubmVySFRNTCA9ICcnOwogICAgICAgICAgICAKICAgICAgICAgICAgWydqb2tlJywgJ2JyZWFrJywgJ2NlbyddLmZvckVhY2goYSA9PiB7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChgdS0ke2F9YCkudGV4dENvbnRlbnQgPSBHLnVzZXNbYV07CiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChgbGltLSR7YX1gKS50ZXh0Q29udGVudCA9IEcudXNlc1thXTsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGBidG4tJHthfWApLmRpc2FibGVkID0gZmFsc2U7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgbG9nKCfwn5OLIE1lZXRpbmcgYmVnaW5zLiBXYXRjaCBmb3Igcml2YWxyaWVzIScsICd3YXJuJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aW1lckludCA9IHNldEludGVydmFsKGdhbWVUaWNrLCAxMDAwKTsKICAgICAgICAgICAgdGlja0ludCA9IHNldEludGVydmFsKGFjdGl2aXR5VGljaywgMTIwMCk7IC8vIFNsaWdodGx5IGZhc3RlcgogICAgICAgICAgICB0ZW5zaW9uSW50ID0gc2V0SW50ZXJ2YWwodGVuc2lvblRpY2ssIDUwMCk7CiAgICAgICAgICAgIAogICAgICAgICAgICB1cGRhdGVVSSgpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBmdW5jdGlvbiBnZXRGYXRpZ3VlRmFjdG9yKCkgewogICAgICAgICAgICBjb25zdCBlbGFwc2VkID0gNzUgLSBHLnRpbWU7CiAgICAgICAgICAgIGNvbnN0IHByb2dyZXNzID0gZWxhcHNlZCAvIDc1OwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHByb2dyZXNzIDwgMC4zKSByZXR1cm4gMDsKICAgICAgICAgICAgaWYgKHByb2dyZXNzIDwgMC41KSByZXR1cm4gMC4zOwogICAgICAgICAgICBpZiAocHJvZ3Jlc3MgPCAwLjcpIHJldHVybiAwLjY7CiAgICAgICAgICAgIHJldHVybiAxLjA7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGZ1bmN0aW9uIHRlbnNpb25UaWNrKCkgewogICAgICAgICAgICBpZiAoIUcucnVubmluZykgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVmlzdWFsIHRlbnNpb24gZmVlZGJhY2sKICAgICAgICAgICAgY29uc3Qgcm9vbSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtZWV0aW5nLXJvb20nKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChHLmNvbmZsaWN0IHx8IEcudGVuc2lvbiA+IDgwKSB7CiAgICAgICAgICAgICAgICByb29tLnN0eWxlLmJhY2tncm91bmQgPSBgbGluZWFyLWdyYWRpZW50KDE4MGRlZywgI0ZFRTJFMiwgI0ZFQ0FDQSlgOwogICAgICAgICAgICB9IGVsc2UgaWYgKEcudGVuc2lvbiA+IDYwKSB7CiAgICAgICAgICAgICAgICByb29tLnN0eWxlLmJhY2tncm91bmQgPSBgbGluZWFyLWdyYWRpZW50KDE4MGRlZywgI0ZFRjNDNywgI0ZERTY4QSlgOwogICAgICAgICAgICB9IGVsc2UgaWYgKEcudGVuc2lvbiA+IDQ1KSB7CiAgICAgICAgICAgICAgICByb29tLnN0eWxlLmJhY2tncm91bmQgPSBgbGluZWFyLWdyYWRpZW50KDE4MGRlZywgI0UwRjJGRSwgI0JBRTZGRClgOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcm9vbS5zdHlsZS5iYWNrZ3JvdW5kID0gYGxpbmVhci1ncmFkaWVudCgxODBkZWcsICNFOEY0RkQsICNEMUU4RkEpYDsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ2hlY2sgZm9yIEdVQVJBTlRFRUQgY29uZmxpY3RzIChpZiBub3QgcHJldmVudGVkKQogICAgICAgICAgICBjb25zdCBlbGFwc2VkID0gNzUgLSBHLnRpbWU7CiAgICAgICAgICAgIEcuZ3VhcmFudGVlZENvbmZsaWN0cy5mb3JFYWNoKGdjID0+IHsKICAgICAgICAgICAgICAgIGlmICghZ2MudHJpZ2dlcmVkICYmICFnYy5wcmV2ZW50ZWQgJiYgZWxhcHNlZCA+PSBnYy50aW1lICYmICFHLmNvbmZsaWN0KSB7CiAgICAgICAgICAgICAgICAgICAgZ2MudHJpZ2dlcmVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBtMSA9IE1FTUJFUlMuZmluZChtID0+IG0uaWQgPT09IGdjLnBhaXJbMF0pOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IG0yID0gTUVNQkVSUy5maW5kKG0gPT4gbS5pZCA9PT0gZ2MucGFpclsxXSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKG0xICYmIG0yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEJ1aWxkIHVwIHRlbnNpb24gYmVmb3JlIGNvbmZsaWN0CiAgICAgICAgICAgICAgICAgICAgICAgIEcubWVtYmVyc1ttMS5pZF0uZnJ1c3RyYXRpb24gPSBNYXRoLm1pbigxMDAsIEcubWVtYmVyc1ttMS5pZF0uZnJ1c3RyYXRpb24gKyAxMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIEcubWVtYmVyc1ttMi5pZF0uZnJ1c3RyYXRpb24gPSBNYXRoLm1pbigxMDAsIEcubWVtYmVyc1ttMi5pZF0uZnJ1c3RyYXRpb24gKyAxMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRyaWdnZXJDb25mbGljdChtMSwgbTIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBZGRpdGlvbmFsIHJhbmRvbSBldmVudHMgKGxlc3MgZnJlcXVlbnQgc2luY2Ugd2UgaGF2ZSBndWFyYW50ZWVkIGNvbmZsaWN0cykKICAgICAgICAgICAgY29uc3QgZmF0aWd1ZSA9IGdldEZhdGlndWVGYWN0b3IoKTsKICAgICAgICAgICAgaWYgKCFHLmNvbmZsaWN0ICYmIE1hdGgucmFuZG9tKCkgPCAwLjAwOCArIGZhdGlndWUgKiAwLjAxNSkgewogICAgICAgICAgICAgICAgdHJpZ2dlclJhbmRvbUV2ZW50KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZnVuY3Rpb24gdHJpZ2dlclJhbmRvbUV2ZW50KCkgewogICAgICAgICAgICBjb25zdCBmYXRpZ3VlID0gZ2V0RmF0aWd1ZUZhY3RvcigpOwogICAgICAgICAgICBjb25zdCByb2xsID0gTWF0aC5yYW5kb20oKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChyb2xsIDwgMC4zICYmIEcuY29uZmxpY3RDb3VudCA8IDQpIHsKICAgICAgICAgICAgICAgIC8vIEV4dHJhIGNvbmZsaWN0IChiZXlvbmQgdGhlIGd1YXJhbnRlZWQgMikKICAgICAgICAgICAgICAgIGNvbnN0IHBhaXJzID0gW1sndGVjaCcsICdmaW5hbmNlJ10sIFsnbWt0JywgJ29wcyddXTsKICAgICAgICAgICAgICAgIGNvbnN0IHBhaXIgPSBwYWlyc1tNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBwYWlycy5sZW5ndGgpXTsKICAgICAgICAgICAgICAgIGNvbnN0IG0xID0gTUVNQkVSUy5maW5kKG0gPT4gbS5pZCA9PT0gcGFpclswXSk7CiAgICAgICAgICAgICAgICBjb25zdCBtMiA9IE1FTUJFUlMuZmluZChtID0+IG0uaWQgPT09IHBhaXJbMV0pOwogICAgICAgICAgICAgICAgaWYgKG0xICYmIG0yKSB7CiAgICAgICAgICAgICAgICAgICAgdHJpZ2dlckNvbmZsaWN0KG0xLCBtMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAocm9sbCA8IDAuNikgewogICAgICAgICAgICAgICAgLy8gRnJ1c3RyYXRlZCBvdXRidXJzdAogICAgICAgICAgICAgICAgY29uc3QgY2FuZGlkYXRlcyA9IE1FTUJFUlMuZmlsdGVyKG0gPT4gIW0uaXNDRU8gJiYgRy5tZW1iZXJzW20uaWRdLmZydXN0cmF0aW9uID4gMjUpOwogICAgICAgICAgICAgICAgaWYgKGNhbmRpZGF0ZXMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG0gPSBjYW5kaWRhdGVzW01hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIGNhbmRpZGF0ZXMubGVuZ3RoKV07CiAgICAgICAgICAgICAgICAgICAgRy5tZW1iZXJzW20uaWRdLmZydXN0cmF0aW9uICs9IDEwOwogICAgICAgICAgICAgICAgICAgIEcudGVuc2lvbiA9IE1hdGgubWluKDEwMCwgRy50ZW5zaW9uICsgNiArIGZhdGlndWUgKiA0KTsKICAgICAgICAgICAgICAgICAgICBzZXRNZW1iZXJTdGF0ZShtLmlkLCAnYW5ncnknKTsKICAgICAgICAgICAgICAgICAgICBzaG93U3BlZWNoKG0uaWQsIFBIUkFTRVMuYW5ncnlbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogUEhSQVNFUy5hbmdyeS5sZW5ndGgpXSwgJ2FuZ3J5Jyk7CiAgICAgICAgICAgICAgICAgICAgZmxhc2goJ2JhZCcpOwogICAgICAgICAgICAgICAgICAgIHNob3dTdGF0dXMoJ/CfmKQnKTsKICAgICAgICAgICAgICAgICAgICBsb2coYPCfmKQgJHttLm5hbWV9IGxvc2VzIHBhdGllbmNlIWAsICdiYWQnKTsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IGNsZWFyTWVtYmVyU3RhdGUobS5pZCksIDEyMDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gR2VuZXJhbCByb29tIHRlbnNpb24gc3Bpa2UKICAgICAgICAgICAgICAgIEcudGVuc2lvbiA9IE1hdGgubWluKDEwMCwgRy50ZW5zaW9uICsgNSArIGZhdGlndWUgKiA1KTsKICAgICAgICAgICAgICAgIE1FTUJFUlMuZmlsdGVyKG0gPT4gIW0uaXNDRU8pLmZvckVhY2gobSA9PiB7CiAgICAgICAgICAgICAgICAgICAgRy5tZW1iZXJzW20uaWRdLmZydXN0cmF0aW9uID0gTWF0aC5taW4oMTAwLCBHLm1lbWJlcnNbbS5pZF0uZnJ1c3RyYXRpb24gKyAzKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgc2hvd1N0YXR1cygn8J+YrCcpOwogICAgICAgICAgICAgICAgbG9nKGDwn5isIFBhdGllbmNlIHdlYXJpbmcgdGhpbi4uLmAsICd3YXJuJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdXBkYXRlVUkoKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZnVuY3Rpb24gZ2V0RHJhZ1BlbmFsdHkoKSB7CiAgICAgICAgICAgIGlmIChHLml0ZW1UaW1lIDwgMTApIHJldHVybiAwOwogICAgICAgICAgICBpZiAoRy5pdGVtVGltZSA8IDE1KSByZXR1cm4gMC4xNTsKICAgICAgICAgICAgaWYgKEcuaXRlbVRpbWUgPCAyMCkgcmV0dXJuIDAuMzsKICAgICAgICAgICAgcmV0dXJuIDAuNTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZnVuY3Rpb24gYnVpbGRSb29tKCkgewogICAgICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21lbWJlcnMtY29udGFpbmVyJyk7CiAgICAgICAgICAgIGNvbnN0IGIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYnViYmxlcy1jb250YWluZXInKTsKICAgICAgICAgICAgYy5pbm5lckhUTUwgPSAnJzsgYi5pbm5lckhUTUwgPSAnJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIE1FTUJFUlMuZm9yRWFjaChtID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgICAgICBlbC5jbGFzc05hbWUgPSAnbWVtYmVyJzsgZWwuaWQgPSBgbS0ke20uaWR9YDsKICAgICAgICAgICAgICAgIE9iamVjdC5hc3NpZ24oZWwuc3R5bGUsIG0ucG9zKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3Qgcm9sZSA9IG0uaXNDRU8gPyAnQ2hhaXInIDogCiAgICAgICAgICAgICAgICAgICAgbS5pZCA9PT0gJ3RlY2gnID8gJ1RlY2gnIDogCiAgICAgICAgICAgICAgICAgICAgbS5pZCA9PT0gJ2ZpbmFuY2UnID8gJ0ZpbmFuY2UnIDogCiAgICAgICAgICAgICAgICAgICAgbS5pZCA9PT0gJ21rdCcgPyAnTWFya2V0aW5nJyA6ICdPcGVyYXRpb25zJzsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQ3JlYXRlIGZhY2UtYmFzZWQgYXZhdGFyCiAgICAgICAgICAgICAgICBjb25zdCBhdmF0YXJDbGFzcyA9IGBhdmF0YXItJHttLm5hbWUudG9Mb3dlckNhc2UoKX1gOwogICAgICAgICAgICAgICAgY29uc3QgaGFzR2xhc3NlcyA9IG0uaWQgPT09ICdta3QnOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBlbC5pbm5lckhUTUwgPSBgCiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ibWVtYmVyLXN0YXR1cyIgaWQ9InN0LSR7bS5pZH0iPjwvZGl2PgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9Im1lbWJlci1hdmF0YXIgJHthdmF0YXJDbGFzc30iPgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJhdmF0YXItZmFjZSI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJmYWNlLWJnIj48L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImhhaXIiPjwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHtoYXNHbGFzc2VzID8gJzxkaXYgY2xhc3M9ImdsYXNzZXMiPjwvZGl2PicgOiAnJ30KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImV5ZWJyb3dzIj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJleWVicm93Ij48L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJleWVicm93Ij48L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZXllcyI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZXllIj48L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJleWUiPjwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJtb3V0aCI+PC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJtZW1iZXItZW1vdGlvbiIgaWQ9ImVtby0ke20uaWR9Ij48L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJtZW1iZXItbmFtZSI+JHttLm5hbWV9PC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ibWVtYmVyLXJvbGUiPiR7cm9sZX08L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJtZW1iZXItYmFyIj48ZGl2IGNsYXNzPSJtZW1iZXItYmFyLWZpbGwiIGlkPSJiYXItJHttLmlkfSIgc3R5bGU9IndpZHRoOjIwJSI+PC9kaXY+PC9kaXY+CiAgICAgICAgICAgICAgICBgOwogICAgICAgICAgICAgICAgYy5hcHBlbmRDaGlsZChlbCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGJ1YiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICAgICAgYnViLmNsYXNzTmFtZSA9ICdzcGVlY2gtYnViYmxlJzsgYnViLmlkID0gYGJ1Yi0ke20uaWR9YDsKICAgICAgICAgICAgICAgIGIuYXBwZW5kQ2hpbGQoYnViKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBZGQgY3VycmVudCBzcGVha2VyIGRpc3BsYXkKICAgICAgICAgICAgY29uc3Qgc3BlYWtlckRpc3BsYXkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgICAgc3BlYWtlckRpc3BsYXkuY2xhc3NOYW1lID0gJ2N1cnJlbnQtc3BlYWtlcic7CiAgICAgICAgICAgIHNwZWFrZXJEaXNwbGF5LmlkID0gJ2N1cnJlbnQtc3BlYWtlcic7CiAgICAgICAgICAgIHNwZWFrZXJEaXNwbGF5LmlubmVySFRNTCA9ICc8c3BhbiBjbGFzcz0ic3BlYWtlci1pY29uIj48L3NwYW4+PHNwYW4gY2xhc3M9InNwZWFrZXItdGV4dCI+PC9zcGFuPic7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtZWV0aW5nLXJvb20nKS5hcHBlbmRDaGlsZChzcGVha2VyRGlzcGxheSk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGZ1bmN0aW9uIGxvYWRQcm9qZWN0KGlkeCkgewogICAgICAgICAgICBjb25zdCBwID0gUFJPSkVDVFNbaWR4XTsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Byb2plY3QtbnVtJykudGV4dENvbnRlbnQgPSBgJHtpZHggKyAxfS81YDsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Byb2plY3QtbmFtZScpLnRleHRDb250ZW50ID0gcC5uYW1lOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJvamVjdC1kZXNjJykudGV4dENvbnRlbnQgPSBwLmRlc2M7CiAgICAgICAgICAgIAogICAgICAgICAgICBHLmRpc2N1c3Npb24gPSB7IHZvaWNlczogbmV3IFNldCgpLCBwb2ludHM6IDAgfTsKICAgICAgICAgICAgRy5pdGVtVGltZSA9IDA7CiAgICAgICAgICAgIEcubGFzdFNwZWFrZXIgPSBudWxsOwogICAgICAgICAgICBHLnJ1c2hXYXJuZWQgPSBmYWxzZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIE1FTUJFUlMuZm9yRWFjaChtID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGFzc2VydGl2ZSA9IG0uYXNzZXJ0aXZlIHx8IDAuNTsKICAgICAgICAgICAgICAgIEcubWVtYmVyc1ttLmlkXS53YW50c1NwZWFrID0gTWF0aC5yYW5kb20oKSA8IGFzc2VydGl2ZSAqIDAuNDsKICAgICAgICAgICAgICAgIEcubWVtYmVyc1ttLmlkXS5sYXN0U3Bva2UgPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAzKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGZ1bmN0aW9uIGdhbWVUaWNrKCkgewogICAgICAgICAgICBpZiAoIUcucnVubmluZykgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgRy50aW1lLS07CiAgICAgICAgICAgIEcuaXRlbVRpbWUrKzsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGRyYWcgPSBnZXREcmFnUGVuYWx0eSgpOwogICAgICAgICAgICBjb25zdCBmYXRpZ3VlID0gZ2V0RmF0aWd1ZUZhY3RvcigpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRW5lcmd5IGRyYWlucyBiYXNlZCBvbiBhY3Rpdml0eSBhbmQgdGltZQogICAgICAgICAgICBjb25zdCBlbmVyZ3lEcmFpbiA9IDAuMyArIGZhdGlndWUgKiAwLjQ7CiAgICAgICAgICAgIEcuZW5lcmd5ID0gTWF0aC5tYXgoMCwgRy5lbmVyZ3kgLSBlbmVyZ3lEcmFpbik7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBUZW5zaW9uIHJpc2VzIC0gZmFzdGVyIHdoZW4gdGlyZWQKICAgICAgICAgICAgY29uc3QgdGlyZWRuZXNzTXVsdGlwbGllciA9IEcuZW5lcmd5IDwgNDAgPyAxLjUgOiBHLmVuZXJneSA8IDYwID8gMS4yIDogMTsKICAgICAgICAgICAgY29uc3QgdGVuc2lvblJpc2UgPSAoMC4xNSArIGZhdGlndWUgKiAwLjIgKyBkcmFnICogMC4yKSAqIHRpcmVkbmVzc011bHRpcGxpZXI7CiAgICAgICAgICAgIEcudGVuc2lvbiA9IE1hdGgubWluKDEwMCwgRy50ZW5zaW9uICsgdGVuc2lvblJpc2UpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTG93IGVuZXJneSBlZmZlY3RzCiAgICAgICAgICAgIGlmIChHLmVuZXJneSA8IDQwKSB7CiAgICAgICAgICAgICAgICAvLyBUaXJlZCBwZW9wbGUgZ2V0IGNyYW5reSAtIGZydXN0cmF0aW9uIGJ1aWxkcyBmYXN0ZXIKICAgICAgICAgICAgICAgIE1FTUJFUlMuZm9yRWFjaChtID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAoIW0uaXNDRU8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgRy5tZW1iZXJzW20uaWRdLmZydXN0cmF0aW9uID0gTWF0aC5taW4oMTAwLCBHLm1lbWJlcnNbbS5pZF0uZnJ1c3RyYXRpb24gKyAwLjE1KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gT2NjYXNpb25hbCB0aXJlZCBjb21tZW50cwogICAgICAgICAgICAgICAgaWYgKEcuZW5lcmd5IDwgMjUgJiYgTWF0aC5yYW5kb20oKSA8IDAuMDMpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0aXJlZE1lbWJlciA9IE1FTUJFUlMuZmlsdGVyKG0gPT4gIW0uaXNDRU8pW01hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDQpXTsKICAgICAgICAgICAgICAgICAgICBzaG93U3BlZWNoKHRpcmVkTWVtYmVyLmlkLCBQSFJBU0VTLnRpcmVkW01hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIFBIUkFTRVMudGlyZWQubGVuZ3RoKV0sICcnKTsKICAgICAgICAgICAgICAgICAgICBsb2coYPCfmKsgJHt0aXJlZE1lbWJlci5uYW1lfSBsb29rcyBleGhhdXN0ZWRgLCAnd2FybicpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBWZXJ5IGxvdyBlbmVyZ3kgaXMgZGFuZ2Vyb3VzCiAgICAgICAgICAgIGlmIChHLmVuZXJneSA8IDIwKSB7CiAgICAgICAgICAgICAgICBHLnRlbnNpb24gPSBNYXRoLm1pbigxMDAsIEcudGVuc2lvbiArIDAuMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFDVElWRSBDT05GTElDVFMgZXNjYWxhdGUgLSBmYXN0ZXIgd2hlbiB0aXJlZAogICAgICAgICAgICBpZiAoRy5jb25mbGljdCkgewogICAgICAgICAgICAgICAgY29uc3QgY29uZmxpY3RSYXRlID0gRy5lbmVyZ3kgPCA0MCA/IDEuMiA6IDAuODsKICAgICAgICAgICAgICAgIEcudGVuc2lvbiA9IE1hdGgubWluKDEwMCwgRy50ZW5zaW9uICsgY29uZmxpY3RSYXRlICsgZmF0aWd1ZSAqIDAuMyk7CiAgICAgICAgICAgICAgICBjb25zdCBbaWQxLCBpZDJdID0gRy5jb25mbGljdDsKICAgICAgICAgICAgICAgIEcubWVtYmVyc1tpZDFdLmZydXN0cmF0aW9uID0gTWF0aC5taW4oMTAwLCBHLm1lbWJlcnNbaWQxXS5mcnVzdHJhdGlvbiArIDAuNSk7CiAgICAgICAgICAgICAgICBHLm1lbWJlcnNbaWQyXS5mcnVzdHJhdGlvbiA9IE1hdGgubWluKDEwMCwgRy5tZW1iZXJzW2lkMl0uZnJ1c3RyYXRpb24gKyAwLjUpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBPY2Nhc2lvbmFsIGFuZ3J5IG91dGJ1cnN0cyBkdXJpbmcgY29uZmxpY3QKICAgICAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpIDwgMC4xMikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwZWFrZXIgPSBNYXRoLnJhbmRvbSgpIDwgMC41ID8gaWQxIDogaWQyOwogICAgICAgICAgICAgICAgICAgIHNob3dTcGVlY2goc3BlYWtlciwgUEhSQVNFUy5jb25mbGljdFtNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBQSFJBU0VTLmNvbmZsaWN0Lmxlbmd0aCldLCAnYW5ncnknKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ2hlY2sgZm9yIHByZS1jb25mbGljdCB3YXJuaW5nIHNpZ25zIChyaXZhbHMgZ2V0dGluZyBoZWF0ZWQpCiAgICAgICAgICAgIEcuZ3VhcmFudGVlZENvbmZsaWN0cy5mb3JFYWNoKGdjID0+IHsKICAgICAgICAgICAgICAgIGlmICghZ2MudHJpZ2dlcmVkKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZWxhcHNlZCA9IDc1IC0gRy50aW1lOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRpbWVVbnRpbCA9IGdjLnRpbWUgLSBlbGFwc2VkOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIDEwIHNlY29uZHMgYmVmb3JlOiBmaXJzdCB3YXJuaW5nIHNpZ24KICAgICAgICAgICAgICAgICAgICBpZiAodGltZVVudGlsIDw9IDEwICYmIHRpbWVVbnRpbCA+IDcgJiYgIWdjLmVhcmx5V2FybikgewogICAgICAgICAgICAgICAgICAgICAgICBnYy5lYXJseVdhcm4gPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtMSA9IE1FTUJFUlMuZmluZChtID0+IG0uaWQgPT09IGdjLnBhaXJbMF0pOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtMiA9IE1FTUJFUlMuZmluZChtID0+IG0uaWQgPT09IGdjLnBhaXJbMV0pOwogICAgICAgICAgICAgICAgICAgICAgICBHLm1lbWJlcnNbZ2MucGFpclswXV0uZnJ1c3RyYXRpb24gKz0gNTsKICAgICAgICAgICAgICAgICAgICAgICAgRy5tZW1iZXJzW2djLnBhaXJbMV1dLmZydXN0cmF0aW9uICs9IDU7CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZyhg8J+RgCAke20xLm5hbWV9IGFuZCAke20yLm5hbWV9IHNlZW0gdGVuc2UuLi5gLCAnd2FybicpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyA3IHNlY29uZHMgYmVmb3JlOiB0ZW5zaW9uIHJpc2luZywgc2hvdyB2aXN1YWwKICAgICAgICAgICAgICAgICAgICBpZiAodGltZVVudGlsIDw9IDcgJiYgdGltZVVudGlsID4gNCAmJiAhZ2Mud2FybmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGdjLndhcm5lZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG0xID0gTUVNQkVSUy5maW5kKG0gPT4gbS5pZCA9PT0gZ2MucGFpclswXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG0yID0gTUVNQkVSUy5maW5kKG0gPT4gbS5pZCA9PT0gZ2MucGFpclsxXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIEcubWVtYmVyc1tnYy5wYWlyWzBdXS5mcnVzdHJhdGlvbiArPSA2OwogICAgICAgICAgICAgICAgICAgICAgICBHLm1lbWJlcnNbZ2MucGFpclsxXV0uZnJ1c3RyYXRpb24gKz0gNjsKICAgICAgICAgICAgICAgICAgICAgICAgc2V0TWVtYmVyU3RhdGUoZ2MucGFpclswXSwgJ3RlbnNlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHNldE1lbWJlclN0YXRlKGdjLnBhaXJbMV0sICd0ZW5zZScpOwogICAgICAgICAgICAgICAgICAgICAgICBzaG93U3BlZWNoKGdjLnBhaXJbMF0sIFBIUkFTRVMuY29uY2VybltNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBQSFJBU0VTLmNvbmNlcm4ubGVuZ3RoKV0sICcnKTsKICAgICAgICAgICAgICAgICAgICAgICAgRy50ZW5zaW9uID0gTWF0aC5taW4oMTAwLCBHLnRlbnNpb24gKyA1KTsKICAgICAgICAgICAgICAgICAgICAgICAgbG9nKGDwn5isICR7bTEubmFtZX0gYW5kICR7bTIubmFtZX0gZXhjaGFuZ2luZyBsb29rcy4uLmAsICd3YXJuJyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIDMgc2Vjb25kcyBiZWZvcmU6IGZpbmFsIHdhcm5pbmcsIHJlY29tbWVuZCBhY3Rpb24KICAgICAgICAgICAgICAgICAgICBpZiAodGltZVVudGlsIDw9IDMgJiYgdGltZVVudGlsID4gMCAmJiAhZ2MuZmluYWxXYXJuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGdjLmZpbmFsV2FybiA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG0xID0gTUVNQkVSUy5maW5kKG0gPT4gbS5pZCA9PT0gZ2MucGFpclswXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG0yID0gTUVNQkVSUy5maW5kKG0gPT4gbS5pZCA9PT0gZ2MucGFpclsxXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIEcubWVtYmVyc1tnYy5wYWlyWzBdXS5mcnVzdHJhdGlvbiArPSA1OwogICAgICAgICAgICAgICAgICAgICAgICBHLm1lbWJlcnNbZ2MucGFpclsxXV0uZnJ1c3RyYXRpb24gKz0gNTsKICAgICAgICAgICAgICAgICAgICAgICAgc2hvd1NwZWVjaChnYy5wYWlyWzFdLCAiSSBkaXNhZ3JlZSB3aXRoIHRoYXQgYXBwcm9hY2guIiwgJ2FuZ3J5Jyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHNldE1lbWJlclN0YXRlKGdjLnBhaXJbMF0sICdhbmdyeScpOwogICAgICAgICAgICAgICAgICAgICAgICBzZXRNZW1iZXJTdGF0ZShnYy5wYWlyWzFdLCAnYW5ncnknKTsKICAgICAgICAgICAgICAgICAgICAgICAgRy50ZW5zaW9uID0gTWF0aC5taW4oMTAwLCBHLnRlbnNpb24gKyA1KTsKICAgICAgICAgICAgICAgICAgICAgICAgZmxhc2goJ2JhZCcpOwogICAgICAgICAgICAgICAgICAgICAgICBsb2coYOKaoO+4jyAke20xLm5hbWV9IHZzICR7bTIubmFtZX0gYWJvdXQgdG8gY2xhc2ghIFVzZSDwn5WK77iPIERlZnVzZSBOT1chYCwgJ2JhZCcpOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gSGlnaGxpZ2h0IGRlZnVzZSBidXR0b24KICAgICAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2J0bi1kZWZ1c2UnKS5jbGFzc0xpc3QuYWRkKCdyZWNvbW1lbmRlZCcpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBNRU1CRVJTLmZvckVhY2gobSA9PiB7CiAgICAgICAgICAgICAgICBpZiAobS5pc0NFTykgcmV0dXJuOwogICAgICAgICAgICAgICAgY29uc3QgbXMgPSBHLm1lbWJlcnNbbS5pZF07CiAgICAgICAgICAgICAgICBtcy5sYXN0U3Bva2UrKzsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRnJ1c3RyYXRpb24gYnVpbGRzIHdoZW4gbm90IGhlYXJkCiAgICAgICAgICAgICAgICBpZiAoIUcuZGlzY3Vzc2lvbi52b2ljZXMuaGFzKG0uaWQpKSB7CiAgICAgICAgICAgICAgICAgICAgbXMuZnJ1c3RyYXRpb24gPSBNYXRoLm1pbigxMDAsIG1zLmZydXN0cmF0aW9uICsgMC4yNSArIGZhdGlndWUgKiAwLjE1KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBBc3NlcnRpdmUgcGVvcGxlIHdhbnQgdG8gc3BlYWsgc29vbmVyLCBxdWlldCBwZW9wbGUgbGF0ZXIKICAgICAgICAgICAgICAgICAgICBjb25zdCBhc3NlcnRpdmUgPSBtLmFzc2VydGl2ZSB8fCAwLjU7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3BlYWtUaHJlc2hvbGQgPSBNYXRoLmZsb29yKDQgKyAoMSAtIGFzc2VydGl2ZSkgKiA1KTsgLy8gNC05IGJhc2VkIG9uIGFzc2VydGl2ZW5lc3MKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAobXMubGFzdFNwb2tlID4gc3BlYWtUaHJlc2hvbGQgJiYgTWF0aC5yYW5kb20oKSA8IGFzc2VydGl2ZSAqIDAuNCkgewogICAgICAgICAgICAgICAgICAgICAgICBtcy53YW50c1NwZWFrID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEhpZ2ggZnJ1c3RyYXRpb24gYmxlZWRzIGludG8gdGVuc2lvbiAocmVkdWNlZCkKICAgICAgICAgICAgICAgIGlmIChtcy5mcnVzdHJhdGlvbiA+IDYwKSBHLnRlbnNpb24gPSBNYXRoLm1pbigxMDAsIEcudGVuc2lvbiArIDAuMDMpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHVwZGF0ZVVJKCk7CiAgICAgICAgICAgIGNoZWNrRW5kKCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGZ1bmN0aW9uIGFjdGl2aXR5VGljaygpIHsKICAgICAgICAgICAgaWYgKCFHLnJ1bm5pbmcpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGZhdGlndWUgPSBnZXRGYXRpZ3VlRmFjdG9yKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBEdXJpbmcgY29uZmxpY3QsIHBhcnRpY2lwYW50cyBrZWVwIGFyZ3VpbmcKICAgICAgICAgICAgaWYgKEcuY29uZmxpY3QpIHsKICAgICAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpIDwgMC4yKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3BlYWtlciA9IEcuY29uZmxpY3RbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogMildOwogICAgICAgICAgICAgICAgICAgIHNldE1lbWJlclN0YXRlKHNwZWFrZXIsICdhbmdyeScpOwogICAgICAgICAgICAgICAgICAgIHNob3dTcGVlY2goc3BlYWtlciwgUEhSQVNFUy5jb25mbGljdFtNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBQSFJBU0VTLmNvbmZsaWN0Lmxlbmd0aCldLCAnYW5ncnknKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsgLy8gTm8gbm9ybWFsIHNwZWFraW5nIGR1cmluZyBjb25mbGljdAogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBGcnVzdHJhdGVkIGludGVycnVwdGlvbnMgbW9yZSBsaWtlbHkgd2hlbiB0aXJlZAogICAgICAgICAgICBjb25zdCB2ZXJ5RnJ1c3RyYXRlZCA9IE1FTUJFUlMuZmlsdGVyKG0gPT4gIW0uaXNDRU8gJiYgRy5tZW1iZXJzW20uaWRdLmZydXN0cmF0aW9uID4gNTApOwogICAgICAgICAgICBpZiAodmVyeUZydXN0cmF0ZWQubGVuZ3RoID4gMCAmJiBNYXRoLnJhbmRvbSgpIDwgMC4wNiArIGZhdGlndWUgKiAwLjA2KSB7CiAgICAgICAgICAgICAgICBjb25zdCBtID0gdmVyeUZydXN0cmF0ZWRbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogdmVyeUZydXN0cmF0ZWQubGVuZ3RoKV07CiAgICAgICAgICAgICAgICBzZXRNZW1iZXJTdGF0ZShtLmlkLCAnYW5ncnknKTsKICAgICAgICAgICAgICAgIHNob3dTcGVlY2gobS5pZCwgUEhSQVNFUy5hbmdyeVtNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBQSFJBU0VTLmFuZ3J5Lmxlbmd0aCldLCAnYW5ncnknKTsKICAgICAgICAgICAgICAgIEcudGVuc2lvbiA9IE1hdGgubWluKDEwMCwgRy50ZW5zaW9uICsgNCArIGZhdGlndWUgKiAzKTsKICAgICAgICAgICAgICAgIGZsYXNoKCdiYWQnKTsKICAgICAgICAgICAgICAgIGxvZyhg8J+YpCAke20ubmFtZX0gdmVudHMgZnJ1c3RyYXRpb24hYCwgJ3dhcm4nKTsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gY2xlYXJNZW1iZXJTdGF0ZShtLmlkKSwgMTAwMCk7CiAgICAgICAgICAgICAgICB1cGRhdGVVSSgpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBQbGF5ZXJzIG5lZWQgdG8gdXNlIEludml0ZSB0byBnZXQgcXVpZXRlciBtZW1iZXJzIHRhbGtpbmcKICAgICAgICAgICAgLy8gQXNzZXJ0aXZlIG1lbWJlcnMgc3BlYWsgdXAgbW9yZSwgcXVpZXQgb25lcyBuZWVkIGludml0aW5nCiAgICAgICAgICAgIGNvbnN0IGNhbmRpZGF0ZXMgPSBNRU1CRVJTLmZpbHRlcihtID0+IHsKICAgICAgICAgICAgICAgIGlmIChtLmlzQ0VPKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICBjb25zdCBtcyA9IEcubWVtYmVyc1ttLmlkXTsKICAgICAgICAgICAgICAgIGNvbnN0IGFzc2VydGl2ZSA9IG0uYXNzZXJ0aXZlIHx8IDAuNTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQ2hlY2sgaWYgdGhleSB3YW50IHRvIHNwZWFrIGJhc2VkIG9uIHBlcnNvbmFsaXR5CiAgICAgICAgICAgICAgICBpZiAobXMud2FudHNTcGVhayAmJiBNYXRoLnJhbmRvbSgpIDwgYXNzZXJ0aXZlICsgMC4yKSByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIGlmIChtcy5sYXN0U3Bva2UgPiA3KSByZXR1cm4gdHJ1ZTsgLy8gUGVvcGxlIGV2ZW50dWFsbHkgc3BlYWsKICAgICAgICAgICAgICAgIGlmIChtcy5mcnVzdHJhdGlvbiA+IDUwICYmIE1hdGgucmFuZG9tKCkgPCAwLjYpIHJldHVybiB0cnVlOyAvLyBGcnVzdHJhdGlvbiBtYWtlcyBwZW9wbGUgc3BlYWsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyA1MCUgY2hhbmNlIHNvbWVvbmUgc3BlYWtzIGlmIHRoZXkgd2FudCB0bwogICAgICAgICAgICBpZiAoY2FuZGlkYXRlcy5sZW5ndGggPiAwICYmIE1hdGgucmFuZG9tKCkgPCAwLjUpIHsKICAgICAgICAgICAgICAgIC8vIFByaW9yaXRpemUgZnJ1c3RyYXRlZCBwZW9wbGUgKHRoZXkgaW50ZXJydXB0KQogICAgICAgICAgICAgICAgY2FuZGlkYXRlcy5zb3J0KChhLCBiKSA9PiBHLm1lbWJlcnNbYi5pZF0uZnJ1c3RyYXRpb24gLSBHLm1lbWJlcnNbYS5pZF0uZnJ1c3RyYXRpb24pOwogICAgICAgICAgICAgICAgbWVtYmVyU3BlYWtzKGNhbmRpZGF0ZXNbMF0pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGZ1bmN0aW9uIG1lbWJlclNwZWFrcyhtZW1iZXIpIHsKICAgICAgICAgICAgY29uc3QgbXMgPSBHLm1lbWJlcnNbbWVtYmVyLmlkXTsKICAgICAgICAgICAgY29uc3QgZmF0aWd1ZSA9IGdldEZhdGlndWVGYWN0b3IoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGxldCBwaHJhc2VzLCBjbHMgPSAnJywgdGVuc2lvbkRlbHRhID0gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1vcmUgbGlrZWx5IHRvIGJlIGFuZ3J5IHdoZW4gZnJ1c3RyYXRlZCBPUiB3aGVuIHJvb20gaXMgdGlyZWQKICAgICAgICAgICAgY29uc3QgYW5nZXJDaGFuY2UgPSAobXMuZnJ1c3RyYXRpb24gPiA0NSA/IDAuNSA6IDApICsgZmF0aWd1ZSAqIDAuMyArIChHLnRlbnNpb24gPiA1NSA/IDAuMiA6IDApOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPCBhbmdlckNoYW5jZSkgewogICAgICAgICAgICAgICAgcGhyYXNlcyA9IFBIUkFTRVMuYW5ncnk7CiAgICAgICAgICAgICAgICBjbHMgPSAnYW5ncnknOwogICAgICAgICAgICAgICAgdGVuc2lvbkRlbHRhID0gMyArIE1hdGguZmxvb3IoZmF0aWd1ZSAqIDMpOwogICAgICAgICAgICAgICAgc2V0TWVtYmVyU3RhdGUobWVtYmVyLmlkLCAnYW5ncnknKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChHLmVuZXJneSA8IDM1ICYmIE1hdGgucmFuZG9tKCkgPCAwLjQpIHsKICAgICAgICAgICAgICAgIHBocmFzZXMgPSBQSFJBU0VTLnRpcmVkOwogICAgICAgICAgICAgICAgdGVuc2lvbkRlbHRhID0gMTsKICAgICAgICAgICAgfSBlbHNlIGlmIChNYXRoLnJhbmRvbSgpIDwgMC4zNSkgewogICAgICAgICAgICAgICAgcGhyYXNlcyA9IFBIUkFTRVMuY29uY2VybjsKICAgICAgICAgICAgICAgIHRlbnNpb25EZWx0YSA9IDI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBwaHJhc2VzID0gUEhSQVNFUy5nb29kOwogICAgICAgICAgICAgICAgY2xzID0gJ2dvb2QnOwogICAgICAgICAgICAgICAgdGVuc2lvbkRlbHRhID0gLTE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHNob3dTcGVlY2gobWVtYmVyLmlkLCBwaHJhc2VzW01hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIHBocmFzZXMubGVuZ3RoKV0sIGNscyk7CiAgICAgICAgICAgIAogICAgICAgICAgICBHLnRlbnNpb24gPSBNYXRoLm1pbigxMDAsIE1hdGgubWF4KDAsIEcudGVuc2lvbiArIHRlbnNpb25EZWx0YSkpOwogICAgICAgICAgICBHLmRpc2N1c3Npb24udm9pY2VzLmFkZChtZW1iZXIuaWQpOwogICAgICAgICAgICBHLmRpc2N1c3Npb24ucG9pbnRzKys7CiAgICAgICAgICAgIG1zLndhbnRzU3BlYWsgPSBmYWxzZTsKICAgICAgICAgICAgbXMubGFzdFNwb2tlID0gMDsKICAgICAgICAgICAgbXMuZnJ1c3RyYXRpb24gPSBNYXRoLm1heCgwLCBtcy5mcnVzdHJhdGlvbiAtIDUpOwogICAgICAgICAgICBHLmxhc3RTcGVha2VyID0gbWVtYmVyLmlkOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGNscyAhPT0gJ2FuZ3J5Jykgc2V0TWVtYmVyU3RhdGUobWVtYmVyLmlkLCAnc3BlYWtpbmcnKTsKICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiBjbGVhck1lbWJlclN0YXRlKG1lbWJlci5pZCksIDkwMCk7CiAgICAgICAgICAgIAogICAgICAgICAgICB1cGRhdGVVSSgpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBmdW5jdGlvbiB0cmlnZ2VyQ29uZmxpY3QobTEsIG0yKSB7CiAgICAgICAgICAgIEcuY29uZmxpY3QgPSBbbTEuaWQsIG0yLmlkXTsKICAgICAgICAgICAgRy5jb25mbGljdENvdW50Kys7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBNb2RlcmF0ZSB0ZW5zaW9uIHNwaWtlCiAgICAgICAgICAgIEcudGVuc2lvbiA9IE1hdGgubWluKDEwMCwgRy50ZW5zaW9uICsgMTIpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRHJhbWF0aWMgZXhjaGFuZ2UKICAgICAgICAgICAgc2hvd1NwZWVjaChtMS5pZCwgUEhSQVNFUy5jb25mbGljdFtNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBQSFJBU0VTLmNvbmZsaWN0Lmxlbmd0aCldLCAnYW5ncnknKTsKICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICBzaG93U3BlZWNoKG0yLmlkLCBQSFJBU0VTLmNvbmZsaWN0W01hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIFBIUkFTRVMuY29uZmxpY3QubGVuZ3RoKV0sICdhbmdyeScpOwogICAgICAgICAgICB9LCAzMDApOwogICAgICAgICAgICAKICAgICAgICAgICAgc2V0TWVtYmVyU3RhdGUobTEuaWQsICdhbmdyeScpOwogICAgICAgICAgICBzZXRNZW1iZXJTdGF0ZShtMi5pZCwgJ2FuZ3J5Jyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBNb2RlcmF0ZSBmcnVzdHJhdGlvbiBpbmNyZWFzZQogICAgICAgICAgICBHLm1lbWJlcnNbbTEuaWRdLmZydXN0cmF0aW9uID0gTWF0aC5taW4oMTAwLCBHLm1lbWJlcnNbbTEuaWRdLmZydXN0cmF0aW9uICsgMTUpOwogICAgICAgICAgICBHLm1lbWJlcnNbbTIuaWRdLmZydXN0cmF0aW9uID0gTWF0aC5taW4oMTAwLCBHLm1lbWJlcnNbbTIuaWRdLmZydXN0cmF0aW9uICsgMTUpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gT3RoZXJzIGdldCBhIGJpdCB1bmNvbWZvcnRhYmxlCiAgICAgICAgICAgIE1FTUJFUlMuZmlsdGVyKG0gPT4gIW0uaXNDRU8gJiYgbS5pZCAhPT0gbTEuaWQgJiYgbS5pZCAhPT0gbTIuaWQpLmZvckVhY2gobSA9PiB7CiAgICAgICAgICAgICAgICBHLm1lbWJlcnNbbS5pZF0uZnJ1c3RyYXRpb24gPSBNYXRoLm1pbigxMDAsIEcubWVtYmVyc1ttLmlkXS5mcnVzdHJhdGlvbiArIDMpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZsYXNoKCdiYWQnKTsKICAgICAgICAgICAgc2hvd1N0YXR1cygn4pqhJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBWaXN1YWwgZmVlZGJhY2sgLSByb29tIGdvZXMgcmVkCiAgICAgICAgICAgIGNvbnN0IHJvb20gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWVldGluZy1yb29tJyk7CiAgICAgICAgICAgIHJvb20uY2xhc3NMaXN0LmFkZCgnY3JpdGljYWwnKTsKICAgICAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLmdhbWUtaGVhZGVyJykuY2xhc3NMaXN0LmFkZCgnZGFuZ2VyJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICBsb2coYOKaoSBDT05GTElDVDogJHttMS5uYW1lfSB2cyAke20yLm5hbWV9IWAsICdiYWQnKTsKICAgICAgICAgICAgdXBkYXRlVUkoKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZnVuY3Rpb24gc2V0TWVtYmVyU3RhdGUoaWQsIHN0YXRlKSB7CiAgICAgICAgICAgIGNvbnN0IGVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoYG0tJHtpZH1gKTsKICAgICAgICAgICAgY29uc3QgZW1vID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoYGVtby0ke2lkfWApOwogICAgICAgICAgICBlbC5jbGFzc0xpc3QucmVtb3ZlKCdzcGVha2luZycsICdhbmdyeScsICdoYXBweScsICdjZW8tbW9kZScsICd0ZW5zZScsICd0aXJlZCcpOwogICAgICAgICAgICBlbC5jbGFzc0xpc3QuYWRkKHN0YXRlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFVwZGF0ZSBlbW90aW9uIGJhZGdlCiAgICAgICAgICAgIGlmIChlbW8pIHsKICAgICAgICAgICAgICAgIGVtby5jbGFzc0xpc3QuYWRkKCdzaG93Jyk7CiAgICAgICAgICAgICAgICBpZiAoc3RhdGUgPT09ICdhbmdyeScpIHsKICAgICAgICAgICAgICAgICAgICBlbW8udGV4dENvbnRlbnQgPSAn8J+YoCc7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXRlID09PSAndGVuc2UnKSB7CiAgICAgICAgICAgICAgICAgICAgZW1vLnRleHRDb250ZW50ID0gJ/CfmKwnOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdGF0ZSA9PT0gJ2hhcHB5JykgewogICAgICAgICAgICAgICAgICAgIGVtby50ZXh0Q29udGVudCA9ICfwn5iKJzsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhdGUgPT09ICdzcGVha2luZycpIHsKICAgICAgICAgICAgICAgICAgICBlbW8udGV4dENvbnRlbnQgPSAn8J+SrCc7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXRlID09PSAnY2VvLW1vZGUnKSB7CiAgICAgICAgICAgICAgICAgICAgZW1vLnRleHRDb250ZW50ID0gJ/CfkZQnOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdGF0ZSA9PT0gJ3RpcmVkJykgewogICAgICAgICAgICAgICAgICAgIGVtby50ZXh0Q29udGVudCA9ICfwn5i0JzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICBmdW5jdGlvbiBjbGVhck1lbWJlclN0YXRlKGlkKSB7CiAgICAgICAgICAgIGNvbnN0IGVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoYG0tJHtpZH1gKTsKICAgICAgICAgICAgY29uc3QgZW1vID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoYGVtby0ke2lkfWApOwogICAgICAgICAgICBpZiAoZWwpIGVsLmNsYXNzTGlzdC5yZW1vdmUoJ3NwZWFraW5nJywgJ2FuZ3J5JywgJ2hhcHB5JywgJ2Nlby1tb2RlJywgJ3RlbnNlJywgJ3RpcmVkJyk7CiAgICAgICAgICAgIGlmIChlbW8pIHsKICAgICAgICAgICAgICAgIGVtby5jbGFzc0xpc3QucmVtb3ZlKCdzaG93Jyk7CiAgICAgICAgICAgICAgICBlbW8udGV4dENvbnRlbnQgPSAnJzsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICBmdW5jdGlvbiBzaG93U3BlZWNoKGlkLCB0ZXh0LCBjbHMgPSAnJykgewogICAgICAgICAgICBjb25zdCBidWIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChgYnViLSR7aWR9YCk7CiAgICAgICAgICAgIGNvbnN0IGVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoYG0tJHtpZH1gKTsKICAgICAgICAgICAgaWYgKCFidWIgfHwgIWVsKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCByb29tID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21lZXRpbmctcm9vbScpLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgICAgICAgICBjb25zdCBtZW0gPSBlbC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGxldCBsZWZ0ID0gbWVtLmxlZnQgLSByb29tLmxlZnQgKyAyMDsKICAgICAgICAgICAgbGV0IHRvcCA9IG1lbS50b3AgLSByb29tLnRvcCAtIDUwOwogICAgICAgICAgICBsZWZ0ID0gTWF0aC5tYXgoMTAsIE1hdGgubWluKGxlZnQsIHJvb20ud2lkdGggLSAxNzApKTsKICAgICAgICAgICAgdG9wID0gTWF0aC5tYXgoMTAsIHRvcCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBidWIuc3R5bGUubGVmdCA9IGxlZnQgKyAncHgnOwogICAgICAgICAgICBidWIuc3R5bGUudG9wID0gdG9wICsgJ3B4JzsKICAgICAgICAgICAgYnViLnRleHRDb250ZW50ID0gdGV4dDsKICAgICAgICAgICAgYnViLmNsYXNzTmFtZSA9ICdzcGVlY2gtYnViYmxlIHZpc2libGUgJyArIGNsczsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFVwZGF0ZSBjdXJyZW50IHNwZWFrZXIgZGlzcGxheQogICAgICAgICAgICBjb25zdCBzcGVha2VyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2N1cnJlbnQtc3BlYWtlcicpOwogICAgICAgICAgICBpZiAoc3BlYWtlcikgewogICAgICAgICAgICAgICAgY29uc3QgbWVtYmVyID0gTUVNQkVSUy5maW5kKG0gPT4gbS5pZCA9PT0gaWQpOwogICAgICAgICAgICAgICAgY29uc3Qgcm9sZUljb24gPSBtZW1iZXIuaXNDRU8gPyAn8J+RlCcgOiAKICAgICAgICAgICAgICAgICAgICBtZW1iZXIuaWQgPT09ICd0ZWNoJyA/ICfwn5SsJyA6IAogICAgICAgICAgICAgICAgICAgIG1lbWJlci5pZCA9PT0gJ2ZpbmFuY2UnID8gJ/CfkrAnIDogCiAgICAgICAgICAgICAgICAgICAgbWVtYmVyLmlkID09PSAnbWt0JyA/ICfwn5OiJyA6ICfimpnvuI8nOwogICAgICAgICAgICAgICAgc3BlYWtlci5xdWVyeVNlbGVjdG9yKCcuc3BlYWtlci1pY29uJykudGV4dENvbnRlbnQgPSByb2xlSWNvbjsKICAgICAgICAgICAgICAgIHNwZWFrZXIucXVlcnlTZWxlY3RvcignLnNwZWFrZXItdGV4dCcpLnRleHRDb250ZW50ID0gYCR7bWVtYmVyLm5hbWV9OiAiJHt0ZXh0fSJgOwogICAgICAgICAgICAgICAgc3BlYWtlci5jbGFzc05hbWUgPSAnY3VycmVudC1zcGVha2VyIHNob3cgJyArIGNsczsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHNwZWFrZXIuaGlkZVRpbWVvdXQpOwogICAgICAgICAgICAgICAgc3BlYWtlci5oaWRlVGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4gc3BlYWtlci5jbGFzc0xpc3QucmVtb3ZlKCdzaG93JyksIDI1MDApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IGJ1Yi5jbGFzc0xpc3QucmVtb3ZlKCd2aXNpYmxlJyksIDIwMDApOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBmdW5jdGlvbiBzaG93U3RhdHVzKGVtb2ppKSB7CiAgICAgICAgICAgIGNvbnN0IGVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Jvb20tc3RhdHVzJyk7CiAgICAgICAgICAgIGVsLnRleHRDb250ZW50ID0gZW1vamk7CiAgICAgICAgICAgIGVsLmNsYXNzTGlzdC5hZGQoJ3Nob3cnKTsKICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiBlbC5jbGFzc0xpc3QucmVtb3ZlKCdzaG93JyksIDQwMCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGZ1bmN0aW9uIHNob3dGbG9hdChlbW9qaSkgewogICAgICAgICAgICBjb25zdCBlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICBlbC5jbGFzc05hbWUgPSAnZmxvYXQtZWZmZWN0JzsKICAgICAgICAgICAgZWwudGV4dENvbnRlbnQgPSBlbW9qaTsKICAgICAgICAgICAgZWwuc3R5bGUubGVmdCA9ICcyMDBweCc7CiAgICAgICAgICAgIGVsLnN0eWxlLnRvcCA9ICcyMDBweCc7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtZWV0aW5nLXJvb20nKS5hcHBlbmRDaGlsZChlbCk7CiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gZWwucmVtb3ZlKCksIDUwMCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGZ1bmN0aW9uIGZsYXNoKHR5cGUpIHsKICAgICAgICAgICAgY29uc3QgZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChgZmxhc2gtJHt0eXBlfWApOwogICAgICAgICAgICBlbC5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiBlbC5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKSwgMTYwKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZnVuY3Rpb24gZG9BY3Rpb24oYWN0aW9uKSB7CiAgICAgICAgICAgIGlmICghRy5ydW5uaW5nIHx8IEcuY29vbGRvd25zW2FjdGlvbl0pIHJldHVybjsKICAgICAgICAgICAgaWYgKFsnam9rZScsICdicmVhaycsICdjZW8nXS5pbmNsdWRlcyhhY3Rpb24pICYmIEcudXNlc1thY3Rpb25dIDw9IDApIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGxldCBjZCA9IDQsIHN1Y2Nlc3MgPSB0cnVlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIGVmZmVjdGl2ZW5lc3MgYmFzZWQgb24gZW5lcmd5ICg3MC0xMDAlIGVmZmVjdGl2ZW5lc3MpCiAgICAgICAgICAgIGNvbnN0IGVmZmVjdGl2ZW5lc3MgPSAwLjcgKyAoRy5lbmVyZ3kgLyAxMDApICogMC4zOwogICAgICAgICAgICBjb25zdCBpc0xvd0VuZXJneSA9IEcuZW5lcmd5IDwgNDA7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBY3Rpb25zIGNvc3QgZW5lcmd5IChleGNlcHQgYnJlYWsgd2hpY2ggcmVzdG9yZXMgaXQpCiAgICAgICAgICAgIGNvbnN0IGVuZXJneUNvc3RzID0geyBhY2s6IDIsIGludml0ZTogMywgZGVmdXNlOiA0LCBqb2tlOiAzLCBjZW86IDUgfTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHN3aXRjaChhY3Rpb24pIHsKICAgICAgICAgICAgICAgIGNhc2UgJ2Fjayc6CiAgICAgICAgICAgICAgICAgICAgaWYgKCFHLmxhc3RTcGVha2VyIHx8IEcubWVtYmVyc1tHLmxhc3RTcGVha2VyXS5sYXN0U3Bva2UgPiAzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZyhgTm8gcmVjZW50IHNwZWFrZXJgLCAnd2FybicpOwogICAgICAgICAgICAgICAgICAgICAgICBzdWNjZXNzID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGVha2VyID0gRy5sYXN0U3BlYWtlcjsKICAgICAgICAgICAgICAgICAgICBjb25zdCBhY2tQb3dlciA9IE1hdGgucm91bmQoMTIgKiBlZmZlY3RpdmVuZXNzKTsKICAgICAgICAgICAgICAgICAgICBHLm1lbWJlcnNbc3BlYWtlcl0uZnJ1c3RyYXRpb24gPSBNYXRoLm1heCgwLCBHLm1lbWJlcnNbc3BlYWtlcl0uZnJ1c3RyYXRpb24gLSBhY2tQb3dlcik7CiAgICAgICAgICAgICAgICAgICAgRy50ZW5zaW9uID0gTWF0aC5tYXgoMCwgRy50ZW5zaW9uIC0gTWF0aC5yb3VuZCg0ICogZWZmZWN0aXZlbmVzcykpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHNob3dTcGVlY2goc3BlYWtlciwgIlRoYW5rcy4iLCAnZ29vZCcpOwogICAgICAgICAgICAgICAgICAgIHNldE1lbWJlclN0YXRlKHNwZWFrZXIsICdoYXBweScpOwogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gY2xlYXJNZW1iZXJTdGF0ZShzcGVha2VyKSwgODAwKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBzaG93RmxvYXQoJ/CfkY8nKTsKICAgICAgICAgICAgICAgICAgICBmbGFzaCgnZ29vZCcpOwogICAgICAgICAgICAgICAgICAgIGxvZyhg8J+RjyBBY2tub3dsZWRnZWQgJHtNRU1CRVJTLmZpbmQobSA9PiBtLmlkID09PSBzcGVha2VyKS5uYW1lfSR7aXNMb3dFbmVyZ3kgPyAnICh0aXJlZCknIDogJyd9YCwgJ2dvb2QnKTsKICAgICAgICAgICAgICAgICAgICBjZCA9IDM7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjYXNlICdpbnZpdGUnOgogICAgICAgICAgICAgICAgICAgIC8vIEZpbmQgcGVvcGxlIHdobyBoYXZlbid0IHNwb2tlbiB5ZXQsIHByaW9yaXRpemluZyBxdWlldCBwZXJzb25hbGl0aWVzCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgbm90U3Bva2VuID0gTUVNQkVSUy5maWx0ZXIobSA9PiAhbS5pc0NFTyAmJiAhRy5kaXNjdXNzaW9uLnZvaWNlcy5oYXMobS5pZCkpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHdhaXRpbmcgPSBNRU1CRVJTLmZpbHRlcihtID0+ICFtLmlzQ0VPICYmIEcubWVtYmVyc1ttLmlkXS53YW50c1NwZWFrKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBDb21iaW5lIGFuZCBwcmlvcml0aXplOiBxdWlldCBwZW9wbGUgd2hvIGhhdmVuJ3Qgc3Bva2VuID4gYW55b25lIHdobyBoYXNuJ3Qgc3Bva2VuID4gYW55b25lIHdhaXRpbmcKICAgICAgICAgICAgICAgICAgICBsZXQgdGFyZ2V0cyA9IG5vdFNwb2tlbi5sZW5ndGggPiAwID8gbm90U3Bva2VuIDogd2FpdGluZzsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAodGFyZ2V0cy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgbG9nKGBFdmVyeW9uZSBoYXMgc3Bva2VuIGFscmVhZHlgLCAnd2FybicpOwogICAgICAgICAgICAgICAgICAgICAgICBzdWNjZXNzID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBTb3J0IGJ5OiBsZWFzdCBhc3NlcnRpdmUgZmlyc3QgKHRoZXkgbmVlZCB0aGUgaW52aXRlIG1vc3QpCiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0cy5zb3J0KChhLCBiKSA9PiAoYS5hc3NlcnRpdmUgfHwgMC41KSAtIChiLmFzc2VydGl2ZSB8fCAwLjUpKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXQgPSB0YXJnZXRzWzBdOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGNvbnN0IGludml0ZVBvd2VyID0gTWF0aC5yb3VuZCgxMiAqIGVmZmVjdGl2ZW5lc3MpOwogICAgICAgICAgICAgICAgICAgIEcubWVtYmVyc1t0YXJnZXQuaWRdLmZydXN0cmF0aW9uID0gTWF0aC5tYXgoMCwgRy5tZW1iZXJzW3RhcmdldC5pZF0uZnJ1c3RyYXRpb24gLSBpbnZpdGVQb3dlcik7CiAgICAgICAgICAgICAgICAgICAgRy5tZW1iZXJzW3RhcmdldC5pZF0ud2FudHNTcGVhayA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gVGhleSBzcGVhayBpbW1lZGlhdGVseSB3aGVuIGludml0ZWQKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IG1lbWJlclNwZWFrcyh0YXJnZXQpLCAyMDApOwogICAgICAgICAgICAgICAgICAgIHNob3dGbG9hdCgn8J+Xo++4jycpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHF1aWV0Tm90ZSA9ICh0YXJnZXQuYXNzZXJ0aXZlIHx8IDAuNSkgPCAwLjUgPyAnICh0aGV5IG5lZWRlZCB0aGF0ISknIDogJyc7CiAgICAgICAgICAgICAgICAgICAgbG9nKGDwn5ej77iPIEludml0ZWQgJHt0YXJnZXQubmFtZX0ke3F1aWV0Tm90ZX0ke2lzTG93RW5lcmd5ID8gJyAtIHJvb20gdGlyZWQnIDogJyd9YCwgJ2dvb2QnKTsKICAgICAgICAgICAgICAgICAgICBjZCA9IDM7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjYXNlICdkZWZ1c2UnOgogICAgICAgICAgICAgICAgICAgIGlmIChHLmNvbmZsaWN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IFtpZDEsIGlkMl0gPSBHLmNvbmZsaWN0OwogICAgICAgICAgICAgICAgICAgICAgICBjbGVhck1lbWJlclN0YXRlKGlkMSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyTWVtYmVyU3RhdGUoaWQyKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZGVmdXNlUG93ZXIgPSBNYXRoLnJvdW5kKDE1ICogZWZmZWN0aXZlbmVzcyk7CiAgICAgICAgICAgICAgICAgICAgICAgIEcubWVtYmVyc1tpZDFdLmZydXN0cmF0aW9uID0gTWF0aC5tYXgoMCwgRy5tZW1iZXJzW2lkMV0uZnJ1c3RyYXRpb24gLSBkZWZ1c2VQb3dlcik7CiAgICAgICAgICAgICAgICAgICAgICAgIEcubWVtYmVyc1tpZDJdLmZydXN0cmF0aW9uID0gTWF0aC5tYXgoMCwgRy5tZW1iZXJzW2lkMl0uZnJ1c3RyYXRpb24gLSBkZWZ1c2VQb3dlcik7CiAgICAgICAgICAgICAgICAgICAgICAgIEcudGVuc2lvbiA9IE1hdGgubWF4KDAsIEcudGVuc2lvbiAtIE1hdGgucm91bmQoMTIgKiBlZmZlY3RpdmVuZXNzKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIEcuY29uZmxpY3QgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ2xlYXIgdmlzdWFsIGNyaXNpcwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByb29tID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21lZXRpbmctcm9vbScpOwogICAgICAgICAgICAgICAgICAgICAgICByb29tLmNsYXNzTGlzdC5yZW1vdmUoJ2NyaXRpY2FsJywgJ3RlbnNlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJvb20uc3R5bGUuYmFja2dyb3VuZCA9ICcnOwogICAgICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcuZ2FtZS1oZWFkZXInKS5jbGFzc0xpc3QucmVtb3ZlKCdkYW5nZXInKTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIHNob3dGbG9hdCgn8J+Viu+4jycpOwogICAgICAgICAgICAgICAgICAgICAgICBmbGFzaCgnZ29vZCcpOwogICAgICAgICAgICAgICAgICAgICAgICBzaG93U3RhdHVzKCfwn5iMJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZyhg8J+Viu+4jyBDb25mbGljdCByZXNvbHZlZCEke2lzTG93RW5lcmd5ID8gJyAoaGFyZGVyIHdoZW4gdGlyZWQpJyA6ICcnfWAsICdnb29kJyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ2hlY2sgaWYgd2UncmUgcHJldmVudGluZyBhbiB1cGNvbWluZyBjb25mbGljdAogICAgICAgICAgICAgICAgICAgICAgICBsZXQgcHJldmVudGVkQ29uZmxpY3QgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgRy5ndWFyYW50ZWVkQ29uZmxpY3RzLmZvckVhY2goZ2MgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFnYy50cmlnZ2VyZWQgJiYgKGdjLndhcm5lZCB8fCBnYy5maW5hbFdhcm4pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRGVmdXNpbmcgZHVyaW5nIGJ1aWxkdXAgcHJldmVudHMgdGhlIGNvbmZsaWN0IQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdjLnRyaWdnZXJlZCA9IHRydWU7IC8vIE1hcmsgYXMgaGFuZGxlZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdjLnByZXZlbnRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJNZW1iZXJTdGF0ZShnYy5wYWlyWzBdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGVhck1lbWJlclN0YXRlKGdjLnBhaXJbMV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEcubWVtYmVyc1tnYy5wYWlyWzBdXS5mcnVzdHJhdGlvbiA9IE1hdGgubWF4KDAsIEcubWVtYmVyc1tnYy5wYWlyWzBdXS5mcnVzdHJhdGlvbiAtIDEyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBHLm1lbWJlcnNbZ2MucGFpclsxXV0uZnJ1c3RyYXRpb24gPSBNYXRoLm1heCgwLCBHLm1lbWJlcnNbZ2MucGFpclsxXV0uZnJ1c3RyYXRpb24gLSAxMik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJldmVudGVkQ29uZmxpY3QgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG0xID0gTUVNQkVSUy5maW5kKG0gPT4gbS5pZCA9PT0gZ2MucGFpclswXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbTIgPSBNRU1CRVJTLmZpbmQobSA9PiBtLmlkID09PSBnYy5wYWlyWzFdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2coYPCflYrvuI8gQ3Jpc2lzIGF2ZXJ0ZWQhICR7bTEubmFtZX0gYW5kICR7bTIubmFtZX0gY2FsbWVkIGRvd24uYCwgJ2dvb2QnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpZiAocHJldmVudGVkQ29uZmxpY3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIEcudGVuc2lvbiA9IE1hdGgubWF4KDAsIEcudGVuc2lvbiAtIDEwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNob3dGbG9hdCgn8J+Viu+4jycpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmxhc2goJ2dvb2QnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNob3dTdGF0dXMoJ/CfmIwnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChHLnRlbnNpb24gPiAzMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgRy50ZW5zaW9uID0gTWF0aC5tYXgoMCwgRy50ZW5zaW9uIC0gTWF0aC5yb3VuZCgxMiAqIGVmZmVjdGl2ZW5lc3MpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIE1FTUJFUlMuZm9yRWFjaChtID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW0uaXNDRU8pIEcubWVtYmVyc1ttLmlkXS5mcnVzdHJhdGlvbiA9IE1hdGgubWF4KDAsIEcubWVtYmVyc1ttLmlkXS5mcnVzdHJhdGlvbiAtIDUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbGFzaCgnZ29vZCcpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nKGDwn5WK77iPIENhbG1lZCB0aGUgcm9vbWAsICdnb29kJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2coYFJvb20gY2FsbSBlbm91Z2hgLCAnd2FybicpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3VjY2VzcyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNkID0gNDsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNhc2UgJ2pva2UnOgogICAgICAgICAgICAgICAgICAgIEcudXNlcy5qb2tlLS07CiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Utam9rZScpLnRleHRDb250ZW50ID0gRy51c2VzLmpva2U7CiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2xpbS1qb2tlJykudGV4dENvbnRlbnQgPSBHLnVzZXMuam9rZTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBjb25zdCBmYXRpZ3VlID0gZ2V0RmF0aWd1ZUZhY3RvcigpOwogICAgICAgICAgICAgICAgICAgIC8vIEpva2VzIGFyZSBsZXNzIHJpc2t5IGFuZCBtb3JlIGVmZmVjdGl2ZSB3aGVuIHBlb3BsZSBhcmUgdGlyZWQKICAgICAgICAgICAgICAgICAgICBjb25zdCBqb2tlUmlzayA9IDAuMDggLSBmYXRpZ3VlICogMC4wNDsgLy8gVmVyeSBsb3cgcmlzawogICAgICAgICAgICAgICAgICAgIGNvbnN0IGpva2VQb3dlciA9IE1hdGgucm91bmQoKDEwICsgZmF0aWd1ZSAqIDgpICogZWZmZWN0aXZlbmVzcyk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgc2hvd1NwZWVjaCgnY2VvJywgUEhSQVNFUy5qb2tlc1tNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBQSFJBU0VTLmpva2VzLmxlbmd0aCldLCAnZ29vZCcpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpIDwgam9rZVJpc2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgRy50ZW5zaW9uID0gTWF0aC5taW4oMTAwLCBHLnRlbnNpb24gKyA0KTsKICAgICAgICAgICAgICAgICAgICAgICAgc2hvd1N0YXR1cygn8J+YrCcpOwogICAgICAgICAgICAgICAgICAgICAgICBmbGFzaCgnYmFkJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZyhg8J+YrCBKb2tlIGZlbGwgZmxhdGAsICd3YXJuJyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgRy50ZW5zaW9uID0gTWF0aC5tYXgoMCwgRy50ZW5zaW9uIC0gam9rZVBvd2VyKTsKICAgICAgICAgICAgICAgICAgICAgICAgRy5lbmVyZ3kgPSBNYXRoLm1pbigxMDAsIEcuZW5lcmd5ICsgOCArIGZhdGlndWUgKiA2KTsgLy8gSm9rZXMgcmVzdG9yZSBzb21lIGVuZXJneSEKICAgICAgICAgICAgICAgICAgICAgICAgTUVNQkVSUy5mb3JFYWNoKG0gPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFtLmlzQ0VPKSBHLm1lbWJlcnNbbS5pZF0uZnJ1c3RyYXRpb24gPSBNYXRoLm1heCgwLCBHLm1lbWJlcnNbbS5pZF0uZnJ1c3RyYXRpb24gLSA1IC0gZmF0aWd1ZSAqIDMpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgc2hvd0Zsb2F0KCfwn5iCJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZsYXNoKCdnb29kJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHNob3dTdGF0dXMoJ/CfmIQnKTsKICAgICAgICAgICAgICAgICAgICAgICAgbG9nKGDwn5iCIEdyZWF0IGxhdWdoISR7ZmF0aWd1ZSA+IDAuNSA/ICcgTXVjaCBuZWVkZWQhJyA6ICcnfSArRW5lcmd5YCwgJ2dvb2QnKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKEcudXNlcy5qb2tlIDw9IDApIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdidG4tam9rZScpLmRpc2FibGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBjZCA9IDY7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjYXNlICdicmVhayc6CiAgICAgICAgICAgICAgICAgICAgRy51c2VzLmJyZWFrLS07CiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3UtYnJlYWsnKS50ZXh0Q29udGVudCA9IEcudXNlcy5icmVhazsKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbGltLWJyZWFrJykudGV4dENvbnRlbnQgPSBHLnVzZXMuYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgYnJlYWtGYXRpZ3VlID0gZ2V0RmF0aWd1ZUZhY3RvcigpOwogICAgICAgICAgICAgICAgICAgIC8vIEJyZWFrcyBhcmUgTVVDSCBNT1JFIGVmZmVjdGl2ZSB3aGVuIHBlb3BsZSBhcmUgdGlyZWQhCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZW5lcmd5UmVzdG9yZSA9IDMwICsgYnJlYWtGYXRpZ3VlICogMjU7IC8vIFVwIHRvIDU1IGVuZXJneSEKICAgICAgICAgICAgICAgICAgICBjb25zdCB0ZW5zaW9uUmVsaWVmID0gMTAgKyBicmVha0ZhdGlndWUgKiAxMjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBHLnRpbWUgPSBNYXRoLm1heCgwLCBHLnRpbWUgLSA4KTsKICAgICAgICAgICAgICAgICAgICBHLmVuZXJneSA9IE1hdGgubWluKDEwMCwgRy5lbmVyZ3kgKyBlbmVyZ3lSZXN0b3JlKTsKICAgICAgICAgICAgICAgICAgICBHLnRlbnNpb24gPSBNYXRoLm1heCgwLCBHLnRlbnNpb24gLSB0ZW5zaW9uUmVsaWVmKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBbJ2FjaycsICdpbnZpdGUnLCAnZGVmdXNlJ10uZm9yRWFjaChhID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgRy5jb29sZG93bnNbYV0gPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoYGJ0bi0ke2F9YCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJ0bi5kaXNhYmxlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LnJlbW92ZSgnY29vbGRvd24nKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBNRU1CRVJTLmZvckVhY2gobSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIEcubWVtYmVyc1ttLmlkXS5mcnVzdHJhdGlvbiA9IE1hdGgubWF4KDAsIEcubWVtYmVyc1ttLmlkXS5mcnVzdHJhdGlvbiAtIDggLSBicmVha0ZhdGlndWUgKiA1KTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBzaG93RmxvYXQoJ+KYlScpOwogICAgICAgICAgICAgICAgICAgIGZsYXNoKCdnb29kJyk7CiAgICAgICAgICAgICAgICAgICAgc2hvd1N0YXR1cygn4pqhJyk7CiAgICAgICAgICAgICAgICAgICAgbG9nKGDimJUgQnJlYWshICske01hdGgucm91bmQoZW5lcmd5UmVzdG9yZSl9IGVuZXJneSwgY29vbGRvd25zIHJlc2V0YCwgJ2dvb2QnKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYnRuLWJyZWFrJykuZGlzYWJsZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGNkID0gOTk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjYXNlICdjZW8nOgogICAgICAgICAgICAgICAgICAgIGlmICghRy5jb25mbGljdCAmJiBHLnRlbnNpb24gPCA1MCkgewogICAgICAgICAgICAgICAgICAgICAgICBsb2coYPCfkZQgU2F2ZSBDRU8gZm9yIHJlYWwgY3Jpc2lzYCwgJ3dhcm4nKTsKICAgICAgICAgICAgICAgICAgICAgICAgc3VjY2VzcyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgRy51c2VzLmNlby0tOwogICAgICAgICAgICAgICAgICAgIEcuY2VvVXNlZCsrOwogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1LWNlbycpLnRleHRDb250ZW50ID0gRy51c2VzLmNlbzsKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbGltLWNlbycpLnRleHRDb250ZW50ID0gRy51c2VzLmNlbzsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBjb25zdCBjZW9GYXRpZ3VlID0gZ2V0RmF0aWd1ZUZhY3RvcigpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHNldE1lbWJlclN0YXRlKCdjZW8nLCAnY2VvLW1vZGUnKTsKICAgICAgICAgICAgICAgICAgICBzaG93U3BlZWNoKCdjZW8nLCBQSFJBU0VTLmNlb1tNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBQSFJBU0VTLmNlby5sZW5ndGgpXSwgJ2NlbycpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmIChHLmNvbmZsaWN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IFtpZDEsIGlkMl0gPSBHLmNvbmZsaWN0OwogICAgICAgICAgICAgICAgICAgICAgICBjbGVhck1lbWJlclN0YXRlKGlkMSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyTWVtYmVyU3RhdGUoaWQyKTsKICAgICAgICAgICAgICAgICAgICAgICAgRy5jb25mbGljdCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBDbGVhciB2aXN1YWwgY3Jpc2lzCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJvb20gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWVldGluZy1yb29tJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJvb20uY2xhc3NMaXN0LnJlbW92ZSgnY3JpdGljYWwnLCAndGVuc2UnKTsKICAgICAgICAgICAgICAgICAgICAgICAgcm9vbS5zdHlsZS5iYWNrZ3JvdW5kID0gJyc7CiAgICAgICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5nYW1lLWhlYWRlcicpLmNsYXNzTGlzdC5yZW1vdmUoJ2RhbmdlcicpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBDRU8gaXMgbW9yZSBpbXBhY3RmdWwgbGF0ZSBnYW1lIHdoZW4gYXV0aG9yaXR5IGlzIG5lZWRlZAogICAgICAgICAgICAgICAgICAgIEcudGVuc2lvbiA9IE1hdGgubWF4KDAsIEcudGVuc2lvbiAtIDIwIC0gY2VvRmF0aWd1ZSAqIDEwKTsKICAgICAgICAgICAgICAgICAgICBHLmRpc2N1c3Npb24ucG9pbnRzICs9IDM7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQnV0IGFsc28gbW9yZSBkZW1vcmFsaXppbmcgd2hlbiBwZW9wbGUgYXJlIHRpcmVkCiAgICAgICAgICAgICAgICAgICAgTUVNQkVSUy5mb3JFYWNoKG0gPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW0uaXNDRU8pIEcubWVtYmVyc1ttLmlkXS5mcnVzdHJhdGlvbiA9IE1hdGgubWluKDEwMCwgRy5tZW1iZXJzW20uaWRdLmZydXN0cmF0aW9uICsgNSArIGNlb0ZhdGlndWUgKiA1KTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBmbGFzaCgnY2VvJyk7CiAgICAgICAgICAgICAgICAgICAgc2hvd1N0YXR1cygn8J+RlCcpOwogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gY2xlYXJNZW1iZXJTdGF0ZSgnY2VvJyksIDEwMDApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGxvZyhg8J+RlCBDRU8gaW50ZXJ2ZW5lcyEgQ3Jpc2lzIGF2ZXJ0ZWQuYCwgJ2NlbycpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdidG4tY2VvJykuZGlzYWJsZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGNkID0gOTk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChzdWNjZXNzICYmIGNkIDwgOTkpIHsKICAgICAgICAgICAgICAgIC8vIERlZHVjdCBlbmVyZ3kgY29zdCAoZXhjZXB0IGZvciBicmVhayB3aGljaCByZXN0b3JlcyBlbmVyZ3kpCiAgICAgICAgICAgICAgICBpZiAoYWN0aW9uICE9PSAnYnJlYWsnICYmIGVuZXJneUNvc3RzW2FjdGlvbl0pIHsKICAgICAgICAgICAgICAgICAgICBHLmVuZXJneSA9IE1hdGgubWF4KDAsIEcuZW5lcmd5IC0gZW5lcmd5Q29zdHNbYWN0aW9uXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIEcuY29vbGRvd25zW2FjdGlvbl0gPSB0cnVlOwogICAgICAgICAgICAgICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoYGJ0bi0ke2FjdGlvbn1gKTsKICAgICAgICAgICAgICAgIGJ0bi5kaXNhYmxlZCA9IHRydWU7CiAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LmFkZCgnY29vbGRvd24nKTsKICAgICAgICAgICAgICAgIGJ0bi5zdHlsZS5zZXRQcm9wZXJ0eSgnLS1jZCcsIGNkICsgJ3MnKTsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIEcuY29vbGRvd25zW2FjdGlvbl0gPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBidG4uZGlzYWJsZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LnJlbW92ZSgnY29vbGRvd24nKTsKICAgICAgICAgICAgICAgIH0sIGNkICogMTAwMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHVwZGF0ZVVJKCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGZ1bmN0aW9uIGdldFF1YWxpdHkoKSB7CiAgICAgICAgICAgIGNvbnN0IHZvaWNlcyA9IEcuZGlzY3Vzc2lvbi52b2ljZXMuc2l6ZTsKICAgICAgICAgICAgY29uc3QgcG9pbnRzID0gRy5kaXNjdXNzaW9uLnBvaW50czsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFF1YWxpdHkgaXMgZGVwZW5kZW50IG9uIHZvaWNlcyBidXQgbm90IGFzIGhhcnNobHkKICAgICAgICAgICAgbGV0IHEgPSAyMCArIHZvaWNlcyAqIDE0OyAvLyAyMCwgMzQsIDQ4LCA2MiwgNzYgYmFzZQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQm9udXMgZm9yIGV4dHJhIGRpc2N1c3Npb24gcG9pbnRzCiAgICAgICAgICAgIHEgKz0gTWF0aC5taW4ocG9pbnRzICogMiwgOCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBUZW5zaW9uIHBlbmFsdHkgKHJlZHVjZWQpCiAgICAgICAgICAgIHEgLT0gRy50ZW5zaW9uICogMC4yOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQWN0aXZlIGNvbmZsaWN0IHBlbmFsdHkgKHJlZHVjZWQpCiAgICAgICAgICAgIGlmIChHLmNvbmZsaWN0KSB7CiAgICAgICAgICAgICAgICBxIC09IDEwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBFbmVyZ3kgYWZmZWN0cyBxdWFsaXR5IC0gdGlyZWQgZGVjaXNpb25zIGFyZSB3b3JzZQogICAgICAgICAgICBpZiAoRy5lbmVyZ3kgPCAzMCkgewogICAgICAgICAgICAgICAgcSAtPSA4OyAvLyBFeGhhdXN0ZWQgcGVuYWx0eQogICAgICAgICAgICB9IGVsc2UgaWYgKEcuZW5lcmd5IDwgNTApIHsKICAgICAgICAgICAgICAgIHEgLT0gNDsgLy8gVGlyZWQgcGVuYWx0eQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDRU8gcGVuYWx0eQogICAgICAgICAgICBxIC09IEcuY2VvVXNlZCAqIDg7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBNaWxkIHJ1c2hpbmcgcGVuYWx0eQogICAgICAgICAgICBpZiAodm9pY2VzIDwgMikgewogICAgICAgICAgICAgICAgcSAtPSAxMDsKICAgICAgICAgICAgfSBlbHNlIGlmICh2b2ljZXMgPCAzKSB7CiAgICAgICAgICAgICAgICBxIC09IDU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiBNYXRoLm1heCgxNSwgTWF0aC5taW4oMTAwLCBNYXRoLnJvdW5kKHEpKSk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGZ1bmN0aW9uIG1ha2VEZWNpc2lvbihkZWNpc2lvbikgewogICAgICAgICAgICBpZiAoIUcucnVubmluZykgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3Qgdm9pY2VzID0gRy5kaXNjdXNzaW9uLnZvaWNlcy5zaXplOwogICAgICAgICAgICBjb25zdCBxdWFsaXR5ID0gZ2V0UXVhbGl0eSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gV2FybiBpZiBydXNoaW5nIHdpdGggZmV3IHZvaWNlcwogICAgICAgICAgICBpZiAodm9pY2VzIDwgMiAmJiAhRy5ydXNoV2FybmVkKSB7CiAgICAgICAgICAgICAgICBHLnJ1c2hXYXJuZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgZmxhc2goJ2JhZCcpOwogICAgICAgICAgICAgICAgc2hvd1N0YXR1cygn4pqg77iPJyk7CiAgICAgICAgICAgICAgICBsb2coYOKaoO+4jyBPbmx5ICR7dm9pY2VzfSB2b2ljZSBoZWFyZCEgUXVhbGl0eSB3aWxsIHN1ZmZlci5gLCAnYmFkJyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNoYWtlIHRoZSBxdWFsaXR5IGRpc3BsYXkgdG8gZHJhdyBhdHRlbnRpb24KICAgICAgICAgICAgICAgIGNvbnN0IHFEaXNwbGF5ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLnF1YWxpdHktZGlzcGxheScpOwogICAgICAgICAgICAgICAgcURpc3BsYXkuc3R5bGUuYW5pbWF0aW9uID0gJ3NoYWtlIDAuM3MgZWFzZSc7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHFEaXNwbGF5LnN0eWxlLmFuaW1hdGlvbiA9ICcnLCAzMDApOwogICAgICAgICAgICAgICAgcmV0dXJuOyAvLyBGaXJzdCBjbGljayBqdXN0IHdhcm5zCiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlc2V0IHJ1c2ggd2FybmluZyBmb3IgbmV4dCBkZWNpc2lvbgogICAgICAgICAgICBHLnJ1c2hXYXJuZWQgPSBmYWxzZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh2b2ljZXMgPCAyKSB7CiAgICAgICAgICAgICAgICAvLyBQZW5hbHR5IGZvciBleGNsdWRpbmcgcGVvcGxlLCBidXQgbm90IHRvbyBoYXJzaAogICAgICAgICAgICAgICAgTUVNQkVSUy5maWx0ZXIobSA9PiAhRy5kaXNjdXNzaW9uLnZvaWNlcy5oYXMobS5pZCkgJiYgIW0uaXNDRU8pLmZvckVhY2gobSA9PiB7CiAgICAgICAgICAgICAgICAgICAgRy5tZW1iZXJzW20uaWRdLmZydXN0cmF0aW9uID0gTWF0aC5taW4oMTAwLCBHLm1lbWJlcnNbbS5pZF0uZnJ1c3RyYXRpb24gKyAxMik7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIEcudGVuc2lvbiA9IE1hdGgubWluKDEwMCwgRy50ZW5zaW9uICsgNik7CiAgICAgICAgICAgICAgICBmbGFzaCgnYmFkJyk7CiAgICAgICAgICAgICAgICBsb2coYPCfmKQgU29tZSBwZW9wbGUgZmVlbCBleGNsdWRlZGAsICdiYWQnKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh2b2ljZXMgPCAzKSB7CiAgICAgICAgICAgICAgICAvLyBNaWxkIHBlbmFsdHkKICAgICAgICAgICAgICAgIE1FTUJFUlMuZmlsdGVyKG0gPT4gIUcuZGlzY3Vzc2lvbi52b2ljZXMuaGFzKG0uaWQpICYmICFtLmlzQ0VPKS5mb3JFYWNoKG0gPT4gewogICAgICAgICAgICAgICAgICAgIEcubWVtYmVyc1ttLmlkXS5mcnVzdHJhdGlvbiA9IE1hdGgubWluKDEwMCwgRy5tZW1iZXJzW20uaWRdLmZydXN0cmF0aW9uICsgNik7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIEcudGVuc2lvbiA9IE1hdGgubWluKDEwMCwgRy50ZW5zaW9uICsgMyk7CiAgICAgICAgICAgICAgICBsb2coYPCfmJUgQ291bGQgdXNlIG1vcmUgaW5wdXRgLCAnd2FybicpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZmxhc2goJ2dvb2QnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgRy5kZWNpc2lvbnMucHVzaCh7IGRlY2lzaW9uLCBxdWFsaXR5LCB2b2ljZXMsIHRpbWU6IEcuaXRlbVRpbWUgfSk7CiAgICAgICAgICAgIEcudGVuc2lvbiA9IE1hdGgubWF4KDAsIEcudGVuc2lvbiAtIDMpOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgZW1vamkgPSBxdWFsaXR5ID49IDU1ID8gJ+KchScgOiBxdWFsaXR5ID49IDQwID8gJ+KsnCcgOiAn4pqg77iPJzsKICAgICAgICAgICAgbG9nKGAke2Vtb2ppfSAke1BST0pFQ1RTW0cucHJvamVjdF0ubmFtZS5zcGxpdCgnICcpWzFdfSBkZWNpZGVkICgke3F1YWxpdHl9JSBxdWFsaXR5KWAsIHF1YWxpdHkgPj0gNTUgPyAnZ29vZCcgOiBxdWFsaXR5IDwgNDAgPyAnYmFkJyA6ICcnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChHLnByb2plY3QgPCBQUk9KRUNUUy5sZW5ndGggLSAxKSB7CiAgICAgICAgICAgICAgICBHLnByb2plY3QrKzsKICAgICAgICAgICAgICAgIGxvYWRQcm9qZWN0KEcucHJvamVjdCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlbmRHYW1lKCdjb21wbGV0ZScpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICB1cGRhdGVVSSgpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBmdW5jdGlvbiB1cGRhdGVVSSgpIHsKICAgICAgICAgICAgY29uc3QgbSA9IE1hdGguZmxvb3IoRy50aW1lIC8gNjApOwogICAgICAgICAgICBjb25zdCBzID0gRy50aW1lICUgNjA7CiAgICAgICAgICAgIGNvbnN0IHRpbWVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RpbWVyJyk7CiAgICAgICAgICAgIHRpbWVyLnRleHRDb250ZW50ID0gYCR7bX06JHtzLnRvU3RyaW5nKCkucGFkU3RhcnQoMiwgJzAnKX1gOwogICAgICAgICAgICB0aW1lci5jbGFzc0xpc3QudG9nZ2xlKCd1cmdlbnQnLCBHLnRpbWUgPD0gMTUpOwogICAgICAgICAgICAKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RlY2lkZWQtY291bnQnKS50ZXh0Q29udGVudCA9IGAke0cuZGVjaXNpb25zLmxlbmd0aH0vNWA7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBpdGVtVCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdpdGVtLXRpbWUnKTsKICAgICAgICAgICAgaXRlbVQudGV4dENvbnRlbnQgPSBHLml0ZW1UaW1lICsgJ3MnOwogICAgICAgICAgICBpdGVtVC5jbGFzc0xpc3QucmVtb3ZlKCdzbG93JywgJ2RyYWcnKTsKICAgICAgICAgICAgaWYgKEcuaXRlbVRpbWUgPiAxNSkgaXRlbVQuY2xhc3NMaXN0LmFkZCgnZHJhZycpOwogICAgICAgICAgICBlbHNlIGlmIChHLml0ZW1UaW1lID4gMTApIGl0ZW1ULmNsYXNzTGlzdC5hZGQoJ3Nsb3cnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHJlbWFpbmluZyA9IDUgLSBHLmRlY2lzaW9ucy5sZW5ndGg7CiAgICAgICAgICAgIGNvbnN0IHRpbWVQZXJJdGVtID0gcmVtYWluaW5nID4gMCA/IEcudGltZSAvIHJlbWFpbmluZyA6IDA7CiAgICAgICAgICAgIGNvbnN0IHBhY2UgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGFjZS1ib3gnKTsKICAgICAgICAgICAgcGFjZS5jbGFzc0xpc3QucmVtb3ZlKCdnb29kJywgJ3dhcm4nLCAnYmFkJyk7CiAgICAgICAgICAgIGlmICh0aW1lUGVySXRlbSA+PSAxMiB8fCByZW1haW5pbmcgPT09IDApIHsKICAgICAgICAgICAgICAgIHBhY2UuY2xhc3NMaXN0LmFkZCgnZ29vZCcpOwogICAgICAgICAgICAgICAgcGFjZS5pbm5lckhUTUwgPSAnPGRpdj5PbiBQYWNlPC9kaXY+PGRpdiBjbGFzcz0icGFjZS1sYWJlbCI+8J+RjTwvZGl2Pic7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGltZVBlckl0ZW0gPj0gOCkgewogICAgICAgICAgICAgICAgcGFjZS5jbGFzc0xpc3QuYWRkKCd3YXJuJyk7CiAgICAgICAgICAgICAgICBwYWNlLmlubmVySFRNTCA9ICc8ZGl2Pkh1cnJ5PC9kaXY+PGRpdiBjbGFzcz0icGFjZS1sYWJlbCI+4pqg77iPPC9kaXY+JzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHBhY2UuY2xhc3NMaXN0LmFkZCgnYmFkJyk7CiAgICAgICAgICAgICAgICBwYWNlLmlubmVySFRNTCA9ICc8ZGl2PkJlaGluZCE8L2Rpdj48ZGl2IGNsYXNzPSJwYWNlLWxhYmVsIj7wn4+DPC9kaXY+JzsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2VuZXJneS1iYXInKS5zdHlsZS53aWR0aCA9IEcuZW5lcmd5ICsgJyUnOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZW5lcmd5LXZhbCcpLnRleHRDb250ZW50ID0gTWF0aC5yb3VuZChHLmVuZXJneSkgKyAnJSc7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdlbmVyZ3ktYmFyLWMnKS5jbGFzc0xpc3QudG9nZ2xlKCdjcml0aWNhbCcsIEcuZW5lcmd5IDwgMjUpOwogICAgICAgICAgICAKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RlbnNpb24tYmFyJykuc3R5bGUud2lkdGggPSBHLnRlbnNpb24gKyAnJSc7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0ZW5zaW9uLXZhbCcpLnRleHRDb250ZW50ID0gTWF0aC5yb3VuZChHLnRlbnNpb24pICsgJyUnOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGVuc2lvbi1iYXItYycpLmNsYXNzTGlzdC50b2dnbGUoJ2NyaXRpY2FsJywgRy50ZW5zaW9uID4gNzApOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ29sb3Igdm9pY2VzIGNoaXAgYmFzZWQgb24gcHJvZ3Jlc3MKICAgICAgICAgICAgY29uc3Qgdm9pY2VzQ2hpcCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaGlwLXZvaWNlcycpOwogICAgICAgICAgICB2b2ljZXNDaGlwLmNsYXNzTGlzdC5yZW1vdmUoJ2FsZXJ0JywgJ3dhcm4nLCAnZ29vZCcpOwogICAgICAgICAgICBpZiAoRy5kaXNjdXNzaW9uLnZvaWNlcy5zaXplID49IDMpIHsKICAgICAgICAgICAgICAgIHZvaWNlc0NoaXAuY2xhc3NMaXN0LmFkZCgnZ29vZCcpOwogICAgICAgICAgICAgICAgdm9pY2VzQ2hpcC5pbm5lckhUTUwgPSBgPHNwYW4gY2xhc3M9ImNoaXAtaWNvbiI+4pyTPC9zcGFuPjxzcGFuIGNsYXNzPSJjaGlwLXRleHQiPiR7Ry5kaXNjdXNzaW9uLnZvaWNlcy5zaXplfS80PC9zcGFuPmA7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoRy5kaXNjdXNzaW9uLnZvaWNlcy5zaXplID49IDEpIHsKICAgICAgICAgICAgICAgIHZvaWNlc0NoaXAuaW5uZXJIVE1MID0gYDxzcGFuIGNsYXNzPSJjaGlwLWljb24iPvCfl6PvuI88L3NwYW4+PHNwYW4gY2xhc3M9ImNoaXAtdGV4dCI+JHtHLmRpc2N1c3Npb24udm9pY2VzLnNpemV9LzQ8L3NwYW4+YDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZvaWNlc0NoaXAuY2xhc3NMaXN0LmFkZCgnd2FybicpOwogICAgICAgICAgICAgICAgdm9pY2VzQ2hpcC5pbm5lckhUTUwgPSBgPHNwYW4gY2xhc3M9ImNoaXAtaWNvbiI+4o+zPC9zcGFuPjxzcGFuIGNsYXNzPSJjaGlwLXRleHQiPjAvNDwvc3Bhbj5gOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBGYXRpZ3VlIGluZGljYXRvcgogICAgICAgICAgICBjb25zdCBmYXRpZ3VlID0gZ2V0RmF0aWd1ZUZhY3RvcigpOwogICAgICAgICAgICBjb25zdCBjZiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaGlwLWZhdGlndWUnKTsKICAgICAgICAgICAgY2YuY2xhc3NMaXN0LnJlbW92ZSgnYWxlcnQnLCAnd2FybicpOwogICAgICAgICAgICBpZiAoZmF0aWd1ZSA+PSAwLjgpIHsgCiAgICAgICAgICAgICAgICBjZi5jbGFzc0xpc3QuYWRkKCdhbGVydCcpOyAKICAgICAgICAgICAgICAgIGNmLmlubmVySFRNTCA9ICc8c3BhbiBjbGFzcz0iY2hpcC1pY29uIj7wn6WxPC9zcGFuPjxzcGFuIGNsYXNzPSJjaGlwLXRleHQiPkV4aGF1c3RlZDwvc3Bhbj4nOyAKICAgICAgICAgICAgfSBlbHNlIGlmIChmYXRpZ3VlID49IDAuNSkgeyAKICAgICAgICAgICAgICAgIGNmLmNsYXNzTGlzdC5hZGQoJ3dhcm4nKTsgCiAgICAgICAgICAgICAgICBjZi5pbm5lckhUTUwgPSAnPHNwYW4gY2xhc3M9ImNoaXAtaWNvbiI+8J+Ykzwvc3Bhbj48c3BhbiBjbGFzcz0iY2hpcC10ZXh0Ij5UaXJlZDwvc3Bhbj4nOyAKICAgICAgICAgICAgfSBlbHNlIGlmIChmYXRpZ3VlID49IDAuMikgeyAKICAgICAgICAgICAgICAgIGNmLmlubmVySFRNTCA9ICc8c3BhbiBjbGFzcz0iY2hpcC1pY29uIj7wn5iQPC9zcGFuPjxzcGFuIGNsYXNzPSJjaGlwLXRleHQiPk9LPC9zcGFuPic7IAogICAgICAgICAgICB9IGVsc2UgeyAKICAgICAgICAgICAgICAgIGNmLmlubmVySFRNTCA9ICc8c3BhbiBjbGFzcz0iY2hpcC1pY29uIj7wn5iKPC9zcGFuPjxzcGFuIGNsYXNzPSJjaGlwLXRleHQiPkZyZXNoPC9zcGFuPic7IAogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBjciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaGlwLXJvb20nKTsKICAgICAgICAgICAgY3IuY2xhc3NMaXN0LnJlbW92ZSgnYWxlcnQnLCAnd2FybicpOwogICAgICAgICAgICBpZiAoRy50ZW5zaW9uID4gODApIHsgCiAgICAgICAgICAgICAgICBjci5jbGFzc0xpc3QuYWRkKCdhbGVydCcpOyAKICAgICAgICAgICAgICAgIGNyLmlubmVySFRNTCA9ICc8c3BhbiBjbGFzcz0iY2hpcC1pY29uIj7wn5SlPC9zcGFuPjxzcGFuIGNsYXNzPSJjaGlwLXRleHQiPkRBTkdFUiE8L3NwYW4+JzsgCiAgICAgICAgICAgIH0gZWxzZSBpZiAoRy50ZW5zaW9uID4gNjApIHsgCiAgICAgICAgICAgICAgICBjci5jbGFzc0xpc3QuYWRkKCdhbGVydCcpOyAKICAgICAgICAgICAgICAgIGNyLmlubmVySFRNTCA9ICc8c3BhbiBjbGFzcz0iY2hpcC1pY29uIj7wn5ihPC9zcGFuPjxzcGFuIGNsYXNzPSJjaGlwLXRleHQiPkhvdCE8L3NwYW4+JzsgCiAgICAgICAgICAgIH0gZWxzZSBpZiAoRy50ZW5zaW9uID4gNDUpIHsgCiAgICAgICAgICAgICAgICBjci5jbGFzc0xpc3QuYWRkKCd3YXJuJyk7IAogICAgICAgICAgICAgICAgY3IuaW5uZXJIVE1MID0gJzxzcGFuIGNsYXNzPSJjaGlwLWljb24iPvCfmKw8L3NwYW4+PHNwYW4gY2xhc3M9ImNoaXAtdGV4dCI+VGVuc2U8L3NwYW4+JzsgCiAgICAgICAgICAgIH0gZWxzZSB7IAogICAgICAgICAgICAgICAgY3IuaW5uZXJIVE1MID0gJzxzcGFuIGNsYXNzPSJjaGlwLWljb24iPvCfmIo8L3NwYW4+PHNwYW4gY2xhc3M9ImNoaXAtdGV4dCI+T0s8L3NwYW4+JzsgCiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFVwZGF0ZSByb29tIHZpc3VhbCBzdGF0ZSBiYXNlZCBvbiB0ZW5zaW9uIGFuZCBlbmVyZ3kKICAgICAgICAgICAgY29uc3Qgcm9vbSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtZWV0aW5nLXJvb20nKTsKICAgICAgICAgICAgcm9vbS5jbGFzc0xpc3QucmVtb3ZlKCd0aXJlZC1yb29tJywgJ2V4aGF1c3RlZC1yb29tJyk7CiAgICAgICAgICAgIGlmIChHLmVuZXJneSA8IDI1KSB7CiAgICAgICAgICAgICAgICByb29tLmNsYXNzTGlzdC5hZGQoJ2V4aGF1c3RlZC1yb29tJyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoRy5lbmVyZ3kgPCA1MCkgewogICAgICAgICAgICAgICAgcm9vbS5jbGFzc0xpc3QuYWRkKCd0aXJlZC1yb29tJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICghRy5jb25mbGljdCkgewogICAgICAgICAgICAgICAgcm9vbS5jbGFzc0xpc3QucmVtb3ZlKCd0ZW5zZScsICdjcml0aWNhbCcpOwogICAgICAgICAgICAgICAgaWYgKEcudGVuc2lvbiA+IDgwKSB7CiAgICAgICAgICAgICAgICAgICAgcm9vbS5jbGFzc0xpc3QuYWRkKCdjcml0aWNhbCcpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChHLnRlbnNpb24gPiA2MCkgewogICAgICAgICAgICAgICAgICAgIHJvb20uY2xhc3NMaXN0LmFkZCgndGVuc2UnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGVhZGVyIGRhbmdlciBtb2RlIG9ubHkgYXQgaGlnaCB0ZW5zaW9uIG9yIGNvbmZsaWN0CiAgICAgICAgICAgIGNvbnN0IGhlYWRlciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5nYW1lLWhlYWRlcicpOwogICAgICAgICAgICBoZWFkZXIuY2xhc3NMaXN0LnRvZ2dsZSgnZGFuZ2VyJywgRy50ZW5zaW9uID4gODAgfHwgRy5jb25mbGljdCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBjcmlzaXMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY3Jpc2lzLWJhbm5lcicpOwogICAgICAgICAgICBjb25zdCBjdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjcmlzaXMtdGV4dCcpOwogICAgICAgICAgICBjb25zdCBoaW50ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLmNyaXNpcy1oaW50Jyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDaGVjayBmb3IgYnVpbGRpbmcgY29uZmxpY3RzCiAgICAgICAgICAgIGNvbnN0IGJ1aWxkaW5nQ29uZmxpY3QgPSBHLmd1YXJhbnRlZWRDb25mbGljdHMuZmluZChnYyA9PiAKICAgICAgICAgICAgICAgICFnYy50cmlnZ2VyZWQgJiYgIWdjLnByZXZlbnRlZCAmJiAoZ2Mud2FybmVkIHx8IGdjLmZpbmFsV2FybikKICAgICAgICAgICAgKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChHLmNvbmZsaWN0KSB7CiAgICAgICAgICAgICAgICBjb25zdCBbaWQxLCBpZDJdID0gRy5jb25mbGljdDsKICAgICAgICAgICAgICAgIGN0LnRleHRDb250ZW50ID0gYOKaoSAke01FTUJFUlMuZmluZChtID0+IG0uaWQgPT09IGlkMSkubmFtZX0gdnMgJHtNRU1CRVJTLmZpbmQobSA9PiBtLmlkID09PSBpZDIpLm5hbWV9IWA7CiAgICAgICAgICAgICAgICBoaW50LnRleHRDb250ZW50ID0gYFVzZSDwn5WK77iPIERlZnVzZSBOT1chYDsKICAgICAgICAgICAgICAgIGNyaXNpcy5jbGFzc0xpc3QuYWRkKCdzaG93Jyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYnVpbGRpbmdDb25mbGljdCAmJiBidWlsZGluZ0NvbmZsaWN0LmZpbmFsV2FybikgewogICAgICAgICAgICAgICAgY29uc3QgbTEgPSBNRU1CRVJTLmZpbmQobSA9PiBtLmlkID09PSBidWlsZGluZ0NvbmZsaWN0LnBhaXJbMF0pOwogICAgICAgICAgICAgICAgY29uc3QgbTIgPSBNRU1CRVJTLmZpbmQobSA9PiBtLmlkID09PSBidWlsZGluZ0NvbmZsaWN0LnBhaXJbMV0pOwogICAgICAgICAgICAgICAgY3QudGV4dENvbnRlbnQgPSBg4pqg77iPICR7bTEubmFtZX0gdnMgJHttMi5uYW1lfSBhYm91dCB0byBjbGFzaCFgOwogICAgICAgICAgICAgICAgaGludC50ZXh0Q29udGVudCA9IGDwn5WK77iPIERlZnVzZSBub3cgdG8gUFJFVkVOVCBjb25mbGljdCFgOwogICAgICAgICAgICAgICAgY3Jpc2lzLmNsYXNzTGlzdC5hZGQoJ3Nob3cnKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChidWlsZGluZ0NvbmZsaWN0ICYmIGJ1aWxkaW5nQ29uZmxpY3Qud2FybmVkKSB7CiAgICAgICAgICAgICAgICBjb25zdCBtMSA9IE1FTUJFUlMuZmluZChtID0+IG0uaWQgPT09IGJ1aWxkaW5nQ29uZmxpY3QucGFpclswXSk7CiAgICAgICAgICAgICAgICBjb25zdCBtMiA9IE1FTUJFUlMuZmluZChtID0+IG0uaWQgPT09IGJ1aWxkaW5nQ29uZmxpY3QucGFpclsxXSk7CiAgICAgICAgICAgICAgICBjdC50ZXh0Q29udGVudCA9IGDwn5isIFRlbnNpb24gYnVpbGRpbmc6ICR7bTEubmFtZX0gJiAke20yLm5hbWV9YDsKICAgICAgICAgICAgICAgIGhpbnQudGV4dENvbnRlbnQgPSBgV2F0Y2ggZm9yIHdhcm5pbmcgc2lnbnMuLi5gOwogICAgICAgICAgICAgICAgY3Jpc2lzLmNsYXNzTGlzdC5hZGQoJ3Nob3cnKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChHLmVuZXJneSA8IDI1KSB7CiAgICAgICAgICAgICAgICBjdC50ZXh0Q29udGVudCA9IGDwn5i0IFJvb20gaXMgRVhIQVVTVEVEIWA7CiAgICAgICAgICAgICAgICBoaW50LnRleHRDb250ZW50ID0gYFVzZSDimJUgQnJlYWsgb3Ig8J+YgiBKb2tlIGZvciBlbmVyZ3khYDsKICAgICAgICAgICAgICAgIGNyaXNpcy5jbGFzc0xpc3QuYWRkKCdzaG93Jyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoRy50ZW5zaW9uID4gODApIHsKICAgICAgICAgICAgICAgIGN0LnRleHRDb250ZW50ID0gYPCflKUgREFOR0VSOiBOZWFyIGJyZWFraW5nIWA7CiAgICAgICAgICAgICAgICBoaW50LnRleHRDb250ZW50ID0gYFVzZSDwn5WK77iPIERlZnVzZSBvciDwn5iCIEpva2UhYDsKICAgICAgICAgICAgICAgIGNyaXNpcy5jbGFzc0xpc3QuYWRkKCdzaG93Jyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoRy5lbmVyZ3kgPCA0MCAmJiBHLnVzZXMuYnJlYWsgPiAwKSB7CiAgICAgICAgICAgICAgICBjdC50ZXh0Q29udGVudCA9IGDwn5iTIEVuZXJneSBnZXR0aW5nIGxvdy4uLmA7CiAgICAgICAgICAgICAgICBoaW50LnRleHRDb250ZW50ID0gYENvbnNpZGVyIHVzaW5nIOKYlSBCcmVhayBzb29uYDsKICAgICAgICAgICAgICAgIGNyaXNpcy5jbGFzc0xpc3QuYWRkKCdzaG93Jyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjcmlzaXMuY2xhc3NMaXN0LnJlbW92ZSgnc2hvdycpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBkcmFnID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RyYWctd2FybmluZycpOwogICAgICAgICAgICBkcmFnLmNsYXNzTGlzdC50b2dnbGUoJ3Nob3cnLCBHLml0ZW1UaW1lID4gMTUgJiYgIUcuY29uZmxpY3QpOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgYXR0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhdHRlbnRpb24tcm93Jyk7CiAgICAgICAgICAgIGF0dG4uaW5uZXJIVE1MID0gJyc7CiAgICAgICAgICAgIE1FTUJFUlMuZm9yRWFjaChtID0+IHsKICAgICAgICAgICAgICAgIGlmIChtLmlzQ0VPKSByZXR1cm47CiAgICAgICAgICAgICAgICBjb25zdCBtcyA9IEcubWVtYmVyc1ttLmlkXTsKICAgICAgICAgICAgICAgIGNvbnN0IGhhc1Nwb2tlbiA9IEcuZGlzY3Vzc2lvbi52b2ljZXMuaGFzKG0uaWQpOwogICAgICAgICAgICAgICAgY29uc3QgaXNRdWlldCA9IChtLmFzc2VydGl2ZSB8fCAwLjUpIDwgMC41OwogICAgICAgICAgICAgICAgY29uc3Qgcm9sZUljb24gPSBtLmlkID09PSAndGVjaCcgPyAn8J+UrCcgOiAKICAgICAgICAgICAgICAgICAgICBtLmlkID09PSAnZmluYW5jZScgPyAn8J+SsCcgOiAKICAgICAgICAgICAgICAgICAgICBtLmlkID09PSAnbWt0JyA/ICfwn5OiJyA6ICfimpnvuI8nOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAobXMuZnJ1c3RyYXRpb24gPiA0NSkgewogICAgICAgICAgICAgICAgICAgIGF0dG4uaW5uZXJIVE1MICs9IGA8ZGl2IGNsYXNzPSJhdHRuLWNoaXAgYW5ncnkiPiR7cm9sZUljb259ICR7bS5uYW1lfSBmcnVzdHJhdGVkPC9kaXY+YDsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIWhhc1Nwb2tlbiAmJiBpc1F1aWV0KSB7CiAgICAgICAgICAgICAgICAgICAgYXR0bi5pbm5lckhUTUwgKz0gYDxkaXYgY2xhc3M9ImF0dG4tY2hpcCBxdWlldCI+JHtyb2xlSWNvbn0gJHttLm5hbWV9IHF1aWV0PC9kaXY+YDsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIWhhc1Nwb2tlbiAmJiBtcy53YW50c1NwZWFrKSB7CiAgICAgICAgICAgICAgICAgICAgYXR0bi5pbm5lckhUTUwgKz0gYDxkaXYgY2xhc3M9ImF0dG4tY2hpcCB3YWl0aW5nIj4ke3JvbGVJY29ufSAke20ubmFtZX0gd2FpdGluZzwvZGl2PmA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgTUVNQkVSUy5mb3JFYWNoKG0gPT4gewogICAgICAgICAgICAgICAgY29uc3QgYmFyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoYGJhci0ke20uaWR9YCk7CiAgICAgICAgICAgICAgICBjb25zdCBmcnVzdHJhdGlvbiA9IEcubWVtYmVyc1ttLmlkXS5mcnVzdHJhdGlvbjsKICAgICAgICAgICAgICAgIGJhci5zdHlsZS53aWR0aCA9IE1hdGgubWluKDEwMCwgZnJ1c3RyYXRpb24pICsgJyUnOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBDb2xvciBiYXNlZCBvbiBmcnVzdHJhdGlvbjogZ3JlZW4gKGNhbG0pIC0+IHllbGxvdyAtPiByZWQgKGFuZ3J5KQogICAgICAgICAgICAgICAgaWYgKGZydXN0cmF0aW9uID4gNjApIHsKICAgICAgICAgICAgICAgICAgICBiYXIuc3R5bGUuYmFja2dyb3VuZCA9ICcjRUY0NDQ0JzsgLy8gUmVkCiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGZydXN0cmF0aW9uID4gNDApIHsKICAgICAgICAgICAgICAgICAgICBiYXIuc3R5bGUuYmFja2dyb3VuZCA9ICcjRjU5RTBCJzsgLy8gWWVsbG93CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGJhci5zdHlsZS5iYWNrZ3JvdW5kID0gJyMyMkM1NUUnOyAvLyBHcmVlbgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBzdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGBzdC0ke20uaWR9YCk7CiAgICAgICAgICAgICAgICBjb25zdCBtcyA9IEcubWVtYmVyc1ttLmlkXTsKICAgICAgICAgICAgICAgIGNvbnN0IGhhc1Nwb2tlbiA9IEcuZGlzY3Vzc2lvbi52b2ljZXMuaGFzKG0uaWQpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTaG93IHN0YXR1cyBiYXNlZCBvbiBzdGF0ZQogICAgICAgICAgICAgICAgaWYgKG1zLmZydXN0cmF0aW9uID4gNTApIHsgCiAgICAgICAgICAgICAgICAgICAgc3QudGV4dENvbnRlbnQgPSAn8J+YpCc7IAogICAgICAgICAgICAgICAgICAgIHN0LmNsYXNzTGlzdC5hZGQoJ3Nob3cnKTsgCiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhhc1Nwb2tlbikgeyAKICAgICAgICAgICAgICAgICAgICBzdC50ZXh0Q29udGVudCA9ICfinJMnOyAKICAgICAgICAgICAgICAgICAgICBzdC5jbGFzc0xpc3QuYWRkKCdzaG93Jyk7IAogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChtcy53YW50c1NwZWFrKSB7IAogICAgICAgICAgICAgICAgICAgIHN0LnRleHRDb250ZW50ID0gJ/Cfkq0nOyAKICAgICAgICAgICAgICAgICAgICBzdC5jbGFzc0xpc3QuYWRkKCdzaG93Jyk7IAogICAgICAgICAgICAgICAgfSBlbHNlIHsgCiAgICAgICAgICAgICAgICAgICAgc3QuY2xhc3NMaXN0LnJlbW92ZSgnc2hvdycpOyAKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCB2b2ljZXMgPSBHLmRpc2N1c3Npb24udm9pY2VzLnNpemU7CiAgICAgICAgICAgIGNvbnN0IHF1YWxpdHkgPSBnZXRRdWFsaXR5KCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgcHJvbWluZW50IHF1YWxpdHkgZGlzcGxheQogICAgICAgICAgICBjb25zdCBxRGlzcGxheSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5xdWFsaXR5LWRpc3BsYXknKTsKICAgICAgICAgICAgY29uc3QgcVNjb3JlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3F1YWxpdHktc2NvcmUnKTsKICAgICAgICAgICAgY29uc3QgcUJhciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdxdWFsaXR5LWJhcicpOwogICAgICAgICAgICBjb25zdCBxRmFjdG9ycyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdxdWFsaXR5LWZhY3RvcnMnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHFTY29yZS50ZXh0Q29udGVudCA9IHF1YWxpdHkgKyAnJSc7CiAgICAgICAgICAgIHFCYXIuc3R5bGUud2lkdGggPSBxdWFsaXR5ICsgJyUnOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ29sb3IgYmFzZWQgb24gcXVhbGl0eSAtIHVwZGF0ZSBib3RoIHNjb3JlIGFuZCBjb250YWluZXIKICAgICAgICAgICAgcVNjb3JlLmNsYXNzTGlzdC5yZW1vdmUoJ2xvdycsICdtZWRpdW0nLCAnZ29vZCcsICdncmVhdCcpOwogICAgICAgICAgICBxRGlzcGxheS5jbGFzc0xpc3QucmVtb3ZlKCdsb3cnLCAnbWVkaXVtJywgJ2dvb2QnLCAnZ3JlYXQnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFVwZGF0ZSBnb2FsIHRleHQgYmFzZWQgb24gdm9pY2VzCiAgICAgICAgICAgIGNvbnN0IHFHb2FsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3F1YWxpdHktZ29hbCcpOwogICAgICAgICAgICBjb25zdCBxdWlldFVuaGVhcmQgPSBNRU1CRVJTLmZpbHRlcihtID0+IAogICAgICAgICAgICAgICAgIW0uaXNDRU8gJiYgCiAgICAgICAgICAgICAgICAhRy5kaXNjdXNzaW9uLnZvaWNlcy5oYXMobS5pZCkgJiYgCiAgICAgICAgICAgICAgICAobS5hc3NlcnRpdmUgfHwgMC41KSA8IDAuNQogICAgICAgICAgICApOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHZvaWNlcyA+PSAzKSB7CiAgICAgICAgICAgICAgICBxR29hbC50ZXh0Q29udGVudCA9ICfinJMgUmVhZHkgdG8gZGVjaWRlISc7CiAgICAgICAgICAgICAgICBxR29hbC5zdHlsZS5jb2xvciA9ICd2YXIoLS1zdWNjZXNzKSc7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocXVpZXRVbmhlYXJkLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIHFHb2FsLnRleHRDb250ZW50ID0gYFVzZSBJbnZpdGUgZm9yIHF1aWV0IG1lbWJlcnNgOwogICAgICAgICAgICAgICAgcUdvYWwuc3R5bGUuY29sb3IgPSAnIzdDM0FFRCc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBxR29hbC50ZXh0Q29udGVudCA9IGBOZWVkICR7MyAtIHZvaWNlc30gbW9yZSB2b2ljZSR7MyAtIHZvaWNlcyA+IDEgPyAncycgOiAnJ30gZm9yIGdyZWVuYDsKICAgICAgICAgICAgICAgIHFHb2FsLnN0eWxlLmNvbG9yID0gJ3ZhcigtLXRleHQtbWVkaXVtKSc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChxdWFsaXR5ID49IDcwKSB7CiAgICAgICAgICAgICAgICBxU2NvcmUuY2xhc3NMaXN0LmFkZCgnZ3JlYXQnKTsKICAgICAgICAgICAgICAgIHFEaXNwbGF5LmNsYXNzTGlzdC5hZGQoJ2dyZWF0Jyk7CiAgICAgICAgICAgICAgICBxQmFyLnN0eWxlLmJhY2tncm91bmQgPSAnIzA1OTY2OSc7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocXVhbGl0eSA+PSA1NSkgewogICAgICAgICAgICAgICAgcVNjb3JlLmNsYXNzTGlzdC5hZGQoJ2dvb2QnKTsKICAgICAgICAgICAgICAgIHFEaXNwbGF5LmNsYXNzTGlzdC5hZGQoJ2dvb2QnKTsKICAgICAgICAgICAgICAgIHFCYXIuc3R5bGUuYmFja2dyb3VuZCA9ICcjMjJDNTVFJzsKICAgICAgICAgICAgfSBlbHNlIGlmIChxdWFsaXR5ID49IDM1KSB7CiAgICAgICAgICAgICAgICBxU2NvcmUuY2xhc3NMaXN0LmFkZCgnbWVkaXVtJyk7CiAgICAgICAgICAgICAgICBxRGlzcGxheS5jbGFzc0xpc3QuYWRkKCdtZWRpdW0nKTsKICAgICAgICAgICAgICAgIHFCYXIuc3R5bGUuYmFja2dyb3VuZCA9ICcjRjU5RTBCJzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHFTY29yZS5jbGFzc0xpc3QuYWRkKCdsb3cnKTsKICAgICAgICAgICAgICAgIHFEaXNwbGF5LmNsYXNzTGlzdC5hZGQoJ2xvdycpOwogICAgICAgICAgICAgICAgcUJhci5zdHlsZS5iYWNrZ3JvdW5kID0gJyNFRjQ0NDQnOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTaG93IHdoYXQncyBhZmZlY3RpbmcgcXVhbGl0eSAtIGVtcGhhc2l6ZSB2b2ljZXMgYXMgbWFpbiBkcml2ZXIKICAgICAgICAgICAgbGV0IGZhY3RvcnMgPSBbXTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFZvaWNlcyBmYWN0b3IgLSBUSEUgS0VZIERSSVZFUgogICAgICAgICAgICBpZiAodm9pY2VzID49IDQpIHsKICAgICAgICAgICAgICAgIGZhY3RvcnMucHVzaChgPHNwYW4gY2xhc3M9InF1YWxpdHktZmFjdG9yIHBvc2l0aXZlIj7inJMgQWxsIDQgdm9pY2VzIGhlYXJkITwvc3Bhbj5gKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh2b2ljZXMgPT09IDMpIHsKICAgICAgICAgICAgICAgIGZhY3RvcnMucHVzaChgPHNwYW4gY2xhc3M9InF1YWxpdHktZmFjdG9yIHBvc2l0aXZlIj7wn5ej77iPICR7dm9pY2VzfS80IHZvaWNlcyAoZ29vZCEpPC9zcGFuPmApOwogICAgICAgICAgICB9IGVsc2UgaWYgKHZvaWNlcyA9PT0gMikgewogICAgICAgICAgICAgICAgZmFjdG9ycy5wdXNoKGA8c3BhbiBjbGFzcz0icXVhbGl0eS1mYWN0b3IgbmV1dHJhbCI+8J+Xo++4jyAke3ZvaWNlc30vNCB2b2ljZXMgKHdhaXQgZm9yIG1vcmUpPC9zcGFuPmApOwogICAgICAgICAgICB9IGVsc2UgaWYgKHZvaWNlcyA9PT0gMSkgewogICAgICAgICAgICAgICAgZmFjdG9ycy5wdXNoKGA8c3BhbiBjbGFzcz0icXVhbGl0eS1mYWN0b3IgbmVnYXRpdmUiPvCfl6PvuI8gJHt2b2ljZXN9LzQgdm9pY2VzICh0b28gZmV3ISk8L3NwYW4+YCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBmYWN0b3JzLnB1c2goYDxzcGFuIGNsYXNzPSJxdWFsaXR5LWZhY3RvciBuZWdhdGl2ZSI+8J+Xo++4jyBObyBvbmUgaGFzIHNwb2tlbiB5ZXQ8L3NwYW4+YCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEVuZXJneSBmYWN0b3IKICAgICAgICAgICAgaWYgKEcuZW5lcmd5IDwgMzApIHsKICAgICAgICAgICAgICAgIGZhY3RvcnMucHVzaChgPHNwYW4gY2xhc3M9InF1YWxpdHktZmFjdG9yIG5lZ2F0aXZlIj7wn5i0IEV4aGF1c3RlZCAoLTglKTwvc3Bhbj5gKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChHLmVuZXJneSA8IDUwKSB7CiAgICAgICAgICAgICAgICBmYWN0b3JzLnB1c2goYDxzcGFuIGNsYXNzPSJxdWFsaXR5LWZhY3RvciBuZXV0cmFsIj7wn5iTIFRpcmVkICgtNCUpPC9zcGFuPmApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDb25mbGljdCB3YXJuaW5nCiAgICAgICAgICAgIGlmIChHLmNvbmZsaWN0KSB7CiAgICAgICAgICAgICAgICBmYWN0b3JzLnB1c2goYDxzcGFuIGNsYXNzPSJxdWFsaXR5LWZhY3RvciBuZWdhdGl2ZSI+4pqhIENvbmZsaWN0IGFjdGl2ZSE8L3NwYW4+YCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoRy50ZW5zaW9uID4gNTUpIHsKICAgICAgICAgICAgICAgIGZhY3RvcnMucHVzaChgPHNwYW4gY2xhc3M9InF1YWxpdHktZmFjdG9yIG5lZ2F0aXZlIj7wn5SlIEhpZ2ggdGVuc2lvbjwvc3Bhbj5gKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChHLnRlbnNpb24gPCAzMCAmJiB2b2ljZXMgPj0gMikgewogICAgICAgICAgICAgICAgZmFjdG9ycy5wdXNoKGA8c3BhbiBjbGFzcz0icXVhbGl0eS1mYWN0b3IgcG9zaXRpdmUiPvCfmIogQ2FsbSBkaXNjdXNzaW9uPC9zcGFuPmApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDRU8gcGVuYWx0eSByZW1pbmRlcgogICAgICAgICAgICBpZiAoRy5jZW9Vc2VkID4gMCkgewogICAgICAgICAgICAgICAgZmFjdG9ycy5wdXNoKGA8c3BhbiBjbGFzcz0icXVhbGl0eS1mYWN0b3IgbmVnYXRpdmUiPvCfkZQgLSR7Ry5jZW9Vc2VkICogOH0lPC9zcGFuPmApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBxRmFjdG9ycy5pbm5lckhUTUwgPSBmYWN0b3JzLmpvaW4oJycpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRGVjaXNpb24gaW5mbyB0ZXh0IC0gZ3VpZGUgcGF0aWVuY2UKICAgICAgICAgICAgY29uc3QgaW5mbyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkZWNpc2lvbi1pbmZvJyk7CiAgICAgICAgICAgIGNvbnN0IHF1aWV0TmVlZEludml0ZSA9IE1FTUJFUlMuZmlsdGVyKG0gPT4gCiAgICAgICAgICAgICAgICAhbS5pc0NFTyAmJiAKICAgICAgICAgICAgICAgICFHLmRpc2N1c3Npb24udm9pY2VzLmhhcyhtLmlkKSAmJiAKICAgICAgICAgICAgICAgIChtLmFzc2VydGl2ZSB8fCAwLjUpIDwgMC41CiAgICAgICAgICAgICk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoRy5jb25mbGljdCkgewogICAgICAgICAgICAgICAgaW5mby50ZXh0Q29udGVudCA9IGDimqDvuI8gUmVzb2x2ZSBjb25mbGljdCBiZWZvcmUgZGVjaWRpbmchYDsKICAgICAgICAgICAgICAgIGluZm8uY2xhc3NOYW1lID0gJ2RlY2lzaW9uLWluZm8gd2Fybic7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodm9pY2VzID49IDMgJiYgcXVhbGl0eSA+PSA1NSkgewogICAgICAgICAgICAgICAgaW5mby50ZXh0Q29udGVudCA9IGDinJMgR29vZCBjb25zZW5zdXMhIFNhZmUgdG8gZGVjaWRlLmA7CiAgICAgICAgICAgICAgICBpbmZvLmNsYXNzTmFtZSA9ICdkZWNpc2lvbi1pbmZvIHJlYWR5JzsKICAgICAgICAgICAgfSBlbHNlIGlmICh2b2ljZXMgPj0gNCAmJiBxdWFsaXR5ID49IDUwKSB7CiAgICAgICAgICAgICAgICBpbmZvLnRleHRDb250ZW50ID0gYOKckyBFdmVyeW9uZSBoZWFyZC4gUmVhZHkgdG8gZGVjaWRlLmA7CiAgICAgICAgICAgICAgICBpbmZvLmNsYXNzTmFtZSA9ICdkZWNpc2lvbi1pbmZvIHJlYWR5JzsKICAgICAgICAgICAgfSBlbHNlIGlmIChxdWlldE5lZWRJbnZpdGUubGVuZ3RoID4gMCAmJiB2b2ljZXMgPCAzKSB7CiAgICAgICAgICAgICAgICBjb25zdCBuYW1lcyA9IHF1aWV0TmVlZEludml0ZS5tYXAobSA9PiBtLm5hbWUpLmpvaW4oJywgJyk7CiAgICAgICAgICAgICAgICBpbmZvLnRleHRDb250ZW50ID0gYPCfl6PvuI8gSW52aXRlICR7bmFtZXN9IOKAlCB0aGV5IHdvbid0IHNwZWFrIHVwIGFsb25lYDsKICAgICAgICAgICAgICAgIGluZm8uY2xhc3NOYW1lID0gJ2RlY2lzaW9uLWluZm8gd2Fybic7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodm9pY2VzIDwgMikgewogICAgICAgICAgICAgICAgaW5mby50ZXh0Q29udGVudCA9IGDij7MgV2FpdCBmb3IgcGVvcGxlIHRvIHNwZWFrIGZpcnN0Li4uYDsKICAgICAgICAgICAgICAgIGluZm8uY2xhc3NOYW1lID0gJ2RlY2lzaW9uLWluZm8nOwogICAgICAgICAgICB9IGVsc2UgaWYgKHZvaWNlcyA8IDMpIHsKICAgICAgICAgICAgICAgIGluZm8udGV4dENvbnRlbnQgPSBg4o+zIExldCBtb3JlIHZvaWNlcyBiZSBoZWFyZCAoJHt2b2ljZXN9LzQpYDsKICAgICAgICAgICAgICAgIGluZm8uY2xhc3NOYW1lID0gJ2RlY2lzaW9uLWluZm8gd2Fybic7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpbmZvLnRleHRDb250ZW50ID0gYCR7dm9pY2VzfS80IGhlYXJkIOKAoiBRdWFsaXR5OiAke3F1YWxpdHl9JWA7CiAgICAgICAgICAgICAgICBpbmZvLmNsYXNzTmFtZSA9ICdkZWNpc2lvbi1pbmZvJzsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLmFjdGlvbi1idG4nKS5mb3JFYWNoKGIgPT4gYi5jbGFzc0xpc3QucmVtb3ZlKCdyZWNvbW1lbmRlZCcpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJldXNlIGJ1aWxkaW5nQ29uZmxpY3QgZnJvbSBlYXJsaWVyIGluIHVwZGF0ZVVJCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoRy5jb25mbGljdCkgewogICAgICAgICAgICAgICAgLy8gU1RST05HTFkgcmVjb21tZW5kIGRlZnVzZSBkdXJpbmcgY29uZmxpY3QKICAgICAgICAgICAgICAgIGNvbnN0IGRlZnVzZUJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdidG4tZGVmdXNlJyk7CiAgICAgICAgICAgICAgICBkZWZ1c2VCdG4uY2xhc3NMaXN0LmFkZCgncmVjb21tZW5kZWQnKTsKICAgICAgICAgICAgICAgIC8vIEFsc28gcHVsc2UgdGhlIENFTyBidXR0b24gaWYgZGVmdXNlIGlzIG9uIGNvb2xkb3duCiAgICAgICAgICAgICAgICBpZiAoRy5jb29sZG93bnMuZGVmdXNlICYmIEcudXNlcy5jZW8gPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2J0bi1jZW8nKS5jbGFzc0xpc3QuYWRkKCdyZWNvbW1lbmRlZCcpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKGJ1aWxkaW5nQ29uZmxpY3QpIHsKICAgICAgICAgICAgICAgIC8vIFJlY29tbWVuZCBkZWZ1c2UgZHVyaW5nIGJ1aWxkdXAgdG8gcHJldmVudCBjb25mbGljdAogICAgICAgICAgICAgICAgaWYgKCFHLmNvb2xkb3ducy5kZWZ1c2UpIHsKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYnRuLWRlZnVzZScpLmNsYXNzTGlzdC5hZGQoJ3JlY29tbWVuZGVkJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoRy5lbmVyZ3kgPCAzNSAmJiBHLnVzZXMuYnJlYWsgPiAwKSB7CiAgICAgICAgICAgICAgICAvLyBFTkVSR1kgQ1JJVElDQUwgLSByZWNvbW1lbmQgYnJlYWshCiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYnRuLWJyZWFrJykuY2xhc3NMaXN0LmFkZCgncmVjb21tZW5kZWQnKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChHLmVuZXJneSA8IDUwICYmIEcudXNlcy5qb2tlID4gMCAmJiAhRy5jb29sZG93bnMuam9rZSkgewogICAgICAgICAgICAgICAgLy8gRW5lcmd5IGdldHRpbmcgbG93IC0gcmVjb21tZW5kIGpva2UgZm9yIHNtYWxsIGJvb3N0CiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYnRuLWpva2UnKS5jbGFzc0xpc3QuYWRkKCdyZWNvbW1lbmRlZCcpOwogICAgICAgICAgICB9IGVsc2UgaWYgKEcudGVuc2lvbiA+IDYwKSB7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYnRuLWRlZnVzZScpLmNsYXNzTGlzdC5hZGQoJ3JlY29tbWVuZGVkJyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBDaGVjayBmb3IgcXVpZXQgbWVtYmVycyB3aG8gaGF2ZW4ndCBzcG9rZW4KICAgICAgICAgICAgICAgIGNvbnN0IHF1aWV0VW5oZWFyZCA9IE1FTUJFUlMuZmlsdGVyKG0gPT4gCiAgICAgICAgICAgICAgICAgICAgIW0uaXNDRU8gJiYgCiAgICAgICAgICAgICAgICAgICAgIUcuZGlzY3Vzc2lvbi52b2ljZXMuaGFzKG0uaWQpICYmIAogICAgICAgICAgICAgICAgICAgIChtLmFzc2VydGl2ZSB8fCAwLjUpIDwgMC41CiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgY29uc3QgYW55VW5oZWFyZCA9IE1FTUJFUlMuZmlsdGVyKG0gPT4gIW0uaXNDRU8gJiYgIUcuZGlzY3Vzc2lvbi52b2ljZXMuaGFzKG0uaWQpKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHF1aWV0VW5oZWFyZC5sZW5ndGggPiAwICYmICFHLmNvb2xkb3ducy5pbnZpdGUpIHsKICAgICAgICAgICAgICAgICAgICAvLyBRdWlldCBtZW1iZXJzIG5lZWQgaW52aXRpbmchCiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2J0bi1pbnZpdGUnKS5jbGFzc0xpc3QuYWRkKCdyZWNvbW1lbmRlZCcpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChhbnlVbmhlYXJkLmxlbmd0aCA+IDAgJiYgRy5kaXNjdXNzaW9uLnZvaWNlcy5zaXplIDwgMyAmJiAhRy5jb29sZG93bnMuaW52aXRlKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gTmVlZCBtb3JlIHZvaWNlcwogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdidG4taW52aXRlJykuY2xhc3NMaXN0LmFkZCgncmVjb21tZW5kZWQnKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoRy5sYXN0U3BlYWtlciAmJiBHLm1lbWJlcnNbRy5sYXN0U3BlYWtlcl0uZnJ1c3RyYXRpb24gPiAzMCAmJiBHLm1lbWJlcnNbRy5sYXN0U3BlYWtlcl0ubGFzdFNwb2tlIDwgMykgewogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdidG4tYWNrJykuY2xhc3NMaXN0LmFkZCgncmVjb21tZW5kZWQnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICBmdW5jdGlvbiBjaGVja0VuZCgpIHsKICAgICAgICAgICAgaWYgKEcudGVuc2lvbiA+PSAxMDApIHsgZW5kR2FtZSgnZXhwbG9zaW9uJyk7IHJldHVybjsgfQogICAgICAgICAgICBpZiAoRy5lbmVyZ3kgPD0gMCkgeyBlbmRHYW1lKCdleGhhdXN0aW9uJyk7IHJldHVybjsgfQogICAgICAgICAgICBpZiAoRy50aW1lIDw9IDApIHsgZW5kR2FtZSgndGltZW91dCcpOyB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGZ1bmN0aW9uIGVuZEdhbWUocmVhc29uKSB7CiAgICAgICAgICAgIEcucnVubmluZyA9IGZhbHNlOwogICAgICAgICAgICBjbGVhckludGVydmFsKHRpbWVySW50KTsKICAgICAgICAgICAgY2xlYXJJbnRlcnZhbCh0aWNrSW50KTsKICAgICAgICAgICAgY2xlYXJJbnRlcnZhbCh0ZW5zaW9uSW50KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlc2V0IHJvb20gYXBwZWFyYW5jZQogICAgICAgICAgICBjb25zdCByb29tID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21lZXRpbmctcm9vbScpOwogICAgICAgICAgICByb29tLnN0eWxlLmJhY2tncm91bmQgPSAnJzsKICAgICAgICAgICAgcm9vbS5zdHlsZS5hbmltYXRpb24gPSAnJzsKICAgICAgICAgICAgcm9vbS5jbGFzc0xpc3QucmVtb3ZlKCd0ZW5zZScsICdjcml0aWNhbCcsICd0aXJlZC1yb29tJywgJ2V4aGF1c3RlZC1yb29tJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSZXNldCBoZWFkZXIKICAgICAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLmdhbWUtaGVhZGVyJykuY2xhc3NMaXN0LnJlbW92ZSgnZGFuZ2VyJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBzY3JlZW4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVzdWx0LXNjcmVlbicpOwogICAgICAgICAgICBjb25zdCB0aXRsZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZXN1bHQtdGl0bGUnKTsKICAgICAgICAgICAgY29uc3QgbWVzc2FnZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZXN1bHQtbWVzc2FnZScpOwogICAgICAgICAgICBjb25zdCBncmlkID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Jlc3VsdC1ncmlkJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICBsZXQgZG9uZSA9IEcuZGVjaXNpb25zLmxlbmd0aDsKICAgICAgICAgICAgbGV0IGF2Z1EgPSBkb25lID4gMCA/IEcuZGVjaXNpb25zLnJlZHVjZSgocywgZCkgPT4gcyArIGQucXVhbGl0eSwgMCkgLyBkb25lIDogMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IG1pc3NlZCA9IDUgLSBkb25lOwogICAgICAgICAgICBpZiAobWlzc2VkID4gMCAmJiByZWFzb24gPT09ICd0aW1lb3V0JykgewogICAgICAgICAgICAgICAgYXZnUSA9IE1hdGgubWF4KDAsIGF2Z1EgLSBtaXNzZWQgKiAxMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGxldCBjbHMgPSAnJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChyZWFzb24gPT09ICdjb21wbGV0ZScpIHsKICAgICAgICAgICAgICAgIGlmIChhdmdRID49IDYwICYmIEcuY2VvVXNlZCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIHRpdGxlLnRleHRDb250ZW50ID0gJ/Cfj4YgRXhjZWxsZW50IENoYWlyISc7CiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS50ZXh0Q29udGVudCA9IGBBbGwgNSBkZWNpc2lvbnMgY29tcGxldGVkIHdpdGggJHtNYXRoLnJvdW5kKGF2Z1EpfSUgYXZlcmFnZSBxdWFsaXR5LiBPdXRzdGFuZGluZyBmYWNpbGl0YXRpb24g4oCUIHRoZSBjb21taXR0ZWUgdHJ1c3RzIHlvdXIgbGVhZGVyc2hpcCFgOwogICAgICAgICAgICAgICAgICAgIGNscyA9ICd3aW4nOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChhdmdRID49IDUwKSB7CiAgICAgICAgICAgICAgICAgICAgdGl0bGUudGV4dENvbnRlbnQgPSAn4pyTIE1lZXRpbmcgQ29tcGxldGVkJzsKICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLnRleHRDb250ZW50ID0gYEFsbCBpdGVtcyBkZWNpZGVkIHdpdGggJHtNYXRoLnJvdW5kKGF2Z1EpfSUgYXZlcmFnZSBxdWFsaXR5LiAke0cuY2VvVXNlZCA+IDAgPyAnQ0VPIGludGVydmVudGlvbiBub3RlZC4nIDogJ1NvbGlkIHdvcmshJ30gVGVhbSB3aWxsIG1vc3RseSBidXkgaW4uYDsKICAgICAgICAgICAgICAgICAgICBjbHMgPSAncGFydGlhbCc7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRpdGxlLnRleHRDb250ZW50ID0gJ/Cfk4sgRmluaXNoZWQsIEJ1dC4uLic7CiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS50ZXh0Q29udGVudCA9IGBHb3QgdGhyb3VnaCB0aGUgYWdlbmRhLCBidXQgb25seSAke01hdGgucm91bmQoYXZnUSl9JSBhdmVyYWdlIHF1YWxpdHkuIEV4cGVjdCBwdXNoYmFjayDigJQgdG9vIHJ1c2hlZCBvciBjb250ZW50aW91cy5gOwogICAgICAgICAgICAgICAgICAgIGNscyA9ICdwYXJ0aWFsJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChyZWFzb24gPT09ICdleHBsb3Npb24nKSB7CiAgICAgICAgICAgICAgICB0aXRsZS50ZXh0Q29udGVudCA9ICfwn5KlIE1lZXRpbmcgRXhwbG9kZWQnOwogICAgICAgICAgICAgICAgbWVzc2FnZS50ZXh0Q29udGVudCA9ICdUZW5zaW9ucyBib2lsZWQgb3Zlci4gVGhlIG1lZXRpbmcgY29sbGFwc2VkIGluIGNoYW9zLiBObyBkZWNpc2lvbnMgbWFkZS4nOwogICAgICAgICAgICAgICAgY2xzID0gJ2xvc2UnOwogICAgICAgICAgICB9IGVsc2UgaWYgKHJlYXNvbiA9PT0gJ2V4aGF1c3Rpb24nKSB7CiAgICAgICAgICAgICAgICB0aXRsZS50ZXh0Q29udGVudCA9ICfwn5ipIEVuZXJneSBHb25lJzsKICAgICAgICAgICAgICAgIG1lc3NhZ2UudGV4dENvbnRlbnQgPSAnVGhlIHJvb20gcmFuIG91dCBvZiBzdGVhbS4gRXZlcnlvbmUgZ2F2ZSB1cC4nOwogICAgICAgICAgICAgICAgY2xzID0gJ2xvc2UnOwogICAgICAgICAgICB9IGVsc2UgaWYgKHJlYXNvbiA9PT0gJ3RpbWVvdXQnKSB7CiAgICAgICAgICAgICAgICB0aXRsZS50ZXh0Q29udGVudCA9ICfij7AgVGltZSBFeHBpcmVkJzsKICAgICAgICAgICAgICAgIG1lc3NhZ2UudGV4dENvbnRlbnQgPSBgT25seSAke2RvbmV9LzUgZGVjaXNpb25zIG1hZGUgKCR7TWF0aC5yb3VuZChhdmdRKX0lIGF2ZyBxdWFsaXR5KS4gJHttaXNzZWR9IGl0ZW1zIGRlZmVycmVkLiBQYWNlIHlvdXJzZWxmIGJldHRlciFgOwogICAgICAgICAgICAgICAgY2xzID0gZG9uZSA+PSAzID8gJ3BhcnRpYWwnIDogJ2xvc2UnOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDYWxjdWxhdGUgYnVkZ2V0IG11bHRpcGxpZXIgYmFzZWQgb24gb3V0Y29tZQogICAgICAgICAgICBpZiAocmVhc29uID09PSAnZXhwbG9zaW9uJyB8fCByZWFzb24gPT09ICdleGhhdXN0aW9uJykgewogICAgICAgICAgICAgICAgbGFzdEJ1ZGdldE11bHRpcGxpZXIgPSAwLjg7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYXZnUSA+PSA2MCAmJiBkb25lID09PSA1KSB7CiAgICAgICAgICAgICAgICBsYXN0QnVkZ2V0TXVsdGlwbGllciA9IDEuMjU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYXZnUSA+PSA1MCAmJiBkb25lID49IDQpIHsKICAgICAgICAgICAgICAgIGxhc3RCdWRnZXRNdWx0aXBsaWVyID0gMS4xNTsKICAgICAgICAgICAgfSBlbHNlIGlmIChhdmdRID49IDM1ICYmIGRvbmUgPj0gMykgewogICAgICAgICAgICAgICAgbGFzdEJ1ZGdldE11bHRpcGxpZXIgPSAxLjA7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBsYXN0QnVkZ2V0TXVsdGlwbGllciA9IDAuOTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgc2NyZWVuLmNsYXNzTmFtZSA9ICdyZXN1bHQtc2NyZWVuIGFjdGl2ZSAnICsgY2xzOwogICAgICAgICAgICAKICAgICAgICAgICAgZ3JpZC5pbm5lckhUTUwgPSBgCiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJyZXN1bHQtY2FyZCAke2F2Z1EgPj0gNTUgPyAnZ29vZCcgOiBhdmdRIDwgMzUgPyAnYmFkJyA6ICcnfSI+PGRpdiBjbGFzcz0ici12YWx1ZSI+JHtNYXRoLnJvdW5kKGF2Z1EpfSU8L2Rpdj48ZGl2IGNsYXNzPSJyLWxhYmVsIj5BdmcgUXVhbGl0eTwvZGl2PjwvZGl2PgogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0icmVzdWx0LWNhcmQgJHtkb25lID09PSA1ID8gJ2dvb2QnIDogZG9uZSA8IDMgPyAnYmFkJyA6ICcnfSI+PGRpdiBjbGFzcz0ici12YWx1ZSI+JHtkb25lfS81PC9kaXY+PGRpdiBjbGFzcz0ici1sYWJlbCI+RGVjaWRlZDwvZGl2PjwvZGl2PgogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0icmVzdWx0LWNhcmQgJHtHLmNlb1VzZWQgPT09IDAgPyAnZ29vZCcgOiAnYmFkJ30iPjxkaXYgY2xhc3M9InItdmFsdWUiPiR7Ry5jZW9Vc2VkfTwvZGl2PjxkaXYgY2xhc3M9InItbGFiZWwiPkNFTyBDYWxsczwvZGl2PjwvZGl2PgogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0icmVzdWx0LWNhcmQiPjxkaXYgY2xhc3M9InItdmFsdWUiPiR7Ry5jb25mbGljdENvdW50fTwvZGl2PjxkaXYgY2xhc3M9InItbGFiZWwiPkNvbmZsaWN0czwvZGl2PjwvZGl2PgogICAgICAgICAgICBgOwogICAgICAgICAgICAKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dhbWUtc2NyZWVuJykuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHZhciBsYXN0QnVkZ2V0TXVsdGlwbGllciA9IDEuMDsKICAgICAgICAKICAgICAgICBmdW5jdGlvbiByZXNldEdhbWUoKSB7IAogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVzdWx0LXNjcmVlbicpLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOyAKICAgICAgICAgICAgc3RhcnRHYW1lKCk7IAogICAgICAgIH0KICAgICAgICAKICAgICAgICBmdW5jdGlvbiBzZW5kUmVzdWx0VG9QYXJlbnQoKSB7CiAgICAgICAgICAgIC8vIFNlbmQgcmVzdWx0IHRvIHBhcmVudCB3aW5kb3cKICAgICAgICAgICAgaWYgKHdpbmRvdy5wYXJlbnQgIT09IHdpbmRvdykgewogICAgICAgICAgICAgICAgd2luZG93LnBhcmVudC5wb3N0TWVzc2FnZSh7CiAgICAgICAgICAgICAgICAgICAgdHlwZTogJ2NvbW1pdHRlZUNoYW9zRG9uZScsCiAgICAgICAgICAgICAgICAgICAgYnVkZ2V0TXVsdGlwbGllcjogbGFzdEJ1ZGdldE11bHRpcGxpZXIKICAgICAgICAgICAgICAgIH0sICcqJyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZnVuY3Rpb24gbG9nKHRleHQsIHR5cGUgPSAnJykgeyAKICAgICAgICAgICAgY29uc3QgbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdldmVudC1sb2cnKTsKICAgICAgICAgICAgY29uc3QgaSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOyAKICAgICAgICAgICAgaS5jbGFzc05hbWUgPSAnZXZlbnQtaXRlbSAnICsgdHlwZTsgCiAgICAgICAgICAgIGkudGV4dENvbnRlbnQgPSB0ZXh0OyAKICAgICAgICAgICAgbC5pbnNlcnRCZWZvcmUoaSwgbC5maXJzdENoaWxkKTsgCiAgICAgICAgICAgIHdoaWxlIChsLmNoaWxkcmVuLmxlbmd0aCA+IDMpIGwucmVtb3ZlQ2hpbGQobC5sYXN0Q2hpbGQpOyAKICAgICAgICB9CiAgICA8L3NjcmlwdD4KPC9ib2R5Pgo8L2h0bWw+Cg==";
    
    function showBudgetMeeting() {
        showPhase('budget-meeting');
    }
    
    // Track which meeting is active
    var currentMeetingType = 'year1';
    
    function startCommitteeChaos() {
        currentMeetingType = 'year1';
        var overlay = document.getElementById('cc-overlay');
        var iframe = document.getElementById('cc-iframe');
        
        // Set the iframe source to the base64-encoded mini-game
        iframe.src = 'data:text/html;base64,' + CC_GAME_BASE64;
        
        // Show the overlay
        overlay.classList.add('active');
    }
    
    // Year 2 meeting functions
    function showYear2BudgetMeeting() {
        showPhase('year2-budget-meeting');
    }
    
    function startYear2CommitteeChaos() {
        currentMeetingType = 'year2';
        var overlay = document.getElementById('cc-overlay');
        var iframe = document.getElementById('cc-iframe');
        
        // Set the iframe source to the base64-encoded mini-game
        iframe.src = 'data:text/html;base64,' + CC_GAME_BASE64;
        
        // Show the overlay
        overlay.classList.add('active');
    }
    
    function continueToYear2() {
        // If there are no active projects at the start of Year 2, skip directly to results
        if (gameState.activeProjects.length === 0) {
            showResults();
            return;
        }
        
        // Continue to Q5 (Year 2) - cockpit will be shown after projects are updated
        renderQuarterlyReview();
    }
    
    // ============================================
    // YEAR 1 END PROJECT SELECTION (Mid-Year Refresh)
    // ============================================
    
    const year1EndProjectTemplates = [
        { 
            archetype: 'quick_win',
            names: ['SmartDoorbell Mini', 'Budget Motion Sensor', 'LED Status Light Kit'],
            descs: ['Entry-level doorbell camera targeting first-time buyers. Simplified features, aggressive price point. Can leverage existing manufacturing.', 
                    'Low-cost PIR sensor optimised for indoor use. Value engineering from existing sensor line. Quick time to market.',
                    'Retrofit kit adding smart LED indicators to existing sensors. Low development cost, high margin accessory.'],
            budgetRange: [1.5, 3.0], baseSuccess: 0.75, 
            scores: { technical: 2, marketsize: 4, strategic: 3, team: 4, capability: 5, ip: 2, platform: 2, sustainability: 2, newmarket: 2, geographic: 3, competitive: 4, devcost: 2, roi: 4, speed: 5, risk: 2 },
            quarterNarratives: { good: ['Quick progress.', 'On track for launch.'], bad: ['Minor delays.', 'Quality issues being addressed.'] },
            outcomeNarrative: { success: 'Fast execution delivered quick market entry.', failure: 'Rushed development led to quality issues.' }
        },
        { 
            archetype: 'market_response',
            names: ['Competitor Response Pack', 'Feature Parity Update', 'Value Line Extension'],
            descs: ['Rapid response to Xiaomi\'s latest launch. Feature matching with ShieldTech quality. Defensive market positioning.',
                    'Update to match competitor features announced at CES. Maintaining competitive relevance in premium segment.',
                    'Extended product line addressing mid-market gap identified by sales team. Quick win from existing platform.'],
            budgetRange: [2.5, 4.5], baseSuccess: 0.70,
            scores: { technical: 3, marketsize: 4, strategic: 4, team: 4, capability: 4, ip: 2, platform: 3, sustainability: 2, newmarket: 2, geographic: 3, competitive: 5, devcost: 3, roi: 3, speed: 4, risk: 3 },
            quarterNarratives: { good: ['Competitive analysis complete.', 'Features on track.'], bad: ['Scope creeping.', 'Competitor moved again.'] },
            outcomeNarrative: { success: 'Maintained market position against competitive threat.', failure: 'Competitor outpaced our response.' }
        },
        { 
            archetype: 'capability_build',
            names: ['AI Training Pipeline', 'Edge Compute Framework', 'Cloud Analytics Platform'],
            descs: ['Internal tooling for model training and deployment. Accelerates all AI-enabled products. Foundation for future innovation.',
                    'Framework for running models on device. Reduces cloud costs, improves latency. Platform play for premium products.',
                    'Analytics backend enabling new subscription services. Monetisation path for existing customer base.'],
            budgetRange: [3.0, 5.5], baseSuccess: 0.65,
            scores: { technical: 5, marketsize: 3, strategic: 4, team: 4, capability: 3, ip: 4, platform: 5, sustainability: 3, newmarket: 2, geographic: 2, competitive: 3, devcost: 4, roi: 3, speed: 2, risk: 3 },
            quarterNarratives: { good: ['Architecture validated.', 'Team ramping up.'], bad: ['Technical challenges emerging.', 'Integration complexity.'] },
            outcomeNarrative: { success: 'Platform investment paying dividends across product line.', failure: 'Capability build took longer than expected.' }
        },
        { 
            archetype: 'partnership_opportunity',
            names: ['Builder Integration Module', 'Reliance Retail Bundle', 'Insurance Partnership Kit'],
            descs: ['Pre-integrated solution for housing developers. Reduces installation complexity. B2B revenue stream.',
                    'Co-branded bundle for Reliance Retail distribution. Volume opportunity with margin trade-off.',
                    'Sensor kit designed for insurance premium discounts. New channel, recurring revenue model.'],
            budgetRange: [2.0, 4.0], baseSuccess: 0.60,
            scores: { technical: 3, marketsize: 4, strategic: 4, team: 3, capability: 4, ip: 2, platform: 3, sustainability: 2, newmarket: 4, geographic: 4, competitive: 3, devcost: 3, roi: 4, speed: 3, risk: 3 },
            quarterNarratives: { good: ['Partner aligned.', 'Integration progressing.'], bad: ['Partner priorities shifting.', 'Terms being renegotiated.'] },
            outcomeNarrative: { success: 'Partnership opened valuable new channel.', failure: 'Partnership terms didn\'t materialise as expected.' }
        },
        {
            archetype: 'tech_adjacency',
            names: ['Health Monitoring Add-on', 'Energy Management Module', 'Air Quality Sensor'],
            descs: ['Wellness features leveraging existing sensors. Detects sleep patterns, activity levels. Health-tech adjacency play.',
                    'Smart energy monitoring with solar integration. Growing segment in sustainable homes. New revenue stream.',
                    'Indoor air quality monitoring with smart ventilation control. Premium feature for health-conscious customers.'],
            budgetRange: [3.5, 6.0], baseSuccess: 0.55,
            scores: { technical: 4, marketsize: 3, strategic: 3, team: 3, capability: 3, ip: 3, platform: 3, sustainability: 4, newmarket: 5, geographic: 3, competitive: 3, devcost: 4, roi: 3, speed: 2, risk: 4 },
            quarterNarratives: { good: ['Technology validated.', 'User research positive.'], bad: ['Regulatory complexity.', 'Market adoption uncertain.'] },
            outcomeNarrative: { success: 'Adjacent market entry successful—new growth vector.', failure: 'Market wasn\'t ready for the adjacency play.' }
        }
    ];
    
    // State for Year 1 End selection
    let year1EndProjectPool = [];
    let year1EndSelectedProjects = [];
    let year1EndAvailableBudget = 0;
    
    function generateYear1EndProjectPool() {
        const pool = [];
        const usedNames = new Set();
        const effects = calculateCommitteeEffects();
        let projectId = 50; // Start from 50 to avoid collision with Year 1 and Year 2 projects
        
        // Shuffle templates and pick a subset
        const shuffled = shuffleArray([...year1EndProjectTemplates]);
        const templatesToUse = shuffled.slice(0, 4); // Use 4 templates to generate ~5-7 projects
        
        for (const template of templatesToUse) {
            const count = 1 + Math.floor(Math.random() * 2); // 1-2 projects per template
            const indices = shuffleArray([...Array(template.names.length).keys()]).slice(0, count);
            
            for (const i of indices) {
                const name = template.names[i];
                if (usedNames.has(name)) continue;
                usedNames.add(name);
                
                const budgetRaw = template.budgetRange[0] + Math.random() * (template.budgetRange[1] - template.budgetRange[0]);
                const budget = Math.round(budgetRaw * 10) / 10;
                let successProb = template.baseSuccess + (Math.random() * 0.1 - 0.05);
                
                // Map Year 1 End archetypes to existing archetype effects where applicable
                const archetypeMapping = {
                    'quick_win': 'conventionalWinner',
                    'market_response': 'competitive',
                    'capability_build': 'slowBurner',
                    'partnership_opportunity': 'pivotSuccess',
                    'tech_adjacency': 'hiddenGem'
                };
                const mappedKey = archetypeMapping[template.archetype];
                if (mappedKey && effects[mappedKey]) {
                    successProb *= effects[mappedKey];
                }
                
                // Use equivalent base archetypes for helper functions
                const baseArchetypeMapping = {
                    'quick_win': 'conventional_winner',
                    'market_response': 'competitive_casualty',
                    'capability_build': 'slow_burner',
                    'partnership_opportunity': 'pivot_success',
                    'tech_adjacency': 'hidden_gem'
                };
                const baseArchetype = baseArchetypeMapping[template.archetype] || 'conventional_winner';
                
                const project = {
                    id: 'y1end-' + projectId,
                    numId: projectId,
                    name: name,
                    desc: template.descs[i],
                    shortDesc: template.descs[i],
                    tagline: getYear1EndTagline(template.archetype),
                    fullDesc: generateYear1EndFullDesc(name, template.descs[i], template.archetype),
                    marketContext: getYear1EndMarketContext({ archetype: template.archetype }),
                    capabilityFit: getYear1EndCapabilityFit({ archetype: template.archetype }),
                    risks: getYear1EndRisks({ archetype: template.archetype }),
                    teamNote: getYear1EndTeamNote({ archetype: template.archetype }),
                    teamDetails: generateTeamDetails(name, baseArchetype, template.scores),
                    strategicBuckets: getStrategicBucketsForArchetype(template.archetype),
                    trl: getTRL(baseArchetype),
                    ipPosition: getIPPosition(baseArchetype, name),
                    ipAnalysis: generateYear1EndIPAnalysis(template.archetype),
                    competitors: getYear1EndCompetitors(template.archetype),
                    developmentCosts: getDevelopmentCosts(budget, baseArchetype),
                    milestones: getMilestones(baseArchetype, budget),
                    financials: generateFinancials(budget, baseArchetype),
                    synergies: generateYear1EndSynergies(name, template.archetype),
                    archetype: template.archetype,
                    baseArchetype: baseArchetype,
                    budget: budget,
                    successProb: Math.max(0.05, Math.min(0.95, successProb)),
                    baseSuccessRate: Math.round(successProb * 100),
                    scores: { ...template.scores },
                    criteriaScores: template.scores,
                    quarterNarratives: template.quarterNarratives,
                    outcomeNarrative: template.outcomeNarrative,
                    timeline: 4 + Math.floor(Math.random() * 3), // 4-6 quarters for Year 1 End projects (run Q5-Q10)
                    status: 'proposed',
                    currentQuarter: 0,
                    spentBudget: 0,
                    quarterlyUpdates: [],
                    decision: null,
                    outcome: null,
                    playerScores: {},
                    committeeScores: {},
                    lead: assignProjectLead(baseArchetype, template.scores),
                    isYear1EndProject: true
                };
                
                pool.push(project);
                projectId++;
            }
        }
        
        return pool;
    }
    
    function generateYear1EndFullDesc(name, shortDesc, archetype) {
        const expansions = {
            'quick_win': `${shortDesc}\n\nThis opportunity emerged from Year 1 customer feedback and sales team input. The market window is 6-9 months before competitors are likely to respond. Development risk is low as it leverages proven technology and existing manufacturing relationships. Success depends on execution speed and maintaining quality standards.`,
            'market_response': `${shortDesc}\n\nCompetitive intelligence from Year 1 indicates this defensive move is necessary to protect market share. The project responds to specific competitor features that customers have been asking about. Timing is critical—delayed response could result in customer defection. The technical approach uses proven methods to minimise risk.`,
            'capability_build': `${shortDesc}\n\nThis strategic investment addresses capability gaps identified during Year 1. While not directly customer-facing, it will accelerate future product development and reduce technical debt. ROI is measured in development velocity and cost reduction across the portfolio rather than direct revenue.`,
            'partnership_opportunity': `${shortDesc}\n\nPartnership discussions initiated during Year 1 have matured to the point where product development can begin. The partner brings channel access and market knowledge while ShieldTech contributes technology and product expertise. Terms are largely agreed; execution is the primary risk.`,
            'tech_adjacency': `${shortDesc}\n\nCustomer requests during Year 1 revealed demand for adjacent capabilities. This project extends ShieldTech's technology into a new use case with strong synergies to the core business. Market validation is partial—further customer discovery is built into the development plan.`
        };
        return expansions[archetype] || shortDesc;
    }
    
    function generateYear1EndIPAnalysis(archetype) {
        const ipAnalyses = {
            'quick_win': {
                shieldtechIP: 'Leverages existing ShieldTech patents on sensor integration and cloud connectivity.',
                competitorIP: 'Clear field—no blocking patents identified in target feature set.',
                fto: 'Clear',
                ftoRisk: 'Low'
            },
            'market_response': {
                shieldtechIP: 'May file defensive patents on implementation approach.',
                competitorIP: 'Competitor has patents in adjacent areas. Design-around strategy in place.',
                fto: 'Requires review',
                ftoRisk: 'Medium'
            },
            'capability_build': {
                shieldtechIP: 'Platform architecture may generate valuable trade secrets and patents.',
                competitorIP: 'Open source components used where available. Some proprietary integrations.',
                fto: 'Clear for internal use',
                ftoRisk: 'Low'
            },
            'partnership_opportunity': {
                shieldtechIP: 'Joint IP arrangement with partner. ShieldTech retains core technology rights.',
                competitorIP: 'Partner provides IP indemnification in target channel.',
                fto: 'Partner-dependent',
                ftoRisk: 'Medium'
            },
            'tech_adjacency': {
                shieldtechIP: 'New application of existing IP. May generate adjacent patents.',
                competitorIP: 'New market—IP landscape less crowded than core security.',
                fto: 'Initial review positive',
                ftoRisk: 'Low-Medium'
            }
        };
        return ipAnalyses[archetype] || { shieldtechIP: 'Standard IP position', competitorIP: 'No significant concerns', fto: 'Review pending', ftoRisk: 'Unknown' };
    }
    
    function getYear1EndCompetitors(archetype) {
        const competitorSets = {
            'quick_win': [
                { name: 'Xiaomi', position: 'Price leader in entry segment', threat: 'Medium' },
                { name: 'Godrej', position: 'Established brand, slower innovation', threat: 'Low' }
            ],
            'market_response': [
                { name: 'Target Competitor', position: 'Feature originator, market leader', threat: 'High' },
                { name: 'Fast Followers', position: 'May also respond quickly', threat: 'Medium' }
            ],
            'capability_build': [
                { name: 'Internal Alternative', position: 'Continue with current approach', threat: 'Low' },
                { name: 'Build vs Buy', position: 'Third-party platform options exist', threat: 'Low' }
            ],
            'partnership_opportunity': [
                { name: 'Partner Alternatives', position: 'Partner could work with competitors', threat: 'Medium' },
                { name: 'Direct Approach', position: 'Could build channel directly (slower)', threat: 'Low' }
            ],
            'tech_adjacency': [
                { name: 'Segment Specialists', position: 'Focused players in adjacent market', threat: 'Medium' },
                { name: 'Tech Giants', position: 'May enter if market proves out', threat: 'Medium' }
            ]
        };
        return competitorSets[archetype] || [{ name: 'Various', position: 'Standard competitive landscape', threat: 'Medium' }];
    }
    
    function generateYear1EndSynergies(name, archetype) {
        const synergySets = {
            'quick_win': {
                technical: ['Shared manufacturing', 'Common firmware base', 'Existing QA processes'],
                commercial: ['Same channel partners', 'Cross-sell to existing customers', 'Unified support'],
                strategic: ['Strengthens entry-level lineup', 'Defends against price erosion']
            },
            'market_response': {
                technical: ['Leverages existing platform', 'OTA update infrastructure'],
                commercial: ['Retains at-risk customers', 'Sales team requesting'],
                strategic: ['Maintains competitive position', 'Signals market responsiveness']
            },
            'capability_build': {
                technical: ['Accelerates all product development', 'Reduces technical debt'],
                commercial: ['Enables faster feature delivery', 'Improves reliability'],
                strategic: ['Platform for future growth', 'Attracts engineering talent']
            },
            'partnership_opportunity': {
                technical: ['Integration with partner systems', 'Shared development where aligned'],
                commercial: ['New channel access', 'Partner marketing support'],
                strategic: ['Diversifies revenue', 'Reduces channel concentration risk']
            },
            'tech_adjacency': {
                technical: ['Core technology transfers', 'Shared cloud infrastructure'],
                commercial: ['Upsell to existing customers', 'New customer segment'],
                strategic: ['Growth beyond core market', 'Hedge against market saturation']
            }
        };
        return synergySets[archetype] || { technical: ['Standard synergies'], commercial: ['Cross-sell potential'], strategic: ['Portfolio diversification'] };
    }
    
    function getYear1EndTagline(archetype) {
        const taglines = {
            'quick_win': 'Fast time-to-market opportunity',
            'market_response': 'Competitive response initiative',
            'capability_build': 'Strategic capability investment',
            'partnership_opportunity': 'Channel expansion opportunity',
            'tech_adjacency': 'Adjacent market exploration'
        };
        return taglines[archetype] || 'Mid-year opportunity';
    }
    
    function showYear1EndProjectSelection() {
        // Show the phase first so the DOM element is accessible
        showPhase('year1-end-selection');
        
        // Always generate fresh project pool for Year 1 End
        year1EndProjectPool = generateYear1EndProjectPool();
        year1EndSelectedProjects = [];
        
        // Calculate ongoing project needs (remaining costs for active projects)
        const ongoingProjectNeeds = gameState.activeProjects.reduce((sum, p) => {
            const remaining = (p.budget || 0) - (p.spentBudget || 0);
            return sum + Math.max(0, remaining);
        }, 0);
        
        // Calculate what was spent on completed projects (this money is gone)
        const completedProjectSpending = (gameState.completedProjects || []).reduce((sum, p) => {
            return sum + (p.spentBudget || 0);
        }, 0);
        
        // Calculate what was spent on killed projects (partial spending before kill)
        const killedProjectSpending = (gameState.killedProjects || []).reduce((sum, p) => {
            return sum + (p.spentBudget || 0);
        }, 0);
        
        // Total committed = ongoing needs + already spent on completed + killed
        const totalCommitted = ongoingProjectNeeds + completedProjectSpending + killedProjectSpending;
        
        // Available = annual budget - all committed spending
        year1EndAvailableBudget = Math.max(0, gameState.maxBudget - totalCommitted);
        
        // Ensure at least a small refresh budget for gameplay (10% of max, reduced from 15%)
        const minRefreshBudget = gameState.maxBudget * 0.10;
        if (year1EndAvailableBudget < minRefreshBudget) {
            year1EndAvailableBudget = minRefreshBudget;
        }
        
        // Render the Year 1 End project grid
        renderYear1EndProjectGrid();
        updateYear1EndBudgetDisplay();
    }
    
    let year1EndLastRenderTime = 0;
    function renderYear1EndProjectGrid() {
        // Debounce rapid re-renders
        const now = Date.now();
        if (now - year1EndLastRenderTime < 50) return;
        year1EndLastRenderTime = now;
        
        const grid = document.getElementById('year1end-project-grid');
        
        if (!grid) {
            console.error('Could not find year1end-project-grid element!');
            return;
        }
        
        if (year1EndProjectPool.length === 0) {
            grid.innerHTML = '<p style="text-align: center; color: var(--gray-500); padding: 20px;">No new projects available.</p>';
            return;
        }
        
        grid.innerHTML = year1EndProjectPool.map((project, index) => {
            const isSelected = year1EndSelectedProjects.includes(project.id);
            const canAfford = project.budget <= year1EndAvailableBudget || isSelected;
            const isLocked = !isSelected && !canAfford;
            
            const bucketsHtml = (project.strategicBuckets || []).map(bucket => `
                <span style="display: inline-block; background: ${bucket.color}20; color: ${bucket.color}; padding: 2px 8px; border-radius: 10px; font-size: 0.7em; font-weight: 500;">
                    ${bucket.icon} ${bucket.name}
                </span>
            `).join('');
            
            // Generate key metrics
            const successRate = project.baseSuccessRate || Math.round(project.successProb * 100);
            const riskLevel = project.scores?.risk <= 2 ? 'Low' : project.scores?.risk <= 3 ? 'Medium' : 'High';
            const riskColor = project.scores?.risk <= 2 ? 'var(--success)' : project.scores?.risk <= 3 ? 'var(--warning)' : 'var(--danger)';
            
            // Get lead info if available
            const leadHtml = project.lead ? `
                <div style="display: flex; align-items: center; gap: 8px; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--gray-200);">
                    <div style="width: 28px; height: 28px; border-radius: 50%; background: ${project.lead.avatarColor}; color: white; display: flex; align-items: center; justify-content: center; font-size: 0.7em; font-weight: 600;">${project.lead.initials}</div>
                    <div style="font-size: 0.8em;">
                        <div style="font-weight: 600; color: var(--gray-700);">${project.lead.name}</div>
                        <div style="color: var(--gray-500);">${project.lead.role}</div>
                    </div>
                </div>
            ` : '';
            
            return `
                <div class="project-card ${isSelected ? 'selected' : ''} ${isLocked ? 'locked' : ''}" data-id="${project.id}">
                    <div class="project-header">
                        <span class="project-name">${project.name}</span>
                        <span class="project-budget">$${project.budget}M </span>
                    </div>
                    <div class="project-tagline">${project.tagline || ''}</div>
                    <div style="margin: 8px 0;">${bucketsHtml}</div>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px; font-size: 0.85em; flex-wrap: wrap;">
                        <span style="background: var(--gray-100); padding: 4px 8px; border-radius: 4px;">
                            ⏱️ <strong>${project.timeline}Q</strong> timeline
                        </span>
                        <span style="background: var(--primary-lighter); padding: 4px 8px; border-radius: 4px;">
                            📊 <strong>${successRate}%</strong> success rate
                        </span>
                        <span style="background: ${riskColor}20; color: ${riskColor}; padding: 4px 8px; border-radius: 4px;">
                            ⚡ <strong>${riskLevel}</strong> risk
                        </span>
                    </div>
                    <div class="project-desc">${project.shortDesc || project.desc}</div>
                    ${leadHtml}
                    <div class="project-card-actions">
                        <button class="project-learn-more" onclick="event.stopPropagation(); openYear1EndProjectModal('${project.id}')">Learn More</button>
                        <button class="project-select-btn ${isSelected ? 'selected' : ''}" 
                                onclick="event.stopPropagation(); toggleYear1EndProject('${project.id}')" 
                                ${isLocked ? 'disabled' : ''}>
                            ${isSelected ? '✓ Selected' : isLocked ? 'Over Budget' : 'Select'}
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    // Helper function to assign strategic buckets based on archetype
    function getStrategicBucketsForArchetype(archetype) {
        const bucketMappings = {
            'quick_win': [
                { id: 'defend-metro', name: 'Defend Metro Leadership', icon: '🛡️', color: '#2563eb' }
            ],
            'market_response': [
                { id: 'defend-metro', name: 'Defend Metro Leadership', icon: '🛡️', color: '#2563eb' }
            ],
            'capability_build': [
                { id: 'ai-first', name: 'AI-First Products', icon: '🤖', color: '#dc2626' }
            ],
            'partnership_opportunity': [
                { id: 'recurring-revenue', name: 'Recurring Revenue', icon: '💳', color: '#7c3aed' }
            ],
            'tech_adjacency': [
                { id: 'ai-first', name: 'AI-First Products', icon: '🤖', color: '#dc2626' }
            ]
        };
        return bucketMappings[archetype] || [];
    }
    
    // Modal for Year 1 End projects
    function openYear1EndProjectModal(projectId) {
        const project = year1EndProjectPool.find(p => p.id === projectId);
        if (!project) return;
        
        // Store current context so the modal button knows which pool to use
        gameState.currentModalProject = projectId;
        gameState.currentModalContext = 'year1end';
        
        document.getElementById('project-modal-name').textContent = project.name;
        document.getElementById('project-modal-tagline').textContent = project.tagline || '';
        document.getElementById('project-modal-budget').textContent = `$${project.budget}M`;
        document.getElementById('project-modal-desc').textContent = project.fullDesc || project.desc;
        document.getElementById('project-modal-market').textContent = project.marketContext || getYear1EndMarketContext(project);
        document.getElementById('project-modal-capability').textContent = project.capabilityFit || getYear1EndCapabilityFit(project);
        document.getElementById('project-modal-team').textContent = project.teamNote || getYear1EndTeamNote(project);
        
        // Strategic buckets
        const bucketsEl = document.getElementById('project-modal-buckets');
        if (bucketsEl) {
            bucketsEl.innerHTML = (project.strategicBuckets || []).map(bucket => `
                <span style="display: inline-block; background: ${bucket.color}20; color: ${bucket.color}; padding: 4px 12px; border-radius: 15px; font-size: 0.85em; font-weight: 500; margin-right: 8px;">
                    ${bucket.icon} ${bucket.name}
                </span>
            `).join('');
        }
        
        // Development costs - use generated data if available
        const devCosts = project.developmentCosts || {};
        document.getElementById('project-modal-dev-costs').innerHTML = `
            <div class="dev-costs-grid">
                <div class="dev-cost-item total">
                    <div class="dev-cost-amount">$${devCosts.total || project.budget}M </div>
                    <div class="dev-cost-label">Total Budget</div>
                </div>
                <div class="dev-cost-item">
                    <div class="dev-cost-amount">$${devCosts.personnel?.amount || (project.budget * 0.5).toFixed(1)}M </div>
                    <div class="dev-cost-label">Personnel</div>
                    <div class="dev-cost-pct">${devCosts.personnel?.pct || 50}%</div>
                </div>
                <div class="dev-cost-item">
                    <div class="dev-cost-amount">$${devCosts.hardware?.amount || (project.budget * 0.2).toFixed(1)}M </div>
                    <div class="dev-cost-label">Hardware/Components</div>
                    <div class="dev-cost-pct">${devCosts.hardware?.pct || 20}%</div>
                </div>
                <div class="dev-cost-item">
                    <div class="dev-cost-amount">$${devCosts.software?.amount || (project.budget * 0.15).toFixed(1)}M </div>
                    <div class="dev-cost-label">Software/Tools</div>
                    <div class="dev-cost-pct">${devCosts.software?.pct || 15}%</div>
                </div>
                <div class="dev-cost-item">
                    <div class="dev-cost-amount">$${devCosts.external?.amount || (project.budget * 0.15).toFixed(1)}M </div>
                    <div class="dev-cost-label">External/Other</div>
                    <div class="dev-cost-pct">${devCosts.external?.pct || 15}%</div>
                </div>
            </div>
        `;
        
        // Milestones - use generated data if available
        const milestones = project.milestones?.milestones || project.milestones?.phases || [];
        if (milestones.length > 0) {
            document.getElementById('project-modal-milestones').innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    ${milestones.map((m, i) => `
                        <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--gray-50); border-radius: 8px; border-left: 3px solid var(--primary);">
                            <span style="font-size: 1.2em;">${i === milestones.length - 1 ? '✅' : '🎯'}</span>
                            <div style="flex: 1;">
                                <div style="font-weight: 600;">${m.phase || m.name || 'Phase ' + (i+1)}</div>
                                <div style="font-size: 0.85em; color: var(--gray-600);">
                                    ${m.quarters ? m.quarters : ''} ${m.duration ? '• ' + m.duration : ''} ${m.costAmount ? '• $' + m.costAmount + 'M' : ''}
                                </div>
                                ${m.deliverables ? `<div style="margin-top: 5px; font-size: 0.8em; color: var(--gray-500);">${m.deliverables.join(', ')}</div>` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        } else {
            document.getElementById('project-modal-milestones').innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--gray-50); border-radius: 8px; border-left: 3px solid var(--primary);">
                        <span style="font-size: 1.2em;">🎯</span>
                        <div>
                            <div style="font-weight: 600;">Q1-Q${Math.ceil(project.timeline/2)}: Development</div>
                            <div style="font-size: 0.85em; color: var(--gray-600);">Core development and validation</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--gray-50); border-radius: 8px; border-left: 3px solid var(--success);">
                        <span style="font-size: 1.2em;">✅</span>
                        <div>
                            <div style="font-weight: 600;">Q${project.timeline}: Launch</div>
                            <div style="font-size: 0.85em; color: var(--gray-600);">Market launch and commercialisation</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // TRL - use generated data if available
        const trl = project.trl || { current: 5, target: 8 };
        const trlHtml = [1,2,3,4,5,6,7,8,9].map(level => `
            <div style="flex: 1; height: 30px; display: flex; align-items: center; justify-content: center; 
                        background: ${level <= trl.current ? 'var(--primary)' : level <= trl.target ? 'var(--primary-lighter)' : 'var(--gray-200)'}; 
                        color: ${level <= trl.current ? 'white' : level <= trl.target ? 'var(--primary)' : 'var(--gray-400)'};
                        border-radius: 4px; font-weight: 600; font-size: 0.8em;">
                ${level}
            </div>
        `).join('');
        document.getElementById('project-modal-trl').innerHTML = `
            <div style="display: flex; gap: 4px; margin-bottom: 8px;">${trlHtml}</div>
            <div style="display: flex; gap: 20px; font-size: 0.85em; color: var(--gray-600);">
                <span>● Current: TRL ${trl.current}</span>
                <span>○ Target: TRL ${trl.target}</span>
            </div>
            ${trl.note ? `<p style="margin-top: 10px; font-size: 0.85em;">${trl.note}</p>` : ''}
        `;
        
        // IP - use generated data if available
        const ip = project.ipAnalysis || project.ipPosition || {};
        document.getElementById('project-modal-ip').innerHTML = `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                <div style="background: var(--gray-50); padding: 12px; border-radius: 8px;">
                    <div style="font-weight: 600; font-size: 0.8em; margin-bottom: 6px; color: var(--gray-700);">ShieldTech IP</div>
                    <p style="font-size: 0.8em; margin: 0;">${ip.shieldtechIP || ip.shieldtech || 'Standard IP position'}</p>
                </div>
                <div style="background: var(--gray-50); padding: 12px; border-radius: 8px;">
                    <div style="font-weight: 600; font-size: 0.8em; margin-bottom: 6px; color: var(--gray-700);">Competitor IP</div>
                    <p style="font-size: 0.8em; margin: 0;">${ip.competitorIP || ip.competitors || 'No significant concerns'}</p>
                </div>
            </div>
            <div style="padding: 8px 15px; border-radius: 8px; font-size: 0.85em; display: inline-block;
                        background: ${(ip.ftoRisk || '').toLowerCase().includes('high') ? 'var(--danger-light)' : (ip.ftoRisk || '').toLowerCase().includes('medium') ? 'var(--warning-light)' : 'var(--success-light)'};
                        color: ${(ip.ftoRisk || '').toLowerCase().includes('high') ? 'var(--danger)' : (ip.ftoRisk || '').toLowerCase().includes('medium') ? 'var(--warning)' : 'var(--success)'};">
                <strong>FTO:</strong> ${ip.fto || 'Review pending'} · ${ip.ftoRisk || 'Low'} Risk
            </div>
        `;
        
        // Competitors - use generated data
        const competitors = project.competitors || [];
        document.getElementById('project-modal-competitors').innerHTML = competitors.length > 0 ? `
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px;">
                ${competitors.map(c => `
                    <div style="background: var(--gray-50); padding: 12px; border-radius: 8px; 
                                border-left: 3px solid ${(c.threat || '').toLowerCase().includes('high') ? 'var(--danger)' : (c.threat || '').toLowerCase().includes('medium') ? 'var(--warning)' : 'var(--success)'};">
                        <div style="font-weight: 600; font-size: 0.85em; margin-bottom: 4px;">${c.name}</div>
                        <div style="font-size: 0.8em; color: var(--gray-600);">${c.position}</div>
                        <div style="font-size: 0.75em; color: ${(c.threat || '').toLowerCase().includes('high') ? 'var(--danger)' : (c.threat || '').toLowerCase().includes('medium') ? 'var(--warning)' : 'var(--success)'}; margin-top: 4px;">
                            Threat: ${c.threat || 'Medium'}
                        </div>
                    </div>
                `).join('')}
            </div>
        ` : '<p style="color: var(--gray-500);">Competitive analysis based on Year 1 market observations.</p>';
        
        // Synergies - use generated data
        const synergiesEl = document.getElementById('project-modal-synergies');
        if (synergiesEl) {
            const synergies = project.synergies || {};
            synergiesEl.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                    ${synergies.technical ? `
                        <div style="background: var(--primary-lighter); padding: 10px; border-radius: 8px;">
                            <div style="font-weight: 600; font-size: 0.8em; color: var(--primary); margin-bottom: 6px;">🔧 Technical</div>
                            <ul style="margin: 0; padding-left: 15px; font-size: 0.8em; color: var(--gray-600);">
                                ${synergies.technical.map(s => `<li>${s}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    ${synergies.commercial ? `
                        <div style="background: var(--success-light); padding: 10px; border-radius: 8px;">
                            <div style="font-weight: 600; font-size: 0.8em; color: var(--success); margin-bottom: 6px;">💼 Commercial</div>
                            <ul style="margin: 0; padding-left: 15px; font-size: 0.8em; color: var(--gray-600);">
                                ${synergies.commercial.map(s => `<li>${s}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    ${synergies.strategic ? `
                        <div style="background: var(--warning-light); padding: 10px; border-radius: 8px;">
                            <div style="font-weight: 600; font-size: 0.8em; color: var(--warning); margin-bottom: 6px;">🎯 Strategic</div>
                            <ul style="margin: 0; padding-left: 15px; font-size: 0.8em; color: var(--gray-600);">
                                ${synergies.strategic.map(s => `<li>${s}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        // Financials - use generated data
        const financialsEl = document.getElementById('project-modal-financials');
        if (financialsEl) {
            const fin = project.financials || {};
            financialsEl.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">
                    <div style="background: var(--gray-50); padding: 15px; border-radius: 8px;">
                        <div style="font-size: 1.3em; font-weight: 700; color: var(--primary);">$${fin.revenueY1 || (project.budget * 2.5).toFixed(1)}M </div>
                        <div style="font-size: 0.8em; color: var(--gray-500);">Est. Revenue (Y1)</div>
                    </div>
                    <div style="background: var(--gray-50); padding: 15px; border-radius: 8px;">
                        <div style="font-size: 1.3em; font-weight: 700; color: var(--success);">${fin.grossMargin || '40%'}</div>
                        <div style="font-size: 0.8em; color: var(--gray-500);">Gross Margin</div>
                    </div>
                    <div style="background: var(--gray-50); padding: 15px; border-radius: 8px;">
                        <div style="font-size: 1.3em; font-weight: 700; color: var(--warning);">${fin.paybackPeriod || (project.timeline + 2) + 'Q'}</div>
                        <div style="font-size: 0.8em; color: var(--gray-500);">Payback Period</div>
                    </div>
                </div>
            `;
        }
        
        // Team details - full rendering like original modal
        const teamDetailsEl = document.getElementById('project-modal-team-details');
        if (teamDetailsEl) {
            const teamDetails = project.teamDetails;
            
            if (teamDetails) {
                let teamHtml = '';
                
                // Project Lead - primary responsibility
                if (project.lead) {
                    teamHtml += '<div style="margin-bottom: 20px;">';
                    teamHtml += '<div style="margin-bottom: 10px;"><strong>🎯 Project Lead:</strong></div>';
                    teamHtml += renderLeadCard(project.lead);
                    teamHtml += '</div>';
                }
                
                // Team leads - using initials instead of images
                teamHtml += '<div style="margin-bottom: 15px;"><strong>👨‍💻 Supporting Team Leads:</strong></div>';
                teamHtml += '<div class="team-leads-grid" style="margin-bottom: 20px;">';
                teamDetails.leads.forEach(lead => {
                    const staff = lead.staffId ? findStaff(lead.staffId) : null;
                    if (staff) {
                        const initials = staff.name.split(' ').map(n => n[0]).join('');
                        teamHtml += `
                            <div class="team-lead-card">
                                <div class="team-lead-avatar" style="background: ${staff.avatarColor || '#003da5'}; color: white; font-weight: 600;">
                                    ${initials}
                                </div>
                                <div class="team-lead-info">
                                    <div class="team-lead-name">${staff.name}</div>
                                    <div class="team-lead-role">${lead.role}</div>
                                </div>
                            </div>
                        `;
                    } else {
                        teamHtml += `
                            <div class="team-lead-card team-lead-vacancy">
                                <div class="team-lead-avatar">?</div>
                                <div class="team-lead-info">
                                    <div class="team-lead-name">To Be Hired</div>
                                    <div class="team-lead-role">${lead.role}</div>
                                </div>
                            </div>
                        `;
                    }
                });
                teamHtml += '</div>';
                
                // Headcount
                const hc = teamDetails.headcount;
                teamHtml += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-bottom: 15px;">';
                teamHtml += `<div style="background: var(--info-light); padding: 10px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 1.2em; font-weight: 700; color: var(--info);">${hc.engineers}</div>
                    <div style="font-size: 0.75em; color: var(--gray-500);">Engineers</div>
                </div>`;
                teamHtml += `<div style="background: var(--info-light); padding: 10px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 1.2em; font-weight: 700; color: var(--info);">${hc.product}</div>
                    <div style="font-size: 0.75em; color: var(--gray-500);">Product</div>
                </div>`;
                teamHtml += `<div style="background: var(--info-light); padding: 10px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 1.2em; font-weight: 700; color: var(--info);">${hc.design || 1}</div>
                    <div style="font-size: 0.75em; color: var(--gray-500);">Design</div>
                </div>`;
                teamHtml += `<div style="background: var(--info-light); padding: 10px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 1.2em; font-weight: 700; color: var(--info);">${hc.qa}</div>
                    <div style="font-size: 0.75em; color: var(--gray-500);">QA</div>
                </div>`;
                teamHtml += `<div style="background: var(--primary-lighter); padding: 10px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 1.2em; font-weight: 700; color: var(--primary);">${hc.total}</div>
                    <div style="font-size: 0.75em; color: var(--gray-500);">Total FTE</div>
                </div>`;
                teamHtml += '</div>';
                
                // Skills needed
                teamHtml += '<div style="margin-bottom: 15px;"><strong>Key Skills Required:</strong></div>';
                teamHtml += '<div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px;">';
                teamDetails.skillsNeeded.forEach(skill => {
                    teamHtml += `<span style="background: var(--gray-100); padding: 6px 12px; border-radius: 15px; font-size: 0.85em;">${skill}</span>`;
                });
                teamHtml += '</div>';
                
                // Team assessment summary
                if (teamDetails.strengths.length > 0 || teamDetails.risks.length > 0) {
                    teamHtml += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">';
                    if (teamDetails.strengths.length > 0) {
                        teamHtml += '<div style="background: var(--success-light); padding: 12px; border-radius: 8px;">';
                        teamHtml += '<div style="font-weight: 600; color: var(--success); margin-bottom: 8px;">✓ Team Strengths</div>';
                        teamDetails.strengths.forEach(s => {
                            teamHtml += `<div style="font-size: 0.85em; color: var(--gray-600); margin-bottom: 4px;">• ${s}</div>`;
                        });
                        teamHtml += '</div>';
                    }
                    if (teamDetails.risks.length > 0) {
                        teamHtml += '<div style="background: var(--danger-light); padding: 12px; border-radius: 8px;">';
                        teamHtml += '<div style="font-weight: 600; color: var(--danger); margin-bottom: 8px;">⚠ Team Risks</div>';
                        teamDetails.risks.forEach(r => {
                            teamHtml += `<div style="font-size: 0.85em; color: var(--gray-600); margin-bottom: 4px;">• ${r}</div>`;
                        });
                        teamHtml += '</div>';
                    }
                    teamHtml += '</div>';
                }
                
                // Risk assessment at the end
                teamHtml += `<p style="font-size: 0.9em; color: var(--gray-600); margin-top: 15px;">
                    <strong>Project Risk Assessment:</strong> ${project.risks || getYear1EndRisks(project)}
                </p>`;
                
                teamDetailsEl.innerHTML = teamHtml;
            } else if (project.lead) {
                // Still show project lead even if no team details
                let leadHtml = '<div style="margin-bottom: 15px;">';
                leadHtml += '<div style="margin-bottom: 10px;"><strong>🎯 Project Lead:</strong></div>';
                leadHtml += renderLeadCard(project.lead);
                leadHtml += '</div>';
                leadHtml += `<p style="font-size: 0.9em; color: var(--gray-600);">
                    <strong>Risk Assessment:</strong> ${project.risks || getYear1EndRisks(project)}
                </p>`;
                teamDetailsEl.innerHTML = leadHtml;
            } else {
                teamDetailsEl.innerHTML = `
                    <p style="font-size: 0.9em; color: var(--gray-600);">
                        <strong>Risk Assessment:</strong> ${project.risks || getYear1EndRisks(project)}
                    </p>
                `;
            }
        }
        
        // Update select button in modal
        const isSelected = year1EndSelectedProjects.includes(projectId);
        const selectBtn = document.getElementById('project-modal-btn');
        if (selectBtn) {
            selectBtn.textContent = isSelected ? '✓ Selected - Remove' : 'Add to Portfolio';
            selectBtn.className = isSelected ? 'add-to-committee-btn remove' : 'add-to-committee-btn';
        }
        
        document.getElementById('project-modal').classList.remove('hidden');
    }
    
    function getYear1EndMarketContext(project) {
        const contexts = {
            'quick_win': 'Fast-moving market segment identified through Year 1 customer feedback. Strong demand signal from sales team. Competitive window of 6-9 months before likely response.',
            'market_response': 'Defensive play responding to competitor moves observed in Year 1. Market share at risk without response. Customer research confirms feature gap concerns.',
            'capability_build': 'Strategic capability investment informed by Year 1 learnings. Will accelerate future product development and reduce technical debt.',
            'partnership_opportunity': 'Partnership opportunity emerged from Year 1 business development. Strong strategic fit with potential for recurring revenue.',
            'tech_adjacency': 'Adjacent market exploration based on customer requests during Year 1. Leverage existing technology with adaptation for new use cases.'
        };
        return contexts[project.archetype] || 'Market opportunity identified through Year 1 operations.';
    }
    
    function getYear1EndCapabilityFit(project) {
        const fits = {
            'quick_win': 'Strong capability fit. Leverages existing team skills and infrastructure. Low execution risk.',
            'market_response': 'Good capability alignment. Engineering team familiar with required technologies. Some acceleration needed.',
            'capability_build': 'Builds new capabilities. Requires focused investment but creates long-term value across product line.',
            'partnership_opportunity': 'Mixed capability requirements. Core product work fits existing skills. Partnership management needs development.',
            'tech_adjacency': 'Partial capability fit. Core technology transfers well. New domain expertise required.'
        };
        return fits[project.archetype] || 'Capability assessment based on Year 1 team performance.';
    }
    
    function getYear1EndTeamNote(project) {
        const notes = {
            'quick_win': 'Can be staffed from existing team with minor reallocation. Low disruption to ongoing projects.',
            'market_response': 'Requires dedicated squad. May compete with existing projects for senior engineers.',
            'capability_build': 'Platform team ownership. Needs dedicated resources for full duration.',
            'partnership_opportunity': 'Cross-functional team needed. Business development lead essential.',
            'tech_adjacency': 'Needs domain specialist hire or consultant. Otherwise standard team composition.'
        };
        return notes[project.archetype] || 'Team allocation to be determined based on Year 2 capacity.';
    }
    
    function getYear1EndRisks(project) {
        const risks = {
            'quick_win': 'Execution speed is critical. Risk of quality shortcuts if timeline pressured. Competition may respond faster.',
            'market_response': 'Reactive positioning. May be outpaced by competitor\'s next move. Resource allocation tension with proactive initiatives.',
            'capability_build': 'Typical platform risk: may take longer than expected, benefits accrue slowly. Opportunity cost of not shipping customer-facing features.',
            'partnership_opportunity': 'Partner dependency. Terms may shift. Integration complexity often underestimated.',
            'tech_adjacency': 'Market validation risk. Adjacent segment may not convert as expected. Domain learning curve.'
        };
        return risks[project.archetype] || 'Standard project risks apply. Year 1 experience informs mitigation strategies.';
    }
    
    function toggleYear1EndProject(projectId) {
        const project = year1EndProjectPool.find(p => p.id === projectId);
        if (!project) return;
        
        const index = year1EndSelectedProjects.indexOf(projectId);
        
        if (index >= 0) {
            // Deselect
            year1EndSelectedProjects.splice(index, 1);
            year1EndAvailableBudget += project.budget;
        } else {
            // Select (if can afford)
            if (project.budget <= year1EndAvailableBudget) {
                year1EndSelectedProjects.push(projectId);
                year1EndAvailableBudget -= project.budget;
            } else {
                return; // Can't afford, don't re-render
            }
        }
        
        renderYear1EndProjectGrid();
        updateYear1EndBudgetDisplay();
    }
    
    function updateYear1EndBudgetDisplay() {
        document.getElementById('year1end-budget-remaining').textContent = '$' + Math.round(year1EndAvailableBudget * 10) / 10 + 'M';
        document.getElementById('year1end-budget-total').textContent = '/ $' + gameState.maxBudget + 'M annual budget';
        document.getElementById('year1end-projects-selected').textContent = year1EndSelectedProjects.length;
        
        // Enable/disable confirm button - allow skipping even with 0 selections
        document.getElementById('confirm-year1end-selection-btn').disabled = year1EndSelectedProjects.length === 0;
        
        // Update strategic balance display
        updateYear1EndStrategicBalance();
    }
    
    function updateYear1EndStrategicBalance() {
        const balanceDiv = document.getElementById('year1end-strategic-balance');
        if (!balanceDiv) return;
        
        // Count buckets from existing active projects
        const bucketCounts = {};
        Object.values(strategicBuckets).forEach(bucket => {
            bucketCounts[bucket.id] = 0;
        });
        
        // Add Year 1 End specific buckets - now using main strategic buckets
        const year1EndBuckets = {
            'defend-metro': { id: 'defend-metro', name: 'Defend Metro Leadership', icon: '🛡️', color: '#2563eb' },
            'tier23-rollout': { id: 'tier23-rollout', name: 'Tier 2/3 Rollout', icon: '🗺️', color: '#059669' },
            'recurring-revenue': { id: 'recurring-revenue', name: 'Recurring Revenue', icon: '💳', color: '#7c3aed' },
            'ai-first': { id: 'ai-first', name: 'AI-First Products', icon: '🤖', color: '#dc2626' }
        };
        
        Object.values(year1EndBuckets).forEach(bucket => {
            if (!bucketCounts[bucket.id]) bucketCounts[bucket.id] = 0;
        });
        
        // Count from active projects
        gameState.activeProjects.forEach(project => {
            (project.strategicBuckets || []).forEach(bucket => {
                if (bucketCounts[bucket.id] !== undefined) bucketCounts[bucket.id]++;
            });
        });
        
        // Count from selected Year 1 End projects
        year1EndSelectedProjects.forEach(projectId => {
            const project = year1EndProjectPool.find(p => p.id === projectId);
            if (project) {
                (project.strategicBuckets || []).forEach(bucket => {
                    if (bucketCounts[bucket.id] !== undefined) {
                        bucketCounts[bucket.id]++;
                    } else {
                        bucketCounts[bucket.id] = 1;
                    }
                });
            }
        });
        
        // Combine all buckets for display
        const allBuckets = { ...strategicBuckets, ...year1EndBuckets };
        
        // Filter to only show buckets that have projects or are relevant
        const relevantBuckets = Object.values(allBuckets).filter(bucket => 
            bucketCounts[bucket.id] > 0 || 
            year1EndProjectPool.some(p => (p.strategicBuckets || []).some(b => b.id === bucket.id))
        );
        
        balanceDiv.innerHTML = '<div style="width: 100%; margin-bottom: 8px; font-weight: 600; color: var(--gray-600);">Strategic Balance:</div>' +
            relevantBuckets.map(bucket => {
                const count = bucketCounts[bucket.id] || 0;
                const hasProjects = count > 0;
                return `
                    <div style="display: flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 20px; 
                                background: ${hasProjects ? bucket.color + '20' : 'var(--gray-100)'}; 
                                color: ${hasProjects ? bucket.color : 'var(--gray-400)'}; 
                                border: 1px solid ${hasProjects ? bucket.color + '40' : 'var(--gray-200)'};">
                        <span>${bucket.icon}</span>
                        <span style="font-size: 0.85em;">${bucket.name}</span>
                        <span style="font-weight: 700; margin-left: 4px;">${count}</span>
                    </div>
                `;
            }).join('');
    }
    
    function skipYear1EndSelection() {
        // Show portfolio review before continuing to Year 2 Budget Meeting
        showYear1PortfolioReview();
    }
    
    function showYear1EndReview() {
        // Populate the review modal with portfolio information
        const modal = document.getElementById('year1end-review-modal');
        
        // Get selected projects
        const selectedProjects = year1EndSelectedProjects.map(id => 
            year1EndProjectPool.find(p => p.id === id)
        ).filter(p => p);
        
        // Update strategic balance in review modal
        const balanceDiv = document.getElementById('year1end-review-balance');
        if (balanceDiv) {
            // Count all buckets
            const bucketCounts = {};
            
            // Year 1 End specific buckets - now using main strategic buckets
            const allBuckets = {
                ...strategicBuckets
            };
            
            Object.values(allBuckets).forEach(b => bucketCounts[b.id] = 0);
            
            // Count from active projects
            gameState.activeProjects.forEach(project => {
                (project.strategicBuckets || []).forEach(bucket => {
                    if (bucketCounts[bucket.id] !== undefined) bucketCounts[bucket.id]++;
                });
            });
            
            // Count from selected new projects
            selectedProjects.forEach(project => {
                (project.strategicBuckets || []).forEach(bucket => {
                    bucketCounts[bucket.id] = (bucketCounts[bucket.id] || 0) + 1;
                });
            });
            
            // Filter to only show relevant buckets
            const relevantBuckets = Object.values(allBuckets).filter(b => bucketCounts[b.id] > 0);
            
            balanceDiv.innerHTML = relevantBuckets.map(bucket => {
                const count = bucketCounts[bucket.id] || 0;
                return `
                    <div style="display: flex; align-items: center; gap: 6px; padding: 8px 14px; border-radius: 20px; 
                                background: ${bucket.color}20; color: ${bucket.color}; 
                                border: 1px solid ${bucket.color}40;">
                        <span>${bucket.icon}</span>
                        <span style="font-size: 0.9em;">${bucket.name}</span>
                        <span style="font-weight: 700; margin-left: 4px;">${count}</span>
                    </div>
                `;
            }).join('');
        }
        
        // Update new projects list
        const projectsDiv = document.getElementById('year1end-review-projects');
        if (projectsDiv) {
            projectsDiv.innerHTML = selectedProjects.map(project => `
                <div style="display: flex; align-items: center; gap: 12px; background: var(--success-light); border: 1px solid var(--success); border-radius: 8px; padding: 12px;">
                    <div style="font-size: 1.3em;">🆕</div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--gray-800);">${project.name}</div>
                        <div style="font-size: 0.85em; color: var(--gray-600);">${project.tagline || ''}</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: 700; color: var(--gold-dark);">$${project.budget}M </div>
                        <div style="font-size: 0.8em; color: var(--gray-500);">${project.timeline}Q timeline</div>
                    </div>
                </div>
            `).join('');
        }
        
        // Update existing projects list
        const existingDiv = document.getElementById('year1end-review-existing');
        if (existingDiv) {
            existingDiv.innerHTML = gameState.activeProjects.map(project => {
                const statusColor = project.status === 'active' ? 'var(--info)' : 'var(--warning)';
                return `
                    <div style="display: flex; align-items: center; gap: 10px; background: var(--gray-50); border-radius: 6px; padding: 10px;">
                        <div style="flex: 1;">
                            <div style="font-weight: 500; color: var(--gray-700); font-size: 0.9em;">${project.name}</div>
                        </div>
                        <div style="font-size: 0.8em; color: ${statusColor};">Q${project.quartersActive || 0}/${project.timeline || '?'}</div>
                        <div style="font-size: 0.85em; font-weight: 600; color: var(--gold-dark);">$${project.budget}M </div>
                    </div>
                `;
            }).join('');
        }
        
        // Update summary stats
        const totalProjects = gameState.activeProjects.length + selectedProjects.length;
        const newBudgetUsed = selectedProjects.reduce((sum, p) => sum + p.budget, 0);
        const existingBudgetUsed = gameState.activeProjects.reduce((sum, p) => sum + (p.budget || 0), 0);
        const totalBudgetUsed = newBudgetUsed + existingBudgetUsed;
        const budgetRemaining = gameState.maxBudget - totalBudgetUsed;
        
        document.getElementById('year1end-review-total-projects').textContent = totalProjects;
        document.getElementById('year1end-review-budget-used').textContent = '$' + totalBudgetUsed.toFixed(1) + 'M';
        document.getElementById('year1end-review-budget-remaining').textContent = '$' + Math.max(0, budgetRemaining).toFixed(1) + 'M';
        
        // Show modal
        modal.classList.remove('hidden');
    }
    
    function closeYear1EndReview() {
        document.getElementById('year1end-review-modal').classList.add('hidden');
    }
    
    // ============================================
    // YEAR 1 PORTFOLIO REVIEW (2x2 Matrix Modal)
    // ============================================
    
    let year1ReviewMatrix = 'risk-speed';
    
    function showYear1PortfolioReview() {
        year1ReviewMatrix = 'risk-speed';
        
        // Update toggle buttons
        document.querySelectorAll('#year1-portfolio-review-modal .matrix-toggle-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.matrix === year1ReviewMatrix);
        });
        
        // Calculate stats
        const successes = gameState.completedProjects.filter(p => p.outcome === 'success').length;
        const failures = gameState.completedProjects.filter(p => p.outcome !== 'success').length;
        const killed = gameState.killedProjects.length;
        const active = gameState.activeProjects.length;
        
        document.getElementById('y1-review-success').textContent = successes;
        document.getElementById('y1-review-failed').textContent = failures;
        document.getElementById('y1-review-killed').textContent = killed;
        document.getElementById('y1-review-active').textContent = active;
        
        // Generate insights
        const insights = generateYear1ReviewInsights(successes, failures, killed, active);
        document.getElementById('y1-review-insights').innerHTML = insights;
        
        // Render the matrix
        renderYear1ReviewMatrix();
        
        // Show modal
        document.getElementById('year1-portfolio-review-modal').classList.remove('hidden');
    }
    
    function switchYear1Matrix(matrixType) {
        year1ReviewMatrix = matrixType;
        
        // Update toggle buttons
        document.querySelectorAll('#year1-portfolio-review-modal .matrix-toggle-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.matrix === matrixType);
        });
        
        renderYear1ReviewMatrix();
    }
    
    function renderYear1ReviewMatrix() {
        const config = matrixConfigs[year1ReviewMatrix];
        const container = document.getElementById('year1-matrix-container');
        
        // Collect all projects with their status
        const allProjects = [];
        
        // Completed projects (success)
        gameState.completedProjects.filter(p => p.outcome === 'success').forEach(p => {
            allProjects.push({ ...p, reviewStatus: 'success' });
        });
        
        // Completed projects (failed)
        gameState.completedProjects.filter(p => p.outcome !== 'success').forEach(p => {
            allProjects.push({ ...p, reviewStatus: 'failed' });
        });
        
        // Killed projects
        gameState.killedProjects.forEach(p => {
            allProjects.push({ ...p, reviewStatus: 'killed' });
        });
        
        // Active projects
        gameState.activeProjects.forEach(p => {
            allProjects.push({ ...p, reviewStatus: 'active' });
        });
        
        // Build quadrant labels
        const quadrantsHtml = `
            <div class="matrix-quadrant q1"><div class="quadrant-label">${config.quadrants.q1.label}</div></div>
            <div class="matrix-quadrant q2"><div class="quadrant-label">${config.quadrants.q2.label}</div></div>
            <div class="matrix-quadrant q3"><div class="quadrant-label">${config.quadrants.q3.label}</div></div>
            <div class="matrix-quadrant q4"><div class="quadrant-label">${config.quadrants.q4.label}</div></div>
        `;
        
        // Build axes
        const axesHtml = `
            <div class="matrix-axis horizontal"></div>
            <div class="matrix-axis vertical"></div>
            <div class="axis-label x-min">${config.xAxis.min}</div>
            <div class="axis-label x-max">${config.xAxis.max}</div>
            <div class="axis-label y-min">${config.yAxis.min}</div>
            <div class="axis-label y-max">${config.yAxis.max}</div>
        `;
        
        // Build project bubbles with outcome status
        const bubblesHtml = allProjects.map(project => {
            // Get positions from pre-computed positions or calculate
            const pos = projectMatrixPositions[project.id]?.[year1ReviewMatrix];
            const xPos = pos ? pos.x : 50;
            const yPos = pos ? 100 - pos.y : 50;
            
            // Size based on budget (40-75px for better mobile touch targets)
            const minBudget = 2, maxBudget = 15;
            const budgetNorm = ((project.budget || 5) - minBudget) / (maxBudget - minBudget);
            const size = 40 + budgetNorm * 35;
            
            // Status colors and labels
            let statusClass, statusColor, statusBorder, statusLabel;
            switch (project.reviewStatus) {
                case 'success':
                    statusColor = '#22c55e';
                    statusBorder = '#166534';
                    statusLabel = '✅ Success';
                    statusClass = 'review-success';
                    break;
                case 'failed':
                    statusColor = '#ef4444';
                    statusBorder = '#b91c1c';
                    statusLabel = '❌ Failed';
                    statusClass = 'review-failed';
                    break;
                case 'killed':
                    statusColor = '#6b7280';
                    statusBorder = '#374151';
                    statusLabel = '🔴 Killed';
                    statusClass = 'review-killed';
                    break;
                case 'active':
                    statusColor = '#3b82f6';
                    statusBorder = '#1d4ed8';
                    statusLabel = '🔵 Active';
                    statusClass = 'review-active';
                    break;
            }
            
            return `
                <div class="project-bubble ${statusClass}" 
                     style="left: calc(${xPos}% - ${size/2}px); top: calc(${yPos}% - ${size/2}px); width: ${size}px; height: ${size}px; background: ${statusColor}; border: 3px solid ${statusBorder}; cursor: default;"
                     data-project-id="${project.id}">
                    <div class="bubble-tooltip">
                        <div class="tooltip-name">${project.name}</div>
                        <div class="tooltip-budget">$${project.budget}M </div>
                        <div style="font-size: 0.85em; margin-top: 4px; opacity: 0.9;">
                            ${statusLabel}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = quadrantsHtml + axesHtml + bubblesHtml;
    }
    
    function generateYear1ReviewInsights(successes, failures, killed, active) {
        const insights = [];
        const totalFunded = successes + failures + active;
        const hitRate = totalFunded > 0 ? Math.round((successes / (successes + failures)) * 100) : 0;
        
        // Overall performance insight
        if (successes > failures) {
            insights.push(`<div style="margin-bottom: 10px;">📈 <strong>Strong Year 1:</strong> ${successes} project(s) succeeded vs ${failures} failure(s). Your selection process is working well.</div>`);
        } else if (failures > successes) {
            insights.push(`<div style="margin-bottom: 10px;">📉 <strong>Challenging Year 1:</strong> ${failures} project(s) failed vs ${successes} success(es). Consider adjusting your criteria for Year 2.</div>`);
        } else {
            insights.push(`<div style="margin-bottom: 10px;">📊 <strong>Mixed Year 1:</strong> Equal successes and failures. Year 2 offers opportunity to improve hit rate.</div>`);
        }
        
        // Kill decisions insight
        if (killed > 0) {
            insights.push(`<div style="margin-bottom: 10px;">🛑 <strong>Portfolio Discipline:</strong> You killed ${killed} project(s). Smart pivots preserve resources for better opportunities.</div>`);
        }
        
        // Active projects insight
        if (active > 0) {
            insights.push(`<div style="margin-bottom: 10px;">🔄 <strong>Continuing Work:</strong> ${active} project(s) carry into Year 2. These represent committed capital and ongoing risk.</div>`);
        }
        
        // Process-based insight
        if (gameState.decisionModel === 'committee' && gameState.committee.length > 3) {
            if (successes > failures) {
                insights.push(`<div style="margin-bottom: 10px;">👥 <strong>Committee Value:</strong> Your ${gameState.committee.length}-person committee helped identify winners.</div>`);
            }
        }
        
        return insights.join('');
    }
    
    function closeYear1PortfolioReview() {
        document.getElementById('year1-portfolio-review-modal').classList.add('hidden');
    }
    
    function closeYear1PortfolioReviewAndContinue() {
        closeYear1PortfolioReview();
        // Start Year 2 with project assessment BEFORE budget meeting
        startYear2Assessment();
    }
    
    // ============================================
    // YEAR 2 PORTFOLIO REVIEW (2x2 Matrix)
    // ============================================
    
    let year2ReviewMatrix = 'risk-speed';
    
    function showYear2PortfolioReview() {
        year2ReviewMatrix = 'risk-speed';
        
        // Update toggle buttons
        document.querySelectorAll('#year2-portfolio-review-modal .matrix-toggle-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.matrix === year2ReviewMatrix);
        });
        
        // Calculate stats
        const successes = gameState.completedProjects.filter(p => p.outcome === 'success').length;
        const failures = gameState.completedProjects.filter(p => p.outcome !== 'success').length;
        const killed = gameState.killedProjects.length;
        const active = gameState.activeProjects.length;
        
        document.getElementById('y2-review-success').textContent = successes;
        document.getElementById('y2-review-failed').textContent = failures;
        document.getElementById('y2-review-killed').textContent = killed;
        document.getElementById('y2-review-active').textContent = active;
        
        // Generate insights
        const insights = generateYear2ReviewInsights(successes, failures, killed, active);
        document.getElementById('y2-review-insights').innerHTML = insights;
        
        // Render the matrix
        renderYear2ReviewMatrix();
        
        // Show modal
        document.getElementById('year2-portfolio-review-modal').classList.remove('hidden');
    }
    
    function switchYear2Matrix(matrixType) {
        year2ReviewMatrix = matrixType;
        
        // Update toggle buttons
        document.querySelectorAll('#year2-portfolio-review-modal .matrix-toggle-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.matrix === matrixType);
        });
        
        renderYear2ReviewMatrix();
    }
    
    function renderYear2ReviewMatrix() {
        const config = matrixConfigs[year2ReviewMatrix];
        const container = document.getElementById('year2-matrix-container');
        
        // Collect all projects with their status
        const allProjects = [];
        
        // Completed projects (success)
        gameState.completedProjects.filter(p => p.outcome === 'success').forEach(p => {
            allProjects.push({ ...p, reviewStatus: 'success' });
        });
        
        // Completed projects (failed)
        gameState.completedProjects.filter(p => p.outcome !== 'success').forEach(p => {
            allProjects.push({ ...p, reviewStatus: 'failed' });
        });
        
        // Killed projects
        gameState.killedProjects.forEach(p => {
            allProjects.push({ ...p, reviewStatus: 'killed' });
        });
        
        // Active projects
        gameState.activeProjects.forEach(p => {
            allProjects.push({ ...p, reviewStatus: 'active' });
        });
        
        // Build quadrant labels
        const quadrantsHtml = `
            <div class="matrix-quadrant q1"><div class="quadrant-label">${config.quadrants.q1.label}</div></div>
            <div class="matrix-quadrant q2"><div class="quadrant-label">${config.quadrants.q2.label}</div></div>
            <div class="matrix-quadrant q3"><div class="quadrant-label">${config.quadrants.q3.label}</div></div>
            <div class="matrix-quadrant q4"><div class="quadrant-label">${config.quadrants.q4.label}</div></div>
        `;
        
        // Build axes
        const axesHtml = `
            <div class="matrix-axis horizontal"></div>
            <div class="matrix-axis vertical"></div>
            <div class="axis-label x-min">${config.xAxis.min}</div>
            <div class="axis-label x-max">${config.xAxis.max}</div>
            <div class="axis-label y-min">${config.yAxis.min}</div>
            <div class="axis-label y-max">${config.yAxis.max}</div>
        `;
        
        // Build project bubbles
        let bubblesHtml = '';
        allProjects.forEach(project => {
            const scores = project.scores || {};
            const xScore = scores[config.xAxis.key] || 3;
            const yScore = scores[config.yAxis.key] || 3;
            
            // Convert 1-5 score to percentage position (inverted for y)
            const xPos = ((xScore - 1) / 4) * 80 + 10;
            const yPos = 90 - ((yScore - 1) / 4) * 80;
            
            // Status-based colors
            let bgColor, borderColor;
            switch (project.reviewStatus) {
                case 'success':
                    bgColor = '#22c55e';
                    borderColor = '#166534';
                    break;
                case 'failed':
                    bgColor = '#ef4444';
                    borderColor = '#b91c1c';
                    break;
                case 'killed':
                    bgColor = '#6b7280';
                    borderColor = '#374151';
                    break;
                case 'active':
                default:
                    bgColor = '#3b82f6';
                    borderColor = '#1d4ed8';
                    break;
            }
            
            bubblesHtml += `
                <div class="project-bubble" 
                     style="left: ${xPos}%; top: ${yPos}%; background: ${bgColor}; border: 2px solid ${borderColor};"
                     title="${project.name} (${project.reviewStatus})">
                    <span class="bubble-label">${(project.name || '').substring(0, 3)}</span>
                </div>
            `;
        });
        
        container.innerHTML = quadrantsHtml + axesHtml + bubblesHtml;
    }
    
    function generateYear2ReviewInsights(successes, failures, killed, active) {
        const total = successes + failures + killed;
        const successRate = total > 0 ? Math.round((successes / total) * 100) : 0;
        
        let insights = [];
        
        if (successRate >= 70) {
            insights.push('🎯 <strong>Excellent track record!</strong> Your high success rate shows strong project selection and management.');
        } else if (successRate >= 50) {
            insights.push('📊 <strong>Solid performance.</strong> Your portfolio is performing at industry average.');
        } else if (total > 0) {
            insights.push('⚠️ <strong>Learning opportunity.</strong> Use Year 2 to apply lessons from earlier challenges.');
        }
        
        if (active > 6) {
            insights.push('📈 <strong>Large portfolio.</strong> With ' + active + ' active projects, ensure you have bandwidth to manage them all effectively.');
        } else if (active >= 4) {
            insights.push('✅ <strong>Healthy portfolio size.</strong> ' + active + ' active projects is a manageable load for Year 2.');
        } else if (active > 0) {
            insights.push('🎯 <strong>Focused portfolio.</strong> ' + active + ' projects allows for concentrated attention and resources.');
        }
        
        // Check strategic balance
        const bucketCounts = {};
        gameState.activeProjects.forEach(p => {
            (p.strategicBuckets || []).forEach(b => {
                bucketCounts[b.name] = (bucketCounts[b.name] || 0) + 1;
            });
        });
        
        const bucketNames = Object.keys(bucketCounts);
        if (bucketNames.length >= 3) {
            insights.push('🔀 <strong>Diversified strategy.</strong> Your portfolio spans multiple strategic buckets.');
        } else if (bucketNames.length === 1) {
            insights.push('🎯 <strong>Concentrated bet.</strong> All projects in one strategic area—high risk, high reward.');
        }
        
        return insights.length > 0 
            ? '<ul style="list-style: none; padding: 0; margin: 0;">' + insights.map(i => '<li style="margin-bottom: 8px;">' + i + '</li>').join('') + '</ul>'
            : '<p style="color: var(--gray-500); text-align: center;">Your Year 2 portfolio is set. Good luck!</p>';
    }
    
    function closeYear2PortfolioReview() {
        document.getElementById('year2-portfolio-review-modal').classList.add('hidden');
    }
    
    function closeYear2PortfolioReviewAndContinue() {
        closeYear2PortfolioReview();
        // After Year 2 project selection, go to budget meeting
        showYear2BudgetMeeting();
    }
    
    function finalConfirmYear1EndSelection() {
        // Add selected Year 1 End projects to active projects
        year1EndSelectedProjects.forEach(projectId => {
            const project = year1EndProjectPool.find(p => p.id === projectId);
            if (project) {
                // Prepare the project for the active portfolio
                const activeProject = {
                    ...project,
                    status: 'active',
                    progress: 0,
                    currentQuarter: 0,
                    quartersActive: 0,
                    spentBudget: 0,
                    startQuarter: gameState.currentQuarter,
                    isYear1EndProject: true,
                    decision: 'continue'
                };
                
                // Add quarter narratives if not present
                if (!activeProject.quarterNarratives) {
                    activeProject.quarterNarratives = {
                        good: ['Making good progress.', 'Team aligned and executing.'],
                        bad: ['Facing some challenges.', 'Timeline pressure building.']
                    };
                }
                
                gameState.activeProjects.push(activeProject);
                gameState.budget -= project.budget;
            }
        });
        
        // Show portfolio review for fine-tuning before continuing to Year 2
        showYear1PortfolioReview();
    }
    
    // ============================================
    // YEAR 2 PROJECT TEMPLATES
    // ============================================
    
    const year2ProjectTemplates = [
        { 
            archetype: 'market_response', 
            names: ['RapidResponse Kit', 'MarketMatch Pro', 'CompetitorBlock'], 
            descs: [
                'Quick-deploy security bundle responding to competitor\'s new budget line. Pre-configured system with 1 hub, 3 sensors, 1 camera at $55. Fast-track development using existing components in new configuration. 3-month launch target.',
                'AI-powered pricing engine that automatically adjusts product recommendations based on competitor pricing scraped from e-commerce sites. Real-time market intelligence dashboard for sales team.',
                'Feature parity update to match competitor\'s new smart integration capabilities. Over-the-air update for existing ShieldOS devices enabling voice assistant compatibility.'
            ], 
            budgetRange: [3, 5], baseSuccess: 0.60, 
            scores: { technical: 4, marketsize: 4, strategic: 4, team: 4, capability: 5, ip: 2, platform: 3, sustainability: 2, newmarket: 2, geographic: 4, competitive: 4, devcost: 4, roi: 4, speed: 5, risk: 3 }, 
            quarterNarratives: { good: ['Market response on schedule.', 'Competitive positioning strengthening.'], bad: ['Competitor moving faster.', 'Feature scope creeping.'] }, 
            outcomeNarrative: { success: 'Maintained market position against competitive threat.', failure: 'Too little too late—competitor captured segment.' } 
        },
        { 
            archetype: 'partnership_opportunity', 
            names: ['TelcoSafe Bundle', 'InsuranceLink', 'BuilderConnect'], 
            descs: [
                'Co-branded security bundle with Jio/Airtel for broadband subscribers. Revenue-sharing model with telecom handling distribution. Custom firmware with ISP branding. Exclusive 18-month partnership terms negotiated.',
                'Insurance-integrated system where ShieldTech alerts reduce home insurance premiums. API integration with ICICI Lombard and HDFC Ergo. Claim reporting automation. New recurring revenue stream from commission.',
                'Pre-wired security infrastructure for new residential developments. Partnership with Godrej Properties, Sobha, and Brigade. Bulk pricing model with installation during construction phase.'
            ], 
            budgetRange: [4, 6], baseSuccess: 0.65, 
            scores: { technical: 3, marketsize: 5, strategic: 5, team: 3, capability: 4, ip: 2, platform: 4, sustainability: 3, newmarket: 4, geographic: 4, competitive: 4, devcost: 3, roi: 5, speed: 3, risk: 3 }, 
            quarterNarratives: { good: ['Partner integration progressing well.', 'Deal terms finalized.'], bad: ['Partner internal delays.', 'Contract negotiations stalled.'] }, 
            outcomeNarrative: { success: 'Partnership opened major new distribution channel.', failure: 'Partnership fell through—pivoted to direct strategy.' } 
        },
        { 
            archetype: 'tech_refresh', 
            names: ['NextGen Sensor Array', 'CloudOS 2.0', 'BatteryMax Upgrade'], 
            descs: [
                'Complete sensor technology refresh using latest mmWave radar chips. 50% better detection accuracy, 30% lower power consumption. Drop-in replacement for current sensor line with backward compatibility.',
                'Major platform update: new mobile app architecture (React Native), cloud migration to AWS, and API modernization for faster third-party integrations. Enables subscription services revenue model.',
                'Battery optimization across product line. New power management chip design reducing standby consumption by 40%. Solar charging compatibility. Extends field life from 18 to 30 months.'
            ], 
            budgetRange: [5, 7], baseSuccess: 0.70, 
            scores: { technical: 5, marketsize: 4, strategic: 5, team: 4, capability: 4, ip: 4, platform: 5, sustainability: 4, newmarket: 3, geographic: 3, competitive: 5, devcost: 3, roi: 4, speed: 3, risk: 3 }, 
            quarterNarratives: { good: ['Technical specs exceeding targets.', 'Platform foundation solid.'], bad: ['Migration complexity higher than expected.', 'Backward compatibility issues emerging.'] }, 
            outcomeNarrative: { success: 'Technology refresh positioned ShieldTech for next 3 years.', failure: 'Partial rollout—full refresh deferred to next cycle.' } 
        },
        { 
            archetype: 'emerging_segment', 
            names: ['SmallBiz Secure', 'TempleGuard', 'SchoolSafe System'], 
            descs: [
                'Tailored solution for small retail shops and offices (500-2000 sq ft). Cash drawer sensors, staff panic buttons, HD cameras with POS integration. Monthly subscription model at $12/month including monitoring.',
                'Specialized system for religious institutions: temples, churches, mosques. Donation box security, crowd monitoring during festivals, integration with management committee alerts. Culturally appropriate design.',
                'School security platform with student tracking (RFID cards), perimeter alerts, classroom panic buttons, and parent notification system. CBSE/ICSE compliance documentation. Pilot with 5 schools underway.'
            ], 
            budgetRange: [4, 6], baseSuccess: 0.55, 
            scores: { technical: 3, marketsize: 4, strategic: 4, team: 3, capability: 4, ip: 3, platform: 4, sustainability: 4, newmarket: 5, geographic: 4, competitive: 4, devcost: 4, roi: 3, speed: 4, risk: 3 }, 
            quarterNarratives: { good: ['Segment validation positive.', 'Early adopters enthusiastic.'], bad: ['Segment needs are more specialized than expected.', 'Sales cycle longer in B2B.'] }, 
            outcomeNarrative: { success: 'New B2B segment opened with strong recurring revenue.', failure: 'Segment viable but requires dedicated sales team we don\'t have.' } 
        },
        { 
            archetype: 'acquisition_integration', 
            names: ['VideoAI Merger', 'LocalBrand Acquisition', 'Patent Portfolio Buy'], 
            descs: [
                'Integration of acquired Bangalore AI startup\'s computer vision technology. Their edge-ML models outperform ours for human detection. Team of 12 engineers needs integration into ShieldTech processes.',
                'Acquisition of regional brand strong in South India (40% market share in Kerala/TN). Integration of their dealer network, service centers, and local product variants. Brand transition planning.',
                'Acquisition of defensive patent portfolio from struggling competitor. 23 patents covering motion detection algorithms, encrypted communications, and smart lock mechanisms. Licensing revenue potential.'
            ], 
            budgetRange: [6, 9], baseSuccess: 0.50, 
            scores: { technical: 4, marketsize: 4, strategic: 5, team: 3, capability: 3, ip: 5, platform: 4, sustainability: 3, newmarket: 4, geographic: 4, competitive: 5, devcost: 2, roi: 4, speed: 2, risk: 2 }, 
            quarterNarratives: { good: ['Integration proceeding smoothly.', 'Synergies materializing.'], bad: ['Cultural integration challenging.', 'Hidden technical debt discovered.'] }, 
            outcomeNarrative: { success: 'Acquisition accelerated capabilities by 2 years.', failure: 'Integration took longer than expected but core value captured.' } 
        },
        { 
            archetype: 'regulatory_opportunity', 
            names: ['BIS Certified Pro', 'FireSafe Combo', 'DataLocal System'], 
            descs: [
                'First-to-market BIS-certified smart lock meeting new 2024 mandatory standards. Competitors need 6-12 months to comply. Window of opportunity for premium pricing and government contracts.',
                'Integrated fire + security system meeting National Building Code requirements for commercial spaces. Smoke detection, sprinkler integration, and evacuation alerts. Required for new commercial occupancy permits.',
                'India data localization compliant system with all data processing and storage within Indian borders. Targets government and banking sector customers with strict data sovereignty requirements.'
            ], 
            budgetRange: [4, 6], baseSuccess: 0.65, 
            scores: { technical: 4, marketsize: 4, strategic: 5, team: 4, capability: 4, ip: 3, platform: 3, sustainability: 3, newmarket: 4, geographic: 5, competitive: 5, devcost: 3, roi: 4, speed: 4, risk: 3 }, 
            quarterNarratives: { good: ['Certification on track.', 'Government tender submitted.'], bad: ['Compliance requirements evolving.', 'Certification delays.'] }, 
            outcomeNarrative: { success: 'Regulatory first-mover advantage captured market share.', failure: 'Certification delayed—competitors caught up.' } 
        }
    ];
    
    // State for Year 2 selection
    let year2ProjectPool = [];
    let year2SelectedProjects = [];
    let year2AvailableBudget = 0;
    
    function generateYear2ProjectPool() {
        console.log('generateYear2ProjectPool called');
        console.log('year2ProjectTemplates:', year2ProjectTemplates);
        
        const pool = [];
        const usedNames = new Set();
        let projectId = 100; // Start from 100 to avoid collision with Year 1 projects
        
        // Shuffle templates and pick a subset
        const shuffled = shuffleArray([...year2ProjectTemplates]);
        console.log('Shuffled templates:', shuffled.length);
        const templatesToUse = shuffled.slice(0, 3); // Use 3 templates to generate 3-5 projects
        console.log('Templates to use:', templatesToUse.length);
        
        for (const template of templatesToUse) {
            const count = 1 + Math.floor(Math.random() * 2); // 1-2 projects per template
            const indices = shuffleArray([...Array(template.names.length).keys()]).slice(0, count);
            console.log('Template:', template.archetype, 'count:', count, 'indices:', indices);
            
            // Stop if we already have 5 projects
            if (pool.length >= 5) break;
            
            for (const i of indices) {
                // Stop if we already have 5 projects
                if (pool.length >= 5) break;
                
                const name = template.names[i];
                console.log('Processing name:', name, 'index:', i);
                if (usedNames.has(name)) {
                    console.log('Skipping duplicate name:', name);
                    continue;
                }
                usedNames.add(name);
                
                const budgetRaw = template.budgetRange[0] + Math.random() * (template.budgetRange[1] - template.budgetRange[0]);
                const budget = Math.round(budgetRaw * 10) / 10;
                
                const project = {
                    id: 'y2proj-' + projectId,
                    numId: projectId,
                    name: name,
                    desc: template.descs[i],
                    description: template.descs[i],
                    shortDesc: template.descs[i],
                    tagline: getYear2Tagline(template.archetype),
                    archetype: template.archetype,
                    budget: budget,
                    successProb: template.baseSuccess + (Math.random() * 0.1 - 0.05),
                    scores: { ...template.scores },
                    quarterNarratives: template.quarterNarratives,
                    outcomeNarrative: template.outcomeNarrative,
                    timeline: 4 + Math.floor(Math.random() * 3), // 4-6 quarters for Year 2 projects (run Q5-Q10)
                    status: 'proposed',
                    isYear2Project: true,
                    // Add team info
                    team: generateRandomTeam(),
                    // Add strategic buckets
                    strategicBuckets: generateStrategicBuckets(template.archetype),
                    // Add milestones
                    milestones: getMilestones(template.archetype, budget),
                    // Add quarterly updates array
                    quarterlyUpdates: []
                };
                
                console.log('Created project:', project.name, project.id);
                pool.push(project);
                
                projectId++;
            }
        }
        
        // Ensure minimum of 3 projects - if we somehow got fewer, add from remaining templates
        if (pool.length < 3) {
            const remainingTemplates = shuffled.slice(3);
            for (const template of remainingTemplates) {
                if (pool.length >= 3) break;
                const name = template.names[0];
                if (!usedNames.has(name)) {
                    const budgetRaw = template.budgetRange[0] + Math.random() * (template.budgetRange[1] - template.budgetRange[0]);
                    const budget = Math.round(budgetRaw * 10) / 10;
                    pool.push({
                        id: 'y2proj-' + projectId,
                        numId: projectId,
                        name: name,
                        desc: template.descs[0],
                        description: template.descs[0],
                        shortDesc: template.descs[0],
                        tagline: getYear2Tagline(template.archetype),
                        archetype: template.archetype,
                        budget: budget,
                        successProb: template.baseSuccess + (Math.random() * 0.1 - 0.05),
                        scores: { ...template.scores },
                        quarterNarratives: template.quarterNarratives,
                        outcomeNarrative: template.outcomeNarrative,
                        timeline: 4 + Math.floor(Math.random() * 3),
                        status: 'proposed',
                        isYear2Project: true,
                        team: generateRandomTeam(),
                        strategicBuckets: generateStrategicBuckets(template.archetype),
                        milestones: getMilestones(template.archetype, budget),
                        quarterlyUpdates: []
                    });
                    projectId++;
                }
            }
        }
        
        console.log('Final Year 2 pool size:', pool.length, '(target: 3-5)');
        return pool;
    }
    
    function getYear2Tagline(archetype) {
        const taglines = {
            'market_response': 'Rapid response to competitive pressure',
            'partnership_opportunity': 'Strategic alliance with distribution potential',
            'tech_refresh': 'Platform modernization for future growth',
            'emerging_segment': 'New market segment with growth potential',
            'acquisition_integration': 'Inorganic growth opportunity',
            'regulatory_opportunity': 'First-mover advantage from compliance'
        };
        return taglines[archetype] || 'New strategic opportunity';
    }
    
    function generateRandomTeam() {
        const leads = [
            { name: 'Priya Sharma', title: 'Senior Product Manager' },
            { name: 'Rahul Mehta', title: 'Engineering Lead' },
            { name: 'Ananya Gupta', title: 'Technical Architect' },
            { name: 'Vikram Singh', title: 'Product Director' },
            { name: 'Deepa Krishnan', title: 'Innovation Lead' },
            { name: 'Arjun Patel', title: 'Platform Architect' },
            { name: 'Kavita Reddy', title: 'Senior Engineer' },
            { name: 'Nikhil Verma', title: 'Product Manager' }
        ];
        
        const lead = leads[Math.floor(Math.random() * leads.length)];
        return {
            lead: lead.name,
            leadTitle: lead.title,
            size: 4 + Math.floor(Math.random() * 8)
        };
    }
    
    function generateStrategicBuckets(archetype) {
        const bucketMap = {
            'quick_win': [{ id: 'recurring-revenue', name: 'Recurring Revenue', icon: '💳' }],
            'market_response': [{ id: 'defend-metro', name: 'Defend Metro Leadership', icon: '🛡️' }],
            'partnership_opportunity': [{ id: 'tier23-rollout', name: 'Tier 2/3 Rollout', icon: '🗺️' }],
            'tech_refresh': [{ id: 'ai-first', name: 'AI-First Products', icon: '🤖' }],
            'emerging_segment': [{ id: 'tier23-rollout', name: 'Tier 2/3 Rollout', icon: '🗺️' }],
            'acquisition_integration': [{ id: 'recurring-revenue', name: 'Recurring Revenue', icon: '💳' }],
            'regulatory_opportunity': [{ id: 'defend-metro', name: 'Defend Metro Leadership', icon: '🛡️' }]
        };
        
        return bucketMap[archetype] || [{ id: 'ai-first', name: 'AI-First Products', icon: '🤖' }];
    }
    
    // ============================================
    // YEAR 2 ASSESSMENT SYSTEM
    // ============================================
    
    let year2ScoringApproach = null;
    let year2TeamBlinding = null;
    let year2CurrentProjectIndex = 0;
    let year2RankedProjects = [];
    let year2ProjectTriage = {};
    let year2ApproachChoice = null; // 'same' or 'change'
    
    function startYear2Assessment() {
        // Generate the Year 2 project pool first
        year2ProjectPool = generateYear2ProjectPool();
        year2SelectedProjects = [];
        year2CurrentProjectIndex = 0;
        year2RankedProjects = [];
        year2ProjectTriage = {};
        year2ApproachChoice = null;
        
        // Use same approach as Year 1 by default
        year2ScoringApproach = gameState.scoringApproach || 'careful';
        year2TeamBlinding = gameState.teamBlinding || 'visible';
        
        // Initialize triage for all projects
        year2ProjectPool.forEach(p => {
            year2ProjectTriage[p.id] = 'marginal';
        });
        
        // For solo or random modes, skip the assessment and go directly to selection
        if (gameState.decisionModel === 'solo' || gameState.decisionModel === 'random') {
            // Calculate committee scores
            calculateYear2CommitteeScores();
            
            // For random mode, auto-select projects
            if (gameState.decisionModel === 'random') {
                autoSelectYear2Projects();
            }
            
            // Go to selection
            proceedToYear2PortfolioBuilder();
            return;
        }
        
        // For delegate mode, skip player scoring
        if (year2ScoringApproach === 'delegate') {
            calculateYear2CommitteeScores();
            showYear2CommitteeFeedback();
            return;
        }
        
        // Go directly to assessment - no approach modal
        renderYear2Assessment();
        showPhase('year2-assessment');
    }
    
    function autoSelectYear2Projects() {
        // Randomly select 1-3 projects within budget
        const shuffled = shuffleArray([...year2ProjectPool]);
        const numToSelect = 1 + Math.floor(Math.random() * 3);
        let budgetRemaining = year2AvailableBudget;
        
        for (let i = 0; i < Math.min(numToSelect, shuffled.length); i++) {
            if (shuffled[i].budget <= budgetRemaining) {
                year2SelectedProjects.push(shuffled[i].id);
                budgetRemaining -= shuffled[i].budget;
            }
        }
    }
    
    function selectYear2ApproachOption(value) {
        year2ApproachChoice = value;
        
        // Update visual selection
        document.querySelectorAll('.approach-option[data-choice="year2approach"]').forEach(opt => {
            opt.classList.remove('selected');
        });
        document.querySelector(`.approach-option[data-choice="year2approach"][data-value="${value}"]`).classList.add('selected');
        
        if (value === 'same') {
            // Use same approach as Year 1 (with fallback defaults)
            year2ScoringApproach = gameState.scoringApproach || 'careful';
            year2TeamBlinding = gameState.teamBlinding || 'visible';
            document.getElementById('year2-change-options').classList.add('hidden');
            updateYear2ApproachButton();
        } else {
            // Show change options
            year2ScoringApproach = null;
            year2TeamBlinding = null;
            document.getElementById('year2-change-options').classList.remove('hidden');
            document.querySelectorAll('#year2-change-options .approach-option').forEach(opt => opt.classList.remove('selected'));
            updateYear2ApproachButton();
        }
    }
    
    function selectYear2ScoringOption(value) {
        year2ScoringApproach = value;
        document.querySelectorAll('.approach-option[data-choice="y2scoring"]').forEach(opt => {
            opt.classList.remove('selected');
        });
        document.querySelector(`.approach-option[data-choice="y2scoring"][data-value="${value}"]`).classList.add('selected');
        updateYear2ApproachButton();
    }
    
    function selectYear2BlindingOption(value) {
        year2TeamBlinding = value;
        document.querySelectorAll('.approach-option[data-choice="y2blinding"]').forEach(opt => {
            opt.classList.remove('selected');
        });
        document.querySelector(`.approach-option[data-choice="y2blinding"][data-value="${value}"]`).classList.add('selected');
        updateYear2ApproachButton();
    }
    
    function updateYear2ApproachButton() {
        const btn = document.getElementById('year2-approach-confirm-btn');
        
        if (year2ScoringApproach && year2TeamBlinding) {
            btn.disabled = false;
            const scoringLabels = {
                'careful': 'Careful Evaluation',
                'rapid': 'Rapid Screening',
                'delegate': 'Committee Scoring'
            };
            btn.textContent = `Begin ${scoringLabels[year2ScoringApproach]} →`;
        } else {
            btn.disabled = true;
            btn.textContent = year2ApproachChoice === 'change' ? 'Select Both Options' : 'Select an Option to Continue';
        }
    }
    
    function confirmYear2Approach() {
        if (!year2ScoringApproach || !year2TeamBlinding) return;
        
        // Close modal
        document.getElementById('year2-approach-modal').classList.add('hidden');
        
        // Initialize triage for Year 2 projects
        year2ProjectPool.forEach(p => {
            year2ProjectTriage[p.id] = 'marginal';
        });
        
        if (year2ScoringApproach === 'delegate') {
            // Skip to committee feedback
            calculateYear2CommitteeScores();
            showYear2CommitteeFeedback();
        } else {
            // Start player assessment
            year2CurrentProjectIndex = 0;
            renderYear2Assessment();
            showPhase('year2-assessment');
        }
    }
    
    function renderYear2Assessment() {
        const project = year2ProjectPool[year2CurrentProjectIndex];
        
        // Update counter
        document.getElementById('year2-project-counter-current').textContent = year2CurrentProjectIndex + 1;
        document.getElementById('year2-project-counter-total').textContent = year2ProjectPool.length;
        
        // Update progress bar
        const progress = ((year2CurrentProjectIndex) / year2ProjectPool.length) * 100;
        document.getElementById('year2-assessment-progress').style.width = `${progress}%`;
        
        // Render project card
        renderYear2ProjectCard(project);
        
        // Render scoring grid
        renderYear2ScoringGrid(project);
        
        // Update buttons
        document.getElementById('year2-prev-project-btn').disabled = year2CurrentProjectIndex === 0;
        document.getElementById('year2-next-project-btn').textContent = 
            year2CurrentProjectIndex === year2ProjectPool.length - 1 ? 'Complete Assessment →' : 'Next Project →';
    }
    
    function renderYear2ProjectCard(project) {
        const showTeam = year2TeamBlinding === 'visible';
        
        let html = `
            <div class="project-header">
                <div class="project-badge year2">Year 2 Opportunity</div>
                <h2>${project.name}</h2>
                <p class="project-tagline">${project.tagline}</p>
            </div>
            
            <div class="project-metrics">
                <div class="metric">
                    <span class="metric-value">$${project.budget}M </span>
                    <span class="metric-label">Budget</span>
                </div>
                <div class="metric">
                    <span class="metric-value">${project.timeline}Q</span>
                    <span class="metric-label">Timeline</span>
                </div>
                <div class="metric">
                    <span class="metric-value">${Math.round(project.successProb * 100)}%</span>
                    <span class="metric-label">Est. Success</span>
                </div>
            </div>
            
            <div class="project-description">
                <h4>📋 Description</h4>
                <p>${project.description || project.desc || 'No description available.'}</p>
            </div>`;
        
        if (project.marketContext) {
            html += `
            <div class="project-market" style="margin-top: 15px;">
                <h4>📊 Market Context</h4>
                <p>${project.marketContext}</p>
            </div>`;
        }
        
        if (project.capabilityFit) {
            html += `
            <div class="project-capability" style="margin-top: 15px;">
                <h4>🔧 Capability Fit</h4>
                <p>${project.capabilityFit}</p>
            </div>`;
        }
        
        if (showTeam && project.team) {
            html += `
            <div class="project-team">
                <h4>👥 Team</h4>
                <div class="team-lead">
                    <strong>${project.team.lead}</strong>
                    <span class="lead-title">${project.team.leadTitle}</span>
                </div>
                <p class="team-size">${project.team.size} team members</p>
            </div>`;
        }
        
        if (project.strategicBuckets && project.strategicBuckets.length > 0) {
            html += `
            <div class="project-strategic">
                <h4>🎯 Strategic Fit</h4>
                <div class="strategic-buckets">
                    ${project.strategicBuckets.map(b => `<span class="bucket-tag">${b.icon || '📌'} ${b.name}</span>`).join('')}
                </div>
            </div>`;
        }
        
        document.getElementById('year2-project-card').innerHTML = html;
    }
    
    function renderYear2ScoringGrid(project) {
        const criteria = [
            { id: 'technical', label: 'Technical Feasibility', icon: '🔧' },
            { id: 'marketsize', label: 'Market Size', icon: '📊' },
            { id: 'strategic', label: 'Strategic Alignment', icon: '🎯' },
            { id: 'roi', label: 'ROI Potential', icon: '💰' },
            { id: 'risk', label: 'Risk Level (5=Low Risk)', icon: '⚠️' }
        ];
        
        // Initialize player scores if not exists
        if (!project.playerScores) {
            project.playerScores = {};
            criteria.forEach(c => project.playerScores[c.id] = 3);
        }
        
        const html = criteria.map(criterion => `
            <div class="scoring-row">
                <div class="scoring-label">
                    <span class="scoring-icon">${criterion.icon}</span>
                    <span>${criterion.label}</span>
                </div>
                <div class="scoring-slider-container">
                    <input type="range" min="1" max="5" value="${project.playerScores[criterion.id]}" 
                           class="scoring-slider" data-criterion="${criterion.id}"
                           oninput="updateYear2Score('${project.id}', '${criterion.id}', this.value)">
                    <div class="scoring-value">${project.playerScores[criterion.id]}</div>
                </div>
            </div>
        `).join('');
        
        document.getElementById('year2-scoring-grid').innerHTML = html;
        updateYear2AverageScore(project);
    }
    
    function updateYear2Score(projectId, criterion, value) {
        const project = year2ProjectPool.find(p => p.id === projectId);
        if (project) {
            project.playerScores[criterion] = parseInt(value);
            
            // Update displayed value
            const slider = document.querySelector(`#year2-scoring-grid input[data-criterion="${criterion}"]`);
            if (slider) {
                slider.nextElementSibling.textContent = value;
            }
            
            updateYear2AverageScore(project);
        }
    }
    
    function updateYear2AverageScore(project) {
        if (!project.playerScores) return;
        
        const scores = Object.values(project.playerScores);
        const avg = scores.reduce((a, b) => a + b, 0) / scores.length;
        project.playerAvg = avg;
        
        document.getElementById('year2-player-avg-score').textContent = avg.toFixed(1);
    }
    
    function year2NextProject() {
        if (year2CurrentProjectIndex < year2ProjectPool.length - 1) {
            year2CurrentProjectIndex++;
            renderYear2Assessment();
        } else {
            // Assessment complete - calculate committee scores and show feedback
            calculateYear2CommitteeScores();
            showYear2CommitteeFeedback();
        }
    }
    
    function year2PrevProject() {
        if (year2CurrentProjectIndex > 0) {
            year2CurrentProjectIndex--;
            renderYear2Assessment();
        }
    }
    
    function calculateYear2CommitteeScores() {
        // Get committee or create a default one for solo/random modes
        const committee = gameState.selectedCommittee || [
            { id: 'default1', name: 'Technical Lead', bias: { technical: 0.5 } },
            { id: 'default2', name: 'Product Manager', bias: { marketsize: 0.5 } },
            { id: 'default3', name: 'Strategy Director', bias: { strategic: 0.5 } }
        ];
        
        year2ProjectPool.forEach(project => {
            // Generate committee member scores based on project's actual scores with some noise
            const committeeScores = {};
            committee.forEach(member => {
                const memberScores = {};
                const criteria = ['technical', 'marketsize', 'strategic', 'roi', 'risk'];
                
                criteria.forEach(criterion => {
                    // Base score from project's true scores
                    const baseScore = project.scores[criterion] || 3;
                    // Add member bias based on their expertise/role
                    let bias = 0;
                    if (member.bias && member.bias[criterion]) {
                        bias = member.bias[criterion];
                    }
                    // Add randomness
                    const noise = (Math.random() - 0.5) * 1.5;
                    const score = Math.max(1, Math.min(5, Math.round(baseScore + bias + noise)));
                    memberScores[criterion] = score;
                });
                
                const avg = Object.values(memberScores).reduce((a, b) => a + b, 0) / Object.values(memberScores).length;
                committeeScores[member.id] = { scores: memberScores, avg };
            });
            
            project.committeeScores = committeeScores;
            
            // Calculate overall committee average
            const avgScores = Object.values(committeeScores).map(c => c.avg);
            project.committeeAvg = avgScores.length > 0 ? avgScores.reduce((a, b) => a + b, 0) / avgScores.length : 3;
            
            // Calculate overall average (player + committee)
            if (project.playerAvg) {
                project.overallAvg = (project.playerAvg + project.committeeAvg) / 2;
            } else {
                project.overallAvg = project.committeeAvg;
            }
        });
        
        // Rank projects by overall average
        year2RankedProjects = [...year2ProjectPool].sort((a, b) => b.overallAvg - a.overallAvg);
    }
    
    function showYear2CommitteeFeedback() {
        // Render the new projects rankings
        renderYear2NewRankings();
        
        // Render ongoing projects for comparison
        renderYear2OngoingRankings();
        
        // Render comparison view
        renderYear2ComparisonView();
        
        // Render triage grid
        renderYear2TriageGrid();
        
        // Show first tab
        switchYear2FeedbackTab('new');
        
        showPhase('year2-committee-feedback');
    }
    
    function switchYear2FeedbackTab(tab) {
        // Update tab buttons
        document.querySelectorAll('#phase-year2-committee-feedback .feedback-tab').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.tab === tab);
        });
        
        // Show/hide content
        document.getElementById('year2-feedback-new').classList.toggle('hidden', tab !== 'new');
        document.getElementById('year2-feedback-ongoing').classList.toggle('hidden', tab !== 'ongoing');
        document.getElementById('year2-feedback-comparison').classList.toggle('hidden', tab !== 'comparison');
    }
    
    function renderYear2NewRankings() {
        const html = year2RankedProjects.map((project, index) => {
            const rank = index + 1;
            const medal = rank === 1 ? '🥇' : rank === 2 ? '🥈' : rank === 3 ? '🥉' : `#${rank}`;
            
            return `
                <div class="ranking-item expanded" style="flex-direction: column; align-items: stretch; padding: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                        <div style="display: flex; gap: 15px; align-items: flex-start;">
                            <div class="ranking-rank" style="font-size: 1.5em;">${medal}</div>
                            <div>
                                <div class="ranking-name" style="font-size: 1.1em; font-weight: 600;">${project.name}</div>
                                <div class="ranking-tagline" style="color: var(--gray-600); font-style: italic;">${project.tagline}</div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.2em; font-weight: 700; color: var(--gold-dark);">$${project.budget}M </div>
                            <div style="font-size: 0.85em; color: var(--gray-500);">${project.timeline} quarters</div>
                        </div>
                    </div>
                    
                    <div style="background: var(--gray-50); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                        <p style="margin: 0; color: var(--gray-700); line-height: 1.5;">${project.desc || project.description || 'No description available.'}</p>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <div class="ranking-scores" style="display: flex; gap: 8px; flex-wrap: wrap;">
                            ${project.playerAvg ? `<div class="score-pill you">You: ${project.playerAvg.toFixed(1)}</div>` : ''}
                            <div class="score-pill committee">Committee: ${project.committeeAvg.toFixed(1)}</div>
                            <div class="score-pill overall">Overall: ${project.overallAvg.toFixed(1)}</div>
                        </div>
                        <button class="btn btn-small" onclick="openProjectModal('${project.id}', 'year2')">View Full Details</button>
                    </div>
                </div>
            `;
        }).join('');
        
        document.getElementById('year2-new-rankings').innerHTML = html;
    }
    
    function renderYear2OngoingRankings() {
        // Show ongoing active projects with their original Year 1 scores
        const ongoingProjects = [...gameState.activeProjects].sort((a, b) => (b.overallAvg || 0) - (a.overallAvg || 0));
        
        if (ongoingProjects.length === 0) {
            document.getElementById('year2-ongoing-rankings').innerHTML = `
                <div style="text-align: center; padding: 30px; color: var(--gray-500);">
                    <div style="font-size: 2em; margin-bottom: 10px;">📭</div>
                    <p>No ongoing projects. All Year 1 projects have completed or been terminated.</p>
                </div>
            `;
            return;
        }
        
        const html = ongoingProjects.map((project, index) => {
            const progress = project.latestUpdate?.progress || 0;
            const spent = Math.round(((project.spentBudget || 0) / project.budget) * 100);
            
            return `
                <div class="ranking-item ongoing expanded" style="flex-direction: column; align-items: stretch; padding: 15px; background: var(--primary-lighter); border-left: 4px solid var(--primary);">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                        <div style="display: flex; gap: 15px; align-items: flex-start;">
                            <div class="ranking-rank" style="background: var(--primary); color: white;">${index + 1}</div>
                            <div>
                                <div class="ranking-name" style="font-size: 1.1em; font-weight: 600;">${project.name}</div>
                                <div class="ranking-tagline" style="color: var(--gray-600);">${progress}% complete · ${spent}% budget spent</div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.2em; font-weight: 700; color: var(--primary);">$${project.budget}M </div>
                            <div style="font-size: 0.85em; color: var(--gray-500);">Original Score: ${(project.overallAvg || 3).toFixed(1)}</div>
                        </div>
                    </div>
                    
                    <div style="background: white; padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                        <p style="margin: 0; color: var(--gray-700); line-height: 1.5;">${project.desc || project.shortDesc || project.description || 'No description available.'}</p>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; gap: 10px;">
                            <span style="background: var(--primary); color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.85em;">📂 Ongoing</span>
                            <span style="background: var(--gray-200); padding: 4px 10px; border-radius: 12px; font-size: 0.85em;">${project.timeline}Q timeline</span>
                        </div>
                        <button class="btn btn-small" onclick="openProjectModal('${project.id}', 'ongoing')">View Full Details</button>
                    </div>
                </div>
            `;
        }).join('');
        
        document.getElementById('year2-ongoing-rankings').innerHTML = html;
    }
    
    function renderYear2ComparisonView() {
        // Create a merged view showing all projects ranked together
        const allProjects = [
            ...year2RankedProjects.map(p => ({ ...p, source: 'new' })),
            ...gameState.activeProjects.map(p => ({ ...p, source: 'ongoing' }))
        ].sort((a, b) => (b.overallAvg || 0) - (a.overallAvg || 0));
        
        const html = allProjects.map((project, index) => {
            const isNew = project.source === 'new';
            const badge = isNew ? '🆕' : '📂';
            const badgeClass = isNew ? 'new' : 'ongoing';
            
            return `
                <div class="comparison-item ${badgeClass}">
                    <div class="comparison-rank">#${index + 1}</div>
                    <div class="comparison-badge ${badgeClass}">${badge}</div>
                    <div class="comparison-info">
                        <div class="comparison-name">${project.name}</div>
                    </div>
                    <div class="comparison-score">${(project.overallAvg || 3).toFixed(1)}</div>
                    <div class="comparison-budget">$${project.budget}M </div>
                </div>
            `;
        }).join('');
        
        // Add insight
        const topNew = allProjects.findIndex(p => p.source === 'new');
        const topOngoing = allProjects.findIndex(p => p.source === 'ongoing');
        
        let insight = '';
        if (topNew < topOngoing && topNew >= 0 && topOngoing >= 0) {
            insight = `<div class="comparison-insight success">💡 Your top new opportunity (#${topNew + 1}) ranks higher than your top ongoing project (#${topOngoing + 1}). Consider prioritizing new investments.</div>`;
        } else if (topOngoing < topNew && topNew >= 0 && topOngoing >= 0) {
            insight = `<div class="comparison-insight info">💡 Your ongoing projects (#${topOngoing + 1}) rank higher than new opportunities (#${topNew + 1}). Your current portfolio may be well-positioned.</div>`;
        }
        
        document.getElementById('year2-comparison-view').innerHTML = insight + `<div class="comparison-list">${html}</div>`;
    }
    
    function renderYear2TriageGrid() {
        const html = year2RankedProjects.map(project => {
            const triage = year2ProjectTriage[project.id] || 'marginal';
            
            return `
                <div class="triage-item" data-project-id="${project.id}">
                    <div class="triage-project-info">
                        <span class="triage-project-name">${project.name}</span>
                        <span class="triage-project-score">Score: ${project.overallAvg.toFixed(1)} · $${project.budget}M </span>
                    </div>
                    <div class="triage-buttons">
                        <button class="triage-btn fund ${triage === 'fund' ? 'selected' : ''}" 
                                onclick="setYear2Triage('${project.id}', 'fund')">
                            ✅ Fund
                        </button>
                        <button class="triage-btn marginal ${triage === 'marginal' ? 'selected' : ''}" 
                                onclick="setYear2Triage('${project.id}', 'marginal')">
                            ⚖️ Maybe
                        </button>
                        <button class="triage-btn stop ${triage === 'stop' ? 'selected' : ''}" 
                                onclick="setYear2Triage('${project.id}', 'stop')">
                            🚫 Skip
                        </button>
                    </div>
                </div>
            `;
        }).join('');
        
        document.getElementById('year2-triage-grid').innerHTML = html;
    }
    
    function setYear2Triage(projectId, decision) {
        year2ProjectTriage[projectId] = decision;
        
        // Update UI
        const item = document.querySelector(`.triage-item[data-project-id="${projectId}"]`);
        if (item) {
            item.querySelectorAll('.triage-btn').forEach(btn => btn.classList.remove('selected'));
            item.querySelector(`.triage-btn.${decision}`).classList.add('selected');
        }
    }
    
    // Year 2 Portfolio Builder state
    let year2PortfolioMatrix = 'risk-speed';
    let year2PortfolioView = 'matrix';
    let year2BaseAvailableBudget = 0; // Budget available before any new selections
    
    function proceedToYear2PortfolioBuilder() {
        // Calculate budget for Year 2 selection
        const ongoingProjectNeeds = gameState.activeProjects.reduce((sum, p) => {
            const remaining = (p.budget || 0) - (p.spentBudget || 0);
            return sum + Math.max(0, remaining);
        }, 0);
        
        const completedProjectSpending = (gameState.completedProjects || []).reduce((sum, p) => {
            return sum + (p.spentBudget || 0);
        }, 0);
        
        const killedProjectSpending = (gameState.killedProjects || []).reduce((sum, p) => {
            return sum + (p.spentBudget || 0);
        }, 0);
        
        const totalCommitted = ongoingProjectNeeds + completedProjectSpending + killedProjectSpending;
        year2BaseAvailableBudget = Math.max(0, gameState.maxBudget - totalCommitted);
        
        // Ensure minimum budget for gameplay
        if (year2BaseAvailableBudget < gameState.maxBudget * 0.05) {
            year2BaseAvailableBudget = gameState.maxBudget * 0.05;
        }
        
        year2AvailableBudget = year2BaseAvailableBudget;
        
        // Pre-select funded projects
        year2SelectedProjects = [];
        year2RankedProjects.forEach(project => {
            if (year2ProjectTriage[project.id] === 'fund' && project.budget <= year2AvailableBudget) {
                year2SelectedProjects.push(project.id);
                year2AvailableBudget -= project.budget;
            }
        });
        
        year2PortfolioMatrix = 'risk-speed';
        year2PortfolioView = 'matrix';
        
        renderYear2PortfolioBuilder();
        showPhase('year2-selection');
    }
    
    function renderYear2PortfolioBuilder() {
        renderYear2PortfolioMatrix();
        renderYear2PortfolioList();
        updateYear2PortfolioSidebar();
        
        // Update view tabs
        document.querySelectorAll('#phase-year2-selection .view-tab').forEach(tab => {
            tab.classList.toggle('active', tab.dataset.view === year2PortfolioView);
        });
        document.getElementById('year2-portfolio-matrix-view').classList.toggle('hidden', year2PortfolioView !== 'matrix');
        document.getElementById('year2-portfolio-list-view').classList.toggle('hidden', year2PortfolioView !== 'list');
    }
    
    function switchYear2PortfolioView(view) {
        year2PortfolioView = view;
        document.querySelectorAll('#phase-year2-selection .view-tab').forEach(tab => {
            tab.classList.toggle('active', tab.dataset.view === view);
        });
        document.getElementById('year2-portfolio-matrix-view').classList.toggle('hidden', view !== 'matrix');
        document.getElementById('year2-portfolio-list-view').classList.toggle('hidden', view !== 'list');
    }
    
    function switchYear2PortfolioMatrix(matrixType) {
        year2PortfolioMatrix = matrixType;
        document.querySelectorAll('#phase-year2-selection .matrix-tab').forEach(tab => {
            tab.classList.toggle('active', tab.dataset.matrix === matrixType);
        });
        renderYear2PortfolioMatrix();
    }
    
    function renderYear2PortfolioMatrix() {
        const config = matrixConfigs[year2PortfolioMatrix];
        const container = document.getElementById('year2-portfolio-matrix');
        if (!container || !config) return;
        
        const quadrantsHtml = `
            <div class="matrix-quadrant q1"><div class="quadrant-label">${config.quadrants.q1.label}</div></div>
            <div class="matrix-quadrant q2"><div class="quadrant-label">${config.quadrants.q2.label}</div></div>
            <div class="matrix-quadrant q3"><div class="quadrant-label">${config.quadrants.q3.label}</div></div>
            <div class="matrix-quadrant q4"><div class="quadrant-label">${config.quadrants.q4.label}</div></div>
        `;
        
        const axesHtml = `
            <div class="matrix-axis horizontal"></div>
            <div class="matrix-axis vertical"></div>
            <div class="axis-label x-min">${config.xAxis.min}</div>
            <div class="axis-label x-max">${config.xAxis.max}</div>
            <div class="axis-label y-min">${config.yAxis.min}</div>
            <div class="axis-label y-max">${config.yAxis.max}</div>
        `;
        
        // Build ongoing project bubbles (blue) - click to view details
        const ongoingHtml = gameState.activeProjects.map(project => {
            const scores = project.scores || {};
            const xScore = scores[config.xAxis.key] || 3;
            const yScore = scores[config.yAxis.key] || 3;
            const xPos = ((xScore - 1) / 4) * 80 + 10;
            const yPos = 90 - ((yScore - 1) / 4) * 80;
            const size = 50;
            
            return `
                <div class="project-bubble funded" 
                     style="left: calc(${xPos}% - ${size/2}px); top: calc(${yPos}% - ${size/2}px); width: ${size}px; height: ${size}px;"
                     onclick="openProjectModal('${project.id}', 'ongoing')"
                     data-project-id="${project.id}">
                    <div class="bubble-tooltip">
                        <div class="tooltip-name">${project.name}</div>
                        <div class="tooltip-budget">$${project.budget}M </div>
                        <div style="font-size: 0.85em; margin-top: 4px; opacity: 0.8;">📂 Ongoing - Click for details</div>
                    </div>
                </div>
            `;
        }).join('');
        
        // Build new project bubbles - click to view details and add/remove
        const newHtml = year2RankedProjects.map(project => {
            const scores = project.scores || {};
            const xScore = scores[config.xAxis.key] || 3;
            const yScore = scores[config.yAxis.key] || 3;
            const xPos = ((xScore - 1) / 4) * 80 + 10;
            const yPos = 90 - ((yScore - 1) / 4) * 80;
            const size = 50;
            
            const isSelected = year2SelectedProjects.includes(project.id);
            const isSkipped = year2ProjectTriage[project.id] === 'stop';
            const canAfford = project.budget <= year2AvailableBudget || isSelected;
            
            let statusClass, statusText;
            
            if (isSkipped) {
                statusClass = 'stopped';
                statusText = '🚫 Skipped';
            } else if (isSelected) {
                statusClass = 'marginal-in';
                statusText = '✅ Selected';
            } else if (canAfford) {
                statusClass = 'marginal-out';
                statusText = '🆕 Available';
            } else {
                statusClass = 'unaffordable';
                statusText = '💰 Over budget';
            }
            
            return `
                <div class="project-bubble ${statusClass}" 
                     style="left: calc(${xPos}% - ${size/2}px); top: calc(${yPos}% - ${size/2}px); width: ${size}px; height: ${size}px;"
                     onclick="openProjectModal('${project.id}', 'year2')"
                     data-project-id="${project.id}">
                    <div class="bubble-tooltip">
                        <div class="tooltip-name">${project.name}</div>
                        <div class="tooltip-budget">$${project.budget}M • Score: ${(project.overallAvg || 3).toFixed(1)}</div>
                        <div style="font-size: 0.85em; margin-top: 4px; opacity: 0.8;">${statusText} - Click for details</div>
                    </div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = quadrantsHtml + axesHtml + ongoingHtml + newHtml;
    }
    
    function year2Toggle(projectId) {
        const project = year2RankedProjects.find(p => p.id === projectId);
        if (!project) return;
        if (year2ProjectTriage[projectId] === 'stop') return;
        
        const index = year2SelectedProjects.indexOf(projectId);
        if (index >= 0) {
            year2SelectedProjects.splice(index, 1);
            year2AvailableBudget += project.budget;
        } else if (project.budget <= year2AvailableBudget) {
            year2SelectedProjects.push(projectId);
            year2AvailableBudget -= project.budget;
        }
        
        renderYear2PortfolioBuilder();
    }
    
    function renderYear2PortfolioList() {
        const container = document.getElementById('year2-portfolio-list');
        
        // Ongoing projects section
        let html = `
            <div class="portfolio-list-section">
                <h3 style="color: var(--primary); margin-bottom: 15px;">📂 Ongoing Projects (Year 1)</h3>
                <div class="portfolio-list-items">
        `;
        
        if (gameState.activeProjects.length === 0) {
            html += `<p style="color: var(--gray-500); padding: 10px;">No ongoing projects.</p>`;
        } else {
            gameState.activeProjects.forEach(project => {
                const progress = project.latestUpdate?.progress || 0;
                html += `
                    <div class="portfolio-list-item ongoing" style="background: var(--primary-lighter); border-left: 4px solid var(--primary); cursor: pointer;"
                         onclick="openProjectModal('${project.id}', 'ongoing')">
                        <div class="item-info" style="flex: 1;">
                            <span class="item-name">${project.name}</span>
                            <span class="item-detail">${(project.desc || project.shortDesc || '').substring(0, 80)}...</span>
                            <span class="item-detail" style="color: var(--primary);">${progress}% complete · $${project.budget}M</span>
                        </div>
                        <span class="item-status" style="color: var(--primary);">🔒 Continuing</span>
                    </div>
                `;
            });
        }
        
        html += `</div></div>`;
        
        // New projects section
        html += `
            <div class="portfolio-list-section">
                <h3 style="color: var(--success); margin-bottom: 15px;">🆕 New Projects (Year 2)</h3>
                <div class="portfolio-list-items">
        `;
        
        year2RankedProjects.forEach((project, index) => {
            const isSelected = year2SelectedProjects.includes(project.id);
            const triage = year2ProjectTriage[project.id];
            const isSkipped = triage === 'stop';
            const canAfford = project.budget <= year2AvailableBudget || isSelected;
            
            let statusHtml, bgStyle;
            if (isSkipped) {
                statusHtml = `<span class="item-status" style="color: var(--gray-400);">🚫 Skipped</span>`;
                bgStyle = 'background: var(--gray-100); opacity: 0.7;';
            } else if (isSelected) {
                statusHtml = `<button class="btn btn-small" style="background: var(--danger);" onclick="event.stopPropagation(); year2Toggle('${project.id}')">Remove</button>`;
                bgStyle = 'background: var(--success-light); border-left: 4px solid var(--success);';
            } else if (canAfford) {
                statusHtml = `<button class="btn btn-small" onclick="event.stopPropagation(); year2Toggle('${project.id}')">+ Add</button>`;
                bgStyle = 'background: white;';
            } else {
                statusHtml = `<span class="item-status" style="color: var(--warning);">💰 Over budget</span>`;
                bgStyle = 'background: var(--warning-light);';
            }
            
            html += `
                <div class="portfolio-list-item" style="${bgStyle} cursor: pointer;" 
                     onclick="openProjectModal('${project.id}', 'year2')">
                    <div class="item-info" style="flex: 1;">
                        <span class="item-name">#${index + 1} ${project.name}</span>
                        <span class="item-detail">${(project.desc || project.shortDesc || '').substring(0, 80)}...</span>
                        <span class="item-detail" style="color: var(--primary);">Score: ${project.overallAvg.toFixed(1)} · $${project.budget}M · ${project.timeline}Q</span>
                    </div>
                    ${statusHtml}
                </div>
            `;
        });
        
        html += `</div></div>`;
        
        container.innerHTML = html;
    }
    
    function updateYear2PortfolioSidebar() {
        // Calculate spending on new projects
        const newProjectSpending = year2SelectedProjects.reduce((sum, projectId) => {
            const project = year2RankedProjects.find(p => p.id === projectId);
            return sum + (project?.budget || 0);
        }, 0);
        
        // Update budget breakdown
        const breakdownEl = document.getElementById('year2-budget-breakdown');
        if (breakdownEl) {
            const ongoingProjectNeeds = gameState.activeProjects.reduce((sum, p) => {
                const remaining = (p.budget || 0) - (p.spentBudget || 0);
                return sum + Math.max(0, remaining);
            }, 0);
            
            breakdownEl.innerHTML = `
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                    <span>Annual Budget:</span>
                    <strong>$${gameState.maxBudget.toFixed(1)}M </strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px; color: var(--primary);">
                    <span>Ongoing Projects:</span>
                    <strong>-$${ongoingProjectNeeds.toFixed(1)}M </strong>
                </div>
                <div style="display: flex; justify-content: space-between; padding-top: 6px; border-top: 1px solid var(--gray-200); color: var(--success); font-weight: 600;">
                    <span>Available for New:</span>
                    <span>$${year2BaseAvailableBudget.toFixed(1)}M </span>
                </div>
            `;
        }
        
        // Update budget meter
        const percentageUsed = year2BaseAvailableBudget > 0 ? (newProjectSpending / year2BaseAvailableBudget) * 100 : 0;
        const fillEl = document.getElementById('year2-budget-fill');
        if (fillEl) {
            fillEl.style.width = `${Math.min(100, percentageUsed)}%`;
            if (newProjectSpending > year2BaseAvailableBudget) {
                fillEl.style.background = 'var(--danger)';
            } else if (percentageUsed > 80) {
                fillEl.style.background = 'var(--warning)';
            } else {
                fillEl.style.background = 'linear-gradient(90deg, var(--success) 0%, var(--success-light) 100%)';
            }
        }
        
        document.getElementById('year2-budget-remaining').textContent = `$${newProjectSpending.toFixed(1)}M spent`;
        document.getElementById('year2-budget-available').textContent = `of $${year2BaseAvailableBudget.toFixed(1)}M`;
        
        // Update portfolio summary
        const summaryEl = document.getElementById('year2-portfolio-summary');
        if (summaryEl) {
            summaryEl.innerHTML = `
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span>Ongoing Projects:</span>
                    <strong>${gameState.activeProjects.length}</strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px; color: var(--success);">
                    <span>New Projects:</span>
                    <strong>+${year2SelectedProjects.length}</strong>
                </div>
                <div style="display: flex; justify-content: space-between; padding-top: 8px; border-top: 1px solid var(--gray-200);">
                    <span>Total Active:</span>
                    <strong>${gameState.activeProjects.length + year2SelectedProjects.length}</strong>
                </div>
            `;
        }
        
        // Update new project list
        const listEl = document.getElementById('year2-new-project-list');
        if (listEl) {
            listEl.innerHTML = year2RankedProjects.map((project, index) => {
                const isSelected = year2SelectedProjects.includes(project.id);
                const isSkipped = year2ProjectTriage[project.id] === 'stop';
                
                let icon = '⚖️';
                if (isSelected) icon = '✅';
                else if (isSkipped) icon = '🚫';
                
                return `
                    <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--gray-100); ${isSkipped ? 'opacity: 0.5;' : ''}">
                        <span style="font-size: 0.85em;">${icon} #${index + 1} ${project.name}</span>
                        <span style="font-size: 0.85em; color: var(--gray-500);">$${project.budget}M</span>
                    </div>
                `;
            }).join('');
        }
        
        // Update confirm button
        const isOverBudget = newProjectSpending > year2BaseAvailableBudget;
        const confirmBtn = document.getElementById('confirm-year2-portfolio-btn');
        if (confirmBtn) {
            if (isOverBudget) {
                confirmBtn.disabled = true;
                confirmBtn.textContent = '⚠️ Over Budget';
            } else {
                confirmBtn.disabled = false;
                confirmBtn.textContent = `Confirm Year 2 Portfolio (${gameState.activeProjects.length + year2SelectedProjects.length} projects) →`;
            }
        }
    }
    
    function confirmYear2Portfolio() {
        // Add selected Year 2 projects to active projects
        year2SelectedProjects.forEach(projectId => {
            const project = year2RankedProjects.find(p => p.id === projectId);
            if (project) {
                gameState.activeProjects.push({
                    ...project,
                    status: 'active',
                    progress: 0,
                    currentQuarter: 0,
                    quartersActive: 0,
                    spentBudget: 0,
                    startQuarter: gameState.currentQuarter,
                    isYear2Project: true,
                    decision: 'continue'
                });
            }
        });
        
        // Go to budget meeting
        showYear2BudgetMeeting();
    }
    
    // Keep old functions for backward compatibility but redirect
    function skipYear2Selection() {
        confirmYear2Portfolio();
    }
    
    function confirmYear2Selection() {
        confirmYear2Portfolio();
    }
    
    function showYear2ProjectSelection() {
        console.log('showYear2ProjectSelection called');
        
        // Generate new project pool for Year 2
        year2ProjectPool = generateYear2ProjectPool();
        console.log('Generated Year 2 pool:', year2ProjectPool.length, 'projects');
        console.log('Year 2 pool:', year2ProjectPool);
        
        year2SelectedProjects = [];
        
        // Calculate ongoing project needs (remaining costs for active projects)
        const ongoingProjectNeeds = gameState.activeProjects.reduce((sum, p) => {
            const remaining = (p.budget || 0) - (p.spentBudget || 0);
            return sum + Math.max(0, remaining);
        }, 0);
        
        // Calculate what was spent on completed projects (this money is gone)
        const completedProjectSpending = (gameState.completedProjects || []).reduce((sum, p) => {
            return sum + (p.spentBudget || 0);
        }, 0);
        
        // Calculate what was spent on killed projects (partial spending before kill)
        const killedProjectSpending = (gameState.killedProjects || []).reduce((sum, p) => {
            return sum + (p.spentBudget || 0);
        }, 0);
        
        // Total committed = ongoing needs + already spent on completed/killed
        const totalCommitted = ongoingProjectNeeds + completedProjectSpending + killedProjectSpending;
        
        // Available = new allocation minus all committed spending
        year2AvailableBudget = Math.max(0, gameState.maxBudget - totalCommitted);
        
        // Ensure at least a small refresh budget for gameplay (5% of max, reduced from 10%)
        const minRefreshBudget = gameState.maxBudget * 0.05;
        if (year2AvailableBudget < minRefreshBudget) {
            year2AvailableBudget = minRefreshBudget;
        }
        
        console.log('MaxBudget:', gameState.maxBudget, 'Ongoing needs:', ongoingProjectNeeds, 
                    'Completed spending:', completedProjectSpending, 'Killed spending:', killedProjectSpending,
                    'Available:', year2AvailableBudget);
        
        // Render the Year 2 project grid
        renderYear2ProjectGrid();
        updateYear2BudgetDisplay();
        
        showPhase('year2-selection');
    }
    
    function renderYear2ProjectGrid() {
        console.log('renderYear2ProjectGrid called');
        const grid = document.getElementById('year2-project-grid');
        console.log('Grid element:', grid);
        console.log('year2ProjectPool length:', year2ProjectPool.length);
        
        if (!grid) {
            console.error('Could not find year2-project-grid element!');
            return;
        }
        
        grid.innerHTML = '';
        
        if (year2ProjectPool.length === 0) {
            grid.innerHTML = '<p style="text-align: center; color: var(--gray-500); padding: 20px;">No new projects available.</p>';
            return;
        }
        
        // Use ranked projects if available, otherwise use pool
        const projectsToShow = year2RankedProjects.length > 0 ? year2RankedProjects : year2ProjectPool;
        
        projectsToShow.forEach((project, index) => {
            const isSelected = year2SelectedProjects.includes(project.id);
            const canAfford = project.budget <= year2AvailableBudget || isSelected;
            const triage = year2ProjectTriage[project.id];
            const isFunded = triage === 'fund';
            const isStopped = triage === 'stop';
            
            const card = document.createElement('div');
            card.className = 'project-card' + (isSelected ? ' selected' : '') + (!canAfford ? ' unaffordable' : '');
            
            let borderColor = 'var(--gray-200)';
            let bgColor = 'white';
            if (isSelected) {
                borderColor = 'var(--success)';
                bgColor = 'var(--success-light)';
            } else if (isFunded) {
                borderColor = 'var(--success)';
            } else if (isStopped) {
                borderColor = 'var(--gray-300)';
                bgColor = 'var(--gray-100)';
            }
            
            card.style.cssText = `
                background: ${bgColor};
                border: 2px solid ${borderColor};
                border-radius: 12px;
                padding: 20px;
                cursor: ${canAfford && !isStopped ? 'pointer' : 'not-allowed'};
                opacity: ${canAfford && !isStopped ? '1' : '0.6'};
                transition: all 0.2s;
            `;
            
            if (canAfford && !isStopped) {
                card.onclick = () => toggleYear2Project(project.id);
            }
            
            // Show rank and score if available
            const rankBadge = year2RankedProjects.length > 0 
                ? `<span style="background: var(--primary); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.75em; font-weight: 600;">#${index + 1} · ${(project.overallAvg || 3).toFixed(1)}</span>`
                : '';
            
            const triageBadge = isFunded 
                ? '<span style="background: var(--success); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.75em; margin-left: 5px;">✓ Funded</span>'
                : isStopped 
                    ? '<span style="background: var(--gray-400); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.75em; margin-left: 5px;">Skipped</span>'
                    : '';
            
            card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                    <div>
                        <div style="margin-bottom: 6px;">${rankBadge}${triageBadge}</div>
                        <h3 style="margin: 0 0 4px; color: var(--primary); font-size: 1.1em;">${project.name}</h3>
                        <span style="font-size: 0.8em; color: var(--gray-500); font-style: italic;">${project.tagline}</span>
                    </div>
                    <div style="background: var(--gold-light); color: var(--gold-dark); padding: 4px 10px; border-radius: 20px; font-weight: 700; font-size: 0.9em;">
                        $${project.budget} M
                    </div>
                </div>
                <p style="margin: 0 0 12px; color: var(--gray-600); font-size: 0.9em; line-height: 1.5;">${(project.desc || project.description || '').substring(0, 150)}${(project.desc || project.description || '').length > 150 ? '...' : ''}</p>
                <div style="display: flex; gap: 15px; font-size: 0.85em; color: var(--gray-500);">
                    <span>⏱️ ${project.timeline}Q timeline</span>
                    <span>📊 ${Math.round(project.successProb * 100)}% base success</span>
                </div>
                ${isSelected ? '<div style="margin-top: 10px; text-align: center; color: var(--success); font-weight: 600;">✓ Selected</div>' : ''}
            `;
            
            grid.appendChild(card);
        });
    }
    
    function toggleYear2Project(projectId) {
        const project = year2ProjectPool.find(p => p.id === projectId);
        if (!project) return;
        
        // Don't allow toggling stopped projects
        if (year2ProjectTriage[projectId] === 'stop') return;
        
        const index = year2SelectedProjects.indexOf(projectId);
        
        if (index >= 0) {
            // Deselect
            year2SelectedProjects.splice(index, 1);
            year2AvailableBudget += project.budget;
        } else {
            // Select (if can afford)
            if (project.budget <= year2AvailableBudget) {
                year2SelectedProjects.push(projectId);
                year2AvailableBudget -= project.budget;
            }
        }
        
        renderYear2ProjectGrid();
        updateYear2BudgetDisplay();
    }
    
    function updateYear2BudgetDisplay() {
        // Calculate budget components for display
        const ongoingProjectNeeds = gameState.activeProjects.reduce((sum, p) => {
            const remaining = (p.budget || 0) - (p.spentBudget || 0);
            return sum + Math.max(0, remaining);
        }, 0);
        
        const completedProjectSpending = (gameState.completedProjects || []).reduce((sum, p) => {
            return sum + (p.spentBudget || 0);
        }, 0);
        
        const killedProjectSpending = (gameState.killedProjects || []).reduce((sum, p) => {
            return sum + (p.spentBudget || 0);
        }, 0);
        
        // Calculate spending on newly selected Year 2 projects
        const newProjectSpending = year2SelectedProjects.reduce((sum, projectId) => {
            const project = year2ProjectPool.find(p => p.id === projectId);
            return sum + (project?.budget || 0);
        }, 0);
        
        const totalCommitted = ongoingProjectNeeds + completedProjectSpending + killedProjectSpending;
        const baseAvailable = Math.max(0, gameState.maxBudget - totalCommitted);
        
        // Update breakdown display
        const breakdownEl = document.getElementById('year2-budget-breakdown');
        if (breakdownEl) {
            breakdownEl.innerHTML = `
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                    <span>Year 2 Budget:</span>
                    <strong>$${gameState.maxBudget.toFixed(1)}M </strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px; color: var(--warning);">
                    <span>Active Projects (remaining):</span>
                    <strong>-$${ongoingProjectNeeds.toFixed(1)}M </strong>
                </div>
                ${completedProjectSpending > 0 ? `
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px; color: var(--gray-500);">
                    <span>Spent on Completed:</span>
                    <strong>-$${completedProjectSpending.toFixed(1)}M </strong>
                </div>` : ''}
                ${killedProjectSpending > 0 ? `
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px; color: var(--gray-500);">
                    <span>Spent before Kill:</span>
                    <strong>-$${killedProjectSpending.toFixed(1)}M </strong>
                </div>` : ''}
                <div style="display: flex; justify-content: space-between; padding-top: 6px; border-top: 1px solid var(--gray-200); color: var(--primary); font-weight: 600;">
                    <span>Available for New:</span>
                    <span>$${baseAvailable.toFixed(1)}M </span>
                </div>
            `;
        }
        
        const remainingAfterSelection = year2AvailableBudget;
        document.getElementById('year2-budget-remaining').textContent = '$' + Math.round(remainingAfterSelection * 10) / 10 + ' M remaining';
        document.getElementById('year2-projects-selected').textContent = year2SelectedProjects.length;
        
        // Enable/disable confirm button - allow if projects selected and within budget
        const confirmBtn = document.getElementById('confirm-year2-selection-btn');
        const isOverBudget = newProjectSpending > baseAvailable;
        confirmBtn.disabled = year2SelectedProjects.length === 0 || isOverBudget;
        
        if (isOverBudget) {
            confirmBtn.textContent = '⚠️ Over Budget';
        } else {
            confirmBtn.textContent = 'Add Selected Projects & Continue →';
        }
    }
    
    // Listen for messages from the iframe
    window.addEventListener('message', function(event) {
        if (event.data && event.data.type === 'committeeChaosDone') {
            // Cap multiplier to reasonable range to prevent budget explosion
            // Raw multiplier from game, then clamped to 0.85 - 1.10
            var rawMultiplier = event.data.budgetMultiplier || 1.0;
            var multiplier = Math.max(0.85, Math.min(1.10, rawMultiplier));
            
            // Hide the overlay
            document.getElementById('cc-overlay').classList.remove('active');
            
            if (currentMeetingType === 'year1') {
                // Year 1: Set initial budget
                var finalBudget = Math.round(40 * multiplier);
                gameState.maxBudget = finalBudget;
                gameState.budget = finalBudget;
                
                // Show the budget results
                var resultTitle, resultMessage, changeText;
                
                // Thresholds adjusted for capped multiplier range (0.85-1.10)
                if (multiplier >= 1.08) {
                    resultTitle = '🏆 Excellent Facilitation!';
                    resultMessage = 'Outstanding meeting! The board is impressed with your facilitation skills.';
                    changeText = '<span style="color: var(--success);">+' + Math.round((multiplier - 1) * 100) + '% budget boost!</span>';
                } else if (multiplier >= 1.03) {
                    resultTitle = '✓ Good Meeting';
                    resultMessage = 'Solid facilitation. The committee approved a budget increase.';
                    changeText = '<span style="color: var(--success);">+' + Math.round((multiplier - 1) * 100) + '% budget boost</span>';
                } else if (multiplier >= 0.97) {
                    resultTitle = '📋 Acceptable Meeting';
                    resultMessage = 'Meeting concluded adequately. Standard budget approved.';
                    changeText = 'Standard budget';
                } else if (multiplier >= 0.90) {
                    resultTitle = '⚠️ Difficult Meeting';
                    resultMessage = 'The meeting had some issues. Budget slightly reduced.';
                    changeText = '<span style="color: var(--danger);">' + Math.round((multiplier - 1) * 100) + '% budget cut</span>';
                } else {
                    resultTitle = '💥 Challenging Meeting';
                    resultMessage = 'The meeting was difficult. Budget reduced.';
                    changeText = '<span style="color: var(--danger);">' + Math.round((multiplier - 1) * 100) + '% from standard</span>';
                }
                
                document.getElementById('budget-result-title').textContent = resultTitle;
                document.getElementById('budget-result-message').textContent = resultMessage;
                document.getElementById('budget-result-amount').textContent = '$' + finalBudget + 'M';
                document.getElementById('budget-result-change').innerHTML = changeText;
                
                showPhase('budget-results');
            } else {
                // Year 2: Adjust existing budget based on maxBudget, not remaining budget
                var oldBudget = gameState.maxBudget;
                var newBudget = Math.round(oldBudget * multiplier);
                
                // Ensure minimum budget floor of 20M (half of standard 40M)
                newBudget = Math.max(20, newBudget);
                
                // Calculate actual adjustment after floor
                var adjustment = newBudget - oldBudget;
                
                gameState.maxBudget = newBudget;
                // Also update current budget proportionally, but don't exceed new max
                var budgetRatio = gameState.budget / oldBudget;
                gameState.budget = Math.min(newBudget, Math.round(newBudget * budgetRatio));
                
                var resultTitle, resultMessage, changeText;
                
                // Thresholds adjusted for capped multiplier range (0.85-1.10)
                if (multiplier >= 1.08) {
                    resultTitle = '🏆 Outstanding Review!';
                    resultMessage = 'The committee is thrilled with progress. Funding increase approved!';
                    changeText = '<span style="color: var(--success);">+$' + Math.abs(adjustment) + ' M boost!</span>';
                } else if (multiplier >= 1.03) {
                    resultTitle = '✓ Positive Review';
                    resultMessage = 'Strong progress earned additional funding.';
                    changeText = '<span style="color: var(--success);">+$' + Math.abs(adjustment) + ' M increase</span>';
                } else if (multiplier >= 0.97) {
                    resultTitle = '📋 Satisfactory Review';
                    resultMessage = 'Progress is on track. Budget maintained.';
                    changeText = 'No change';
                } else if (multiplier >= 0.90) {
                    resultTitle = '⚠️ Concerns Raised';
                    resultMessage = 'Some concerns about progress. Minor budget adjustment.';
                    changeText = '<span style="color: var(--danger);">-$' + Math.abs(adjustment) + ' M cut</span>';
                } else {
                    resultTitle = '📉 Disappointing Review';
                    resultMessage = 'The committee is unhappy. Budget reduced.';
                    changeText = '<span style="color: var(--danger);">-$' + Math.abs(adjustment) + ' M reduction</span>';
                }
                
                document.getElementById('year2-budget-result-title').textContent = resultTitle;
                document.getElementById('year2-budget-result-message').textContent = resultMessage;
                document.getElementById('year2-budget-result-amount').textContent = '$' + newBudget + 'M';
                document.getElementById('year2-budget-result-change').innerHTML = changeText;
                
                showPhase('year2-budget-results');
            }
        }
    });
    
    // ============================================
    // PROJECT COCKPIT FUNCTIONS
    // ============================================
    
    let cockpitSelectedProject = null;
    let cockpitSelectedAction = null;
    
    // Action implications data
    const cockpitActionImplications = {
        continue: {
            effects: [
                { type: 'neutral', text: 'No budget change' },
                { type: 'neutral', text: 'Timeline unchanged' },
                { type: 'positive', text: 'Team stability' }
            ]
        },
        accelerate: {
            effects: [
                { type: 'positive', text: '+50% budget boost' },
                { type: 'positive', text: '-1 quarter timeline' },
                { type: 'negative', text: 'Higher burn rate' }
            ]
        },
        reduce: {
            effects: [
                { type: 'positive', text: '-30% budget savings' },
                { type: 'negative', text: '+1 quarter timeline' },
                { type: 'neutral', text: 'Reduced scope' }
            ]
        },
        champion: {
            effects: [
                { type: 'positive', text: 'Executive visibility' },
                { type: 'positive', text: 'Priority resources' },
                { type: 'negative', text: 'Uses political capital' }
            ]
        },
        kill: {
            effects: [
                { type: 'positive', text: 'Free up budget & team' },
                { type: 'negative', text: 'Sunk costs lost' },
                { type: 'negative', text: 'Team morale impact' }
            ]
        }
    };
    
    function showCockpitView() {
        renderCockpitView();
        showPhase('cockpit');
    }
    
    function renderCockpitView() {
        const year = gameState.currentQuarter <= 4 ? 1 : 2;
        const quarterInYear = gameState.currentQuarter <= 4 ? gameState.currentQuarter : gameState.currentQuarter - 4;
        
        // Count RAG status
        let greenCount = 0, amberCount = 0, redCount = 0;
        gameState.activeProjects.forEach(p => {
            const status = p.latestUpdate?.status || 'green';
            if (status === 'green') greenCount++;
            else if (status === 'yellow') amberCount++;
            else redCount++;
        });
        
        // Calculate total budget and spent
        let totalBudget = 0, totalSpent = 0;
        gameState.activeProjects.forEach(p => {
            totalBudget += p.budget;
            totalSpent += p.spentBudget || 0;
        });
        
        const needsAction = amberCount + redCount;
        
        // Render header
        const spentPercent = totalBudget > 0 ? Math.round((totalSpent / totalBudget) * 100) : 0;
        document.getElementById('cockpit-header').innerHTML = `
            <div class="cockpit-title-section">
                <h2>🎛️ Project Cockpit</h2>
                <span class="cockpit-quarter-badge">Q${gameState.currentQuarter} · Year ${year}</span>
            </div>
            <div class="cockpit-stats">
                <div class="rag-summary">
                    <span class="rag-pill green">${greenCount} ✓</span>
                    <span class="rag-pill amber">${amberCount} !</span>
                    <span class="rag-pill red">${redCount} ✗</span>
                </div>
                <div class="cockpit-stat">
                    <span class="value">$${totalBudget.toFixed(1)}M</span>
                    <span class="label">Budget</span>
                </div>
                <div class="cockpit-stat">
                    <span class="value">${spentPercent}%</span>
                    <span class="label">Spent</span>
                </div>
                ${needsAction > 0 ? `
                <div class="cockpit-stat alert">
                    <span class="value">${needsAction}</span>
                    <span class="label">Action</span>
                </div>` : ''}
            </div>
        `;
        
        // Render project grid
        const gridHtml = gameState.activeProjects.map(project => {
            const update = project.latestUpdate || {};
            const status = update.status || 'green';
            const ragClass = status === 'yellow' ? 'amber' : status;
            const budgetPct = Math.round((project.spentBudget || 0) / project.budget * 100);
            const progress = update.progress || 0;
            const remaining = Math.max(0, project.timeline - (project.currentQuarter || 0));
            
            const decisionTag = project.decision && project.decision !== 'continue' ? 
                `<span class="decision-tag ${project.decision}">${project.decision}</span>` : '';
            
            // Determine what to show in the status area
            let statusText = '';
            if (decisionTag) {
                statusText = decisionTag;
            } else if (update.narrative) {
                statusText = update.narrative.substring(0, 60) + '...';
            } else if (project.tagline) {
                statusText = project.tagline.substring(0, 60) + (project.tagline.length > 60 ? '...' : '');
            } else {
                statusText = `$${project.budget.toFixed(1)}M · ${project.timeline}Q timeline`;
            }
            
            return `
                <div class="cockpit-tile ${ragClass} ${cockpitSelectedProject?.id === project.id ? 'selected' : ''}" 
                     onclick="openCockpitPanel('${project.id}')">
                    <div class="cockpit-tile-header">
                        <span class="cockpit-tile-name">${project.name}</span>
                        <span class="cockpit-tile-quarter">Q${project.currentQuarter || 0}/${project.timeline}</span>
                    </div>
                    <div class="cockpit-tile-metrics">
                        <div class="cockpit-metric">
                            <div class="value">${progress}%</div>
                            <div class="label">Progress</div>
                        </div>
                        <div class="cockpit-metric">
                            <div class="value">${budgetPct}%</div>
                            <div class="label">Spent</div>
                        </div>
                        <div class="cockpit-metric">
                            <div class="value">${remaining}Q</div>
                            <div class="label">Left</div>
                        </div>
                    </div>
                    <div class="cockpit-tile-progress">
                        <div class="cockpit-tile-progress-fill" style="width: ${progress}%"></div>
                    </div>
                    <div class="cockpit-tile-status">
                        ${statusText}
                    </div>
                    <button class="cockpit-tile-btn" onclick="event.stopPropagation(); openCockpitPanel('${project.id}')">
                        ⚙️ Manage
                    </button>
                </div>
            `;
        }).join('');
        
        // Handle empty state
        if (gameState.activeProjects.length === 0) {
            document.getElementById('cockpit-grid').innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--gray-500);">
                    <div style="font-size: 3em; margin-bottom: 15px;">📭</div>
                    <h3 style="margin: 0 0 10px; color: var(--gray-700);">No Active Projects</h3>
                    <p style="margin: 0;">All projects have completed or been terminated. Click below to view your final results.</p>
                </div>
            `;
        } else {
            document.getElementById('cockpit-grid').innerHTML = gridHtml;
        }
    }
    
    function openCockpitPanel(projectId) {
        cockpitSelectedProject = gameState.activeProjects.find(p => p.id === projectId);
        cockpitSelectedAction = null;
        
        if (!cockpitSelectedProject) return;
        
        const p = cockpitSelectedProject;
        const update = p.latestUpdate || {};
        const status = update.status || 'green';
        const ragClass = status === 'yellow' ? 'amber' : status;
        const ragLabel = status === 'green' ? 'On Track' : status === 'yellow' ? 'At Risk' : 'Critical';
        
        // Update header
        document.getElementById('cockpit-panel-name').textContent = p.name;
        document.getElementById('cockpit-panel-tagline').textContent = p.tagline || '';
        
        const badge = document.getElementById('cockpit-panel-badge');
        badge.className = `panel-rag-badge ${ragClass}`;
        badge.textContent = ragLabel;
        
        // Calculate metrics
        const budgetUsed = Math.round((p.spentBudget || 0) / p.budget * 100);
        const remaining = Math.max(0, p.timeline - p.currentQuarter);
        const progress = update.progress || 0;
        
        // Get strategic buckets
        const strategic = (p.strategicBuckets || []).map(b => b.name).join(', ') || 'Not specified';
        
        // Get milestone info
        const milestones = p.milestones?.milestones || p.milestones?.phases || [
            { name: 'Research' }, { name: 'Development' }, { name: 'Testing' }, { name: 'Launch' }
        ];
        const milestonesComplete = update.milestonesComplete || Math.floor((p.currentQuarter / p.timeline) * milestones.length);
        
        // Generate management advice based on committee and project status
        const advice = generateManagementAdvice(p, update);
        
        // Render panel body
        document.getElementById('cockpit-panel-body').innerHTML = `
            <!-- Project Link -->
            <button class="project-link-btn" onclick="openProjectTemplateModal('${p.id}')">
                📄 View Original Project Proposal & Goals
            </button>
            
            <!-- Key Metrics -->
            <div class="panel-section">
                <h4>📊 Key Metrics</h4>
                <div class="panel-metrics-grid">
                    <div class="panel-metric-box">
                        <div class="value">${progress}%</div>
                        <div class="label">Progress</div>
                    </div>
                    <div class="panel-metric-box">
                        <div class="value">$${(p.spentBudget || 0).toFixed(1)}M</div>
                        <div class="label">of $${p.budget}M</div>
                    </div>
                    <div class="panel-metric-box ${budgetUsed > 80 ? 'warning' : ''} ${budgetUsed > 100 ? 'danger' : ''}">
                        <div class="value">${budgetUsed}%</div>
                        <div class="label">Budget Used</div>
                    </div>
                    <div class="panel-metric-box">
                        <div class="value">${remaining}Q</div>
                        <div class="label">Remaining</div>
                    </div>
                </div>
            </div>
            
            <!-- Project Snapshot -->
            <div class="panel-section">
                <h4>📋 Project Snapshot</h4>
                <div class="snapshot-grid">
                    <div class="snapshot-item">
                        <div class="label">Strategic Focus</div>
                        <div class="value">${strategic}</div>
                    </div>
                    <div class="snapshot-item">
                        <div class="label">TRL Progress</div>
                        <div class="value">TRL ${p.trl?.current || '?'} → ${p.trl?.target || '?'}</div>
                    </div>
                    <div class="snapshot-item">
                        <div class="label">Timeline</div>
                        <div class="value">${p.timeline} quarters total</div>
                    </div>
                    <div class="snapshot-item">
                        <div class="label">Team Size</div>
                        <div class="value">${p.teamLeads?.length ? p.teamLeads.length + ' leads' : 'TBD'}</div>
                    </div>
                </div>
            </div>
            
            <!-- Milestone Progress -->
            <div class="panel-section">
                <h4>🎯 Milestone Progress</h4>
                <div class="milestone-track">
                    ${milestones.map((m, i) => {
                        let status = 'pending';
                        if (i < milestonesComplete) status = 'complete';
                        else if (i === milestonesComplete) status = 'current';
                        return `
                            <div class="milestone-step">
                                <div class="milestone-step-bar ${status}"></div>
                                <div class="milestone-step-label">${m.name || m.phase || 'M' + (i+1)}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
                <div class="milestone-narrative">${update.narrative || 'No update available this quarter.'}</div>
            </div>
            
            <!-- Intelligence Summary -->
            <div class="panel-section">
                <h4>🔍 Intelligence Summary</h4>
                <div class="intel-grid">
                    <div class="intel-card">
                        <h5>🏁 Competition</h5>
                        <p>${getCompetitorUpdate(p, status === 'green')}</p>
                    </div>
                    <div class="intel-card">
                        <h5>🛡️ IP Position</h5>
                        <p>${getIPUpdate(p, status === 'green')}</p>
                    </div>
                    <div class="intel-card">
                        <h5>👥 Team & Resources</h5>
                        <p>${getTeamUpdate(p, status === 'green')}</p>
                    </div>
                    <div class="intel-card">
                        <h5>⚠️ Key Risk</h5>
                        <p>${getRiskAssessment(p, update)}</p>
                    </div>
                </div>
            </div>
            
            <!-- Management Advice -->
            <div class="advice-section">
                <h4>💼 Leadership Perspectives</h4>
                <div class="advice-cards">
                    ${advice.map(a => `
                        <div class="advice-card">
                            <div class="advice-header">
                                <div class="advisor-avatar" style="background: ${a.color}">${a.initials}</div>
                                <div class="advisor-info">
                                    <div class="name">${a.name}</div>
                                    <div class="role">${a.role}</div>
                                </div>
                                <span class="advice-stance ${a.stance}">${a.stance.charAt(0).toUpperCase() + a.stance.slice(1)}</span>
                            </div>
                            <div class="advice-quote">"${a.quote}"</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
        
        // Reset action buttons
        document.querySelectorAll('.cockpit-action-btn').forEach(btn => btn.classList.remove('selected'));
        
        // Pre-select current decision if exists
        if (p.decision) {
            const currentBtn = document.querySelector(`.cockpit-action-btn.${p.decision}`);
            if (currentBtn) {
                currentBtn.classList.add('selected');
                cockpitSelectedAction = p.decision;
                updateCockpitImplications(p.decision);
                document.getElementById('cockpit-confirm-btn').disabled = false;
                document.getElementById('cockpit-confirm-btn').textContent = `Decision: ${p.decision.charAt(0).toUpperCase() + p.decision.slice(1)}`;
            }
        } else {
            document.getElementById('cockpit-confirm-btn').disabled = true;
            document.getElementById('cockpit-confirm-btn').textContent = 'Select an action to continue';
            document.getElementById('cockpit-implications-placeholder').style.display = 'block';
            document.getElementById('cockpit-implications-content').classList.remove('visible');
        }
        
        // Show panel
        document.getElementById('cockpit-overlay').classList.add('active');
        document.getElementById('cockpit-panel').classList.add('active');
        
        // Update grid to show selection
        renderCockpitView();
    }
    
    function closeCockpitPanel() {
        document.getElementById('cockpit-overlay').classList.remove('active');
        document.getElementById('cockpit-panel').classList.remove('active');
        cockpitSelectedProject = null;
        cockpitSelectedAction = null;
        renderCockpitView();
    }
    
    function selectCockpitAction(action) {
        cockpitSelectedAction = action;
        
        // Update button states
        document.querySelectorAll('.cockpit-action-btn').forEach(btn => {
            btn.classList.remove('selected');
        });
        document.querySelector(`.cockpit-action-btn.${action}`).classList.add('selected');
        
        // Show implications
        updateCockpitImplications(action);
        
        // Enable confirm button
        const confirmBtn = document.getElementById('cockpit-confirm-btn');
        confirmBtn.disabled = false;
        
        const actionLabels = {
            continue: 'Confirm: Continue',
            accelerate: 'Confirm: Accelerate',
            reduce: 'Confirm: Reduce Scope',
            champion: 'Confirm: Champion',
            kill: 'Confirm: Stop Project'
        };
        confirmBtn.textContent = actionLabels[action];
    }
    
    function updateCockpitImplications(action) {
        const placeholder = document.getElementById('cockpit-implications-placeholder');
        const content = document.getElementById('cockpit-implications-content');
        const implications = cockpitActionImplications[action];
        
        placeholder.style.display = 'none';
        content.classList.add('visible');
        content.innerHTML = implications.effects.map(e => `
            <span class="implication-item ${e.type}">
                ${e.type === 'positive' ? '✓' : e.type === 'negative' ? '✗' : '•'} ${e.text}
            </span>
        `).join('');
    }
    
    function confirmCockpitDecision() {
        if (!cockpitSelectedProject || !cockpitSelectedAction) return;
        
        // Map champion to continue (with flag for future enhancement)
        let gameAction = cockpitSelectedAction;
        if (cockpitSelectedAction === 'champion') {
            gameAction = 'continue';
            cockpitSelectedProject.championed = true;
        }
        
        // Set decision using existing game function
        setDecision(cockpitSelectedProject.id, gameAction);
        
        // Close panel and refresh
        closeCockpitPanel();
    }
    
    function generateManagementAdvice(project, update) {
        const status = update.status || 'green';
        const advice = [];
        
        // Get committee members for personalized advice
        const committee = gameState.committee || [];
        
        // CEO perspective (always included - Meera Venkataraman)
        const ceoAdvice = {
            name: 'Meera Venkataraman',
            initials: 'MV',
            role: 'CEO',
            color: '#003da5'
        };
        
        if (status === 'green') {
            ceoAdvice.stance = 'supportive';
            ceoAdvice.quote = 'Strong execution. This is the kind of progress that builds investor confidence. Keep the momentum.';
        } else if (status === 'yellow') {
            ceoAdvice.stance = 'cautious';
            ceoAdvice.quote = 'I see potential here, but we need to address those concerns. What resources would help get this back on track?';
        } else {
            ceoAdvice.stance = 'concerned';
            ceoAdvice.quote = 'We need an honest assessment of whether the original thesis still holds. I\'m open to options, but the status quo isn\'t working.';
        }
        advice.push(ceoAdvice);
        
        // Add COO for operational projects or budget concerns (Sanjay Hegde)
        const budgetUsed = (project.spentBudget || 0) / project.budget;
        if (budgetUsed > 0.7 || status === 'red') {
            const cooAdvice = {
                name: 'Sanjay Hegde',
                initials: 'SH',
                role: 'COO',
                color: '#059669'
            };
            
            if (budgetUsed > 0.9) {
                cooAdvice.stance = 'concerned';
                cooAdvice.quote = 'Budget utilization is concerning. We need a clear path to completion or we should consider descoping significantly.';
            } else if (status === 'red') {
                cooAdvice.stance = 'concerned';
                cooAdvice.quote = 'The operational metrics are worrying. I\'d recommend a thorough review before committing more resources.';
            } else {
                cooAdvice.stance = 'cautious';
                cooAdvice.quote = 'Keep an eye on the burn rate. If we extend timeline, we need clear milestones for the next gate.';
            }
            advice.push(cooAdvice);
        }
        
        // Add CTO for technical projects (Harpreet Singh)
        if (project.trl && project.trl.current < 6) {
            const ctoAdvice = {
                name: 'Harpreet Singh',
                initials: 'HS',
                role: 'CTO',
                color: '#2563eb'
            };
            
            if (status === 'green') {
                ctoAdvice.stance = 'supportive';
                ctoAdvice.quote = 'The technical foundation looks solid. This could become a platform differentiator if we execute well.';
            } else if (status === 'yellow') {
                ctoAdvice.stance = 'cautious';
                ctoAdvice.quote = 'Some technical debt building up. I\'d rather extend timeline than cut corners on architecture.';
            } else {
                ctoAdvice.stance = 'concerned';
                ctoAdvice.quote = 'The technical complexity was underestimated. Consider bringing in external expertise before committing more.';
            }
            advice.push(ctoAdvice);
        }
        
        // Add VP Marketing for market-facing projects (Anjali Deshmukh)
        const hasSalesFocus = (project.strategicBuckets || []).some(b => 
            b.id === 'defend-metro' || b.id === 'tier23-rollout'
        );
        if (hasSalesFocus && advice.length < 3) {
            const marketingAdvice = {
                name: 'Anjali Deshmukh',
                initials: 'AD',
                role: 'VP Marketing',
                color: '#ec4899'
            };
            
            if (status === 'green') {
                marketingAdvice.stance = 'supportive';
                marketingAdvice.quote = 'Channel partners are asking about this. If we can hit the launch window, distribution is ready.';
            } else {
                marketingAdvice.stance = 'neutral';
                marketingAdvice.quote = 'Market timing matters here. I\'d want to see the roadmap firmed up before committing marketing resources.';
            }
            advice.push(marketingAdvice);
        }
        
        return advice.slice(0, 3); // Max 3 advisors
    }
    
    function openProjectTemplateModal(projectId) {
        // Look in projectPool first (during assessment), then activeProjects (during execution)
        let project = null;
        if (gameState.projectPool) {
            project = gameState.projectPool.find(p => p.id === projectId || p.id === parseInt(projectId));
        }
        if (!project && gameState.activeProjects) {
            project = gameState.activeProjects.find(p => p.id === projectId || p.id === parseInt(projectId));
        }
        if (!project) return;
        
        const showTeam = shouldShowTeamInfo();
        
        // Build modal content from project data
        const modalHtml = `
            <div class="template-modal-overlay" onclick="closeProjectTemplateModal()">
                <div class="template-modal" onclick="event.stopPropagation()">
                    <div class="template-header">
                        <div>
                            <h3>${project.name}</h3>
                            <p class="tagline">${project.tagline || ''}</p>
                        </div>
                        <div class="template-budget-badge">
                            <div class="amount">$${project.budget}M </div>
                            <div class="label">Budget</div>
                        </div>
                    </div>
                    <div class="template-body">
                        <div class="template-section">
                            <h4>📋 Project Overview</h4>
                            <p>${project.fullDesc || project.desc || 'No description available.'}</p>
                        </div>
                        
                        <div class="template-section">
                            <h4>📊 Market Context</h4>
                            <p>${project.marketContext || 'Market analysis pending.'}</p>
                        </div>
                        
                        <div class="template-section">
                            <h4>🏗️ Capability Fit</h4>
                            <p>${project.capabilityFit || 'Capability assessment pending.'}</p>
                        </div>
                        
                        <div class="template-section">
                            <h4>🎯 Development Milestones</h4>
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                ${(project.milestones?.milestones || project.milestones?.phases || []).map((m, i) => `
                                    <div style="background: var(--gray-50); padding: 12px; border-radius: 8px; border-left: 3px solid var(--primary);">
                                        <div style="font-weight: 600; color: var(--primary); margin-bottom: 4px;">${m.phase || m.name || 'Phase ' + (i+1)}</div>
                                        <div style="font-size: 0.8em; color: var(--gray-500);">
                                            ${m.quarters ? '📆 ' + m.quarters + ' · ' : ''}
                                            ${m.duration ? '⏱️ ' + m.duration : ''}
                                            ${m.costAmount ? ' · 💰 $' + m.costAmount + 'M' : ''}
                                        </div>
                                        ${m.deliverables ? `
                                            <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-top: 8px;">
                                                ${m.deliverables.map(d => `<span style="background: white; padding: 3px 8px; border-radius: 10px; font-size: 0.75em; color: var(--gray-600); border: 1px solid var(--gray-200);">${d}</span>`).join('')}
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="template-section">
                            <h4>🔬 Technology Readiness Level (TRL)</h4>
                            <div style="display: flex; gap: 4px; margin-bottom: 8px;">
                                ${[1,2,3,4,5,6,7,8,9].map(level => `
                                    <div style="flex: 1; height: 30px; display: flex; align-items: center; justify-content: center; 
                                                background: ${level <= (project.trl?.current || 3) ? 'var(--primary)' : level <= (project.trl?.target || 7) ? 'var(--primary-lighter)' : 'var(--gray-200)'}; 
                                                color: ${level <= (project.trl?.current || 3) ? 'white' : level <= (project.trl?.target || 7) ? 'var(--primary)' : 'var(--gray-400)'};
                                                border-radius: 4px; font-weight: 600; font-size: 0.8em;">
                                        ${level}
                                    </div>
                                `).join('')}
                            </div>
                            <div style="display: flex; gap: 20px; font-size: 0.8em; color: var(--gray-600);">
                                <span>● Current: TRL ${project.trl?.current || '?'}</span>
                                <span>○ Target: TRL ${project.trl?.target || '?'}</span>
                            </div>
                            <div style="margin-top: 12px; padding: 10px 12px; background: var(--gray-50); border-radius: 8px; font-size: 0.75em; color: var(--gray-600);">
                                <div style="font-weight: 600; margin-bottom: 6px; color: var(--gray-700);">TRL Scale Guide:</div>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px;">
                                    <span><strong>1–3</strong> Research: concept &amp; lab testing</span>
                                    <span><strong>4–6</strong> Development: prototype &amp; validation</span>
                                    <span><strong>7–9</strong> Deployment: operational &amp; proven</span>
                                </div>
                            </div>
                            ${project.trl?.note ? `<p style="margin-top: 10px; font-size: 0.85em;">${project.trl.note}</p>` : ''}
                        </div>
                        
                        <div class="template-section">
                            <h4>🛡️ Intellectual Property (IP) Position</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                <div style="background: var(--gray-50); padding: 12px; border-radius: 8px;">
                                    <div style="font-weight: 600; font-size: 0.8em; margin-bottom: 6px; color: var(--gray-700);">ShieldTech IP</div>
                                    <p style="font-size: 0.8em; margin: 0;">${project.ipAnalysis?.shieldtechIP || project.ipPosition?.shieldtech || 'Assessment pending.'}</p>
                                </div>
                                <div style="background: var(--gray-50); padding: 12px; border-radius: 8px;">
                                    <div style="font-weight: 600; font-size: 0.8em; margin-bottom: 6px; color: var(--gray-700);">Competitor IP</div>
                                    <p style="font-size: 0.8em; margin: 0;">${project.ipAnalysis?.competitorIP || project.ipPosition?.competitors || 'Assessment pending.'}</p>
                                </div>
                            </div>
                            <div style="padding: 8px 15px; border-radius: 8px; font-size: 0.85em; display: inline-block;
                                        background: ${(project.ipAnalysis?.ftoRisk || project.ipPosition?.risk || '').toLowerCase().includes('high') ? 'var(--danger-light)' : (project.ipAnalysis?.ftoRisk || project.ipPosition?.risk || '').toLowerCase().includes('medium') ? 'var(--warning-light)' : 'var(--success-light)'};
                                        color: ${(project.ipAnalysis?.ftoRisk || project.ipPosition?.risk || '').toLowerCase().includes('high') ? 'var(--danger)' : (project.ipAnalysis?.ftoRisk || project.ipPosition?.risk || '').toLowerCase().includes('medium') ? 'var(--warning)' : 'var(--success)'};">
                                <strong>Freedom to Operate:</strong> ${project.ipAnalysis?.fto || project.ipPosition?.fto || 'Review needed'} · ${project.ipAnalysis?.ftoRisk || project.ipPosition?.risk || 'Unknown'} Risk
                            </div>
                        </div>
                        
                        <div class="template-section">
                            <h4>⚔️ Key Competitors</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px;">
                                ${(project.competitors || []).map(c => `
                                    <div style="background: var(--gray-50); padding: 12px; border-radius: 8px; 
                                                border-left: 3px solid ${(c.threat || '').toLowerCase().includes('high') ? 'var(--danger)' : (c.threat || '').toLowerCase().includes('medium') ? 'var(--warning)' : 'var(--success)'};">
                                        <div style="font-weight: 600; font-size: 0.85em; margin-bottom: 4px;">${c.name}</div>
                                        <div style="font-size: 0.8em; color: var(--gray-600);">${c.position}</div>
                                    </div>
                                `).join('') || '<p style="color: var(--gray-500);">No competitor data available.</p>'}
                            </div>
                        </div>
                        
                        ${showTeam ? `
                        <div class="template-section">
                            <h4>👥 Team</h4>
                            ${project.lead ? `
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px; padding: 12px; background: var(--gray-50); border-radius: 8px;">
                                    <div style="width: 45px; height: 45px; border-radius: 50%; background: ${project.lead.avatarColor || 'var(--primary)'}; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600;">${project.lead.initials || '?'}</div>
                                    <div>
                                        <div style="font-weight: 600;">${project.lead.name}</div>
                                        <div style="font-size: 0.85em; color: var(--gray-600);">${project.lead.role || 'Project Lead'}</div>
                                    </div>
                                    <div style="margin-left: auto; padding: 4px 12px; border-radius: 15px; font-weight: 600; font-size: 0.85em;
                                                background: ${project.lead.trackRecord ? (((project.lead.trackRecord.successes + project.lead.trackRecord.partial * 0.5) / (project.lead.trackRecord.successes + project.lead.trackRecord.failures + project.lead.trackRecord.partial)) >= 0.7 ? 'var(--success-light)' : 'var(--warning-light)') : 'var(--gray-100)'};
                                                color: ${project.lead.trackRecord ? (((project.lead.trackRecord.successes + project.lead.trackRecord.partial * 0.5) / (project.lead.trackRecord.successes + project.lead.trackRecord.failures + project.lead.trackRecord.partial)) >= 0.7 ? 'var(--success)' : 'var(--warning)') : 'var(--gray-500)'};">
                                        ${project.lead.trackRecord ? Math.round(((project.lead.trackRecord.successes + project.lead.trackRecord.partial * 0.5) / (project.lead.trackRecord.successes + project.lead.trackRecord.failures + project.lead.trackRecord.partial)) * 100) + '% track record' : 'New lead'}
                                    </div>
                                </div>
                            ` : ''}
                            <p>${project.teamNote || 'Team assignment pending.'}</p>
                        </div>
                        ` : `
                        <div class="template-section">
                            <h4>👥 Team</h4>
                            <div class="blinded-section" style="margin: 0;">
                                <div class="blinded-icon">🎭</div>
                                <div class="blinded-text">
                                    <strong>Team Information Hidden</strong>
                                    <span>Blind Review mode — team details not visible.</span>
                                </div>
                            </div>
                        </div>
                        `}
                    </div>
                    <button class="template-close" onclick="closeProjectTemplateModal()">Close</button>
                </div>
            </div>
        `;
        
        const container = document.createElement('div');
        container.id = 'template-modal-container';
        container.innerHTML = modalHtml;
        document.body.appendChild(container);
    }
    
    function closeProjectTemplateModal() {
        const container = document.getElementById('template-modal-container');
        if (container) container.remove();
    }
    </script>
</body>
</html>
